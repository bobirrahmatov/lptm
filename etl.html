<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Loader - Portfolio Analytics</title>
    <!-- Alpine.js for reactive components -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // TailAdmin Brand Colors
                        brand: {
                            25: '#f2f7ff',
                            50: '#ecf3ff',
                            100: '#dde9ff',
                            200: '#c2d6ff',
                            300: '#9cb9ff',
                            400: '#7592ff',
                            500: '#465fff',
                            600: '#3641f5',
                            700: '#2a31d8',
                            800: '#252dae',
                            900: '#262e89',
                            950: '#161950'
                        },
                        // TailAdmin Success Colors
                        success: {
                            25: '#f6fef9',
                            50: '#ecfdf3',
                            100: '#d1fadf',
                            200: '#a6f4c5',
                            300: '#6ce9a6',
                            400: '#32d583',
                            500: '#12b76a',
                            600: '#039855',
                            700: '#027a48',
                            800: '#05603a',
                            900: '#054f31',
                            950: '#053321'
                        },
                        // TailAdmin Warning Colors
                        warning: {
                            25: '#fffcf5',
                            50: '#fffaeb',
                            100: '#fef0c7',
                            200: '#fedf89',
                            300: '#fec84b',
                            400: '#fdb022',
                            500: '#f79009',
                            600: '#dc6803',
                            700: '#b54708',
                            800: '#93370d',
                            900: '#7a2e0e',
                            950: '#4e1d09'
                        },
                        // TailAdmin Error Colors
                        error: {
                            25: '#fffbfa',
                            50: '#fef3f2',
                            100: '#fee4e2',
                            200: '#fecdca',
                            300: '#fda29b',
                            400: '#f97066',
                            500: '#f04438',
                            600: '#d92d20',
                            700: '#b42318',
                            800: '#912018',
                            900: '#7a271a',
                            950: '#55160c'
                        },
                        // TailAdmin Gray Scale
                        gray: {
                            25: '#fcfcfd',
                            50: '#f9fafb',
                            100: '#f2f4f7',
                            200: '#e4e7ec',
                            300: '#d0d5dd',
                            400: '#98a2b3',
                            500: '#667085',
                            600: '#475467',
                            700: '#344054',
                            800: '#1d2939',
                            900: '#101828',
                            950: '#0c111d'
                        }
                    },
                    fontFamily: {
                        'outfit': ['Outfit', 'sans-serif'],
                    },
                    boxShadow: {
                        'theme-xs': '0px 1px 2px 0px rgba(16, 24, 40, 0.05)',
                        'theme-sm': '0px 1px 3px 0px rgba(16, 24, 40, 0.1), 0px 1px 2px 0px rgba(16, 24, 40, 0.06)',
                        'theme-md': '0px 4px 8px -2px rgba(16, 24, 40, 0.1), 0px 2px 4px -2px rgba(16, 24, 40, 0.06)',
                        'theme-lg': '0px 12px 16px -4px rgba(16, 24, 40, 0.08), 0px 4px 6px -2px rgba(16, 24, 40, 0.03)',
                        'theme-xl': '0px 20px 24px -4px rgba(16, 24, 40, 0.08), 0px 8px 8px -4px rgba(16, 24, 40, 0.03)'
                    }
                }
            }
        }
    </script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Outfit', sans-serif;
        }
        
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            height: 6px;
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* File input styling */
        .file-upload-zone {
            transition: all 0.2s ease;
        }
        .file-upload-zone:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        /* Region badge colors - TailAdmin blue theme */
        .badge-emea { background-color: #ecf3ff; color: #465fff; }
        .badge-nam { background-color: #f2f4f7; color: #344054; }
        .badge-apac { background-color: #e0f2fe; color: #0086c9; }

        /* Notification animation */
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        .notification-animate {
            animation: slideInRight 0.3s ease-out;
        }

        /* ETL Flow animations */
        @keyframes flowDash {
            0% { stroke-dashoffset: 20; }
            100% { stroke-dashoffset: 0; }
        }
        @keyframes flowPulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        @keyframes dotMove {
            0% { transform: translateY(0); }
            50% { transform: translateY(4px); }
            100% { transform: translateY(0); }
        }
        .flow-line {
            stroke-dasharray: 6, 4;
            animation: flowDash 0.8s linear infinite;
        }
        .flow-dot {
            animation: flowPulse 1.5s ease-in-out infinite;
        }
        .connector-dot {
            animation: dotMove 1s ease-in-out infinite;
        }

        /* Flow card hover effects */
        .flow-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .flow-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px -6px rgba(0, 0, 0, 0.15);
        }

        /* Vertical connector line */
        .connector-vertical {
            width: 2px;
            background: repeating-linear-gradient(
                to bottom,
                #9ca3af 0px,
                #9ca3af 6px,
                transparent 6px,
                transparent 10px
            );
            background-size: 2px 10px;
            animation: flowVertical 0.8s linear infinite;
        }
        @keyframes flowVertical {
            0% { background-position: 0 0; }
            100% { background-position: 0 10px; }
        }

        /* Horizontal connector */
        .connector-horizontal {
            height: 2px;
            background: repeating-linear-gradient(
                to right,
                #9ca3af 0px,
                #9ca3af 6px,
                transparent 6px,
                transparent 10px
            );
            background-size: 10px 2px;
            animation: flowHorizontal 0.8s linear infinite;
        }
        @keyframes flowHorizontal {
            0% { background-position: 0 0; }
            100% { background-position: 10px 0; }
        }

        /* Gradient text for ETL labels */
        .etl-label {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* MDX Documentation Styles */
        .prose code {
            font-size: 0.875em;
            font-weight: 500;
        }
        .prose pre {
            background-color: #1d2939;
            border-radius: 0.75rem;
            padding: 1rem;
            overflow-x: auto;
        }
        .prose pre code {
            color: #e4e7ec;
            font-size: 0.8125rem;
            line-height: 1.6;
        }
        .prose h2 {
            margin-top: 0;
            margin-bottom: 1rem;
        }
        .prose p {
            margin-bottom: 0;
        }
        .prose table {
            margin: 0;
        }

        /* Card hover effects */
        .doc-card {
            transition: all 0.2s ease;
        }
        .doc-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 16px -4px rgba(16, 24, 40, 0.08), 0 4px 6px -2px rgba(16, 24, 40, 0.03);
        }

        /* Scrollbar for tables */
        .prose table::-webkit-scrollbar {
            height: 6px;
        }
        .prose table::-webkit-scrollbar-track {
            background: #f2f4f7;
            border-radius: 3px;
        }
        .prose table::-webkit-scrollbar-thumb {
            background: #d0d5dd;
            border-radius: 3px;
        }

        /* TailAdmin-style focus ring */
        .focus-ring:focus {
            outline: none;
            box-shadow: 0px 0px 0px 4px rgba(70, 95, 255, 0.12);
        }

        /* Smooth tab transitions */
        [x-cloak] { display: none !important; }
    </style>
    
    <!-- Block Confluence drag-drop interception -->
</head>

<body class="bg-gray-50 min-h-screen" x-data="dataLoaderApp()">
    <!-- Notification Container -->
    <div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Loading Overlay -->
    <div x-show="isLoading" x-cloak
        class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-[10000] flex items-center justify-center">
        <div class="bg-white rounded-2xl p-8 shadow-2xl flex flex-col items-center gap-5 max-w-md mx-4 w-80">
            <div class="relative">
                <div class="w-16 h-16 border-4 border-gray-200 border-t-brand-600 rounded-full animate-spin"></div>
            </div>
            <div class="text-center w-full">
                <h3 class="text-lg font-semibold text-gray-900 mb-2" x-text="loadingMessage">Processing Files</h3>
                <p class="text-sm text-brand-600 font-medium">Please wait...</p>
            </div>
        </div>
    </div>

    <div class="mx-auto max-w-7xl p-4 md:p-6" x-data="{ activeTab: 'upload' }">
        <!-- Tab Navigation - TailAdmin Style -->
        <div class="mb-6 rounded-2xl border border-gray-200 bg-white p-4 sm:p-6">
            <!-- Header -->
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Data Loader</h1>
                <p class="text-sm text-gray-500 mt-1">Upload regional data files to consolidate portfolio, covenants, and CCM data</p>
            </div>
            
            <!-- Tab Navigation -->
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-2 overflow-x-auto [&::-webkit-scrollbar-thumb]:rounded-full [&::-webkit-scrollbar-thumb]:bg-gray-200 [&::-webkit-scrollbar]:h-1.5">
                    <button
                        class="inline-flex items-center gap-2 border-b-2 px-4 py-3 text-sm font-medium transition-colors duration-200 ease-in-out whitespace-nowrap"
                        :class="activeTab === 'upload' ? 'text-brand-500 border-brand-500' : 'bg-transparent text-gray-500 border-transparent hover:text-gray-700'"
                        @click="activeTab = 'upload'">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                        </svg>
                        Data Upload
                    </button>
                    <button
                        class="inline-flex items-center gap-2 border-b-2 px-4 py-3 text-sm font-medium transition-colors duration-200 ease-in-out whitespace-nowrap"
                        :class="activeTab === 'etl' ? 'text-brand-500 border-brand-500' : 'bg-transparent text-gray-500 border-transparent hover:text-gray-700'"
                        @click="activeTab = 'etl'">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        ETL Flow
                    </button>
                    <button
                        class="inline-flex items-center gap-2 border-b-2 px-4 py-3 text-sm font-medium transition-colors duration-200 ease-in-out whitespace-nowrap"
                        :class="activeTab === 'docs' ? 'text-brand-500 border-brand-500' : 'bg-transparent text-gray-500 border-transparent hover:text-gray-700'"
                        @click="activeTab = 'docs'">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                        </svg>
                        Documentation
                    </button>
                </nav>
            </div>
        </div>

        <!-- Data Upload Tab -->
        <div x-show="activeTab === 'upload'">

        <!-- Status Overview Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <!-- Portfolio Data Status -->
            <div class="rounded-2xl border border-gray-200 bg-white p-4">
                <div class="flex items-center gap-3">
                    <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-brand-50 text-brand-500">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Portfolio Data</p>
                        <p class="text-lg font-semibold text-gray-800" x-text="getFileCount('portfolio') + '/3 files'"></p>
                    </div>
                </div>
            </div>
            <!-- Covenants Status -->
            <div class="rounded-2xl border border-gray-200 bg-white p-4">
                <div class="flex items-center gap-3">
                    <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-brand-50 text-brand-500">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Covenants</p>
                        <p class="text-lg font-semibold text-gray-800" x-text="getFileCount('covenants') + '/3 files'"></p>
                    </div>
                </div>
            </div>
            <!-- CCMs Status -->
            <div class="rounded-2xl border border-gray-200 bg-white p-4">
                <div class="flex items-center gap-3">
                    <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-brand-50 text-brand-500">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Credit Reviews</p>
                        <p class="text-lg font-semibold text-gray-800" x-text="getFileCount('ccm') + '/3 files'"></p>
                    </div>
                </div>
            </div>
            <!-- Mapping Status -->
            <div class="rounded-2xl border border-gray-200 bg-white p-4">
                <div class="flex items-center gap-3">
                    <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-brand-50 text-brand-500">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Product Mapping</p>
                        <p class="text-lg font-semibold text-gray-800" x-text="files.mapping ? 'Uploaded' : 'Not uploaded'"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="space-y-6">
            
            <!-- Section 1: Portfolio Data -->
            <div class="rounded-2xl border border-gray-200 bg-white overflow-hidden">
                <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-brand-50 to-white">
                    <div class="flex items-center gap-3">
                        <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-brand-500 text-white">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Portfolio Data</h3>
                            <p class="text-sm text-gray-500">Regional Credit Platform consolidated files</p>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- EMEA - RAR7 Combined -->
                        <div class="space-y-3">
                            <div class="flex items-center gap-2">
                                <span class="badge-emea px-2.5 py-1 rounded-md text-xs font-semibold">EMEA</span>
                                <span class="text-sm font-medium text-gray-700">RAR7 Combined File</span>
                            </div>
                            <div class="file-upload-zone relative rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 p-4 text-center cursor-pointer"
                                @click="$refs.portfolioEmea.click()">
                                <input type="file" x-ref="portfolioEmea" class="hidden" accept=".xlsx,.xls" 
                                    @change="handleFileSelect($event, 'portfolio', 'emea')">
                                <template x-if="!files.portfolio.emea">
                                    <div>
                                        <div class="mx-auto mb-2 flex h-10 w-10 items-center justify-center rounded-full bg-gray-200 text-gray-500">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                            </svg>
                                        </div>
                                        <p class="text-sm text-gray-600 font-medium">Click to upload</p>
                                        <p class="text-xs text-gray-400 mt-1">Excel files only (.xlsx, .xls)</p>
                                    </div>
                                </template>
                                <template x-if="files.portfolio.emea">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-2">
                                            <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-brand-50 text-brand-500">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                </svg>
                                            </div>
                                            <div class="text-left">
                                                <p class="text-sm font-medium text-gray-700 truncate max-w-[140px]" x-text="files.portfolio.emea.name"></p>
                                                <p class="text-xs text-gray-400" x-text="formatFileSize(files.portfolio.emea.size)"></p>
                                            </div>
                                        </div>
                                        <button @click.stop="removeFile('portfolio', 'emea')" class="p-1 rounded hover:bg-gray-200">
                                            <svg class="w-4 h-4 text-gray-400 hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- NAM - BO Export -->
                        <div class="space-y-3">
                            <div class="flex items-center gap-2">
                                <span class="badge-nam px-2.5 py-1 rounded-md text-xs font-semibold">NAM</span>
                                <span class="text-sm font-medium text-gray-700">BO Export</span>
                            </div>
                            <div class="file-upload-zone relative rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 p-4 text-center cursor-pointer"
                                @click="$refs.portfolioNam.click()">
                                <input type="file" x-ref="portfolioNam" class="hidden" accept=".xlsx,.xls" 
                                    @change="handleFileSelect($event, 'portfolio', 'nam')">
                                <template x-if="!files.portfolio.nam">
                                    <div>
                                        <div class="mx-auto mb-2 flex h-10 w-10 items-center justify-center rounded-full bg-gray-200 text-gray-500">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                            </svg>
                                        </div>
                                        <p class="text-sm text-gray-600 font-medium">Click to upload</p>
                                        <p class="text-xs text-gray-400 mt-1">Excel files only (.xlsx, .xls)</p>
                                    </div>
                                </template>
                                <template x-if="files.portfolio.nam">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-2">
                                            <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-brand-50 text-brand-500">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                </svg>
                                            </div>
                                            <div class="text-left">
                                                <p class="text-sm font-medium text-gray-700 truncate max-w-[140px]" x-text="files.portfolio.nam.name"></p>
                                                <p class="text-xs text-gray-400" x-text="formatFileSize(files.portfolio.nam.size)"></p>
                                            </div>
                                        </div>
                                        <button @click.stop="removeFile('portfolio', 'nam')" class="p-1 rounded hover:bg-gray-200">
                                            <svg class="w-4 h-4 text-gray-400 hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- APAC - eOASIS -->
                        <div class="space-y-3">
                            <div class="flex items-center gap-2">
                                <span class="badge-apac px-2.5 py-1 rounded-md text-xs font-semibold">APAC</span>
                                <span class="text-sm font-medium text-gray-700">eOASIS File</span>
                            </div>
                            <div class="file-upload-zone relative rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 p-4 text-center cursor-pointer"
                                @click="$refs.portfolioApac.click()">
                                <input type="file" x-ref="portfolioApac" class="hidden" accept=".xlsx,.xls" 
                                    @change="handleFileSelect($event, 'portfolio', 'apac')">
                                <template x-if="!files.portfolio.apac">
                                    <div>
                                        <div class="mx-auto mb-2 flex h-10 w-10 items-center justify-center rounded-full bg-gray-200 text-gray-500">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                            </svg>
                                        </div>
                                        <p class="text-sm text-gray-600 font-medium">Click to upload</p>
                                        <p class="text-xs text-gray-400 mt-1">Excel files only (.xlsx, .xls)</p>
                                    </div>
                                </template>
                                <template x-if="files.portfolio.apac">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-2">
                                            <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-brand-50 text-brand-500">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                </svg>
                                            </div>
                                            <div class="text-left">
                                                <p class="text-sm font-medium text-gray-700 truncate max-w-[140px]" x-text="files.portfolio.apac.name"></p>
                                                <p class="text-xs text-gray-400" x-text="formatFileSize(files.portfolio.apac.size)"></p>
                                            </div>
                                        </div>
                                        <button @click.stop="removeFile('portfolio', 'apac')" class="p-1 rounded hover:bg-gray-200">
                                            <svg class="w-4 h-4 text-gray-400 hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 2: Covenants Data -->
            <div class="rounded-2xl border border-gray-200 bg-white overflow-hidden">
                <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-brand-25 to-white">
                    <div class="flex items-center gap-3">
                        <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-brand-500 text-white">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">Covenants Data</h3>
                            <p class="text-sm text-gray-500">Regional covenant tracking files</p>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- EMEA Covenants -->
                        <div class="space-y-3">
                            <div class="flex items-center gap-2">
                                <span class="badge-emea px-2.5 py-1 rounded-md text-xs font-semibold">EMEA</span>
                                <span class="text-sm font-medium text-gray-700">Covenants File</span>
                            </div>
                            <div class="file-upload-zone relative rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 p-4 text-center cursor-pointer"
                                @click="$refs.covenantsEmea.click()">
                                <input type="file" x-ref="covenantsEmea" class="hidden" accept=".xlsx,.xls" 
                                    @change="handleFileSelect($event, 'covenants', 'emea')">
                                <template x-if="!files.covenants.emea">
                                    <div>
                                        <div class="mx-auto mb-2 flex h-10 w-10 items-center justify-center rounded-full bg-gray-200 text-gray-500">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                            </svg>
                                        </div>
                                        <p class="text-sm text-gray-600 font-medium">Click to upload</p>
                                        <p class="text-xs text-gray-400 mt-1">Excel files only (.xlsx, .xls)</p>
                                    </div>
                                </template>
                                <template x-if="files.covenants.emea">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-2">
                                            <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-brand-50 text-brand-500">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                </svg>
                                            </div>
                                            <div class="text-left">
                                                <p class="text-sm font-medium text-gray-700 truncate max-w-[140px]" x-text="files.covenants.emea.name"></p>
                                                <p class="text-xs text-gray-400" x-text="formatFileSize(files.covenants.emea.size)"></p>
                                            </div>
                                        </div>
                                        <button @click.stop="removeFile('covenants', 'emea')" class="p-1 rounded hover:bg-gray-200">
                                            <svg class="w-4 h-4 text-gray-400 hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- NAM Covenants -->
                        <div class="space-y-3">
                            <div class="flex items-center gap-2">
                                <span class="badge-nam px-2.5 py-1 rounded-md text-xs font-semibold">NAM</span>
                                <span class="text-sm font-medium text-gray-700">Covenants File</span>
                            </div>
                            <div class="file-upload-zone relative rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 p-4 text-center cursor-pointer"
                                @click="$refs.covenantsNam.click()">
                                <input type="file" x-ref="covenantsNam" class="hidden" accept=".xlsx,.xls" 
                                    @change="handleFileSelect($event, 'covenants', 'nam')">
                                <template x-if="!files.covenants.nam">
                                    <div>
                                        <div class="mx-auto mb-2 flex h-10 w-10 items-center justify-center rounded-full bg-gray-200 text-gray-500">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                            </svg>
                                        </div>
                                        <p class="text-sm text-gray-600 font-medium">Click to upload</p>
                                        <p class="text-xs text-gray-400 mt-1">Excel files only (.xlsx, .xls)</p>
                                    </div>
                                </template>
                                <template x-if="files.covenants.nam">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-2">
                                            <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-brand-50 text-brand-500">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                </svg>
                                            </div>
                                            <div class="text-left">
                                                <p class="text-sm font-medium text-gray-700 truncate max-w-[140px]" x-text="files.covenants.nam.name"></p>
                                                <p class="text-xs text-gray-400" x-text="formatFileSize(files.covenants.nam.size)"></p>
                                            </div>
                                        </div>
                                        <button @click.stop="removeFile('covenants', 'nam')" class="p-1 rounded hover:bg-gray-200">
                                            <svg class="w-4 h-4 text-gray-400 hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- APAC Covenants -->
                        <div class="space-y-3">
                            <div class="flex items-center gap-2">
                                <span class="badge-apac px-2.5 py-1 rounded-md text-xs font-semibold">APAC</span>
                                <span class="text-sm font-medium text-gray-700">Covenants File</span>
                            </div>
                            <div class="file-upload-zone relative rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 p-4 text-center cursor-pointer"
                                @click="$refs.covenantsApac.click()">
                                <input type="file" x-ref="covenantsApac" class="hidden" accept=".xlsx,.xls" 
                                    @change="handleFileSelect($event, 'covenants', 'apac')">
                                <template x-if="!files.covenants.apac">
                                    <div>
                                        <div class="mx-auto mb-2 flex h-10 w-10 items-center justify-center rounded-full bg-gray-200 text-gray-500">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                            </svg>
                                        </div>
                                        <p class="text-sm text-gray-600 font-medium">Click to upload</p>
                                        <p class="text-xs text-gray-400 mt-1">Excel files only (.xlsx, .xls)</p>
                                    </div>
                                </template>
                                <template x-if="files.covenants.apac">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-2">
                                            <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-brand-50 text-brand-500">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                </svg>
                                            </div>
                                            <div class="text-left">
                                                <p class="text-sm font-medium text-gray-700 truncate max-w-[140px]" x-text="files.covenants.apac.name"></p>
                                                <p class="text-xs text-gray-400" x-text="formatFileSize(files.covenants.apac.size)"></p>
                                            </div>
                                        </div>
                                        <button @click.stop="removeFile('covenants', 'apac')" class="p-1 rounded hover:bg-gray-200">
                                            <svg class="w-4 h-4 text-gray-400 hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 3: CCM Data -->
            <div class="rounded-2xl border border-gray-200 bg-white overflow-hidden">
                <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-brand-25 to-white">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-brand-500 text-white">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">Credit Reviews (CCM)</h3>
                                <p class="text-sm text-gray-500">Regional credit committee meeting files</p>
                            </div>
                        </div>
                        <!-- Report Date Selection -->
                        <div class="flex items-center gap-3">
                            <label class="text-sm font-medium text-gray-700">Report Date:</label>
                            <input
                                type="date"
                                x-model="ccmReportDate"
                                class="h-10 w-44 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-800 shadow-sm focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 focus:outline-none"
                            />
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- EMEA CCM -->
                        <div class="space-y-3">
                            <div class="flex items-center gap-2">
                                <span class="badge-emea px-2.5 py-1 rounded-md text-xs font-semibold">EMEA</span>
                                <span class="text-sm font-medium text-gray-700">CCM File</span>
                            </div>
                            <div class="file-upload-zone relative rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 p-4 text-center cursor-pointer"
                                @click="$refs.ccmEmea.click()">
                                <input type="file" x-ref="ccmEmea" class="hidden" accept=".xlsx,.xls" 
                                    @change="handleFileSelect($event, 'ccm', 'emea')">
                                <template x-if="!files.ccm.emea">
                                    <div>
                                        <div class="mx-auto mb-2 flex h-10 w-10 items-center justify-center rounded-full bg-gray-200 text-gray-500">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                            </svg>
                                        </div>
                                        <p class="text-sm text-gray-600 font-medium">Click to upload</p>
                                        <p class="text-xs text-gray-400 mt-1">Excel files only (.xlsx, .xls)</p>
                                    </div>
                                </template>
                                <template x-if="files.ccm.emea">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-2">
                                            <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-brand-50 text-brand-500">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                </svg>
                                            </div>
                                            <div class="text-left">
                                                <p class="text-sm font-medium text-gray-700 truncate max-w-[140px]" x-text="files.ccm.emea.name"></p>
                                                <p class="text-xs text-gray-400" x-text="formatFileSize(files.ccm.emea.size)"></p>
                                            </div>
                                        </div>
                                        <button @click.stop="removeFile('ccm', 'emea')" class="p-1 rounded hover:bg-gray-200">
                                            <svg class="w-4 h-4 text-gray-400 hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- NAM CCM -->
                        <div class="space-y-3">
                            <div class="flex items-center gap-2">
                                <span class="badge-nam px-2.5 py-1 rounded-md text-xs font-semibold">NAM</span>
                                <span class="text-sm font-medium text-gray-700">CCM File</span>
                            </div>
                            <div class="file-upload-zone relative rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 p-4 text-center cursor-pointer"
                                @click="$refs.ccmNam.click()">
                                <input type="file" x-ref="ccmNam" class="hidden" accept=".xlsx,.xls" 
                                    @change="handleFileSelect($event, 'ccm', 'nam')">
                                <template x-if="!files.ccm.nam">
                                    <div>
                                        <div class="mx-auto mb-2 flex h-10 w-10 items-center justify-center rounded-full bg-gray-200 text-gray-500">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                            </svg>
                                        </div>
                                        <p class="text-sm text-gray-600 font-medium">Click to upload</p>
                                        <p class="text-xs text-gray-400 mt-1">Excel files only (.xlsx, .xls)</p>
                                    </div>
                                </template>
                                <template x-if="files.ccm.nam">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-2">
                                            <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-brand-50 text-brand-500">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                </svg>
                                            </div>
                                            <div class="text-left">
                                                <p class="text-sm font-medium text-gray-700 truncate max-w-[140px]" x-text="files.ccm.nam.name"></p>
                                                <p class="text-xs text-gray-400" x-text="formatFileSize(files.ccm.nam.size)"></p>
                                            </div>
                                        </div>
                                        <button @click.stop="removeFile('ccm', 'nam')" class="p-1 rounded hover:bg-gray-200">
                                            <svg class="w-4 h-4 text-gray-400 hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- APAC CCM -->
                        <div class="space-y-3">
                            <div class="flex items-center gap-2">
                                <span class="badge-apac px-2.5 py-1 rounded-md text-xs font-semibold">APAC</span>
                                <span class="text-sm font-medium text-gray-700">CCM File</span>
                            </div>
                            <div class="file-upload-zone relative rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 p-4 text-center cursor-pointer"
                                @click="$refs.ccmApac.click()">
                                <input type="file" x-ref="ccmApac" class="hidden" accept=".xlsx,.xls" 
                                    @change="handleFileSelect($event, 'ccm', 'apac')">
                                <template x-if="!files.ccm.apac">
                                    <div>
                                        <div class="mx-auto mb-2 flex h-10 w-10 items-center justify-center rounded-full bg-gray-200 text-gray-500">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                            </svg>
                                        </div>
                                        <p class="text-sm text-gray-600 font-medium">Click to upload</p>
                                        <p class="text-xs text-gray-400 mt-1">Excel files only (.xlsx, .xls)</p>
                                    </div>
                                </template>
                                <template x-if="files.ccm.apac">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-2">
                                            <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-brand-50 text-brand-500">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                </svg>
                                            </div>
                                            <div class="text-left">
                                                <p class="text-sm font-medium text-gray-700 truncate max-w-[140px]" x-text="files.ccm.apac.name"></p>
                                                <p class="text-xs text-gray-400" x-text="formatFileSize(files.ccm.apac.size)"></p>
                                            </div>
                                        </div>
                                        <button @click.stop="removeFile('ccm', 'apac')" class="p-1 rounded hover:bg-gray-200">
                                            <svg class="w-4 h-4 text-gray-400 hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 4: ROTCE Data -->
            <div class="rounded-2xl border border-gray-200 bg-white overflow-hidden">
                <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-purple-50 to-white">
                    <div class="flex items-center gap-3">
                        <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-purple-500 text-white">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">ROTCE Data</h3>
                            <p class="text-sm text-gray-500">Return on Tangible Common Equity data for portfolio mapping</p>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <div class="max-w-lg">
                        <div class="space-y-3">
                            <div class="flex items-center gap-2">
                                <span class="px-2.5 py-1 rounded-md text-xs font-semibold bg-purple-100 text-purple-600">GLOBAL</span>
                                <span class="text-sm font-medium text-gray-700">ROTCE Report</span>
                            </div>
                            <div class="file-upload-zone relative rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 p-4 text-center cursor-pointer"
                                @click="$refs.rotceFile.click()">
                                <input type="file" x-ref="rotceFile" class="hidden" accept=".xlsx,.xls" 
                                    @change="handleFileSelect($event, 'rotce', 'global')">
                                <template x-if="!files.rotce.global">
                                    <div>
                                        <div class="mx-auto mb-2 flex h-10 w-10 items-center justify-center rounded-full bg-purple-100 text-purple-500">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                            </svg>
                                        </div>
                                        <p class="text-sm text-gray-600 font-medium">Click to upload</p>
                                        <p class="text-xs text-gray-400 mt-1">Excel files only (.xlsx, .xls)</p>
                                    </div>
                                </template>
                                <template x-if="files.rotce.global">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-2">
                                            <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-purple-50 text-purple-500">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                </svg>
                                            </div>
                                            <div class="text-left">
                                                <p class="text-sm font-medium text-gray-700 truncate max-w-[140px]" x-text="files.rotce.global.name"></p>
                                                <p class="text-xs text-gray-400" x-text="formatFileSize(files.rotce.global.size)"></p>
                                            </div>
                                        </div>
                                        <button @click.stop="removeFile('rotce', 'global')" class="p-1 rounded hover:bg-gray-200">
                                            <svg class="w-4 h-4 text-gray-400 hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </template>
                            </div>
                            <p class="text-xs text-gray-500">
                                Columns: Client Relationship ID, Period, Variable Net Income, Total TCE, Variable RoTCE, Total_RWA_EOP
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 5: Product Mapping -->
            <div class="rounded-2xl border border-gray-200 bg-white overflow-hidden">
                <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-brand-25 to-white">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-brand-500 text-white">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">Product Mapping</h3>
                                <p class="text-sm text-gray-500">Master mapping file for product classifications</p>
                            </div>
                        </div>
                        <!-- Download Button -->
                        <button @click="downloadMappingTemplate()"
                            class="flex items-center gap-1.5 rounded-lg border border-gray-300 bg-white px-3 py-2 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            <span>Download Template</span>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="max-w-lg">
                        <div class="space-y-3">
                            <div class="flex items-center gap-2">
                                <span class="px-2.5 py-1 rounded-md text-xs font-semibold bg-brand-100 text-brand-600">GLOBAL</span>
                                <span class="text-sm font-medium text-gray-700">Product_Mapping.xlsx</span>
                            </div>
                            <div class="file-upload-zone relative rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 p-6 text-center cursor-pointer"
                                @click="$refs.mappingFile.click()">
                                <input type="file" x-ref="mappingFile" class="hidden" accept=".xlsx,.xls" 
                                    @change="handleMappingSelect($event)">
                                <template x-if="!files.mapping">
                                    <div>
                                        <div class="mx-auto mb-3 flex h-12 w-12 items-center justify-center rounded-full bg-brand-100 text-brand-500">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                            </svg>
                                        </div>
                                        <p class="text-sm text-gray-600 font-medium">Click to upload Product_Mapping.xlsx</p>
                                        <p class="text-xs text-gray-400 mt-1">This file contains product classification mappings</p>
                                    </div>
                                </template>
                                <template x-if="files.mapping">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-brand-50 text-brand-500">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                </svg>
                                            </div>
                                            <div class="text-left">
                                                <p class="text-sm font-medium text-gray-700" x-text="files.mapping.name"></p>
                                                <p class="text-xs text-gray-400" x-text="formatFileSize(files.mapping.size)"></p>
                                            </div>
                                        </div>
                                        <button @click.stop="files.mapping = null" class="p-1.5 rounded hover:bg-gray-200">
                                            <svg class="w-5 h-5 text-gray-400 hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Processing Result Banner -->
            <div x-show="processingComplete" x-cloak class="mb-6">
                <!-- Success Result -->
                <template x-if="processingResult && processingResult.success">
                    <div class="rounded-2xl border-2 border-brand-500 bg-brand-50 p-6">
                        <div class="flex items-start gap-4">
                            <div class="flex h-12 w-12 items-center justify-center rounded-full bg-brand-500 text-white flex-shrink-0">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-brand-700 mb-2">Processing Complete!</h3>
                                <div class="text-sm text-brand-600 space-y-1">
                                    <p x-show="processingResult.portfolioRecords > 0">
                                        <strong x-text="processingResult.portfolioRecords"></strong> Portfolio records processed
                                        <span x-show="processingResult.portfolioUploaded" class="text-brand-500"> Uploaded</span>
                                        <span x-show="!processingResult.portfolioUploaded" class="text-gray-500">(Download available)</span>
                                    </p>
                                    <p x-show="processingResult.covenantsRecords > 0">
                                        <strong x-text="processingResult.covenantsRecords"></strong> Covenants records processed
                                        <span x-show="processingResult.covenantsUploaded" class="text-brand-500"> Uploaded</span>
                                        <span x-show="!processingResult.covenantsUploaded" class="text-gray-500">(Download available)</span>
                                    </p>
                                    <p x-show="processingResult.ccmRecords > 0">
                                        <strong x-text="processingResult.ccmRecords"></strong> CCM records processed
                                        <span x-show="processingResult.ccmUploaded" class="text-brand-500"> Uploaded</span>
                                        <span x-show="!processingResult.ccmUploaded" class="text-gray-500">(Download available)</span>
                                    </p>
                                    <p x-show="processingResult.rotceRecords > 0">
                                        <strong x-text="processingResult.rotceRecords"></strong> ROTCE records processed
                                        <span x-show="processingResult.rotceUploaded" class="text-purple-500"> Uploaded</span>
                                        <span x-show="!processingResult.rotceUploaded" class="text-gray-500">(Download available)</span>
                                    </p>
                                    <p x-show="processingResult.aggregatedRecords > 0" class="border-t border-brand-200 pt-2 mt-2">
                                        <strong x-text="processingResult.aggregatedRecords"></strong> Aggregated history records
                                        <span x-show="processingResult.aggregatedHistoryUploaded" class="text-success-500"> Uploaded</span>
                                        <span x-show="!processingResult.aggregatedHistoryUploaded" class="text-gray-500">(Download available)</span>
                                        <span class="block text-xs text-gray-500 mt-1">Weekly metrics by Region, Product Program & Sub-Program</span>
                                    </p>
                                </div>
                                
                                <!-- Download Buttons -->
                                <div class="mt-4 p-4 bg-white rounded-xl border border-brand-200">
                                    <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                        <svg class="w-4 h-4 text-brand-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                        </svg>
                                        Download Processed Files
                                    </h4>
                                    <div class="flex flex-wrap gap-2">
                                        <button x-show="processingResult.portfolioRecords > 0" @click="downloadFile('portfolio')"
                                            class="flex items-center gap-1.5 rounded-lg border border-gray-300 bg-white px-3 py-2 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                            <svg class="w-3.5 h-3.5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                            <span>Portfolio_tw.xlsx</span>
                                        </button>
                                        <button x-show="processingResult.covenantsRecords > 0" @click="downloadFile('covenants')"
                                            class="flex items-center gap-1.5 rounded-lg border border-gray-300 bg-white px-3 py-2 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                            <svg class="w-3.5 h-3.5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                            <span>Covenants_tw.xlsx</span>
                                        </button>
                                        <button x-show="processingResult.ccmRecords > 0" @click="downloadFile('ccm')"
                                            class="flex items-center gap-1.5 rounded-lg border border-gray-300 bg-white px-3 py-2 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                            <svg class="w-3.5 h-3.5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                            <span>CCM_tw.xlsx</span>
                                        </button>
                                        <button x-show="processingResult.rotceRecords > 0" @click="downloadFile('rotce')"
                                            class="flex items-center gap-1.5 rounded-lg border border-gray-300 bg-white px-3 py-2 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                            <svg class="w-3.5 h-3.5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                            <span>ROTCE_tw.xlsx</span>
                                        </button>
                                        <button x-show="processingResult.aggregatedRecords > 0" @click="downloadFile('aggregatedHistory')"
                                            class="flex items-center gap-1.5 rounded-lg border border-success-300 bg-success-50 px-3 py-2 text-xs font-medium text-success-700 hover:bg-success-100 transition-colors">
                                            <svg class="w-3.5 h-3.5 text-success-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                            </svg>
                                            <span>Portfolio_Aggregated_History.xlsx</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="mt-4 flex items-center gap-2">
                                    <a href="portfolioAnalytics.html" 
                                        class="flex items-center gap-1.5 rounded-lg bg-blue-600 hover:bg-blue-700 px-3 py-2 text-xs font-medium text-white transition-colors">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                        <span>Go to Analytics</span>
                                    </a>
                                    <button @click="processingComplete = false; processingResult = null"
                                        class="flex items-center gap-1.5 rounded-lg border border-gray-300 bg-white px-3 py-2 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        <span>Process More</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Error Result -->
                <template x-if="processingResult && !processingResult.success">
                    <div class="rounded-2xl border-2 border-gray-400 bg-gray-50 p-6">
                        <div class="flex items-start gap-4">
                            <div class="flex h-12 w-12 items-center justify-center rounded-full bg-gray-500 text-white flex-shrink-0">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-700 mb-2">Processing Failed</h3>
                                <p class="text-sm text-gray-600" x-text="processingResult.error"></p>
                                <div class="mt-4">
                                    <button @click="processingComplete = false; processingResult = null"
                                        class="flex items-center gap-1.5 rounded-lg bg-blue-600 hover:bg-blue-700 px-3 py-2 text-xs font-medium text-white transition-colors">
                                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        <span>Try Again</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Action Buttons -->
            <div x-show="!processingComplete" class="flex items-center justify-between py-4">
                <button type="button" @click="clearAllFiles()"
                    class="flex items-center gap-1.5 rounded-lg border border-gray-300 bg-white px-3 py-2 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    <span>Clear All</span>
                </button>
                <div class="flex items-center gap-2">
                    <button type="button" @click="validateFiles()"
                        class="flex items-center gap-1.5 rounded-lg border border-gray-300 bg-white px-3 py-2 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>Validate</span>
                    </button>
                    <button type="button" @click="processAndLoad()" :disabled="!canProcess()"
                        :class="canProcess() ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-gray-100 text-gray-400 cursor-not-allowed border border-gray-200'"
                        class="flex items-center gap-1.5 rounded-lg px-3 py-2 text-xs font-medium transition-colors">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                        </svg>
                        <span>Process & Load</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer Info -->
        <div class="mt-8 space-y-4">
            <!-- Upload Info -->
            <div class="rounded-xl bg-blue-50 border border-brand-200 p-4">
                <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-blue-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <div class="text-sm text-blue-800">
                        <p class="font-medium mb-1">Portfolio Analytics of LPTM Integration</p>
                        <p class="text-xs text-blue-600">Consolidated data will be automatically uploaded to Portfolio Analytics when processed:</p>
                        <ul class="text-xs text-blue-600 mt-1 space-y-0.5">
                            <li> <strong>Portfolio_tw.xlsx</strong> - Portfolio data (full detail)</li>
                            <li> <strong>Portfolio_Aggregated_History.xlsx</strong> - Weekly aggregated metrics (incremental)</li>
                            <li> <strong>Covenants_tw.xlsx</strong> - Covenants data</li>
                            <li> <strong>CCM_tw.xlsx</strong> - Credit Reviews data</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- File Sources Info -->
            <div class="rounded-xl bg-gray-100 p-4">
                <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-gray-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="text-sm text-gray-600">
                        <p class="font-medium text-gray-700 mb-1">File Sources Information</p>
                        <ul class="space-y-1 text-xs">
                            <li><strong>Portfolio Data:</strong> Regional Credit Platform exports - EMEA (RAR7 Combined), NAM (BO Export), APAC (eOASIS)</li>
                            <li><strong>Covenants:</strong> New Covenants Module from Credit Platform (1st sheet from each region)</li>
                            <li><strong>Credit Reviews (CCM):</strong> NAM (Open CCM tab), APAC (Past Due + All Coming Due CCMs), EMEA (Past Due + Coming Due + Open CCM)</li>
                            <li><strong>Product Mapping:</strong> Master classification file - download latest version before uploading custom mappings</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        </div>
        <!-- End Data Upload Tab -->

        <!-- ETL Flow Tab -->
        <div x-show="activeTab === 'etl'" x-data="{ selectedFlow: 'ccm', flowDropdownOpen: false }">
            <!-- ETL Header with Dropdown -->
            <div class="mb-6">
                <div class="rounded-2xl border border-gray-200 bg-white p-6">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div class="flex items-center gap-3">
                            <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-gradient-to-br from-brand-500 to-brand-700 text-white">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-900">ETL Data Flow</h2>
                                <p class="text-sm text-gray-500">Extract, Transform, Load process for regional data consolidation</p>
                            </div>
                        </div>
                        
                        <!-- Flow Selector Dropdown -->
                        <div class="relative inline-block" x-data="{ open: false }">
                            <button @click="open = !open"
                                class="inline-flex items-center gap-3 rounded-xl border border-gray-200 bg-white px-5 py-3 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 transition-all min-w-[220px] justify-between">
                                <div class="flex items-center gap-2">
                                    <template x-if="selectedFlow === 'ccm'">
                                        <div class="flex items-center gap-2">
                                            <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-brand-500 text-white">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                </svg>
                                            </span>
                                            <span>CCM (Credit Reviews)</span>
                                        </div>
                                    </template>
                                    <template x-if="selectedFlow === 'portfolio'">
                                        <div class="flex items-center gap-2">
                                            <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-brand-500 text-white">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                            </span>
                                            <span>Portfolio Data</span>
                                        </div>
                                    </template>
                                    <template x-if="selectedFlow === 'covenants'">
                                        <div class="flex items-center gap-2">
                                            <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-brand-500 text-white">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                            </span>
                                            <span>Covenants</span>
                                        </div>
                                    </template>
                                </div>
                                <svg class="w-5 h-5 text-gray-400 transition-transform duration-200" :class="open && 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div x-show="open" @click.outside="open = false" x-transition:enter="transition ease-out duration-100" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
                                class="absolute right-0 top-full z-50 mt-2 w-full min-w-[260px] rounded-xl border border-gray-200 bg-white p-2 shadow-lg">
                                <ul class="flex flex-col gap-1">
                                    <li>
                                        <button @click="selectedFlow = 'ccm'; open = false"
                                            class="flex w-full items-center gap-3 rounded-lg px-3 py-2.5 text-sm font-medium transition-colors"
                                            :class="selectedFlow === 'ccm' ? 'bg-brand-50 text-brand-700' : 'text-gray-700 hover:bg-gray-100'">
                                            <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-brand-500 text-white">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                </svg>
                                            </span>
                                            CCM (Credit Reviews)
                                        </button>
                                    </li>
                                    <li>
                                        <button @click="selectedFlow = 'portfolio'; open = false"
                                            class="flex w-full items-center gap-3 rounded-lg px-3 py-2.5 text-sm font-medium transition-colors"
                                            :class="selectedFlow === 'portfolio' ? 'bg-brand-50 text-brand-700' : 'text-gray-700 hover:bg-gray-100'">
                                            <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-brand-500 text-white">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                            </span>
                                            Portfolio Data
                                        </button>
                                    </li>
                                    <li>
                                        <button @click="selectedFlow = 'covenants'; open = false"
                                            class="flex w-full items-center gap-3 rounded-lg px-3 py-2.5 text-sm font-medium transition-colors"
                                            :class="selectedFlow === 'covenants' ? 'bg-brand-50 text-brand-700' : 'text-gray-700 hover:bg-gray-100'">
                                            <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-brand-500 text-white">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                            </span>
                                            Covenants
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== CCM ETL FLOW ==================== -->
            <div x-show="selectedFlow === 'ccm'" class="space-y-6">
                <!-- Visual Process Flow -->
                <div class="rounded-2xl border border-gray-200 bg-gradient-to-br from-gray-50 to-white overflow-hidden">
                    <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-brand-25 to-transparent">
                        <div class="flex items-center gap-3">
                            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-brand-500 text-white shadow-lg shadow-brand-500/30">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">CCM (Credit Reviews) ETL Process</h3>
                                <p class="text-sm text-gray-500">Consolidating regional CCM files into CCM_tw.xlsx</p>
                            </div>
                        </div>
                    </div>

                    <div class="p-6 overflow-x-auto">
                        <!-- Connected Flow Diagram -->
                        <div class="flex flex-col items-center">
                            <!-- Row 1: Source Files -->
                            <div class="flex justify-center gap-8">
                                <!-- NAM Source -->
                                <div class="flow-card w-48 rounded-2xl border-2 border-gray-200 bg-white p-4 shadow-sm hover:border-gray-300">
                                    <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Source</div>
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="px-2 py-1 rounded-lg text-xs font-bold bg-gray-100 text-gray-700">NAM</span>
                                        <span class="text-sm font-semibold text-gray-800">CCM File</span>
                                    </div>
                                    <div class="flex items-center gap-2 text-xs text-gray-600">
                                        <span class="w-1.5 h-1.5 rounded-full bg-gray-400"></span>
                                        <span class="font-mono bg-gray-50 px-1.5 py-0.5 rounded">Open CCM</span>
                                    </div>
                                </div>
                                <!-- APAC Source -->
                                <div class="flow-card w-48 rounded-2xl border-2 border-gray-200 bg-white p-4 shadow-sm hover:border-gray-300">
                                    <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Source</div>
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="px-2 py-1 rounded-lg text-xs font-bold bg-blue-50 text-blue-700">APAC</span>
                                        <span class="text-sm font-semibold text-gray-800">CCM File</span>
                                    </div>
                                    <div class="space-y-1">
                                        <div class="flex items-center gap-2 text-xs text-gray-600">
                                            <span class="w-1.5 h-1.5 rounded-full bg-brand-400"></span>
                                            <span class="font-mono bg-blue-50 px-1.5 py-0.5 rounded">Past Due</span>
                                        </div>
                                        <div class="flex items-center gap-2 text-xs text-gray-600">
                                            <span class="w-1.5 h-1.5 rounded-full bg-brand-400"></span>
                                            <span class="font-mono bg-blue-50 px-1.5 py-0.5 rounded text-[10px]">All Coming Due CCMs</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- EMEA Source -->
                                <div class="flow-card w-48 rounded-2xl border-2 border-brand-200 bg-white p-4 shadow-sm hover:border-blue-300">
                                    <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Source</div>
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="px-2 py-1 rounded-lg text-xs font-bold bg-brand-100 text-brand-700">EMEA</span>
                                        <span class="text-sm font-semibold text-gray-800">CCM File</span>
                                    </div>
                                    <div class="space-y-1">
                                        <div class="flex items-center gap-2 text-xs text-gray-600">
                                            <span class="w-1.5 h-1.5 rounded-full bg-blue-400"></span>
                                            <span class="font-mono bg-blue-50 px-1.5 py-0.5 rounded">Past Due</span>
                                        </div>
                                        <div class="flex items-center gap-2 text-xs text-gray-600">
                                            <span class="w-1.5 h-1.5 rounded-full bg-blue-400"></span>
                                            <span class="font-mono bg-blue-50 px-1.5 py-0.5 rounded">Coming Due</span>
                                        </div>
                                        <div class="flex items-center gap-2 text-xs text-gray-600">
                                            <span class="w-1.5 h-1.5 rounded-full bg-blue-400"></span>
                                            <span class="font-mono bg-blue-50 px-1.5 py-0.5 rounded">Open CCM</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Connector: 3 sources merging down -->
                            <div class="relative w-full flex justify-center" style="height: 50px;">
                                <svg class="absolute" width="500" height="50" style="left: 50%; transform: translateX(-50%);">
                                    <!-- Left line down and right -->
                                    <path d="M 75 0 L 75 25 L 250 25" class="flow-line" stroke="#9ca3af" stroke-width="2" fill="none"/>
                                    <!-- Center line down -->
                                    <path d="M 250 0 L 250 25" class="flow-line" stroke="#9ca3af" stroke-width="2" fill="none"/>
                                    <!-- Right line down and left -->
                                    <path d="M 425 0 L 425 25 L 250 25" class="flow-line" stroke="#9ca3af" stroke-width="2" fill="none"/>
                                    <!-- Down from merge point -->
                                    <path d="M 250 25 L 250 50" class="flow-line" stroke="#9ca3af" stroke-width="2" fill="none"/>
                                    <!-- Merge dot -->
                                    <circle cx="250" cy="25" r="5" class="flow-dot" fill="#6b7280"/>
                                </svg>
                            </div>

                            <!-- Row 2: Extract Step -->
                            <div class="flow-card rounded-2xl border-2 border-blue-300 bg-gradient-to-br from-blue-50 to-blue-100 p-5 shadow-lg w-80">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-blue-500 text-white font-bold shadow">E</div>
                                    <div>
                                        <h4 class="text-sm font-bold text-blue-900">EXTRACT</h4>
                                        <p class="text-xs text-blue-600">Read Excel Sheets</p>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-600">Parse uploaded Excel files and read data from specified tabs for each region</p>
                            </div>

                            <!-- Connector: Down arrow -->
                            <div class="flex flex-col items-center py-1">
                                <div class="connector-vertical h-8"></div>
                                <div class="connector-dot w-2 h-2 rounded-full bg-gray-500"></div>
                            </div>

                            <!-- Row 3: Transform Steps - Row 1 -->
                            <div class="flex justify-center gap-4">
                                <!-- Column Mapping -->
                                <div class="flow-card w-48 rounded-2xl border-2 border-brand-300 bg-gradient-to-br from-brand-50 to-brand-100 p-3 shadow-lg">
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="flex h-7 w-7 items-center justify-center rounded-lg bg-brand-500 text-white font-bold text-xs shadow">T1</div>
                                        <h4 class="text-xs font-bold text-brand-800">Column Mapping</h4>
                                    </div>
                                    <ul class="text-[10px] text-gray-600 space-y-0.5">
                                        <li class="flex items-center gap-1">
                                            <span class="w-1 h-1 rounded-full bg-brand-400"></span>
                                            Map regional columns
                                        </li>
                                        <li class="flex items-center gap-1">
                                            <span class="w-1 h-1 rounded-full bg-brand-400"></span>
                                            APAC: Specialist  UW
                                        </li>
                                        <li class="flex items-center gap-1">
                                            <span class="w-1 h-1 rounded-full bg-brand-400"></span>
                                            EMEA: Auto-fill Region
                                        </li>
                                    </ul>
                                </div>
                                <!-- Date Formatting -->
                                <div class="flow-card w-48 rounded-2xl border-2 border-cyan-300 bg-gradient-to-br from-cyan-50 to-cyan-100 p-3 shadow-lg">
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="flex h-7 w-7 items-center justify-center rounded-lg bg-cyan-500 text-white font-bold text-xs shadow">T2</div>
                                        <h4 class="text-xs font-bold text-cyan-900">Date Format</h4>
                                    </div>
                                    <p class="text-[10px] text-gray-600 mb-1.5">Standardize to:</p>
                                    <div class="flex items-center justify-center gap-1 mb-1.5">
                                        <span class="px-1.5 py-0.5 rounded text-[10px] font-mono bg-white border border-cyan-200 text-cyan-700 font-semibold">DD/MM/YYYY</span>
                                    </div>
                                    <div class="text-[9px] text-gray-500 space-y-0.5">
                                        <div class="flex items-center gap-1">
                                            <span class="text-cyan-500"></span>
                                            <span class="font-mono">DD-MMM-YYYY</span>
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <span class="text-cyan-500"></span>
                                            <span class="font-mono">MM/DD/YYYY</span>
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <span class="text-cyan-500"></span>
                                            <span class="font-mono">YYYY-MM-DD</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- Status Calculation -->
                                <div class="flow-card w-48 rounded-2xl border-2 border-orange-300 bg-gradient-to-br from-orange-50 to-orange-100 p-3 shadow-lg">
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="flex h-7 w-7 items-center justify-center rounded-lg bg-orange-500 text-white font-bold text-xs shadow">T3</div>
                                        <h4 class="text-xs font-bold text-orange-900">Status Calc</h4>
                                    </div>
                                    <div class="space-y-1">
                                        <div class="flex items-center gap-1.5">
                                            <span class="px-1 py-0.5 rounded text-[9px] font-semibold bg-gray-200 text-gray-700">Past Due</span>
                                            <span class="text-[9px] text-gray-600">Before</span>
                                        </div>
                                        <div class="flex items-center gap-1.5">
                                            <span class="px-1 py-0.5 rounded text-[9px] font-semibold bg-brand-100 text-brand-700">Coming Due</span>
                                            <span class="text-[9px] text-gray-600">Same</span>
                                        </div>
                                        <div class="flex items-center gap-1.5">
                                            <span class="px-1 py-0.5 rounded text-[9px] font-semibold bg-brand-50 text-brand-600">Open</span>
                                            <span class="text-[9px] text-gray-600">After</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- Filter -->
                                <div class="flow-card w-48 rounded-2xl border-2 border-red-300 bg-gradient-to-br from-red-50 to-red-100 p-3 shadow-lg">
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="flex h-7 w-7 items-center justify-center rounded-lg bg-red-500 text-white font-bold text-xs shadow">T4</div>
                                        <h4 class="text-xs font-bold text-red-900">Filter Rows</h4>
                                    </div>
                                    <p class="text-[10px] text-gray-600 mb-1">Exclude rows with:</p>
                                    <div class="flex flex-wrap gap-1">
                                        <span class="px-1 py-0.5 rounded text-[9px] font-mono bg-white border border-red-200 text-red-600">Nothing to Report</span>
                                        <span class="px-1 py-0.5 rounded text-[9px] font-mono bg-white border border-red-200 text-red-600">NIL</span>
                                        <span class="px-1 py-0.5 rounded text-[9px] font-mono bg-white border border-red-200 text-red-600">N/A</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Connector: 4 transforms merging down -->
                            <div class="relative w-full flex justify-center" style="height: 50px;">
                                <svg class="absolute" width="650" height="50" style="left: 50%; transform: translateX(-50%);">
                                    <!-- Box 1 (leftmost) down and right -->
                                    <path d="M 85 0 L 85 25 L 325 25" class="flow-line" stroke="#9ca3af" stroke-width="2" fill="none"/>
                                    <!-- Box 2 down and right -->
                                    <path d="M 230 0 L 230 25 L 325 25" class="flow-line" stroke="#9ca3af" stroke-width="2" fill="none"/>
                                    <!-- Box 3 down and left -->
                                    <path d="M 420 0 L 420 25 L 325 25" class="flow-line" stroke="#9ca3af" stroke-width="2" fill="none"/>
                                    <!-- Box 4 (rightmost) down and left -->
                                    <path d="M 565 0 L 565 25 L 325 25" class="flow-line" stroke="#9ca3af" stroke-width="2" fill="none"/>
                                    <!-- Down from merge point -->
                                    <path d="M 325 25 L 325 50" class="flow-line" stroke="#9ca3af" stroke-width="2" fill="none"/>
                                    <!-- Merge dot -->
                                    <circle cx="325" cy="25" r="5" class="flow-dot" fill="#6b7280"/>
                                </svg>
                            </div>

                            <!-- Row 4: Load Step -->
                            <div class="flow-card rounded-2xl border-2 border-gray-300 bg-gradient-to-br from-brand-50 to-brand-100 p-5 shadow-lg w-80">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-blue-500 text-white font-bold shadow">L</div>
                                    <div>
                                        <h4 class="text-sm font-bold text-brand-700">LOAD</h4>
                                        <p class="text-xs text-brand-600">Upload to Portfolio Analytics</p>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-600">Merge all regional data and upload consolidated <span class="font-mono font-semibold">CCM_tw.xlsx</span></p>
                            </div>

                            <!-- Connector: Down arrow with arrowhead -->
                            <div class="flex flex-col items-center py-1">
                                <div class="connector-vertical h-6"></div>
                                <svg class="w-4 h-4 text-gray-500 connector-dot" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 16l-6-6h12l-6 6z"/>
                                </svg>
                            </div>

                            <!-- Row 5: Output -->
                            <div class="flow-card rounded-2xl border-2 border-brand-300 bg-white p-5 shadow-xl">
                                <div class="flex items-center gap-4">
                                    <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-gradient-to-br from-brand-500 to-brand-700 text-white shadow-lg">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h4 class="text-sm font-bold text-gray-900">CCM_tw.xlsx</h4>
                                        <p class="text-xs text-gray-500">Consolidated Credit Reviews</p>
                                        <p class="text-xs text-brand-600 font-medium mt-1">Available in Portfolio Analytics of LPTM</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Column Mapping Table -->
                <div class="rounded-2xl border border-gray-200 bg-white overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
                        <h3 class="text-base font-semibold text-gray-900">Column Mapping Reference</h3>
                    </div>
                    <div class="p-6 overflow-x-auto">
                        <table class="min-w-full text-xs">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-3 py-2.5 text-left font-semibold text-gray-700 border-b">Output Column</th>
                                    <th class="px-3 py-2.5 text-left font-semibold text-gray-600 border-b bg-gray-50">NAM Source</th>
                                    <th class="px-3 py-2.5 text-left font-semibold text-brand-600 border-b bg-blue-50">APAC Source</th>
                                    <th class="px-3 py-2.5 text-left font-semibold text-blue-700 border-b bg-blue-50">EMEA Source</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 font-mono font-medium">Report_Date</td>
                                    <td class="px-3 py-2 text-gray-600" colspan="3"><em class="text-brand-600"> Selected from Date Picker</em></td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 font-mono font-medium">Region</td>
                                    <td class="px-3 py-2 font-mono text-gray-600">Region</td>
                                    <td class="px-3 py-2 font-mono text-brand-600">Region</td>
                                    <td class="px-3 py-2 text-blue-700"><em>Auto-fill "EMEA"</em></td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 font-mono font-medium">Relationship_ID</td>
                                    <td class="px-3 py-2 font-mono text-gray-600">CARE ID</td>
                                    <td class="px-3 py-2 font-mono text-brand-600">CARE ID</td>
                                    <td class="px-3 py-2 font-mono text-blue-700">Relationship ID</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 font-mono font-medium">Client_Name</td>
                                    <td class="px-3 py-2 font-mono text-gray-600">Client Name</td>
                                    <td class="px-3 py-2 font-mono text-brand-600">Client Name</td>
                                    <td class="px-3 py-2 font-mono text-blue-700">CA ID</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 font-mono font-medium">Classification</td>
                                    <td class="px-3 py-2 font-mono text-gray-600">Classification</td>
                                    <td class="px-3 py-2 font-mono text-brand-600">Classification</td>
                                    <td class="px-3 py-2 font-mono text-blue-700">Classification</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 font-mono font-medium">Frequency</td>
                                    <td class="px-3 py-2 font-mono text-gray-600">Frequency</td>
                                    <td class="px-3 py-2 font-mono text-brand-600">Frequency</td>
                                    <td class="px-3 py-2 font-mono text-blue-700">Frequency</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 font-mono font-medium">Underwriter</td>
                                    <td class="px-3 py-2 font-mono text-gray-600">Underwriter</td>
                                    <td class="px-3 py-2 font-mono text-brand-600">Specialist <span class="text-gray-400"></span></td>
                                    <td class="px-3 py-2 font-mono text-blue-700">Underwriter</td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-cyan-50/50">
                                    <td class="px-3 py-2 font-mono font-medium">Next_CCM_Month_End</td>
                                    <td class="px-3 py-2 font-mono text-gray-600">Next CCM Month End <span class="text-cyan-600 text-[10px]"> DD/MM/YYYY</span></td>
                                    <td class="px-3 py-2 font-mono text-brand-600">Next CCM Month End <span class="text-cyan-600 text-[10px]"> DD/MM/YYYY</span></td>
                                    <td class="px-3 py-2 font-mono text-blue-700">Next CCM Month End <span class="text-cyan-600 text-[10px]"> DD/MM/YYYY</span></td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-cyan-50/50">
                                    <td class="px-3 py-2 font-mono font-medium">Next_CCM_Approval_Date</td>
                                    <td class="px-3 py-2 font-mono text-gray-600">Next CCM Approval Date <span class="text-cyan-600 text-[10px]"> DD/MM/YYYY</span></td>
                                    <td class="px-3 py-2 font-mono text-brand-600">Next CCM Approval Date <span class="text-cyan-600 text-[10px]"> DD/MM/YYYY</span></td>
                                    <td class="px-3 py-2 font-mono text-blue-700">Next CCM Approval Date <span class="text-cyan-600 text-[10px]"> DD/MM/YYYY</span></td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 font-mono font-medium">CCM_Status</td>
                                    <td class="px-3 py-2 text-gray-600" colspan="3"><em class="text-brand-600"> Calculated based on dates</em></td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <!-- Date Formatting Note -->
                        <div class="mt-4 p-4 rounded-xl bg-cyan-50 border border-cyan-200">
                            <div class="flex items-start gap-3">
                                <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-cyan-500 text-white flex-shrink-0">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="text-sm font-semibold text-cyan-900 mb-1">Date Formatting (T2)</h4>
                                    <p class="text-xs text-cyan-700 mb-2">All date columns are automatically standardized to <span class="font-mono font-semibold bg-white px-1.5 py-0.5 rounded border border-cyan-300">DD/MM/YYYY</span> format.</p>
                                    <div class="text-xs text-cyan-600">
                                        <span class="font-medium">Supported input formats:</span>
                                        <span class="font-mono ml-1">DD-MMM-YYYY</span>  
                                        <span class="font-mono">MM/DD/YYYY</span>  
                                        <span class="font-mono">MMM-DD-YYYY</span>  
                                        <span class="font-mono">YYYY-MM-DD</span>  
                                        <span class="font-mono">Excel serial dates</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End CCM ETL Flow -->

            <!-- ==================== PORTFOLIO DATA ETL FLOW ==================== -->
            <div x-show="selectedFlow === 'portfolio'" class="space-y-6">
                <div class="rounded-2xl border border-gray-200 bg-gradient-to-br from-gray-50 to-white overflow-hidden">
                    <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-brand-50 to-transparent">
                        <div class="flex items-center gap-3">
                            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-brand-500 text-white shadow-lg shadow-brand-500/30">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">Portfolio Data ETL Process</h3>
                                <p class="text-sm text-gray-500">Consolidating regional portfolio files into Portfolio_tw.xlsx</p>
                            </div>
                        </div>
                    </div>

                    <div class="p-6 overflow-x-auto">
                        <!-- Connected Flow Diagram for Portfolio -->
                        <div class="flex flex-col items-center">
                            <!-- Row 1: Source Files + PSE Mapping -->
                            <div class="flex justify-center gap-6">
                                <!-- EMEA Source -->
                                <div class="flow-card w-44 rounded-2xl border-2 border-brand-200 bg-white p-3 shadow-sm hover:border-blue-300">
                                    <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Source</div>
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="px-2 py-0.5 rounded-lg text-xs font-bold bg-brand-100 text-brand-700">EMEA</span>
                                        <span class="text-sm font-semibold text-gray-800">Portfolio</span>
                                    </div>
                                    <p class="text-[10px] text-gray-500">Filter: Fac ID  empty</p>
                                </div>
                                <!-- APAC Source -->
                                <div class="flow-card w-44 rounded-2xl border-2 border-gray-200 bg-white p-3 shadow-sm hover:border-gray-300">
                                    <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Source</div>
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="px-2 py-0.5 rounded-lg text-xs font-bold bg-blue-50 text-blue-700">APAC</span>
                                        <span class="text-sm font-semibold text-gray-800">Portfolio</span>
                                    </div>
                                    <p class="text-[10px] text-gray-500">All rows, C/U status</p>
                                </div>
                                <!-- NAM Source -->
                                <div class="flow-card w-44 rounded-2xl border-2 border-gray-200 bg-white p-3 shadow-sm hover:border-gray-300">
                                    <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Source</div>
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="px-2 py-0.5 rounded-lg text-xs font-bold bg-gray-100 text-gray-700">NAM</span>
                                        <span class="text-sm font-semibold text-gray-800">Portfolio</span>
                                    </div>
                                    <ul class="text-[10px] text-gray-500 space-y-0.5">
                                        <li> Headers from row 4</li>
                                        <li> Filter OUT Risk Cat</li>
                                    </ul>
                                </div>
                                <!-- PSE & Category Mapping -->
                                <div class="flow-card w-48 rounded-2xl border-2 border-brand-200 bg-gradient-to-br from-brand-50 to-white p-3 shadow-sm">
                                    <div class="text-xs font-semibold text-brand-500 uppercase tracking-wider mb-2">Mapping</div>
                                    <div class="flex items-center gap-2 mb-2">
                                        <svg class="w-4 h-4 text-brand-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <span class="text-xs font-semibold text-gray-700">Product_Mapping</span>
                                    </div>
                                    <ul class="text-[9px] text-gray-500 space-y-0.5">
                                        <li> PSE tab: PSE/non-PSE</li>
                                        <li> Category tab: Product_Program, Product_Sub_Program</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Connector: 4 sources merging down -->
                            <div class="relative w-full flex justify-center" style="height: 50px;">
                                <svg class="absolute" width="650" height="50" style="left: 50%; transform: translateX(-50%);">
                                    <path d="M 88 0 L 88 25 L 325 25" class="flow-line" stroke="#9ca3af" stroke-width="2" fill="none"/>
                                    <path d="M 213 0 L 213 25 L 325 25" class="flow-line" stroke="#9ca3af" stroke-width="2" fill="none"/>
                                    <path d="M 437 0 L 437 25 L 325 25" class="flow-line" stroke="#9ca3af" stroke-width="2" fill="none"/>
                                    <path d="M 562 0 L 562 25 L 325 25" class="flow-line" stroke="#a855f7" stroke-width="2" fill="none"/>
                                    <path d="M 325 25 L 325 50" class="flow-line" stroke="#9ca3af" stroke-width="2" fill="none"/>
                                    <circle cx="325" cy="25" r="5" class="flow-dot" fill="#6b7280"/>
                                </svg>
                            </div>

                            <!-- Row 2: Extract Step -->
                            <div class="flow-card rounded-2xl border-2 border-blue-300 bg-gradient-to-br from-blue-50 to-blue-100 p-4 shadow-lg w-80">
                                <div class="flex items-center gap-3 mb-2">
                                    <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-blue-500 text-white font-bold shadow">E</div>
                                    <div>
                                        <h4 class="text-sm font-bold text-blue-900">EXTRACT</h4>
                                        <p class="text-xs text-blue-600">Read 1st sheet + PSE Mapping</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Connector -->
                            <div class="flex flex-col items-center py-1">
                                <div class="connector-vertical h-6"></div>
                                <div class="connector-dot w-2 h-2 rounded-full bg-gray-500"></div>
                            </div>

                            <!-- Row 3: Transform Steps -->
                            <div class="flex justify-center gap-3 flex-wrap">
                                <div class="flow-card w-32 rounded-2xl border-2 border-brand-300 bg-gradient-to-br from-brand-50 to-brand-100 p-2 shadow-lg">
                                    <div class="flex items-center gap-1 mb-1">
                                        <div class="flex h-5 w-5 items-center justify-center rounded-lg bg-brand-500 text-white font-bold text-[9px]">T1</div>
                                        <h4 class="text-[10px] font-bold text-brand-800">Column Map</h4>
                                    </div>
                                    <p class="text-[8px] text-gray-600">Map 30+ columns</p>
                                </div>
                                <div class="flow-card w-32 rounded-2xl border-2 border-cyan-300 bg-gradient-to-br from-cyan-50 to-cyan-100 p-2 shadow-lg">
                                    <div class="flex items-center gap-1 mb-1">
                                        <div class="flex h-5 w-5 items-center justify-center rounded-lg bg-cyan-500 text-white font-bold text-[9px]">T2</div>
                                        <h4 class="text-[10px] font-bold text-cyan-900">Date Format</h4>
                                    </div>
                                    <p class="text-[8px] text-gray-600">DD/MM/YYYY</p>
                                </div>
                                <div class="flow-card w-32 rounded-2xl border-2 border-orange-300 bg-gradient-to-br from-orange-50 to-orange-100 p-2 shadow-lg">
                                    <div class="flex items-center gap-1 mb-1">
                                        <div class="flex h-5 w-5 items-center justify-center rounded-lg bg-orange-500 text-white font-bold text-[9px]">T3</div>
                                        <h4 class="text-[10px] font-bold text-orange-900">Committed</h4>
                                    </div>
                                    <p class="text-[8px] text-gray-600">YES/NO, C/U</p>
                                </div>
                                <div class="flow-card w-32 rounded-2xl border-2 border-pink-300 bg-gradient-to-br from-pink-50 to-pink-100 p-2 shadow-lg">
                                    <div class="flex items-center gap-1 mb-1">
                                        <div class="flex h-5 w-5 items-center justify-center rounded-lg bg-pink-500 text-white font-bold text-[9px]">T4</div>
                                        <h4 class="text-[10px] font-bold text-pink-900">PSE Lookup</h4>
                                    </div>
                                    <p class="text-[8px] text-gray-600">PSE tab</p>
                                </div>
                                <div class="flow-card w-32 rounded-2xl border-2 border-violet-300 bg-gradient-to-br from-violet-50 to-violet-100 p-2 shadow-lg">
                                    <div class="flex items-center gap-1 mb-1">
                                        <div class="flex h-5 w-5 items-center justify-center rounded-lg bg-violet-500 text-white font-bold text-[9px]">T5</div>
                                        <h4 class="text-[10px] font-bold text-violet-900">Category</h4>
                                    </div>
                                    <p class="text-[8px] text-gray-600">Prod Program/Sub</p>
                                </div>
                                <div class="flow-card w-32 rounded-2xl border-2 border-red-300 bg-gradient-to-br from-red-50 to-red-100 p-2 shadow-lg">
                                    <div class="flex items-center gap-1 mb-1">
                                        <div class="flex h-5 w-5 items-center justify-center rounded-lg bg-red-500 text-white font-bold text-[9px]">T6</div>
                                        <h4 class="text-[10px] font-bold text-red-900">Filter</h4>
                                    </div>
                                    <p class="text-[8px] text-gray-600">Region rules</p>
                                </div>
                            </div>

                            <!-- Connector -->
                            <div class="flex flex-col items-center py-1">
                                <div class="connector-vertical h-6"></div>
                                <div class="connector-dot w-2 h-2 rounded-full bg-gray-500"></div>
                            </div>

                            <!-- Row 4: Calculate -->
                            <div class="flow-card rounded-2xl border-2 border-amber-300 bg-gradient-to-br from-amber-50 to-amber-100 p-4 shadow-lg w-80">
                                <div class="flex items-center gap-3 mb-2">
                                    <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-amber-500 text-white font-bold shadow">C</div>
                                    <div>
                                        <h4 class="text-sm font-bold text-amber-900">CALCULATE</h4>
                                        <p class="text-xs text-amber-600">OSUC, Total_OS, Unused, Undrawn</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Connector -->
                            <div class="flex flex-col items-center py-1">
                                <div class="connector-vertical h-6"></div>
                                <div class="connector-dot w-2 h-2 rounded-full bg-gray-500"></div>
                            </div>

                            <!-- Row 5: Load -->
                            <div class="flow-card rounded-2xl border-2 border-gray-300 bg-gradient-to-br from-brand-50 to-brand-100 p-5 shadow-lg w-80">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-blue-500 text-white font-bold shadow">L</div>
                                    <div>
                                        <h4 class="text-sm font-bold text-brand-700">LOAD</h4>
                                        <p class="text-xs text-brand-600">Upload to Portfolio Analytics</p>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-600">Merge all regional portfolio data and upload <span class="font-mono font-semibold">Portfolio_tw.xlsx</span></p>
                            </div>

                            <!-- Connector -->
                            <div class="flex flex-col items-center py-1">
                                <div class="connector-vertical h-6"></div>
                                <div class="connector-dot w-2 h-2 rounded-full bg-gray-500"></div>
                            </div>

                            <!-- Row 6: Aggregate (NEW STEP) -->
                            <div class="flow-card rounded-2xl border-2 border-success-300 bg-gradient-to-br from-success-50 to-success-100 p-4 shadow-lg w-80">
                                <div class="flex items-center gap-3 mb-2">
                                    <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-success-500 text-white font-bold shadow">A</div>
                                    <div>
                                        <h4 class="text-sm font-bold text-success-900">AGGREGATE</h4>
                                        <p class="text-xs text-success-600">Create Incremental History</p>
                                    </div>
                                </div>
                                <div class="mt-2 space-y-1">
                                    <p class="text-[10px] text-gray-600 font-semibold">Group by:</p>
                                    <ul class="text-[9px] text-gray-500 space-y-0.5">
                                        <li> Report_Date, Region</li>
                                        <li> Product_Program & Sub_Program</li>
                                        <li> Committed/Uncommitted, PSE/non-PSE</li>
                                    </ul>
                                    <p class="text-[10px] text-gray-600 font-semibold mt-2">Metrics:</p>
                                    <ul class="text-[9px] text-gray-500 space-y-0.5">
                                        <li> Sum: TFA, OSUC, Total_OS, Unused, Undrawn</li>
                                        <li> Count: Facilities, Relationships, CAs</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Connector: Split to two outputs -->
                            <div class="relative w-full flex justify-center" style="height: 50px;">
                                <svg class="absolute" width="400" height="50" style="left: 50%; transform: translateX(-50%);">
                                    <path d="M 200 0 L 200 25" class="flow-line" stroke="#9ca3af" stroke-width="2" fill="none"/>
                                    <path d="M 200 25 L 100 50" class="flow-line" stroke="#6366f1" stroke-width="2" fill="none"/>
                                    <path d="M 200 25 L 300 50" class="flow-line" stroke="#10b981" stroke-width="2" fill="none"/>
                                    <circle cx="200" cy="25" r="5" class="flow-dot" fill="#6b7280"/>
                                </svg>
                            </div>

                            <!-- Outputs Side by Side -->
                            <div class="flex justify-center gap-6">
                                <!-- Output 1: Portfolio_tw.xlsx -->
                                <div class="flow-card rounded-2xl border-2 border-brand-300 bg-white p-4 shadow-xl w-64">
                                    <div class="flex items-center gap-3">
                                        <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-gradient-to-br from-brand-500 to-brand-700 text-white shadow-lg">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <h4 class="text-xs font-bold text-gray-900">Portfolio_tw.xlsx</h4>
                                            <p class="text-[10px] text-gray-500">Full Detail Data</p>
                                            <p class="text-[10px] text-brand-600 font-medium">~50K+ records</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Output 2: Aggregated History (NEW) -->
                                <div class="flow-card rounded-2xl border-2 border-success-300 bg-gradient-to-br from-success-50 to-white p-4 shadow-xl w-64">
                                    <div class="flex items-center gap-3">
                                        <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-gradient-to-br from-success-500 to-success-700 text-white shadow-lg">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <h4 class="text-xs font-bold text-gray-900">Portfolio_Aggregated_History.xlsx</h4>
                                            <p class="text-[10px] text-gray-500">Weekly Incremental</p>
                                            <p class="text-[10px] text-success-600 font-medium">~4K records/year</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Regional Transformations Details -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- EMEA Transformations -->
                    <div class="rounded-2xl border border-brand-200 bg-gradient-to-br from-blue-50 to-white p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="px-2 py-1 rounded-lg text-xs font-bold bg-blue-500 text-white">EMEA</span>
                            <h4 class="text-sm font-semibold text-gray-800">Specific Rules</h4>
                        </div>
                        <ul class="text-xs text-gray-600 space-y-1.5">
                            <li class="flex items-start gap-2">
                                <span class="w-1 h-1 rounded-full bg-blue-400 mt-1.5 flex-shrink-0"></span>
                                <span><strong>Filter:</strong> Only rows where <code class="bg-blue-100 px-1 rounded text-[10px]">Fac ID</code> is not empty</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="w-1 h-1 rounded-full bg-blue-400 mt-1.5 flex-shrink-0"></span>
                                <span><strong>Committed:</strong> Commited Facility YES  Committed, NO  Uncommitted</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="w-1 h-1 rounded-full bg-blue-400 mt-1.5 flex-shrink-0"></span>
                                <span><strong>Team Lead:</strong> SIMPSON HARRY, PALMER KRISTOPHER, KADELI IRIDA, GRAEME-WILSON DOM  Kristopher Palmer, else Ponniah Raj</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="w-1 h-1 rounded-full bg-blue-400 mt-1.5 flex-shrink-0"></span>
                                <span><strong>PSE:</strong> Facility Type in PSE tab  PSE, else non-PSE</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="w-1 h-1 rounded-full bg-brand-400 mt-1.5 flex-shrink-0"></span>
                                <span><strong>Category:</strong> <code class="bg-brand-100 px-1 rounded text-[10px]">Facility Type</code>  Primary_Key  Product_Program, Product_Sub_Program</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="w-1 h-1 rounded-full bg-purple-400 mt-1.5 flex-shrink-0"></span>
                                <span><strong>Credit Class:</strong> Normalize (P  Pass, SM  Special Mention, etc.)</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="w-1 h-1 rounded-full bg-cyan-400 mt-1.5 flex-shrink-0"></span>
                                <span><strong>Names:</strong> "LASTNAME, FIRSTNAME"  "FirstName LastName"</span>
                            </li>
                        </ul>
                    </div>

                    <!-- APAC Transformations -->
                    <div class="rounded-2xl border border-gray-200 bg-gradient-to-br from-brand-25 to-white p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="px-2 py-1 rounded-lg text-xs font-bold bg-blue-500 text-white">APAC</span>
                            <h4 class="text-sm font-semibold text-gray-800">Specific Rules</h4>
                        </div>
                        <ul class="text-xs text-gray-600 space-y-1.5">
                            <li class="flex items-start gap-2">
                                <span class="w-1 h-1 rounded-full bg-brand-400 mt-1.5 flex-shrink-0"></span>
                                <span><strong>Filter:</strong> Bring all rows (no filtering)</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="w-1 h-1 rounded-full bg-brand-400 mt-1.5 flex-shrink-0"></span>
                                <span><strong>Committed:</strong> Legal Status C  Committed, U  Uncommitted</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="w-1 h-1 rounded-full bg-brand-400 mt-1.5 flex-shrink-0"></span>
                                <span><strong>PSE:</strong> Facility Type in PSE tab  PSE, else non-PSE</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="w-1 h-1 rounded-full bg-brand-400 mt-1.5 flex-shrink-0"></span>
                                <span><strong>Dates:</strong> DD/MM/YYYY, invalid text (DEMAND)  null</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="w-1 h-1 rounded-full bg-brand-400 mt-1.5 flex-shrink-0"></span>
                                <span><strong>Category:</strong> <code class="bg-brand-100 px-1 rounded text-[10px]">Product Program Name</code>  Primary_Key  Product_Program, Product_Sub_Program</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="w-1 h-1 rounded-full bg-purple-400 mt-1.5 flex-shrink-0"></span>
                                <span><strong>Credit Class:</strong> Normalize (P  Pass, SM  Special Mention, etc.)</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="w-1 h-1 rounded-full bg-cyan-400 mt-1.5 flex-shrink-0"></span>
                                <span><strong>Names:</strong> "LASTNAME, FIRSTNAME"  "FirstName LastName"</span>
                            </li>
                        </ul>
                    </div>

                    <!-- NAM Transformations -->
                    <div class="rounded-2xl border border-gray-200 bg-gradient-to-br from-gray-50 to-white p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="px-2 py-1 rounded-lg text-xs font-bold bg-gray-500 text-white">NAM</span>
                            <h4 class="text-sm font-semibold text-gray-800">Specific Rules</h4>
                        </div>
                        <ul class="text-xs text-gray-600 space-y-1.5">
                            <li class="flex items-start gap-2">
                                <span class="w-1 h-1 rounded-full bg-gray-400 mt-1.5 flex-shrink-0"></span>
                                <span><strong>File Structure:</strong> Headers start at row 4 (B4), rows 1-3 skipped, column A empty</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="w-1 h-1 rounded-full bg-gray-400 mt-1.5 flex-shrink-0"></span>
                                <span><strong>Filter OUT:</strong> Risk Category = Clearing, Notation, Settlement</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="w-1 h-1 rounded-full bg-brand-400 mt-1.5 flex-shrink-0"></span>
                                <span><strong>Region Mapping:</strong> Control Unit  <code class="bg-brand-100 px-1 rounded text-[10px]">Regions_Mapping.xlsx</code>  Region (IPB  NAM)</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="w-1 h-1 rounded-full bg-gray-400 mt-1.5 flex-shrink-0"></span>
                                <span><strong>Region Filter:</strong> Keep only NAM and LATAM, filter out SARG and non-matches</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="w-1 h-1 rounded-full bg-gray-400 mt-1.5 flex-shrink-0"></span>
                                <span><strong>PSE:</strong> Product Program OR Facility Type in PSE tab  PSE, else non-PSE</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="w-1 h-1 rounded-full bg-gray-400 mt-1.5 flex-shrink-0"></span>
                                <span><strong>Dates:</strong> DD/MM/YYYY, invalid text  null</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="w-1 h-1 rounded-full bg-brand-400 mt-1.5 flex-shrink-0"></span>
                                <span><strong>Category:</strong> <code class="bg-brand-100 px-1 rounded text-[10px]">Product Program</code>  Primary_Key  Product_Program, Product_Sub_Program</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="w-1 h-1 rounded-full bg-purple-400 mt-1.5 flex-shrink-0"></span>
                                <span><strong>Credit Class:</strong> Normalize (P  Pass, SM  Special Mention, etc.)</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="w-1 h-1 rounded-full bg-cyan-400 mt-1.5 flex-shrink-0"></span>
                                <span><strong>Names:</strong> "LASTNAME, FIRSTNAME"  "FirstName LastName"</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Post-Merge Calculations -->
                <div class="rounded-2xl border border-amber-200 bg-white overflow-hidden">
                    <div class="px-6 py-4 border-b border-amber-100 bg-amber-50">
                        <h3 class="text-base font-semibold text-amber-900">Post-Merge Calculations</h3>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- EMEA Only Calculations -->
                            <div class="rounded-xl border border-brand-200 bg-gradient-to-br from-blue-50 to-white p-4">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="px-2 py-1 rounded-lg text-xs font-bold bg-blue-500 text-white">EMEA Only</span>
                                </div>
                                <div class="space-y-2 text-xs">
                                    <div class="bg-white rounded-lg p-2 border border-brand-200">
                                        <span class="font-semibold text-blue-700">OSUC =</span> If Committed  Fac_Amount, else Direct_OS + Contingent_OS + PSE_OS
                                    </div>
                                    <div class="bg-white rounded-lg p-2 border border-brand-200">
                                        <span class="font-semibold text-blue-700">Total_Unused_Exposure =</span> If Committed  Fac_Amount - (Direct_OS + Contingent_OS + PSE_OS), else 0
                                    </div>
                                </div>
                            </div>

                            <!-- All Regions Calculations -->
                            <div class="rounded-xl border border-amber-200 bg-gradient-to-br from-amber-50 to-white p-4">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="px-2 py-1 rounded-lg text-xs font-bold bg-brand-100 text-brand-700">EMEA</span>
                                    <span class="px-2 py-1 rounded-lg text-xs font-bold bg-blue-50 text-blue-700">APAC</span>
                                    <span class="px-2 py-1 rounded-lg text-xs font-bold bg-gray-100 text-gray-700">NAM</span>
                                    <span class="text-xs text-gray-500 ml-1">All Regions</span>
                                </div>
                                <div class="space-y-2 text-xs">
                                    <div class="bg-white rounded-lg p-2 border">
                                        <span class="font-semibold">Total_OS =</span> Direct_OS + Contingent_OS + PSE_OS
                                    </div>
                                    <div class="bg-white rounded-lg p-2 border">
                                        <span class="font-semibold">Total_Undrawn =</span> Fac_Amount - (Direct_OS + Contingent_OS + PSE_OS)
                                    </div>
                                </div>
                                <p class="text-[10px] text-gray-500 mt-3 italic">Note: APAC & NAM use source values for OSUC and Total_Unused_Exposure</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Portfolio Column Mapping Table -->
                <div class="rounded-2xl border border-gray-200 bg-white overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100 bg-brand-50">
                        <h3 class="text-base font-semibold text-gray-900">Column Mapping Reference (Portfolio_tw.xlsx - 34 columns)</h3>
                    </div>
                    <div class="p-4 overflow-x-auto">
                        <table class="min-w-full text-[10px]">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-2 py-2 text-left font-semibold text-brand-700 border-b bg-brand-50">Output Column</th>
                                    <th class="px-2 py-2 text-left font-semibold text-blue-700 border-b bg-blue-50">EMEA Source</th>
                                    <th class="px-2 py-2 text-left font-semibold text-brand-600 border-b bg-blue-50">APAC Source</th>
                                    <th class="px-2 py-2 text-left font-semibold text-gray-600 border-b bg-gray-50">NAM Source</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <tr class="hover:bg-gray-50 bg-cyan-50/30">
                                    <td class="px-2 py-1 font-mono font-medium">Report_Date</td>
                                    <td class="px-2 py-1 font-mono text-blue-700">As Of Date</td>
                                    <td class="px-2 py-1 font-mono text-brand-600">Position Date <span class="text-cyan-500">(DD-MMM-YYYY)  DD/MM/YYYY</span></td>
                                    <td class="px-2 py-1 font-mono text-gray-600">As Of Date</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-2 py-1 font-mono font-medium">Region</td>
                                    <td class="px-2 py-1 font-mono text-blue-700">"EMEA"</td>
                                    <td class="px-2 py-1 font-mono text-brand-600">"APAC"</td>
                                    <td class="px-2 py-1 font-mono text-gray-600">"NAM"</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-2 py-1 font-mono font-medium">Facility_ID</td>
                                    <td class="px-2 py-1 font-mono text-blue-700">Fac ID</td>
                                    <td class="px-2 py-1 font-mono text-brand-600">Facility Id</td>
                                    <td class="px-2 py-1 font-mono text-gray-600">Facility ID</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-2 py-1 font-mono font-medium">Parent_Facility_ID</td>
                                    <td class="px-2 py-1 font-mono text-blue-700">Parent Facility ID</td>
                                    <td class="px-2 py-1 font-mono text-brand-600">Facility Id</td>
                                    <td class="px-2 py-1 font-mono text-gray-600">GFRN</td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-brand-50/30">
                                    <td class="px-2 py-1 font-mono font-medium">Product_Program</td>
                                    <td class="px-2 py-1 font-mono text-brand-500">Category tab (Facility Type  Primary_Key)</td>
                                    <td class="px-2 py-1 font-mono text-brand-500">Category tab (Product Program Name  Primary_Key)</td>
                                    <td class="px-2 py-1 font-mono text-brand-500">Category tab (Product Program  Primary_Key)</td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-brand-50/30">
                                    <td class="px-2 py-1 font-mono font-medium">Product_Sub_Program</td>
                                    <td class="px-2 py-1 font-mono text-brand-500">Category tab (Sub_Category)</td>
                                    <td class="px-2 py-1 font-mono text-brand-500">Category tab (Sub_Category)</td>
                                    <td class="px-2 py-1 font-mono text-brand-500">Category tab (Sub_Category)</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-2 py-1 font-mono font-medium">Management_Status</td>
                                    <td class="px-2 py-1 font-mono text-blue-700">DM/CM Flag</td>
                                    <td class="px-2 py-1 font-mono text-brand-600">Management status</td>
                                    <td class="px-2 py-1 font-mono text-gray-600">Management Status</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-2 py-1 font-mono font-medium">Facility_Type</td>
                                    <td class="px-2 py-1 font-mono text-blue-700">Facility Type</td>
                                    <td class="px-2 py-1 font-mono text-brand-600">Facility Type</td>
                                    <td class="px-2 py-1 font-mono text-gray-600">Facility Type</td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-orange-50/30">
                                    <td class="px-2 py-1 font-mono font-medium">Committed_Uncommitted</td>
                                    <td class="px-2 py-1 font-mono text-blue-700">Commited Facility <span class="text-orange-500">(YESCommitted, NOUncommitted)</span></td>
                                    <td class="px-2 py-1 font-mono text-brand-600">Legal Status <span class="text-orange-500">(CCommitted, UUncommitted)</span></td>
                                    <td class="px-2 py-1 font-mono text-gray-600">Committed / Uncommitted Flag</td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-red-50/30">
                                    <td class="px-2 py-1 font-mono font-medium">Risk_Category</td>
                                    <td class="px-2 py-1 font-mono text-gray-400">-</td>
                                    <td class="px-2 py-1 font-mono text-brand-600">Risk Category</td>
                                    <td class="px-2 py-1 font-mono text-gray-600">Risk Category <span class="text-red-500">(Filter OUT: Clearing, Notation, Settlement)</span></td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-2 py-1 font-mono font-medium">Relationship_ID</td>
                                    <td class="px-2 py-1 font-mono text-blue-700">Relationship ID</td>
                                    <td class="px-2 py-1 font-mono text-brand-600">Relationship Id</td>
                                    <td class="px-2 py-1 font-mono text-gray-600">CARE Relationship ID</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-2 py-1 font-mono font-medium">Relationship_Name</td>
                                    <td class="px-2 py-1 font-mono text-blue-700">EG Title</td>
                                    <td class="px-2 py-1 font-mono text-gray-400">-</td>
                                    <td class="px-2 py-1 font-mono text-gray-600">Relationship Short Name</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-2 py-1 font-mono font-medium">CAID</td>
                                    <td class="px-2 py-1 font-mono text-blue-700">CA ID</td>
                                    <td class="px-2 py-1 font-mono text-brand-600">CA No.</td>
                                    <td class="px-2 py-1 font-mono text-gray-600">CA ID</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-2 py-1 font-mono font-medium">Lead_Underwriter</td>
                                    <td class="px-2 py-1 font-mono text-blue-700">Investment Finance Lead Underwriter</td>
                                    <td class="px-2 py-1 font-mono text-brand-600">Investment Finance Lead Underwriter Name</td>
                                    <td class="px-2 py-1 font-mono text-gray-600">Investment Finance Lead Underwriter</td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-indigo-50/30">
                                    <td class="px-2 py-1 font-mono font-medium">Underwriting_Team_Lead</td>
                                    <td class="px-2 py-1 font-mono text-indigo-600">Derived: SIMPSON/PALMER/KADELI/GRAEME-WILSON  Kristopher Palmer, else Ponniah Raj</td>
                                    <td class="px-2 py-1 font-mono text-brand-600">Team Lead</td>
                                    <td class="px-2 py-1 font-mono text-gray-600">Investment Finance Underwriting Team Lead</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-2 py-1 font-mono font-medium">Control_Unit</td>
                                    <td class="px-2 py-1 font-mono text-blue-700">Control Unit</td>
                                    <td class="px-2 py-1 font-mono text-brand-600">Control unit</td>
                                    <td class="px-2 py-1 font-mono text-gray-600">Control Unit</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-2 py-1 font-mono font-medium">Fac_Amount</td>
                                    <td class="px-2 py-1 font-mono text-blue-700">Approved Line Amount</td>
                                    <td class="px-2 py-1 font-mono text-brand-600">TFA (USD)</td>
                                    <td class="px-2 py-1 font-mono text-gray-600">Total Reported Facility Amount</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-2 py-1 font-mono font-medium">Direct_OS</td>
                                    <td class="px-2 py-1 font-mono text-blue-700">Total Direct OS</td>
                                    <td class="px-2 py-1 font-mono text-brand-600">Direct (USD)</td>
                                    <td class="px-2 py-1 font-mono text-gray-600">Direct O/S (Fac Lvl)</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-2 py-1 font-mono font-medium">Contingent_OS</td>
                                    <td class="px-2 py-1 font-mono text-blue-700">Total Cont OS</td>
                                    <td class="px-2 py-1 font-mono text-brand-600">Contingent (USD)</td>
                                    <td class="px-2 py-1 font-mono text-gray-600">Contingent O/S (Fac Lvl)</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-2 py-1 font-mono font-medium">PSE_OS</td>
                                    <td class="px-2 py-1 font-mono text-blue-700">Total FX / Derivatives OS</td>
                                    <td class="px-2 py-1 font-mono text-brand-600">PSE (USD)</td>
                                    <td class="px-2 py-1 font-mono text-gray-600">PSE O/S (Fac Lvl)</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-2 py-1 font-mono font-medium">Total_Comm_Exposure</td>
                                    <td class="px-2 py-1 font-mono text-gray-400">-</td>
                                    <td class="px-2 py-1 font-mono text-gray-400">-</td>
                                    <td class="px-2 py-1 font-mono text-gray-600">Total Comm Exposure (Fac Lvl)</td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-cyan-50/30">
                                    <td class="px-2 py-1 font-mono font-medium">Maturity_Date</td>
                                    <td class="px-2 py-1 font-mono text-blue-700">Facility Maturity Date <span class="text-cyan-500"> DD/MM/YYYY</span></td>
                                    <td class="px-2 py-1 font-mono text-brand-600">Mainline Maturity Date <span class="text-cyan-500">(DD-MMM-YYYY)  DD/MM/YYYY</span></td>
                                    <td class="px-2 py-1 font-mono text-gray-600">Maturity Date Or Demand <span class="text-cyan-500"> DD/MM/YYYY</span></td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-2 py-1 font-mono font-medium">Product_Underwriter</td>
                                    <td class="px-2 py-1 font-mono text-blue-700">Investment Finance Lead Underwriter</td>
                                    <td class="px-2 py-1 font-mono text-brand-600">Investment Finance Lead Underwriter Name</td>
                                    <td class="px-2 py-1 font-mono text-gray-600">Investment Finance Product Underwriter</td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-cyan-50/30">
                                    <td class="px-2 py-1 font-mono font-medium">CA_Expiration_Date</td>
                                    <td class="px-2 py-1 font-mono text-blue-700">CA Maturity Date <span class="text-cyan-500"> DD/MM/YYYY</span></td>
                                    <td class="px-2 py-1 font-mono text-brand-600">CA Expiration Date <span class="text-cyan-500">(DD/MM/YYYY)  DD/MM/YYYY</span></td>
                                    <td class="px-2 py-1 font-mono text-gray-600">CA Expiration Date <span class="text-cyan-500"> DD/MM/YYYY</span></td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-2 py-1 font-mono font-medium">Credit_Classification</td>
                                    <td class="px-2 py-1 font-mono text-blue-700">Credit Classification</td>
                                    <td class="px-2 py-1 font-mono text-brand-600">Classification</td>
                                    <td class="px-2 py-1 font-mono text-gray-600">Credit Classification</td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-pink-50/30">
                                    <td class="px-2 py-1 font-mono font-medium">PSE_non_PSE</td>
                                    <td class="px-2 py-1 font-mono text-pink-600">PSE tab (Facility Type lookup)</td>
                                    <td class="px-2 py-1 font-mono text-pink-600">PSE tab (Facility Type lookup)</td>
                                    <td class="px-2 py-1 font-mono text-pink-600">PSE tab (Product Program OR Facility Type lookup)</td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-cyan-50/30">
                                    <td class="px-2 py-1 font-mono font-medium">Facility_First_Approval_Date</td>
                                    <td class="px-2 py-1 font-mono text-blue-700">Facility First Approval Date <span class="text-cyan-500"> DD/MM/YYYY</span></td>
                                    <td class="px-2 py-1 font-mono text-gray-400">-</td>
                                    <td class="px-2 py-1 font-mono text-gray-600">Facility Approval Date <span class="text-cyan-500"> DD/MM/YYYY</span></td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-cyan-50/30">
                                    <td class="px-2 py-1 font-mono font-medium">Origination_Date</td>
                                    <td class="px-2 py-1 font-mono text-blue-700">Origination Date <span class="text-cyan-500"> DD/MM/YYYY</span></td>
                                    <td class="px-2 py-1 font-mono text-brand-600">Original Origination Date <span class="text-cyan-500">(dd-MMM-YY)  DD/MM/YYYY</span></td>
                                    <td class="px-2 py-1 font-mono text-gray-600">Origination Date <span class="text-cyan-500"> DD/MM/YYYY</span></td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-green-50/30">
                                    <td class="px-2 py-1 font-mono font-medium">CA_Review</td>
                                    <td class="px-2 py-1 font-mono text-blue-700">CA Review Y/N <span class="text-green-500">(YES/YYes, NO/NNo)</span></td>
                                    <td class="px-2 py-1 font-mono text-gray-400">-</td>
                                    <td class="px-2 py-1 font-mono text-gray-400">-</td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-blue-50/30">
                                    <td class="px-2 py-1 font-mono font-medium">OSUC</td>
                                    <td class="px-2 py-1 font-mono text-blue-600">If Committed: Fac_Amount, else: Direct_OS + Contingent_OS + PSE_OS</td>
                                    <td class="px-2 py-1 font-mono text-blue-600">If Committed: Fac_Amount, else: Direct_OS + Contingent_OS + PSE_OS</td>
                                    <td class="px-2 py-1 font-mono text-gray-600">Total Comm Exposure (Fac Lvl)</td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-amber-50/30">
                                    <td class="px-2 py-1 font-mono font-medium">Total_OS</td>
                                    <td class="px-2 py-1 font-mono text-amber-600" colspan="3">Calculated (All Regions): Direct_OS + Contingent_OS + PSE_OS</td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-blue-50/30">
                                    <td class="px-2 py-1 font-mono font-medium">Total_Unused_Exposure</td>
                                    <td class="px-2 py-1 font-mono text-blue-600">If Committed: Fac_Amount - Total_OS, else: 0</td>
                                    <td class="px-2 py-1 font-mono text-blue-600">If Committed: Fac_Amount - Total_OS, else: 0</td>
                                    <td class="px-2 py-1 font-mono text-gray-600">Unused Commitment (Fac Lvl)</td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-amber-50/30">
                                    <td class="px-2 py-1 font-mono font-medium">Total_Undrawn</td>
                                    <td class="px-2 py-1 font-mono text-amber-600" colspan="3">Calculated (All Regions): Fac_Amount - (Direct_OS + Contingent_OS + PSE_OS)</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-2 py-1 font-mono font-medium">ROTCE</td>
                                    <td class="px-2 py-1 font-mono text-gray-400" colspan="3">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- End Portfolio Data ETL Flow -->

            <!-- ==================== COVENANTS ETL FLOW ==================== -->
            <div x-show="selectedFlow === 'covenants'" class="space-y-6">
                <div class="rounded-2xl border border-gray-200 bg-gradient-to-br from-gray-50 to-white overflow-hidden">
                    <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-brand-25 to-transparent">
                        <div class="flex items-center gap-3">
                            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-brand-500 text-white shadow-lg shadow-brand-500/30">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">Covenants ETL Process</h3>
                                <p class="text-sm text-gray-500">Consolidating regional covenants files into Covenants_tw.xlsx</p>
                            </div>
                        </div>
                    </div>

                    <div class="p-6 overflow-x-auto">
                        <!-- Connected Flow Diagram for Covenants -->
                        <div class="flex flex-col items-center">
                            <!-- Row 1: Source Files -->
                            <div class="flex justify-center gap-8">
                                <!-- NAM Source -->
                                <div class="flow-card w-48 rounded-2xl border-2 border-gray-200 bg-white p-4 shadow-sm hover:border-gray-300">
                                    <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Source</div>
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="px-2 py-1 rounded-lg text-xs font-bold bg-gray-100 text-gray-700">NAM</span>
                                        <span class="text-sm font-semibold text-gray-800">Covenants</span>
                                    </div>
                                    <div class="flex items-center gap-2 text-xs text-gray-600">
                                        <span class="w-1.5 h-1.5 rounded-full bg-gray-400"></span>
                                        <span class="font-mono bg-gray-50 px-1.5 py-0.5 rounded text-[10px]">1st Sheet (always)</span>
                                    </div>
                                </div>
                                <!-- APAC Source -->
                                <div class="flow-card w-48 rounded-2xl border-2 border-gray-200 bg-white p-4 shadow-sm hover:border-gray-300">
                                    <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Source</div>
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="px-2 py-1 rounded-lg text-xs font-bold bg-blue-50 text-blue-700">APAC</span>
                                        <span class="text-sm font-semibold text-gray-800">Covenants</span>
                                    </div>
                                    <div class="flex items-center gap-2 text-xs text-gray-600">
                                        <span class="w-1.5 h-1.5 rounded-full bg-brand-400"></span>
                                        <span class="font-mono bg-blue-50 px-1.5 py-0.5 rounded text-[10px]">1st Sheet (always)</span>
                                    </div>
                                </div>
                                <!-- EMEA Source -->
                                <div class="flow-card w-48 rounded-2xl border-2 border-brand-200 bg-white p-4 shadow-sm hover:border-blue-300">
                                    <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Source</div>
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="px-2 py-1 rounded-lg text-xs font-bold bg-brand-100 text-brand-700">EMEA</span>
                                        <span class="text-sm font-semibold text-gray-800">Covenants</span>
                                    </div>
                                    <div class="flex items-center gap-2 text-xs text-gray-600">
                                        <span class="w-1.5 h-1.5 rounded-full bg-blue-400"></span>
                                        <span class="font-mono bg-blue-50 px-1.5 py-0.5 rounded text-[10px]">1st Sheet (always)</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Connector: 3 sources merging down -->
                            <div class="relative w-full flex justify-center" style="height: 50px;">
                                <svg class="absolute" width="500" height="50" style="left: 50%; transform: translateX(-50%);">
                                    <path d="M 75 0 L 75 25 L 250 25" class="flow-line" stroke="#9ca3af" stroke-width="2" fill="none"/>
                                    <path d="M 250 0 L 250 25" class="flow-line" stroke="#9ca3af" stroke-width="2" fill="none"/>
                                    <path d="M 425 0 L 425 25 L 250 25" class="flow-line" stroke="#9ca3af" stroke-width="2" fill="none"/>
                                    <path d="M 250 25 L 250 50" class="flow-line" stroke="#9ca3af" stroke-width="2" fill="none"/>
                                    <circle cx="250" cy="25" r="5" class="flow-dot" fill="#6b7280"/>
                                </svg>
                            </div>

                            <!-- Row 2: Extract Step -->
                            <div class="flow-card rounded-2xl border-2 border-blue-300 bg-gradient-to-br from-blue-50 to-blue-100 p-5 shadow-lg w-80">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-blue-500 text-white font-bold shadow">E</div>
                                    <div>
                                        <h4 class="text-sm font-bold text-blue-900">EXTRACT</h4>
                                        <p class="text-xs text-blue-600">Read First Sheet</p>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-600">Read covenant data from <span class="font-semibold">first sheet</span> of each regional Excel file (New Covenants Module export)</p>
                            </div>

                            <!-- Connector: Down arrow -->
                            <div class="flex flex-col items-center py-1">
                                <div class="connector-vertical h-8"></div>
                                <div class="connector-dot w-2 h-2 rounded-full bg-gray-500"></div>
                            </div>

                            <!-- Row 3: Transform Steps -->
                            <div class="flex justify-center gap-4">
                                <!-- Column Mapping -->
                                <div class="flow-card w-48 rounded-2xl border-2 border-brand-300 bg-gradient-to-br from-brand-50 to-brand-100 p-3 shadow-lg">
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="flex h-7 w-7 items-center justify-center rounded-lg bg-brand-500 text-white font-bold text-xs shadow">T1</div>
                                        <h4 class="text-xs font-bold text-brand-800">Column Mapping</h4>
                                    </div>
                                    <ul class="text-[10px] text-gray-600 space-y-0.5">
                                        <li class="flex items-center gap-1">
                                            <span class="w-1 h-1 rounded-full bg-brand-400"></span>
                                            Map 26 columns
                                        </li>
                                        <li class="flex items-center gap-1">
                                            <span class="w-1 h-1 rounded-full bg-brand-400"></span>
                                            As Of Date  Report_Date
                                        </li>
                                        <li class="flex items-center gap-1">
                                            <span class="w-1 h-1 rounded-full bg-brand-400"></span>
                                            Standardize names
                                        </li>
                                    </ul>
                                </div>
                                <!-- Date Formatting -->
                                <div class="flow-card w-48 rounded-2xl border-2 border-cyan-300 bg-gradient-to-br from-cyan-50 to-cyan-100 p-3 shadow-lg">
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="flex h-7 w-7 items-center justify-center rounded-lg bg-cyan-500 text-white font-bold text-xs shadow">T2</div>
                                        <h4 class="text-xs font-bold text-cyan-900">Date Format</h4>
                                    </div>
                                    <p class="text-[10px] text-gray-600 mb-1">Standardize to:</p>
                                    <div class="flex items-center justify-center mb-1">
                                        <span class="px-1.5 py-0.5 rounded text-[10px] font-mono bg-white border border-cyan-200 text-cyan-700 font-semibold">DD/MM/YYYY</span>
                                    </div>
                                    <div class="text-[9px] text-gray-500">
                                        Covenant Due Date, Deferred Date, 45 Days Past Due
                                    </div>
                                </div>
                                <!-- Status Normalization -->
                                <div class="flow-card w-48 rounded-2xl border-2 border-orange-300 bg-gradient-to-br from-orange-50 to-orange-100 p-3 shadow-lg">
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="flex h-7 w-7 items-center justify-center rounded-lg bg-orange-500 text-white font-bold text-xs shadow">T3</div>
                                        <h4 class="text-xs font-bold text-orange-900">Status Norm</h4>
                                    </div>
                                    <p class="text-[10px] text-gray-600 mb-1">Normalize values:</p>
                                    <div class="space-y-1 text-[9px]">
                                        <div class="flex items-center gap-1">
                                            <span class="font-mono bg-white px-1 rounded border border-orange-200 text-orange-600">Past_Due</span>
                                            <span class="text-gray-400"></span>
                                            <span class="font-semibold text-orange-700">Past Due</span>
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <span class="font-mono bg-white px-1 rounded border border-orange-200 text-orange-600">1 to 30</span>
                                            <span class="text-gray-400"></span>
                                            <span class="font-semibold text-orange-700">0-30 Days</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- Filter -->
                                <div class="flow-card w-48 rounded-2xl border-2 border-red-300 bg-gradient-to-br from-red-50 to-red-100 p-3 shadow-lg">
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="flex h-7 w-7 items-center justify-center rounded-lg bg-red-500 text-white font-bold text-xs shadow">T4</div>
                                        <h4 class="text-xs font-bold text-red-900">Filter Rows</h4>
                                    </div>
                                    <p class="text-[10px] text-gray-600 mb-1">Remove rows where:</p>
                                    <div class="flex flex-wrap gap-1">
                                        <span class="px-1 py-0.5 rounded text-[9px] font-mono bg-white border border-red-200 text-red-600">Internal Cov*</span>
                                        <span class="text-[9px] text-gray-500">in Description or</span>
                                        <span class="px-1 py-0.5 rounded text-[9px] font-mono bg-white border border-red-200 text-red-600">Internal*</span>
                                        <span class="text-[9px] text-gray-500">in Remarks</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Connector: 4 transforms merging down -->
                            <div class="relative w-full flex justify-center" style="height: 50px;">
                                <svg class="absolute" width="650" height="50" style="left: 50%; transform: translateX(-50%);">
                                    <path d="M 85 0 L 85 25 L 325 25" class="flow-line" stroke="#9ca3af" stroke-width="2" fill="none"/>
                                    <path d="M 230 0 L 230 25 L 325 25" class="flow-line" stroke="#9ca3af" stroke-width="2" fill="none"/>
                                    <path d="M 420 0 L 420 25 L 325 25" class="flow-line" stroke="#9ca3af" stroke-width="2" fill="none"/>
                                    <path d="M 565 0 L 565 25 L 325 25" class="flow-line" stroke="#9ca3af" stroke-width="2" fill="none"/>
                                    <path d="M 325 25 L 325 50" class="flow-line" stroke="#9ca3af" stroke-width="2" fill="none"/>
                                    <circle cx="325" cy="25" r="5" class="flow-dot" fill="#6b7280"/>
                                </svg>
                            </div>

                            <!-- Row 4: Load Step -->
                            <div class="flow-card rounded-2xl border-2 border-gray-300 bg-gradient-to-br from-brand-50 to-brand-100 p-5 shadow-lg w-80">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-blue-500 text-white font-bold shadow">L</div>
                                    <div>
                                        <h4 class="text-sm font-bold text-brand-700">LOAD</h4>
                                        <p class="text-xs text-brand-600">Upload to Portfolio Analytics</p>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-600">Merge all regional covenants data and upload <span class="font-mono font-semibold">Covenants_tw.xlsx</span></p>
                            </div>

                            <!-- Connector: Down arrow with arrowhead -->
                            <div class="flex flex-col items-center py-1">
                                <div class="connector-vertical h-6"></div>
                                <svg class="w-4 h-4 text-gray-500 connector-dot" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 16l-6-6h12l-6 6z"/>
                                </svg>
                            </div>

                            <!-- Output -->
                            <div class="flow-card rounded-2xl border-2 border-brand-300 bg-white p-5 shadow-xl">
                                <div class="flex items-center gap-4">
                                    <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-gradient-to-br from-brand-500 to-brand-700 text-white shadow-lg">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h4 class="text-sm font-bold text-gray-900">Covenants_tw.xlsx</h4>
                                        <p class="text-xs text-gray-500">Consolidated Covenants Data (26 columns)</p>
                                        <p class="text-xs text-brand-600 font-medium mt-1">Available in Portfolio Analytics of LPTM</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Column Mapping Table -->
                <div class="rounded-2xl border border-gray-200 bg-white overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
                        <h3 class="text-base font-semibold text-gray-900">Column Mapping Reference</h3>
                    </div>
                    <div class="p-6 overflow-x-auto">
                        <table class="min-w-full text-xs">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-3 py-2.5 text-left font-semibold text-gray-700 border-b">Source Column (Reports)</th>
                                    <th class="px-3 py-2.5 text-left font-semibold text-brand-700 border-b bg-brand-50">Output Column (Covenants_tw.xlsx)</th>
                                    <th class="px-3 py-2.5 text-left font-semibold text-gray-600 border-b">Notes</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <tr class="hover:bg-gray-50 bg-cyan-50/50">
                                    <td class="px-3 py-2 font-mono">As Of Date</td>
                                    <td class="px-3 py-2 font-mono text-brand-700">Report_Date</td>
                                    <td class="px-3 py-2 text-cyan-600 text-[10px]"> DD/MM/YYYY</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 font-mono">Region</td>
                                    <td class="px-3 py-2 font-mono text-brand-700">Region</td>
                                    <td class="px-3 py-2 text-gray-500 text-[10px]">-</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 font-mono">Originating Unit</td>
                                    <td class="px-3 py-2 font-mono text-brand-700">Origination_Unit</td>
                                    <td class="px-3 py-2 text-gray-500 text-[10px]">-</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 font-mono">Investment Finance Underwriting Team Lead</td>
                                    <td class="px-3 py-2 font-mono text-brand-700">Underwriting_Team_Lead</td>
                                    <td class="px-3 py-2 text-gray-500 text-[10px]">-</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 font-mono">Investment Finance Lead Underwriter</td>
                                    <td class="px-3 py-2 font-mono text-brand-700">Lead_Underwriter</td>
                                    <td class="px-3 py-2 text-gray-500 text-[10px]">-</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 font-mono">Investment Finance Product Underwriter</td>
                                    <td class="px-3 py-2 font-mono text-brand-700">Product_Underwriter</td>
                                    <td class="px-3 py-2 text-gray-500 text-[10px]">-</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 font-mono">OU Expense Code</td>
                                    <td class="px-3 py-2 font-mono text-brand-700">OU_Expense_Code</td>
                                    <td class="px-3 py-2 text-gray-500 text-[10px]">-</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 font-mono">CU Expense Code</td>
                                    <td class="px-3 py-2 font-mono text-brand-700">CU_Expense_Code</td>
                                    <td class="px-3 py-2 text-gray-500 text-[10px]">-</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 font-mono">Relationship ID</td>
                                    <td class="px-3 py-2 font-mono text-brand-700">Relationship_ID</td>
                                    <td class="px-3 py-2 text-gray-500 text-[10px]">-</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 font-mono">Relationship Name</td>
                                    <td class="px-3 py-2 font-mono text-brand-700">Relationship_Name</td>
                                    <td class="px-3 py-2 text-gray-500 text-[10px]">-</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 font-mono">Borrowers Name</td>
                                    <td class="px-3 py-2 font-mono text-brand-700">Borrowers_Name</td>
                                    <td class="px-3 py-2 text-gray-500 text-[10px]">-</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 font-mono">CA Number</td>
                                    <td class="px-3 py-2 font-mono text-brand-700">CA_Number</td>
                                    <td class="px-3 py-2 text-gray-500 text-[10px]">-</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 font-mono">Facility Number</td>
                                    <td class="px-3 py-2 font-mono text-brand-700">Facility_Number</td>
                                    <td class="px-3 py-2 text-gray-500 text-[10px]">-</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 font-mono">Product Program Name</td>
                                    <td class="px-3 py-2 font-mono text-brand-700">Product_Program_Name</td>
                                    <td class="px-3 py-2 text-gray-500 text-[10px]">-</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 font-mono">Facility Type</td>
                                    <td class="px-3 py-2 font-mono text-brand-700">Facility_Type</td>
                                    <td class="px-3 py-2 text-gray-500 text-[10px]">-</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 font-mono">Covenant Number</td>
                                    <td class="px-3 py-2 font-mono text-brand-700">Covenant_Number</td>
                                    <td class="px-3 py-2 text-gray-500 text-[10px]">-</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 font-mono">Periodicity / Frequency</td>
                                    <td class="px-3 py-2 font-mono text-brand-700">Periodic_Frequency</td>
                                    <td class="px-3 py-2 text-gray-500 text-[10px]">-</td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-cyan-50/50">
                                    <td class="px-3 py-2 font-mono">Covenant Due Date</td>
                                    <td class="px-3 py-2 font-mono text-brand-700">Covenant_Due_Date</td>
                                    <td class="px-3 py-2 text-cyan-600 text-[10px]"> DD/MM/YYYY</td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-cyan-50/50">
                                    <td class="px-3 py-2 font-mono">Covenant Deferred Date</td>
                                    <td class="px-3 py-2 font-mono text-brand-700">Covenant_Deferred_Date</td>
                                    <td class="px-3 py-2 text-cyan-600 text-[10px]"> DD/MM/YYYY</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 font-mono">No of Days Past Due</td>
                                    <td class="px-3 py-2 font-mono text-brand-700">Days_Past_Due</td>
                                    <td class="px-3 py-2 text-gray-500 text-[10px]">-</td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-orange-50/50">
                                    <td class="px-3 py-2 font-mono">Coming Due / Past Due</td>
                                    <td class="px-3 py-2 font-mono text-brand-700">Coming_Due_Past_Due</td>
                                    <td class="px-3 py-2 text-orange-600 text-[10px]">Remove underscores (Past_Due  Past Due)</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 font-mono">Past Due Category</td>
                                    <td class="px-3 py-2 font-mono text-brand-700">Past_Due_Category</td>
                                    <td class="px-3 py-2 text-orange-600 text-[10px]">Normalize format: "1 to 30 Days"  "0-30 Days"</td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-red-50/50">
                                    <td class="px-3 py-2 font-mono">Covenant Description</td>
                                    <td class="px-3 py-2 font-mono text-brand-700">Covenant_Description</td>
                                    <td class="px-3 py-2 text-red-600 text-[10px]">Filter: Remove "Internal Cov*" rows</td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-red-50/50">
                                    <td class="px-3 py-2 font-mono">Covenant Remarks</td>
                                    <td class="px-3 py-2 font-mono text-brand-700">Covenant_Remarks</td>
                                    <td class="px-3 py-2 text-red-600 text-[10px]">Filter: Remove "Internal*" rows</td>
                                </tr>
                                <tr class="hover:bg-gray-50 bg-cyan-50/50">
                                    <td class="px-3 py-2 font-mono">45 Days Past Due Date</td>
                                    <td class="px-3 py-2 font-mono text-brand-700">45_Days_Past_Due_Date</td>
                                    <td class="px-3 py-2 text-cyan-600 text-[10px]"> DD/MM/YYYY</td>
                                </tr>
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 font-mono">Control Unit</td>
                                    <td class="px-3 py-2 font-mono text-brand-700">Control_Unit</td>
                                    <td class="px-3 py-2 text-gray-500 text-[10px]">-</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <!-- Transformation Notes -->
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Date Formatting Note -->
                            <div class="p-4 rounded-xl bg-cyan-50 border border-cyan-200">
                                <div class="flex items-start gap-3">
                                    <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-cyan-500 text-white flex-shrink-0">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h4 class="text-sm font-semibold text-cyan-900 mb-1">Date Formatting (T2)</h4>
                                        <p class="text-xs text-cyan-700">All date columns standardized to <span class="font-mono font-semibold bg-white px-1.5 py-0.5 rounded border border-cyan-300">DD/MM/YYYY</span></p>
                                    </div>
                                </div>
                            </div>
                            <!-- Status Normalization Note -->
                            <div class="p-4 rounded-xl bg-orange-50 border border-orange-200">
                                <div class="flex items-start gap-3">
                                    <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-orange-500 text-white flex-shrink-0">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h4 class="text-sm font-semibold text-orange-900 mb-1">Status Normalization (T3)</h4>
                                        <p class="text-xs text-orange-700"><span class="font-mono font-semibold">Past_Due_Category</span> values normalized: <span class="font-mono bg-white px-1.5 py-0.5 rounded border border-orange-300">"1 to 30 Days"</span>  <span class="font-mono bg-white px-1.5 py-0.5 rounded border border-orange-300">"0-30 Days"</span></p>
                                    </div>
                                </div>
                            </div>
                            <!-- Filter Note -->
                            <div class="p-4 rounded-xl bg-red-50 border border-red-200">
                                <div class="flex items-start gap-3">
                                    <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-red-500 text-white flex-shrink-0">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h4 class="text-sm font-semibold text-red-900 mb-1">Row Filtering (T4)</h4>
                                        <p class="text-xs text-red-700">Rows where <span class="font-mono font-semibold">Covenant Description</span> starts with <span class="font-mono bg-white px-1.5 py-0.5 rounded border border-red-300">"Internal Cov"</span> or <span class="font-mono font-semibold">Covenant Remarks</span> starts with <span class="font-mono bg-white px-1.5 py-0.5 rounded border border-red-300">"Internal"</span> are removed</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Covenants ETL Flow -->

        </div>
        <!-- End ETL Flow Tab -->

        <!-- Documentation Tab -->
        <div x-show="activeTab === 'docs'" x-data="{ selectedDoc: 'ccm', docDropdownOpen: false }">
            <!-- Documentation Header with Dropdown -->
            <div class="mb-6">
                <div class="rounded-2xl border border-gray-200 bg-white p-6">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div class="flex items-center gap-3">
                            <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-gradient-to-br from-gray-700 to-gray-900 text-white">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                </svg>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-gray-900">Process Documentation</h2>
                                <p class="text-sm text-gray-500">Technical documentation for ETL processes</p>
                            </div>
                        </div>
                        
                        <!-- Document Selector Dropdown -->
                        <div class="relative inline-block" x-data="{ open: false }">
                            <button @click="open = !open"
                                class="inline-flex items-center gap-3 rounded-xl border border-gray-200 bg-white px-5 py-3 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 transition-all min-w-[220px] justify-between">
                                <div class="flex items-center gap-2">
                                    <template x-if="selectedDoc === 'ccm'">
                                        <div class="flex items-center gap-2">
                                            <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-brand-500 text-white">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                </svg>
                                            </span>
                                            <span>CCM (Credit Reviews)</span>
                                        </div>
                                    </template>
                                    <template x-if="selectedDoc === 'portfolio'">
                                        <div class="flex items-center gap-2">
                                            <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-brand-500 text-white">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                            </span>
                                            <span>Portfolio Data</span>
                                        </div>
                                    </template>
                                    <template x-if="selectedDoc === 'covenants'">
                                        <div class="flex items-center gap-2">
                                            <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-brand-500 text-white">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                            </span>
                                            <span>Covenants</span>
                                        </div>
                                    </template>
                                </div>
                                <svg class="w-5 h-5 text-gray-400 transition-transform duration-200" :class="open && 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div x-show="open" @click.outside="open = false" x-transition:enter="transition ease-out duration-100" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
                                class="absolute right-0 top-full z-50 mt-2 w-full min-w-[260px] rounded-xl border border-gray-200 bg-white p-2 shadow-lg">
                                <ul class="flex flex-col gap-1">
                                    <li>
                                        <button @click="selectedDoc = 'ccm'; open = false"
                                            class="flex w-full items-center gap-3 rounded-lg px-3 py-2.5 text-sm font-medium transition-colors"
                                            :class="selectedDoc === 'ccm' ? 'bg-brand-50 text-brand-700' : 'text-gray-700 hover:bg-gray-100'">
                                            <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-brand-500 text-white">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                </svg>
                                            </span>
                                            CCM (Credit Reviews)
                                        </button>
                                    </li>
                                    <li>
                                        <button @click="selectedDoc = 'portfolio'; open = false"
                                            class="flex w-full items-center gap-3 rounded-lg px-3 py-2.5 text-sm font-medium transition-colors"
                                            :class="selectedDoc === 'portfolio' ? 'bg-brand-50 text-brand-700' : 'text-gray-700 hover:bg-gray-100'">
                                            <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-brand-500 text-white">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                            </span>
                                            Portfolio Data
                                        </button>
                                    </li>
                                    <li>
                                        <button @click="selectedDoc = 'covenants'; open = false"
                                            class="flex w-full items-center gap-3 rounded-lg px-3 py-2.5 text-sm font-medium transition-colors"
                                            :class="selectedDoc === 'covenants' ? 'bg-brand-50 text-brand-700' : 'text-gray-700 hover:bg-gray-100'">
                                            <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-brand-500 text-white">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                            </span>
                                            Covenants
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== CCM DOCUMENTATION ==================== -->
            <div x-show="selectedDoc === 'ccm'" class="space-y-6">
                <div class="rounded-2xl border border-gray-200 bg-white overflow-hidden">
                    <!-- Doc Header -->
                    <div class="px-5 py-4 sm:px-6 sm:py-5 border-b border-gray-100">
                        <div class="flex items-center gap-4">
                            <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-brand-500 text-white">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div>
                                <h1 class="text-xl font-semibold text-gray-800">CCM (Credit Committee Memos)</h1>
                                <p class="text-gray-500 text-sm mt-0.5">ETL Process Documentation</p>
                            </div>
                        </div>
                    </div>

                    <!-- Doc Content - MDX Style -->
                    <div class="border-t border-gray-100 p-5 sm:p-6">
                        <!-- Overview Section -->
                        <div class="mb-8">
                            <h2 class="text-base font-medium text-gray-800 flex items-center gap-2 mb-4">
                                <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-brand-50 text-brand-500 text-xs font-bold">01</span>
                                Overview
                            </h2>
                            <div class="bg-brand-25 rounded-xl p-5 border border-brand-100">
                                <p class="text-gray-600 text-sm leading-relaxed mb-0">
                                    The CCM ETL process consolidates Credit Committee Memo data from three regional files into a single 
                                    <code class="px-1.5 py-0.5 bg-white text-brand-600 rounded text-xs font-mono border border-brand-200">CCM_tw.xlsx</code> 
                                    file. This process extracts data from specific sheets based on region, transforms columns to a standardized format, 
                                    and calculates the CCM status based on the selected report date.
                                </p>
                            </div>
                        </div>

                        <!-- Data Sources Section -->
                        <div class="mb-8">
                            <h2 class="text-base font-medium text-gray-800 flex items-center gap-2 mb-4">
                                <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-brand-50 text-brand-500 text-xs font-bold">02</span>
                                Data Sources
                            </h2>
                            <div class="grid md:grid-cols-3 gap-4">
                                <div class="rounded-xl border border-gray-200 bg-white p-5 hover:border-brand-200 transition-colors">
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700">NAM</span>
                                        <span class="text-sm font-medium text-gray-800">Region</span>
                                    </div>
                                    <p class="text-sm text-gray-500 mb-3">North America CCM File</p>
                                    <div class="space-y-2">
                                        <div class="flex items-center gap-2 text-sm">
                                            <span class="w-1.5 h-1.5 rounded-full bg-brand-400"></span>
                                            <code class="text-xs bg-gray-50 px-2 py-1 rounded text-gray-700">Open CCM</code>
                                        </div>
                                    </div>
                                </div>
                                <div class="rounded-xl border border-gray-200 bg-white p-5 hover:border-brand-200 transition-colors">
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="px-2.5 py-1 rounded-full text-xs font-medium bg-brand-50 text-brand-600">APAC</span>
                                        <span class="text-sm font-medium text-gray-800">Region</span>
                                    </div>
                                    <p class="text-sm text-gray-500 mb-3">Asia Pacific CCM File</p>
                                    <div class="space-y-2">
                                        <div class="flex items-center gap-2 text-sm">
                                            <span class="w-1.5 h-1.5 rounded-full bg-brand-400"></span>
                                            <code class="text-xs bg-gray-50 px-2 py-1 rounded text-gray-700">Past Due</code>
                                        </div>
                                        <div class="flex items-center gap-2 text-sm">
                                            <span class="w-1.5 h-1.5 rounded-full bg-brand-400"></span>
                                            <code class="text-xs bg-gray-50 px-2 py-1 rounded text-gray-700">All Coming Due CCMs</code>
                                        </div>
                                    </div>
                                </div>
                                <div class="rounded-xl border border-gray-200 bg-white p-5 hover:border-brand-200 transition-colors">
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="px-2.5 py-1 rounded-full text-xs font-medium bg-brand-50 text-brand-600">EMEA</span>
                                        <span class="text-sm font-medium text-gray-800">Region</span>
                                    </div>
                                    <p class="text-sm text-gray-500 mb-3">Europe, Middle East & Africa</p>
                                    <div class="space-y-2">
                                        <div class="flex items-center gap-2 text-sm">
                                            <span class="w-1.5 h-1.5 rounded-full bg-brand-400"></span>
                                            <code class="text-xs bg-gray-50 px-2 py-1 rounded text-gray-700">Past Due</code>
                                        </div>
                                        <div class="flex items-center gap-2 text-sm">
                                            <span class="w-1.5 h-1.5 rounded-full bg-brand-400"></span>
                                            <code class="text-xs bg-gray-50 px-2 py-1 rounded text-gray-700">Coming Due</code>
                                        </div>
                                        <div class="flex items-center gap-2 text-sm">
                                            <span class="w-1.5 h-1.5 rounded-full bg-brand-400"></span>
                                            <code class="text-xs bg-gray-50 px-2 py-1 rounded text-gray-700">Open CCM</code>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Transformation Rules Section -->
                        <div class="mb-8">
                            <h2 class="text-base font-medium text-gray-800 flex items-center gap-2 mb-4">
                                <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-brand-50 text-brand-500 text-xs font-bold">03</span>
                                Transformation Rules
                            </h2>
                            <div class="space-y-3">
                                <!-- Rule 1 -->
                                <div class="rounded-xl border border-gray-200 bg-white p-4 hover:border-brand-200 transition-colors">
                                    <div class="flex items-start gap-3">
                                        <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-brand-50 text-brand-500 font-bold text-xs flex-shrink-0">T1</div>
                                        <div>
                                            <h4 class="font-medium text-gray-800 text-sm mb-1">Column Mapping</h4>
                                            <p class="text-sm text-gray-500 mb-2">Regional columns are mapped to standardized output columns. APAC's "Specialist" column maps to "Underwriter".</p>
                                            <div class="bg-gray-50 rounded-lg p-2.5 text-xs font-mono">
                                                <span class="text-gray-400">// APAC special mapping</span><br>
                                                <span class="text-brand-500">Specialist</span>  <span class="text-brand-600">Underwriter</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Rule 2 -->
                                <div class="rounded-xl border border-gray-200 bg-white p-4 hover:border-brand-200 transition-colors">
                                    <div class="flex items-start gap-3">
                                        <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-brand-50 text-brand-500 font-bold text-xs flex-shrink-0">T2</div>
                                        <div>
                                            <h4 class="font-medium text-gray-800 text-sm mb-1">Date Formatting</h4>
                                            <p class="text-sm text-gray-500 mb-2">All date columns are converted to <code class="px-1.5 py-0.5 bg-brand-50 text-brand-600 rounded text-xs">DD/MM/YYYY</code> format. Handles multiple input formats:</p>
                                            <div class="flex flex-wrap gap-2">
                                                <span class="px-2 py-1 bg-gray-50 text-gray-600 rounded text-xs font-mono">DD-MMM-YYYY</span>
                                                <span class="px-2 py-1 bg-gray-50 text-gray-600 rounded text-xs font-mono">MM-DD-YYYY</span>
                                                <span class="px-2 py-1 bg-gray-50 text-gray-600 rounded text-xs font-mono">MMM-DD-YYYY</span>
                                                <span class="px-2 py-1 bg-gray-50 text-gray-600 rounded text-xs font-mono">YYYY-MM-DD</span>
                                                <span class="px-2 py-1 bg-gray-50 text-gray-600 rounded text-xs font-mono">Excel Serial</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Rule 3 -->
                                <div class="rounded-xl border border-gray-200 bg-white p-4 hover:border-brand-200 transition-colors">
                                    <div class="flex items-start gap-3">
                                        <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-brand-50 text-brand-500 font-bold text-xs flex-shrink-0">T3</div>
                                        <div>
                                            <h4 class="font-medium text-gray-800 text-sm mb-1">CCM Status Calculation</h4>
                                            <p class="text-sm text-gray-500 mb-2">Status is determined by comparing <code class="px-1.5 py-0.5 bg-brand-50 text-brand-600 rounded text-xs">Next_CCM_Approval_Date</code> with the selected Report Date:</p>
                                            <div class="space-y-1.5">
                                                <div class="flex items-center gap-3">
                                                    <span class="px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">Past Due</span>
                                                    <span class="text-sm text-gray-500">Date is before Report Date month</span>
                                                </div>
                                                <div class="flex items-center gap-3">
                                                    <span class="px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-700">Coming Due</span>
                                                    <span class="text-sm text-gray-500">Date is within Report Date month</span>
                                                </div>
                                                <div class="flex items-center gap-3">
                                                    <span class="px-2 py-0.5 rounded-full text-xs font-medium bg-brand-50 text-brand-600">Open</span>
                                                    <span class="text-sm text-gray-500">Date is after Report Date month</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Rule 4 -->
                                <div class="rounded-xl border border-gray-200 bg-white p-4 hover:border-brand-200 transition-colors">
                                    <div class="flex items-start gap-3">
                                        <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-brand-50 text-brand-500 font-bold text-xs flex-shrink-0">T4</div>
                                        <div>
                                            <h4 class="font-medium text-gray-800 text-sm mb-1">Region Auto-Fill (EMEA)</h4>
                                            <p class="text-sm text-gray-500">EMEA files do not contain a Region column. The system automatically fills "EMEA" for all rows from EMEA files.</p>
                                        </div>
                                    </div>
                                </div>
                                <!-- Rule 5 -->
                                <div class="rounded-xl border border-gray-200 bg-white p-4 hover:border-brand-200 transition-colors">
                                    <div class="flex items-start gap-3">
                                        <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-brand-50 text-brand-500 font-bold text-xs flex-shrink-0">T5</div>
                                        <div>
                                            <h4 class="font-medium text-gray-800 text-sm mb-1">Data Filtering</h4>
                                            <p class="text-sm text-gray-500 mb-2">Rows are filtered out if they contain placeholder values indicating no data:</p>
                                            <div class="flex flex-wrap gap-2">
                                                <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-medium">Nothing to Report</span>
                                                <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-medium">NIL</span>
                                                <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-medium">N/A</span>
                                                <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-medium">NA</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Output Schema Section -->
                        <div class="mb-8">
                            <h2 class="text-base font-medium text-gray-800 flex items-center gap-2 mb-4">
                                <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-brand-50 text-brand-500 text-xs font-bold">04</span>
                                Output Schema
                            </h2>
                            <div class="overflow-hidden rounded-xl border border-gray-200 bg-white">
                                <div class="max-w-full overflow-x-auto">
                                    <table class="w-full">
                                        <thead>
                                            <tr class="border-b border-gray-100">
                                                <th class="px-5 py-3 text-left sm:px-6">
                                                    <p class="font-medium text-gray-500 text-xs">#</p>
                                                </th>
                                                <th class="px-5 py-3 text-left sm:px-6">
                                                    <p class="font-medium text-gray-500 text-xs">Column Name</p>
                                                </th>
                                                <th class="px-5 py-3 text-left sm:px-6">
                                                    <p class="font-medium text-gray-500 text-xs">Type</p>
                                                </th>
                                                <th class="px-5 py-3 text-left sm:px-6">
                                                    <p class="font-medium text-gray-500 text-xs">Description</p>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-4 sm:px-6 text-gray-500 text-sm">1</td><td class="px-5 py-4 sm:px-6 font-mono text-sm text-gray-800">Region</td><td class="px-5 py-4 sm:px-6"><span class="bg-brand-50 text-brand-600 text-xs rounded-full px-2 py-0.5 font-medium">String</span></td><td class="px-5 py-4 sm:px-6 text-gray-500 text-sm">NAM, APAC, or EMEA</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-4 sm:px-6 text-gray-500 text-sm">2</td><td class="px-5 py-4 sm:px-6 font-mono text-sm text-gray-800">Report_Date</td><td class="px-5 py-4 sm:px-6"><span class="bg-blue-50 text-blue-600 text-xs rounded-full px-2 py-0.5 font-medium">Date</span></td><td class="px-5 py-4 sm:px-6 text-gray-500 text-sm">Selected report date (DD/MM/YYYY)</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-4 sm:px-6 text-gray-500 text-sm">3</td><td class="px-5 py-4 sm:px-6 font-mono text-sm text-gray-800">Client_Name</td><td class="px-5 py-4 sm:px-6"><span class="bg-brand-50 text-brand-600 text-xs rounded-full px-2 py-0.5 font-medium">String</span></td><td class="px-5 py-4 sm:px-6 text-gray-500 text-sm">Client/counterparty name</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-4 sm:px-6 text-gray-500 text-sm">4</td><td class="px-5 py-4 sm:px-6 font-mono text-sm text-gray-800">CCM_Type</td><td class="px-5 py-4 sm:px-6"><span class="bg-brand-50 text-brand-600 text-xs rounded-full px-2 py-0.5 font-medium">String</span></td><td class="px-5 py-4 sm:px-6 text-gray-500 text-sm">Type of CCM document</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-4 sm:px-6 text-gray-500 text-sm">5</td><td class="px-5 py-4 sm:px-6 font-mono text-sm text-gray-800">CCM_Status</td><td class="px-5 py-4 sm:px-6"><span class="bg-brand-50 text-brand-600 text-xs rounded-full px-2 py-0.5 font-medium">Calculated</span></td><td class="px-5 py-4 sm:px-6 text-gray-500 text-sm">Past Due/Coming Due/Open</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-4 sm:px-6 text-gray-500 text-sm">6</td><td class="px-5 py-4 sm:px-6 font-mono text-sm text-gray-800">Next_CCM_Approval_Date</td><td class="px-5 py-4 sm:px-6"><span class="bg-blue-50 text-blue-600 text-xs rounded-full px-2 py-0.5 font-medium">Date</span></td><td class="px-5 py-4 sm:px-6 text-gray-500 text-sm">Next approval date (DD/MM/YYYY)</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-4 sm:px-6 text-gray-500 text-sm">7</td><td class="px-5 py-4 sm:px-6 font-mono text-sm text-gray-800">Underwriter</td><td class="px-5 py-4 sm:px-6"><span class="bg-brand-50 text-brand-600 text-xs rounded-full px-2 py-0.5 font-medium">String</span></td><td class="px-5 py-4 sm:px-6 text-gray-500 text-sm">Assigned underwriter</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-4 sm:px-6 text-gray-500 text-sm">8</td><td class="px-5 py-4 sm:px-6 font-mono text-sm text-gray-800">Risk_Category</td><td class="px-5 py-4 sm:px-6"><span class="bg-brand-50 text-brand-600 text-xs rounded-full px-2 py-0.5 font-medium">String</span></td><td class="px-5 py-4 sm:px-6 text-gray-500 text-sm">Risk classification</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-4 sm:px-6 text-gray-500 text-sm">9</td><td class="px-5 py-4 sm:px-6 font-mono text-sm text-gray-800">Last_CCM_Approval_Date</td><td class="px-5 py-4 sm:px-6"><span class="bg-blue-50 text-blue-600 text-xs rounded-full px-2 py-0.5 font-medium">Date</span></td><td class="px-5 py-4 sm:px-6 text-gray-500 text-sm">Previous approval date</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-4 sm:px-6 text-gray-500 text-sm">10</td><td class="px-5 py-4 sm:px-6 font-mono text-sm text-gray-800">Comments</td><td class="px-5 py-4 sm:px-6"><span class="bg-brand-50 text-brand-600 text-xs rounded-full px-2 py-0.5 font-medium">String</span></td><td class="px-5 py-4 sm:px-6 text-gray-500 text-sm">Additional notes</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Output Info -->
                        <div class="rounded-xl bg-brand-50 border border-brand-100 p-5">
                            <div class="flex items-start gap-3">
                                <svg class="w-5 h-5 text-brand-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div>
                                    <h4 class="font-semibold text-brand-800 mb-1">Output File</h4>
                                    <p class="text-sm text-brand-700">The consolidated data is saved as <code class="px-1.5 py-0.5 bg-white text-brand-600 rounded text-xs font-mono border border-brand-200">CCM_tw.xlsx</code> and automatically uploaded to Portfolio Analytics of LPTM.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== PORTFOLIO DOCUMENTATION ==================== -->
            <div x-show="selectedDoc === 'portfolio'" class="space-y-6">
                <div class="rounded-2xl border border-gray-200 bg-white overflow-hidden">
                    <!-- Doc Header -->
                    <div class="px-5 py-4 sm:px-6 sm:py-5 border-b border-gray-100">
                        <div class="flex items-center gap-4">
                            <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-brand-500 text-white">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <h1 class="text-xl font-semibold text-gray-800">Portfolio Data</h1>
                                <p class="text-gray-500 text-sm mt-0.5">ETL Process Documentation</p>
                            </div>
                        </div>
                    </div>

                    <!-- Doc Content - MDX Style -->
                    <div class="border-t border-gray-100 p-5 sm:p-6">
                        <!-- Overview Section -->
                        <div class="mb-8">
                            <h2 class="text-base font-medium text-gray-800 flex items-center gap-2 mb-4">
                                <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-brand-50 text-brand-500 text-xs font-bold">01</span>
                                Overview
                            </h2>
                            <div class="bg-brand-25 rounded-xl p-5 border border-brand-100">
                                <p class="text-gray-600 text-sm leading-relaxed mb-0">
                                    The Portfolio ETL process consolidates facility and exposure data from three regional Credit Platform exports into a single 
                                    <code class="px-1.5 py-0.5 bg-white text-brand-600 rounded text-xs font-mono border border-brand-200">Portfolio_tw.xlsx</code> 
                                    file. This process includes complex transformations such as PSE classification, product categorization, 
                                    commitment status derivation, and exposure calculations.
                                </p>
                            </div>
                        </div>

                        <!-- Data Sources Section -->
                        <div class="mb-8">
                            <h2 class="text-base font-medium text-gray-800 flex items-center gap-2 mb-4">
                                <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-brand-50 text-brand-500 text-xs font-bold">02</span>
                                Data Sources
                            </h2>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div class="md:col-span-2">
                                    <div class="rounded-xl border border-gray-200 bg-white p-5 hover:border-brand-200 transition-colors">
                                        <div class="flex items-center gap-2 mb-3">
                                            <span class="px-2.5 py-1 rounded-full text-xs font-medium bg-brand-50 text-brand-600">MAPPING</span>
                                            <span class="text-sm font-medium text-gray-800">Product_Mapping.xlsx</span>
                                        </div>
                                        <p class="text-sm text-gray-500 mb-3">Master classification file with two tabs:</p>
                                        <div class="grid md:grid-cols-2 gap-3">
                                            <div class="bg-gray-50 rounded-lg p-3">
                                                <div class="font-medium text-sm text-gray-800 mb-1">PSE Tab</div>
                                                <p class="text-xs text-gray-500">Facility_Type, Product_Program  PSE/non-PSE classification</p>
                                            </div>
                                            <div class="bg-gray-50 rounded-lg p-3">
                                                <div class="font-medium text-sm text-gray-800 mb-1">Category Tab</div>
                                                <p class="text-xs text-gray-500">Primary_Key  Product_Program, Product_Sub_Program</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="rounded-xl border border-gray-200 bg-white p-5 hover:border-brand-200 transition-colors">
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="px-2.5 py-1 rounded-full text-xs font-medium bg-brand-50 text-brand-600">EMEA</span>
                                        <span class="text-sm font-medium text-gray-800">RAR7 Combined</span>
                                    </div>
                                    <p class="text-sm text-gray-500 mb-2">Regional Credit Platform Export</p>
                                    <ul class="text-xs text-gray-500 space-y-1">
                                        <li> Filter: <code class="bg-gray-50 px-1 rounded text-gray-700">Fac ID</code> is not null</li>
                                        <li> Lookup Key: <code class="bg-gray-50 px-1 rounded text-gray-700">Facility Type</code></li>
                                    </ul>
                                </div>
                                <div class="rounded-xl border border-gray-200 bg-white p-5 hover:border-brand-200 transition-colors">
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="px-2.5 py-1 rounded-full text-xs font-medium bg-brand-50 text-brand-600">APAC</span>
                                        <span class="text-sm font-medium text-gray-800">eOASIS Export</span>
                                    </div>
                                    <p class="text-sm text-gray-500 mb-2">Regional Credit Platform Export</p>
                                    <ul class="text-xs text-gray-500 space-y-1">
                                        <li> No filter (all rows imported)</li>
                                        <li> Lookup Key: <code class="bg-gray-50 px-1 rounded text-gray-700">Product Program Name</code></li>
                                    </ul>
                                </div>
                                <div class="md:col-span-2 rounded-xl border border-gray-200 bg-white p-5 hover:border-brand-200 transition-colors">
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700">NAM</span>
                                        <span class="text-sm font-medium text-gray-800">BO Export</span>
                                    </div>
                                    <p class="text-sm text-gray-500 mb-2">Regional Credit Platform Export</p>
                                    <div class="bg-brand-25 rounded-lg p-3 border border-brand-100 mb-3">
                                        <div class="flex items-center gap-2 text-sm text-brand-700">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                            </svg>
                                            <span class="font-medium">Special File Structure:</span>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-2">Data starts from row 4 (B4), column A is always empty. Rows 1-3 contain report metadata and are skipped.</p>
                                    </div>
                                    <ul class="text-xs text-gray-500 space-y-1.5">
                                        <li> Filter 1: <code class="bg-gray-50 px-1 rounded text-gray-700">Risk Category</code>  Clearing, Notation, Settlement</li>
                                        <li> Region Mapping: <code class="bg-gray-50 px-1 rounded text-gray-700">Control Unit</code>  <code class="bg-brand-50 px-1 rounded text-brand-600">Regions_Mapping.xlsx</code>  Region (IPB  NAM)</li>
                                        <li> Filter 2: Keep only <span class="font-semibold text-gray-700">NAM</span> and <span class="font-semibold text-gray-700">LATAM</span>, filter out SARG and non-matches</li>
                                        <li> Lookup Key: <code class="bg-gray-50 px-1 rounded text-gray-700">Product Program</code></li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Transformation Rules Section -->
                        <div class="mb-10">
                            <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2 mb-4">
                                <span class="flex h-8 w-8 items-center justify-center rounded-lg bg-gray-100 text-gray-600 text-sm font-bold">03</span>
                                Transformation Rules
                            </h2>
                            <div class="space-y-4">
                                <!-- Rule: Committed/Uncommitted -->
                                <div class="rounded-xl border border-gray-200 bg-white p-5">
                                    <div class="flex items-start gap-4">
                                        <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-brand-100 text-brand-600 font-bold text-sm flex-shrink-0">T1</div>
                                        <div class="w-full">
                                            <h4 class="font-semibold text-gray-900 mb-2">Committed/Uncommitted Derivation</h4>
                                            <div class="grid md:grid-cols-3 gap-3 text-sm">
                                                <div class="bg-blue-50 rounded-lg p-3 border border-blue-100">
                                                    <div class="font-semibold text-blue-800 mb-1">EMEA</div>
                                                    <p class="text-xs text-gray-600"><code class="bg-white px-1 rounded">Committed Facility</code> = "YES"  Committed<br>= "NO"  Uncommitted</p>
                                                </div>
                                                <div class="bg-blue-50 rounded-lg p-3 border border-gray-200">
                                                    <div class="font-semibold text-blue-800 mb-1">APAC</div>
                                                    <p class="text-xs text-gray-600"><code class="bg-white px-1 rounded">Legal Status</code> = "C"  Committed<br>= "U"  Uncommitted</p>
                                                </div>
                                                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                                                    <div class="font-semibold text-gray-700 mb-1">NAM</div>
                                                    <p class="text-xs text-gray-600">Direct mapping from <code class="bg-white px-1 rounded">Committed / Uncommitted Flag</code></p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Rule: Underwriting Team Lead -->
                                <div class="rounded-xl border border-gray-200 bg-white p-5">
                                    <div class="flex items-start gap-4">
                                        <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-brand-100 text-brand-600 font-bold text-sm flex-shrink-0">T2</div>
                                        <div>
                                            <h4 class="font-semibold text-gray-900 mb-2">Underwriting Team Lead (EMEA Only)</h4>
                                            <p class="text-sm text-gray-600 mb-3">Based on <code class="px-1.5 py-0.5 bg-gray-100 rounded text-xs">Investment Finance Lead Underwriter</code>:</p>
                                            <div class="grid md:grid-cols-2 gap-3">
                                                <div class="bg-blue-50 rounded-lg p-3 border border-gray-200">
                                                    <div class="font-semibold text-blue-800 text-sm mb-1">Kristopher Palmer</div>
                                                    <p class="text-xs text-gray-600">If value is: SIMPSON HARRY, PALMER KRISTOPHER, KADELI IRIDA, GRAEME-WILSON DOM</p>
                                                </div>
                                                <div class="bg-blue-50 rounded-lg p-3 border border-blue-100">
                                                    <div class="font-semibold text-blue-800 text-sm mb-1">Ponniah Raj</div>
                                                    <p class="text-xs text-gray-600">All other values</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Rule: PSE Classification -->
                                <div class="rounded-xl border border-gray-200 bg-white p-5">
                                    <div class="flex items-start gap-4">
                                        <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-brand-100 text-brand-600 font-bold text-sm flex-shrink-0">T3</div>
                                        <div>
                                            <h4 class="font-semibold text-gray-900 mb-2">PSE/non-PSE Classification</h4>
                                            <p class="text-sm text-gray-600 mb-3">Lookup against <code class="px-1.5 py-0.5 bg-brand-100 rounded text-xs">Product_Mapping.xlsx</code>  PSE tab:</p>
                                            <div class="bg-gray-50 rounded-lg p-3 text-xs font-mono space-y-1">
                                                <div><span class="text-blue-600">EMEA/APAC:</span> <span class="text-gray-600">Facility_Type</span>  lookup Facility_Type column</div>
                                                <div><span class="text-gray-700">NAM:</span> <span class="text-gray-600">Product_Program OR Facility_Type</span>  lookup both columns</div>
                                                <div class="text-gray-500 mt-2">// Result: "PSE" if found, "non-PSE" otherwise</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Rule: Category Mapping -->
                                <div class="rounded-xl border border-gray-200 bg-white p-5">
                                    <div class="flex items-start gap-4">
                                        <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-brand-100 text-brand-600 font-bold text-sm flex-shrink-0">T4</div>
                                        <div>
                                            <h4 class="font-semibold text-gray-900 mb-2">Product Category Mapping</h4>
                                            <p class="text-sm text-gray-600 mb-3">Lookup against <code class="px-1.5 py-0.5 bg-brand-100 rounded text-xs">Product_Mapping.xlsx</code>  Category tab:</p>
                                            <div class="overflow-x-auto">
                                                <table class="text-xs w-full">
                                                    <thead>
                                                        <tr class="bg-gray-100">
                                                            <th class="px-3 py-2 text-left">Region</th>
                                                            <th class="px-3 py-2 text-left">Primary Key</th>
                                                            <th class="px-3 py-2 text-left">Output: Product_Program</th>
                                                            <th class="px-3 py-2 text-left">Output: Product_Sub_Program</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr class="border-t"><td class="px-3 py-2 font-semibold text-blue-600">EMEA</td><td class="px-3 py-2 font-mono">Facility Type</td><td class="px-3 py-2">Category</td><td class="px-3 py-2">Sub_Category</td></tr>
                                                        <tr class="border-t bg-gray-50"><td class="px-3 py-2 font-semibold text-brand-600">APAC</td><td class="px-3 py-2 font-mono">Product Program Name</td><td class="px-3 py-2">Category</td><td class="px-3 py-2">Sub_Category</td></tr>
                                                        <tr class="border-t"><td class="px-3 py-2 font-semibold text-gray-700">NAM</td><td class="px-3 py-2 font-mono">Product Program</td><td class="px-3 py-2">Category</td><td class="px-3 py-2">Sub_Category</td></tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Rule: Credit Classification Normalization -->
                                <div class="rounded-xl border border-purple-200 bg-purple-50/30 p-5">
                                    <div class="flex items-start gap-4">
                                        <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-purple-100 text-purple-600 font-bold text-sm flex-shrink-0">T5</div>
                                        <div class="w-full">
                                            <h4 class="font-semibold text-gray-900 mb-2">Credit Classification Normalization</h4>
                                            <p class="text-sm text-gray-600 mb-3">Standardize credit classification values across all regions to consistent naming:</p>
                                            <div class="overflow-x-auto">
                                                <table class="text-xs w-full">
                                                    <thead>
                                                        <tr class="bg-purple-100">
                                                            <th class="px-3 py-2 text-left">Input Values</th>
                                                            <th class="px-3 py-2 text-left">Normalized Output</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr class="border-t"><td class="px-3 py-2 font-mono text-gray-600">P, Pass, Pass (P)</td><td class="px-3 py-2 font-semibold text-green-600">Pass</td></tr>
                                                        <tr class="border-t bg-white"><td class="px-3 py-2 font-mono text-gray-600">PWL, Pass Watch List, Pass Watch List (PWL)</td><td class="px-3 py-2 font-semibold text-yellow-600">Pass Watch List</td></tr>
                                                        <tr class="border-t"><td class="px-3 py-2 font-mono text-gray-600">SM, Special Mention, Special Mention (SM)</td><td class="px-3 py-2 font-semibold text-orange-600">Special Mention</td></tr>
                                                        <tr class="border-t bg-white"><td class="px-3 py-2 font-mono text-gray-600">SS, Substandard, Substandard (SS)</td><td class="px-3 py-2 font-semibold text-red-500">Substandard</td></tr>
                                                        <tr class="border-t"><td class="px-3 py-2 font-mono text-gray-600">Substandard Non Performing</td><td class="px-3 py-2 font-semibold text-red-600">Substandard Non Performing</td></tr>
                                                        <tr class="border-t bg-white"><td class="px-3 py-2 font-mono text-gray-600">Substandard Performing</td><td class="px-3 py-2 font-semibold text-red-400">Substandard Performing</td></tr>
                                                        <tr class="border-t"><td class="px-3 py-2 font-mono text-gray-600">D, Doubtful, Doubtful (D)</td><td class="px-3 py-2 font-semibold text-red-700">Doubtful</td></tr>
                                                        <tr class="border-t bg-white"><td class="px-3 py-2 font-mono text-gray-600">L, Loss</td><td class="px-3 py-2 font-semibold text-red-800">Loss</td></tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <p class="text-xs text-gray-500 mt-2 italic">Case-insensitive matching. Unknown values are preserved as-is.</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Rule: Underwriter Name Normalization -->
                                <div class="rounded-xl border border-cyan-200 bg-cyan-50/30 p-5">
                                    <div class="flex items-start gap-4">
                                        <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-cyan-100 text-cyan-600 font-bold text-sm flex-shrink-0">T6</div>
                                        <div class="w-full">
                                            <h4 class="font-semibold text-gray-900 mb-2">Underwriter Name Normalization</h4>
                                            <p class="text-sm text-gray-600 mb-3">Standardize underwriter names from uppercase "LASTNAME, FIRSTNAME" format to proper case "FirstName LastName":</p>
                                            <div class="overflow-x-auto">
                                                <table class="text-xs w-full">
                                                    <thead>
                                                        <tr class="bg-cyan-100">
                                                            <th class="px-3 py-2 text-left">Input Format</th>
                                                            <th class="px-3 py-2 text-left">Output Format</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr class="border-t"><td class="px-3 py-2 font-mono text-gray-600">SIMPSON, HARRY</td><td class="px-3 py-2 font-semibold text-cyan-700">Harry Simpson</td></tr>
                                                        <tr class="border-t bg-white"><td class="px-3 py-2 font-mono text-gray-600">PALMER, KRISTOPHER</td><td class="px-3 py-2 font-semibold text-cyan-700">Kristopher Palmer</td></tr>
                                                        <tr class="border-t"><td class="px-3 py-2 font-mono text-gray-600">GRAEME-WILSON, DOM</td><td class="px-3 py-2 font-semibold text-cyan-700">Dom Graeme Wilson</td></tr>
                                                        <tr class="border-t bg-white"><td class="px-3 py-2 font-mono text-gray-600">JOHN SMITH</td><td class="px-3 py-2 font-semibold text-cyan-700">John Smith</td></tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <p class="text-xs text-gray-500 mt-2 italic">Applied to: Lead_Underwriter, Underwriting_Team_Lead, Product_Underwriter columns.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Calculations Section -->
                        <div class="mb-8">
                            <h2 class="text-base font-medium text-gray-800 flex items-center gap-2 mb-4">
                                <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-brand-50 text-brand-500 text-xs font-bold">04</span>
                                Post-Merge Calculations
                            </h2>
                            <div class="overflow-hidden rounded-xl border border-gray-200 bg-white">
                                <div class="max-w-full overflow-x-auto">
                                    <table class="w-full">
                                        <thead>
                                            <tr class="border-b border-gray-100">
                                                <th class="px-5 py-3 text-left sm:px-6"><p class="font-medium text-gray-500 text-xs">Column</p></th>
                                                <th class="px-5 py-3 text-left sm:px-6"><p class="font-medium text-gray-500 text-xs">Formula</p></th>
                                                <th class="px-5 py-3 text-center sm:px-6"><p class="font-medium text-gray-500 text-xs">EMEA</p></th>
                                                <th class="px-5 py-3 text-center sm:px-6"><p class="font-medium text-gray-500 text-xs">APAC</p></th>
                                                <th class="px-5 py-3 text-center sm:px-6"><p class="font-medium text-gray-500 text-xs">NAM</p></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr class="border-b border-gray-100">
                                                <td class="px-5 py-3 sm:px-6 font-mono text-sm text-gray-800">OSUC</td>
                                                <td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">If Committed: Fac_Amount, else: Direct_OS + Contingent_OS + PSE_OS</td>
                                                <td class="px-5 py-3 sm:px-6 text-center"><span class="px-2 py-0.5 rounded-full text-xs bg-brand-50 text-brand-600 font-medium">Calculated</span></td>
                                                <td class="px-5 py-3 sm:px-6 text-center"><span class="px-2 py-0.5 rounded-full text-xs bg-brand-50 text-brand-600 font-medium">Calculated</span></td>
                                                <td class="px-5 py-3 sm:px-6 text-center"><span class="px-2 py-0.5 rounded-full text-xs bg-gray-100 text-gray-600 font-medium">Source</span></td>
                                            </tr>
                                            <tr class="border-b border-gray-100">
                                                <td class="px-5 py-3 sm:px-6 font-mono text-sm text-gray-800">Total_OS</td>
                                                <td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">Direct_OS + Contingent_OS + PSE_OS</td>
                                                <td class="px-5 py-3 sm:px-6 text-center"><span class="px-2 py-0.5 rounded-full text-xs bg-brand-50 text-brand-600 font-medium">Calculated</span></td>
                                                <td class="px-5 py-3 sm:px-6 text-center"><span class="px-2 py-0.5 rounded-full text-xs bg-brand-50 text-brand-600 font-medium">Calculated</span></td>
                                                <td class="px-5 py-3 sm:px-6 text-center"><span class="px-2 py-0.5 rounded-full text-xs bg-brand-50 text-brand-600 font-medium">Calculated</span></td>
                                            </tr>
                                            <tr class="border-b border-gray-100">
                                                <td class="px-5 py-3 sm:px-6 font-mono text-sm text-gray-800">Total_Unused_Exposure</td>
                                                <td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">If Committed: Fac_Amount - Total_OS, else: 0</td>
                                                <td class="px-5 py-3 sm:px-6 text-center"><span class="px-2 py-0.5 rounded-full text-xs bg-brand-50 text-brand-600 font-medium">Calculated</span></td>
                                                <td class="px-5 py-3 sm:px-6 text-center"><span class="px-2 py-0.5 rounded-full text-xs bg-brand-50 text-brand-600 font-medium">Calculated</span></td>
                                                <td class="px-5 py-3 sm:px-6 text-center"><span class="px-2 py-0.5 rounded-full text-xs bg-gray-100 text-gray-600 font-medium">Source</span></td>
                                            </tr>
                                            <tr class="border-b border-gray-100">
                                                <td class="px-5 py-3 sm:px-6 font-mono text-sm text-gray-800">Total_Undrawn</td>
                                                <td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">Fac_Amount - (Direct_OS + Contingent_OS + PSE_OS)</td>
                                                <td class="px-5 py-3 sm:px-6 text-center"><span class="px-2 py-0.5 rounded-full text-xs bg-brand-50 text-brand-600 font-medium">Calculated</span></td>
                                                <td class="px-5 py-3 sm:px-6 text-center"><span class="px-2 py-0.5 rounded-full text-xs bg-brand-50 text-brand-600 font-medium">Calculated</span></td>
                                                <td class="px-5 py-3 sm:px-6 text-center"><span class="px-2 py-0.5 rounded-full text-xs bg-brand-50 text-brand-600 font-medium">Calculated</span></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Column Mapping Table Section -->
                        <div class="mb-8">
                            <h2 class="text-base font-medium text-gray-800 flex items-center gap-2 mb-4">
                                <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-brand-50 text-brand-500 text-xs font-bold">05</span>
                                Column Mapping (Portfolio_tw.xlsx - 33 Columns)
                            </h2>
                            <div class="overflow-hidden rounded-xl border border-gray-200 bg-white">
                                <div class="max-h-96 overflow-y-auto">
                                    <table class="w-full">
                                        <thead class="sticky top-0 bg-white">
                                            <tr class="border-b border-gray-100">
                                                <th class="px-4 py-3 text-left"><p class="font-medium text-gray-500 text-xs">#</p></th>
                                                <th class="px-4 py-3 text-left"><p class="font-medium text-gray-500 text-xs">Output Column</p></th>
                                                <th class="px-4 py-3 text-left"><p class="font-medium text-gray-500 text-xs">EMEA Source</p></th>
                                                <th class="px-4 py-3 text-left"><p class="font-medium text-gray-500 text-xs">APAC Source</p></th>
                                                <th class="px-4 py-3 text-left"><p class="font-medium text-gray-500 text-xs">NAM Source</p></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">1</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Region</td><td class="px-4 py-2.5 text-xs text-gray-500">"EMEA" (auto)</td><td class="px-4 py-2.5 text-xs text-gray-500">Region</td><td class="px-4 py-2.5 text-xs text-gray-500">Region</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">2</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Group_ID</td><td class="px-4 py-2.5 text-xs text-gray-500">Group ID</td><td class="px-4 py-2.5 text-xs text-gray-500">Group ID</td><td class="px-4 py-2.5 text-xs text-gray-500">Group ID</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">3</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Group_Name</td><td class="px-4 py-2.5 text-xs text-gray-500">Group Name</td><td class="px-4 py-2.5 text-xs text-gray-500">Group Name</td><td class="px-4 py-2.5 text-xs text-gray-500">Group Name</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">4</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Client_ID</td><td class="px-4 py-2.5 text-xs text-gray-500">Client ID</td><td class="px-4 py-2.5 text-xs text-gray-500">Client ID</td><td class="px-4 py-2.5 text-xs text-gray-500">Client ID</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">5</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Client_Name</td><td class="px-4 py-2.5 text-xs text-gray-500">Client Name</td><td class="px-4 py-2.5 text-xs text-gray-500">Client Name</td><td class="px-4 py-2.5 text-xs text-gray-500">Client Name</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">6</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Fac_ID</td><td class="px-4 py-2.5 text-xs text-gray-500">Fac ID</td><td class="px-4 py-2.5 text-xs text-gray-500">Facility ID</td><td class="px-4 py-2.5 text-xs text-gray-500">Facility ID</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">7</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Facility_Type</td><td class="px-4 py-2.5 text-xs text-gray-500">Facility Type</td><td class="px-4 py-2.5 text-xs text-gray-500">Facility Type</td><td class="px-4 py-2.5 text-xs text-gray-500">Facility Type</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">8</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Product_Program</td><td class="px-4 py-2.5 text-xs"><span class="bg-brand-50 text-brand-600 px-1.5 py-0.5 rounded text-xs">Lookup</span></td><td class="px-4 py-2.5 text-xs"><span class="bg-brand-50 text-brand-600 px-1.5 py-0.5 rounded text-xs">Lookup</span></td><td class="px-4 py-2.5 text-xs"><span class="bg-brand-50 text-brand-600 px-1.5 py-0.5 rounded text-xs">Lookup</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">9</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Product_Sub_Program</td><td class="px-4 py-2.5 text-xs"><span class="bg-brand-50 text-brand-600 px-1.5 py-0.5 rounded text-xs">Lookup</span></td><td class="px-4 py-2.5 text-xs"><span class="bg-brand-50 text-brand-600 px-1.5 py-0.5 rounded text-xs">Lookup</span></td><td class="px-4 py-2.5 text-xs"><span class="bg-brand-50 text-brand-600 px-1.5 py-0.5 rounded text-xs">Lookup</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">10</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Risk_Category</td><td class="px-4 py-2.5 text-xs text-gray-500">Risk Category</td><td class="px-4 py-2.5 text-xs text-gray-500">Risk Category</td><td class="px-4 py-2.5 text-xs text-gray-500">Risk Category</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">11</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Committed_Uncommitted</td><td class="px-4 py-2.5 text-xs"><span class="bg-gray-100 text-gray-700 px-1.5 py-0.5 rounded text-xs">Derived</span></td><td class="px-4 py-2.5 text-xs"><span class="bg-gray-100 text-gray-700 px-1.5 py-0.5 rounded text-xs">Derived</span></td><td class="px-4 py-2.5 text-xs text-gray-500">Committed / Uncommitted Flag</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">12</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Fac_Amount</td><td class="px-4 py-2.5 text-xs text-gray-500">Fac Amount</td><td class="px-4 py-2.5 text-xs text-gray-500">Fac Amount</td><td class="px-4 py-2.5 text-xs text-gray-500">Total Reported Facility Amount</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">13</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Direct_OS</td><td class="px-4 py-2.5 text-xs text-gray-500">Direct OS</td><td class="px-4 py-2.5 text-xs text-gray-500">Direct OS</td><td class="px-4 py-2.5 text-xs text-gray-500">Direct O/S</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">14</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Contingent_OS</td><td class="px-4 py-2.5 text-xs text-gray-500">Contingent OS</td><td class="px-4 py-2.5 text-xs text-gray-500">Contingent OS</td><td class="px-4 py-2.5 text-xs text-gray-500">Contingent O/S</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">15</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">PSE_OS</td><td class="px-4 py-2.5 text-xs text-gray-500">PSE OS</td><td class="px-4 py-2.5 text-xs text-gray-500">PSE OS</td><td class="px-4 py-2.5 text-xs text-gray-500">PSE O/S</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">16</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">OSUC</td><td class="px-4 py-2.5 text-xs"><span class="bg-brand-50 text-brand-600 px-1.5 py-0.5 rounded text-xs">Calculated</span></td><td class="px-4 py-2.5 text-xs text-gray-500">OSUC</td><td class="px-4 py-2.5 text-xs text-gray-500">OSUC</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">17</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Total_OS</td><td class="px-4 py-2.5 text-xs"><span class="bg-brand-50 text-brand-600 px-1.5 py-0.5 rounded text-xs">Calculated</span></td><td class="px-4 py-2.5 text-xs"><span class="bg-brand-50 text-brand-600 px-1.5 py-0.5 rounded text-xs">Calculated</span></td><td class="px-4 py-2.5 text-xs"><span class="bg-brand-50 text-brand-600 px-1.5 py-0.5 rounded text-xs">Calculated</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">18</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Total_Unused_Exposure</td><td class="px-4 py-2.5 text-xs"><span class="bg-brand-50 text-brand-600 px-1.5 py-0.5 rounded text-xs">Calculated</span></td><td class="px-4 py-2.5 text-xs text-gray-500">Total Unused Exposure</td><td class="px-4 py-2.5 text-xs text-gray-500">Total Unused Exposure</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">19</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Total_Undrawn</td><td class="px-4 py-2.5 text-xs"><span class="bg-brand-50 text-brand-600 px-1.5 py-0.5 rounded text-xs">Calculated</span></td><td class="px-4 py-2.5 text-xs"><span class="bg-brand-50 text-brand-600 px-1.5 py-0.5 rounded text-xs">Calculated</span></td><td class="px-4 py-2.5 text-xs"><span class="bg-brand-50 text-brand-600 px-1.5 py-0.5 rounded text-xs">Calculated</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">20</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">PSE_non_PSE</td><td class="px-4 py-2.5 text-xs"><span class="bg-brand-50 text-brand-600 px-1.5 py-0.5 rounded text-xs">Lookup</span></td><td class="px-4 py-2.5 text-xs"><span class="bg-brand-50 text-brand-600 px-1.5 py-0.5 rounded text-xs">Lookup</span></td><td class="px-4 py-2.5 text-xs"><span class="bg-brand-50 text-brand-600 px-1.5 py-0.5 rounded text-xs">Lookup</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">21</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Underwriting_Team_Lead</td><td class="px-4 py-2.5 text-xs"><span class="bg-gray-100 text-gray-700 px-1.5 py-0.5 rounded text-xs">Derived</span></td><td class="px-4 py-2.5 text-xs text-gray-500"></td><td class="px-4 py-2.5 text-xs text-gray-500"></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">22</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Underwriter</td><td class="px-4 py-2.5 text-xs text-gray-500">Underwriter</td><td class="px-4 py-2.5 text-xs text-gray-500">Underwriter</td><td class="px-4 py-2.5 text-xs text-gray-500">Underwriter</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">23</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Fac_Start_Date</td><td class="px-4 py-2.5 text-xs text-gray-500">Fac Start Date</td><td class="px-4 py-2.5 text-xs text-gray-500">Facility Start Date</td><td class="px-4 py-2.5 text-xs text-gray-500">Facility Start Date</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">24</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Fac_Maturity_Date</td><td class="px-4 py-2.5 text-xs text-gray-500">Fac Maturity Date</td><td class="px-4 py-2.5 text-xs text-gray-500">Facility Maturity Date</td><td class="px-4 py-2.5 text-xs text-gray-500">Facility Maturity Date</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">25</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">CCM_Approval_Date</td><td class="px-4 py-2.5 text-xs text-gray-500">CCM Approval Date</td><td class="px-4 py-2.5 text-xs text-gray-500">CCM Approval Date</td><td class="px-4 py-2.5 text-xs text-gray-500">CCM Approval Date</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">26</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Next_CCM_Date</td><td class="px-4 py-2.5 text-xs text-gray-500">Next CCM Date</td><td class="px-4 py-2.5 text-xs text-gray-500">Next CCM Date</td><td class="px-4 py-2.5 text-xs text-gray-500">Next CCM Date</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">27</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Parent_Branch</td><td class="px-4 py-2.5 text-xs text-gray-500">Parent Branch</td><td class="px-4 py-2.5 text-xs text-gray-500">Parent Branch</td><td class="px-4 py-2.5 text-xs text-gray-500">Parent Branch</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">28</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Booking_Branch</td><td class="px-4 py-2.5 text-xs text-gray-500">Booking Branch</td><td class="px-4 py-2.5 text-xs text-gray-500">Booking Branch</td><td class="px-4 py-2.5 text-xs text-gray-500">Booking Branch</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">29</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Currency</td><td class="px-4 py-2.5 text-xs text-gray-500">Currency</td><td class="px-4 py-2.5 text-xs text-gray-500">Currency</td><td class="px-4 py-2.5 text-xs text-gray-500">Currency</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">30</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Portfolio_Name</td><td class="px-4 py-2.5 text-xs text-gray-500">Portfolio Name</td><td class="px-4 py-2.5 text-xs text-gray-500">Portfolio Name</td><td class="px-4 py-2.5 text-xs text-gray-500">Portfolio Name</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">31</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Client_Entity_Name</td><td class="px-4 py-2.5 text-xs text-gray-500">Client Entity Name</td><td class="px-4 py-2.5 text-xs text-gray-500">Client Entity Name</td><td class="px-4 py-2.5 text-xs text-gray-500">Client Entity Name</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">32</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Reporting_Unit</td><td class="px-4 py-2.5 text-xs text-gray-500">Reporting Unit</td><td class="px-4 py-2.5 text-xs text-gray-500">Reporting Unit</td><td class="px-4 py-2.5 text-xs text-gray-500">Reporting Unit</td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-4 py-2.5 text-gray-400 text-xs">33</td><td class="px-4 py-2.5 font-mono text-xs text-gray-800">Comments</td><td class="px-4 py-2.5 text-xs text-gray-500">Comments</td><td class="px-4 py-2.5 text-xs text-gray-500">Comments</td><td class="px-4 py-2.5 text-xs text-gray-500">Comments</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <!-- Legend -->
                            <div class="mt-3 flex flex-wrap gap-3 text-xs">
                                <div class="flex items-center gap-1.5">
                                    <span class="bg-brand-50 text-brand-600 px-1.5 py-0.5 rounded">Calculated</span>
                                    <span class="text-gray-500">Post-merge calculation</span>
                                </div>
                                <div class="flex items-center gap-1.5">
                                    <span class="bg-brand-50 text-brand-600 px-1.5 py-0.5 rounded">Lookup</span>
                                    <span class="text-gray-500">From Product_Mapping.xlsx</span>
                                </div>
                                <div class="flex items-center gap-1.5">
                                    <span class="bg-gray-100 text-gray-700 px-1.5 py-0.5 rounded">Derived</span>
                                    <span class="text-gray-500">Logic-based transformation</span>
                                </div>
                            </div>
                        </div>

                        <!-- Aggregation & History Section (NEW) -->
                        <div class="mb-8">
                            <h2 class="text-base font-medium text-gray-800 flex items-center gap-2 mb-4">
                                <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-success-50 text-success-500 text-xs font-bold">05</span>
                                Aggregation & Historical Tracking
                            </h2>
                            <div class="bg-success-25 rounded-xl p-5 border border-success-100 mb-4">
                                <div class="flex items-start gap-3">
                                    <svg class="w-5 h-5 text-success-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <div>
                                        <h4 class="font-semibold text-success-800 mb-1">Incremental Refresh</h4>
                                        <p class="text-sm text-success-700 mb-3">After processing full detail Portfolio data, the system automatically creates aggregated weekly metrics for historical trend analysis. This reduces data volume from ~50K+ detail records to ~4K aggregated records per year.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <!-- Aggregation Dimensions -->
                                <div class="rounded-xl border border-gray-200 bg-white p-5">
                                    <h4 class="font-medium text-gray-800 text-sm mb-3 flex items-center gap-2">
                                        <svg class="w-4 h-4 text-success-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                                        </svg>
                                        Aggregation Dimensions
                                    </h4>
                                    <p class="text-sm text-gray-500 mb-3">Data is grouped by the following dimensions:</p>
                                    <div class="grid md:grid-cols-3 gap-3">
                                        <div class="bg-gray-50 rounded-lg p-3">
                                            <div class="text-xs font-medium text-gray-700 mb-1">Time & Geography</div>
                                            <ul class="text-xs text-gray-500 space-y-0.5">
                                                <li> Report_Date</li>
                                                <li> Region</li>
                                            </ul>
                                        </div>
                                        <div class="bg-gray-50 rounded-lg p-3">
                                            <div class="text-xs font-medium text-gray-700 mb-1">Product Classification</div>
                                            <ul class="text-xs text-gray-500 space-y-0.5">
                                                <li> Product_Program</li>
                                                <li> Product_Sub_Program</li>
                                            </ul>
                                        </div>
                                        <div class="bg-gray-50 rounded-lg p-3">
                                            <div class="text-xs font-medium text-gray-700 mb-1">Facility Attributes</div>
                                            <ul class="text-xs text-gray-500 space-y-0.5">
                                                <li> Committed_Uncommitted</li>
                                                <li> PSE_non_PSE</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Aggregated Metrics -->
                                <div class="rounded-xl border border-gray-200 bg-white p-5">
                                    <h4 class="font-medium text-gray-800 text-sm mb-3 flex items-center gap-2">
                                        <svg class="w-4 h-4 text-success-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                        </svg>
                                        Metrics Calculated
                                    </h4>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <div class="font-medium text-xs text-gray-700 mb-2">Financial Metrics (SUM)</div>
                                            <ul class="text-xs text-gray-500 space-y-1">
                                                <li class="flex items-center gap-2">
                                                    <span class="w-1 h-1 rounded-full bg-success-400"></span>
                                                    <span><strong>TFA:</strong> Total Facility Amount</span>
                                                </li>
                                                <li class="flex items-center gap-2">
                                                    <span class="w-1 h-1 rounded-full bg-success-400"></span>
                                                    <span><strong>OSUC:</strong> Outstanding Under Commitment</span>
                                                </li>
                                                <li class="flex items-center gap-2">
                                                    <span class="w-1 h-1 rounded-full bg-success-400"></span>
                                                    <span><strong>Total_OS:</strong> Total Outstanding</span>
                                                </li>
                                                <li class="flex items-center gap-2">
                                                    <span class="w-1 h-1 rounded-full bg-success-400"></span>
                                                    <span><strong>Direct_OS:</strong> Direct Outstanding</span>
                                                </li>
                                                <li class="flex items-center gap-2">
                                                    <span class="w-1 h-1 rounded-full bg-success-400"></span>
                                                    <span><strong>Contingent_OS:</strong> Contingent Outstanding</span>
                                                </li>
                                                <li class="flex items-center gap-2">
                                                    <span class="w-1 h-1 rounded-full bg-success-400"></span>
                                                    <span><strong>PSE_OS:</strong> PSE Outstanding</span>
                                                </li>
                                                <li class="flex items-center gap-2">
                                                    <span class="w-1 h-1 rounded-full bg-success-400"></span>
                                                    <span><strong>Total_Unused_Exposure:</strong> Unused commitment</span>
                                                </li>
                                                <li class="flex items-center gap-2">
                                                    <span class="w-1 h-1 rounded-full bg-success-400"></span>
                                                    <span><strong>Total_Undrawn:</strong> Undrawn amount</span>
                                                </li>
                                            </ul>
                                        </div>
                                        <div>
                                            <div class="font-medium text-xs text-gray-700 mb-2">Count Metrics (DISTINCT)</div>
                                            <ul class="text-xs text-gray-500 space-y-1">
                                                <li class="flex items-center gap-2">
                                                    <span class="w-1 h-1 rounded-full bg-brand-400"></span>
                                                    <span><strong>Count_of_Facilities:</strong> Unique Facility IDs</span>
                                                </li>
                                                <li class="flex items-center gap-2">
                                                    <span class="w-1 h-1 rounded-full bg-brand-400"></span>
                                                    <span><strong>Count_of_Relationships:</strong> Unique Relationship IDs</span>
                                                </li>
                                                <li class="flex items-center gap-2">
                                                    <span class="w-1 h-1 rounded-full bg-brand-400"></span>
                                                    <span><strong>Count_of_CAs:</strong> Unique Credit Approval IDs</span>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Historical Merge Process -->
                                <div class="rounded-xl border border-success-200 bg-success-50 p-5">
                                    <h4 class="font-medium text-success-800 text-sm mb-2 flex items-center gap-2">
                                        <svg class="w-4 h-4 text-success-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        Incremental Merge Logic
                                    </h4>
                                    <ul class="text-xs text-success-700 space-y-1.5">
                                        <li class="flex items-start gap-2">
                                            <span class="w-1 h-1 rounded-full bg-success-500 mt-1.5"></span>
                                            <span><strong>First Run:</strong> Creates new <code class="px-1 py-0.5 bg-white text-success-600 rounded font-mono">Portfolio_Aggregated_History.xlsx</code> file</span>
                                        </li>
                                        <li class="flex items-start gap-2">
                                            <span class="w-1 h-1 rounded-full bg-success-500 mt-1.5"></span>
                                            <span><strong>Subsequent Runs:</strong> Downloads existing file, merges new data with historical data</span>
                                        </li>
                                        <li class="flex items-start gap-2">
                                            <span class="w-1 h-1 rounded-full bg-success-500 mt-1.5"></span>
                                            <span><strong>Duplicate Handling:</strong> Same week data is updated (not duplicated) using composite key matching</span>
                                        </li>
                                        <li class="flex items-start gap-2">
                                            <span class="w-1 h-1 rounded-full bg-success-500 mt-1.5"></span>
                                            <span><strong>Auto-Upload:</strong> Merged file automatically uploaded back to Confluence attachment</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Output Info -->
                        <div class="space-y-3">
                            <div class="rounded-xl bg-brand-50 border border-brand-200 p-5">
                                <div class="flex items-start gap-3">
                                    <svg class="w-5 h-5 text-brand-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div>
                                        <h4 class="font-semibold text-brand-800 mb-1">Primary Output File</h4>
                                        <p class="text-sm text-brand-700">The consolidated data (33 columns) is saved as <code class="px-1.5 py-0.5 bg-white text-brand-600 rounded text-xs font-mono border border-brand-200">Portfolio_tw.xlsx</code> and automatically uploaded to Portfolio Analytics of LPTM.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="rounded-xl bg-success-50 border border-success-200 p-5">
                                <div class="flex items-start gap-3">
                                    <svg class="w-5 h-5 text-success-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <div>
                                        <h4 class="font-semibold text-success-800 mb-1">Aggregated History File (NEW)</h4>
                                        <p class="text-sm text-success-700">Weekly aggregated metrics (17 columns) are incrementally saved to <code class="px-1.5 py-0.5 bg-white text-success-600 rounded text-xs font-mono border border-success-200">Portfolio_Aggregated_History.xlsx</code> and automatically uploaded to Portfolio Analytics of LPTM. This file grows incrementally with each weekly run.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== COVENANTS DOCUMENTATION ==================== -->
            <div x-show="selectedDoc === 'covenants'" class="space-y-6">
                <div class="rounded-2xl border border-gray-200 bg-white overflow-hidden">
                    <!-- Doc Header -->
                    <div class="px-5 py-4 sm:px-6 sm:py-5 border-b border-gray-100">
                        <div class="flex items-center gap-4">
                            <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-brand-500 text-white">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <h1 class="text-xl font-semibold text-gray-800">Covenants</h1>
                                <p class="text-gray-500 text-sm mt-0.5">ETL Process Documentation</p>
                            </div>
                        </div>
                    </div>

                    <!-- Doc Content - MDX Style -->
                    <div class="border-t border-gray-100 p-5 sm:p-6">
                        <!-- Overview Section -->
                        <div class="mb-8">
                            <h2 class="text-base font-medium text-gray-800 flex items-center gap-2 mb-4">
                                <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-brand-50 text-brand-500 text-xs font-bold">01</span>
                                Overview
                            </h2>
                            <div class="bg-brand-25 rounded-xl p-5 border border-brand-100">
                                <p class="text-gray-600 text-sm leading-relaxed mb-0">
                                    The Covenants ETL process consolidates covenant data from three regional files into a single 
                                    <code class="px-1.5 py-0.5 bg-white text-brand-600 rounded text-xs font-mono border border-brand-200">Covenants_tw.xlsx</code> 
                                    file. This process reads from the first sheet of each regional file, standardizes column names, 
                                    filters out internal covenants, and normalizes status values.
                                </p>
                            </div>
                        </div>

                        <!-- Data Sources Section -->
                        <div class="mb-8">
                            <h2 class="text-base font-medium text-gray-800 flex items-center gap-2 mb-4">
                                <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-brand-50 text-brand-500 text-xs font-bold">02</span>
                                Data Sources
                            </h2>
                            <div class="grid md:grid-cols-3 gap-4">
                                <div class="rounded-xl border border-gray-200 bg-white p-5 hover:border-brand-200 transition-colors">
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700">NAM</span>
                                        <span class="text-sm font-medium text-gray-800">Covenants File</span>
                                    </div>
                                    <p class="text-sm text-gray-500 mb-2">New Covenants Module Export</p>
                                    <div class="text-xs text-gray-500">
                                        <span class="font-medium text-gray-700">Sheet:</span> 1st sheet (always)
                                    </div>
                                </div>
                                <div class="rounded-xl border border-gray-200 bg-white p-5 hover:border-brand-200 transition-colors">
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="px-2.5 py-1 rounded-full text-xs font-medium bg-brand-50 text-brand-600">APAC</span>
                                        <span class="text-sm font-medium text-gray-800">Covenants File</span>
                                    </div>
                                    <p class="text-sm text-gray-500 mb-2">New Covenants Module Export</p>
                                    <div class="text-xs text-gray-500">
                                        <span class="font-medium text-gray-700">Sheet:</span> 1st sheet (always)
                                    </div>
                                </div>
                                <div class="rounded-xl border border-gray-200 bg-white p-5 hover:border-brand-200 transition-colors">
                                    <div class="flex items-center gap-2 mb-3">
                                        <span class="px-2.5 py-1 rounded-full text-xs font-medium bg-brand-50 text-brand-600">EMEA</span>
                                        <span class="text-sm font-medium text-gray-800">Covenants File</span>
                                    </div>
                                    <p class="text-sm text-gray-500 mb-2">New Covenants Module Export</p>
                                    <div class="text-xs text-gray-500">
                                        <span class="font-medium text-gray-700">Sheet:</span> 1st sheet (always)
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Transformation Rules Section -->
                        <div class="mb-8">
                            <h2 class="text-base font-medium text-gray-800 flex items-center gap-2 mb-4">
                                <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-brand-50 text-brand-500 text-xs font-bold">03</span>
                                Transformation Rules
                            </h2>
                            <div class="space-y-3">
                                <!-- Rule 1 -->
                                <div class="rounded-xl border border-gray-200 bg-white p-4 hover:border-brand-200 transition-colors">
                                    <div class="flex items-start gap-3">
                                        <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-brand-50 text-brand-500 font-bold text-xs flex-shrink-0">T1</div>
                                        <div>
                                            <h4 class="font-medium text-gray-800 text-sm mb-1">Column Mapping</h4>
                                            <p class="text-sm text-gray-500">Regional columns are mapped to standardized 26-column output schema. All regions use similar column structures from the New Covenants Module.</p>
                                        </div>
                                    </div>
                                </div>
                                <!-- Rule 2 -->
                                <div class="rounded-xl border border-gray-200 bg-white p-4 hover:border-brand-200 transition-colors">
                                    <div class="flex items-start gap-3">
                                        <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-brand-50 text-brand-500 font-bold text-xs flex-shrink-0">T2</div>
                                        <div>
                                            <h4 class="font-medium text-gray-800 text-sm mb-1">Date Formatting</h4>
                                            <p class="text-sm text-gray-500 mb-2">All date columns are converted to <code class="px-1.5 py-0.5 bg-brand-50 text-brand-600 rounded text-xs">DD/MM/YYYY</code> format. Handles multiple input formats including Excel serial numbers.</p>
                                        </div>
                                    </div>
                                </div>
                                <!-- Rule 3 -->
                                <div class="rounded-xl border border-gray-200 bg-white p-4 hover:border-brand-200 transition-colors">
                                    <div class="flex items-start gap-3">
                                        <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-brand-50 text-brand-500 font-bold text-xs flex-shrink-0">T3</div>
                                        <div>
                                            <h4 class="font-medium text-gray-800 text-sm mb-1">Status Normalization</h4>
                                            <p class="text-sm text-gray-500 mb-2">The <code class="px-1.5 py-0.5 bg-brand-50 text-brand-600 rounded text-xs">Coming Due / Past Due</code> column values are normalized:</p>
                                            <div class="flex flex-wrap gap-3">
                                                <div class="flex items-center gap-2">
                                                    <span class="px-2 py-0.5 bg-gray-100 text-gray-500 rounded-full text-xs font-mono line-through">Past_Due</span>
                                                    <svg class="w-4 h-4 text-brand-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                                                    <span class="px-2 py-0.5 bg-gray-100 text-gray-600 rounded-full text-xs font-medium">Past Due</span>
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <span class="px-2 py-0.5 bg-gray-100 text-gray-500 rounded-full text-xs font-mono line-through">Coming_Due</span>
                                                    <svg class="w-4 h-4 text-brand-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                                                    <span class="px-2 py-0.5 bg-gray-100 text-gray-700 rounded-full text-xs font-medium">Coming Due</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Rule 4 -->
                                <div class="rounded-xl border border-gray-200 bg-white p-4 hover:border-brand-200 transition-colors">
                                    <div class="flex items-start gap-3">
                                        <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-brand-50 text-brand-500 font-bold text-xs flex-shrink-0">T4</div>
                                        <div>
                                            <h4 class="font-medium text-gray-800 text-sm mb-1">Internal Covenant Filter</h4>
                                            <p class="text-sm text-gray-500 mb-2">Rows are filtered out if either condition is met:</p>
                                            <div class="bg-gray-50 rounded-lg p-2.5 border border-gray-200 space-y-2">
                                                <div class="flex items-center gap-2 text-sm text-gray-600">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
                                                    </svg>
                                                    <code class="px-1.5 py-0.5 bg-brand-50 text-brand-600 rounded text-xs">Covenant Description</code>
                                                    <span class="text-xs">starts with</span>
                                                    <span class="font-mono text-xs">Internal Cov*</span>
                                                </div>
                                                <div class="flex items-center gap-2 text-sm text-gray-600">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
                                                    </svg>
                                                    <code class="px-1.5 py-0.5 bg-brand-50 text-brand-600 rounded text-xs">Covenant Remarks</code>
                                                    <span class="text-xs">starts with</span>
                                                    <span class="font-mono text-xs">Internal*</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Output Schema Section -->
                        <div class="mb-8">
                            <h2 class="text-base font-medium text-gray-800 flex items-center gap-2 mb-4">
                                <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-brand-50 text-brand-500 text-xs font-bold">04</span>
                                Output Schema (26 Columns)
                            </h2>
                            <div class="overflow-hidden rounded-xl border border-gray-200 bg-white">
                                <div class="max-h-80 overflow-y-auto">
                                    <table class="w-full">
                                        <thead class="sticky top-0">
                                            <tr class="border-b border-gray-100 bg-white">
                                                <th class="px-5 py-3 text-left sm:px-6">
                                                    <p class="font-medium text-gray-500 text-xs">#</p>
                                                </th>
                                                <th class="px-5 py-3 text-left sm:px-6">
                                                    <p class="font-medium text-gray-500 text-xs">Column Name</p>
                                                </th>
                                                <th class="px-5 py-3 text-left sm:px-6">
                                                    <p class="font-medium text-gray-500 text-xs">Type</p>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">1</td><td class="px-5 py-3 sm:px-6 font-mono text-xs text-gray-800">Region</td><td class="px-5 py-3 sm:px-6"><span class="bg-brand-50 text-brand-600 text-xs rounded-full px-2 py-0.5 font-medium">String</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">2</td><td class="px-5 py-3 sm:px-6 font-mono text-xs text-gray-800">Coming Due / Past Due</td><td class="px-5 py-3 sm:px-6"><span class="bg-brand-50 text-brand-600 text-xs rounded-full px-2 py-0.5 font-medium">String</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">3</td><td class="px-5 py-3 sm:px-6 font-mono text-xs text-gray-800">Group ID</td><td class="px-5 py-3 sm:px-6"><span class="bg-brand-50 text-brand-600 text-xs rounded-full px-2 py-0.5 font-medium">String</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">4</td><td class="px-5 py-3 sm:px-6 font-mono text-xs text-gray-800">Group Name</td><td class="px-5 py-3 sm:px-6"><span class="bg-brand-50 text-brand-600 text-xs rounded-full px-2 py-0.5 font-medium">String</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">5</td><td class="px-5 py-3 sm:px-6 font-mono text-xs text-gray-800">Client ID</td><td class="px-5 py-3 sm:px-6"><span class="bg-brand-50 text-brand-600 text-xs rounded-full px-2 py-0.5 font-medium">String</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">6</td><td class="px-5 py-3 sm:px-6 font-mono text-xs text-gray-800">Client Name</td><td class="px-5 py-3 sm:px-6"><span class="bg-brand-50 text-brand-600 text-xs rounded-full px-2 py-0.5 font-medium">String</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">7</td><td class="px-5 py-3 sm:px-6 font-mono text-xs text-gray-800">Fac ID</td><td class="px-5 py-3 sm:px-6"><span class="bg-brand-50 text-brand-600 text-xs rounded-full px-2 py-0.5 font-medium">String</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">8</td><td class="px-5 py-3 sm:px-6 font-mono text-xs text-gray-800">Covenant ID</td><td class="px-5 py-3 sm:px-6"><span class="bg-brand-50 text-brand-600 text-xs rounded-full px-2 py-0.5 font-medium">String</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">9</td><td class="px-5 py-3 sm:px-6 font-mono text-xs text-gray-800">Covenant Status</td><td class="px-5 py-3 sm:px-6"><span class="bg-brand-50 text-brand-600 text-xs rounded-full px-2 py-0.5 font-medium">String</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">10</td><td class="px-5 py-3 sm:px-6 font-mono text-xs text-gray-800">Covenant Category</td><td class="px-5 py-3 sm:px-6"><span class="bg-brand-50 text-brand-600 text-xs rounded-full px-2 py-0.5 font-medium">String</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">11</td><td class="px-5 py-3 sm:px-6 font-mono text-xs text-gray-800">Covenant Type</td><td class="px-5 py-3 sm:px-6"><span class="bg-brand-50 text-brand-600 text-xs rounded-full px-2 py-0.5 font-medium">String</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">12</td><td class="px-5 py-3 sm:px-6 font-mono text-xs text-gray-800">Covenant Description</td><td class="px-5 py-3 sm:px-6"><span class="bg-brand-50 text-brand-600 text-xs rounded-full px-2 py-0.5 font-medium">String</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">13</td><td class="px-5 py-3 sm:px-6 font-mono text-xs text-gray-800">Compliance Frequency</td><td class="px-5 py-3 sm:px-6"><span class="bg-brand-50 text-brand-600 text-xs rounded-full px-2 py-0.5 font-medium">String</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">14</td><td class="px-5 py-3 sm:px-6 font-mono text-xs text-gray-800">Compliance Grace Period</td><td class="px-5 py-3 sm:px-6"><span class="bg-blue-50 text-blue-600 text-xs rounded-full px-2 py-0.5 font-medium">Number</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">15</td><td class="px-5 py-3 sm:px-6 font-mono text-xs text-gray-800">Compliance Due Date</td><td class="px-5 py-3 sm:px-6"><span class="bg-blue-50 text-blue-600 text-xs rounded-full px-2 py-0.5 font-medium">Date</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">16</td><td class="px-5 py-3 sm:px-6 font-mono text-xs text-gray-800">Compliance Due Date with Grace</td><td class="px-5 py-3 sm:px-6"><span class="bg-blue-50 text-blue-600 text-xs rounded-full px-2 py-0.5 font-medium">Date</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">17</td><td class="px-5 py-3 sm:px-6 font-mono text-xs text-gray-800">Previous Compliance Date</td><td class="px-5 py-3 sm:px-6"><span class="bg-blue-50 text-blue-600 text-xs rounded-full px-2 py-0.5 font-medium">Date</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">18</td><td class="px-5 py-3 sm:px-6 font-mono text-xs text-gray-800">Covenant Start Date</td><td class="px-5 py-3 sm:px-6"><span class="bg-blue-50 text-blue-600 text-xs rounded-full px-2 py-0.5 font-medium">Date</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">19</td><td class="px-5 py-3 sm:px-6 font-mono text-xs text-gray-800">Covenant Maturity Date</td><td class="px-5 py-3 sm:px-6"><span class="bg-blue-50 text-blue-600 text-xs rounded-full px-2 py-0.5 font-medium">Date</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">20</td><td class="px-5 py-3 sm:px-6 font-mono text-xs text-gray-800">Parent Branch</td><td class="px-5 py-3 sm:px-6"><span class="bg-brand-50 text-brand-600 text-xs rounded-full px-2 py-0.5 font-medium">String</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">21</td><td class="px-5 py-3 sm:px-6 font-mono text-xs text-gray-800">Covenant Booking Branch</td><td class="px-5 py-3 sm:px-6"><span class="bg-brand-50 text-brand-600 text-xs rounded-full px-2 py-0.5 font-medium">String</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">22</td><td class="px-5 py-3 sm:px-6 font-mono text-xs text-gray-800">Client Entity Name</td><td class="px-5 py-3 sm:px-6"><span class="bg-brand-50 text-brand-600 text-xs rounded-full px-2 py-0.5 font-medium">String</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">23</td><td class="px-5 py-3 sm:px-6 font-mono text-xs text-gray-800">Lead Underwriter</td><td class="px-5 py-3 sm:px-6"><span class="bg-brand-50 text-brand-600 text-xs rounded-full px-2 py-0.5 font-medium">String</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">24</td><td class="px-5 py-3 sm:px-6 font-mono text-xs text-gray-800">Reporting Unit</td><td class="px-5 py-3 sm:px-6"><span class="bg-brand-50 text-brand-600 text-xs rounded-full px-2 py-0.5 font-medium">String</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">25</td><td class="px-5 py-3 sm:px-6 font-mono text-xs text-gray-800">Client Risk Category</td><td class="px-5 py-3 sm:px-6"><span class="bg-brand-50 text-brand-600 text-xs rounded-full px-2 py-0.5 font-medium">String</span></td></tr>
                                            <tr class="border-b border-gray-100"><td class="px-5 py-3 sm:px-6 text-gray-500 text-xs">26</td><td class="px-5 py-3 sm:px-6 font-mono text-xs text-gray-800">Portfolio Name</td><td class="px-5 py-3 sm:px-6"><span class="bg-brand-50 text-brand-600 text-xs rounded-full px-2 py-0.5 font-medium">String</span></td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Output Info -->
                        <div class="rounded-xl bg-brand-50 border border-brand-100 p-5">
                            <div class="flex items-start gap-3">
                                <svg class="w-5 h-5 text-brand-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div>
                                    <h4 class="font-semibold text-brand-800 mb-1">Output File</h4>
                                    <p class="text-sm text-brand-700">The consolidated data is saved as <code class="px-1.5 py-0.5 bg-white text-brand-600 rounded text-xs font-mono border border-brand-200">Covenants_tw.xlsx</code> and automatically uploaded to Portfolio Analytics of LPTM.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Documentation Tab -->

    </div>

    <script>
        function dataLoaderApp() {
            return {
                isLoading: false,
                loadingMessage: 'Processing Files',
                processingComplete: false,
                processingResult: null,
                ccmReportDate: new Date().toISOString().split('T')[0], // Default to today
                // Store processed data for download
                processedDataCache: {
                    portfolio: null,
                    covenants: null,
                    ccm: null,
                    rotce: null,
                    aggregatedHistory: null
                },
                files: {
                    portfolio: { emea: null, nam: null, apac: null },
                    covenants: { emea: null, nam: null, apac: null },
                    ccm: { emea: null, nam: null, apac: null },
                    rotce: { global: null },
                    mapping: null
                },
                
                // Portfolio Analytics of LPTM Configuration
                confluenceConfig: {
                    pageId: '3229979875',
                    baseUrl: 'https://cedt-confluence.nam.nsroot.net/confluence',
                    ccmFileName: 'CCM_tw.xlsx',
                    portfolioFileName: 'Portfolio_tw.xlsx',
                    covenantsFileName: 'Covenants_tw.xlsx',
                    rotceFileName: 'ROTCE_tw.xlsx',
                    mappingFileName: 'Product_Mapping.xlsx',
                    regionsMappingFileName: 'Regions_Mapping.xlsx',
                    aggregatedHistoryFileName: 'Portfolio_Aggregated_History.xlsx'
                },

                handleFileSelect(event, category, region) {
                    const file = event.target.files[0];
                    if (file && this.isValidExcel(file)) {
                        this.files[category][region] = file;
                        this.showNotification(`${region.toUpperCase()} file uploaded successfully`, 'success');
                    } else if (file) {
                        this.showNotification('Please select a valid Excel file (.xlsx, .xls)', 'error');
                    }
                    event.target.value = '';
                },

                handleMappingSelect(event) {
                    const file = event.target.files[0];
                    if (file && this.isValidExcel(file)) {
                        this.files.mapping = file;
                        this.showNotification('Product mapping file uploaded successfully', 'success');
                    } else if (file) {
                        this.showNotification('Please select a valid Excel file (.xlsx, .xls)', 'error');
                    }
                    event.target.value = '';
                },

                isValidExcel(file) {
                    const validTypes = [
                        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                        'application/vnd.ms-excel'
                    ];
                    const validExtensions = ['.xlsx', '.xls'];
                    const hasValidType = validTypes.includes(file.type);
                    const hasValidExtension = validExtensions.some(ext => file.name.toLowerCase().endsWith(ext));
                    return hasValidType || hasValidExtension;
                },

                removeFile(category, region) {
                    this.files[category][region] = null;
                    this.showNotification(`${region.toUpperCase()} file removed`, 'info');
                },

                getFileCount(category) {
                    if (category === 'mapping') {
                        return this.files.mapping ? 1 : 0;
                    }
                    return Object.values(this.files[category]).filter(f => f !== null).length;
                },

                formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },

                downloadMappingTemplate() {
                    // Download the mapping template file
                    this.showNotification('Downloading Product_Mapping.xlsx template...', 'info');
                    
                    const link = document.createElement('a');
                    link.href = this.mappingDownloadUrl;
                    link.download = 'Product_Mapping.xlsx';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },

                clearAllFiles() {
                    this.files = {
                        portfolio: { emea: null, nam: null, apac: null },
                        covenants: { emea: null, nam: null, apac: null },
                        ccm: { emea: null, nam: null, apac: null },
                        rotce: { global: null },
                        mapping: null
                    };
                    this.showNotification('All files cleared', 'info');
                },

                canProcess() {
                    // At least one complete category should be ready to process
                    const validation = this.validateCategoryCompleteness();
                    return validation.canProcess;
                },
                
                // Validate that if any file is uploaded for a category, ALL files must be uploaded
                validateCategoryCompleteness() {
                    const result = {
                        canProcess: false,
                        errors: [],
                        warnings: [],
                        completedCategories: []
                    };
                    
                    const regions = ['emea', 'nam', 'apac'];
                    
                    // Check Portfolio
                    const portfolioFiles = regions.map(r => this.files.portfolio[r] ? r.toUpperCase() : null).filter(Boolean);
                    const portfolioMissing = regions.filter(r => !this.files.portfolio[r]).map(r => r.toUpperCase());
                    
                    if (portfolioFiles.length > 0 && portfolioFiles.length < 3) {
                        result.errors.push({
                            category: 'Portfolio',
                            uploaded: portfolioFiles,
                            missing: portfolioMissing,
                            message: `Portfolio: Missing ${portfolioMissing.join(', ')} file(s)`
                        });
                    } else if (portfolioFiles.length === 3) {
                        result.completedCategories.push('Portfolio');
                    }
                    
                    // Check Covenants
                    const covenantsFiles = regions.map(r => this.files.covenants[r] ? r.toUpperCase() : null).filter(Boolean);
                    const covenantsMissing = regions.filter(r => !this.files.covenants[r]).map(r => r.toUpperCase());
                    
                    if (covenantsFiles.length > 0 && covenantsFiles.length < 3) {
                        result.errors.push({
                            category: 'Covenants',
                            uploaded: covenantsFiles,
                            missing: covenantsMissing,
                            message: `Covenants: Missing ${covenantsMissing.join(', ')} file(s)`
                        });
                    } else if (covenantsFiles.length === 3) {
                        result.completedCategories.push('Covenants');
                    }
                    
                    // Check CCM
                    const ccmFiles = regions.map(r => this.files.ccm[r] ? r.toUpperCase() : null).filter(Boolean);
                    const ccmMissing = regions.filter(r => !this.files.ccm[r]).map(r => r.toUpperCase());
                    
                    if (ccmFiles.length > 0 && ccmFiles.length < 3) {
                        result.errors.push({
                            category: 'CCM',
                            uploaded: ccmFiles,
                            missing: ccmMissing,
                            message: `CCM: Missing ${ccmMissing.join(', ')} file(s)`
                        });
                    } else if (ccmFiles.length === 3) {
                        result.completedCategories.push('CCM');
                    }
                    
                    // ROTCE and Product_Mapping are optional - just note if uploaded
                    if (this.files.rotce.global) {
                        result.warnings.push('ROTCE file uploaded (optional)');
                    }
                    if (this.files.mapping) {
                        result.warnings.push('Product Mapping file uploaded (optional)');
                    }
                    
                    // Can process if at least one category is complete AND no errors
                    result.canProcess = result.completedCategories.length > 0 && result.errors.length === 0;
                    
                    return result;
                },

                async validateFiles() {
                    this.isLoading = true;
                    this.loadingMessage = 'Validating Files...';
                    
                    // Simulate validation
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    const validation = this.validateCategoryCompleteness();

                    this.isLoading = false;

                    // Show validation errors if any
                    if (validation.errors.length > 0) {
                        const errorMessages = validation.errors.map(e => e.message).join('\n ');
                        this.showValidationPopover(validation);
                        return;
                    }
                    
                    // Check if any files are uploaded
                    if (validation.completedCategories.length === 0) {
                        this.showNotification('Please upload all regional files (EMEA, NAM, APAC) for at least one category', 'info');
                        return;
                    }
                    
                    // All good
                    const readyMsg = `Ready to process: ${validation.completedCategories.join(', ')}`;
                    this.showNotification(readyMsg + ' - All files validated successfully!', 'success');
                },
                
                // Show validation error popover with details
                showValidationPopover(validation) {
                    let html = '<div class="text-left">';
                    html += '<p class="font-semibold text-red-700 mb-2"> Incomplete File Sets Detected</p>';
                    html += '<p class="text-xs text-gray-600 mb-3">All regional files (EMEA, NAM, APAC) must be uploaded for each category you want to process.</p>';
                    
                    validation.errors.forEach(error => {
                        html += `<div class="mb-3 p-2 bg-red-50 rounded-lg border border-red-200">`;
                        html += `<p class="font-semibold text-red-800 text-sm">${error.category}</p>`;
                        html += `<p class="text-xs text-gray-600">Uploaded: <span class="text-green-600 font-medium">${error.uploaded.join(', ') || 'None'}</span></p>`;
                        html += `<p class="text-xs text-gray-600">Missing: <span class="text-red-600 font-medium">${error.missing.join(', ')}</span></p>`;
                        html += `</div>`;
                    });
                    
                    if (validation.completedCategories.length > 0) {
                        html += `<p class="text-xs text-green-600 mt-2"> Complete: ${validation.completedCategories.join(', ')}</p>`;
                    }
                    
                    html += '<p class="text-xs text-gray-500 mt-3 italic">Note: ROTCE and Product Mapping files are optional.</p>';
                    html += '</div>';
                    
                    this.showNotification(html, 'error', 10000); // Show for 10 seconds
                },

                async processAndLoad() {
                    const validation = this.validateCategoryCompleteness();
                    
                    // Show errors if validation fails
                    if (validation.errors.length > 0) {
                        this.showValidationPopover(validation);
                        return;
                    }
                    
                    if (!validation.canProcess) {
                        this.showNotification('Please upload all regional files (EMEA, NAM, APAC) for at least one category', 'warning');
                        return;
                    }
                    
                    this.isLoading = true;
                    this.loadingMessage = 'Processing Files...';
                    
                    try {
                        // Process each category
                        const processedData = {
                            portfolio: [],
                            covenants: [],
                            ccm: [],
                            mapping: null
                        };

                        // Load PSE mapping data from Confluence or uploaded file
                        let pseMappingData = null;
                        this.loadingMessage = 'Loading Product Mapping...';
                        
                        // First try to use uploaded mapping file, then fall back to Confluence
                        if (this.files.mapping) {
                            pseMappingData = await this.loadPSEMappingData(this.files.mapping);
                        } else {
                            // Fetch from Confluence attachments
                            const mappingWorkbook = await this.fetchMappingFromConfluence();
                            if (mappingWorkbook) {
                                pseMappingData = await this.loadPSEMappingData(mappingWorkbook);
                            }
                        }
                        
                        if (!pseMappingData || (pseMappingData.facilityTypes.length === 0 && pseMappingData.categoryMapping.length === 0)) {
                            console.log('Product_Mapping.xlsx not found - PSE and Category mapping will be skipped');
                        }

                        // Fetch Regions mapping for NAM
                        this.loadingMessage = 'Loading Regions Mapping...';
                        const regionsMapping = await this.fetchRegionsMappingFromConfluence();

                        // Process portfolio files with ETL logic
                        let allPortfolioData = [];
                        for (const [region, file] of Object.entries(this.files.portfolio)) {
                            if (file) {
                                this.loadingMessage = `Processing Portfolio ${region.toUpperCase()} with ETL...`;
                                const data = await this.processPortfolioFile(file, region, pseMappingData, regionsMapping);
                                allPortfolioData = [...allPortfolioData, ...data];
                                processedData.portfolio.push({ region, data, rowCount: data.length });
                            }
                        }

                        // Fetch ROTCE data from Confluence for mapping
                        this.loadingMessage = 'Loading ROTCE data for Portfolio mapping...';
                        const rotceData = await this.fetchROTCEFromConfluence();
                        
                        // Apply ROTCE mapping to Portfolio data
                        if (allPortfolioData.length > 0 && rotceData && rotceData.length > 0) {
                            this.loadingMessage = 'Mapping ROTCE to Portfolio...';
                            allPortfolioData = this.mapROTCEToPortfolio(allPortfolioData, rotceData);
                        }

                        // Apply post-merge calculations
                        if (allPortfolioData.length > 0) {
                            this.loadingMessage = 'Applying Portfolio calculations...';
                            allPortfolioData = this.applyPortfolioCalculations(allPortfolioData);
                        }

                        // Store consolidated Portfolio data
                        processedData.portfolioConsolidated = allPortfolioData;

                        // Track upload status for each file type
                        let portfolioUploadSuccess = false;
                        let covenantsUploadSuccess = false;
                        let ccmUploadSuccess = false;

                        // Upload consolidated Portfolio file to Confluence if we have data
                        if (allPortfolioData.length > 0) {
                            this.loadingMessage = 'Uploading Portfolio_tw.xlsx to Portfolio Analytics...';
                            portfolioUploadSuccess = await this.uploadPortfolioToConfluence(allPortfolioData);
                            if (portfolioUploadSuccess) {
                                this.showNotification(`Portfolio_tw.xlsx uploaded to Portfolio Analytics (${allPortfolioData.length} records)`, 'success');
                            } else {
                                this.showNotification('Portfolio processed - use Download button to save file', 'warning');
                            }
                        }

                        // Process covenants files with ETL logic
                        let allCovenantsData = [];
                        for (const [region, file] of Object.entries(this.files.covenants)) {
                            if (file) {
                                this.loadingMessage = `Processing Covenants ${region.toUpperCase()} with ETL...`;
                                const data = await this.processCovenantFile(file, region, regionsMapping);
                                allCovenantsData = [...allCovenantsData, ...data];
                                processedData.covenants.push({ region, data, rowCount: data.length });
                            }
                        }
                        // Store consolidated Covenants data
                        processedData.covenantsConsolidated = allCovenantsData;

                        // Upload consolidated Covenants file to Confluence if we have data
                        if (allCovenantsData.length > 0) {
                            this.loadingMessage = 'Uploading Covenants_tw.xlsx to Portfolio Analytics...';
                            covenantsUploadSuccess = await this.uploadCovenantsToConfluence(allCovenantsData);
                            if (covenantsUploadSuccess) {
                                this.showNotification(`Covenants_tw.xlsx uploaded to Portfolio Analytics (${allCovenantsData.length} records)`, 'success');
                            } else {
                                this.showNotification('Covenants processed - use Download button to save file', 'warning');
                            }
                        }

                        // Process CCM files with ETL logic
                        let allCCMData = [];
                        for (const [region, file] of Object.entries(this.files.ccm)) {
                            if (file) {
                                this.loadingMessage = `Processing CCM ${region.toUpperCase()} with ETL...`;
                                const data = await this.processCCMFile(file, region);
                                allCCMData = [...allCCMData, ...data];
                                processedData.ccm.push({ region, data, rowCount: data.length });
                            }
                        }
                        // Store consolidated CCM data
                        processedData.ccmConsolidated = allCCMData;

                        // Upload consolidated CCM file to Confluence if we have CCM data
                        if (allCCMData.length > 0) {
                            this.loadingMessage = 'Uploading CCM_tw.xlsx to Portfolio Analytics...';
                            ccmUploadSuccess = await this.uploadCCMToConfluence(allCCMData);
                            if (ccmUploadSuccess) {
                                this.showNotification(`CCM_tw.xlsx uploaded to Portfolio Analytics (${allCCMData.length} records)`, 'success');
                            } else {
                                this.showNotification('CCM processed - use Download button to save file', 'warning');
                            }
                        }

                        // Process ROTCE file
                        let allROTCEData = [];
                        let rotceUploadSuccess = false;
                        if (this.files.rotce.global) {
                            this.loadingMessage = 'Processing ROTCE data...';
                            allROTCEData = await this.processROTCEFile(this.files.rotce.global);
                            processedData.rotce = allROTCEData;
                            
                            // Upload ROTCE_tw.xlsx to Confluence
                            if (allROTCEData.length > 0) {
                                this.loadingMessage = 'Uploading ROTCE_tw.xlsx to Portfolio Analytics...';
                                rotceUploadSuccess = await this.uploadROTCEToConfluence(allROTCEData);
                                if (rotceUploadSuccess) {
                                    this.showNotification(`ROTCE_tw.xlsx uploaded to Portfolio Analytics (${allROTCEData.length} records)`, 'success');
                                } else {
                                    this.showNotification('ROTCE processed - use Download button to save file', 'warning');
                                }
                            }
                        }

                        // Process mapping file
                        if (this.files.mapping) {
                            this.loadingMessage = 'Processing Product Mapping...';
                            processedData.mapping = await this.readExcelFile(this.files.mapping);
                        }

                        // STEP 5: Aggregate Portfolio data for historical tracking
                        let aggregatedHistoryUploadSuccess = false;
                        let aggregatedRecordCount = 0;
                        if (allPortfolioData.length > 0) {
                            this.loadingMessage = 'Creating aggregated historical data...';
                            const aggregatedData = this.aggregatePortfolioData(allPortfolioData);
                            aggregatedRecordCount = aggregatedData.length;
                            
                            console.log(`Aggregated ${allPortfolioData.length} portfolio records into ${aggregatedRecordCount} aggregated records`);
                            
                            // Upload aggregated history (will merge with existing data)
                            this.loadingMessage = 'Uploading aggregated history to Portfolio Analytics...';
                            const aggregateResult = await this.uploadAggregatedHistoryToConfluence(aggregatedData);
                            aggregatedHistoryUploadSuccess = aggregateResult.success;
                            aggregatedRecordCount = aggregateResult.recordCount;
                            
                            if (aggregatedHistoryUploadSuccess) {
                                this.showNotification(`Aggregated history updated (${aggregatedRecordCount} total records)`, 'success');
                            } else {
                                this.showNotification('Aggregated history created - use Download button to save file', 'warning');
                            }
                        }

                        // Store processed data for manual download
                        this.processedDataCache = {
                            portfolio: allPortfolioData.length > 0 ? allPortfolioData : null,
                            covenants: allCovenantsData.length > 0 ? allCovenantsData : null,
                            ccm: allCCMData.length > 0 ? allCCMData : null,
                            rotce: allROTCEData.length > 0 ? allROTCEData : null,
                            aggregatedHistory: null  // Will be populated by uploadAggregatedHistoryToConfluence
                        };
                        
                        // Store only metadata (not full data) to avoid localStorage quota issues
                        try {
                            localStorage.setItem('portfolioLoaderData', JSON.stringify({
                                timestamp: new Date().toISOString(),
                                ccmReportDate: this.ccmReportDate,
                                files: {
                                    portfolio: Object.keys(this.files.portfolio).filter(k => this.files.portfolio[k]),
                                    covenants: Object.keys(this.files.covenants).filter(k => this.files.covenants[k]),
                                    ccm: Object.keys(this.files.ccm).filter(k => this.files.ccm[k]),
                                    rotce: this.files.rotce.global ? true : false,
                                    mapping: this.files.mapping ? true : false
                                },
                                recordCounts: {
                                    portfolio: allPortfolioData.length,
                                    covenants: allCovenantsData.length,
                                    ccm: allCCMData.length,
                                    rotce: allROTCEData ? allROTCEData.length : 0
                                }
                            }));
                        } catch (storageError) {
                            console.warn('localStorage quota exceeded, skipping local storage:', storageError);
                        }

                        this.isLoading = false;
                        
                        // Show success message
                        const totalRecords = allCCMData.length + allCovenantsData.length + allPortfolioData.length;
                        
                        this.showNotification(`Processing complete! ${totalRecords} total records processed.`, 'success');
                        
                        // Set flag to show success state
                        this.processingComplete = true;
                        this.processingResult = {
                            success: true,
                            portfolioRecords: allPortfolioData.length,
                            covenantsRecords: allCovenantsData.length,
                            ccmRecords: allCCMData.length,
                            rotceRecords: allROTCEData.length,
                            aggregatedRecords: aggregatedRecordCount,
                            portfolioUploaded: portfolioUploadSuccess,
                            covenantsUploaded: covenantsUploadSuccess,
                            ccmUploaded: ccmUploadSuccess,
                            rotceUploaded: rotceUploadSuccess,
                            aggregatedHistoryUploaded: aggregatedHistoryUploadSuccess
                        };

                    } catch (error) {
                        this.isLoading = false;
                        this.processingComplete = true;
                        this.processingResult = { success: false, error: error.message };
                        this.showNotification('Error processing files: ' + error.message, 'error');
                        console.error('Processing error:', error);
                    }
                },

                // Upload consolidated CCM data to Confluence as CCM_tw.xlsx
                async uploadCCMToConfluence(ccmData) {
                    try {
                        // Optimize and convert data to Excel workbook
                        const optimizedData = this.optimizeDataForExcel(ccmData);
                        const workbook = XLSX.utils.book_new();
                        const worksheet = XLSX.utils.json_to_sheet(optimizedData);
                        
                        // Set column widths for better readability
                        worksheet['!cols'] = [
                            { wch: 12 },  // Report_Date
                            { wch: 8 },   // Region
                            { wch: 15 },  // Relationship_ID
                            { wch: 30 },  // Client_Name
                            { wch: 15 },  // Classification
                            { wch: 12 },  // Frequency
                            { wch: 20 },  // Underwriter
                            { wch: 18 },  // Next_CCM_Month_End
                            { wch: 20 },  // Next_CCM_Approval_Date
                            { wch: 12 }   // CCM_Status
                        ];
                        
                        XLSX.utils.book_append_sheet(workbook, worksheet, 'CCM Data');
                        
                        // Convert to binary with maximum compression
                        const excelBuffer = XLSX.write(workbook, { 
                            bookType: 'xlsx', 
                            type: 'array',
                            compression: true,
                            bookSST: false  // Disable shared string table for smaller size
                        });
                        const blob = new Blob([excelBuffer], { 
                            type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                        });
                        
                        // First check if attachment already exists
                        const attachmentsUrl = `${this.confluenceConfig.baseUrl}/rest/api/content/${this.confluenceConfig.pageId}/child/attachment?filename=${encodeURIComponent(this.confluenceConfig.ccmFileName)}`;
                        
                        const attachmentsResponse = await fetch(attachmentsUrl, {
                            headers: {
                                'X-Atlassian-Token': 'no-check'
                            }
                        });
                        
                        const attachmentsData = await attachmentsResponse.json();
                        
                        // Get attachment ID if exists
                        let attachmentId = null;
                        if (attachmentsData.results && attachmentsData.results.length > 0) {
                            attachmentId = attachmentsData.results[0].id;
                        }
                        
                        // Create FormData for upload
                        const formData = new FormData();
                        formData.append('file', blob, this.confluenceConfig.ccmFileName);
                        
                        // Build URL - use /data endpoint for updating existing file
                        const uploadUrl = attachmentId 
                            ? `${this.confluenceConfig.baseUrl}/rest/api/content/${this.confluenceConfig.pageId}/child/attachment/${attachmentId}/data`
                            : `${this.confluenceConfig.baseUrl}/rest/api/content/${this.confluenceConfig.pageId}/child/attachment`;
                        
                        console.log('Uploading CCM_tw.xlsx to Confluence:', uploadUrl);
                        console.log('Attachment ID:', attachmentId || 'New file');
                        
                        const response = await fetch(uploadUrl, {
                            method: 'POST',
                            headers: {
                                'X-Atlassian-Token': 'no-check'
                            },
                            body: formData
                        });
                        
                        if (response.ok) {
                            console.log('Successfully uploaded CCM_tw.xlsx to Confluence');
                            return true;
                        } else {
                            const errorText = await response.text();
                            if (response.status === 413) {
                                console.warn('CCM file too large for Confluence upload (413). Use manual download instead.');
                            } else {
                                console.error('Confluence upload failed:', response.status, errorText);
                            }
                            return false;
                        }
                    } catch (error) {
                        console.error('Error uploading to Confluence:', error);
                        // Don't fail the whole process, just log the error
                        return false;
                    }
                },

                // Download consolidated CCM as Excel file locally (fallback)
                downloadCCMLocally(ccmData) {
                    const workbook = XLSX.utils.book_new();
                    const worksheet = XLSX.utils.json_to_sheet(ccmData);
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'CCM Data');
                    
                    // Generate filename with date
                    const dateStr = this.ccmReportDate.replace(/-/g, '');
                    const filename = `CCM_tw_${dateStr}.xlsx`;
                    
                    XLSX.writeFile(workbook, filename);
                    this.showNotification(`Downloaded ${filename}`, 'success');
                },

                // ==================== ROTCE ETL FUNCTIONS ====================
                
                // Process ROTCE file
                async processROTCEFile(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const data = new Uint8Array(e.target.result);
                                const workbook = XLSX.read(data, { type: 'array' });
                                
                                // Read from first sheet
                                const sheetName = workbook.SheetNames[0];
                                const sheet = workbook.Sheets[sheetName];
                                const rawData = XLSX.utils.sheet_to_json(sheet);
                                
                                // Map ROTCE columns
                                const processedData = rawData.map(row => ({
                                    Client_Relationship_ID: String(row['Client Relationship ID'] || row['Client_Relationship_ID'] || row['ClientRelationshipID'] || '').trim(),
                                    Period: row['Period'] || '',
                                    Variable_Net_Income: this.parseNumeric(row['Variable Net Income'] || row['Variable_Net_Income'] || 0),
                                    Total_TCE: this.parseNumeric(row['Total TCE'] || row['Total_TCE'] || 0),
                                    Variable_RoTCE: this.parseROTCEPercentage(row['Variable RoTCE'] || row['Variable_RoTCE'] || row['VariableRoTCE'] || 0),
                                    Total_RWA_EOP: this.parseNumeric(row['Total_RWA_EOP'] || row['Total RWA EOP'] || 0)
                                })).filter(row => row.Client_Relationship_ID); // Filter out rows without Client Relationship ID
                                
                                console.log(`ROTCE: Processed ${processedData.length} records`);
                                resolve(processedData);
                            } catch (error) {
                                console.error('Error processing ROTCE file:', error);
                                reject(error);
                            }
                        };
                        reader.onerror = reject;
                        reader.readAsArrayBuffer(file);
                    });
                },
                
                // Parse ROTCE percentage value
                parseROTCEPercentage(value) {
                    if (value === null || value === undefined || value === '') return '0%';
                    
                    // If already a string with %
                    if (typeof value === 'string' && value.includes('%')) {
                        return value.trim();
                    }
                    
                    // If it's a decimal (e.g., 0.15 = 15%)
                    const num = parseFloat(String(value).replace(/[%,]/g, ''));
                    if (isNaN(num)) return '0%';
                    
                    // Check if the value seems to be already a percentage (e.g., 15 vs 0.15)
                    if (Math.abs(num) < 1) {
                        // It's a decimal, convert to percentage
                        return (num * 100).toFixed(2) + '%';
                    } else {
                        // It's already a percentage number
                        return num.toFixed(2) + '%';
                    }
                },
                
                // Upload ROTCE to Confluence
                async uploadROTCEToConfluence(rotceData) {
                    try {
                        const optimizedData = this.optimizeDataForExcel(rotceData);
                        const workbook = XLSX.utils.book_new();
                        const worksheet = XLSX.utils.json_to_sheet(optimizedData);
                        
                        // Set column widths
                        worksheet['!cols'] = [
                            { wch: 25 },  // Client_Relationship_ID
                            { wch: 12 },  // Period
                            { wch: 20 },  // Variable_Net_Income
                            { wch: 15 },  // Total_TCE
                            { wch: 15 },  // Variable_RoTCE
                            { wch: 15 }   // Total_RWA_EOP
                        ];
                        
                        XLSX.utils.book_append_sheet(workbook, worksheet, 'ROTCE Data');
                        
                        const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array', compression: true, bookSST: false });
                        const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                        
                        // Check if attachment exists
                        const attachmentsResponse = await fetch(
                            `${this.confluenceConfig.baseUrl}/rest/api/content/${this.confluenceConfig.pageId}/child/attachment?filename=${this.confluenceConfig.rotceFileName}`
                        );
                        const attachmentsData = await attachmentsResponse.json();
                        
                        const formData = new FormData();
                        formData.append('file', blob, this.confluenceConfig.rotceFileName);
                        
                        let uploadUrl;
                        if (attachmentsData.results && attachmentsData.results.length > 0) {
                            const attachmentId = attachmentsData.results[0].id;
                            uploadUrl = `${this.confluenceConfig.baseUrl}/rest/api/content/${this.confluenceConfig.pageId}/child/attachment/${attachmentId}/data`;
                        } else {
                            uploadUrl = `${this.confluenceConfig.baseUrl}/rest/api/content/${this.confluenceConfig.pageId}/child/attachment`;
                        }
                        
                        const response = await fetch(uploadUrl, {
                            method: 'POST',
                            headers: { 'X-Atlassian-Token': 'no-check' },
                            body: formData
                        });
                        
                        if (response.status === 413) {
                            console.warn('ROTCE file too large for Confluence upload (413 error)');
                            return false;
                        }
                        
                        if (!response.ok) {
                            throw new Error(`Failed to upload ROTCE: ${response.status}`);
                        }
                        
                        console.log('ROTCE_tw.xlsx uploaded successfully');
                        return true;
                    } catch (error) {
                        console.error('Error uploading ROTCE to Confluence:', error);
                        return false;
                    }
                },
                
                // Fetch ROTCE data from Confluence
                async fetchROTCEFromConfluence() {
                    try {
                        const attachmentsResponse = await fetch(
                            `${this.confluenceConfig.baseUrl}/rest/api/content/${this.confluenceConfig.pageId}/child/attachment?filename=${this.confluenceConfig.rotceFileName}`
                        );
                        const attachmentsData = await attachmentsResponse.json();
                        
                        if (!attachmentsData.results || attachmentsData.results.length === 0) {
                            console.log('ROTCE_tw.xlsx not found in Confluence - ROTCE mapping will be skipped');
                            return null;
                        }
                        
                        const downloadUrl = `${this.confluenceConfig.baseUrl}${attachmentsData.results[0]._links.download}`;
                        const fileResponse = await fetch(downloadUrl);
                        const fileBuffer = await fileResponse.arrayBuffer();
                        
                        const workbook = XLSX.read(new Uint8Array(fileBuffer), { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const sheet = workbook.Sheets[sheetName];
                        const rawData = XLSX.utils.sheet_to_json(sheet);
                        
                        // Build a map of Client_Relationship_ID to Variable_RoTCE
                        const rotceMap = rawData.map(row => ({
                            clientRelationshipId: String(row['Client_Relationship_ID'] || row['Client Relationship ID'] || '').trim(),
                            variableRoTCE: row['Variable_RoTCE'] || row['Variable RoTCE'] || '0%'
                        })).filter(r => r.clientRelationshipId);
                        
                        console.log(`ROTCE: Fetched ${rotceMap.length} records from Confluence`);
                        return rotceMap;
                    } catch (error) {
                        console.error('Error fetching ROTCE from Confluence:', error);
                        return null;
                    }
                },
                
                // Map ROTCE to Portfolio data
                mapROTCEToPortfolio(portfolioData, rotceData) {
                    if (!rotceData || rotceData.length === 0) {
                        // Set all ROTCE to 0% if no ROTCE data
                        return portfolioData.map(row => ({
                            ...row,
                            ROTCE: '0%'
                        }));
                    }
                    
                    // Create a lookup map for faster access
                    const rotceLookup = new Map();
                    rotceData.forEach(r => {
                        if (r.clientRelationshipId) {
                            rotceLookup.set(r.clientRelationshipId.toLowerCase(), r.variableRoTCE);
                        }
                    });
                    
                    let matchCount = 0;
                    const mappedData = portfolioData.map(row => {
                        const relationshipId = String(row.Relationship_ID || '').trim().toLowerCase();
                        let rotceValue = '0%';
                        
                        if (relationshipId && rotceLookup.has(relationshipId)) {
                            rotceValue = rotceLookup.get(relationshipId);
                            matchCount++;
                        }
                        
                        return {
                            ...row,
                            ROTCE: rotceValue
                        };
                    });
                    
                    console.log(`ROTCE Mapping: ${matchCount}/${portfolioData.length} records matched`);
                    return mappedData;
                },

                // ==================== COVENANTS ETL FUNCTIONS ====================
                
                // Upload consolidated Covenants data to Confluence as Covenants_tw.xlsx
                async uploadCovenantsToConfluence(covenantsData) {
                    try {
                        // Optimize and convert data to Excel workbook
                        const optimizedData = this.optimizeDataForExcel(covenantsData);
                        const workbook = XLSX.utils.book_new();
                        const worksheet = XLSX.utils.json_to_sheet(optimizedData);
                        
                        // Set column widths for better readability
                        worksheet['!cols'] = [
                            { wch: 12 },  // Report_Date
                            { wch: 8 },   // Region
                            { wch: 18 },  // Origination_Unit
                            { wch: 22 },  // Underwriting_Team_Lead
                            { wch: 20 },  // Lead_Underwriter
                            { wch: 20 },  // Product_Underwriter
                            { wch: 15 },  // OU_Expense_Code
                            { wch: 15 },  // CU_Expense_Code
                            { wch: 15 },  // Relationship_ID
                            { wch: 25 },  // Relationship_Name
                            { wch: 25 },  // Borrowers_Name
                            { wch: 12 },  // CA_Number
                            { wch: 15 },  // Facility_Number
                            { wch: 25 },  // Product_Program_Name
                            { wch: 15 },  // Facility_Type
                            { wch: 15 },  // Covenant_Number
                            { wch: 18 },  // Periodic_Frequency
                            { wch: 15 },  // Covenant_Due_Date
                            { wch: 18 },  // Covenant_Deferred_Date
                            { wch: 12 },  // Days_Past_Due
                            { wch: 18 },  // Coming_Due_Past_Due
                            { wch: 18 },  // Past_Due_Category
                            { wch: 40 },  // Covenant_Description
                            { wch: 30 },  // Covenant_Remarks
                            { wch: 18 },  // 45_Days_Past_Due_Date
                            { wch: 15 }   // Control_Unit
                        ];
                        
                        XLSX.utils.book_append_sheet(workbook, worksheet, 'Covenants Data');
                        
                        // Convert to binary with maximum compression
                        const excelBuffer = XLSX.write(workbook, { 
                            bookType: 'xlsx', 
                            type: 'array',
                            compression: true,
                            bookSST: false  // Disable shared string table for smaller size
                        });
                        const blob = new Blob([excelBuffer], { 
                            type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                        });
                        
                        // First check if attachment already exists
                        const attachmentsUrl = `${this.confluenceConfig.baseUrl}/rest/api/content/${this.confluenceConfig.pageId}/child/attachment?filename=${encodeURIComponent(this.confluenceConfig.covenantsFileName)}`;
                        
                        const attachmentsResponse = await fetch(attachmentsUrl, {
                            headers: {
                                'X-Atlassian-Token': 'no-check'
                            }
                        });
                        
                        const attachmentsData = await attachmentsResponse.json();
                        
                        // Get attachment ID if exists
                        let attachmentId = null;
                        if (attachmentsData.results && attachmentsData.results.length > 0) {
                            attachmentId = attachmentsData.results[0].id;
                        }
                        
                        // Create FormData for upload
                        const formData = new FormData();
                        formData.append('file', blob, this.confluenceConfig.covenantsFileName);
                        
                        // Build URL - use /data endpoint for updating existing file
                        const uploadUrl = attachmentId 
                            ? `${this.confluenceConfig.baseUrl}/rest/api/content/${this.confluenceConfig.pageId}/child/attachment/${attachmentId}/data`
                            : `${this.confluenceConfig.baseUrl}/rest/api/content/${this.confluenceConfig.pageId}/child/attachment`;
                        
                        console.log('Uploading Covenants_tw.xlsx to Confluence:', uploadUrl);
                        console.log('Attachment ID:', attachmentId || 'New file');
                        
                        const response = await fetch(uploadUrl, {
                            method: 'POST',
                            headers: {
                                'X-Atlassian-Token': 'no-check'
                            },
                            body: formData
                        });
                        
                        if (response.ok) {
                            console.log('Successfully uploaded Covenants_tw.xlsx to Confluence');
                            return true;
                        } else {
                            const errorText = await response.text();
                            if (response.status === 413) {
                                console.warn('Covenants file too large for Confluence upload (413). Use manual download instead.');
                            } else {
                                console.error('Confluence upload failed:', response.status, errorText);
                            }
                            return false;
                        }
                    } catch (error) {
                        console.error('Error uploading Covenants to Confluence:', error);
                        return false;
                    }
                },

                // Process Covenant file with ETL logic
                async processCovenantFile(file, region, regionsMapping = {}) {
                    const workbook = await this.readExcelWorkbook(file);
                    
                    // Always read from first sheet
                    const firstSheetName = workbook.SheetNames[0];
                    const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheetName]);
                    
                    console.log(`Covenants ${region.toUpperCase()} - First sheet: ${firstSheetName}, rows: ${rawData.length}`);

                    // Transform data to standard format
                    const transformedData = rawData
                        .filter(row => !this.isInternalCovenant(row, region)) // Filter out Internal* rows (NAM/LATAM only)
                        .filter(row => Object.keys(row).length > 0) // Filter empty rows
                        .map(row => this.mapCovenantRow(row, region, regionsMapping))
                        .filter(row => row !== null); // Filter out SARG entries (returns null)

                    return transformedData;
                },

                // Check if row is an internal covenant
                // Only applies to NAM and LATAM regions (EMEA and APAC keep all covenants)
                isInternalCovenant(row, region) {
                    const regionUpper = String(region).toUpperCase();
                    
                    // Only filter Internal covenants for NAM and LATAM
                    if (regionUpper !== 'NAM' && regionUpper !== 'LATAM') {
                        return false; // Don't filter for EMEA and APAC
                    }
                    
                    const description = row['Covenant Description'] || row['CovenantDescription'] || '';
                    const remarks = row['Covenant Remarks'] || row['CovenantRemarks'] || '';
                    
                    // For NAM/LATAM: Check if description or remarks starts with "Internal"
                    const descLower = String(description).trim().toLowerCase();
                    const remarksLower = String(remarks).trim().toLowerCase();
                    
                    return descLower.startsWith('internal') || remarksLower.startsWith('internal');
                },

                // Normalize Coming Due/Past Due values (remove underscores)
                normalizeComingDuePastDue(value) {
                    if (!value) return '';
                    const str = String(value).trim();
                    // Convert "Past_Due" to "Past Due" and "Coming_Due" to "Coming Due"
                    return str
                        .replace(/Past_Due/gi, 'Past Due')
                        .replace(/Coming_Due/gi, 'Coming Due');
                },

                // Normalize Past Due Category values (standardize format)
                normalizePastDueCategory(value) {
                    if (!value) return '';
                    const str = String(value).trim();
                    
                    // Normalize to standard format with hyphens
                    // "1 to 30 Days" -> "0-30 Days"
                    // "31 to 45 Days" -> "31-45 Days"
                    // etc.
                    
                    const normalized = str
                        .replace(/1\s+to\s+30\s+Days/gi, '0-30 Days')
                        .replace(/31\s+to\s+45\s+Days/gi, '31-45 Days')
                        .replace(/46\s+to\s+60\s+Days/gi, '46-60 Days')
                        .replace(/61\s+to\s+90\s+Days/gi, '61-90 Days')
                        .replace(/>90\s+Days/gi, '>90 Days')
                        // Also handle if they come with hyphens already but inconsistent spacing
                        .replace(/1-30\s+Days/gi, '0-30 Days')
                        .replace(/31-45\s+Days/gi, '31-45 Days')
                        .replace(/46-60\s+Days/gi, '46-60 Days')
                        .replace(/61-90\s+Days/gi, '61-90 Days');
                    
                    return normalized;
                },

                // Map Covenant row to standard output format
                mapCovenantRow(row, region, regionsMapping = {}) {
                    // Get Origination_Unit and Control_Unit from source data
                    const originationUnit = row['Originating Unit'] || row['OriginatingUnit'] || '';
                    const controlUnit = row['Control Unit'] || row['ControlUnit'] || '';
                    
                    // Check if this is a SARG entry (should be excluded)
                    const originationUnitUpper = String(originationUnit).trim().toUpperCase();
                    if (originationUnitUpper === 'SARG') {
                        return null; // Will be filtered out
                    }
                    
                    // Lookup region based on Control_Unit from Regions_Mapping.xlsx
                    // Only applies to NAM and LATAM regions (uses Control_Unit, not Origination_Unit)
                    const mappedRegion = this.lookupRegionByControlUnit(controlUnit, region, regionsMapping);
                    
                    return {
                        Report_Date: this.formatDate(row['As Of Date'] || row['AsOfDate'] || ''),
                        Region: mappedRegion,
                        Origination_Unit: originationUnit,
                        Underwriting_Team_Lead: this.normalizeUnderwriterName(row['Investment Finance Underwriting Team Lead'] || row['InvestmentFinanceUnderwritingTeamLead']),
                        Lead_Underwriter: this.normalizeUnderwriterName(row['Investment Finance Lead Underwriter'] || row['InvestmentFinanceLeadUnderwriter']),
                        Product_Underwriter: this.normalizeUnderwriterName(row['Investment Finance Product Underwriter'] || row['InvestmentFinanceProductUnderwriter']),
                        OU_Expense_Code: row['OU Expense Code'] || row['OUExpenseCode'] || '',
                        CU_Expense_Code: row['CU Expense Code'] || row['CUExpenseCode'] || '',
                        Relationship_ID: row['Relationship ID'] || row['RelationshipID'] || '',
                        Relationship_Name: row['Relationship Name'] || row['RelationshipName'] || '',
                        Borrowers_Name: row['Borrowers Name'] || row['BorrowersName'] || '',
                        CA_Number: row['CA Number'] || row['CANumber'] || '',
                        Facility_Number: row['Facility Number'] || row['FacilityNumber'] || '',
                        Product_Program_Name: row['Product Program Name'] || row['ProductProgramName'] || '',
                        Facility_Type: row['Facility Type'] || row['FacilityType'] || '',
                        Covenant_Number: row['Covenant Number'] || row['CovenantNumber'] || '',
                        Periodic_Frequency: row['Periodicity / Frequency'] || row['Periodicity/Frequency'] || row['PeriodicityFrequency'] || '',
                        Covenant_Due_Date: this.formatDate(row['Covenant Due Date'] || row['CovenantDueDate'] || ''),
                        Covenant_Deferred_Date: this.formatDate(row['Covenant Deferred Date'] || row['CovenantDeferredDate'] || ''),
                        Days_Past_Due: row['No of Days Past Due'] || row['NoofDaysPastDue'] || row['DaysPastDue'] || '',
                        Coming_Due_Past_Due: this.normalizeComingDuePastDue(row['Coming Due / Past Due'] || row['ComingDue/PastDue'] || row['ComingDuePastDue'] || ''),
                        Past_Due_Category: this.normalizePastDueCategory(row['Past Due Category'] || row['PastDueCategory'] || ''),
                        Covenant_Description: row['Covenant Description'] || row['CovenantDescription'] || '',
                        Covenant_Remarks: row['Covenant Remarks'] || row['CovenantRemarks'] || '',
                        '45_Days_Past_Due_Date': this.formatDate(row['45 Days Past Due Date'] || row['45DaysPastDueDate'] || ''),
                        Control_Unit: controlUnit
                    };
                },

                // ==================== END COVENANTS ETL FUNCTIONS ====================

                // ==================== PORTFOLIO ETL FUNCTIONS ====================

                // Fetch Product_Mapping.xlsx from Confluence attachments
                async fetchMappingFromConfluence() {
                    try {
                        const attachmentUrl = `${this.confluenceConfig.baseUrl}/rest/api/content/${this.confluenceConfig.pageId}/child/attachment?filename=${encodeURIComponent(this.confluenceConfig.mappingFileName)}`;
                        
                        const response = await fetch(attachmentUrl, {
                            headers: { 'X-Atlassian-Token': 'no-check' }
                        });
                        
                        if (!response.ok) {
                            console.log('Product_Mapping.xlsx not found in attachments');
                            return null;
                        }
                        
                        const data = await response.json();
                        
                        if (!data.results || data.results.length === 0) {
                            console.log('Product_Mapping.xlsx not found in attachments');
                            return null;
                        }
                        
                        // Get the download URL for the attachment
                        const downloadUrl = `${this.confluenceConfig.baseUrl}${data.results[0]._links.download}`;
                        
                        // Fetch the actual file
                        const fileResponse = await fetch(downloadUrl, {
                            headers: { 'X-Atlassian-Token': 'no-check' }
                        });
                        
                        if (!fileResponse.ok) {
                            console.log('Failed to download Product_Mapping.xlsx');
                            return null;
                        }
                        
                        const arrayBuffer = await fileResponse.arrayBuffer();
                        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                        
                        console.log('Product_Mapping.xlsx loaded from Confluence');
                        return workbook;
                    } catch (error) {
                        console.log('Product_Mapping.xlsx not available:', error.message);
                        return null;
                    }
                },

                // Fetch Regions_Mapping.xlsx from Confluence attachments
                async fetchRegionsMappingFromConfluence() {
                    try {
                        const attachmentUrl = `${this.confluenceConfig.baseUrl}/rest/api/content/${this.confluenceConfig.pageId}/child/attachment?filename=${encodeURIComponent(this.confluenceConfig.regionsMappingFileName)}`;
                        
                        const response = await fetch(attachmentUrl, {
                            headers: { 'X-Atlassian-Token': 'no-check' }
                        });
                        
                        if (!response.ok) {
                            console.log('Regions_Mapping.xlsx not found in attachments');
                            return {};
                        }
                        
                        const data = await response.json();
                        
                        if (!data.results || data.results.length === 0) {
                            console.log('Regions_Mapping.xlsx not found in attachments');
                            return {};
                        }
                        
                        const downloadUrl = `${this.confluenceConfig.baseUrl}${data.results[0]._links.download}`;
                        
                        const fileResponse = await fetch(downloadUrl, {
                            headers: { 'X-Atlassian-Token': 'no-check' }
                        });
                        
                        if (!fileResponse.ok) {
                            console.log('Failed to download Regions_Mapping.xlsx');
                            return {};
                        }
                        
                        const arrayBuffer = await fileResponse.arrayBuffer();
                        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                        
                        // Get first sheet data
                        const sheetName = workbook.SheetNames[0];
                        const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                        
                        // Build Control Unit to Region mapping
                        const regionsMapping = {};
                        sheetData.forEach(row => {
                            const controlUnit = String(row['Control Unit'] || row['Control_Unit'] || row['ControlUnit'] || '').trim();
                            const region = String(row['Region'] || row['region'] || row['REGION'] || '').trim();
                            if (controlUnit && region) {
                                regionsMapping[controlUnit.toUpperCase()] = region;
                            }
                        });
                        
                        console.log('Regions_Mapping.xlsx loaded from Confluence');
                        return regionsMapping;
                    } catch (error) {
                        console.log('Regions_Mapping.xlsx not available:', error.message);
                        return {};
                    }
                },

                // Lookup region for NAM based on Control Unit
                lookupNAMRegion(controlUnit, regionsMapping) {
                    if (!regionsMapping || !controlUnit) {
                        return 'NAM';
                    }
                    
                    const controlUnitStr = String(controlUnit).trim().toUpperCase();
                    const mappedRegion = regionsMapping[controlUnitStr];
                    
                    if (mappedRegion) {
                        // If region is IPB, treat as NAM
                        if (mappedRegion.toUpperCase() === 'IPB') {
                            return 'NAM';
                        }
                        return mappedRegion;
                    }
                    
                    return 'NAM';
                },

                // Lookup region based on Control_Unit for Covenants data
                // Only applies mapping for NAM and LATAM regions
                lookupRegionByControlUnit(controlUnit, defaultRegion, regionsMapping) {
                    const defaultRegionUpper = defaultRegion.toUpperCase();
                    
                    // Only apply Control_Unit mapping for NAM and LATAM
                    // EMEA and APAC should just use their file region
                    if (defaultRegionUpper !== 'NAM' && defaultRegionUpper !== 'LATAM') {
                        return defaultRegionUpper;
                    }
                    
                    // If no regionsMapping or no controlUnit, use default region
                    if (!regionsMapping || !controlUnit) {
                        return defaultRegionUpper;
                    }
                    
                    // Normalize the control unit for lookup
                    const controlUnitStr = String(controlUnit).trim().toUpperCase();
                    const mappedRegion = regionsMapping[controlUnitStr];
                    
                    if (mappedRegion) {
                        const mappedRegionUpper = mappedRegion.toUpperCase();
                        // If region is IPB, treat as NAM
                        if (mappedRegionUpper === 'IPB') {
                            return 'NAM';
                        }
                        return mappedRegionUpper;
                    }
                    
                    // If no mapping found, use default region from file
                    return defaultRegionUpper;
                },

                // Load PSE mapping data from workbook
                async loadPSEMappingData(mappingFileOrWorkbook) {
                    try {
                        let workbook;
                        
                        // Check if it's already a workbook object or a File
                        if (mappingFileOrWorkbook && mappingFileOrWorkbook.SheetNames) {
                            workbook = mappingFileOrWorkbook;
                        } else if (mappingFileOrWorkbook) {
                            workbook = await this.readExcelWorkbook(mappingFileOrWorkbook);
                        } else {
                            return { facilityTypes: [], productPrograms: [], categoryMapping: [] };
                        }
                        
                        // Load PSE tab
                        const pseSheet = workbook.SheetNames.find(name => 
                            name.toLowerCase() === 'pse' || name.toLowerCase().includes('pse')
                        );
                        
                        let pseFacilityTypes = [];
                        let pseProductPrograms = [];
                        
                        if (pseSheet) {
                            const pseData = XLSX.utils.sheet_to_json(workbook.Sheets[pseSheet]);
                            
                            pseFacilityTypes = [...new Set(pseData
                                .map(row => {
                                    const val = row['Facility_Type'] || row['Facility Type'] || row['FacilityType'] || 
                                               row['facility_type'] || row['FACILITY_TYPE'] || '';
                                    return String(val).trim();
                                })
                                .filter(v => v)
                            )];
                            
                            pseProductPrograms = [...new Set(pseData
                                .map(row => {
                                    const val = row['Product_Program'] || row['Product Program'] || row['ProductProgram'] ||
                                               row['product_program'] || row['PRODUCT_PROGRAM'] || '';
                                    return String(val).trim();
                                })
                                .filter(v => v)
                            )];
                        }
                        
                        // Load Category tab
                        const categorySheet = workbook.SheetNames.find(name => 
                            name.toLowerCase() === 'category' || name.toLowerCase().includes('category')
                        );
                        
                        let categoryMapping = [];
                        
                        if (categorySheet) {
                            const categoryData = XLSX.utils.sheet_to_json(workbook.Sheets[categorySheet]);
                            
                            categoryMapping = categoryData.map(row => {
                                const region = String(row['Region'] || row['region'] || row['REGION'] || '').trim().toUpperCase();
                                const primaryKey = String(
                                    row['Primary_Key'] || row['PrimaryKey'] || row['Primary Key'] || 
                                    row['primary_key'] || row['PRIMARY_KEY'] || row['Key'] || ''
                                ).trim();
                                const category = String(row['Category'] || row['category'] || row['CATEGORY'] || '').trim();
                                const subCategory = String(
                                    row['Sub_Category'] || row['SubCategory'] || row['Sub Category'] || 
                                    row['sub_category'] || row['SUB_CATEGORY'] || row['Subcategory'] || ''
                                ).trim();
                                
                                return { region, primaryKey, category, subCategory };
                            }).filter(row => row.primaryKey);
                        }
                        
                        const hasData = pseFacilityTypes.length > 0 || pseProductPrograms.length > 0 || categoryMapping.length > 0;
                        console.log(hasData ? 'Product_Mapping.xlsx loaded successfully' : 'Product_Mapping.xlsx has no mapping data');
                        
                        return { 
                            facilityTypes: pseFacilityTypes, 
                            productPrograms: pseProductPrograms,
                            categoryMapping: categoryMapping
                        };
                    } catch (error) {
                        console.log('Error loading Product_Mapping.xlsx:', error.message);
                        return { facilityTypes: [], productPrograms: [], categoryMapping: [] };
                    }
                },
                
                // Lookup Product_Program and Product_Sub_Program from Category mapping
                lookupCategoryMapping(primaryKeyValue, region, mappingData) {
                    if (!mappingData || !mappingData.categoryMapping || !primaryKeyValue) {
                        return { productProgram: '', productSubProgram: '' };
                    }
                    
                    const keyStr = String(primaryKeyValue).trim();
                    const keyStrLower = keyStr.toLowerCase();
                    const regionStr = region.toUpperCase();
                    
                    // First try to find exact match with region
                    let match = mappingData.categoryMapping.find(m => 
                        m.primaryKey.toLowerCase() === keyStrLower && 
                        (m.region === regionStr || m.region === '' || !m.region)
                    );
                    
                    // If no match with region, try without region filter
                    if (!match) {
                        match = mappingData.categoryMapping.find(m => 
                            m.primaryKey.toLowerCase() === keyStrLower
                        );
                    }
                    
                    // Try partial match if exact match not found
                    if (!match) {
                        match = mappingData.categoryMapping.find(m => 
                            m.primaryKey.toLowerCase().includes(keyStrLower) || 
                            keyStrLower.includes(m.primaryKey.toLowerCase())
                        );
                    }
                    
                    if (match) {
                        return {
                            productProgram: match.category || '',
                            productSubProgram: match.subCategory || ''
                        };
                    }
                    
                    return { productProgram: '', productSubProgram: '' };
                },

                // Determine PSE or non-PSE based on mapping data
                determinePSE(facilityType, productProgram, region, pseMappingData) {
                    if (!pseMappingData) {
                        return 'non-PSE';
                    }
                    
                    const facilityTypeStr = String(facilityType || '').trim();
                    const productProgramStr = String(productProgram || '').trim();
                    
                    // For NAM: check both Product Program and Facility Type
                    if (region === 'nam') {
                        if (productProgramStr && pseMappingData.productPrograms && pseMappingData.productPrograms.some(p => 
                            p.toLowerCase() === productProgramStr.toLowerCase()
                        )) {
                            return 'PSE';
                        }
                    }
                    
                    // For all regions: check Facility Type
                    if (facilityTypeStr && pseMappingData.facilityTypes && pseMappingData.facilityTypes.some(f => 
                        f.toLowerCase() === facilityTypeStr.toLowerCase()
                    )) {
                        return 'PSE';
                    }
                    
                    return 'non-PSE';
                },

                // Aggregate Portfolio data for historical tracking
                // Creates weekly aggregated metrics by Report_Date, Region, Product_Program, Product_Sub_Program
                aggregatePortfolioData(portfolioData) {
                    const aggregationMap = new Map();
                    let excludedCount = 0;
                    let includedCount = 0;
                    
                    // Track totals before aggregation for validation
                    const totalsBefore = {
                        TFA: 0,
                        OSUC: 0,
                        Total_OS: 0,
                        Direct_OS: 0,
                        Contingent_OS: 0,
                        PSE_OS: 0,
                        Total_Unused_Exposure: 0,
                        Total_Undrawn: 0
                    };
                    
                    portfolioData.forEach(row => {
                        // CRITICAL FIX: Validate that essential fields are present
                        // Skip rows with missing Report_Date or Region (these are required for meaningful aggregation)
                        const reportDate = String(row.Report_Date || '').trim();
                        const region = String(row.Region || '').trim();
                        
                        if (!reportDate || !region) {
                            excludedCount++;
                            console.warn('Excluding row from aggregation - missing Report_Date or Region:', {
                                Report_Date: reportDate || '(empty)',
                                Region: region || '(empty)',
                                Facility_ID: row.Facility_ID || '(empty)'
                            });
                            return; // Skip this row
                        }
                        
                        // Add to totals before aggregation (for validation)
                        totalsBefore.TFA += this.parseNumeric(row.Fac_Amount);
                        totalsBefore.OSUC += this.parseNumeric(row.OSUC);
                        totalsBefore.Total_OS += this.parseNumeric(row.Total_OS);
                        totalsBefore.Direct_OS += this.parseNumeric(row.Direct_OS);
                        totalsBefore.Contingent_OS += this.parseNumeric(row.Contingent_OS);
                        totalsBefore.PSE_OS += this.parseNumeric(row.PSE_OS);
                        totalsBefore.Total_Unused_Exposure += this.parseNumeric(row.Total_Unused_Exposure);
                        totalsBefore.Total_Undrawn += this.parseNumeric(row.Total_Undrawn);
                        
                        includedCount++;
                        
                        // Create aggregation key - use trimmed values and handle empty strings consistently
                        const key = [
                            reportDate,
                            region,
                            String(row.Product_Program || '').trim(),
                            String(row.Product_Sub_Program || '').trim(),
                            String(row.Committed_Uncommitted || '').trim(),
                            String(row.PSE_non_PSE || '').trim()
                        ].join('|');
                        
                        if (!aggregationMap.has(key)) {
                            aggregationMap.set(key, {
                                Report_Date: reportDate,
                                Region: region,
                                Product_Program: String(row.Product_Program || '').trim(),
                                Product_Sub_Program: String(row.Product_Sub_Program || '').trim(),
                                Committed_Uncommitted: String(row.Committed_Uncommitted || '').trim(),
                                PSE_non_PSE: String(row.PSE_non_PSE || '').trim(),
                                TFA: 0,
                                OSUC: 0,
                                Total_OS: 0,
                                Direct_OS: 0,
                                Contingent_OS: 0,
                                PSE_OS: 0,
                                Total_Unused_Exposure: 0,
                                Total_Undrawn: 0,
                                Count_of_Facilities: new Set(),
                                Count_of_Relationships: new Set(),
                                Count_of_CAs: new Set()
                            });
                        }
                        
                        const agg = aggregationMap.get(key);
                        
                        // Sum financial metrics - ensure parseNumeric is called for all values
                        agg.TFA += this.parseNumeric(row.Fac_Amount);
                        agg.OSUC += this.parseNumeric(row.OSUC);
                        agg.Total_OS += this.parseNumeric(row.Total_OS);
                        agg.Direct_OS += this.parseNumeric(row.Direct_OS);
                        agg.Contingent_OS += this.parseNumeric(row.Contingent_OS);
                        agg.PSE_OS += this.parseNumeric(row.PSE_OS);
                        agg.Total_Unused_Exposure += this.parseNumeric(row.Total_Unused_Exposure);
                        agg.Total_Undrawn += this.parseNumeric(row.Total_Undrawn);
                        
                        // Count distinct values
                        if (row.Facility_ID) agg.Count_of_Facilities.add(row.Facility_ID);
                        if (row.Relationship_ID) agg.Count_of_Relationships.add(row.Relationship_ID);
                        if (row.CAID) agg.Count_of_CAs.add(row.CAID);
                    });
                    
                    // Log aggregation statistics
                    console.log(`Aggregation Summary:
                        - Total input rows: ${portfolioData.length}
                        - Included in aggregation: ${includedCount}
                        - Excluded (missing Report_Date/Region): ${excludedCount}
                        - Unique aggregation groups: ${aggregationMap.size}
                    `);
                    
                    // Convert Sets to counts and format output
                    const aggregatedData = Array.from(aggregationMap.values()).map(agg => ({
                        Report_Date: agg.Report_Date,
                        Region: agg.Region,
                        Product_Program: agg.Product_Program,
                        Product_Sub_Program: agg.Product_Sub_Program,
                        Committed_Uncommitted: agg.Committed_Uncommitted,
                        PSE_non_PSE: agg.PSE_non_PSE,
                        TFA: Math.round(agg.TFA * 100) / 100,
                        OSUC: Math.round(agg.OSUC * 100) / 100,
                        Total_OS: Math.round(agg.Total_OS * 100) / 100,
                        Direct_OS: Math.round(agg.Direct_OS * 100) / 100,
                        Contingent_OS: Math.round(agg.Contingent_OS * 100) / 100,
                        PSE_OS: Math.round(agg.PSE_OS * 100) / 100,
                        Total_Unused_Exposure: Math.round(agg.Total_Unused_Exposure * 100) / 100,
                        Total_Undrawn: Math.round(agg.Total_Undrawn * 100) / 100,
                        Count_of_Facilities: agg.Count_of_Facilities.size,
                        Count_of_Relationships: agg.Count_of_Relationships.size,
                        Count_of_CAs: agg.Count_of_CAs.size
                    }));
                    
                    // Validate totals after aggregation
                    const totalsAfter = {
                        TFA: 0,
                        OSUC: 0,
                        Total_OS: 0,
                        Direct_OS: 0,
                        Contingent_OS: 0,
                        PSE_OS: 0,
                        Total_Unused_Exposure: 0,
                        Total_Undrawn: 0
                    };
                    
                    aggregatedData.forEach(row => {
                        totalsAfter.TFA += row.TFA;
                        totalsAfter.OSUC += row.OSUC;
                        totalsAfter.Total_OS += row.Total_OS;
                        totalsAfter.Direct_OS += row.Direct_OS;
                        totalsAfter.Contingent_OS += row.Contingent_OS;
                        totalsAfter.PSE_OS += row.PSE_OS;
                        totalsAfter.Total_Unused_Exposure += row.Total_Unused_Exposure;
                        totalsAfter.Total_Undrawn += row.Total_Undrawn;
                    });
                    
                    // Log validation results (differences should be minimal due to rounding)
                    console.log('Aggregation Validation:');
                    console.log('  Before Aggregation -> After Aggregation:');
                    Object.keys(totalsBefore).forEach(key => {
                        const before = Math.round(totalsBefore[key] * 100) / 100;
                        const after = Math.round(totalsAfter[key] * 100) / 100;
                        const diff = Math.round((after - before) * 100) / 100;
                        const status = Math.abs(diff) < 0.01 ? '' : '';
                        console.log(`  ${status} ${key}: ${before.toLocaleString()} -> ${after.toLocaleString()} (diff: ${diff})`);
                    });
                    
                    // Sort by Report_Date, Region, Product_Program
                    aggregatedData.sort((a, b) => {
                        if (a.Report_Date !== b.Report_Date) return a.Report_Date.localeCompare(b.Report_Date);
                        if (a.Region !== b.Region) return a.Region.localeCompare(b.Region);
                        if (a.Product_Program !== b.Product_Program) return a.Product_Program.localeCompare(b.Product_Program);
                        return a.Product_Sub_Program.localeCompare(b.Product_Sub_Program);
                    });
                    
                    return aggregatedData;
                },

                // Upload consolidated Portfolio data to Confluence
                // Optimize data for smaller Excel file size
                optimizeDataForExcel(data) {
                    return data.map(row => {
                        const optimizedRow = {};
                        for (const [key, value] of Object.entries(row)) {
                            if (value === null || value === undefined) {
                                optimizedRow[key] = '';
                            } else if (typeof value === 'string') {
                                // Trim and remove excessive whitespace
                                optimizedRow[key] = value.trim();
                            } else if (typeof value === 'number') {
                                // Round to avoid floating point precision issues
                                optimizedRow[key] = Math.round(value * 100) / 100;
                            } else {
                                optimizedRow[key] = value;
                            }
                        }
                        return optimizedRow;
                    });
                },

                async uploadPortfolioToConfluence(portfolioData) {
                    try {
                        // Optimize data for smaller file size
                        const optimizedData = this.optimizeDataForExcel(portfolioData);
                        
                        const workbook = XLSX.utils.book_new();
                        const worksheet = XLSX.utils.json_to_sheet(optimizedData);
                        
                        // Set column widths
                        worksheet['!cols'] = [
                            { wch: 12 },  // Report_Date
                            { wch: 8 },   // Region
                            { wch: 15 },  // Facility_ID
                            { wch: 18 },  // Parent_Facility_ID
                            { wch: 20 },  // Product_Program
                            { wch: 20 },  // Product_Sub_Program
                            { wch: 15 },  // Management_Status
                            { wch: 18 },  // Facility_Type
                            { wch: 18 },  // Committed_Uncommitted
                            { wch: 15 },  // Risk_Category
                            { wch: 15 },  // Relationship_ID
                            { wch: 25 },  // Relationship_Name
                            { wch: 12 },  // CAID
                            { wch: 22 },  // Lead_Underwriter
                            { wch: 22 },  // Underwriting_Team_Lead
                            { wch: 15 },  // Control_Unit
                            { wch: 15 },  // Fac_Amount
                            { wch: 15 },  // Direct_OS
                            { wch: 15 },  // Contingent_OS
                            { wch: 15 },  // PSE_OS
                            { wch: 18 },  // Total_Comm_Exposure
                            { wch: 15 },  // Maturity_Date
                            { wch: 22 },  // Product_Underwriter
                            { wch: 18 },  // CA_Expiration_Date
                            { wch: 18 },  // Credit_Classification
                            { wch: 12 },  // PSE_non_PSE
                            { wch: 20 },  // Facility_First_Approval_Date
                            { wch: 15 },  // Origination_Date
                            { wch: 12 },  // CA_Review
                            { wch: 15 },  // OSUC
                            { wch: 15 },  // Total_OS
                            { wch: 18 },  // Total_Unused_Exposure
                            { wch: 15 },  // Total_Undrawn
                            { wch: 12 }   // ROTCE
                        ];
                        
                        XLSX.utils.book_append_sheet(workbook, worksheet, 'Portfolio Data');
                        
                        // Convert to binary with maximum compression
                        const excelBuffer = XLSX.write(workbook, { 
                            bookType: 'xlsx', 
                            type: 'array',
                            compression: true,
                            bookSST: false  // Disable shared string table for smaller size
                        });
                        const blob = new Blob([excelBuffer], { 
                            type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                        });
                        
                        const attachmentsUrl = `${this.confluenceConfig.baseUrl}/rest/api/content/${this.confluenceConfig.pageId}/child/attachment?filename=${encodeURIComponent(this.confluenceConfig.portfolioFileName)}`;
                        
                        const attachmentsResponse = await fetch(attachmentsUrl, {
                            headers: { 'X-Atlassian-Token': 'no-check' }
                        });
                        
                        const attachmentsData = await attachmentsResponse.json();
                        
                        let attachmentId = null;
                        if (attachmentsData.results && attachmentsData.results.length > 0) {
                            attachmentId = attachmentsData.results[0].id;
                        }
                        
                        const formData = new FormData();
                        formData.append('file', blob, this.confluenceConfig.portfolioFileName);
                        
                        const uploadUrl = attachmentId 
                            ? `${this.confluenceConfig.baseUrl}/rest/api/content/${this.confluenceConfig.pageId}/child/attachment/${attachmentId}/data`
                            : `${this.confluenceConfig.baseUrl}/rest/api/content/${this.confluenceConfig.pageId}/child/attachment`;
                        
                        console.log('Uploading Portfolio_tw.xlsx to Confluence:', uploadUrl);
                        
                        const response = await fetch(uploadUrl, {
                            method: 'POST',
                            headers: { 'X-Atlassian-Token': 'no-check' },
                            body: formData
                        });
                        
                        if (response.ok) {
                            console.log('Successfully uploaded Portfolio_tw.xlsx to Confluence');
                            return true;
                        } else {
                            const errorText = await response.text();
                            if (response.status === 413) {
                                console.warn('Portfolio file too large for Confluence upload (413). Use manual download instead.');
                            } else {
                                console.error('Confluence upload failed:', response.status, errorText);
                            }
                            return false;
                        }
                    } catch (error) {
                        console.error('Error uploading Portfolio to Confluence:', error);
                        return false;
                    }
                },

                // Upload aggregated historical data to Confluence
                // This function fetches existing history, appends new data, and uploads back
                async uploadAggregatedHistoryToConfluence(newAggregatedData) {
                    try {
                        const fileName = this.confluenceConfig.aggregatedHistoryFileName;
                        let existingData = [];
                        
                        // Try to fetch existing aggregated history file from Confluence
                        try {
                            const attachmentsUrl = `${this.confluenceConfig.baseUrl}/rest/api/content/${this.confluenceConfig.pageId}/child/attachment?filename=${encodeURIComponent(fileName)}`;
                            
                            const attachmentsResponse = await fetch(attachmentsUrl, {
                                headers: { 'X-Atlassian-Token': 'no-check' }
                            });
                            
                            if (attachmentsResponse.ok) {
                                const attachmentsData = await attachmentsResponse.json();
                                
                                if (attachmentsData.results && attachmentsData.results.length > 0) {
                                    // File exists, download it
                                    const downloadUrl = this.confluenceConfig.baseUrl + attachmentsData.results[0]._links.download;
                                    const fileResponse = await fetch(downloadUrl);
                                    
                                    if (fileResponse.ok) {
                                        const arrayBuffer = await fileResponse.arrayBuffer();
                                        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                                        const sheetName = workbook.SheetNames[0];
                                        const worksheet = workbook.Sheets[sheetName];
                                        existingData = XLSX.utils.sheet_to_json(worksheet);
                                        console.log(`Found existing aggregated history with ${existingData.length} records`);
                                    }
                                }
                            }
                        } catch (fetchError) {
                            console.log('No existing aggregated history found, creating new file');
                        }
                        
                        // Merge existing and new data, avoiding duplicates
                        const mergedDataMap = new Map();
                        
                        // Add existing data to map
                        existingData.forEach(row => {
                            const key = [
                                row.Report_Date || '',
                                row.Region || '',
                                row.Product_Program || '',
                                row.Product_Sub_Program || '',
                                row.Committed_Uncommitted || '',
                                row.PSE_non_PSE || ''
                            ].join('|');
                            mergedDataMap.set(key, row);
                        });
                        
                        // Add/update with new data (overwrites if same key exists)
                        newAggregatedData.forEach(row => {
                            const key = [
                                row.Report_Date || '',
                                row.Region || '',
                                row.Product_Program || '',
                                row.Product_Sub_Program || '',
                                row.Committed_Uncommitted || '',
                                row.PSE_non_PSE || ''
                            ].join('|');
                            mergedDataMap.set(key, row);
                        });
                        
                        // Convert back to array and sort
                        const mergedData = Array.from(mergedDataMap.values()).sort((a, b) => {
                            if (a.Report_Date !== b.Report_Date) return a.Report_Date.localeCompare(b.Report_Date);
                            if (a.Region !== b.Region) return a.Region.localeCompare(b.Region);
                            if (a.Product_Program !== b.Product_Program) return a.Product_Program.localeCompare(b.Product_Program);
                            return a.Product_Sub_Program.localeCompare(b.Product_Sub_Program);
                        });
                        
                        console.log(`Merged aggregated history: ${mergedData.length} total records`);
                        
                        // Create Excel file with merged data
                        const workbook = XLSX.utils.book_new();
                        const worksheet = XLSX.utils.json_to_sheet(mergedData);
                        
                        // Set column widths
                        worksheet['!cols'] = [
                            { wch: 12 },  // Report_Date
                            { wch: 8 },   // Region
                            { wch: 25 },  // Product_Program
                            { wch: 25 },  // Product_Sub_Program
                            { wch: 20 },  // Committed_Uncommitted
                            { wch: 12 },  // PSE_non_PSE
                            { wch: 15 },  // TFA
                            { wch: 15 },  // OSUC
                            { wch: 15 },  // Total_OS
                            { wch: 15 },  // Direct_OS
                            { wch: 15 },  // Contingent_OS
                            { wch: 15 },  // PSE_OS
                            { wch: 18 },  // Total_Unused_Exposure
                            { wch: 15 },  // Total_Undrawn
                            { wch: 15 },  // Count_of_Facilities
                            { wch: 18 },  // Count_of_Relationships
                            { wch: 12 }   // Count_of_CAs
                        ];
                        
                        XLSX.utils.book_append_sheet(workbook, worksheet, 'Aggregated History');
                        
                        // Convert to binary with compression
                        const excelBuffer = XLSX.write(workbook, { 
                            bookType: 'xlsx', 
                            type: 'array',
                            compression: true,
                            bookSST: false
                        });
                        const blob = new Blob([excelBuffer], { 
                            type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                        });
                        
                        // Check if file already exists to get attachment ID
                        const attachmentsUrl = `${this.confluenceConfig.baseUrl}/rest/api/content/${this.confluenceConfig.pageId}/child/attachment?filename=${encodeURIComponent(fileName)}`;
                        const attachmentsResponse = await fetch(attachmentsUrl, {
                            headers: { 'X-Atlassian-Token': 'no-check' }
                        });
                        
                        const attachmentsData = await attachmentsResponse.json();
                        let attachmentId = null;
                        if (attachmentsData.results && attachmentsData.results.length > 0) {
                            attachmentId = attachmentsData.results[0].id;
                        }
                        
                        const formData = new FormData();
                        formData.append('file', blob, fileName);
                        
                        const uploadUrl = attachmentId 
                            ? `${this.confluenceConfig.baseUrl}/rest/api/content/${this.confluenceConfig.pageId}/child/attachment/${attachmentId}/data`
                            : `${this.confluenceConfig.baseUrl}/rest/api/content/${this.confluenceConfig.pageId}/child/attachment`;
                        
                        console.log(`Uploading ${fileName} to Confluence:`, uploadUrl);
                        
                        const response = await fetch(uploadUrl, {
                            method: 'POST',
                            headers: { 'X-Atlassian-Token': 'no-check' },
                            body: formData
                        });
                        
                        if (response.ok) {
                            console.log(`Successfully uploaded ${fileName} to Confluence`);
                            // Store merged data for download
                            this.processedDataCache.aggregatedHistory = mergedData;
                            return { success: true, recordCount: mergedData.length };
                        } else {
                            const errorText = await response.text();
                            console.error('Confluence upload failed:', response.status, errorText);
                            // Still store data for manual download
                            this.processedDataCache.aggregatedHistory = mergedData;
                            return { success: false, recordCount: mergedData.length };
                        }
                    } catch (error) {
                        console.error('Error uploading aggregated history to Confluence:', error);
                        return { success: false, recordCount: 0 };
                    }
                },

                // Process Portfolio file with ETL logic
                async processPortfolioFile(file, region, pseMappingData, regionsMapping = {}) {
                    const workbook = await this.readExcelWorkbook(file);
                    const firstSheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[firstSheetName];
                    
                    let rawData;
                    
                    // NAM file has special structure: rows 1-3 are empty/report title, headers start at row 4 (B4)
                    // Column A is always empty, so we skip it
                    if (region === 'nam') {
                        // Read starting from row 4 (0-indexed = 3) where headers are
                        rawData = XLSX.utils.sheet_to_json(sheet, { range: 3 });
                    } else {
                        rawData = XLSX.utils.sheet_to_json(sheet);
                    }

                    let transformedData = [];

                    if (region === 'emea') {
                        transformedData = rawData
                            .filter(row => this.hasValidFacID(row)) // Filter: Fac ID not null/empty
                            .map(row => this.mapPortfolioRowEMEA(row, pseMappingData));
                    } else if (region === 'apac') {
                        transformedData = rawData
                            .map(row => this.mapPortfolioRowAPAC(row, pseMappingData));
                    } else if (region === 'nam') {
                        transformedData = rawData
                            .filter(row => !this.isExcludedRiskCategory(row)) // Filter OUT Clearing, Notation, Settlement
                            .filter(row => Object.keys(row).length > 1) // Filter out rows with only empty column A
                            .map(row => this.mapPortfolioRowNAM(row, pseMappingData, regionsMapping))
                            .filter(row => this.isAllowedNAMRegion(row.Region)); // Keep only NAM and LATAM, filter out SARG and non-matches
                    }

                    return transformedData;
                },

                // Check if Fac ID is valid (not null/empty) - for EMEA filter
                hasValidFacID(row) {
                    const facId = row['Fac ID'] || row['FacID'] || row['Facility ID'] || '';
                    return String(facId).trim() !== '';
                },

                // Check if Risk Category should be excluded - for NAM filter
                isExcludedRiskCategory(row) {
                    const riskCategory = String(row['Risk Category'] || '').trim().toLowerCase();
                    const excludedCategories = ['clearing', 'notation', 'settlement'];
                    return excludedCategories.includes(riskCategory);
                },

                // Check if region is allowed for NAM file (NAM and LATAM only, filter out SARG and non-matches)
                isAllowedNAMRegion(region) {
                    const allowedRegions = ['nam', 'latam'];
                    const regionStr = String(region || '').trim().toLowerCase();
                    return allowedRegions.includes(regionStr);
                },

                // Normalize Underwriter name from "LASTNAME, FIRSTNAME" to "FirstName LastName"
                normalizeUnderwriterName(value) {
                    if (!value) return '';
                    
                    const trimmed = String(value).trim();
                    if (!trimmed) return '';
                    
                    // Check if it contains a comma (LASTNAME, FIRSTNAME format)
                    if (trimmed.includes(',')) {
                        const parts = trimmed.split(',').map(p => p.trim());
                        if (parts.length >= 2) {
                            const lastName = parts[0];
                            const firstName = parts[1];
                            
                            // Convert to proper case (FirstName LastName)
                            const formatName = (name) => {
                                return name.toLowerCase()
                                    .split(/[\s-]+/)
                                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                                    .join(' ');
                            };
                            
                            return `${formatName(firstName)} ${formatName(lastName)}`;
                        }
                    }
                    
                    // If no comma, just convert to proper case
                    return trimmed.toLowerCase()
                        .split(/[\s-]+/)
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                        .join(' ');
                },

                // Normalize Credit Classification to standard values
                normalizeCreditClassification(value) {
                    if (!value) return '';
                    
                    const normalized = String(value).trim().toLowerCase();
                    
                    // Pass variants
                    if (normalized === 'p' || normalized === 'pass' || normalized === 'pass (p)') {
                        return 'Pass';
                    }
                    
                    // Pass Watch List variants
                    if (normalized === 'pwl' || normalized === 'pass watch list' || normalized === 'pass watch list (pwl)' || normalized === 'passwatchlist') {
                        return 'Pass Watch List';
                    }
                    
                    // Special Mention variants
                    if (normalized === 'sm' || normalized === 'special mention' || normalized === 'special mention (sm)' || normalized === 'specialmention') {
                        return 'Special Mention';
                    }
                    
                    // Substandard variants
                    if (normalized === 'ss' || normalized === 'substandard' || normalized === 'substandard (ss)') {
                        return 'Substandard';
                    }
                    
                    // Substandard Non Performing
                    if (normalized === 'substandard non performing' || normalized === 'substandard non-performing' || normalized === 'substandardnonperforming') {
                        return 'Substandard Non Performing';
                    }
                    
                    // Substandard Performing
                    if (normalized === 'substandard performing' || normalized === 'substandardperforming') {
                        return 'Substandard Performing';
                    }
                    
                    // Doubtful variants
                    if (normalized === 'd' || normalized === 'doubtful' || normalized === 'doubtful (d)') {
                        return 'Doubtful';
                    }
                    
                    // Loss
                    if (normalized === 'loss' || normalized === 'l') {
                        return 'Loss';
                    }
                    
                    // If no match, return original value with proper case
                    return String(value).trim();
                },

                // Determine Underwriting Team Lead for EMEA
                getEMEAUnderwritingTeamLead(leadUnderwriter) {
                    const kristopherPalmerTeam = [
                        'simpson harry', 'palmer kristopher', 'kadeli irida', 'graeme-wilson dom'
                    ];
                    const leadUW = String(leadUnderwriter || '').trim().toLowerCase();
                    
                    if (kristopherPalmerTeam.some(name => leadUW.includes(name) || name.includes(leadUW))) {
                        return 'Kristopher Palmer';
                    }
                    return 'Ponniah Raj';
                },

                // Format date with handling for invalid values like DEMAND
                formatDateSafe(dateValue) {
                    if (!dateValue) return '';
                    
                    const str = String(dateValue).trim().toUpperCase();
                    
                    // Check for known invalid date texts
                    const invalidTexts = ['DEMAND', 'ON DEMAND', 'N/A', 'TBD', 'TBC', 'OPEN'];
                    if (invalidTexts.some(t => str.includes(t))) {
                        return '';
                    }
                    
                    // Special check for single dash which isn't a date
                    if (str === '-' || str === '') {
                        return '';
                    }
                    
                    // Try to format the date
                    const formatted = this.formatDate(dateValue);
                    
                    // If formatDate returned the original string (couldn't parse), return empty
                    // But only if it doesn't look like a date at all (no digits)
                    if (formatted === String(dateValue).trim()) {
                        // Check if it looks like a valid date format (has digits)
                        if (!/\d/.test(formatted)) {
                            return '';
                        }
                    }
                    
                    return formatted;
                },

                // Parse numeric value safely
                parseNumeric(value) {
                    if (value === null || value === undefined || value === '') return 0;
                    const num = parseFloat(String(value).replace(/[,$]/g, ''));
                    return isNaN(num) ? 0 : num;
                },

                // Get column value with flexible matching (handles whitespace, case variations)
                getColumnValue(row, columnNames) {
                    if (!row || !columnNames || !Array.isArray(columnNames)) return '';
                    
                    // First try exact matches
                    for (const name of columnNames) {
                        if (row[name] !== undefined && row[name] !== null) {
                            return row[name];
                        }
                    }
                    
                    // Then try case-insensitive and trimmed matches
                    const rowKeys = Object.keys(row);
                    for (const name of columnNames) {
                        const nameLower = name.toLowerCase().trim();
                        for (const key of rowKeys) {
                            if (key.toLowerCase().trim() === nameLower) {
                                return row[key];
                            }
                        }
                    }
                    
                    // Try partial match (column name contains or is contained)
                    for (const name of columnNames) {
                        const nameLower = name.toLowerCase().trim();
                        for (const key of rowKeys) {
                            const keyLower = key.toLowerCase().trim();
                            if (keyLower.includes(nameLower) || nameLower.includes(keyLower)) {
                                return row[key];
                            }
                        }
                    }
                    
                    return '';
                },

                // Map EMEA Portfolio row
                mapPortfolioRowEMEA(row, pseMappingData) {
                    const facilityType = row['Facility Type'] || '';
                    const leadUnderwriter = this.normalizeUnderwriterName(row['Investment Finance Lead Underwriter']);
                    const committedFacility = String(row['Commited Facility'] || row['Committed Facility'] || '').toUpperCase();
                    
                    // EMEA uses Facility Type as Primary_Key for category lookup
                    const categoryLookup = this.lookupCategoryMapping(facilityType, 'emea', pseMappingData);
                    
                    // Try multiple column names for Report Date
                    const reportDate = row['As Of Date'] || row['AsOfDate'] || row['Report Date'] || 
                                       row['ReportDate'] || row['Position Date'] || '';
                    
                    // Normalize CA Review Y/N to "Yes" or "No" (EMEA only)
                    const caReviewRaw = String(row['CA Review Y/N'] || row['CA Review'] || row['CAReview'] || '').toUpperCase();
                    const caReview = caReviewRaw === 'YES' || caReviewRaw === 'Y' ? 'Yes' : 
                                     caReviewRaw === 'NO' || caReviewRaw === 'N' ? 'No' : '';
                    
                    return {
                        Report_Date: this.formatDateSafe(reportDate),
                        Region: 'EMEA',
                        Facility_ID: row['Fac ID'] || '',
                        Parent_Facility_ID: row['Parent Facility ID'] || '',
                        Product_Program: categoryLookup.productProgram,
                        Product_Sub_Program: categoryLookup.productSubProgram,
                        Management_Status: row['DM/CM Flag'] || '',
                        Facility_Type: facilityType,
                        Committed_Uncommitted: committedFacility === 'YES' ? 'Committed' : 'Uncommitted',
                        Risk_Category: '',
                        Relationship_ID: row['Relationship ID'] || '',
                        Relationship_Name: row['EG Title'] || '',
                        CAID: row['CA ID'] || '',
                        Lead_Underwriter: leadUnderwriter,
                        Underwriting_Team_Lead: this.getEMEAUnderwritingTeamLead(leadUnderwriter),
                        Control_Unit: row['Control Unit'] || '',
                        Fac_Amount: this.parseNumeric(row['Approved Line Amount']),
                        Direct_OS: this.parseNumeric(row['Total Direct OS']),
                        Contingent_OS: this.parseNumeric(row['Total Cont OS']),
                        PSE_OS: this.parseNumeric(row['Total FX / Derivatives OS']),
                        Total_Comm_Exposure: 0,
                        Maturity_Date: this.formatDateSafe(row['Facility Maturity Date']),
                        Product_Underwriter: leadUnderwriter,
                        CA_Expiration_Date: this.formatDateSafe(row['CA Maturity Date']),
                        Credit_Classification: this.normalizeCreditClassification(row['Credit Classification']),
                        PSE_non_PSE: this.determinePSE(facilityType, '', 'emea', pseMappingData),
                        Facility_First_Approval_Date: this.formatDateSafe(row['Facility First Approval Date']),
                        Origination_Date: this.formatDateSafe(row['Origination Date']),
                        CA_Review: caReview,
                        OSUC: 0,
                        Total_OS: 0,
                        Total_Unused_Exposure: 0,
                        Total_Undrawn: 0,
                        ROTCE: ''
                    };
                },

                // Map APAC Portfolio row
                mapPortfolioRowAPAC(row, pseMappingData) {
                    const facilityType = row['Facility Type'] || '';
                    const legalStatus = String(row['Legal Status'] || '').toUpperCase();
                    const productProgramName = row['Product Program Name'] || row['ProductProgramName'] || '';
                    
                    // APAC uses Product Program Name as Primary_Key for category lookup
                    const categoryLookup = this.lookupCategoryMapping(productProgramName, 'apac', pseMappingData);
                    
                    // Try multiple column names for Report Date (Position Date is in DD-MMM-YYYY format)
                    const reportDate = row['Position Date'] || row['PositionDate'] || row['Report Date'] || 
                                       row['ReportDate'] || row['As Of Date'] || row['AsOfDate'] || 
                                       row['Data Date'] || row['DataDate'] || '';
                    
                    return {
                        Report_Date: this.formatDateSafe(reportDate),
                        Region: 'APAC',
                        Facility_ID: row['Facility Id'] || row['Facility ID'] || '',
                        Parent_Facility_ID: row['Facility Id'] || row['Facility ID'] || '',
                        Product_Program: categoryLookup.productProgram,
                        Product_Sub_Program: categoryLookup.productSubProgram,
                        Management_Status: row['Management status'] || row['Management Status'] || '',
                        Facility_Type: facilityType,
                        Committed_Uncommitted: legalStatus === 'C' ? 'Committed' : 'Uncommitted',
                        Risk_Category: row['Risk Category'] || '',
                        Relationship_ID: row['Relationship Id'] || row['Relationship ID'] || '',
                        Relationship_Name: '',
                        CAID: row['CA No.'] || row['CA No'] || row['CANo'] || row['CANo.'] || '',
                        Lead_Underwriter: this.normalizeUnderwriterName(row['Investment Finance Lead Underwriter Name']),
                        Underwriting_Team_Lead: this.normalizeUnderwriterName(row['Team Lead']),
                        Control_Unit: row['Control unit'] || row['Control Unit'] || '',
                        Fac_Amount: this.parseNumeric(row['TFA (USD)'] || row['TFA(USD)'] || row['TFA']),
                        Direct_OS: this.parseNumeric(row['Direct (USD)'] || row['Direct(USD)'] || row['Direct']),
                        Contingent_OS: this.parseNumeric(row['Contingent (USD)'] || row['Contingent(USD)'] || row['Contingent']),
                        PSE_OS: this.parseNumeric(row['PSE (USD)'] || row['PSE(USD)'] || row['PSE']),
                        Total_Comm_Exposure: 0,
                        Maturity_Date: this.formatDateSafe(row['Mainline Maturity Date']),
                        Product_Underwriter: row['Investment Finance Lead Underwriter Name'] || '',
                        CA_Expiration_Date: this.formatDateSafe(row['CA Expiration Date']),
                        Credit_Classification: this.normalizeCreditClassification(row['Classification']),
                        PSE_non_PSE: this.determinePSE(facilityType, '', 'apac', pseMappingData),
                        Facility_First_Approval_Date: '',
                        Origination_Date: this.formatDateSafe(row['Original Origination Date']),
                        CA_Review: '',
                        OSUC: 0,
                        Total_OS: 0,
                        Total_Unused_Exposure: 0,
                        Total_Undrawn: 0,
                        ROTCE: ''
                    };
                },

                // Map NAM Portfolio row
                mapPortfolioRowNAM(row, pseMappingData, regionsMapping = {}) {
                    const facilityType = row['Facility Type'] || '';
                    const productProgram = row['Product Program'] || row['Product Program Name'] || '';
                    const committedFlag = String(row['Committed / Uncommitted Flag'] || row['Committed/Uncommitted Flag'] || '').toLowerCase();
                    const controlUnit = row['Control Unit'] || '';
                    
                    // NAM uses Product Program as Primary_Key for category lookup
                    const categoryLookup = this.lookupCategoryMapping(productProgram, 'nam', pseMappingData);
                    
                    // Lookup region based on Control Unit from Regions_Mapping.xlsx
                    // If region is IPB, treat as NAM; otherwise use the mapped region
                    const mappedRegion = this.lookupNAMRegion(controlUnit, regionsMapping);
                    
                    // Try multiple column names for Report Date
                    const reportDate = row['As Of Date'] || row['AsOfDate'] || row['Report Date'] || 
                                       row['ReportDate'] || row['Position Date'] || '';
                    
                    return {
                        Report_Date: this.formatDateSafe(reportDate),
                        Region: mappedRegion,
                        Facility_ID: row['Facility ID'] || '',
                        Parent_Facility_ID: row['GFRN'] || '',
                        Product_Program: categoryLookup.productProgram,
                        Product_Sub_Program: categoryLookup.productSubProgram,
                        Management_Status: row['Management Status'] || '',
                        Facility_Type: facilityType,
                        Committed_Uncommitted: committedFlag.includes('uncommitted') ? 'Uncommitted' : 'Committed',
                        Risk_Category: row['Risk Category'] || '',
                        Relationship_ID: row['CARE Relationship ID'] || row['Relationship ID'] || '',
                        Relationship_Name: row['Relationship Short Name'] || '',
                        CAID: row['CA ID'] || '',
                        Lead_Underwriter: this.normalizeUnderwriterName(row['Investment Finance Lead Underwriter']),
                        Underwriting_Team_Lead: this.normalizeUnderwriterName(row['Investment Finance Underwriting Team Lead']),
                        Control_Unit: row['Control Unit'] || '',
                        Fac_Amount: this.parseNumeric(row['Total Reported Facility Amount'] || row['Facility Amount']),
                        Direct_OS: this.parseNumeric(row['Direct O/S (Fac Lvl)'] || row['Direct O/S']),
                        Contingent_OS: this.parseNumeric(row['Contingent O/S (Fac Lvl)'] || row['Contingent O/S']),
                        PSE_OS: this.parseNumeric(row['PSE O/S (Fac Lvl)'] || row['PSE O/S']),
                        Total_Comm_Exposure: this.parseNumeric(row['Total Comm Exposure (Fac Lvl)'] || row['Total Comm Exposure']),
                        Maturity_Date: this.formatDateSafe(row['Maturity Date Or Demand'] || row['Maturity Date']),
                        Product_Underwriter: row['Investment Finance Product Underwriter'] || '',
                        CA_Expiration_Date: this.formatDateSafe(row['CA Expiration Date']),
                        Credit_Classification: this.normalizeCreditClassification(row['Credit Classification']),
                        PSE_non_PSE: this.determinePSE(facilityType, productProgram, 'nam', pseMappingData),
                        Facility_First_Approval_Date: this.formatDateSafe(
                            this.getColumnValue(row, ['Facility Approval Date', 'Facility First Approval Date', 
                            'First Approval Date', 'Facility_Approval_Date', 'FacilityApprovalDate', 'Fac Approval Date'])
                        ),
                        Origination_Date: this.formatDateSafe(
                            this.getColumnValue(row, ['Origination Date', 'OriginationDate', 'Origination_Date',
                            'Original Origination Date', 'Orig Date'])
                        ),
                        CA_Review: '',
                        OSUC: this.parseNumeric(row['Total Comm Exposure (Fac Lvl)'] || row['OSUC']),
                        Total_OS: 0,
                        Total_Unused_Exposure: this.parseNumeric(row['Unused Commitment (Fac Lvl)'] || row['Unused Commitment']),
                        Total_Undrawn: 0,
                        ROTCE: ''
                    };
                },

                // Apply post-merge calculations for Portfolio data
                applyPortfolioCalculations(portfolioData) {
                    return portfolioData.map(row => {
                        const facAmount = this.parseNumeric(row.Fac_Amount);
                        const directOS = this.parseNumeric(row.Direct_OS);
                        const contingentOS = this.parseNumeric(row.Contingent_OS);
                        const pseOS = this.parseNumeric(row.PSE_OS);
                        const isCommitted = row.Committed_Uncommitted === 'Committed';
                        const isEMEA = row.Region === 'EMEA';
                        const isAPAC = row.Region === 'APAC';

                        // Total_OS = Direct_OS + Contingent_OS + PSE_OS (for ALL regions)
                        row.Total_OS = directOS + contingentOS + pseOS;

                        // Total_Undrawn = Fac_Amount - (Direct_OS + Contingent_OS + PSE_OS) (for ALL regions)
                        row.Total_Undrawn = facAmount - (directOS + contingentOS + pseOS);

                        // For EMEA and APAC: Calculate OSUC and Total_Unused_Exposure
                        if (isEMEA || isAPAC) {
                            // OSUC = If Committed  Fac_Amount, If Uncommitted  Direct_OS + Contingent_OS + PSE_OS
                            row.OSUC = isCommitted ? facAmount : (directOS + contingentOS + pseOS);

                            // Total_Unused_Exposure = If Committed  Fac_Amount - (Direct_OS + Contingent_OS + PSE_OS), If Uncommitted  0
                            row.Total_Unused_Exposure = isCommitted ? (facAmount - (directOS + contingentOS + pseOS)) : 0;
                        }

                        return row;
                    });
                },

                // ==================== END PORTFOLIO ETL FUNCTIONS ====================

                // Read Excel file and return workbook for multi-sheet access
                readExcelWorkbook(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const data = new Uint8Array(e.target.result);
                                const workbook = XLSX.read(data, { type: 'array' });
                                resolve(workbook);
                            } catch (error) {
                                reject(error);
                            }
                        };
                        reader.onerror = reject;
                        reader.readAsArrayBuffer(file);
                    });
                },

                // Read first sheet of Excel file (for backward compatibility)
                readExcelFile(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const data = new Uint8Array(e.target.result);
                                const workbook = XLSX.read(data, { type: 'array' });
                                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                                resolve(jsonData);
                            } catch (error) {
                                reject(error);
                            }
                        };
                        reader.onerror = reject;
                        reader.readAsArrayBuffer(file);
                    });
                },

                // Get sheet data by name (case-insensitive partial match)
                getSheetData(workbook, sheetNamePattern) {
                    const sheetName = workbook.SheetNames.find(name => 
                        name.toLowerCase().includes(sheetNamePattern.toLowerCase())
                    );
                    if (sheetName) {
                        return XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                    }
                    return [];
                },

                // Check if row contains "Nothing to Report" or "NIL" values
                isEmptyReport(row) {
                    const values = Object.values(row).map(v => 
                        String(v || '').toLowerCase().trim()
                    );
                    return values.some(v => 
                        v === 'nil' || 
                        v === 'nothing to report' || 
                        v.includes('nothing to report') ||
                        v === 'n/a' ||
                        v === 'na'
                    );
                },

                // Process CCM file based on region with ETL logic
                async processCCMFile(file, region) {
                    const workbook = await this.readExcelWorkbook(file);
                    let rawData = [];
                    
                    // Define which sheets to read based on region
                    if (region === 'nam') {
                        // NAM: Read "Open CCM" tab only
                        rawData = this.getSheetData(workbook, 'Open CCM');
                    } else if (region === 'apac') {
                        // APAC: Read "Past Due" and "All Coming Due CCMs" tabs
                        const pastDue = this.getSheetData(workbook, 'Past Due');
                        const allComingDue = this.getSheetData(workbook, 'All Coming Due CCMs');
                        console.log('APAC - Past Due rows:', pastDue.length);
                        console.log('APAC - All Coming Due CCMs rows:', allComingDue.length);
                        rawData = [...pastDue, ...allComingDue];
                    } else if (region === 'emea') {
                        // EMEA: Read "Past Due", "Coming Due", "Open CCM" tabs
                        const pastDue = this.getSheetData(workbook, 'Past Due');
                        const comingDue = this.getSheetData(workbook, 'Coming Due');
                        const openCCM = this.getSheetData(workbook, 'Open CCM');
                        rawData = [...pastDue, ...comingDue, ...openCCM];
                    }

                    // Transform data to standard format
                    const transformedData = rawData
                        .filter(row => !this.isEmptyReport(row)) // Filter out empty/NIL reports
                        .filter(row => Object.keys(row).length > 0) // Filter empty rows
                        .map(row => this.mapCCMRow(row, region));

                    return transformedData;
                },

                // Map CCM row to standard output format based on region
                mapCCMRow(row, region) {
                    const mappedRow = {
                        Report_Date: this.ccmReportDate,
                        Region: region.toUpperCase(),
                        Relationship_ID: '',
                        Client_Name: '',
                        Classification: '',
                        Frequency: '',
                        Underwriter: '',
                        Next_CCM_Month_End: '',
                        Next_CCM_Approval_Date: '',
                        CCM_Status: ''
                    };

                    if (region === 'nam') {
                        // NAM column mapping
                        mappedRow.Region = row['Region'] || 'NAM';
                        mappedRow.Relationship_ID = row['CARE ID'] || '';
                        mappedRow.Client_Name = row['Client Name'] || '';
                        mappedRow.Classification = row['Classification'] || '';
                        mappedRow.Frequency = row['Frequency'] || '';
                        mappedRow.Underwriter = row['Underwriter'] || '';
                        mappedRow.Next_CCM_Month_End = this.formatDate(row['Next CCM Month End']);
                        mappedRow.Next_CCM_Approval_Date = this.formatDate(row['Next CCM Approval Date']);
                        mappedRow.CCM_Status = row['Status'] || '';
                    } else if (region === 'apac') {
                        // APAC column mapping
                        mappedRow.Region = row['Region'] || 'APAC';
                        mappedRow.Relationship_ID = row['CARE ID'] || '';
                        mappedRow.Client_Name = row['Client Name'] || '';
                        mappedRow.Classification = row['Classification'] || '';
                        mappedRow.Frequency = row['Frequency'] || '';
                        // APAC uses "Specialist" instead of "Underwriter"
                        mappedRow.Underwriter = row['Specialist'] || row['Underwriter'] || '';
                        mappedRow.Next_CCM_Month_End = this.formatDate(row['Next CCM Month End']);
                        mappedRow.Next_CCM_Approval_Date = this.formatDate(row['Next CCM Approval Date']);
                        mappedRow.CCM_Status = row['Status'] || '';
                    } else if (region === 'emea') {
                        // EMEA column mapping - No Region column, fill with "EMEA"
                        mappedRow.Region = 'EMEA';
                        // EMEA uses "Relationship ID" instead of "CARE ID"
                        mappedRow.Relationship_ID = row['Relationship ID'] || '';
                        // EMEA uses "CA ID" which we map to Client_Name
                        mappedRow.Client_Name = row['CA ID'] || row['Client Name'] || '';
                        mappedRow.Classification = row['Classification'] || '';
                        mappedRow.Frequency = row['Frequency'] || '';
                        // EMEA uses "Originator" as Team Leader, but we need Underwriter
                        mappedRow.Underwriter = row['Underwriter'] || '';
                        mappedRow.Next_CCM_Month_End = this.formatDate(row['Next CCM Month End']);
                        mappedRow.Next_CCM_Approval_Date = this.formatDate(row['Next CCM Approval Date']);
                        // EMEA has "Booked Elsewhere Facility?" column
                        mappedRow.CCM_Status = row['Status'] || '';
                    }

                    return mappedRow;
                },

                // Format date to consistent DD/MM/YYYY format
                // Handles: DD-MMM-YYYY, DD-MMM-YY, MM-DD-YYYY, MMM-DD-YYYY, YYYY-MM-DD, DD/MM/YYYY, MM/DD/YYYY, Excel serial numbers
                formatDate(dateValue) {
                    if (!dateValue) return '';
                    
                    let date = null;
                    
                    // Month name mapping (case-insensitive)
                    const monthNames = {
                        'jan': 0, 'january': 0,
                        'feb': 1, 'february': 1,
                        'mar': 2, 'march': 2,
                        'apr': 3, 'april': 3,
                        'may': 4,
                        'jun': 5, 'june': 5,
                        'jul': 6, 'july': 6,
                        'aug': 7, 'august': 7,
                        'sep': 8, 'sept': 8, 'september': 8,
                        'oct': 9, 'october': 9,
                        'nov': 10, 'november': 10,
                        'dec': 11, 'december': 11
                    };

                    // If it's an Excel serial date number
                    if (typeof dateValue === 'number') {
                        date = new Date((dateValue - 25569) * 86400 * 1000);
                    }
                    // If it's a Date object
                    else if (dateValue instanceof Date) {
                        date = dateValue;
                    }
                    // If it's a string, parse various formats
                    else if (typeof dateValue === 'string') {
                        const str = dateValue.trim();
                        
                        // Try DD-MMM-YYYY or DD-MMM-YY (e.g., 29-NOV-2025, 29-NOV-25, also handles / separator)
                        let match = str.match(/^(\d{1,2})[-\/]([A-Za-z]{3,9})[-\/](\d{2,4})$/i);
                        if (match) {
                            const day = parseInt(match[1]);
                            const monthStr = match[2].toLowerCase();
                            const month = monthNames[monthStr];
                            let year = parseInt(match[3]);
                            
                            // Handle 2-digit year: 00-49 = 2000-2049, 50-99 = 1950-1999
                            if (year < 100) {
                                year += (year < 50) ? 2000 : 1900;
                            }
                            
                            if (month !== undefined && day >= 1 && day <= 31) {
                                date = new Date(year, month, day);
                            }
                        }
                        
                        // Try MMM-DD-YYYY or MMM/DD/YYYY (e.g., Jan-15-2024, Jan/15/2024)
                        if (!date) {
                            match = str.match(/^([A-Za-z]{3,9})[-\/](\d{1,2})[-\/](\d{2,4})$/i);
                            if (match) {
                                const monthStr = match[1].toLowerCase();
                                const month = monthNames[monthStr];
                                const day = parseInt(match[2]);
                                let year = parseInt(match[3]);
                                
                                if (year < 100) {
                                    year += (year < 50) ? 2000 : 1900;
                                }
                                
                                if (month !== undefined && day >= 1 && day <= 31) {
                                    date = new Date(year, month, day);
                                }
                            }
                        }
                        
                        // Try YYYY-MM-DD (ISO format)
                        if (!date) {
                            match = str.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})$/);
                            if (match) {
                                const year = parseInt(match[1]);
                                const month = parseInt(match[2]) - 1;
                                const day = parseInt(match[3]);
                                if (month >= 0 && month <= 11 && day >= 1 && day <= 31) {
                                    date = new Date(year, month, day);
                                }
                            }
                        }
                        
                        // Try MM-DD-YYYY or MM/DD/YYYY or DD-MM-YYYY or DD/MM/YYYY
                        if (!date) {
                            match = str.match(/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{2,4})$/);
                            if (match) {
                                let first = parseInt(match[1]);
                                let second = parseInt(match[2]);
                                let year = parseInt(match[3]);
                                
                                if (year < 100) {
                                    year += (year < 50) ? 2000 : 1900;
                                }
                                
                                // If first number > 12, it must be DD/MM/YYYY
                                if (first > 12) {
                                    date = new Date(year, second - 1, first);
                                }
                                // If second number > 12, it must be MM/DD/YYYY
                                else if (second > 12) {
                                    date = new Date(year, first - 1, second);
                                }
                                // Ambiguous - assume DD/MM/YYYY (European format)
                                else {
                                    date = new Date(year, second - 1, first);
                                }
                            }
                        }
                        
                        // Try native Date parsing as last resort
                        if (!date) {
                            const parsed = new Date(str);
                            if (!isNaN(parsed.getTime())) {
                                date = parsed;
                            }
                        }
                    }
                    
                    // Format to DD/MM/YYYY
                    if (date && !isNaN(date.getTime())) {
                        const day = String(date.getDate()).padStart(2, '0');
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const year = date.getFullYear();
                        return `${day}/${month}/${year}`;
                    }
                    
                    // Return original value if parsing failed
                    return String(dateValue).trim();
                },

                // Parse date from various formats
                parseDate(dateValue) {
                    if (!dateValue) return null;
                    
                    if (typeof dateValue === 'number') {
                        return new Date((dateValue - 25569) * 86400 * 1000);
                    }
                    
                    if (dateValue instanceof Date) {
                        return dateValue;
                    }
                    
                    const parsed = new Date(dateValue);
                    return isNaN(parsed.getTime()) ? null : parsed;
                },

                // Download processed file
                downloadFile(type) {
                    const data = this.processedDataCache[type];
                    if (!data || data.length === 0) {
                        this.showNotification('No data available for download', 'warning');
                        return;
                    }
                    
                    const fileNames = {
                        portfolio: 'Portfolio_tw.xlsx',
                        covenants: 'Covenants_tw.xlsx',
                        ccm: 'CCM_tw.xlsx',
                        rotce: 'ROTCE_tw.xlsx',
                        aggregatedHistory: 'Portfolio_Aggregated_History.xlsx'
                    };
                    
                    try {
                        // Optimize data and create workbook
                        const optimizedData = this.optimizeDataForExcel(data);
                        const workbook = XLSX.utils.book_new();
                        const worksheet = XLSX.utils.json_to_sheet(optimizedData);
                        
                        // Set column widths based on data type
                        if (type === 'ccm') {
                            worksheet['!cols'] = [
                                { wch: 12 }, { wch: 8 }, { wch: 15 }, { wch: 30 }, { wch: 15 },
                                { wch: 12 }, { wch: 20 }, { wch: 18 }, { wch: 20 }, { wch: 12 }
                            ];
                        } else if (type === 'covenants') {
                            worksheet['!cols'] = Array(26).fill({ wch: 15 });
                        } else if (type === 'rotce') {
                            worksheet['!cols'] = [
                                { wch: 25 }, { wch: 12 }, { wch: 20 }, { wch: 15 }, { wch: 15 }, { wch: 15 }
                            ];
                        } else if (type === 'aggregatedHistory') {
                            worksheet['!cols'] = [
                                { wch: 12 },  // Report_Date
                                { wch: 8 },   // Region
                                { wch: 25 },  // Product_Program
                                { wch: 25 },  // Product_Sub_Program
                                { wch: 20 },  // Committed_Uncommitted
                                { wch: 12 },  // PSE_non_PSE
                                { wch: 15 },  // TFA
                                { wch: 15 },  // OSUC
                                { wch: 15 },  // Total_OS
                                { wch: 15 },  // Direct_OS
                                { wch: 15 },  // Contingent_OS
                                { wch: 15 },  // PSE_OS
                                { wch: 18 },  // Total_Unused_Exposure
                                { wch: 15 },  // Total_Undrawn
                                { wch: 15 },  // Count_of_Facilities
                                { wch: 18 },  // Count_of_Relationships
                                { wch: 12 }   // Count_of_CAs
                            ];
                        } else {
                            worksheet['!cols'] = Array(34).fill({ wch: 15 }); // 33 + ROTCE column
                        }
                        
                        const sheetNames = {
                            portfolio: 'Portfolio Data',
                            covenants: 'Covenants Data',
                            ccm: 'CCM Data',
                            rotce: 'ROTCE Data',
                            aggregatedHistory: 'Aggregated History'
                        };
                        
                        XLSX.utils.book_append_sheet(workbook, worksheet, sheetNames[type]);
                        
                        // Generate and download with maximum compression
                        const excelBuffer = XLSX.write(workbook, { 
                            bookType: 'xlsx', 
                            type: 'array',
                            compression: true,
                            bookSST: false  // Disable shared string table for smaller size
                        });
                        const blob = new Blob([excelBuffer], { 
                            type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                        });
                        
                        // Create download link
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = fileNames[type];
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                        
                        this.showNotification(`${fileNames[type]} downloaded successfully`, 'success');
                    } catch (error) {
                        console.error('Download error:', error);
                        this.showNotification('Failed to download file: ' + error.message, 'error');
                    }
                },

                showNotification(message, type = 'info', duration = 4000) {
                    const container = document.getElementById('notificationContainer');
                    const colors = {
                        success: 'bg-brand-500',
                        error: 'bg-white border border-red-200',
                        warning: 'bg-warning-500',
                        info: 'bg-brand-500'
                    };
                    const textColors = {
                        success: 'text-white',
                        error: 'text-gray-800',
                        warning: 'text-white',
                        info: 'text-white'
                    };
                    const icons = {
                        success: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>',
                        error: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>',
                        warning: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>',
                        info: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'
                    };
                    const iconColors = {
                        success: 'text-white',
                        error: 'text-red-500',
                        warning: 'text-white',
                        info: 'text-white'
                    };

                    const notification = document.createElement('div');
                    const isHtmlContent = message.includes('<');
                    const maxWidth = isHtmlContent ? 'max-w-md' : 'max-w-sm';
                    
                    notification.className = `notification-animate rounded-xl ${colors[type]} ${textColors[type]} px-4 py-3 shadow-xl ${maxWidth}`;
                    
                    if (isHtmlContent) {
                        // HTML content with close button
                        notification.innerHTML = `
                            <div class="flex items-start gap-3">
                                <svg class="w-5 h-5 flex-shrink-0 mt-0.5 ${iconColors[type]}" fill="none" stroke="currentColor" viewBox="0 0 24 24">${icons[type]}</svg>
                                <div class="flex-1">${message}</div>
                                <button onclick="this.parentElement.parentElement.remove()" class="flex-shrink-0 p-1 hover:bg-gray-200 rounded transition-colors">
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        `;
                    } else {
                        // Simple text content
                        notification.innerHTML = `
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 flex-shrink-0 ${iconColors[type]}" fill="none" stroke="currentColor" viewBox="0 0 24 24">${icons[type]}</svg>
                                <span class="text-sm font-medium">${message}</span>
                            </div>
                        `;
                    }
                    
                    container.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.style.opacity = '0';
                        notification.style.transition = 'opacity 0.3s ease-out';
                        setTimeout(() => notification.remove(), 300);
                    }, duration);
                }
            };
        }
    </script>
</body>

</html>

