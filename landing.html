<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LPTM Hub - Search</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Only essential styles that Tailwind can't handle */
        html, body {
            overflow: hidden;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        /* Smooth rotating text animation */
        .flip-container {
            display: inline-block;
            min-width: 140px;
            position: relative;
        }

        .flip-word {
            display: inline-block;
            transition: all 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        .flip-word.slide-out {
            animation: slideOut 0.5s cubic-bezier(0.4, 0.0, 0.2, 1) forwards;
        }

        .flip-word.slide-in {
            animation: slideIn 0.5s cubic-bezier(0.4, 0.0, 0.2, 1) forwards;
        }

        @keyframes slideOut {
            0% {
                transform: translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateY(-30px);
                opacity: 0;
            }
        }

        @keyframes slideIn {
            0% {
                transform: translateY(30px);
                opacity: 0;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900" style="padding: 1rem;">
<div style="height: calc(100vh - 2rem);" class="rounded-2xl border border-gray-200 px-5 py-7 relative bg-white bg-[linear-gradient(to_right,#f0f0f0_1px,transparent_1px),linear-gradient(to_bottom,#f0f0f0_1px,transparent_1px)] bg-[size:6rem_4rem] overflow-hidden">
    <!-- Subtle Gradient Overlay -->
    <div class="absolute inset-0 bg-[radial-gradient(circle_500px_at_50%_200px,rgba(96,165,250,0.15),transparent)] pointer-events-none" style="border-radius: 1rem;"></div>
    
    <main class="relative z-10 h-full">
        <section class="h-full flex items-center justify-center">
            <div class="w-full max-w-4xl flex flex-col items-center space-y-6 sm:space-y-8 px-4">
                <!-- LPTM Hub Title -->
                <div class="text-center">
                    <h1 class="!text-5xl md:!text-6xl font-bold text-gray-900 mb-6">
                        <span>LPTM </span>
                        <span class="flip-container bg-blue-600 text-white px-4 py-1 rounded-lg">
                            <span class="flip-word" id="flip-text">Hub</span>
                        </span>
                    </h1>
                    <p class="!text-lg text-gray-600">Your central resource for Loan Product & Transaction Management</p>
                </div>
                
                <!-- Search Section -->
                <div id="lptm-search-container" class="w-full max-w-xl sm:max-w-2xl relative">
                    <div id="lptm-search-box" class="bg-white border border-gray-300 rounded-2xl flex items-center h-11 sm:h-12 md:h-14 px-3 sm:px-4 shadow-sm hover:shadow-md transition-shadow duration-300 focus-within:border-blue-500 focus-within:border-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 512 512" class="text-gray-400 mr-2 flex-shrink-0 w-4 h-4 sm:w-5 sm:h-5">
                            <path d="M497.913 497.913c-18.782 18.782-49.225 18.782-68.008 0l-84.862-84.863c-34.889 22.382-76.13 35.717-120.659 35.717C100.469 448.767 0 348.312 0 224.383S100.469 0 224.384 0c123.931 0 224.384 100.452 224.384 224.383 0 44.514-13.352 85.771-35.718 120.676l84.863 84.863c18.782 18.782 18.782 49.209 0 67.991zM224.384 64.109c-88.511 0-160.274 71.747-160.274 160.273s71.764 160.274 160.274 160.274c88.525 0 160.273-71.748 160.273-160.274S312.909 64.109 224.384 64.109z" fill="currentColor"></path>
                        </svg>
                        <input type="text" placeholder="Search Confluence..." class="w-full outline-none text-sm sm:text-base md:text-lg" id="lptm-search-input" autocomplete="off">
                        <div id="lptm-search-loading" class="hidden ml-2 flex-shrink-0">
                            <div class="animate-spin rounded-full h-4 w-4 sm:h-5 sm:w-5 border-2 border-gray-300 border-t-blue-500"></div>
                        </div>
                    </div>
                </div>

                <!-- Suggestion Buttons -->
                <div class="w-full text-center">
                    <p class="text-sm text-gray-600 mb-5">Quick suggestions to get started:</p>
                    <div class="flex flex-col items-center gap-3">
                        <!-- Top Row -->
                        <div class="flex items-center justify-center gap-3">
                            <a href="learning.html" class="suggestion-link inline-flex items-center gap-2 h-11 px-5 py-2.5 bg-white hover:!bg-blue-50 text-gray-700  rounded-lg text-sm font-medium transition-all cursor-pointer border-2 border-gray-200 hover:border-blue-500 shadow-sm hover:shadow-md no-underline focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600 flex-shrink-0">
                                    <path d="M22 10v6M2 10l10-5 10 5-10 5z"/>
                                    <path d="M6 12v5c3 3 9 3 12 0v-5"/>
                                </svg>
                                Learning & Development
                            </a>
                            <a href="cmps.html" class="suggestion-link inline-flex items-center gap-2 h-11 px-5 py-2.5 bg-white hover:!bg-blue-50 text-gray-700 rounded-lg text-sm font-medium transition-all cursor-pointer border-2 border-gray-200 hover:border-blue-500 shadow-sm hover:shadow-md no-underline focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600 flex-shrink-0">
                                    <line x1="18" x2="18" y1="20" y2="10"/>
                                    <line x1="12" x2="12" y1="20" y2="4"/>
                                    <line x1="6" x2="6" y1="20" y2="14"/>
                                </svg>
                                Data Analytics
                            </a>
                            <a href="projects-tracker.html" class="suggestion-link inline-flex items-center gap-2 h-11 px-5 py-2.5 bg-white hover:!bg-blue-50 text-gray-700 rounded-lg text-sm font-medium transition-all cursor-pointer border-2 border-gray-200 hover:border-blue-500 shadow-sm hover:shadow-md no-underline focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600 flex-shrink-0">
                                    <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                    <path d="M16 13H8"/>
                                    <path d="M16 17H8"/>
                                    <path d="M10 9H8"/>
                                </svg>
                                Process Documentation
                            </a>
                        </div>
                        <!-- Bottom Row -->
                        <div class="flex items-center justify-center gap-3">
                            <a href="blog.html" class="suggestion-link inline-flex items-center gap-2 h-11 px-5 py-2.5 bg-white hover:!bg-blue-50 text-gray-700 rounded-lg text-sm font-medium transition-all cursor-pointer border-2 border-gray-200 hover:border-blue-500 shadow-sm hover:shadow-md no-underline focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600 flex-shrink-0">
                                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                                </svg>
                                Resources
                            </a>
                            <a href="links.html" class="suggestion-link inline-flex items-center gap-2 h-11 px-5 py-2.5 bg-white hover:!bg-blue-50 text-gray-700  rounded-lg text-sm font-medium transition-all cursor-pointer border-2 border-gray-200 hover:border-blue-500 shadow-sm hover:shadow-md no-underline focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600 flex-shrink-0">
                                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                                </svg>
                                Useful Links
                            </a>
                            <a href="trainings.html" class="suggestion-link inline-flex items-center gap-2 h-11 px-5 py-2.5 bg-white hover:!bg-blue-50 text-gray-700  rounded-lg text-sm font-medium transition-all cursor-pointer border-2 border-gray-200 hover:border-blue-500 shadow-sm hover:shadow-md no-underline focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600 flex-shrink-0">
                                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                                </svg>
                                Tools
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </section>
    </main>
</div>

<!-- Search Results Container - Outside main container to prevent clipping -->
<div id="lptm-search-results" class="fixed bg-white rounded-lg border border-gray-200 shadow-lg hidden max-h-80 overflow-y-auto overflow-x-hidden" style="z-index: 10000;">
    <div id="lptm-results-list" class="p-2"></div>
    <div id="lptm-no-results" class="hidden p-4 text-center text-gray-500">
        No results found
    </div>
</div>

<script>
    // LPTM Search Functionality
    const lptmSearchInput = document.getElementById('lptm-search-input');
    const lptmSearchBox = document.getElementById('lptm-search-box');
    const lptmSearchContainer = document.getElementById('lptm-search-container');
    const lptmSearchResults = document.getElementById('lptm-search-results');
    const lptmResultsList = document.getElementById('lptm-results-list');
    const lptmNoResults = document.getElementById('lptm-no-results');
    const lptmSearchLoading = document.getElementById('lptm-search-loading');
    
    let lptmSearchTimeout;
    let lptmCurrentAbortController;

    // Function to position search results dropdown
    function positionSearchResults() {
        if (!lptmSearchBox || !lptmSearchResults) return;
        
        const rect = lptmSearchBox.getBoundingClientRect();
        lptmSearchResults.style.top = `${rect.bottom + 12}px`;
        lptmSearchResults.style.left = `${rect.left}px`;
        lptmSearchResults.style.width = `${rect.width}px`;
    }

    // Reposition on scroll and resize
    window.addEventListener('scroll', positionSearchResults);
    window.addEventListener('resize', positionSearchResults);

    // Configure 6 different Confluence spaces
    const CONFLUENCE_SPACES = [
        { name: 'Credit Management Reporting', space: 'creditmanagementreporting', color: 'blue' },
        { name: 'Credit Information Management', space: 'creditinformationmanagement', color: 'green' },
        { name: 'Credit Service Management', space: 'creditservicemanagement', color: 'purple' },
        { name: 'Deal Closing', space: 'dealclosing', color: 'orange' },
        { name: 'Loan Management', space: 'loanmanagement', color: 'indigo' },
        { name: 'Credit Approval Control', space: 'creditapprovalcontrol', color: 'red' }
    ];

    const CONFLUENCE_BASE_URL = 'https://cedt-confluence.nam.nsroot.net/confluence';

    lptmSearchInput.addEventListener('input', function () {
        const query = this.value.trim();
        
        if (lptmSearchTimeout) {
            clearTimeout(lptmSearchTimeout);
        }

        if (lptmCurrentAbortController) {
            lptmCurrentAbortController.abort();
        }

        if (query.length < 2) {
            hideLptmResults();
            return;
        }

        lptmSearchLoading.classList.remove('hidden');
        
        lptmSearchTimeout = setTimeout(() => {
            performMultiSpaceSearch(query);
        }, 300);
    });

    async function performMultiSpaceSearch(query) {
        try {
            lptmCurrentAbortController = new AbortController();
            
            // Search all spaces in parallel
            const searchPromises = CONFLUENCE_SPACES.map(space => 
                searchConfluenceSpace(query, space)
            );

            const results = await Promise.allSettled(searchPromises);
            
            // Combine all successful results
            const allResults = results
                .filter(result => result.status === 'fulfilled' && result.value.length > 0)
                .flatMap(result => result.value);

            displayLptmResults(allResults, query);
            
        } catch (error) {
            console.error('Multi-space search error:', error);
            showMockLptmResults(query);
        } finally {
            lptmSearchLoading.classList.add('hidden');
        }
    }

    async function searchConfluenceSpace(query, spaceConfig) {
        try {
            // Exclude attachments from search results
            const cqlQuery = `(text ~ "*${query}*" AND space = ${spaceConfig.space} AND type = page)`;
            const encodedCql = encodeURIComponent(cqlQuery);
            const apiUrl = `${CONFLUENCE_BASE_URL}/rest/api/content/search?cql=${encodedCql}&limit=5&expand=space,body.view`;

            const response = await fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                signal: lptmCurrentAbortController.signal,
                credentials: 'include'
            });

            if (!response.ok) {
                return [];
            }

            const data = await response.json();
            
            // Add space config to each result and filter out attachments
            return (data.results || [])
                .filter(result => result.type === 'page')
                .map(result => ({
                    ...result,
                    spaceConfig: spaceConfig
                }));
            
        } catch (error) {
            if (error.name !== 'AbortError') {
                console.error(`Error searching ${spaceConfig.name}:`, error);
            }
            return [];
        }
    }

    function stripHtmlTags(html) {
        if (!html) return '';
        
        // Create a temporary div to parse HTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        
        // Remove script and style tags
        const scripts = tempDiv.querySelectorAll('script, style');
        scripts.forEach(script => script.remove());
        
        // Get text content and clean it up
        let text = tempDiv.textContent || tempDiv.innerText || '';
        
        // Replace multiple spaces with single space
        text = text.replace(/\s+/g, ' ').trim();
        
        return text;
    }

    function displayLptmResults(results, query) {
        lptmResultsList.innerHTML = '';
        
        if (!results || results.length === 0) {
            showLptmNoResults();
            return;
        }

        // Display all results in a simple list
        results.forEach(result => {
            const resultElement = createLptmResultElement(result, query);
            lptmResultsList.appendChild(resultElement);
        });

        showLptmResults();
    }

    function createLptmResultElement(result, query) {
        const div = document.createElement('div');
        div.className = 'p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0';
        
        const pageUrl = result._links && result._links.webui ? `${CONFLUENCE_BASE_URL}${result._links.webui}` : '';
        
        // Extract and clean content
        let excerpt = '';
        if (result.body && result.body.view && result.body.view.value) {
            const cleanText = stripHtmlTags(result.body.view.value);
            excerpt = cleanText.length > 120 ? cleanText.substring(0, 120) + '...' : cleanText;
        } else {
            excerpt = `${result.title} - Content available, click to view`;
        }

        const highlightedTitle = highlightLptmSearchTerms(result.title, query);
        const highlightedExcerpt = highlightLptmSearchTerms(excerpt, query);

        div.innerHTML = `
            <div class="flex items-start">
                <div class="flex-shrink-0 mr-3 mt-1">
                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                <div class="flex-grow min-w-0">
                    <h3 class="text-blue-600 hover:underline font-medium text-sm mb-1 leading-tight">${highlightedTitle}</h3>
                    <p class="text-gray-600 text-xs mb-1 leading-relaxed">${highlightedExcerpt}</p>
                    <div class="flex items-center text-xs text-gray-500">
                        <span class="text-blue-600">${pageUrl}</span>
                    </div>
                </div>
            </div>
        `;

        if (pageUrl) {
            div.addEventListener('click', () => {
                window.open(pageUrl, '_blank');
            });
        }

        return div;
    }

    function highlightLptmSearchTerms(text, query) {
        if (!query || !text) return text;
        const regex = new RegExp(`(${query.split(' ').join('|')})`, 'gi');
        return text.replace(regex, '<mark class="bg-yellow-200 px-1">$1</mark>');
    }

    function showMockLptmResults(query) {
        const mockResults = CONFLUENCE_SPACES.flatMap((space, index) => [
            {
                title: `${query} Documentation - ${space.name}`,
                _links: { webui: `/display/${space.space}/mock-page-${index}` },
                spaceConfig: space,
                body: { view: { value: `<p>This is documentation about ${query} in the ${space.name} space. This content shows how processes and procedures are documented for your reference.</p>` } }
            }
        ]);
        displayLptmResults(mockResults, query);
    }

    function showLptmResults() {
        positionSearchResults();
        lptmNoResults.classList.add('hidden');
        lptmSearchResults.classList.remove('hidden');
    }

    function showLptmNoResults() {
        positionSearchResults();
        lptmNoResults.classList.remove('hidden');
        lptmSearchResults.classList.remove('hidden');
    }

    function hideLptmResults() {
        lptmSearchResults.classList.add('hidden');
        lptmNoResults.classList.add('hidden');
    }

    // Hide results when clicking outside
    document.addEventListener('click', function (event) {
        if (lptmSearchBox && !lptmSearchBox.contains(event.target) && 
            lptmSearchResults && !lptmSearchResults.contains(event.target)) {
            hideLptmResults();
        }
    });

    // Handle escape key
    if (lptmSearchInput) {
        lptmSearchInput.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                hideLptmResults();
                this.blur();
            }
        });
    }

    // Focus search input on page load
    if (lptmSearchInput) {
        lptmSearchInput.focus();
    }

    // Smooth rotating text animation for LPTM title
    const flipWords = ['Hub', 'Portal', 'Center', 'Resource', 'Platform'];
    let currentFlipIndex = 0;
    const flipTextElement = document.getElementById('flip-text');

    function flipText() {
        if (!flipTextElement) return;
        
        // Slide out current word
        flipTextElement.classList.add('slide-out');
        
        // After slide out completes, change text and slide in
        setTimeout(() => {
            currentFlipIndex = (currentFlipIndex + 1) % flipWords.length;
            flipTextElement.textContent = flipWords[currentFlipIndex];
            
            // Remove slide-out and add slide-in
            flipTextElement.classList.remove('slide-out');
            flipTextElement.classList.add('slide-in');
            
            // Clean up slide-in class after animation
            setTimeout(() => {
                flipTextElement.classList.remove('slide-in');
            }, 500);
        }, 500);
    }

    // Start rotating every 3 seconds
    setInterval(flipText, 3000);
</script>

</body>
</html>

