<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Analytics Lending</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- SheetJS for Excel/CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jsVectorMap for world map -->
    <link rel="stylesheet" href="https://unpkg.com/jsvectormap@1.5.3/dist/css/jsvectormap.min.css">
    <script src="https://unpkg.com/jsvectormap@1.5.3/dist/js/jsvectormap.min.js"></script>
    <script src="https://unpkg.com/jsvectormap@1.5.3/dist/maps/world.js"></script>
    <style>
        /* Custom scrollbar styles */
        .custom-scrollbar::-webkit-scrollbar {
            height: 6px;
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-[10000] flex items-center justify-center hidden">
        <div class="bg-white rounded-2xl p-8 shadow-2xl flex flex-col items-center gap-4 max-w-sm mx-4">
            <div class="relative">
                <div class="w-16 h-16 border-4 border-gray-200 border-t-blue-600 rounded-full animate-spin"></div>
            </div>
            <div class="text-center">
                <h3 class="text-lg font-semibold text-gray-900 mb-1">Loading Portfolio Data</h3>
                <p class="text-sm text-gray-500" id="loadingMessage">Please wait while we fetch your data...</p>
                <p class="text-xs text-gray-400 mt-2" id="loadingProgress"></p>
            </div>
        </div>
    </div>

    <div class="p-4 md:p-6">
        <!-- Page Header -->
        <div class="mb-6 rounded-2xl border border-gray-200 bg-white p-6">
            <div class="mb-4">
                <h1 class="text-3xl font-bold text-gray-800">Portfolio Analytics Lending</h1>
                <p class="mt-2 text-gray-600">Comprehensive lending portfolio analysis and metrics</p>
            </div>
            
            <!-- Search and Action Buttons -->
            <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                <div class="flex flex-1 items-center gap-4 flex-wrap">
                    <div class="flex-1 max-w-[512px] min-w-[200px]">
                        <div class="relative">
                            <span class="pointer-events-none absolute top-1/2 left-4 -translate-y-1/2">
                                <svg class="fill-gray-500" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M3.04199 9.37381C3.04199 5.87712 5.87735 3.04218 9.37533 3.04218C12.8733 3.04218 15.7087 5.87712 15.7087 9.37381C15.7087 12.8705 12.8733 15.7055 9.37533 15.7055C5.87735 15.7055 3.04199 12.8705 3.04199 9.37381ZM9.37533 1.54218C5.04926 1.54218 1.54199 5.04835 1.54199 9.37381C1.54199 13.6993 5.04926 17.2055 9.37533 17.2055C11.2676 17.2055 13.0032 16.5346 14.3572 15.4178L17.1773 18.2381C17.4702 18.531 17.945 18.5311 18.2379 18.2382C18.5308 17.9453 18.5309 17.4704 18.238 17.1775L15.4182 14.3575C16.5367 13.0035 17.2087 11.2671 17.2087 9.37381C17.2087 5.04835 13.7014 1.54218 9.37533 1.54218Z" fill=""></path>
                                </svg>
                            </span>
                            <input type="text" id="searchInput" placeholder="Search portfolio..." 
                                class="shadow-sm h-[42px] w-full rounded-lg border border-gray-300 bg-transparent py-2.5 pr-4 pl-[42px] text-sm text-gray-800 placeholder:text-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 focus:outline-none">
                        </div>
                    </div>
                    
                    <!-- Global Level Type Toggle -->
                    <div class="inline-flex w-fit items-center gap-0.5 rounded-lg bg-gray-100 p-0.5">
                        <button id="btnGlobalFacilityLevel" onclick="selectGlobalLevel('facility')" 
                            class="px-3 py-2 font-medium transition-colors rounded-md text-sm shadow-sm text-gray-900 bg-white">
                            Facility Level
                        </button>
                        <button id="btnGlobalCALevel" onclick="selectGlobalLevel('ca')" 
                            class="px-3 py-2 font-medium transition-colors rounded-md text-sm text-gray-500 hover:text-gray-900">
                            CA Level
                        </button>
                    </div>
                    
                    <button onclick="toggleFilterPopover()" id="filterButton"
                        class="relative flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 hover:text-gray-800 transition-all duration-200 ease-in-out hover:scale-105">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                        </svg>
                        <span class="hidden sm:inline">Filters</span>
                        <span id="filterCount" class="hidden absolute -top-2 -right-2 flex h-5 w-5 items-center justify-center rounded-full bg-blue-500 text-xs font-semibold text-white"></span>
                    </button>
                    <button onclick="refreshData()" 
                        class="flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 hover:text-gray-800 transition-all duration-200 ease-in-out hover:scale-105">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <span class="hidden sm:inline">Refresh</span>
                    </button>
                </div>
            </div>

            <!-- Active Filters Badges -->
            <div id="activeFiltersBadges" class="flex flex-wrap gap-2 mt-4 pt-4 border-t border-gray-200" style="display: none;">
                <!-- Badges will be dynamically added here -->
            </div>
        </div>

        <!-- Filter Popover -->
        <div id="filterPopover" class="hidden fixed inset-0 z-[9999] overflow-y-auto">
            <!-- Backdrop -->
            <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity" onclick="toggleFilterPopover()"></div>
            
            <!-- Popover Content -->
            <div class="flex min-h-full items-center justify-center p-4">
                <div class="relative bg-white rounded-2xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                    <!-- Header -->
                    <div class="flex items-center justify-between border-b border-gray-200 px-6 py-4">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800">Filter Portfolio</h3>
                            <p class="text-sm text-gray-500 mt-1">Apply filters to refine your data</p>
                        </div>
                        <button onclick="toggleFilterPopover()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Filter Content -->
                    <div class="overflow-y-auto max-h-[calc(90vh-180px)] px-6 py-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Region Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">Region</label>
                                <select id="filterRegion"
                                    class="w-full h-10 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-800 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 focus:outline-none">
                                    <option value="">All Regions</option>
                                </select>
                            </div>

                            <!-- Product Type Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">Product Program</label>
                                <select id="filterProductProgram"
                                    class="w-full h-10 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-800 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 focus:outline-none">
                                    <option value="">All Products</option>
                                </select>
                            </div>

                            <!-- Extending Unit Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">Extending Unit</label>
                                <select id="filterExtendingUnit"
                                    class="w-full h-10 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-800 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 focus:outline-none">
                                    <option value="">All Units</option>
                                </select>
                            </div>

                            <!-- Facility Type Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">Facility Type</label>
                                <select id="filterFacilityType"
                                    class="w-full h-10 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-800 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 focus:outline-none">
                                    <option value="">All Types</option>
                                </select>
                            </div>

                            <!-- Committed/Uncommitted Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">Commitment Status</label>
                                <select id="filterCommitment"
                                    class="w-full h-10 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-800 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 focus:outline-none">
                                    <option value="">All</option>
                                </select>
                            </div>

                            <!-- Management Status Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">Management Status</label>
                                <select id="filterManagementStatus"
                                    class="w-full h-10 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-800 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 focus:outline-none">
                                    <option value="">All (DM/CM)</option>
                                </select>
                            </div>

                            <!-- Team Lead Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">Team Lead</label>
                                <select id="filterTeamLead"
                                    class="w-full h-10 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-800 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 focus:outline-none">
                                    <option value="">All Team Leads</option>
                                </select>
                            </div>

                            <!-- Underwriter Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">Underwriter</label>
                                <select id="filterUnderwriter"
                                    class="w-full h-10 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-800 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 focus:outline-none">
                                    <option value="">All Underwriters</option>
                                </select>
                            </div>

                            <!-- CA Maturity Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">CAs Maturing</label>
                                <select id="filterCAMaturity"
                                    class="w-full h-10 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-800 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 focus:outline-none">
                                    <option value="">All Dates</option>
                                    <option value="30">Next 30 Days</option>
                                    <option value="60">Next 60 Days</option>
                                    <option value="90">Next 90 Days</option>
                                    <option value="180">Next 6 Months</option>
                                    <option value="365">Next Year</option>
                                </select>
                            </div>

                            <!-- Facility Maturity Filter -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">Facilities Maturing</label>
                                <select id="filterFacilityMaturity"
                                    class="w-full h-10 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-800 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 focus:outline-none">
                                    <option value="">All Dates</option>
                                    <option value="30">Next 30 Days</option>
                                    <option value="60">Next 60 Days</option>
                                    <option value="90">Next 90 Days</option>
                                    <option value="180">Next 6 Months</option>
                                    <option value="365">Next Year</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="flex items-center justify-between border-t border-gray-200 px-6 py-4">
                        <button onclick="clearAllFilters()" 
                            class="text-sm font-medium text-gray-600 hover:text-gray-800">
                            Clear All
                        </button>
                        <div class="flex gap-3">
                            <button onclick="toggleFilterPopover()" 
                                class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900">
                                Cancel
                            </button>
                            <button onclick="applyFiltersAndClose()" 
                                class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">
                                Apply Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top 5 Metric Cards -->
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 md:gap-6 mb-6">
            <!-- Card 1: Total # of Relationships -->
            <div class="rounded-2xl border border-gray-200 bg-white px-6 pb-5 pt-6">
                <div class="mb-6 flex items-center gap-3">
                    <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-blue-100">
                        <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Total # of Relationships</h3>
                    </div>
                </div>
                <div class="flex items-end justify-between">
                    <div>
                        <h4 class="text-2xl font-bold text-gray-800" id="totalRelationships">0</h4>
                    </div>
                </div>
            </div>

            <!-- Card 2: Total # of Facilities -->
            <div class="rounded-2xl border border-gray-200 bg-white px-6 pb-5 pt-6">
                <div class="mb-6 flex items-center gap-3">
                    <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-green-100">
                        <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Total # of Facilities</h3>
                    </div>
                </div>
                <div class="flex items-end justify-between">
                    <div>
                        <h4 class="text-2xl font-bold text-gray-800" id="totalFacilities">0</h4>
                    </div>
                </div>
            </div>

            <!-- Card 3: Total # of CAs -->
            <div class="rounded-2xl border border-gray-200 bg-white px-6 pb-5 pt-6">
                <div class="mb-6 flex items-center gap-3">
                    <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-purple-100">
                        <svg class="h-6 w-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Total # of CAs</h3>
                    </div>
                </div>
                <div class="flex items-end justify-between">
                    <div>
                        <h4 class="text-2xl font-bold text-gray-800" id="totalCAs">0</h4>
                    </div>
                </div>
            </div>

            <!-- Card 4: Total $ of OSUC -->
            <div class="rounded-2xl border border-gray-200 bg-white px-6 pb-5 pt-6">
                <div class="mb-6 flex items-center gap-3">
                    <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-orange-100">
                        <svg class="h-6 w-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Total $ of OSUC</h3>
                    </div>
                </div>
                <div class="flex items-end justify-between">
                    <div>
                        <h4 class="text-2xl font-bold text-gray-800" id="totalOSUC">$0.00</h4>
                    </div>
                </div>
            </div>

            <!-- Card 5: Total $ of Facility Amount -->
            <div class="rounded-2xl border border-gray-200 bg-white px-6 pb-5 pt-6">
                <div class="mb-6 flex items-center gap-3">
                    <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-red-100">
                        <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Total $ of Facility Amount</h3>
                    </div>
                </div>
                <div class="flex items-end justify-between">
                    <div>
                        <h4 class="text-2xl font-bold text-gray-800" id="totalFacAmount">$0.00</h4>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-12 gap-4 md:gap-6 mb-6">
            <!-- Area Chart: Facility IDs/CAIDs by Expiration Date -->
            <div class="col-span-12 xl:col-span-8">
                <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6 sm:pt-6">
                    <div class="flex flex-col gap-4 mb-6 sm:flex-row sm:items-center sm:justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Facilities & CAIDs Expiration Timeline</h3>
                            <p class="mt-1 text-gray-500 text-sm">Monthly expiration count by type</p>
                        </div>
                        <div class="flex flex-row-reverse items-center justify-end gap-0.5 sm:flex-col sm:items-start">
                            <div class="flex flex-row-reverse items-center gap-3 sm:flex-row sm:gap-2">
                                <h4 class="text-2xl font-bold text-gray-800" id="totalExpiring">0</h4>
                                <span class="flex items-center gap-1 rounded-full bg-blue-50 px-2 py-0.5 text-xs font-medium text-blue-600">
                                    Total
                                </span>
                            </div>
                            <span class="text-gray-500 text-xs">Combined Count</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-5 mb-5">
                        <div class="flex items-center gap-1.5">
                            <div class="h-2.5 w-2.5 rounded-full" style="background-color: #465FFF;"></div>
                            <p class="text-sm text-gray-500">Facilities</p>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <div class="h-2.5 w-2.5 rounded-full" style="background-color: #9CB9FF;"></div>
                            <p class="text-sm text-gray-500">CAIDs</p>
                        </div>
                    </div>
                    <div class="max-w-full overflow-x-auto custom-scrollbar">
                        <div id="expirationChart" class="apexcharts-tooltip-active -ml-4 min-w-[1000px] pl-2 xl:min-w-full"></div>
                    </div>
                </div>
            </div>

            <!-- Regional Distribution with Map -->
            <div class="col-span-12 xl:col-span-4">
                <div class="rounded-2xl border border-gray-200 bg-white p-5 sm:p-6">
                    <div class="flex justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Regional Distribution</h3>
                            <p class="mt-1 text-sm text-gray-500">Expiring soon by region</p>
                        </div>
                    </div>
                    <div class="border-gray-200 my-6 overflow-hidden rounded-2xl border bg-gray-50 px-4 py-6 sm:px-6">
                        <div id="mapOne" class="mapOne map-btn -mx-4 -my-6 h-[212px] w-full"></div>
                    </div>
                    <div class="space-y-5" id="regionList">
                        <!-- Regional statistics will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Bar Chart: Top Relationships by Total Facility Amount / Direct OS -->
        <div class="mb-6">
            <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6 sm:pt-5">
                <div class="flex flex-col gap-5 mb-6 sm:flex-row sm:items-center sm:justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">Top Relationships by Amount</h3>
                        <p class="mt-1 text-gray-500 text-sm">View by facility amount or direct outstanding</p>
                    </div>
                    <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
                        <!-- Metric Type Toggle -->
                        <div class="inline-flex w-fit items-center gap-0.5 rounded-lg bg-gray-100 p-0.5">
                            <button id="btnFacilityAmount" onclick="selectMetricType('facilityAmount')" 
                                class="px-3 py-2 font-medium transition-colors rounded-md text-sm shadow-sm text-gray-900 bg-white">
                                Facility Amount
                            </button>
                            <button id="btnDirectOS" onclick="selectMetricType('directOS')" 
                                class="px-3 py-2 font-medium transition-colors rounded-md text-sm text-gray-500 hover:text-gray-900">
                                Direct OS
                            </button>
                        </div>
                        <!-- Top N Selector -->
                        <select id="topNFilter" onchange="updateBarChart()" 
                            class="h-11 rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800">
                            <option value="5">Top 5</option>
                            <option value="10" selected>Top 10</option>
                            <option value="15">Top 15</option>
                            <option value="20">Top 20</option>
                        </select>
                    </div>
                </div>
                <div class="max-w-full overflow-x-auto custom-scrollbar">
                    <div id="relationshipChart" class="min-w-[900px] xl:min-w-full"></div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="overflow-hidden rounded-xl border border-gray-200 bg-white">
            <div class="flex flex-col gap-4 border-b border-gray-200 px-4 py-4 sm:px-5 lg:flex-row lg:items-center lg:justify-between">
                <div class="flex-shrink-0">
                    <h3 class="text-lg font-semibold text-gray-800">Portfolio Details</h3>
                    <p class="text-sm text-gray-500">Detailed lending portfolio data</p>
                </div>
                <div class="flex flex-col gap-4 lg:flex-row lg:items-center">
                    <!-- Export Button -->
                    <button onclick="exportToCSV()" 
                        class="flex h-11 items-center justify-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Export
                    </button>
                </div>
            </div>
            <div class="custom-scrollbar overflow-x-auto">
                <table class="w-full table-auto" id="portfolioTable">
                    <thead>
                        <tr class="border-b border-gray-200 bg-gray-50">
                            <th class="p-4 text-left text-xs font-medium text-gray-500 whitespace-nowrap">Report Date</th>
                            <th class="p-4 text-left text-xs font-medium text-gray-500 whitespace-nowrap">Region</th>
                            <th class="p-4 text-left text-xs font-medium text-gray-500 whitespace-nowrap">Facility ID</th>
                            <th class="p-4 text-left text-xs font-medium text-gray-500 whitespace-nowrap">Relationship Name</th>
                            <th class="p-4 text-left text-xs font-medium text-gray-500 whitespace-nowrap">Product Program</th>
                            <th class="p-4 text-left text-xs font-medium text-gray-500 whitespace-nowrap">Facility Amount</th>
                            <th class="p-4 text-left text-xs font-medium text-gray-500 whitespace-nowrap">Direct OS</th>
                            <th class="p-4 text-left text-xs font-medium text-gray-500 whitespace-nowrap">Maturity Date</th>
                            <th class="p-4 text-left text-xs font-medium text-gray-500 whitespace-nowrap">CA Expiration</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-gray-200">
                        <!-- Table rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="flex w-full flex-col items-center justify-between border-t border-gray-200 px-5 py-4 sm:flex-row">
                <div class="pb-3 sm:pb-0">
                    <span class="block text-sm font-medium text-gray-500">
                        Showing <span class="text-gray-800" id="startRow">0</span> to 
                        <span class="text-gray-800" id="endRow">0</span> of 
                        <span class="text-gray-800" id="totalRows">0</span>
                    </span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="previousPage()" id="prevBtn"
                        class="flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50">
                        Previous
                    </button>
                    <span class="text-sm font-medium text-gray-700">
                        Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                    </span>
                    <button onclick="nextPage()" id="nextBtn"
                        class="flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50">
                        Next
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== PORTFOLIO ANALYTICS CONFIGURATION =====
        // This dashboard loads data from Confluence in READ-ONLY mode
        // Similar to cmps.html, data is fetched from an attachment but never modified
        // All filters and options are dynamically populated from the loaded data
        
        // Update these values to match your Confluence page and attachment
        const CONFLUENCE_PAGE_ID = '2740868871'; // Your Confluence page ID
        const CONFLUENCE_FILE_NAME = 'palDashboard.csv'; // Your attachment filename (can be .csv, .xlsx, or .xls)
        const CONFLUENCE_BASE_URL = 'https://cedt-confluence.net/confluence';
        // ==========================================

        // Global variables
        let portfolioData = [];
        let filteredData = [];
        let currentPage = 1;
        let rowsPerPage = 10; // Start with 10 rows for initial load
        let expirationChartInstance = null;
        let searchDebounceTimer = null;
        let relationshipChartInstance = null;
        let activeFilters = {};
        let selectedMetricType = 'facilityAmount'; // Default to Facility Amount
        let selectedRegionalLevel = 'facility'; // Default to Facility Level (Facility ID count)

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== Portfolio Analytics Dashboard ===');
            console.log('READ-ONLY mode - Loading data from Confluence');
            console.log('Page ID:', CONFLUENCE_PAGE_ID);
            console.log('File:', CONFLUENCE_FILE_NAME);
            console.log('=====================================');
            
            // Load data from Confluence attachment
            loadDataFromCSV();
            
            // Setup search functionality with debouncing
            document.getElementById('searchInput').addEventListener('input', function() {
                // Clear previous timer
                if (searchDebounceTimer) {
                    clearTimeout(searchDebounceTimer);
                }
                
                // Set new timer - wait 300ms after user stops typing
                searchDebounceTimer = setTimeout(() => {
                    filterData();
                }, 300);
            });
        });

        // Refresh data from Confluence (read-only, no write operations)
        async function refreshData() {
            showLoadingState();
            try {
                console.log('Refreshing data from Confluence...');
                const data = await fetchDataFromConfluence();
                
                if (data && data.length > 0) {
                    portfolioData = data;
                    
                    // Repopulate filter options with fresh data
                    populateFilterOptions();
                    
                    // Recalculate all metrics and charts
                    calculateMetrics();
                    createExpirationChart();
                    createRegionalChart();
                    createRelationshipChart();
                    
                    // Reset filters and reload data
                    activeFilters = {};
                    displayFilterBadges();
                    updateFilterCount();
                    filterData();
                    
                    showNotification('Success', `Refreshed ${data.length} records successfully`, 'success');
                } else {
                    console.error('No data received from Confluence');
                    showNotification('Error', 'Failed to refresh data from Confluence', 'error');
                }
            } catch (error) {
                console.error('Error refreshing data:', error);
                showNotification('Error', 'Failed to refresh data: ' + error.message, 'error');
            }
        }

        // Load data from Confluence attachment (read-only)
        async function loadDataFromCSV() {
            showLoadingOverlay('Fetching data from Confluence...', 'Connecting to server...');
            showLoadingState();
            
            try {
                const data = await fetchDataFromConfluence();
                
                if (data && data.length > 0) {
                    portfolioData = data;
                    console.log(`Loaded ${data.length} records from Confluence`);
                    
                    showLoadingOverlay('Processing data...', `Loading ${data.length.toLocaleString()} records...`);
                    
                    // Use setTimeout to allow UI to update
                    setTimeout(() => {
                        initializeDashboard();
                        hideLoadingOverlay();
                        showNotification('Success', `Loaded ${data.length.toLocaleString()} records successfully`, 'success');
                    }, 100);
                } else {
                    console.warn('No data from Confluence, using sample data');
                    hideLoadingOverlay();
                    showNotification('Warning', 'No data found in Confluence attachment', 'warning');
                    loadSampleData();
                }
            } catch (error) {
                console.error('Error loading data from Confluence:', error);
                hideLoadingOverlay();
                showNotification('Warning', 'Failed to load from Confluence, using sample data', 'warning');
                loadSampleData();
            }
        }

        // Fetch data from Confluence attachment (read-only, no updates)
        async function fetchDataFromConfluence() {
            try {
                // Construct Confluence API URL
                const url = `${CONFLUENCE_BASE_URL}/download/attachments/${CONFLUENCE_PAGE_ID}/${CONFLUENCE_FILE_NAME}?api=v2`;
                
                console.log('Fetching portfolio data from Confluence:', url);
                console.log('File name:', CONFLUENCE_FILE_NAME);
                
                const response = await fetch(url, {
                    headers: {
                        'X-Atlassian-Token': 'no-check'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch ${CONFLUENCE_FILE_NAME}: ${response.status} ${response.statusText}`);
                }

                console.log('Successfully fetched file from Confluence');
                const blob = await response.blob();
                console.log('Blob size:', blob.size, 'bytes');
                
                // Parse based on file type
                if (CONFLUENCE_FILE_NAME.endsWith('.csv')) {
                    console.log('Parsing CSV file...');
                    return await parseCSVBlob(blob);
                } else if (CONFLUENCE_FILE_NAME.endsWith('.xlsx') || CONFLUENCE_FILE_NAME.endsWith('.xls')) {
                    console.log('Parsing Excel file...');
                    return await parseExcelBlob(blob);
                }
                
                throw new Error('Unsupported file format. Please use .csv, .xlsx, or .xls files.');

            } catch (error) {
                console.error('Error fetching data from Confluence:', error.message);
                return null;
            }
        }

        // Parse CSV blob (read-only)
        async function parseCSVBlob(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n');
                        const headers = lines[0].split(',').map(h => h.trim());
                        
                        console.log('CSV Headers:', headers);
                        
                        const data = [];
                        for (let i = 1; i < lines.length; i++) {
                            if (lines[i].trim()) {
                                const values = lines[i].split(',');
                                const row = {};
                                headers.forEach((header, index) => {
                                    row[header] = values[index] ? values[index].trim() : '';
                                });
                                // Only add rows with Facility_ID
                                if (row.Facility_ID) {
                                    data.push(row);
                                }
                            }
                        }
                        
                        console.log(`Parsed ${data.length} records from CSV`);
                        resolve(data);
                    } catch (error) {
                        console.error('Error parsing CSV:', error);
                        reject(error);
                    }
                };
                reader.onerror = () => {
                    console.error('FileReader error while reading CSV');
                    reject(new Error('Failed to read CSV file'));
                };
                reader.readAsText(blob);
            });
        }

        // Parse Excel blob (read-only)
        async function parseExcelBlob(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        
                        console.log('Excel Sheet Name:', workbook.SheetNames[0]);
                        
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        
                        console.log(`Total rows in Excel: ${jsonData.length}`);
                        
                        // Filter out empty rows (rows without Facility_ID)
                        const filteredData = jsonData.filter(row => row.Facility_ID);
                        
                        console.log(`Parsed ${filteredData.length} valid records from Excel`);
                        
                        // Log sample data structure for debugging
                        if (filteredData.length > 0) {
                            console.log('Sample record fields:', Object.keys(filteredData[0]));
                        }
                        
                        resolve(filteredData);
                    } catch (error) {
                        console.error('Error parsing Excel:', error);
                        reject(error);
                    }
                };
                reader.onerror = () => {
                    console.error('FileReader error while reading Excel file');
                    reject(new Error('Failed to read Excel file'));
                };
                reader.readAsArrayBuffer(blob);
            });
        }

        // Show loading overlay
        function showLoadingOverlay(message = 'Please wait while we fetch your data...', progress = '') {
            const overlay = document.getElementById('loadingOverlay');
            const messageEl = document.getElementById('loadingMessage');
            const progressEl = document.getElementById('loadingProgress');
            
            if (overlay) {
                overlay.classList.remove('hidden');
                if (messageEl) messageEl.textContent = message;
                if (progressEl) progressEl.textContent = progress;
            }
        }

        // Hide loading overlay
        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
        }

        // Show loading state
        function showLoadingState() {
            const tbody = document.getElementById('tableBody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="py-16">
                            <div class="flex flex-col items-center justify-center">
                                <div class="relative">
                                    <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-200"></div>
                                    <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-600 border-t-transparent absolute top-0 left-0"></div>
                                </div>
                                <div class="mt-6 text-center">
                                    <span class="text-base font-medium text-gray-700">Loading data...</span>
                                    <p class="text-sm text-gray-500 mt-1">Fetching portfolio information from Confluence</p>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        // Show notification
        function showNotification(title, message, type = 'success') {
            const colors = {
                success: { bg: 'bg-green-100', text: 'text-green-600', border: 'border-green-200' },
                error: { bg: 'bg-red-100', text: 'text-red-600', border: 'border-red-200' },
                warning: { bg: 'bg-yellow-100', text: 'text-yellow-600', border: 'border-yellow-200' }
            };
            
            const color = colors[type] || colors.success;
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${color.bg} ${color.border} border ${color.text} px-4 py-3 rounded-lg shadow-lg z-50 max-w-md`;
            notification.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="flex-1">
                        <h4 class="font-semibold">${title}</h4>
                        <p class="text-sm">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Load sample data if CSV is not available
        function loadSampleData() {
            portfolioData = [
                {
                    Report_Date: '2024-01-15',
                    Region: 'NAM',
                    Facility_ID: 'FAC001',
                    Parent_Facility_ID: 'PFAC001',
                    Product_Program: 'Commercial Lending',
                    Management_Status: 'Active',
                    Facility_Type: 'Term Loan',
                    'Committed/Uncommitted': 'Committed',
                    Risk_Category: 'Low',
                    Relationship_ID: 'REL001',
                    Relationship_Name: 'ABC Corporation',
                    CAID: 'CAID001',
                    Lead_Underwriter: 'John Smith',
                    Underwriting_Team_Lead: 'Jane Doe',
                    Control_Unit: 'CU-001',
                    Fac_Amount: '5000000',
                    Total_Reported_Fac_Amount: '5000000',
                    Direct_OS: '3000000',
                    Contingent_OS: '500000',
                    PSE_OS: '0',
                    Unused_Committed: '1500000',
                    Total_Comm_Exposure: '5000000',
                    Maturity_Date: '2025-12-31',
                    Prodict_Underwriter: 'John Smith',
                    CA_Expiration_Date: '2025-06-30'
                },
                // Add more sample data as needed
            ];
            initializeDashboard();
        }

        // Initialize dashboard with data (optimized for large datasets)
        function initializeDashboard() {
            const startTime = performance.now();
            console.log('Initializing dashboard with', portfolioData.length, 'records...');
            
            // Step 1: Populate filters
            console.time('Populate Filters');
            populateFilterOptions();
            console.timeEnd('Populate Filters');
            
            // Step 2: Calculate metrics
            console.time('Calculate Metrics');
            calculateMetrics();
            console.timeEnd('Calculate Metrics');
            
            // Step 3: Create charts (batch these as they're expensive)
            console.time('Create Charts');
            createExpirationChart();
            createRegionalChart();
            createRelationshipChart();
            console.timeEnd('Create Charts');
            
            // Step 4: Filter and render table
            console.time('Filter and Render Table');
            filterData();
            console.timeEnd('Filter and Render Table');
            
            const endTime = performance.now();
            console.log(`Dashboard initialized in ${((endTime - startTime) / 1000).toFixed(2)} seconds`);
        }

        // Populate filter dropdowns with unique values from Confluence data (read-only)
        function populateFilterOptions() {
            if (!portfolioData || portfolioData.length === 0) {
                console.warn('No portfolio data available to populate filters');
                return;
            }

            console.log('Populating filter options from', portfolioData.length, 'records');
            
            // Region
            const regions = [...new Set(portfolioData.map(row => row.Region).filter(Boolean))].sort();
            populateSelect('filterRegion', regions);
            console.log('Regions:', regions.length, 'options');
            
            // Product Program
            const products = [...new Set(portfolioData.map(row => row.Product_Program).filter(Boolean))].sort();
            populateSelect('filterProductProgram', products);
            console.log('Product Programs:', products.length, 'options');
            
            // Extending Unit (Control_Unit)
            const units = [...new Set(portfolioData.map(row => row.Control_Unit).filter(Boolean))].sort();
            populateSelect('filterExtendingUnit', units);
            console.log('Extending Units:', units.length, 'options');
            
            // Facility Type
            const facilityTypes = [...new Set(portfolioData.map(row => row.Facility_Type).filter(Boolean))].sort();
            populateSelect('filterFacilityType', facilityTypes);
            console.log('Facility Types:', facilityTypes.length, 'options');
            
            // Committed/Uncommitted
            const commitments = [...new Set(portfolioData.map(row => row['Committed/Uncommitted']).filter(Boolean))].sort();
            populateSelect('filterCommitment', commitments);
            console.log('Commitment Status:', commitments.length, 'options');
            
            // Management Status (DM/CM)
            const statuses = [...new Set(portfolioData.map(row => row.Management_Status).filter(Boolean))].sort();
            populateSelect('filterManagementStatus', statuses);
            console.log('Management Status:', statuses.length, 'options');
            
            // Team Lead (Underwriter_Team_Lead)
            const teamLeads = [...new Set(portfolioData.map(row => row.Underwriting_Team_Lead).filter(Boolean))].sort();
            populateSelect('filterTeamLead', teamLeads);
            console.log('Team Leads:', teamLeads.length, 'options');
            
            // Underwriter (Lead_Underwriter)
            const underwriters = [...new Set(portfolioData.map(row => row.Lead_Underwriter).filter(Boolean))].sort();
            populateSelect('filterUnderwriter', underwriters);
            console.log('Underwriters:', underwriters.length, 'options');
        }

        // Helper to populate a select element
        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) {
                console.warn(`Select element with id '${selectId}' not found`);
                return;
            }
            const currentValue = select.value;
            
            // Keep the first option (All...)
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                select.appendChild(opt);
            });
            
            // Restore previous value if it still exists
            if (currentValue && options.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // Apply all filters
        function applyFilters() {
            const filters = {
                region: document.getElementById('filterRegion').value,
                productProgram: document.getElementById('filterProductProgram').value,
                extendingUnit: document.getElementById('filterExtendingUnit').value,
                facilityType: document.getElementById('filterFacilityType').value,
                commitment: document.getElementById('filterCommitment').value,
                managementStatus: document.getElementById('filterManagementStatus').value,
                teamLead: document.getElementById('filterTeamLead').value,
                underwriter: document.getElementById('filterUnderwriter').value,
                caMaturity: document.getElementById('filterCAMaturity').value,
                facilityMaturity: document.getElementById('filterFacilityMaturity').value
            };
            
            // Update active filters object
            activeFilters = {};
            if (filters.region) activeFilters['Region'] = filters.region;
            if (filters.productProgram) activeFilters['Product Program'] = filters.productProgram;
            if (filters.extendingUnit) activeFilters['Extending Unit'] = filters.extendingUnit;
            if (filters.facilityType) activeFilters['Facility Type'] = filters.facilityType;
            if (filters.commitment) activeFilters['Commitment Status'] = filters.commitment;
            if (filters.managementStatus) activeFilters['Management Status'] = filters.managementStatus;
            if (filters.teamLead) activeFilters['Team Lead'] = filters.teamLead;
            if (filters.underwriter) activeFilters['Underwriter'] = filters.underwriter;
            if (filters.caMaturity) {
                const days = filters.caMaturity;
                activeFilters['CAs Maturing'] = days === '30' ? 'Next 30 Days' :
                                               days === '60' ? 'Next 60 Days' :
                                               days === '90' ? 'Next 90 Days' :
                                               days === '180' ? 'Next 6 Months' : 'Next Year';
            }
            if (filters.facilityMaturity) {
                const days = filters.facilityMaturity;
                activeFilters['Facilities Maturing'] = days === '30' ? 'Next 30 Days' :
                                                       days === '60' ? 'Next 60 Days' :
                                                       days === '90' ? 'Next 90 Days' :
                                                       days === '180' ? 'Next 6 Months' : 'Next Year';
            }
            
            // Display filter badges and update count
            displayFilterBadges();
            updateFilterCount();
            
            // Filter the data
            filteredData = portfolioData.filter(row => {
                // Region filter
                if (filters.region && row.Region !== filters.region) return false;
                
                // Product Program filter
                if (filters.productProgram && row.Product_Program !== filters.productProgram) return false;
                
                // Extending Unit filter
                if (filters.extendingUnit && row.Control_Unit !== filters.extendingUnit) return false;
                
                // Facility Type filter
                if (filters.facilityType && row.Facility_Type !== filters.facilityType) return false;
                
                // Commitment filter
                if (filters.commitment && row['Committed/Uncommitted'] !== filters.commitment) return false;
                
                // Management Status filter
                if (filters.managementStatus && row.Management_Status !== filters.managementStatus) return false;
                
                // Team Lead filter
                if (filters.teamLead && row.Underwriting_Team_Lead !== filters.teamLead) return false;
                
                // Underwriter filter
                if (filters.underwriter && row.Lead_Underwriter !== filters.underwriter) return false;
                
                // CA Maturity filter (date range)
                if (filters.caMaturity) {
                    const caDate = parseDate(row.CA_Expiration_Date);
                    if (!caDate) return false;
                    const today = new Date();
                    const futureDate = new Date(today.getTime() + parseInt(filters.caMaturity) * 24 * 60 * 60 * 1000);
                    if (caDate < today || caDate > futureDate) return false;
                }
                
                // Facility Maturity filter (date range)
                if (filters.facilityMaturity) {
                    const maturityDate = parseDate(row.Maturity_Date);
                    if (!maturityDate) return false;
                    const today = new Date();
                    const futureDate = new Date(today.getTime() + parseInt(filters.facilityMaturity) * 24 * 60 * 60 * 1000);
                    if (maturityDate < today || maturityDate > futureDate) return false;
                }
                
                return true;
            });
            
            // Apply search filter if there is one
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filteredData = filteredData.filter(row => {
                    return Object.values(row).some(value => 
                        String(value).toLowerCase().includes(searchTerm)
                    );
                });
            }
            
            // Recalculate metrics and charts with filtered data
            calculateMetricsFromFiltered();
            createExpirationChartFromFiltered();
            createRegionalChartFromFiltered();
            createRelationshipChartFromFiltered();
            
            // Reset to first page and render table
            currentPage = 1;
            renderTable();
        }

        // Display filter badges
        function displayFilterBadges() {
            const badgesContainer = document.getElementById('activeFiltersBadges');
            badgesContainer.innerHTML = '';
            
            if (Object.keys(activeFilters).length === 0) {
                badgesContainer.style.display = 'none';
                return;
            }
            
            badgesContainer.style.display = 'flex';
            
            Object.entries(activeFilters).forEach(([label, value]) => {
                const badge = document.createElement('span');
                badge.className = 'inline-flex items-center bg-white text-sm text-gray-600 border border-gray-300 rounded-lg gap-x-2 py-1.5 pl-3 pr-1';
                badge.innerHTML = `
                    <span class="text-gray-600">${label}</span>
                    <span class="h-4 w-px bg-gray-300"></span>
                    <span class="font-medium text-gray-800">${value}</span>
                    <button type="button" onclick="removeFilter('${label}')" 
                        class="flex h-5 w-5 items-center justify-center rounded text-gray-500 hover:bg-gray-100 hover:text-gray-700"
                        aria-label="Remove">
                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                `;
                badgesContainer.appendChild(badge);
            });
        }

        // Remove a specific filter
        function removeFilter(label) {
            const filterMap = {
                'Region': 'filterRegion',
                'Product Program': 'filterProductProgram',
                'Extending Unit': 'filterExtendingUnit',
                'Facility Type': 'filterFacilityType',
                'Commitment Status': 'filterCommitment',
                'Management Status': 'filterManagementStatus',
                'Team Lead': 'filterTeamLead',
                'Underwriter': 'filterUnderwriter',
                'CAs Maturing': 'filterCAMaturity',
                'Facilities Maturing': 'filterFacilityMaturity'
            };
            
            const selectId = filterMap[label];
            if (selectId) {
                document.getElementById(selectId).value = '';
                applyFilters();
            }
        }

        // Clear all filters
        function clearAllFilters() {
            document.getElementById('filterRegion').value = '';
            document.getElementById('filterProductProgram').value = '';
            document.getElementById('filterExtendingUnit').value = '';
            document.getElementById('filterFacilityType').value = '';
            document.getElementById('filterCommitment').value = '';
            document.getElementById('filterManagementStatus').value = '';
            document.getElementById('filterTeamLead').value = '';
            document.getElementById('filterUnderwriter').value = '';
            document.getElementById('filterCAMaturity').value = '';
            document.getElementById('filterFacilityMaturity').value = '';
            
            activeFilters = {};
            applyFilters();
            updateFilterCount();
        }

        // Store temporary filter state when opening popover
        let tempFilterState = {};

        // Toggle filter popover
        function toggleFilterPopover() {
            const popover = document.getElementById('filterPopover');
            if (popover.classList.contains('hidden')) {
                // Opening popover - save current filter state
                tempFilterState = {
                    region: document.getElementById('filterRegion').value,
                    productProgram: document.getElementById('filterProductProgram').value,
                    extendingUnit: document.getElementById('filterExtendingUnit').value,
                    facilityType: document.getElementById('filterFacilityType').value,
                    commitment: document.getElementById('filterCommitment').value,
                    managementStatus: document.getElementById('filterManagementStatus').value,
                    teamLead: document.getElementById('filterTeamLead').value,
                    underwriter: document.getElementById('filterUnderwriter').value,
                    caMaturity: document.getElementById('filterCAMaturity').value,
                    facilityMaturity: document.getElementById('filterFacilityMaturity').value
                };
                
                popover.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            } else {
                // Closing popover - restore previous filter state (cancel changes)
                document.getElementById('filterRegion').value = tempFilterState.region || '';
                document.getElementById('filterProductProgram').value = tempFilterState.productProgram || '';
                document.getElementById('filterExtendingUnit').value = tempFilterState.extendingUnit || '';
                document.getElementById('filterFacilityType').value = tempFilterState.facilityType || '';
                document.getElementById('filterCommitment').value = tempFilterState.commitment || '';
                document.getElementById('filterManagementStatus').value = tempFilterState.managementStatus || '';
                document.getElementById('filterTeamLead').value = tempFilterState.teamLead || '';
                document.getElementById('filterUnderwriter').value = tempFilterState.underwriter || '';
                document.getElementById('filterCAMaturity').value = tempFilterState.caMaturity || '';
                document.getElementById('filterFacilityMaturity').value = tempFilterState.facilityMaturity || '';
                
                popover.classList.add('hidden');
                document.body.style.overflow = ''; // Restore scrolling
            }
        }

        // Apply filters and close popover
        function applyFiltersAndClose() {
            applyFilters();
            // Close popover without restoring state (we're applying changes)
            const popover = document.getElementById('filterPopover');
            popover.classList.add('hidden');
            document.body.style.overflow = '';
        }

        // Update filter count badge
        function updateFilterCount() {
            const count = Object.keys(activeFilters).length;
            const badge = document.getElementById('filterCount');
            
            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // Calculate metrics from filtered data
        function calculateMetricsFromFiltered() {
            // Total Facility Amount
            const totalFacAmount = filteredData.reduce((sum, row) => {
                return sum + (parseFloat(row.Fac_Amount) || 0);
            }, 0);
            
            // Total OSUC from filtered data
            const totalOSUC = filteredData.reduce((sum, row) => {
                return sum + (parseFloat(row.Total_Comm_Exposure) || 0);
            }, 0);
            
            // Total Number of Relationships
            const uniqueRelationships = new Set(
                filteredData
                    .map(row => row.Relationship_ID || row.Relationship_Name)
                    .filter(Boolean)
            ).size;
            
            // Total Number of Facilities
            const uniqueFacilities = new Set(
                filteredData
                    .map(row => row.Facility_ID)
                    .filter(Boolean)
            ).size;
            
            // Total Number of CAs
            const uniqueCAs = new Set(
                filteredData
                    .map(row => row.CAID)
                    .filter(Boolean)
            ).size;
            
            document.getElementById('totalRelationships').textContent = uniqueRelationships.toLocaleString();
            document.getElementById('totalFacilities').textContent = uniqueFacilities.toLocaleString();
            document.getElementById('totalCAs').textContent = uniqueCAs.toLocaleString();
            document.getElementById('totalOSUC').textContent = formatCurrency(totalOSUC);
            document.getElementById('totalFacAmount').textContent = formatCurrency(totalFacAmount);
        }

        // Create expiration chart from filtered data
        function createExpirationChartFromFiltered() {
            const facilityData = aggregateByMonthYear(filteredData, 'Maturity_Date');
            const caidData = aggregateByMonthYear(filteredData.filter(r => r.CA_Expiration_Date), 'CA_Expiration_Date');
            
            const allMonths = [...new Set([...facilityData.map(d => d.month), ...caidData.map(d => d.month)])].sort();
            
            const facilitySeries = allMonths.map(month => {
                const item = facilityData.find(d => d.month === month);
                return item ? item.count : 0;
            });
            
            const caidSeries = allMonths.map(month => {
                const item = caidData.find(d => d.month === month);
                return item ? item.count : 0;
            });
            
            const totalExpiring = facilitySeries.reduce((a, b) => a + b, 0) + caidSeries.reduce((a, b) => a + b, 0);
            document.getElementById('totalExpiring').textContent = totalExpiring.toLocaleString();
            
            const options = {
                series: [
                    {
                        name: 'Facilities',
                        data: facilitySeries
                    },
                    {
                        name: 'CAIDs',
                        data: caidSeries
                    }
                ],
                legend: {
                    show: false,
                    position: 'top',
                    horizontalAlign: 'left'
                },
                colors: ['#465FFF', '#9CB9FF'],
                chart: {
                    fontFamily: 'system-ui, -apple-system, sans-serif',
                    height: 310,
                    type: 'area',
                    toolbar: {
                        show: false
                    }
                },
                fill: {
                    gradient: {
                        enabled: true,
                        opacityFrom: 0.55,
                        opacityTo: 0
                    }
                },
                stroke: {
                    curve: 'smooth',
                    width: [2, 2]
                },
                markers: {
                    size: 0
                },
                labels: {
                    show: false,
                    position: 'top'
                },
                grid: {
                    xaxis: {
                        lines: {
                            show: false
                        }
                    },
                    yaxis: {
                        lines: {
                            show: true
                        }
                    }
                },
                dataLabels: {
                    enabled: false
                },
                tooltip: {
                    x: {
                        formatter: function(value, { dataPointIndex }) {
                            const monthStr = allMonths[dataPointIndex];
                            if (monthStr) {
                                const date = new Date(monthStr + '-01');
                                return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                            }
                            return value;
                        }
                    }
                },
                xaxis: {
                    type: 'category',
                    categories: allMonths.map(m => {
                        const date = new Date(m + '-01');
                        return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    }),
                    axisBorder: {
                        show: false
                    },
                    axisTicks: {
                        show: false
                    }
                },
                yaxis: {
                    title: {
                        style: {
                            fontSize: '0px'
                        }
                    }
                }
            };

            if (expirationChartInstance) {
                expirationChartInstance.destroy();
            }
            expirationChartInstance = new ApexCharts(document.querySelector("#expirationChart"), options);
            expirationChartInstance.render();
        }

        // Create regional chart from filtered data
        function createRegionalChartFromFiltered() {
            initializeMapFromFiltered();
            
            const regionCounts = getRegionCountsFromFiltered();
            const totalCount = Object.values(regionCounts).reduce((a, b) => a + b, 0);
            
            const sortedRegions = Object.entries(regionCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const regionInfo = {
                'NAM': { name: 'North America', color: 'bg-blue-500' },
                'EMEA': { name: 'Europe & Middle East', color: 'bg-green-500' },
                'APAC': { name: 'Asia Pacific', color: 'bg-orange-500' },
                'LATAM': { name: 'Latin America', color: 'bg-purple-500' },
                'MEA': { name: 'Middle East & Africa', color: 'bg-red-500' }
            };
            
            const regionList = document.getElementById('regionList');
            regionList.innerHTML = '';
            
            const countLabel = selectedRegionalLevel === 'facility' ? 'Facilities' : 'CAIDs';
            
            sortedRegions.forEach(([region, count]) => {
                const percentage = totalCount > 0 ? ((count / totalCount) * 100).toFixed(0) : 0;
                const info = regionInfo[region] || { name: region, color: 'bg-gray-500' };
                
                const regionItem = document.createElement('div');
                regionItem.className = 'flex items-center justify-between';
                regionItem.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 flex items-center justify-center rounded-full ${info.color} text-white font-semibold text-xs">
                            ${region}
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-gray-800">${info.name}</p>
                            <span class="block text-xs text-gray-500">${count} ${countLabel}</span>
                        </div>
                    </div>
                    <div class="flex w-full max-w-[140px] items-center gap-3">
                        <div class="relative block h-2 w-full max-w-[100px] rounded-sm bg-gray-200">
                            <div class="absolute left-0 top-0 flex h-full items-center justify-center rounded-sm bg-blue-500 text-xs font-medium text-white"
                                style="width: ${percentage}%"></div>
                        </div>
                        <p class="text-sm font-medium text-gray-800">${percentage}%</p>
                    </div>
                `;
                regionList.appendChild(regionItem);
            });
        }

        // Initialize map from filtered data
        function initializeMapFromFiltered() {
            try {
                const mapElement = document.getElementById('mapOne');
                if (!mapElement) {
                    console.warn('Map element #mapOne not found, skipping filtered map initialization');
                    return;
                }
                
                // Check if jsVectorMap is available
                if (typeof jsVectorMap === 'undefined') {
                    console.warn('jsVectorMap library not loaded, skipping filtered map initialization');
                    return;
                }
                
                const regionCoords = {
                    'NAM': [37.0902, -95.7129],
                    'EMEA': [51.5074, -0.1278],
                    'APAC': [35.6762, 139.6503],
                    'LATAM': [-23.5505, -46.6333],
                    'MEA': [25.2048, 55.2708]
                };
                
                const regionCounts = getRegionCountsFromFiltered();
                console.log('Filtered region counts for map:', regionCounts);
                
                const markers = [];
                
                Object.keys(regionCounts).forEach(region => {
                    if (regionCoords[region]) {
                        markers.push({
                            name: region,
                            coords: regionCoords[region]
                        });
                    }
                });
                
                // Clear existing map content but keep the element
                mapElement.innerHTML = '';
                
                // Small delay to ensure DOM is ready
                setTimeout(() => {
                    const map = new jsVectorMap({
                        selector: '#mapOne',
                        map: 'world',
                        zoomButtons: false,
                        regionStyle: {
                            initial: {
                                fill: '#D9D9D9'
                            },
                            hover: {
                                fillOpacity: 1,
                                fill: '#465fff'
                            }
                        },
                        markers: markers,
                        markerStyle: {
                            initial: {
                                strokeWidth: 1,
                        fill: '#465fff',
                        fillOpacity: 1,
                        r: 4
                    },
                    hover: {
                        fill: '#465fff',
                        fillOpacity: 1
                    }
                }
            });
                }, 50); // Small delay to ensure DOM is ready
            } catch (error) {
                console.error('Error initializing filtered map:', error);
                // Map is optional, continue without it
            }
        }

        // Get region counts from filtered data
        function getRegionCountsFromFiltered() {
            const regionCounts = {};
            const today = new Date();
            const threeMonthsLater = new Date(today.getTime() + 90 * 24 * 60 * 60 * 1000);
            
            if (selectedRegionalLevel === 'facility') {
                // Count unique Facility IDs
                const regionFacilities = {};
                filteredData.forEach(row => {
                    const maturityDate = parseDate(row.Maturity_Date);
                    if (maturityDate && maturityDate <= threeMonthsLater && maturityDate >= today) {
                        const region = row.Region || 'Unknown';
                        const facilityId = row.Facility_ID;
                        
                        if (!regionFacilities[region]) {
                            regionFacilities[region] = new Set();
                        }
                        if (facilityId) {
                            regionFacilities[region].add(facilityId);
                        }
                    }
                });
                
                // Convert Set sizes to counts
                Object.keys(regionFacilities).forEach(region => {
                    regionCounts[region] = regionFacilities[region].size;
                });
            } else {
                // Count unique CAIDs
                const regionCAIDs = {};
                filteredData.forEach(row => {
                    const caExpDate = parseDate(row.CA_Expiration_Date);
                    if (caExpDate && caExpDate <= threeMonthsLater && caExpDate >= today) {
                        const region = row.Region || 'Unknown';
                        const caid = row.CAID;
                        
                        if (!regionCAIDs[region]) {
                            regionCAIDs[region] = new Set();
                        }
                        if (caid) {
                            regionCAIDs[region].add(caid);
                        }
                    }
                });
                
                // Convert Set sizes to counts
                Object.keys(regionCAIDs).forEach(region => {
                    regionCounts[region] = regionCAIDs[region].size;
                });
            }
            
            return regionCounts;
        }

        // Create relationship chart from filtered data
        function createRelationshipChartFromFiltered() {
            const topN = parseInt(document.getElementById('topNFilter').value);
            console.log('Creating filtered relationship chart with topN:', topN, 'metric:', selectedMetricType);
            
            // Determine which field to aggregate based on selected metric
            const fieldName = selectedMetricType === 'facilityAmount' ? 'Fac_Amount' : 'Direct_OS';
            const seriesName = selectedMetricType === 'facilityAmount' ? 'Total Facility Amount' : 'Total Direct OS';
            
            const relationshipTotals = {};
            filteredData.forEach((row, index) => {
                // Try multiple possible field names for relationship
                const relId = row.Relationship_Name || row.Relationship_ID || row.relationship_name || 
                             row.relationship_id || row['Relationship Name'] || row['Relationship ID'] || 'Unknown';
                const amount = parseFloat(row[fieldName]) || 0;
                
                if (amount > 0) {
                    relationshipTotals[relId] = (relationshipTotals[relId] || 0) + amount;
                }
            });
            
            console.log('Filtered relationships found:', Object.keys(relationshipTotals).length);
            console.log('Filtered relationship totals sample:', Object.entries(relationshipTotals).slice(0, 5));
            
            const sorted = Object.entries(relationshipTotals)
                .filter(([name, amount]) => name !== 'Unknown' && amount > 0)
                .sort((a, b) => b[1] - a[1])
                .slice(0, topN);
            
            console.log('Top filtered relationships:', sorted.slice(0, 3));
            
            const relationships = sorted.map(item => item[0]);
            const amounts = sorted.map(item => item[1]);
            
            const options = {
                series: [{
                    name: seriesName,
                    data: amounts
                }],
                chart: {
                    type: 'bar',
                    height: 400,
                    toolbar: { show: true }
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        borderRadius: 4
                    }
                },
                colors: ['#3B82F6'],
                xaxis: {
                    categories: relationships,
                    labels: {
                        formatter: function(val) {
                            return formatCurrency(val);
                        }
                    }
                },
                dataLabels: {
                    enabled: false
                },
                grid: {
                    borderColor: '#E5E7EB'
                },
                tooltip: {
                    y: {
                        formatter: function(val) {
                            return formatCurrency(val);
                        }
                    }
                }
            };

            try {
                const chartElement = document.querySelector("#relationshipChart");
                if (!chartElement) {
                    console.error('Relationship chart element not found');
                    return;
                }
                
                if (relationshipChartInstance) {
                    relationshipChartInstance.destroy();
                }
                relationshipChartInstance = new ApexCharts(chartElement, options);
                relationshipChartInstance.render();
                console.log('Filtered relationship chart rendered successfully');
            } catch (error) {
                console.error('Error creating filtered relationship chart:', error);
            }
        }

        // Select global level (affects all charts)
        function selectGlobalLevel(level) {
            selectedRegionalLevel = level;
            
            // Update button styles
            const btnGlobalFacilityLevel = document.getElementById('btnGlobalFacilityLevel');
            const btnGlobalCALevel = document.getElementById('btnGlobalCALevel');
            
            if (level === 'facility') {
                btnGlobalFacilityLevel.className = 'px-3 py-2 font-medium transition-colors rounded-md text-sm shadow-sm text-gray-900 bg-white';
                btnGlobalCALevel.className = 'px-3 py-2 font-medium transition-colors rounded-md text-sm text-gray-500 hover:text-gray-900';
            } else {
                btnGlobalFacilityLevel.className = 'px-3 py-2 font-medium transition-colors rounded-md text-sm text-gray-500 hover:text-gray-900';
                btnGlobalCALevel.className = 'px-3 py-2 font-medium transition-colors rounded-md text-sm shadow-sm text-gray-900 bg-white';
            }
            
            // Update ALL charts based on the global level
            if (Object.keys(activeFilters).length > 0) {
                createExpirationChartFromFiltered();
                createRegionalChartFromFiltered();
            } else {
                createExpirationChart();
                createRegionalChart();
            }
        }

        // Calculate top metrics
        function calculateMetrics() {
            // Total Facility Amount
            const totalFacAmount = portfolioData.reduce((sum, row) => {
                return sum + (parseFloat(row.Fac_Amount) || 0);
            }, 0);
            
            // Total OSUC (Outstanding + Unused Committed = Total_Comm_Exposure)
            const totalOSUC = portfolioData.reduce((sum, row) => {
                return sum + (parseFloat(row.Total_Comm_Exposure) || 0);
            }, 0);
            
            // Total Number of Relationships
            const uniqueRelationships = new Set(
                portfolioData
                    .map(row => row.Relationship_ID || row.Relationship_Name)
                    .filter(Boolean)
            ).size;
            
            // Total Number of Facilities
            const uniqueFacilities = new Set(
                portfolioData
                    .map(row => row.Facility_ID)
                    .filter(Boolean)
            ).size;
            
            // Total Number of CAs
            const uniqueCAs = new Set(
                portfolioData
                    .map(row => row.CAID)
                    .filter(Boolean)
            ).size;
            
            document.getElementById('totalRelationships').textContent = uniqueRelationships.toLocaleString();
            document.getElementById('totalFacilities').textContent = uniqueFacilities.toLocaleString();
            document.getElementById('totalCAs').textContent = uniqueCAs.toLocaleString();
            document.getElementById('totalOSUC').textContent = formatCurrency(totalOSUC);
            document.getElementById('totalFacAmount').textContent = formatCurrency(totalFacAmount);
            
            console.log('Metrics calculated:', {
                relationships: uniqueRelationships,
                facilities: uniqueFacilities,
                cas: uniqueCAs,
                osuc: totalOSUC,
                facAmount: totalFacAmount
            });
        }

        // Format currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = parseDate(dateString);
            if (!date) return 'N/A';
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        // Create expiration timeline chart (Area chart with both series)
        function createExpirationChart() {
            const facilityData = aggregateByMonthYear(portfolioData, 'Maturity_Date');
            const caidData = aggregateByMonthYear(portfolioData.filter(r => r.CA_Expiration_Date), 'CA_Expiration_Date');
            
            // Merge both datasets to have consistent months
            const allMonths = [...new Set([...facilityData.map(d => d.month), ...caidData.map(d => d.month)])].sort();
            
            const facilitySeries = allMonths.map(month => {
                const item = facilityData.find(d => d.month === month);
                return item ? item.count : 0;
            });
            
            const caidSeries = allMonths.map(month => {
                const item = caidData.find(d => d.month === month);
                return item ? item.count : 0;
            });
            
            // Calculate total expiring
            const totalExpiring = facilitySeries.reduce((a, b) => a + b, 0) + caidSeries.reduce((a, b) => a + b, 0);
            document.getElementById('totalExpiring').textContent = totalExpiring.toLocaleString();
            
            const options = {
                series: [
                    {
                        name: 'Facilities',
                        data: facilitySeries
                    },
                    {
                        name: 'CAIDs',
                        data: caidSeries
                    }
                ],
                legend: {
                    show: false,
                    position: 'top',
                    horizontalAlign: 'left'
                },
                colors: ['#465FFF', '#9CB9FF'],
                chart: {
                    fontFamily: 'system-ui, -apple-system, sans-serif',
                    height: 310,
                    type: 'area',
                    toolbar: {
                        show: false
                    }
                },
                fill: {
                    gradient: {
                        enabled: true,
                        opacityFrom: 0.55,
                        opacityTo: 0
                    }
                },
                stroke: {
                    curve: 'smooth',
                    width: [2, 2]
                },
                markers: {
                    size: 0
                },
                labels: {
                    show: false,
                    position: 'top'
                },
                grid: {
                    xaxis: {
                        lines: {
                            show: false
                        }
                    },
                    yaxis: {
                        lines: {
                            show: true
                        }
                    }
                },
                dataLabels: {
                    enabled: false
                },
                tooltip: {
                    x: {
                        formatter: function(value, { dataPointIndex }) {
                            const monthStr = allMonths[dataPointIndex];
                            if (monthStr) {
                                const date = new Date(monthStr + '-01');
                                return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                            }
                            return value;
                        }
                    }
                },
                xaxis: {
                    type: 'category',
                    categories: allMonths.map(m => {
                        const date = new Date(m + '-01');
                        return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    }),
                    axisBorder: {
                        show: false
                    },
                    axisTicks: {
                        show: false
                    }
                },
                yaxis: {
                    title: {
                        style: {
                            fontSize: '0px'
                        }
                    }
                }
            };

            if (expirationChartInstance) {
                expirationChartInstance.destroy();
            }
            expirationChartInstance = new ApexCharts(document.querySelector("#expirationChart"), options);
            expirationChartInstance.render();
        }

        // Parse date in dd/mm/yyyy format
        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            try {
                // Handle dd/mm/yyyy format
                if (dateStr.includes('/')) {
                    const parts = dateStr.split('/');
                    if (parts.length === 3) {
                        const day = parseInt(parts[0]);
                        const month = parseInt(parts[1]) - 1; // JavaScript months are 0-indexed
                        const year = parseInt(parts[2]);
                        const date = new Date(year, month, day);
                        if (!isNaN(date.getTime())) {
                            return date;
                        }
                    }
                }
                
                // Try standard date parsing as fallback
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    return date;
                }
            } catch (e) {
                console.warn('Invalid date:', dateStr);
            }
            return null;
        }

        // Aggregate data by month and year
        function aggregateByMonthYear(data, dateField) {
            const grouped = {};
            data.forEach(row => {
                const dateValue = row[dateField];
                if (dateValue) {
                    const dateObj = parseDate(dateValue);
                    if (dateObj) {
                        // Format as YYYY-MM
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                        const monthYear = `${year}-${month}`;
                        grouped[monthYear] = (grouped[monthYear] || 0) + 1;
                    }
                }
            });
            
            return Object.entries(grouped)
                .map(([month, count]) => ({ month, count }))
                .sort((a, b) => a.month.localeCompare(b.month));
        }

        // Aggregate data by date
        function aggregateByDate(data, dateField) {
            const grouped = {};
            data.forEach(row => {
                const date = row[dateField];
                if (date) {
                    const monthYear = date.substring(0, 7); // YYYY-MM
                    grouped[monthYear] = (grouped[monthYear] || 0) + 1;
                }
            });
            
            return Object.entries(grouped)
                .map(([date, count]) => ({ date: date + '-01', count }))
                .sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        // Initialize world map
        function initializeMap() {
            try {
                const mapElement = document.getElementById('mapOne');
                if (!mapElement) {
                    console.warn('Map element #mapOne not found, skipping map initialization');
                    return;
                }
                
                // Check if jsVectorMap is available
                if (typeof jsVectorMap === 'undefined') {
                    console.warn('jsVectorMap library not loaded, skipping map initialization');
                    return;
                }
                
                // Get region coordinates for markers
                const regionCoords = {
                    'NAM': [37.0902, -95.7129], // North America (USA)
                    'EMEA': [51.5074, -0.1278], // Europe (London)
                    'APAC': [35.6762, 139.6503], // Asia Pacific (Tokyo)
                    'LATAM': [-23.5505, -46.6333], // Latin America (So Paulo)
                    'MEA': [25.2048, 55.2708] // Middle East (Dubai)
                };
                
                const regionCounts = getRegionCounts();
                console.log('Region counts for map:', regionCounts);
                
                const markers = [];
                
                Object.keys(regionCounts).forEach(region => {
                    if (regionCoords[region]) {
                        markers.push({
                            name: region,
                            coords: regionCoords[region]
                        });
                    }
                });
                
                // Clear existing map content but keep the element
                mapElement.innerHTML = '';
                
                // Small delay to ensure DOM is ready
                setTimeout(() => {
                    const map = new jsVectorMap({
                        selector: '#mapOne',
                        map: 'world',
                        zoomButtons: false,
                        regionStyle: {
                            initial: {
                                fill: '#D9D9D9'
                            },
                            hover: {
                                fillOpacity: 1,
                                fill: '#465fff'
                            }
                        },
                        markers: markers,
                        markerStyle: {
                            initial: {
                                strokeWidth: 1,
                                fill: '#465fff',
                                fillOpacity: 1,
                        r: 4
                    },
                    hover: {
                        fill: '#465fff',
                        fillOpacity: 1
                    }
                }
            });
                }, 50); // Small delay to ensure DOM is ready
            } catch (error) {
                console.error('Error initializing map:', error);
                // Map is optional, continue without it
            }
        }
        
        // Get region counts for facilities/CAIDs expiring soon
        function getRegionCounts() {
            const regionCounts = {};
            const today = new Date();
            const threeMonthsLater = new Date(today.getTime() + 90 * 24 * 60 * 60 * 1000);
            
            if (selectedRegionalLevel === 'facility') {
                // Count unique Facility IDs
                const regionFacilities = {};
                portfolioData.forEach(row => {
                    const maturityDate = parseDate(row.Maturity_Date);
                    if (maturityDate && maturityDate <= threeMonthsLater && maturityDate >= today) {
                        const region = row.Region || 'Unknown';
                        const facilityId = row.Facility_ID;
                        
                        if (!regionFacilities[region]) {
                            regionFacilities[region] = new Set();
                        }
                        if (facilityId) {
                            regionFacilities[region].add(facilityId);
                        }
                    }
                });
                
                // Convert Set sizes to counts
                Object.keys(regionFacilities).forEach(region => {
                    regionCounts[region] = regionFacilities[region].size;
                });
            } else {
                // Count unique CAIDs
                const regionCAIDs = {};
                portfolioData.forEach(row => {
                    const caExpDate = parseDate(row.CA_Expiration_Date);
                    if (caExpDate && caExpDate <= threeMonthsLater && caExpDate >= today) {
                        const region = row.Region || 'Unknown';
                        const caid = row.CAID;
                        
                        if (!regionCAIDs[region]) {
                            regionCAIDs[region] = new Set();
                        }
                        if (caid) {
                            regionCAIDs[region].add(caid);
                        }
                    }
                });
                
                // Convert Set sizes to counts
                Object.keys(regionCAIDs).forEach(region => {
                    regionCounts[region] = regionCAIDs[region].size;
                });
            }
            
            return regionCounts;
        }
        
        // Create regional distribution chart with map and list
        function createRegionalChart() {
            initializeMap();
            
            const regionCounts = getRegionCounts();
            const totalCount = Object.values(regionCounts).reduce((a, b) => a + b, 0);
            
            // Sort regions by count (descending)
            const sortedRegions = Object.entries(regionCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5); // Top 5 regions
            
            // Region flag/icon mapping
            const regionInfo = {
                'NAM': { name: 'North America', color: 'bg-blue-500' },
                'EMEA': { name: 'Europe & Middle East', color: 'bg-green-500' },
                'APAC': { name: 'Asia Pacific', color: 'bg-orange-500' },
                'LATAM': { name: 'Latin America', color: 'bg-purple-500' },
                'MEA': { name: 'Middle East & Africa', color: 'bg-red-500' }
            };
            
            const regionList = document.getElementById('regionList');
            regionList.innerHTML = '';
            
            const countLabel = selectedRegionalLevel === 'facility' ? 'Facilities' : 'CAIDs';
            
            sortedRegions.forEach(([region, count]) => {
                const percentage = totalCount > 0 ? ((count / totalCount) * 100).toFixed(0) : 0;
                const info = regionInfo[region] || { name: region, color: 'bg-gray-500' };
                
                const regionItem = document.createElement('div');
                regionItem.className = 'flex items-center justify-between';
                regionItem.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 flex items-center justify-center rounded-full ${info.color} text-white font-semibold text-xs">
                            ${region}
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-gray-800">${info.name}</p>
                            <span class="block text-xs text-gray-500">${count} ${countLabel}</span>
                        </div>
                    </div>
                    <div class="flex w-full max-w-[140px] items-center gap-3">
                        <div class="relative block h-2 w-full max-w-[100px] rounded-sm bg-gray-200">
                            <div class="absolute left-0 top-0 flex h-full items-center justify-center rounded-sm bg-blue-500 text-xs font-medium text-white"
                                style="width: ${percentage}%"></div>
                        </div>
                        <p class="text-sm font-medium text-gray-800">${percentage}%</p>
                    </div>
                `;
                regionList.appendChild(regionItem);
            });
        }

        // Create relationship bar chart
        function createRelationshipChart() {
            const topN = parseInt(document.getElementById('topNFilter').value);
            console.log('Creating relationship chart with topN:', topN, 'metric:', selectedMetricType);
            
            // Log sample data to see field names
            if (portfolioData.length > 0) {
                console.log('Sample row keys:', Object.keys(portfolioData[0]));
                console.log('Sample row data:', portfolioData[0]);
            }
            
            // Determine which field to aggregate based on selected metric
            const fieldName = selectedMetricType === 'facilityAmount' ? 'Fac_Amount' : 'Direct_OS';
            const seriesName = selectedMetricType === 'facilityAmount' ? 'Total Facility Amount' : 'Total Direct OS';
            
            const relationshipTotals = {};
            portfolioData.forEach((row, index) => {
                // Try multiple possible field names for relationship
                const relId = row.Relationship_Name || row.Relationship_ID || row.relationship_name || 
                             row.relationship_id || row['Relationship Name'] || row['Relationship ID'] || 'Unknown';
                const amount = parseFloat(row[fieldName]) || 0;
                
                if (index < 3) {
                    console.log(`Row ${index} - Relationship:`, relId, 'Amount:', amount);
                }
                
                if (amount > 0) {
                    relationshipTotals[relId] = (relationshipTotals[relId] || 0) + amount;
                }
            });
            
            console.log('Total relationships found:', Object.keys(relationshipTotals).length);
            console.log('Relationship totals sample:', Object.entries(relationshipTotals).slice(0, 5));
            
            const sorted = Object.entries(relationshipTotals)
                .filter(([name, amount]) => name !== 'Unknown' && amount > 0)
                .sort((a, b) => b[1] - a[1])
                .slice(0, topN);
            
            console.log('Top relationships:', sorted.slice(0, 3));
            
            const relationships = sorted.map(item => item[0]);
            const amounts = sorted.map(item => item[1]);
            
            const options = {
                series: [{
                    name: seriesName,
                    data: amounts
                }],
                chart: {
                    type: 'bar',
                    height: 400,
                    toolbar: { show: true }
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        borderRadius: 4
                    }
                },
                colors: ['#3B82F6'],
                xaxis: {
                    categories: relationships,
                    labels: {
                        formatter: function(val) {
                            return formatCurrency(val);
                        }
                    }
                },
                dataLabels: {
                    enabled: false
                },
                grid: {
                    borderColor: '#E5E7EB'
                },
                tooltip: {
                    y: {
                        formatter: function(val) {
                            return formatCurrency(val);
                        }
                    }
                }
            };

            try {
                const chartElement = document.querySelector("#relationshipChart");
                if (!chartElement) {
                    console.error('Relationship chart element not found');
                    return;
                }
                
                if (relationshipChartInstance) {
                    relationshipChartInstance.destroy();
                }
                relationshipChartInstance = new ApexCharts(chartElement, options);
                relationshipChartInstance.render();
                console.log('Relationship chart rendered successfully');
            } catch (error) {
                console.error('Error creating relationship chart:', error);
            }
        }

        // Select metric type for relationship chart
        function selectMetricType(type) {
            selectedMetricType = type;
            
            // Update button styles
            const btnFacilityAmount = document.getElementById('btnFacilityAmount');
            const btnDirectOS = document.getElementById('btnDirectOS');
            
            if (type === 'facilityAmount') {
                btnFacilityAmount.className = 'px-3 py-2 font-medium transition-colors rounded-md text-sm shadow-sm text-gray-900 bg-white';
                btnDirectOS.className = 'px-3 py-2 font-medium transition-colors rounded-md text-sm text-gray-500 hover:text-gray-900';
            } else {
                btnFacilityAmount.className = 'px-3 py-2 font-medium transition-colors rounded-md text-sm text-gray-500 hover:text-gray-900';
                btnDirectOS.className = 'px-3 py-2 font-medium transition-colors rounded-md text-sm shadow-sm text-gray-900 bg-white';
            }
            
            // Update the chart
            updateBarChart();
        }

        // Update bar chart
        function updateBarChart() {
            if (Object.keys(activeFilters).length > 0) {
                createRelationshipChartFromFiltered();
            } else {
                createRelationshipChart();
            }
        }

        // Filter data based on search (works with existing filters)
        function filterData() {
            // If no filters are active, just apply search to all data
            if (Object.keys(activeFilters).length === 0) {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                
                if (searchTerm === '') {
                    filteredData = [...portfolioData];
                } else {
                    filteredData = portfolioData.filter(row => {
                        return Object.values(row).some(value => 
                            String(value).toLowerCase().includes(searchTerm)
                        );
                    });
                }
                
                currentPage = 1;
                renderTable();
            } else {
                // If filters are active, reapply them (which will include search)
                applyFilters();
            }
        }

        // Render table (optimized for large datasets)
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const startIdx = (currentPage - 1) * rowsPerPage;
            const endIdx = startIdx + rowsPerPage;
            const pageData = filteredData.slice(startIdx, endIdx);
            
            // Use requestAnimationFrame for smooth rendering
            requestAnimationFrame(() => {
                // Use DocumentFragment for batch DOM insertion (much faster)
                const fragment = document.createDocumentFragment();
                
                pageData.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="p-4 text-sm text-gray-700 whitespace-nowrap">${formatDate(row.Report_Date)}</td>
                        <td class="p-4 text-sm text-gray-700 whitespace-nowrap">${row.Region || 'N/A'}</td>
                        <td class="p-4 text-sm font-medium text-gray-800 whitespace-nowrap">${row.Facility_ID || 'N/A'}</td>
                        <td class="p-4 text-sm text-gray-700">${row.Relationship_Name || 'N/A'}</td>
                        <td class="p-4 text-sm text-gray-700">${row.Product_Program || 'N/A'}</td>
                        <td class="p-4 text-sm font-medium text-gray-800 whitespace-nowrap">${formatCurrency(parseFloat(row.Fac_Amount) || 0)}</td>
                        <td class="p-4 text-sm text-gray-700 whitespace-nowrap">${formatCurrency(parseFloat(row.Direct_OS) || 0)}</td>
                        <td class="p-4 text-sm text-gray-700 whitespace-nowrap">${formatDate(row.Maturity_Date)}</td>
                        <td class="p-4 text-sm text-gray-700 whitespace-nowrap">${formatDate(row.CA_Expiration_Date)}</td>
                    `;
                    fragment.appendChild(tr);
                });
                
                // Single DOM operation instead of multiple
                tbody.innerHTML = '';
                tbody.appendChild(fragment);
                updatePagination();
            });
        }

        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            const startRow = (currentPage - 1) * rowsPerPage + 1;
            const endRow = Math.min(currentPage * rowsPerPage, filteredData.length);
            
            document.getElementById('startRow').textContent = filteredData.length > 0 ? startRow : 0;
            document.getElementById('endRow').textContent = endRow;
            document.getElementById('totalRows').textContent = filteredData.length;
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
            
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages || totalPages === 0;
        }

        // Pagination functions
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        }

        // Export to CSV
        function exportToCSV() {
            // Convert data to worksheet
            const worksheet = XLSX.utils.json_to_sheet(filteredData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Portfolio Data');
            
            // Generate filename with current date
            const filename = 'portfolio_analytics_' + new Date().toISOString().split('T')[0] + '.xlsx';
            
            // Download the file
            XLSX.writeFile(workbook, filename);
            
            showNotification('Success', 'Data exported successfully', 'success');
        }
    </script>
</body>
</html>

