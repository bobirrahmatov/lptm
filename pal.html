<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Analytics Lending</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- SheetJS for Excel/CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jsVectorMap for world map -->
    <link rel="stylesheet" href="https://unpkg.com/jsvectormap@1.5.3/dist/css/jsvectormap.min.css">
    <script src="https://unpkg.com/jsvectormap@1.5.3/dist/js/jsvectormap.min.js"></script>
    <script src="https://unpkg.com/jsvectormap@1.5.3/dist/maps/world.js"></script>
    <style>
        /* Custom scrollbar styles */
        .custom-scrollbar::-webkit-scrollbar {
            height: 6px;
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="p-4 md:p-6">
        <!-- Page Header -->
        <div class="mb-6 rounded-2xl border border-gray-200 bg-white p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Portfolio Analytics Lending</h1>
                    <p class="mt-2 text-gray-600">Comprehensive lending portfolio analysis and metrics</p>
                </div>
                <button onclick="refreshData()" 
                    class="flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-all duration-200 hover:scale-105">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span>Refresh Data</span>
                </button>
            </div>
        </div>

        <!-- Top 4 Metric Cards -->
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 md:gap-6 xl:grid-cols-4 mb-6">
            <!-- Card 1: Total Facility Amount -->
            <div class="rounded-2xl border border-gray-200 bg-white px-6 pb-5 pt-6">
                <div class="mb-6 flex items-center gap-3">
                    <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-blue-100">
                        <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Total Facility Amount</h3>
                    </div>
                </div>
                <div class="flex items-end justify-between">
                    <div>
                        <h4 class="text-2xl font-bold text-gray-800" id="totalFacAmount">$0.00</h4>
                    </div>
                </div>
            </div>

            <!-- Card 2: Total Direct OS -->
            <div class="rounded-2xl border border-gray-200 bg-white px-6 pb-5 pt-6">
                <div class="mb-6 flex items-center gap-3">
                    <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-green-100">
                        <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Total Direct OS</h3>
                    </div>
                </div>
                <div class="flex items-end justify-between">
                    <div>
                        <h4 class="text-2xl font-bold text-gray-800" id="totalDirectOS">$0.00</h4>
                    </div>
                </div>
            </div>

            <!-- Card 3: Total Number of Facilities -->
            <div class="rounded-2xl border border-gray-200 bg-white px-6 pb-5 pt-6">
                <div class="mb-6 flex items-center gap-3">
                    <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-purple-100">
                        <svg class="h-6 w-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Total Facilities</h3>
                    </div>
                </div>
                <div class="flex items-end justify-between">
                    <div>
                        <h4 class="text-2xl font-bold text-gray-800" id="totalFacilities">0</h4>
                    </div>
                </div>
            </div>

            <!-- Card 4: Total Number of CAIDs -->
            <div class="rounded-2xl border border-gray-200 bg-white px-6 pb-5 pt-6">
                <div class="mb-6 flex items-center gap-3">
                    <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-orange-100">
                        <svg class="h-6 w-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Total CAIDs</h3>
                    </div>
                </div>
                <div class="flex items-end justify-between">
                    <div>
                        <h4 class="text-2xl font-bold text-gray-800" id="totalCAIDs">0</h4>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-12 gap-4 md:gap-6 mb-6">
            <!-- Area Chart: Facility IDs/CAIDs by Expiration Date -->
            <div class="col-span-12 xl:col-span-8">
                <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6 sm:pt-6">
                    <div class="flex flex-col gap-4 mb-6 sm:flex-row sm:items-center sm:justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Facilities & CAIDs Expiration Timeline</h3>
                            <p class="mt-1 text-gray-500 text-sm">Monthly expiration count by type</p>
                        </div>
                        <div class="flex flex-row-reverse items-center justify-end gap-0.5 sm:flex-col sm:items-start">
                            <div class="flex flex-row-reverse items-center gap-3 sm:flex-row sm:gap-2">
                                <h4 class="text-2xl font-bold text-gray-800" id="totalExpiring">0</h4>
                                <span class="flex items-center gap-1 rounded-full bg-blue-50 px-2 py-0.5 text-xs font-medium text-blue-600">
                                    Total
                                </span>
                            </div>
                            <span class="text-gray-500 text-xs">Combined Count</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-5 mb-5">
                        <div class="flex items-center gap-1.5">
                            <div class="h-2.5 w-2.5 rounded-full" style="background-color: #465FFF;"></div>
                            <p class="text-sm text-gray-500">Facilities</p>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <div class="h-2.5 w-2.5 rounded-full" style="background-color: #9CB9FF;"></div>
                            <p class="text-sm text-gray-500">CAIDs</p>
                        </div>
                    </div>
                    <div class="max-w-full overflow-x-auto custom-scrollbar">
                        <div id="expirationChart" class="apexcharts-tooltip-active -ml-4 min-w-[1000px] pl-2 xl:min-w-full"></div>
                    </div>
                </div>
            </div>

            <!-- Regional Distribution with Map -->
            <div class="col-span-12 xl:col-span-4">
                <div class="rounded-2xl border border-gray-200 bg-white p-5 sm:p-6">
                    <div class="flex justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Regional Distribution</h3>
                            <p class="mt-1 text-sm text-gray-500">Facilities expiring soon by region</p>
                        </div>
                    </div>
                    <div class="border-gray-200 my-6 overflow-hidden rounded-2xl border bg-gray-50 px-4 py-6 sm:px-6">
                        <div id="mapOne" class="mapOne map-btn -mx-4 -my-6 h-[212px] w-full"></div>
                    </div>
                    <div class="space-y-5" id="regionList">
                        <!-- Regional statistics will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Bar Chart: Top Relationships by Total Facility Amount -->
        <div class="mb-6">
            <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6 sm:pt-5">
                <div class="flex flex-col gap-5 mb-6 sm:flex-row sm:items-center sm:justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">Top Relationships by Facility Amount</h3>
                        <p class="mt-1 text-gray-500 text-sm">Total facility amount by relationship</p>
                    </div>
                    <div>
                        <select id="topNFilter" onchange="updateBarChart()" 
                            class="h-11 rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800">
                            <option value="5">Top 5</option>
                            <option value="10" selected>Top 10</option>
                            <option value="15">Top 15</option>
                            <option value="20">Top 20</option>
                        </select>
                    </div>
                </div>
                <div class="max-w-full overflow-x-auto custom-scrollbar">
                    <div id="relationshipChart" class="min-w-[900px] xl:min-w-full"></div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="overflow-hidden rounded-xl border border-gray-200 bg-white">
            <div class="flex flex-col gap-4 border-b border-gray-200 px-4 py-4 sm:px-5 lg:flex-row lg:items-center lg:justify-between">
                <div class="flex-shrink-0">
                    <h3 class="text-lg font-semibold text-gray-800">Portfolio Details</h3>
                    <p class="text-sm text-gray-500">Detailed lending portfolio data</p>
                </div>
                <div class="flex flex-col gap-4 lg:flex-row lg:items-center">
                    <!-- Search -->
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="Search..." 
                            class="h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 pl-10 text-sm text-gray-800 placeholder:text-gray-400 focus:border-blue-500 focus:outline-none sm:w-64">
                        <span class="pointer-events-none absolute top-1/2 left-3 -translate-y-1/2">
                            <svg class="fill-gray-500" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M3.04199 9.37381C3.04199 5.87712 5.87735 3.04218 9.37533 3.04218C12.8733 3.04218 15.7087 5.87712 15.7087 9.37381C15.7087 12.8705 12.8733 15.7055 9.37533 15.7055C5.87735 15.7055 3.04199 12.8705 3.04199 9.37381ZM9.37533 1.54218C5.04926 1.54218 1.54199 5.04835 1.54199 9.37381C1.54199 13.6993 5.04926 17.2055 9.37533 17.2055C11.2676 17.2055 13.0032 16.5346 14.3572 15.4178L17.1773 18.2381C17.4702 18.531 17.945 18.5311 18.2379 18.2382C18.5308 17.9453 18.5309 17.4704 18.238 17.1775L15.4182 14.3575C16.5367 13.0035 17.2087 11.2671 17.2087 9.37381C17.2087 5.04835 13.7014 1.54218 9.37533 1.54218Z" fill=""></path>
                            </svg>
                        </span>
                    </div>
                    <!-- Export Button -->
                    <button onclick="exportToCSV()" 
                        class="flex h-11 items-center justify-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Export
                    </button>
                </div>
            </div>
            <div class="custom-scrollbar overflow-x-auto">
                <table class="w-full table-auto" id="portfolioTable">
                    <thead>
                        <tr class="border-b border-gray-200 bg-gray-50">
                            <th class="p-4 text-left text-xs font-medium text-gray-500 whitespace-nowrap">Report Date</th>
                            <th class="p-4 text-left text-xs font-medium text-gray-500 whitespace-nowrap">Region</th>
                            <th class="p-4 text-left text-xs font-medium text-gray-500 whitespace-nowrap">Facility ID</th>
                            <th class="p-4 text-left text-xs font-medium text-gray-500 whitespace-nowrap">Relationship Name</th>
                            <th class="p-4 text-left text-xs font-medium text-gray-500 whitespace-nowrap">Product Program</th>
                            <th class="p-4 text-left text-xs font-medium text-gray-500 whitespace-nowrap">Facility Amount</th>
                            <th class="p-4 text-left text-xs font-medium text-gray-500 whitespace-nowrap">Direct OS</th>
                            <th class="p-4 text-left text-xs font-medium text-gray-500 whitespace-nowrap">Maturity Date</th>
                            <th class="p-4 text-left text-xs font-medium text-gray-500 whitespace-nowrap">CA Expiration</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-gray-200">
                        <!-- Table rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="flex w-full flex-col items-center justify-between border-t border-gray-200 px-5 py-4 sm:flex-row">
                <div class="pb-3 sm:pb-0">
                    <span class="block text-sm font-medium text-gray-500">
                        Showing <span class="text-gray-800" id="startRow">0</span> to 
                        <span class="text-gray-800" id="endRow">0</span> of 
                        <span class="text-gray-800" id="totalRows">0</span>
                    </span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="previousPage()" id="prevBtn"
                        class="flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50">
                        Previous
                    </button>
                    <span class="text-sm font-medium text-gray-700">
                        Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                    </span>
                    <button onclick="nextPage()" id="nextBtn"
                        class="flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50">
                        Next
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        // Update these values to match your Confluence page and attachment
        const CONFLUENCE_PAGE_ID = '2740868871'; // Your Confluence page ID
        const CONFLUENCE_FILE_NAME = 'palDashboard.csv'; // Your attachment filename (can be .csv, .xlsx, or .xls)
        const CONFLUENCE_BASE_URL = 'https://cedt-confluence.net/confluence';
        // =======================

        // Global variables
        let portfolioData = [];
        let filteredData = [];
        let currentPage = 1;
        let rowsPerPage = 20;
        let expirationChartInstance = null;
        let relationshipChartInstance = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load data from CSV file
            loadDataFromCSV();
            
            // Setup search functionality
            document.getElementById('searchInput').addEventListener('input', function() {
                filterData();
            });
        });

        // Refresh data from Confluence
        async function refreshData() {
            showLoadingState();
            try {
                const data = await fetchDataFromConfluence();
                if (data && data.length > 0) {
                    portfolioData = data;
                    calculateMetrics();
                    createExpirationChart();
                    createRegionalChart();
                    createRelationshipChart();
                    filterData();
                    showNotification('Success', `Refreshed ${data.length} records successfully`, 'success');
                } else {
                    showNotification('Error', 'Failed to refresh data from Confluence', 'error');
                }
            } catch (error) {
                console.error('Error refreshing data:', error);
                showNotification('Error', 'Failed to refresh data', 'error');
            }
        }

        // Load data from Confluence attachment
        async function loadDataFromCSV() {
            showLoadingState();
            try {
                const data = await fetchDataFromConfluence();
                if (data && data.length > 0) {
                    portfolioData = data;
                    initializeDashboard();
                    showNotification('Success', `Loaded ${data.length} records successfully`, 'success');
                } else {
                    console.warn('No data from Confluence, using sample data');
                    loadSampleData();
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Warning', 'Using sample data', 'warning');
                loadSampleData();
            }
        }

        // Fetch data from Confluence attachment
        async function fetchDataFromConfluence() {
            try {
                // Fetch the file from Confluence
                const url = `${CONFLUENCE_BASE_URL}/download/attachments/${CONFLUENCE_PAGE_ID}/${CONFLUENCE_FILE_NAME}?api=v2`;
                
                console.log('Fetching data from:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'X-Atlassian-Token': 'no-check'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch ${CONFLUENCE_FILE_NAME} file: ${response.status} ${response.statusText}`);
                }

                const blob = await response.blob();
                
                // Check if it's a CSV or Excel file
                if (CONFLUENCE_FILE_NAME.endsWith('.csv')) {
                    return await parseCSVBlob(blob);
                } else if (CONFLUENCE_FILE_NAME.endsWith('.xlsx') || CONFLUENCE_FILE_NAME.endsWith('.xls')) {
                    return await parseExcelBlob(blob);
                }
                
                throw new Error('Unsupported file format. Please use .csv, .xlsx, or .xls files.');

            } catch (error) {
                console.error('Error fetching data from Confluence:', error);
                return null;
            }
        }

        // Parse CSV blob
        async function parseCSVBlob(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n');
                        const headers = lines[0].split(',').map(h => h.trim());
                        
                        const data = [];
                        for (let i = 1; i < lines.length; i++) {
                            if (lines[i].trim()) {
                                const values = lines[i].split(',');
                                const row = {};
                                headers.forEach((header, index) => {
                                    row[header] = values[index] ? values[index].trim() : '';
                                });
                                if (row.Facility_ID) { // Only add rows with Facility_ID
                                    data.push(row);
                                }
                            }
                        }
                        resolve(data);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read CSV file'));
                reader.readAsText(blob);
            });
        }

        // Parse Excel blob
        async function parseExcelBlob(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        
                        // Filter out empty rows
                        const filteredData = jsonData.filter(row => row.Facility_ID);
                        resolve(filteredData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read Excel file'));
                reader.readAsArrayBuffer(blob);
            });
        }

        // Show loading state
        function showLoadingState() {
            const tbody = document.getElementById('tableBody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="py-16">
                            <div class="flex flex-col items-center justify-center">
                                <div class="relative">
                                    <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-200"></div>
                                    <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-600 border-t-transparent absolute top-0 left-0"></div>
                                </div>
                                <div class="mt-6 text-center">
                                    <span class="text-base font-medium text-gray-700">Loading data...</span>
                                    <p class="text-sm text-gray-500 mt-1">Fetching portfolio information from Confluence</p>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        // Show notification
        function showNotification(title, message, type = 'success') {
            const colors = {
                success: { bg: 'bg-green-100', text: 'text-green-600', border: 'border-green-200' },
                error: { bg: 'bg-red-100', text: 'text-red-600', border: 'border-red-200' },
                warning: { bg: 'bg-yellow-100', text: 'text-yellow-600', border: 'border-yellow-200' }
            };
            
            const color = colors[type] || colors.success;
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${color.bg} ${color.border} border ${color.text} px-4 py-3 rounded-lg shadow-lg z-50 max-w-md`;
            notification.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="flex-1">
                        <h4 class="font-semibold">${title}</h4>
                        <p class="text-sm">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Load sample data if CSV is not available
        function loadSampleData() {
            portfolioData = [
                {
                    Report_Date: '2024-01-15',
                    Region: 'NAM',
                    Facility_ID: 'FAC001',
                    Parent_Facility_ID: 'PFAC001',
                    Product_Program: 'Commercial Lending',
                    Management_Status: 'Active',
                    Facility_Type: 'Term Loan',
                    'Committed/Uncommitted': 'Committed',
                    Risk_Category: 'Low',
                    Relationship_ID: 'REL001',
                    Relationship_Name: 'ABC Corporation',
                    CAID: 'CAID001',
                    Lead_Underwriter: 'John Smith',
                    Underwriting_Team_Lead: 'Jane Doe',
                    Control_Unit: 'CU-001',
                    Fac_Amount: '5000000',
                    Total_Reported_Fac_Amount: '5000000',
                    Direct_OS: '3000000',
                    Contingent_OS: '500000',
                    PSE_OS: '0',
                    Unused_Committed: '1500000',
                    Total_Comm_Exposure: '5000000',
                    Maturity_Date: '2025-12-31',
                    Prodict_Underwriter: 'John Smith',
                    CA_Expiration_Date: '2025-06-30'
                },
                // Add more sample data as needed
            ];
            initializeDashboard();
        }

        // Initialize dashboard with data
        function initializeDashboard() {
            calculateMetrics();
            createExpirationChart();
            createRegionalChart();
            createRelationshipChart();
            filterData();
        }

        // Calculate top metrics
        function calculateMetrics() {
            const totalFacAmount = portfolioData.reduce((sum, row) => {
                return sum + (parseFloat(row.Fac_Amount) || 0);
            }, 0);
            
            const totalDirectOS = portfolioData.reduce((sum, row) => {
                return sum + (parseFloat(row.Direct_OS) || 0);
            }, 0);
            
            const uniqueFacilities = new Set(portfolioData.map(row => row.Facility_ID)).size;
            const uniqueCAIDs = new Set(portfolioData.filter(row => row.CAID).map(row => row.CAID)).size;
            
            document.getElementById('totalFacAmount').textContent = formatCurrency(totalFacAmount);
            document.getElementById('totalDirectOS').textContent = formatCurrency(totalDirectOS);
            document.getElementById('totalFacilities').textContent = uniqueFacilities.toLocaleString();
            document.getElementById('totalCAIDs').textContent = uniqueCAIDs.toLocaleString();
        }

        // Format currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        // Create expiration timeline chart (Area chart with both series)
        function createExpirationChart() {
            const facilityData = aggregateByMonthYear(portfolioData, 'Maturity_Date');
            const caidData = aggregateByMonthYear(portfolioData.filter(r => r.CA_Expiration_Date), 'CA_Expiration_Date');
            
            // Merge both datasets to have consistent months
            const allMonths = [...new Set([...facilityData.map(d => d.month), ...caidData.map(d => d.month)])].sort();
            
            const facilitySeries = allMonths.map(month => {
                const item = facilityData.find(d => d.month === month);
                return item ? item.count : 0;
            });
            
            const caidSeries = allMonths.map(month => {
                const item = caidData.find(d => d.month === month);
                return item ? item.count : 0;
            });
            
            // Calculate total expiring
            const totalExpiring = facilitySeries.reduce((a, b) => a + b, 0) + caidSeries.reduce((a, b) => a + b, 0);
            document.getElementById('totalExpiring').textContent = totalExpiring.toLocaleString();
            
            const options = {
                series: [
                    {
                        name: 'Facilities',
                        data: facilitySeries
                    },
                    {
                        name: 'CAIDs',
                        data: caidSeries
                    }
                ],
                legend: {
                    show: false,
                    position: 'top',
                    horizontalAlign: 'left'
                },
                colors: ['#465FFF', '#9CB9FF'],
                chart: {
                    fontFamily: 'system-ui, -apple-system, sans-serif',
                    height: 310,
                    type: 'area',
                    toolbar: {
                        show: false
                    }
                },
                fill: {
                    gradient: {
                        enabled: true,
                        opacityFrom: 0.55,
                        opacityTo: 0
                    }
                },
                stroke: {
                    curve: 'smooth',
                    width: [2, 2]
                },
                markers: {
                    size: 0
                },
                labels: {
                    show: false,
                    position: 'top'
                },
                grid: {
                    xaxis: {
                        lines: {
                            show: false
                        }
                    },
                    yaxis: {
                        lines: {
                            show: true
                        }
                    }
                },
                dataLabels: {
                    enabled: false
                },
                tooltip: {
                    x: {
                        formatter: function(value, { dataPointIndex }) {
                            const monthStr = allMonths[dataPointIndex];
                            if (monthStr) {
                                const date = new Date(monthStr + '-01');
                                return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                            }
                            return value;
                        }
                    }
                },
                xaxis: {
                    type: 'category',
                    categories: allMonths.map(m => {
                        const date = new Date(m + '-01');
                        return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    }),
                    axisBorder: {
                        show: false
                    },
                    axisTicks: {
                        show: false
                    }
                },
                yaxis: {
                    title: {
                        style: {
                            fontSize: '0px'
                        }
                    }
                }
            };

            if (expirationChartInstance) {
                expirationChartInstance.destroy();
            }
            expirationChartInstance = new ApexCharts(document.querySelector("#expirationChart"), options);
            expirationChartInstance.render();
        }

        // Aggregate data by month and year
        function aggregateByMonthYear(data, dateField) {
            const grouped = {};
            data.forEach(row => {
                const date = row[dateField];
                if (date) {
                    const monthYear = date.substring(0, 7); // YYYY-MM
                    grouped[monthYear] = (grouped[monthYear] || 0) + 1;
                }
            });
            
            return Object.entries(grouped)
                .map(([month, count]) => ({ month, count }))
                .sort((a, b) => a.month.localeCompare(b.month));
        }

        // Aggregate data by date
        function aggregateByDate(data, dateField) {
            const grouped = {};
            data.forEach(row => {
                const date = row[dateField];
                if (date) {
                    const monthYear = date.substring(0, 7); // YYYY-MM
                    grouped[monthYear] = (grouped[monthYear] || 0) + 1;
                }
            });
            
            return Object.entries(grouped)
                .map(([date, count]) => ({ date: date + '-01', count }))
                .sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        // Initialize world map
        function initializeMap() {
            // Get region coordinates for markers
            const regionCoords = {
                'NAM': [37.0902, -95.7129], // North America (USA)
                'EMEA': [51.5074, -0.1278], // Europe (London)
                'APAC': [35.6762, 139.6503], // Asia Pacific (Tokyo)
                'LATAM': [-23.5505, -46.6333], // Latin America (SÃ£o Paulo)
                'MEA': [25.2048, 55.2708] // Middle East (Dubai)
            };
            
            const regionCounts = getRegionCounts();
            const markers = [];
            
            Object.keys(regionCounts).forEach(region => {
                if (regionCoords[region]) {
                    markers.push({
                        name: region,
                        coords: regionCoords[region]
                    });
                }
            });
            
            const map = new jsVectorMap({
                selector: '#mapOne',
                map: 'world',
                zoomButtons: false,
                regionStyle: {
                    initial: {
                        fill: '#D9D9D9'
                    },
                    hover: {
                        fillOpacity: 1,
                        fill: '#465fff'
                    }
                },
                markers: markers,
                markerStyle: {
                    initial: {
                        strokeWidth: 1,
                        fill: '#465fff',
                        fillOpacity: 1,
                        r: 4
                    },
                    hover: {
                        fill: '#465fff',
                        fillOpacity: 1
                    }
                }
            });
        }
        
        // Get region counts for facilities expiring soon
        function getRegionCounts() {
            const regionCounts = {};
            const today = new Date();
            const threeMonthsLater = new Date(today.getTime() + 90 * 24 * 60 * 60 * 1000);
            
            portfolioData.forEach(row => {
                const maturityDate = new Date(row.Maturity_Date);
                if (maturityDate <= threeMonthsLater && maturityDate >= today) {
                    const region = row.Region || 'Unknown';
                    regionCounts[region] = (regionCounts[region] || 0) + 1;
                }
            });
            
            return regionCounts;
        }
        
        // Create regional distribution chart with map and list
        function createRegionalChart() {
            initializeMap();
            
            const regionCounts = getRegionCounts();
            const totalCount = Object.values(regionCounts).reduce((a, b) => a + b, 0);
            
            // Sort regions by count (descending)
            const sortedRegions = Object.entries(regionCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5); // Top 5 regions
            
            // Region flag/icon mapping
            const regionInfo = {
                'NAM': { name: 'North America', color: 'bg-blue-500' },
                'EMEA': { name: 'Europe & Middle East', color: 'bg-green-500' },
                'APAC': { name: 'Asia Pacific', color: 'bg-orange-500' },
                'LATAM': { name: 'Latin America', color: 'bg-purple-500' },
                'MEA': { name: 'Middle East & Africa', color: 'bg-red-500' }
            };
            
            const regionList = document.getElementById('regionList');
            regionList.innerHTML = '';
            
            sortedRegions.forEach(([region, count]) => {
                const percentage = ((count / totalCount) * 100).toFixed(0);
                const info = regionInfo[region] || { name: region, color: 'bg-gray-500' };
                
                const regionItem = document.createElement('div');
                regionItem.className = 'flex items-center justify-between';
                regionItem.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 flex items-center justify-center rounded-full ${info.color} text-white font-semibold text-xs">
                            ${region}
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-gray-800">${info.name}</p>
                            <span class="block text-xs text-gray-500">${count} Facilities</span>
                        </div>
                    </div>
                    <div class="flex w-full max-w-[140px] items-center gap-3">
                        <div class="relative block h-2 w-full max-w-[100px] rounded-sm bg-gray-200">
                            <div class="absolute left-0 top-0 flex h-full items-center justify-center rounded-sm bg-blue-500 text-xs font-medium text-white"
                                style="width: ${percentage}%"></div>
                        </div>
                        <p class="text-sm font-medium text-gray-800">${percentage}%</p>
                    </div>
                `;
                regionList.appendChild(regionItem);
            });
        }

        // Create relationship bar chart
        function createRelationshipChart() {
            const topN = parseInt(document.getElementById('topNFilter').value);
            
            const relationshipTotals = {};
            portfolioData.forEach(row => {
                const relId = row.Relationship_Name || row.Relationship_ID || 'Unknown';
                const amount = parseFloat(row.Fac_Amount) || 0;
                relationshipTotals[relId] = (relationshipTotals[relId] || 0) + amount;
            });
            
            const sorted = Object.entries(relationshipTotals)
                .sort((a, b) => b[1] - a[1])
                .slice(0, topN);
            
            const relationships = sorted.map(item => item[0]);
            const amounts = sorted.map(item => item[1]);
            
            const options = {
                series: [{
                    name: 'Total Facility Amount',
                    data: amounts
                }],
                chart: {
                    type: 'bar',
                    height: 400,
                    toolbar: { show: true }
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        borderRadius: 4
                    }
                },
                colors: ['#3B82F6'],
                xaxis: {
                    categories: relationships,
                    labels: {
                        formatter: function(val) {
                            return formatCurrency(val);
                        }
                    }
                },
                dataLabels: {
                    enabled: false
                },
                grid: {
                    borderColor: '#E5E7EB'
                }
            };

            if (relationshipChartInstance) {
                relationshipChartInstance.destroy();
            }
            relationshipChartInstance = new ApexCharts(document.querySelector("#relationshipChart"), options);
            relationshipChartInstance.render();
        }

        // Update bar chart
        function updateBarChart() {
            createRelationshipChart();
        }

        // Filter data based on search
        function filterData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (searchTerm === '') {
                filteredData = [...portfolioData];
            } else {
                filteredData = portfolioData.filter(row => {
                    return Object.values(row).some(value => 
                        String(value).toLowerCase().includes(searchTerm)
                    );
                });
            }
            
            currentPage = 1;
            renderTable();
        }

        // Render table
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const startIdx = (currentPage - 1) * rowsPerPage;
            const endIdx = startIdx + rowsPerPage;
            const pageData = filteredData.slice(startIdx, endIdx);
            
            tbody.innerHTML = '';
            
            pageData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="p-4 text-sm text-gray-700 whitespace-nowrap">${formatDate(row.Report_Date)}</td>
                    <td class="p-4 text-sm text-gray-700 whitespace-nowrap">${row.Region || 'N/A'}</td>
                    <td class="p-4 text-sm font-medium text-gray-800 whitespace-nowrap">${row.Facility_ID || 'N/A'}</td>
                    <td class="p-4 text-sm text-gray-700">${row.Relationship_Name || 'N/A'}</td>
                    <td class="p-4 text-sm text-gray-700">${row.Product_Program || 'N/A'}</td>
                    <td class="p-4 text-sm font-medium text-gray-800 whitespace-nowrap">${formatCurrency(parseFloat(row.Fac_Amount) || 0)}</td>
                    <td class="p-4 text-sm text-gray-700 whitespace-nowrap">${formatCurrency(parseFloat(row.Direct_OS) || 0)}</td>
                    <td class="p-4 text-sm text-gray-700 whitespace-nowrap">${formatDate(row.Maturity_Date)}</td>
                    <td class="p-4 text-sm text-gray-700 whitespace-nowrap">${formatDate(row.CA_Expiration_Date)}</td>
                `;
                tbody.appendChild(tr);
            });
            
            updatePagination();
        }

        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            const startRow = (currentPage - 1) * rowsPerPage + 1;
            const endRow = Math.min(currentPage * rowsPerPage, filteredData.length);
            
            document.getElementById('startRow').textContent = filteredData.length > 0 ? startRow : 0;
            document.getElementById('endRow').textContent = endRow;
            document.getElementById('totalRows').textContent = filteredData.length;
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
            
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages || totalPages === 0;
        }

        // Pagination functions
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        }

        // Export to CSV
        function exportToCSV() {
            // Convert data to worksheet
            const worksheet = XLSX.utils.json_to_sheet(filteredData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Portfolio Data');
            
            // Generate filename with current date
            const filename = 'portfolio_analytics_' + new Date().toISOString().split('T')[0] + '.xlsx';
            
            // Download the file
            XLSX.writeFile(workbook, filename);
            
            showNotification('Success', 'Data exported successfully', 'success');
        }
    </script>
</body>
</html>

