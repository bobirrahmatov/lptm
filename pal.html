<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portfolio Analytics Lending</title>
    <!-- Alpine.js for reactive components -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- SheetJS for Excel/CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- html2canvas for PNG export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Custom scrollbar styles */
        .custom-scrollbar::-webkit-scrollbar {
            height: 6px;
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* TailAdmin custom theme sizes */
        .text-theme-sm {
            font-size: 0.875rem;
            /* 14px */
            line-height: 1.25rem;
            /* 20px */
        }

        /* Chart dark style for consistent sizing */
        .chartDarkStyle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 280px;
            height: 280px;
        }
        
        @media (max-width: 640px) {
            .chartDarkStyle {
                width: 280px;
                height: 280px;
            }
        }
        
        @media (min-width: 2600px) {
            .chartDarkStyle {
                width: 240px;
                height: 240px;
            }
        }

        /* Consistent Tooltip Styling for All Charts */
        .apexcharts-tooltip {
            background: #ffffff !important;
            border: 1px solid #e5e7eb !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
            color: #1f2937 !important;
            border-radius: 8px !important;
        }
        
        .apexcharts-tooltip-custom {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .apexcharts-tooltip * {
            color: inherit !important;
        }
        
        .apexcharts-tooltip .apexcharts-tooltip-title {
            background: #f9fafb !important;
            border-bottom: 1px solid #e5e7eb !important;
            color: #1f2937 !important;
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Loading Overlay -->
    <div id="loadingOverlay"
        class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-[10000] flex items-center justify-center hidden">
        <div class="bg-white rounded-2xl p-8 shadow-2xl flex flex-col items-center gap-4 max-w-sm mx-4">
            <div class="relative">
                <div class="w-16 h-16 border-4 border-gray-200 border-t-blue-600 rounded-full animate-spin"></div>
            </div>
            <div class="text-center">
                <h3 class="text-lg font-semibold text-gray-900 mb-1">
                    Loading Portfolio Data
                </h3>
                <p class="text-sm text-gray-500" id="loadingMessage">
                    Please wait while we fetch your data...
                </p>
                <p class="text-xs text-gray-400 mt-2" id="loadingProgress"></p>
            </div>
        </div>
    </div>

    <div class="p-4 md:p-6">
        <!-- Page Header -->
        <div class="mb-6 rounded-2xl border border-gray-200 bg-white p-5">
            <!-- First Row: Search Bar, Action Buttons, and Last Updated -->
            <div class="flex items-center justify-between gap-4 mb-5">
                <!-- Left: Search Input -->
                <div class="relative flex-1 max-w-2xl">
                    <span class="pointer-events-none absolute top-1/2 left-4 -translate-y-1/2">
                        <svg class="fill-gray-500" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd"
                                d="M3.04199 9.37381C3.04199 5.87712 5.87735 3.04218 9.37533 3.04218C12.8733 3.04218 15.7087 5.87712 15.7087 9.37381C15.7087 12.8705 12.8733 15.7055 9.37533 15.7055C5.87735 15.7055 3.04199 12.8705 3.04199 9.37381ZM9.37533 1.54218C5.04926 1.54218 1.54199 5.04835 1.54199 9.37381C1.54199 13.6993 5.04926 17.2055 9.37533 17.2055C11.2676 17.2055 13.0032 16.5346 14.3572 15.4178L17.1773 18.2381C17.4702 18.531 17.945 18.5311 18.2379 18.2382C18.5308 17.9453 18.5309 17.4704 18.238 17.1775L15.4182 14.3575C16.5367 13.0035 17.2087 11.2671 17.2087 9.37381C17.2087 5.04835 13.7014 1.54218 9.37533 1.54218Z"
                                fill=""></path>
                        </svg>
                    </span>
                    <input type="text" id="searchInput" placeholder="Search facilities, relationships, or any data..." 
                        class="h-11 w-full rounded-lg border border-gray-300 bg-white py-3 pr-4 pl-12 text-sm text-gray-800 placeholder:text-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 focus:outline-none shadow-sm" />
                </div>
                
                <!-- Middle: Action Buttons -->
                <div class="flex items-center gap-2">
                    <button onclick="toggleFilterPopover()" id="filterButton"
                        class="relative flex items-center gap-1.5 rounded-lg border border-gray-300 bg-white px-3 py-2 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z">
                            </path>
                        </svg>
                        <span>More</span>
                        <span id="filterCount"
                            class="hidden absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-blue-500 text-[10px] font-bold text-white"></span>
                    </button>

                    <button onclick="resetAllFilters()" 
                        class="flex items-center gap-1.5 rounded-lg border border-gray-300 bg-white px-3 py-2 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                            </path>
                        </svg>
                        <span>Reset</span>
                    </button>

                    <!-- Export Dropdown -->
                    <div x-data="{ exportOpen: false }" class="relative">
                        <button @click="exportOpen = !exportOpen" @click.away="exportOpen = false"
                            class="flex items-center gap-1.5 rounded-lg bg-blue-600 hover:bg-blue-700 px-3 py-2 text-xs font-medium text-white transition-colors">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                </path>
                            </svg>
                            <span>Export</span>
                            <svg class="w-3 h-3 transition-transform" :class="exportOpen ? 'rotate-180' : ''"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        
                        <!-- Dropdown Menu -->
                        <div x-show="exportOpen" x-transition:enter="transition ease-out duration-100"
                            x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
                            x-transition:leave="transition ease-in duration-75"
                            x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
                            class="absolute right-0 mt-2 w-44 rounded-lg border border-gray-200 bg-white shadow-xl z-10"
                            style="display: none">
                            <div class="py-1">
                                <button onclick="exportToExcel()"
                                    class="flex w-full items-center gap-2.5 px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 transition-colors">
                                    <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                        </path>
                                    </svg>
                                    <span class="font-medium">Excel (.xlsx)</span>
                                </button>
                                <button onclick="exportToPDF()"
                                    class="flex w-full items-center gap-2.5 px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 transition-colors">
                                    <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z">
                                        </path>
                                    </svg>
                                    <span class="font-medium">PDF (.pdf)</span>
                                </button>
                                <button onclick="exportToPPT()"
                                    class="flex w-full items-center gap-2.5 px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 transition-colors">
                                    <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                        </path>
                                    </svg>
                                    <span class="font-medium">PowerPoint (.pptx)</span>
                                </button>
                                <button onclick="exportToPNG()"
                                    class="flex w-full items-center gap-2.5 px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 transition-colors">
                                    <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                                        </path>
                                    </svg>
                                    <span class="font-medium">Image (.png)</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                    
                <!-- Right: Last Updated -->
                <div class="text-right shrink-0">
                    <p class="text-xs text-gray-400 font-medium">Last Updated</p>
                    <p class="text-sm font-semibold text-gray-600" id="reportDate">
                        --
                    </p>
                </div>
            </div>
            
            <!-- Second Row: All Filter Tabs -->
            <div class="flex flex-wrap items-center gap-4">
                <!-- Region Tabs -->
                <div class="flex items-center gap-2">
                    <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Region:</span>
                    <div class="inline-flex items-center gap-0.5 rounded-lg bg-gray-100 p-0.5">
                        <button id="btnRegionAll" onclick="selectRegionFilter('all')" 
                            class="min-w-[50px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white">
                            All
                        </button>
                        <button id="btnRegionAPAC" onclick="selectRegionFilter('APAC')" 
                            class="min-w-[50px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            APAC
                        </button>
                        <button id="btnRegionEMEA" onclick="selectRegionFilter('EMEA')" 
                            class="min-w-[50px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            EMEA
                        </button>
                        <button id="btnRegionLATAM" onclick="selectRegionFilter('LATAM')" 
                            class="min-w-[60px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            LATAM
                        </button>
                        <button id="btnRegionNAM" onclick="selectRegionFilter('NAM')" 
                            class="min-w-[50px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            NAM
                        </button>
                    </div>
                    </div>
                    
                <!-- Divider -->
                <div class="h-8 w-px bg-gray-300"></div>

                <!-- Status Filter -->
                <div class="flex items-center gap-2">
                    <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Status:</span>
                    <div class="inline-flex items-center gap-0.5 rounded-lg bg-gray-100 p-0.5">
                        <button id="btnStatusAll" onclick="selectStatusFilter('all')" 
                            class="min-w-[45px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white">
                            All
                        </button>
                        <button id="btnStatusCM" onclick="selectStatusFilter('CM')" 
                            class="min-w-[45px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            CM
                        </button>
                        <button id="btnStatusDM" onclick="selectStatusFilter('DM')" 
                            class="min-w-[45px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            DM
                        </button>
                    </div>
                </div>

                <!-- Divider -->
                <div class="h-8 w-px bg-gray-300"></div>

                <!-- PSE Toggle -->
                <div x-data="{ pseToggle: true }" class="flex items-center gap-2">
                    <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">PSE:</span>
                    <label for="pseToggle" class="flex cursor-pointer items-center gap-2 select-none">
                        <span class="text-xs font-medium"
                            :class="!pseToggle ? 'text-gray-900' : 'text-gray-500'">Exclude</span>
                        <div class="relative">
                            <input type="checkbox" id="pseToggle" class="sr-only" 
                                @change="pseToggle = !pseToggle; togglePSE(pseToggle)" checked />
                            <div class="block h-5 w-9 rounded-full transition-colors"
                                :class="pseToggle ? 'bg-blue-600' : 'bg-gray-300'"></div>
                            <div :class="pseToggle ? 'translate-x-4' : 'translate-x-0'"
                                class="absolute top-0.5 left-0.5 h-4 w-4 rounded-full bg-white shadow-sm duration-200 ease-in-out">
                        </div>
                        </div>
                        <span class="text-xs font-medium"
                            :class="pseToggle ? 'text-gray-900' : 'text-gray-500'">Include</span>
                    </label>
                </div>

                <!-- Divider -->
                <div class="h-8 w-px bg-gray-300"></div>

                <!-- Metrics By Amount Type Filter -->
                <div class="flex items-center gap-2">
                    <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Exposure:</span>
                    <div class="inline-flex items-center gap-0.5 rounded-lg bg-gray-100 p-0.5">
                        <button id="btnAmountDirect" onclick="selectAmountTypeFilter('direct')" 
                            class="min-w-[65px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white">
                            Direct
                        </button>
                        <button id="btnAmountContingent" onclick="selectAmountTypeFilter('contingent')" 
                            class="min-w-[80px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            Contingent
                        </button>
                        <button id="btnAmountPSE" onclick="selectAmountTypeFilter('pse')" 
                            class="min-w-[50px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            PSE
                        </button>
                        <button id="btnAmountOSUC" onclick="selectAmountTypeFilter('osuc')" 
                            class="min-w-[60px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            OSUC<sup class="text-blue-600">*</sup>
                        </button>
                        <button id="btnAmountUnused" onclick="selectAmountTypeFilter('unused')"
                            class="min-w-[90px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            Undrawn<sup class="text-blue-600">*</sup>
                        </button>
                        <button id="btnAmountTFA" onclick="selectAmountTypeFilter('tfa')" 
                            class="min-w-[50px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            TFA
                        </button>
                    </div>
                </div>
            </div>

            <!-- Active Filters Badges -->
            <div id="activeFiltersBadges" class="flex flex-wrap gap-2 mt-4 pt-4 border-t border-gray-200"
                style="display: none">
                <!-- Badges will be dynamically added here -->
            </div>
        </div>

        <!-- Advanced Filters Modal -->
        <div id="filterPopover"
            class="hidden fixed inset-0 flex items-center justify-center p-5 overflow-y-auto z-[9999]">
            <!-- Backdrop -->
            <div class="fixed inset-0 h-full w-full bg-gray-400/50 backdrop-blur-[32px]"
                onclick="toggleFilterPopover()"></div>
            
            <!-- Modal Content -->
            <div class="relative w-full max-w-[900px] rounded-3xl bg-white p-6 shadow-xl lg:p-10">
                <!-- Close Button -->
                <button onclick="toggleFilterPopover()" type="button"
                    class="absolute right-3 top-3 z-[9999] flex h-9.5 w-9.5 items-center justify-center rounded-full bg-gray-100 text-gray-400 transition-colors hover:bg-gray-200 hover:text-gray-700 sm:right-6 sm:top-6 sm:h-11 sm:w-11 cursor-pointer">
                    <svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M6.04289 16.5413C5.65237 16.9318 5.65237 17.565 6.04289 17.9555C6.43342 18.346 7.06658 18.346 7.45711 17.9555L11.9987 13.4139L16.5408 17.956C16.9313 18.3466 17.5645 18.3466 17.955 17.956C18.3455 17.5655 18.3455 16.9323 17.955 16.5418L13.4129 11.9997L17.955 7.4576C18.3455 7.06707 18.3455 6.43391 17.955 6.04338C17.5645 5.65286 16.9313 5.65286 16.5408 6.04338L11.9987 10.5855L7.45711 6.0439C7.06658 5.65338 6.43342 5.65338 6.04289 6.0439C5.65237 6.43442 5.65237 7.06759 6.04289 7.45811L10.5845 11.9997L6.04289 16.5413Z"
                            fill="" />
                            </svg>
                        </button>

                            <div>
                    <!-- Header -->
                    <h4 class="font-semibold text-gray-800 mb-2 text-title-sm">
                        Advanced Filters
                    </h4>
                    <p class="text-sm leading-6 text-gray-500 mb-7">
                        Refine your portfolio view with detailed filter criteria
                    </p>

                    <!-- Filter Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <!-- Product Program Filter -->
                        <div x-data="{ isOptionSelected: false }">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Product Program
                            </label>
                            <div class="relative z-20 bg-transparent">
                                <select id="filterProductProgram"
                                    class="shadow-theme-xs focus:border-blue-300 focus:ring-blue-500/10 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-11 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden"
                                    :class="isOptionSelected && 'text-gray-800'" @change="isOptionSelected = true"
                                    onchange="applyFilters()">
                                    <option value="" class="text-gray-700">All Programs</option>
                                </select>
                                <span
                                    class="pointer-events-none absolute top-1/2 right-4 z-30 -translate-y-1/2 text-gray-500">
                                    <svg class="stroke-current" width="20" height="20" viewBox="0 0 20 20" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4.79175 7.396L10.0001 12.6043L15.2084 7.396" stroke=""
                                            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </span>
                            </div>
                            </div>

                            <!-- Extending Unit Filter -->
                        <div x-data="{ isOptionSelected: false }">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Extending Unit
                            </label>
                            <div class="relative z-20 bg-transparent">
                                <select id="filterExtendingUnit"
                                    class="shadow-theme-xs focus:border-blue-300 focus:ring-blue-500/10 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-11 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden"
                                    :class="isOptionSelected && 'text-gray-800'" @change="isOptionSelected = true"
                                    onchange="applyFilters()">
                                    <option value="" class="text-gray-700">All Units</option>
                                </select>
                                <span
                                    class="pointer-events-none absolute top-1/2 right-4 z-30 -translate-y-1/2 text-gray-500">
                                    <svg class="stroke-current" width="20" height="20" viewBox="0 0 20 20" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4.79175 7.396L10.0001 12.6043L15.2084 7.396" stroke=""
                                            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </span>
                            </div>
                            </div>

                            <!-- Facility Type Filter -->
                        <div x-data="{ isOptionSelected: false }">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Facility Type
                            </label>
                            <div class="relative z-20 bg-transparent">
                                <select id="filterFacilityType"
                                    class="shadow-theme-xs focus:border-blue-300 focus:ring-blue-500/10 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-11 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden"
                                    :class="isOptionSelected && 'text-gray-800'" @change="isOptionSelected = true"
                                    onchange="applyFilters()">
                                    <option value="" class="text-gray-700">All Types</option>
                                </select>
                                <span
                                    class="pointer-events-none absolute top-1/2 right-4 z-30 -translate-y-1/2 text-gray-500">
                                    <svg class="stroke-current" width="20" height="20" viewBox="0 0 20 20" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4.79175 7.396L10.0001 12.6043L15.2084 7.396" stroke=""
                                            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </span>
                            </div>
                            </div>

                        <!-- Commitment Status Filter -->
                        <div x-data="{ isOptionSelected: false }">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Commitment Status
                            </label>
                            <div class="relative z-20 bg-transparent">
                                <select id="filterCommitment"
                                    class="shadow-theme-xs focus:border-blue-300 focus:ring-blue-500/10 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-11 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden"
                                    :class="isOptionSelected && 'text-gray-800'" @change="isOptionSelected = true"
                                    onchange="applyFilters()">
                                    <option value="" class="text-gray-700">All</option>
                                </select>
                                <span
                                    class="pointer-events-none absolute top-1/2 right-4 z-30 -translate-y-1/2 text-gray-500">
                                    <svg class="stroke-current" width="20" height="20" viewBox="0 0 20 20" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4.79175 7.396L10.0001 12.6043L15.2084 7.396" stroke=""
                                            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </span>
                            </div>
                            </div>

                            <!-- Team Lead Filter -->
                        <div x-data="{ isOptionSelected: false }">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Team Lead
                            </label>
                            <div class="relative z-20 bg-transparent">
                                <select id="filterTeamLead"
                                    class="shadow-theme-xs focus:border-blue-300 focus:ring-blue-500/10 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-11 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden"
                                    :class="isOptionSelected && 'text-gray-800'" @change="isOptionSelected = true"
                                    onchange="applyFilters()">
                                    <option value="" class="text-gray-700">
                                        All Team Leads
                                    </option>
                                </select>
                                <span
                                    class="pointer-events-none absolute top-1/2 right-4 z-30 -translate-y-1/2 text-gray-500">
                                    <svg class="stroke-current" width="20" height="20" viewBox="0 0 20 20" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4.79175 7.396L10.0001 12.6043L15.2084 7.396" stroke=""
                                            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </span>
                            </div>
                            </div>

                            <!-- Underwriter Filter -->
                        <div x-data="{ isOptionSelected: false }">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Underwriter
                            </label>
                            <div class="relative z-20 bg-transparent">
                                <select id="filterUnderwriter"
                                    class="shadow-theme-xs focus:border-blue-300 focus:ring-blue-500/10 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-11 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden"
                                    :class="isOptionSelected && 'text-gray-800'" @change="isOptionSelected = true"
                                    onchange="applyFilters()">
                                    <option value="" class="text-gray-700">
                                        All Underwriters
                                    </option>
                                </select>
                                <span
                                    class="pointer-events-none absolute top-1/2 right-4 z-30 -translate-y-1/2 text-gray-500">
                                    <svg class="stroke-current" width="20" height="20" viewBox="0 0 20 20" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4.79175 7.396L10.0001 12.6043L15.2084 7.396" stroke=""
                                            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </span>
                            </div>
                            </div>

                            <!-- CA Maturity Filter -->
                        <div x-data="{ isOptionSelected: false }">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                CAs Maturing
                            </label>
                            <div class="relative z-20 bg-transparent">
                                <select id="filterCAMaturity"
                                    class="shadow-theme-xs focus:border-blue-300 focus:ring-blue-500/10 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-11 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden"
                                    :class="isOptionSelected && 'text-gray-800'" @change="isOptionSelected = true"
                                    onchange="applyFilters()">
                                    <option value="" class="text-gray-700">All Dates</option>
                                    <option value="30" class="text-gray-700">
                                        Next 30 Days
                                    </option>
                                    <option value="60" class="text-gray-700">
                                        Next 60 Days
                                    </option>
                                    <option value="90" class="text-gray-700">
                                        Next 90 Days
                                    </option>
                                    <option value="180" class="text-gray-700">
                                        Next 6 Months
                                    </option>
                                    <option value="365" class="text-gray-700">Next Year</option>
                                </select>
                                <span
                                    class="pointer-events-none absolute top-1/2 right-4 z-30 -translate-y-1/2 text-gray-500">
                                    <svg class="stroke-current" width="20" height="20" viewBox="0 0 20 20" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4.79175 7.396L10.0001 12.6043L15.2084 7.396" stroke=""
                                            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </span>
                            </div>
                            </div>

                            <!-- Facility Maturity Filter -->
                        <div x-data="{ isOptionSelected: false }">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Facilities Maturing
                            </label>
                            <div class="relative z-20 bg-transparent">
                                <select id="filterFacilityMaturity"
                                    class="shadow-theme-xs focus:border-blue-300 focus:ring-blue-500/10 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-11 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden"
                                    :class="isOptionSelected && 'text-gray-800'" @change="isOptionSelected = true"
                                    onchange="applyFilters()">
                                    <option value="" class="text-gray-700">All Dates</option>
                                    <option value="30" class="text-gray-700">
                                        Next 30 Days
                                    </option>
                                    <option value="60" class="text-gray-700">
                                        Next 60 Days
                                    </option>
                                    <option value="90" class="text-gray-700">
                                        Next 90 Days
                                    </option>
                                    <option value="180" class="text-gray-700">
                                        Next 6 Months
                                    </option>
                                    <option value="365" class="text-gray-700">Next Year</option>
                                </select>
                                <span
                                    class="pointer-events-none absolute top-1/2 right-4 z-30 -translate-y-1/2 text-gray-500">
                                    <svg class="stroke-current" width="20" height="20" viewBox="0 0 20 20" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4.79175 7.396L10.0001 12.6043L15.2084 7.396" stroke=""
                                            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex items-center justify-between w-full gap-3">
                        <button onclick="clearAllFilters()" type="button"
                            class="text-sm font-medium text-gray-600 hover:text-gray-800 transition-colors">
                            Clear All Filters
                        </button>
                        <div class="flex gap-3">
                            <button onclick="toggleFilterPopover()" type="button"
                                class="flex w-full justify-center rounded-lg border border-gray-300 bg-white px-4 py-3 text-sm font-medium text-gray-700 shadow-theme-xs hover:bg-gray-50 hover:text-gray-800 sm:w-auto">
                                Cancel
                            </button>
                            <button onclick="applyFiltersAndClose()" type="button"
                                class="flex justify-center w-full px-4 py-3 text-sm font-medium text-white rounded-lg bg-blue-600 shadow-theme-xs hover:bg-blue-700 sm:w-auto">
                                Apply Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Metric Cards -->
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 md:gap-6 mb-6">
            <!-- Card 1: Total $ of Facility Amount -->
            <div class="rounded-2xl border border-gray-200 bg-white px-6 pb-5 pt-6">
                <div class="mb-6 flex items-center gap-3">
                    <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-red-100">
                        <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">
                            Total $ of Facility Amount
                        </h3>
                    </div>
                </div>
                <div class="flex items-center justify-center">
                    <h4 class="text-2xl font-bold text-gray-800" id="totalFacAmount">
                        $0.00
                    </h4>
                </div>
            </div>

            <!-- Card 2: Total Outstanding -->
            <div class="rounded-2xl border border-gray-200 bg-white px-6 pb-5 pt-6">
                <div class="mb-6 flex items-center gap-3">
                    <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-purple-100">
                        <svg class="h-6 w-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">
                            Total Outstanding
                        </h3>
                    </div>
                </div>
                <div class="flex items-center justify-center">
                    <h4 class="text-2xl font-bold text-gray-800" id="totalOutstanding">
                        $0.00
                    </h4>
                </div>
            </div>

            <!-- Card 3: Total $ of OSUC -->
            <div class="rounded-2xl border border-gray-200 bg-white px-6 pb-5 pt-6">
                <div class="mb-6 flex items-center gap-3">
                    <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-orange-100">
                        <svg class="h-6 w-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">
                            Total $ of OSUC<sup class="text-blue-600">*</sup>
                        </h3>
                    </div>
                </div>
                <div class="flex items-center justify-center">
                    <h4 class="text-2xl font-bold text-gray-800" id="totalOSUC">
                        $0.00
                    </h4>
                </div>
            </div>

            <!-- Card 4: Total # of Facilities -->
            <div class="rounded-2xl border border-gray-200 bg-white px-6 pb-5 pt-6">
                <div class="mb-6 flex items-center gap-3">
                    <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-green-100">
                        <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">
                            Total # of Facilities
                        </h3>
                    </div>
                </div>
                <div class="flex items-center justify-center">
                    <h4 class="text-2xl font-bold text-gray-800" id="totalFacilities">
                        0
                    </h4>
                </div>
            </div>

            <!-- Card 5: Total # of Relationships -->
            <div class="rounded-2xl border border-gray-200 bg-white px-6 pb-5 pt-6">
                <div class="mb-6 flex items-center gap-3">
                    <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-blue-100">
                        <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">
                            Total # of Relationships
                        </h3>
                    </div>
                </div>
                <div class="flex items-center justify-center">
                    <h4 class="text-2xl font-bold text-gray-800" id="totalRelationships">
                        0
                    </h4>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-12 gap-4 md:gap-6 mb-6">
            <!-- Bar Chart: CAs Coming Due & Facilities Expiring -->
            <div class="col-span-12 xl:col-span-4">
                <div class="rounded-2xl border border-gray-200 bg-white p-5 sm:p-6 h-full flex flex-col">
                    <div class="flex flex-col gap-3 mb-5 sm:flex-row sm:items-start sm:justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">
                                CAs & Facilities Expiring
                            </h3>
                            <p class="mt-1 text-sm text-gray-500">
                                Upcoming expirations for the next 3 months
                            </p>
                            <!-- Expired Metrics (Inline) -->
                            <div class="flex items-center gap-4 mt-2">
                                <div class="flex items-center gap-1.5">
                                    <svg class="h-2 w-2 text-blue-500" fill="currentColor" viewBox="0 0 8 8">
                                        <circle cx="4" cy="4" r="4"/>
                                    </svg>
                                    <span class="text-xs text-gray-600">CAs Expired:</span>
                                    <span class="text-xs font-semibold text-gray-900" id="casExpiredCount">0</span>
                                </div>
                                <div class="flex items-center gap-1.5">
                                    <svg class="h-2 w-2 text-orange-500" fill="currentColor" viewBox="0 0 8 8">
                                        <circle cx="4" cy="4" r="4"/>
                                    </svg>
                                    <span class="text-xs text-gray-600">Facilities Expired:</span>
                                    <span class="text-xs font-semibold text-gray-900" id="facilitiesExpiredCount">0</span>
                                </div>
                            </div>
                        </div>
                        <div x-data="{openDropDown: false}" class="relative">
                            <button @click="openDropDown = !openDropDown"
                                :class="openDropDown ? 'text-gray-700' : 'text-gray-400 hover:text-gray-700'"
                                class="transition-colors">
                                <svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" clip-rule="evenodd"
                                        d="M10.2441 6C10.2441 5.0335 11.0276 4.25 11.9941 4.25H12.0041C12.9706 4.25 13.7541 5.0335 13.7541 6C13.7541 6.9665 12.9706 7.75 12.0041 7.75H11.9941C11.0276 7.75 10.2441 6.9665 10.2441 6ZM10.2441 18C10.2441 17.0335 11.0276 16.25 11.9941 16.25H12.0041C12.9706 16.25 13.7541 17.0335 13.7541 18C13.7541 18.9665 12.9706 19.75 12.0041 19.75H11.9941C11.0276 19.75 10.2441 18.9665 10.2441 18ZM11.9941 10.25C11.0276 10.25 10.2441 11.0335 10.2441 12C10.2441 12.9665 11.0276 13.75 11.9941 13.75H12.0041C12.9706 13.75 13.7541 12.9665 13.7541 12C13.7541 11.0335 12.9706 10.25 12.0041 10.25H11.9941Z"
                                        fill="" />
                                </svg>
                            </button>
                            <div x-show="openDropDown" @click.outside="openDropDown = false"
                                class="absolute right-0 top-full z-40 w-40 space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                <button onclick="openChartDataModal('expiring')" @click="openDropDown = false"
                                    class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                    View Data
                                </button>
                                <button onclick="exportChartData('expiring')" @click="openDropDown = false"
                                    class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                    Export Data
                                </button>
                                <button onclick="openMethodologyModal('expiring')" @click="openDropDown = false"
                                    class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                    Methodology
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1 flex items-center">
                        <div id="facilityTrendChart" class="-ml-5 w-full" style="min-height: 350px"></div>
                    </div>
                </div>
            </div>

            <!-- Donut Chart: New Facilities Approved in CP by Product Program -->
            <div class="col-span-12 xl:col-span-4">
                <div class="rounded-2xl border border-gray-200 bg-white p-5 sm:p-6 h-full flex flex-col">
                    <div class="flex flex-col gap-3 mb-5 sm:flex-row sm:items-start sm:justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">
                                New Facilities Approved in CP by Product Program
                            </h3>
                            <p class="mt-1 text-sm text-gray-500" id="newFacilitiesSubtitle">
                                Facilities approved in reporting month
                            </p>
                        </div>
                        <div class="flex items-center gap-2">
                        <div class="inline-flex w-fit items-center gap-0.5 rounded-lg bg-gray-100 p-0.5">
                            <button id="currentMonthBtn" onclick="filterNewFacilitiesByPeriod('current')" 
                                class="px-2 py-1 font-medium transition-colors rounded text-xs shadow-xs text-gray-900 bg-white hover:text-gray-900">
                                Current
                            </button>
                            <button id="previousMonthBtn" onclick="filterNewFacilitiesByPeriod('previous')" 
                                class="px-2 py-1 font-medium transition-colors rounded text-xs text-gray-500 hover:text-gray-900">
                                Previous
                            </button>
                            </div>
                            <div x-data="{openDropDown: false}" class="relative">
                                <button @click="openDropDown = !openDropDown"
                                    :class="openDropDown ? 'text-gray-700' : 'text-gray-400 hover:text-gray-700'"
                                    class="transition-colors">
                                    <svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" clip-rule="evenodd"
                                            d="M10.2441 6C10.2441 5.0335 11.0276 4.25 11.9941 4.25H12.0041C12.9706 4.25 13.7541 5.0335 13.7541 6C13.7541 6.9665 12.9706 7.75 12.0041 7.75H11.9941C11.0276 7.75 10.2441 6.9665 10.2441 6ZM10.2441 18C10.2441 17.0335 11.0276 16.25 11.9941 16.25H12.0041C12.9706 16.25 13.7541 17.0335 13.7541 18C13.7541 18.9665 12.9706 19.75 12.0041 19.75H11.9941C11.0276 19.75 10.2441 18.9665 10.2441 18ZM11.9941 10.25C11.0276 10.25 10.2441 11.0335 10.2441 12C10.2441 12.9665 11.0276 13.75 11.9941 13.75H12.0041C12.9706 13.75 13.7541 12.9665 13.7541 12C13.7541 11.0335 12.9706 10.25 12.0041 10.25H11.9941Z"
                                            fill="" />
                                    </svg>
                                </button>
                                <div x-show="openDropDown" @click.outside="openDropDown = false"
                                    class="absolute right-0 top-full z-40 w-40 space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                    <button onclick="openChartDataModal('newFacilities')" @click="openDropDown = false"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        View Data
                                    </button>
                                    <button onclick="exportChartData('newFacilities')" @click="openDropDown = false"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        Export Data
                                    </button>
                                    <button onclick="openMethodologyModal('newFacilities')"
                                        @click="openDropDown = false"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        Methodology
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col items-center justify-center gap-8 xl:flex-row flex-1">
                        <div id="creditClassificationChart" class="chartDarkStyle"></div>
                        <div id="creditClassificationLegend"
                            class="flex flex-col items-start gap-6 sm:flex-row xl:flex-col">
                            <!-- Legend items will be dynamically generated -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- New Deals Section -->
            <div class="col-span-12 space-y-6 xl:col-span-4">
                <!-- Metric Group One -->
                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 md:gap-6">
                    <!-- Metric Item Start -->
                    <div class="rounded-2xl border border-gray-200 bg-white p-5 md:p-6">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-3">
                        <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-gray-100">
                            <svg class="fill-gray-800" width="24" height="24" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" clip-rule="evenodd"
                                    d="M8.80443 5.60156C7.59109 5.60156 6.60749 6.58517 6.60749 7.79851C6.60749 9.01185 7.59109 9.99545 8.80443 9.99545C10.0178 9.99545 11.0014 9.01185 11.0014 7.79851C11.0014 6.58517 10.0178 5.60156 8.80443 5.60156ZM5.10749 7.79851C5.10749 5.75674 6.76267 4.10156 8.80443 4.10156C10.8462 4.10156 12.5014 5.75674 12.5014 7.79851C12.5014 9.84027 10.8462 11.4955 8.80443 11.4955C6.76267 11.4955 5.10749 9.84027 5.10749 7.79851ZM4.86252 15.3208C4.08769 16.0881 3.70377 17.0608 3.51705 17.8611C3.48384 18.0034 3.5211 18.1175 3.60712 18.2112C3.70161 18.3141 3.86659 18.3987 4.07591 18.3987H13.4249C13.6343 18.3987 13.7992 18.3141 13.8937 18.2112C13.9797 18.1175 14.017 18.0034 13.9838 17.8611C13.7971 17.0608 13.4132 16.0881 12.6383 15.3208C11.8821 14.572 10.6899 13.955 8.75042 13.955C6.81096 13.955 5.61877 14.572 4.86252 15.3208ZM3.8071 14.2549C4.87163 13.2009 6.45602 12.455 8.75042 12.455C11.0448 12.455 12.6292 13.2009 13.6937 14.2549C14.7397 15.2906 15.2207 16.5607 15.4446 17.5202C15.7658 18.8971 14.6071 19.8987 13.4249 19.8987H4.07591C2.89369 19.8987 1.73504 18.8971 2.05628 17.5202C2.28015 16.5607 2.76117 15.2906 3.8071 14.2549ZM15.3042 11.4955C14.4702 11.4955 13.7006 11.2193 13.0821 10.7533C13.3742 10.3314 13.6054 9.86419 13.7632 9.36432C14.1597 9.75463 14.7039 9.99545 15.3042 9.99545C16.5176 9.99545 17.5012 9.01185 17.5012 7.79851C17.5012 6.58517 16.5176 5.60156 15.3042 5.60156C14.7039 5.60156 14.1597 5.84239 13.7632 6.23271C13.6054 5.73284 13.3741 5.26561 13.082 4.84371C13.7006 4.37777 14.4702 4.10156 15.3042 4.10156C17.346 4.10156 19.0012 5.75674 19.0012 7.79851C19.0012 9.84027 17.346 11.4955 15.3042 11.4955ZM19.9248 19.8987H16.3901C16.7014 19.4736 16.9159 18.969 16.9827 18.3987H19.9248C20.1341 18.3987 20.2991 18.3141 20.3936 18.2112C20.4796 18.1175 20.5169 18.0034 20.4837 17.861C20.2969 17.0607 19.913 16.088 19.1382 15.3208C18.4047 14.5945 17.261 13.9921 15.4231 13.9566C15.2232 13.6945 14.9995 13.437 14.7491 13.1891C14.5144 12.9566 14.262 12.7384 13.9916 12.5362C14.3853 12.4831 14.8044 12.4549 15.2503 12.4549C17.5447 12.4549 19.1291 13.2008 20.1936 14.2549C21.2395 15.2906 21.7206 16.5607 21.9444 17.5202C22.2657 18.8971 21.107 19.8987 19.9248 19.8987Z"
                                    fill=""></path>
                            </svg>
                        </div>
                                <span class="text-sm font-medium text-gray-500">New Deals Closed YTD</span>
                        </div>
                            <div x-data="{openDropDown: false}" class="relative">
                                <button @click="openDropDown = !openDropDown"
                                    :class="openDropDown ? 'text-gray-700' : 'text-gray-400 hover:text-gray-700'"
                                    class="transition-colors">
                                    <svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" clip-rule="evenodd"
                                            d="M10.2441 6C10.2441 5.0335 11.0276 4.25 11.9941 4.25H12.0041C12.9706 4.25 13.7541 5.0335 13.7541 6C13.7541 6.9665 12.9706 7.75 12.0041 7.75H11.9941C11.0276 7.75 10.2441 6.9665 10.2441 6ZM10.2441 18C10.2441 17.0335 11.0276 16.25 11.9941 16.25H12.0041C12.9706 16.25 13.7541 17.0335 13.7541 18C13.7541 18.9665 12.9706 19.75 12.0041 19.75H11.9941C11.0276 19.75 10.2441 18.9665 10.2441 18ZM11.9941 10.25C11.0276 10.25 10.2441 11.0335 10.2441 12C10.2441 12.9665 11.0276 13.75 11.9941 13.75H12.0041C12.9706 13.75 13.7541 12.9665 13.7541 12C13.7541 11.0335 12.9706 10.25 12.0041 10.25H11.9941Z"
                                            fill="" />
                                </svg>
                                </button>
                                <div x-show="openDropDown" @click.outside="openDropDown = false"
                                    class="absolute right-0 top-full z-40 w-40 space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                    <button onclick="openChartDataModal('newDealsYTD')" @click="openDropDown = false"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        View Data
                                    </button>
                                    <button onclick="exportChartData('newDealsYTD')" @click="openDropDown = false"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        Export Data
                                    </button>
                                    <button onclick="openMethodologyModal('newDealsYTD')" @click="openDropDown = false"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        Methodology
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-end justify-between">
                            <div>
                                <h4 id="newDealsYTD" class="text-title-sm font-bold text-gray-800">0</h4>
                                <p class="text-xs text-gray-400 mt-1">
                                    <span id="newDealsYTDAmount">$0</span>
                                </p>
                            </div>
                            <span id="newDealsYTDVariance"
                                class="flex items-center gap-1 rounded-full bg-gray-100 py-0.5 pl-2 pr-2.5 text-sm font-medium text-gray-600">
                                0%
                            </span>
                        </div>
                    </div>
                    <!-- Metric Item End -->

                    <!-- Metric Item Start -->
                    <div class="rounded-2xl border border-gray-200 bg-white p-5 md:p-6">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-3">
                        <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-gray-100">
                            <svg class="fill-gray-800" width="24" height="24" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" clip-rule="evenodd"
                                    d="M11.665 3.75621C11.8762 3.65064 12.1247 3.65064 12.3358 3.75621L18.7807 6.97856L12.3358 10.2009C12.1247 10.3065 11.8762 10.3065 11.665 10.2009L5.22014 6.97856L11.665 3.75621ZM4.29297 8.19203V16.0946C4.29297 16.3787 4.45347 16.6384 4.70757 16.7654L11.25 20.0366V11.6513C11.1631 11.6205 11.0777 11.5843 10.9942 11.5426L4.29297 8.19203ZM12.75 20.037L19.2933 16.7654C19.5474 16.6384 19.7079 16.3787 19.7079 16.0946V8.19202L13.0066 11.5426C12.9229 11.5844 12.8372 11.6208 12.75 11.6516V20.037ZM13.0066 2.41456C12.3732 2.09786 11.6277 2.09786 10.9942 2.41456L4.03676 5.89319C3.27449 6.27432 2.79297 7.05342 2.79297 7.90566V16.0946C2.79297 16.9469 3.27448 17.726 4.03676 18.1071L10.9942 21.5857L11.3296 20.9149L10.9942 21.5857C11.6277 21.9024 12.3732 21.9024 13.0066 21.5857L19.9641 18.1071C20.7264 17.726 21.2079 16.9469 21.2079 16.0946V7.90566C21.2079 7.05342 20.7264 6.27432 19.9641 5.89319L13.0066 2.41456Z"
                                    fill=""></path>
                            </svg>
                        </div>
                                <span class="text-sm font-medium text-gray-500">New Deals Closed MTD</span>
                            </div>
                            <div x-data="{openDropDown: false}" class="relative">
                                <button @click="openDropDown = !openDropDown"
                                    :class="openDropDown ? 'text-gray-700' : 'text-gray-400 hover:text-gray-700'"
                                    class="transition-colors">
                                    <svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" clip-rule="evenodd"
                                            d="M10.2441 6C10.2441 5.0335 11.0276 4.25 11.9941 4.25H12.0041C12.9706 4.25 13.7541 5.0335 13.7541 6C13.7541 6.9665 12.9706 7.75 12.0041 7.75H11.9941C11.0276 7.75 10.2441 6.9665 10.2441 6ZM10.2441 18C10.2441 17.0335 11.0276 16.25 11.9941 16.25H12.0041C12.9706 16.25 13.7541 17.0335 13.7541 18C13.7541 18.9665 12.9706 19.75 12.0041 19.75H11.9941C11.0276 19.75 10.2441 18.9665 10.2441 18ZM11.9941 10.25C11.0276 10.25 10.2441 11.0335 10.2441 12C10.2441 12.9665 11.0276 13.75 11.9941 13.75H12.0041C12.9706 13.75 13.7541 12.9665 13.7541 12C13.7541 11.0335 12.9706 10.25 12.0041 10.25H11.9941Z"
                                            fill="" />
                                </svg>
                                </button>
                                <div x-show="openDropDown" @click.outside="openDropDown = false"
                                    class="absolute right-0 top-full z-40 w-40 space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                    <button onclick="openChartDataModal('newDealsMTD')" @click="openDropDown = false"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        View Data
                                    </button>
                                    <button onclick="exportChartData('newDealsMTD')" @click="openDropDown = false"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        Export Data
                                    </button>
                                    <button onclick="openMethodologyModal('newDealsMTD')" @click="openDropDown = false"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        Methodology
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-end justify-between">
                            <div>
                                <h4 id="newDealsMTD" class="text-title-sm font-bold text-gray-800">0</h4>
                                <p class="text-xs text-gray-400 mt-1">
                                    <span id="newDealsMTDAmount">$0</span>
                                </p>
                            </div>
                            <span id="newDealsMTDVariance"
                                class="flex items-center gap-1 rounded-full bg-gray-100 py-0.5 pl-2 pr-2.5 text-sm font-medium text-gray-600">
                                0%
                            </span>
                        </div>
                    </div>
                    <!-- Metric Item End -->
                </div>
                <!-- Metric Group One -->

                <!-- ====== Pipeline Table Start -->
                <div class="overflow-hidden rounded-2xl border border-gray-200 bg-white">
                    <div class="flex items-center justify-between px-5 pt-5 sm:px-6 sm:pt-6 pb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">
                                Pipeline Deals Aging
                            </h3>
                            <p class="mt-1 text-sm text-gray-500">
                                Deals pending origination grouped by approval age
                            </p>
                        </div>
                        <div x-data="{openDropDown: false}" class="relative h-fit">
                            <button @click="openDropDown = !openDropDown"
                                :class="openDropDown ? 'text-gray-700' : 'text-gray-400 hover:text-gray-700'"
                                class="transition-colors">
                                <svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" clip-rule="evenodd"
                                        d="M10.2441 6C10.2441 5.0335 11.0276 4.25 11.9941 4.25H12.0041C12.9706 4.25 13.7541 5.0335 13.7541 6C13.7541 6.9665 12.9706 7.75 12.0041 7.75H11.9941C11.0276 7.75 10.2441 6.9665 10.2441 6ZM10.2441 18C10.2441 17.0335 11.0276 16.25 11.9941 16.25H12.0041C12.9706 16.25 13.7541 17.0335 13.7541 18C13.7541 18.9665 12.9706 19.75 12.0041 19.75H11.9941C11.0276 19.75 10.2441 18.9665 10.2441 18ZM11.9941 10.25C11.0276 10.25 10.2441 11.0335 10.2441 12C10.2441 12.9665 11.0276 13.75 11.9941 13.75H12.0041C12.9706 13.75 13.7541 12.9665 13.7541 12C13.7541 11.0335 12.9706 10.25 12.0041 10.25H11.9941Z"
                                        fill="" />
                                </svg>
                            </button>
                            <div x-show="openDropDown" @click.outside="openDropDown = false"
                                class="absolute right-0 top-full z-40 w-40 space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                <button onclick="openChartDataModal('pipeline')" @click="openDropDown = false"
                                    class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                    View Data
                                </button>
                                <button onclick="exportChartData('pipeline')" @click="openDropDown = false"
                                    class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                    Export Data
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="max-w-full overflow-x-auto">
                        <table class="w-full table-auto">
                            <thead>
                                <tr class="bg-gray-50 text-left">
                                    <th class="px-5 py-3 text-xs font-semibold text-gray-700 uppercase tracking-wider">Aging Bucket</th>
                                    <th class="px-5 py-3 text-xs font-semibold text-gray-700 uppercase tracking-wider text-right">Count</th>
                                    <th class="px-5 py-3 text-xs font-semibold text-gray-700 uppercase tracking-wider text-right">Total TFA</th>
                                </tr>
                            </thead>
                            <tbody id="pipelineTableBody" class="divide-y divide-gray-200">
                                <tr>
                                    <td colspan="3" class="px-5 py-4 text-center text-sm text-gray-500">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- ====== Pipeline Table End -->
            </div>
        </div>

        <!-- Bar Chart and Donut Chart Side by Side -->
        <div class="mb-6 grid grid-cols-12 gap-4 md:gap-6">
        <!-- Bar Chart: Top Relationships by Total Facility Amount / Direct OS -->
            <div class="col-span-12 xl:col-span-6">
                <div
                    class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6 sm:pt-5 h-full flex flex-col">
                    <div class="flex flex-col gap-5 mb-6 sm:flex-row sm:items-start sm:justify-between">
                    <div>
                            <h3 class="text-lg font-semibold text-gray-800" id="topRelationshipsTitle">
                                Top Relationships by Direct OS
                            </h3>
                            <p class="mt-1 text-gray-500 text-sm" id="topRelationshipsSubtitle">
                                Largest client exposures ranked by outstanding balance
                            </p>
                    </div>
                        <div class="flex items-center gap-2">
                            <!-- Top N Selector with TailAdmin Styling -->
                            <div x-data="{ isOptionSelected: true }" class="relative z-20 bg-transparent">
                        <select id="topNFilter" onchange="updateBarChart()" 
                                    class="shadow-theme-xs focus:border-blue-300 focus:ring-blue-500/10 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-11 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden"
                                    :class="isOptionSelected && 'text-gray-800'" @change="isOptionSelected = true">
                                    <option value="10" selected class="text-gray-700">
                                        Top 10
                                    </option>
                                    <option value="20" class="text-gray-700">Top 20</option>
                                    <option value="50" class="text-gray-700">Top 50</option>
                                    <option value="100" class="text-gray-700">Top 100</option>
                        </select>
                                <span
                                    class="pointer-events-none absolute top-1/2 right-4 z-30 -translate-y-1/2 text-gray-500">
                                    <svg class="stroke-current" width="20" height="20" viewBox="0 0 20 20" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4.79175 7.396L10.0001 12.6043L15.2084 7.396" stroke=""
                                            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </span>
                    </div>
                            <div x-data="{openDropDown: false}" class="relative">
                                <button @click="openDropDown = !openDropDown"
                                    :class="openDropDown ? 'text-gray-700' : 'text-gray-400 hover:text-gray-700'"
                                    class="transition-colors">
                                    <svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" clip-rule="evenodd"
                                            d="M10.2441 6C10.2441 5.0335 11.0276 4.25 11.9941 4.25H12.0041C12.9706 4.25 13.7541 5.0335 13.7541 6C13.7541 6.9665 12.9706 7.75 12.0041 7.75H11.9941C11.0276 7.75 10.2441 6.9665 10.2441 6ZM10.2441 18C10.2441 17.0335 11.0276 16.25 11.9941 16.25H12.0041C12.9706 16.25 13.7541 17.0335 13.7541 18C13.7541 18.9665 12.9706 19.75 12.0041 19.75H11.9941C11.0276 19.75 10.2441 18.9665 10.2441 18ZM11.9941 10.25C11.0276 10.25 10.2441 11.0335 10.2441 12C10.2441 12.9665 11.0276 13.75 11.9941 13.75H12.0041C12.9706 13.75 13.7541 12.9665 13.7541 12C13.7541 11.0335 12.9706 10.25 12.0041 10.25H11.9941Z"
                                            fill="" />
                                    </svg>
                                </button>
                                <div x-show="openDropDown" @click.outside="openDropDown = false"
                                    class="absolute right-0 top-full z-40 w-40 space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                    <button onclick="openChartDataModal('topRelationships')"
                                        @click="openDropDown = false"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        View Data
                                    </button>
                                    <button onclick="exportChartData('topRelationships')" @click="openDropDown = false"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        Export Data
                                    </button>
                                    <button onclick="openMethodologyModal('topRelationships')"
                                        @click="openDropDown = false"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        Methodology
                                    </button>
                </div>
                    </div>
                        </div>
                    </div>
                    <div class="flex-1 w-full overflow-y-auto overflow-x-hidden custom-scrollbar"
                        style="max-height: 450px">
                        <div id="relationshipChart" class="-ml-5 pl-2"></div>
                    </div>
                </div>
            </div>

            <!-- ROTCE Performance -->
            <div class="col-span-12 xl:col-span-6">
                <div
                    class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6 sm:pt-5 h-full flex flex-col">
                    <div class="mb-5 flex items-start justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">
                                ROTCE Performance
                            </h3>
                            <p class="mt-1 text-gray-500 text-sm" id="rotceSubtitle">
                                Top N relationships ROTCE performance
                            </p>
                        </div>
                        <div x-data="{openDropDown: false}" class="relative">
                                <button @click="openDropDown = !openDropDown"
                                    :class="openDropDown ? 'text-gray-700' : 'text-gray-400 hover:text-gray-700'"
                                    class="transition-colors">
                                    <svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" clip-rule="evenodd"
                                            d="M10.2441 6C10.2441 5.0335 11.0276 4.25 11.9941 4.25H12.0041C12.9706 4.25 13.7541 5.0335 13.7541 6C13.7541 6.9665 12.9706 7.75 12.0041 7.75H11.9941C11.0276 7.75 10.2441 6.9665 10.2441 6ZM10.2441 18C10.2441 17.0335 11.0276 16.25 11.9941 16.25H12.0041C12.9706 16.25 13.7541 17.0335 13.7541 18C13.7541 18.9665 12.9706 19.75 12.0041 19.75H11.9941C11.0276 19.75 10.2441 18.9665 10.2441 18ZM11.9941 10.25C11.0276 10.25 10.2441 11.0335 10.2441 12C10.2441 12.9665 11.0276 13.75 11.9941 13.75H12.0041C12.9706 13.75 13.7541 12.9665 13.7541 12C13.7541 11.0335 12.9706 10.25 12.0041 10.25H11.9941Z"
                                            fill="" />
                                    </svg>
                                </button>
                                <div x-show="openDropDown" @click.outside="openDropDown = false"
                                    class="absolute right-0 z-40 w-40 p-2 space-y-1 bg-white border border-gray-200 shadow-theme-lg top-full rounded-2xl"
                                style="display: none">
                                    <button onclick="openChartDataModal('rotce')"
                                        class="flex w-full px-3 py-2 font-medium text-left text-gray-500 rounded-lg text-xs hover:bg-gray-100 hover:text-gray-700">
                                        View Data
                                    </button>
                                    <button onclick="exportChartData('rotce')"
                                        class="flex w-full px-3 py-2 font-medium text-left text-gray-500 rounded-lg text-xs hover:bg-gray-100 hover:text-gray-700">
                                        Export Data
                                    </button>
                                    <button onclick="openMethodologyModal('rotce')"
                                        class="flex w-full px-3 py-2 font-medium text-left text-gray-500 rounded-lg text-xs hover:bg-gray-100 hover:text-gray-700">
                                        Methodology
                                    </button>
                                </div>
                        </div>
                    </div>

                    <!-- ROTCE Chart -->
                    <div class="flex-1 w-full overflow-y-auto overflow-x-hidden custom-scrollbar"
                        style="max-height: 450px">
                        <div id="rotceChart" class="-ml-5 pl-2">
                            <!-- Chart will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="overflow-hidden rounded-xl border border-gray-200 bg-white mb-6" x-data="portfolioTable()">
            <!-- Table Header with Search and Filters -->
            <div
                class="flex flex-col justify-between gap-5 border-b border-gray-200 px-5 py-4 sm:flex-row lg:items-center">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">
                        Portfolio Details
                    </h3>
                    <p class="text-sm text-gray-500">
                        Showing <span x-text="displayedRowsCount"></span> lending
                        facilities
                        <span id="perfIndicator" class="text-green-600 font-medium"></span>
                    </p>
                </div>

                <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
                    <!-- Status Filter -->
                    <div class="hidden lg:block">
                        <select x-model="statusFilter" @change="applyTableFilters()"
                            class="shadow-theme-xs focus:border-blue-300 focus:ring-blue-500/10 h-11 w-full rounded-lg border border-gray-300 bg-white px-4 py-2.5 pr-11 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden">
                            <option value="all">All Status</option>
                            <option value="active">Active</option>
                            <option value="expiring">Expiring Soon</option>
                            <option value="expired">Expired</option>
                        </select>
            </div>

                    <!-- Export Button -->
                    <div>
                        <button @click="exportToXLSX()"
                            class="shadow-theme-xs relative flex h-11 items-center justify-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-3 whitespace-nowrap text-gray-700 transition-colors hover:bg-gray-100 hover:text-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"
                                fill="none">
                                <path
                                    d="M16.6661 13.3333V15.4166C16.6661 16.1069 16.1064 16.6666 15.4161 16.6666H4.58203C3.89168 16.6666 3.33203 16.1069 3.33203 15.4166V13.3333M10.0004 3.33325L10.0004 13.3333M6.14456 7.18708L9.9986 3.33549L13.8529 7.18708"
                                    stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                            Export XLSX
                        </button>
                    </div>
                </div>
            </div>

            <!-- Table Content -->
            <div class="custom-scrollbar overflow-x-auto">
                <table class="w-full table-auto">
                    <thead>
                        <tr class="border-b border-gray-200">
                            <th class="p-4 text-left text-xs font-medium whitespace-nowrap text-gray-500">
                                Facility ID
                            </th>
                            <th class="p-4 text-left text-xs font-medium whitespace-nowrap text-gray-500">
                                <div class="flex cursor-pointer items-center gap-3" @click="sortBy('relationship')">
                                    <p class="text-xs font-medium text-gray-500">
                                        Relationship
                                    </p>
                                    <span class="flex flex-col gap-0.5">
                                        <svg :class="sort.key === 'relationship' && sort.asc ? 'text-gray-800' : 'text-gray-300'"
                                            width="8" height="5" viewBox="0 0 8 5" fill="none">
                                            <path
                                                d="M4.40962 0.585167C4.21057 0.300808 3.78943 0.300807 3.59038 0.585166L1.05071 4.21327C0.81874 4.54466 1.05582 5 1.46033 5H6.53967C6.94418 5 7.18126 4.54466 6.94929 4.21327L4.40962 0.585167Z"
                                                fill="currentColor" />
                                        </svg>
                                        <svg :class="sort.key === 'relationship' && !sort.asc ? 'text-gray-800' : 'text-gray-300'"
                                            width="8" height="5" viewBox="0 0 8 5" fill="none">
                                            <path
                                                d="M4.40962 4.41483C4.21057 4.69919 3.78943 4.69919 3.59038 4.41483L1.05071 0.786732C0.81874 0.455343 1.05582 0 1.46033 0H6.53967C6.94418 0 7.18126 0.455342 6.94929 0.786731L4.40962 4.41483Z"
                                                fill="currentColor" />
                                        </svg>
                                    </span>
                                </div>
                            </th>
                            <th class="p-4 text-left text-xs font-medium whitespace-nowrap text-gray-500">
                                <div class="flex cursor-pointer items-center gap-3" @click="sortBy('region')">
                                    <p class="text-xs font-medium text-gray-500">Region</p>
                                    <span class="flex flex-col gap-0.5">
                                        <svg :class="sort.key === 'region' && sort.asc ? 'text-gray-800' : 'text-gray-300'"
                                            width="8" height="5" viewBox="0 0 8 5" fill="none">
                                            <path
                                                d="M4.40962 0.585167C4.21057 0.300808 3.78943 0.300807 3.59038 0.585166L1.05071 4.21327C0.81874 4.54466 1.05582 5 1.46033 5H6.53967C6.94418 5 7.18126 4.54466 6.94929 4.21327L4.40962 0.585167Z"
                                                fill="currentColor" />
                                        </svg>
                                        <svg :class="sort.key === 'region' && !sort.asc ? 'text-gray-800' : 'text-gray-300'"
                                            width="8" height="5" viewBox="0 0 8 5" fill="none">
                                            <path
                                                d="M4.40962 4.41483C4.21057 4.69919 3.78943 4.69919 3.59038 4.41483L1.05071 0.786732C0.81874 0.455343 1.05582 0 1.46033 0H6.53967C6.94418 0 7.18126 0.455342 6.94929 0.786731L4.40962 4.41483Z"
                                                fill="currentColor" />
                                        </svg>
                                    </span>
                                </div>
                            </th>
                            <th class="p-4 text-left text-xs font-medium whitespace-nowrap text-gray-500">
                                Product
                            </th>
                            <th class="p-4 text-left text-xs font-medium whitespace-nowrap text-gray-500">
                                <div class="flex cursor-pointer items-center gap-3" @click="sortBy('amount')">
                                    <p class="text-xs font-medium text-gray-500">
                                        Facility Amount
                                    </p>
                                    <span class="flex flex-col gap-0.5">
                                        <svg :class="sort.key === 'amount' && sort.asc ? 'text-gray-800' : 'text-gray-300'"
                                            width="8" height="5" viewBox="0 0 8 5" fill="none">
                                            <path
                                                d="M4.40962 0.585167C4.21057 0.300808 3.78943 0.300807 3.59038 0.585166L1.05071 4.21327C0.81874 4.54466 1.05582 5 1.46033 5H6.53967C6.94418 5 7.18126 4.54466 6.94929 4.21327L4.40962 0.585167Z"
                                                fill="currentColor" />
                                        </svg>
                                        <svg :class="sort.key === 'amount' && !sort.asc ? 'text-gray-800' : 'text-gray-300'"
                                            width="8" height="5" viewBox="0 0 8 5" fill="none">
                                            <path
                                                d="M4.40962 4.41483C4.21057 4.69919 3.78943 4.69919 3.59038 4.41483L1.05071 0.786732C0.81874 0.455343 1.05582 0 1.46033 0H6.53967C6.94418 0 7.18126 0.455342 6.94929 0.786731L4.40962 4.41483Z"
                                                fill="currentColor" />
                                        </svg>
                                    </span>
                                </div>
                            </th>
                            <th class="p-4 text-left text-xs font-medium whitespace-nowrap text-gray-500">
                                Direct OS
                            </th>
                            <th class="p-4 text-left text-xs font-medium whitespace-nowrap text-gray-500">
                                <div class="flex cursor-pointer items-center gap-3" @click="sortBy('maturity')">
                                    <p class="text-xs font-medium text-gray-500">
                                        Maturity Date
                                    </p>
                                    <span class="flex flex-col gap-0.5">
                                        <svg :class="sort.key === 'maturity' && sort.asc ? 'text-gray-800' : 'text-gray-300'"
                                            width="8" height="5" viewBox="0 0 8 5" fill="none">
                                            <path
                                                d="M4.40962 0.585167C4.21057 0.300808 3.78943 0.300807 3.59038 0.585166L1.05071 4.21327C0.81874 4.54466 1.05582 5 1.46033 5H6.53967C6.94418 5 7.18126 4.54466 6.94929 4.21327L4.40962 0.585167Z"
                                                fill="currentColor" />
                                        </svg>
                                        <svg :class="sort.key === 'maturity' && !sort.asc ? 'text-gray-800' : 'text-gray-300'"
                                            width="8" height="5" viewBox="0 0 8 5" fill="none">
                                            <path
                                                d="M4.40962 4.41483C4.21057 4.69919 3.78943 4.69919 3.59038 4.41483L1.05071 0.786732C0.81874 0.455343 1.05582 0 1.46033 0H6.53967C6.94418 0 7.18126 0.455342 6.94929 0.786731L4.40962 4.41483Z"
                                                fill="currentColor" />
                                        </svg>
                                    </span>
                                </div>
                            </th>
                            <th class="p-4 text-left text-xs font-medium whitespace-nowrap text-gray-500">
                                Status
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-x divide-y divide-gray-200">
                        <!-- No Data Message -->
                        <tr x-show="paginatedRows.length === 0">
                            <td colspan="8" class="p-8 text-center text-gray-500">
                                <div class="flex flex-col items-center justify-center gap-3">
                                    <svg class="w-12 h-12 text-gray-300" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4">
                                        </path>
                                    </svg>
                                    <p class="text-sm font-medium">No data available</p>
                                    <p class="text-xs text-gray-400">
                                        Please ensure data is loaded from the file
                                    </p>
                                </div>
                            </td>
                        </tr>
                        <!-- Data Rows -->
                        <template x-for="row in paginatedRows" :key="row.id">
                            <tr class="transition hover:bg-gray-50">
                                <td class="p-4 whitespace-nowrap">
                                    <span class="text-xs font-medium text-gray-700" x-text="row.facilityId"></span>
                                </td>
                                <td class="p-4 whitespace-nowrap">
                                    <span class="text-sm font-medium text-gray-700" x-text="row.relationship"></span>
                                </td>
                                <td class="p-4 whitespace-nowrap">
                                    <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium"
                                        :class="{
                                            'bg-blue-50 text-blue-700': row.region === 'NAM',
                                            'bg-green-50 text-green-700': row.region === 'EMEA',
                                            'bg-orange-50 text-orange-700': row.region === 'APAC',
                                            'bg-purple-50 text-purple-700': row.region === 'LATAM'
                                        }" x-text="row.region"></span>
                                </td>
                                <td class="p-4 whitespace-nowrap">
                                    <p class="text-sm text-gray-500" x-text="row.product"></p>
                                </td>
                                <td class="p-4 whitespace-nowrap">
                                    <p class="text-sm text-gray-700" x-text="row.facilityAmount"></p>
                                </td>
                                <td class="p-4 whitespace-nowrap">
                                    <p class="text-sm text-gray-700" x-text="row.directOS"></p>
                                </td>
                                <td class="p-4 whitespace-nowrap">
                                    <p class="text-sm text-gray-700">
                                        <span x-text="row.maturityDate"></span>
                                    </p>
                                </td>
                                <td class="p-4 whitespace-nowrap">
                                    <span class="text-xs rounded-full px-2 py-0.5 font-medium" :class="{
                                            'bg-success-50 text-success-700': row.status === 'Active',
                                            'bg-warning-50 text-warning-700': row.status === 'Expiring Soon',
                                            'bg-red-50 text-red-700': row.status === 'Expired'
                                        }" x-text="row.status"></span>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="border-t border-gray-200 px-5 py-4">
                <div class="flex justify-center pb-4 sm:hidden">
                    <span class="block text-sm font-medium text-gray-500">
                        Showing <span class="text-gray-800" x-text="startEntry"></span> to
                        <span class="text-gray-800" x-text="endEntry"></span> of
                        <span class="text-gray-800" x-text="totalRows"></span>
                    </span>
                </div>

                <div class="flex items-center justify-between">
                    <div class="hidden sm:block">
                        <span class="block text-sm font-medium text-gray-500">
                            Showing
                            <span class="text-gray-800" x-text="startEntry"></span> to
                            <span class="text-gray-800" x-text="endEntry"></span> of
                            <span class="text-gray-800" x-text="totalRows"></span>
                        </span>
                    </div>
                    <div
                        class="flex w-full items-center justify-between gap-2 rounded-lg bg-gray-50 p-4 sm:w-auto sm:justify-normal sm:rounded-none sm:bg-transparent sm:p-0">
                        <button @click="page > 1 && page--" :disabled="page === 1"
                            class="shadow-theme-xs flex items-center gap-2 rounded-lg border border-gray-300 bg-white p-2 text-gray-700 hover:bg-gray-50 hover:text-gray-800 disabled:cursor-not-allowed disabled:opacity-50 sm:p-2.5">
                            <span>
                                <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                    <path fill-rule="evenodd" clip-rule="evenodd"
                                        d="M2.58203 9.99868C2.58174 10.1909 2.6549 10.3833 2.80152 10.53L7.79818 15.5301C8.09097 15.8231 8.56584 15.8233 8.85883 15.5305C9.15183 15.2377 9.152 14.7629 8.85921 14.4699L5.13911 10.7472L16.6665 10.7472C17.0807 10.7472 17.4165 10.4114 17.4165 9.99715C17.4165 9.58294 17.0807 9.24715 16.6665 9.24715L5.14456 9.24715L8.85919 5.53016C9.15199 5.23717 9.15184 4.7623 8.85885 4.4695C8.56587 4.1767 8.09099 4.17685 7.79819 4.46984L2.84069 9.43049C2.68224 9.568 2.58203 9.77087 2.58203 9.99715C2.58203 9.99766 2.58203 9.99817 2.58203 9.99868Z"
                                        fill="" />
                                </svg>
                            </span>
                    </button>

                        <span class="block text-sm font-medium text-gray-700 sm:hidden">
                            Page <span x-text="page"></span> of
                            <span x-text="totalPages"></span>
                    </span>

                        <ul class="hidden items-center gap-0.5 sm:flex">
                            <template x-for="n in displayPages" :key="n">
                                <li>
                                    <a href="#" @click.prevent="goToPage(n)"
                                        :class="page === n ? 'bg-blue-500 text-white' : 'hover:bg-blue-500 text-gray-700 hover:text-white'"
                                        class="flex h-10 w-10 items-center justify-center rounded-lg text-sm font-medium">
                                        <span x-text="n"></span>
                                    </a>
                                </li>
                            </template>
                        </ul>

                        <button @click="page < totalPages && page++" :disabled="page === totalPages"
                            class="shadow-theme-xs flex items-center gap-2 rounded-lg border border-gray-300 bg-white p-2 text-gray-700 hover:bg-gray-50 hover:text-gray-800 disabled:cursor-not-allowed disabled:opacity-50 sm:p-2.5">
                            <span>
                                <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                    <path fill-rule="evenodd" clip-rule="evenodd"
                                        d="M17.4165 9.9986C17.4168 10.1909 17.3437 10.3832 17.197 10.53L12.2004 15.5301C11.9076 15.8231 11.4327 15.8233 11.1397 15.5305C10.8467 15.2377 10.8465 14.7629 11.1393 14.4699L14.8594 10.7472L3.33203 10.7472C2.91782 10.7472 2.58203 10.4114 2.58203 9.99715C2.58203 9.58294 2.91782 9.24715 3.33203 9.24715L14.854 9.24715L11.1393 5.53016C10.8465 5.23717 10.8467 4.7623 11.1397 4.4695C11.4327 4.1767 11.9075 4.17685 12.2003 4.46984L17.1578 9.43049C17.3163 9.568 17.4165 9.77087 17.4165 9.99715C17.4165 9.99763 17.4165 9.99812 17.4165 9.9986Z"
                                        fill="" />
                                </svg>
                            </span>
                    </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Important Notes -->
        <div class="overflow-hidden rounded-xl border border-gray-200 bg-white">
            <div class="flex items-start gap-3 px-5 py-4">
                <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-blue-100 mt-1">
                    <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="flex-1">
                    <h4 class="text-sm font-semibold text-gray-800 mb-3">
                        Important Notes
                    </h4>
                    <div class="text-xs text-gray-600 space-y-2.5">
                        <div class="flex items-start gap-2">
                            <span class="font-semibold text-gray-700 mt-0.5">*</span>
                            <p>
                                <span class="font-semibold text-gray-700">OSUC (Outstanding Undrawn Committed):</span>
                                Calculated based on the Committed/Uncommitted column. If
                                "Committed", OSUC = Fac_Amount - (Direct_OS + Contingent_OS +
                                PSE_OS); if "Uncommitted", OSUC = 0. These values are based on
                                regional credit data and may vary from risk-reported values as
                                they are not sourced from Optima.
                            </p>
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="font-semibold text-gray-700 mt-0.5">*</span>
                            <p>
                                <span class="font-semibold text-gray-700">Undrawn (Unused Committed):</span>
                                Calculated based on the Committed/Uncommitted column. If
                                "Committed", Unused_Committed = Fac_Amount - (Direct_OS +
                                Contingent_OS + PSE_OS); if "Uncommitted", Unused_Committed =
                                0. Only committed facilities show values; uncommitted
                                facilities show as $0.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Methodology Modal -->
        <div id="methodologyModal" class="fixed inset-0 z-[9999] hidden items-center justify-center p-5">
            <div class="modal-close-btn fixed inset-0 h-full w-full bg-gray-400/50 backdrop-blur-[32px]"
                onclick="closeMethodologyModal()"></div>
            <div class="relative w-full max-w-[600px] max-h-[85vh] rounded-3xl bg-white shadow-2xl flex flex-col">
                <!-- Close button -->
                <button onclick="closeMethodologyModal()" type="button"
                    class="absolute right-3 top-3 z-[9999] flex h-9.5 w-9.5 items-center justify-center rounded-full bg-gray-100 text-gray-400 transition-colors hover:bg-gray-200 hover:text-gray-700 sm:right-6 sm:top-6 sm:h-11 sm:w-11 cursor-pointer">
                    <svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M6.04289 16.5413C5.65237 16.9318 5.65237 17.565 6.04289 17.9555C6.43342 18.346 7.06658 18.346 7.45711 17.9555L11.9987 13.4139L16.5408 17.956C16.9313 18.3466 17.5645 18.3466 17.955 17.956C18.3455 17.5655 18.3455 16.9323 17.955 16.5418L13.4129 11.9997L17.955 7.4576C18.3455 7.06707 18.3455 6.43391 17.955 6.04338C17.5645 5.65286 16.9313 5.65286 16.5408 6.04338L11.9987 10.5855L7.45711 6.0439C7.06658 5.65338 6.43342 5.65338 6.04289 6.0439C5.65237 6.43442 5.65237 7.06759 6.04289 7.45811L10.5845 11.9997L6.04289 16.5413Z"
                            fill="" />
                    </svg>
                </button>

                <!-- Fixed Header -->
                <div class="flex-shrink-0 text-center p-6 lg:px-10 lg:pt-10 lg:pb-6">
                    <div class="relative flex items-center justify-center z-1 mb-4">
                        <svg class="fill-blue-50" width="70" height="70" viewBox="0 0 90 90" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M34.364 6.85053C38.6205 -2.28351 51.3795 -2.28351 55.636 6.85053C58.0129 11.951 63.5594 14.6722 68.9556 13.3853C78.6192 11.0807 86.5743 21.2433 82.2185 30.3287C79.7862 35.402 81.1561 41.5165 85.5082 45.0122C93.3019 51.2725 90.4628 63.9451 80.7747 66.1403C75.3648 67.3661 71.5265 72.2695 71.5572 77.9156C71.6123 88.0265 60.1169 93.6664 52.3918 87.3184C48.0781 83.7737 41.9219 83.7737 37.6082 87.3184C29.8831 93.6664 18.3877 88.0266 18.4428 77.9156C18.4735 72.2695 14.6352 67.3661 9.22531 66.1403C-0.462787 63.9451 -3.30193 51.2725 4.49185 45.0122C8.84391 41.5165 10.2138 35.402 7.78151 30.3287C3.42572 21.2433 11.3808 11.0807 21.0444 13.3853C26.4406 14.6722 31.9871 11.951 34.364 6.85053Z"
                                fill="" fill-opacity="" />
                        </svg>
                        <span class="absolute -translate-x-1/2 -translate-y-1/2 left-1/2 top-1/2">
                            <svg class="fill-blue-600" width="32" height="32" viewBox="0 0 38 38" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" clip-rule="evenodd"
                                    d="M5.85547 18.9998C5.85547 11.7396 11.7411 5.854 19.0013 5.854C26.2615 5.854 32.1471 11.7396 32.1471 18.9998C32.1471 26.2601 26.2615 32.1457 19.0013 32.1457C11.7411 32.1457 5.85547 26.2601 5.85547 18.9998ZM19.0013 2.854C10.0842 2.854 2.85547 10.0827 2.85547 18.9998C2.85547 27.9169 10.0842 35.1457 19.0013 35.1457C27.9184 35.1457 35.1471 27.9169 35.1471 18.9998C35.1471 10.0827 27.9184 2.854 19.0013 2.854ZM16.9999 11.9145C16.9999 13.0191 17.8953 13.9145 18.9999 13.9145H19.0015C20.106 13.9145 21.0015 13.0191 21.0015 11.9145C21.0015 10.81 20.106 9.91454 19.0015 9.91454H18.9999C17.8953 9.91454 16.9999 10.81 16.9999 11.9145ZM19.0014 27.8171C18.173 27.8171 17.5014 27.1455 17.5014 26.3171V17.3293C17.5014 16.5008 18.173 15.8293 19.0014 15.8293C19.8299 15.8293 20.5014 16.5008 20.5014 17.3293L20.5014 26.3171C20.5014 27.1455 19.8299 27.8171 19.0014 27.8171Z"
                                    fill="" />
                            </svg>
                        </span>
    </div>

                    <h4 class="text-xl font-semibold text-gray-800 sm:text-2xl" id="methodologyModalTitle">
                        Chart Methodology
                    </h4>
                </div>

                <!-- Scrollable Content -->
                <div class="flex-1 overflow-y-auto px-6 lg:px-10">
                    <div class="text-sm leading-6 text-gray-600 text-left pb-4" id="methodologyModalContent">
                        <!-- Dynamic content will be inserted here -->
                    </div>
                </div>

                <!-- Fixed Footer -->
                <div class="flex-shrink-0 border-t border-gray-100 p-6 lg:px-10 lg:pb-10 lg:pt-6">
                    <div class="flex items-center justify-center w-full">
                        <button type="button" onclick="closeMethodologyModal()"
                            class="flex justify-center w-full px-4 py-3 text-sm font-medium text-white rounded-lg bg-blue-600 shadow-theme-xs hover:bg-blue-700 sm:w-auto">
                            Okay, Got It
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Data Viewer Modal -->
        <div id="chartDataModal" class="fixed inset-0 z-[9999] hidden overflow-y-auto" aria-labelledby="modal-title"
            role="dialog" aria-modal="true">
            <!-- Background overlay -->
            <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" onclick="closeChartDataModal()">
            </div>

            <!-- Modal panel -->
            <div class="flex min-h-full items-center justify-center p-4">
                <div
                    class="relative w-full max-w-7xl transform overflow-hidden rounded-2xl bg-white shadow-2xl transition-all">
                    <!-- Modal header -->
                    <div class="border-b border-gray-200 bg-white px-6 py-4">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-900" id="chartDataModalTitle">
                                    Chart Data
                                </h3>
                                <p class="mt-1 text-sm text-gray-500" id="chartDataModalSubtitle">
                                    Viewing underlying data
                                </p>
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="exportModalData()"
                                    class="flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                        </path>
                                    </svg>
                                    Export XLSX
                                </button>
                                <button onclick="closeChartDataModal()" type="button"
                                    class="flex h-9.5 w-9.5 items-center justify-center rounded-full bg-gray-100 text-gray-400 transition-colors hover:bg-gray-200 hover:text-gray-700 sm:h-11 sm:w-11 cursor-pointer">
                                    <svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" clip-rule="evenodd"
                                            d="M6.04289 16.5413C5.65237 16.9318 5.65237 17.565 6.04289 17.9555C6.43342 18.346 7.06658 18.346 7.45711 17.9555L11.9987 13.4139L16.5408 17.956C16.9313 18.3466 17.5645 18.3466 17.955 17.956C18.3455 17.5655 18.3455 16.9323 17.955 16.5418L13.4129 11.9997L17.955 7.4576C18.3455 7.06707 18.3455 6.43391 17.955 6.04338C17.5645 5.65286 16.9313 5.65286 16.5408 6.04338L11.9987 10.5855L7.45711 6.0439C7.06658 5.65338 6.43342 5.65338 6.04289 6.0439C5.65237 6.43442 5.65237 7.06759 6.04289 7.45811L10.5845 11.9997L6.04289 16.5413Z"
                                            fill="" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Modal body with scrollable table -->
                    <div class="max-h-[70vh] overflow-auto bg-white">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr id="chartDataTableHeader">
                                    <!-- Dynamic headers will be inserted here -->
                                </tr>
                            </thead>
                            <tbody id="chartDataTableBody" class="divide-y divide-gray-200">
                                <!-- Dynamic rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Modal footer -->
                    <div class="border-t border-gray-200 bg-gray-50 px-6 py-4">
                        <div class="flex items-center justify-between">
                            <p class="text-sm text-gray-500">
                                Scroll to view all columns and rows
                            </p>
                            <button onclick="closeChartDataModal()" type="button"
                                class="rounded-lg bg-gray-200 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-300 transition-colors">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== PORTFOLIO ANALYTICS CONFIGURATION =====
        // This dashboard loads data from Confluence in READ-ONLY mode
        // Similar to cmps.html, data is fetched from an attachment but never modified
        // All filters and options are dynamically populated from the loaded data
        
        // Update these values to match your Confluence page and attachment
        const CONFLUENCE_PAGE_ID = "2740868871"; // Your Confluence page ID
        const CONFLUENCE_FILE_NAME = "palDashboard.csv"; // Your attachment filename (can be .csv, .xlsx, or .xls)
        const CONFLUENCE_BASE_URL = "https://cedt-confluence.net/confluence";
        // ==========================================
        
        // ===== PERFORMANCE OPTIMIZATIONS FOR 40K+ ROWS =====
        // 1. INDEX CACHING: Pre-parse dates and build indexes for fast filtering
        // 2. SMART FILTERING: Early exit loops, minimal object access, use for-loops not .filter()
        // 3. RESULT CACHING: Cache filtered results to avoid re-filtering same queries
        // 4. SINGLE-PASS METRICS: Calculate all metrics in one loop instead of multiple passes
        // 5. OPTIMIZED CHARTS: Use Map() instead of objects, limit data points
        // 6. DEBOUNCED SEARCH: 500ms delay to prevent filtering on every keystroke
        // 7. LARGER PAGE SIZE: 50 rows per page (fewer renders = better performance)
        // 8. ASYNC RENDERING: Use requestAnimationFrame to prevent UI blocking
        // 
        // Expected Performance: 40K rows should filter in 50-200ms (was 2-5 seconds)
        // =====================================================

        // Global variables
        let portfolioData = [];
        let filteredData = [];
        let currentPage = 1;
        let rowsPerPage = 20; // Show 20 rows per page, load more on pagination
        let expirationChartInstance = null;
        let searchDebounceTimer = null;
        let relationshipChartInstance = null;
        let facilityTrendChartInstance = null; // Store facility trend chart instance
        let facilityMaturityChartInstance = null; // Store facility maturity chart instance
        let creditClassificationChartInstance = null; // Store credit classification chart instance
        let rotceChartInstance = null; // Store ROTCE chart instance
        let updateBarChartTimer = null; // Debounce timer for bar chart updates
        let activeFilters = {};
        let selectedMetricType = "facilityAmount"; // Default to Facility Amount
        
        // Smart Filter States
        let selectedRegion = "all"; // all, APAC, EMEA, LATAM, NAM
        let includePSE = true; // true = include PSE, false = exclude PSE
        let selectedStatus = "all"; // all, CM, DM
        let selectedAmountType = "direct"; // direct, contingent, pse, osuc, tfa (for metrics)
        let selectedPeriod = "current"; // current, previous (for New Facilities Approved in CP by Product Program chart)

        // Cross-filtering state management
        let chartFilter = {
            active: false,
            type: null, // 'relationship', 'region', 'product', 'facilityType', etc.
            value: null, // The clicked value (e.g., relationship name, region name, etc.)
            label: null, // Display label for UI
        };
        
        // Performance optimization: Cache for expensive calculations
        let metricsCache = {
            full: null,
            filtered: null,
            filterHash: "",
        };
        let indexCache = {
            byRegion: null,
            byProduct: null,
            byRelationship: null,
            dates: null,
        };

        // Initialize on page load
        document.addEventListener("DOMContentLoaded", function () {
            console.log("=== Portfolio Analytics Dashboard ===");
            console.log("READ-ONLY mode - Loading data from Confluence");
            console.log("Page ID:", CONFLUENCE_PAGE_ID);
            console.log("File:", CONFLUENCE_FILE_NAME);
            console.log("=====================================");
            
            // Verify all required libraries are loaded
            if (typeof ApexCharts === "undefined") {
                console.error(
                    " ApexCharts library not loaded! Charts will not work."
                );
                showNotification(
                    "Error",
                    "ApexCharts library failed to load. Please refresh the page.",
                    "error"
                );
            } else {
                console.log(" ApexCharts library loaded successfully");
            }

            if (typeof XLSX === "undefined") {
                console.warn(
                    "  XLSX library not loaded. Excel file parsing may not work."
                );
            } else {
                console.log(" XLSX library loaded successfully");
            }
            
            // Load data from Confluence attachment
            loadDataFromCSV();
            
            // Setup search functionality with debouncing (increased for large datasets)
            document
                .getElementById("searchInput")
                .addEventListener("input", function () {
                // Clear previous timer
                if (searchDebounceTimer) {
                    clearTimeout(searchDebounceTimer);
                }
                
                // Set new timer - wait 500ms after user stops typing (longer for 40K rows)
                searchDebounceTimer = setTimeout(() => {
                    filterData();
                }, 500);
            });
        });

        // Refresh data from Confluence (read-only, no write operations)
        async function refreshData() {
            showLoadingState();
            try {
                console.log("Refreshing data from Confluence...");
                const data = await fetchDataFromConfluence();
                
                if (data && data.length > 0) {
                    portfolioData = data;
                    
                    // Clear all caches
                    metricsCache = { full: null, filtered: null, filterHash: "" };
                    indexCache = {
                        byRegion: null,
                        byProduct: null,
                        byRelationship: null,
                        dates: null,
                    };
                    
                    // Rebuild indexes
                    buildIndexes();
                    
                    // Repopulate filter options with fresh data
                    populateFilterOptions();
                    
                    // Recalculate all metrics and charts
                    calculateMetrics();
                    createFacilityTrendChart();
                    createRelationshipChart();
                    createCreditClassificationChart();
                    createROTCEChart();
                    
                    // Reset filters and reload data
                    activeFilters = {};
                    displayFilterBadges();
                    updateFilterCount();
                    filterData();
                    
                    showNotification(
                        "Success",
                        `Refreshed ${data.length.toLocaleString()} records successfully`,
                        "success"
                    );
                } else {
                    console.error("No data received from Confluence");
                    showNotification(
                        "Error",
                        "Failed to refresh data from Confluence",
                        "error"
                    );
                }
            } catch (error) {
                console.error("Error refreshing data:", error);
                showNotification(
                    "Error",
                    "Failed to refresh data: " + error.message,
                    "error"
                );
            }
        }

        // Load data from Confluence attachment (read-only)
        async function loadDataFromCSV() {
            showLoadingOverlay(
                "Fetching data from Confluence...",
                "Connecting to server..."
            );
            showLoadingState();
            
            try {
                const data = await fetchDataFromConfluence();
                
                if (data && data.length > 0) {
                    portfolioData = data;
                    console.log(`Loaded ${data.length} records from Confluence`);
                    
                    showLoadingOverlay(
                        "Processing data...",
                        `Loading ${data.length.toLocaleString()} records...`
                    );
                    
                    // Use setTimeout to allow UI to update
                    setTimeout(() => {
                        initializeDashboard();
                        hideLoadingOverlay();
                        showNotification(
                            "Success",
                            `Loaded ${data.length.toLocaleString()} records successfully`,
                            "success"
                        );
                    }, 100);
                } else {
                    console.error("No data from Confluence");
                    hideLoadingOverlay();
                    showNotification(
                        "Error",
                        "No data found in Confluence attachment",
                        "error"
                    );
                }
            } catch (error) {
                console.error("Error loading data from Confluence:", error);
                hideLoadingOverlay();
                showNotification(
                    "Error",
                    "Failed to load data from Confluence: " + error.message,
                    "error"
                );
            }
        }

        // Fetch data from Confluence attachment (read-only, no updates)
        async function fetchDataFromConfluence() {
            try {
                // Construct Confluence API URL
                const url = `${CONFLUENCE_BASE_URL}/download/attachments/${CONFLUENCE_PAGE_ID}/${CONFLUENCE_FILE_NAME}?api=v2`;
                
                console.log("Fetching portfolio data from Confluence:", url);
                console.log("File name:", CONFLUENCE_FILE_NAME);
                
                const response = await fetch(url, {
                    headers: {
                        "X-Atlassian-Token": "no-check",
                    },
                });

                if (!response.ok) {
                    throw new Error(
                        `Failed to fetch ${CONFLUENCE_FILE_NAME}: ${response.status} ${response.statusText}`
                    );
                }

                console.log("Successfully fetched file from Confluence");
                const blob = await response.blob();
                console.log("Blob size:", blob.size, "bytes");
                
                // Parse based on file type
                if (CONFLUENCE_FILE_NAME.endsWith(".csv")) {
                    console.log("Parsing CSV file...");
                    return await parseCSVBlob(blob);
                } else if (
                    CONFLUENCE_FILE_NAME.endsWith(".xlsx") ||
                    CONFLUENCE_FILE_NAME.endsWith(".xls")
                ) {
                    console.log("Parsing Excel file...");
                    return await parseExcelBlob(blob);
                }
                
                throw new Error(
                    "Unsupported file format. Please use .csv, .xlsx, or .xls files."
                );
            } catch (error) {
                console.error("Error fetching data from Confluence:", error.message);
                return null;
            }
        }

        // Parse CSV blob (read-only)
        async function parseCSVBlob(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const text = e.target.result;
                        const lines = text.split("\n");
                        const headers = lines[0].split(",").map((h) => h.trim());
                        
                        console.log("CSV Headers:", headers);
                        
                        const data = [];
                        for (let i = 1; i < lines.length; i++) {
                            if (lines[i].trim()) {
                                const values = lines[i].split(",");
                                const row = {};
                                headers.forEach((header, index) => {
                                    row[header] = values[index] ? values[index].trim() : "";
                                });
                                // Only add rows with Facility_ID
                                if (row.Facility_ID) {
                                    data.push(row);
                                }
                            }
                        }
                        
                        console.log(`Parsed ${data.length} records from CSV`);
                        resolve(data);
                    } catch (error) {
                        console.error("Error parsing CSV:", error);
                        reject(error);
                    }
                };
                reader.onerror = () => {
                    console.error("FileReader error while reading CSV");
                    reject(new Error("Failed to read CSV file"));
                };
                reader.readAsText(blob);
            });
        }

        // Parse Excel blob (read-only)
        async function parseExcelBlob(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        
                        // Important: cellDates: true converts Excel date serial numbers to JS Dates
                        const workbook = XLSX.read(data, { 
                            type: "array",
                            cellDates: true, // Convert Excel dates to JavaScript dates
                            cellNF: false,
                            cellText: false,
                        });
                        
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        
                        console.log("Excel Sheet Name:", workbook.SheetNames[0]);
                        
                        // Convert sheet to JSON with date formatting
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
                            raw: false, // Don't use raw values (converts dates to strings)
                            dateNF: "yyyy-mm-dd", // Date format
                        });
                        
                        console.log(`Total rows in Excel: ${jsonData.length}`);
                        
                        // Filter out empty rows (rows without Facility_ID)
                        const filteredData = jsonData.filter((row) => row.Facility_ID);
                        
                        console.log(
                            `Parsed ${filteredData.length} valid records from Excel`
                        );
                        
                        // Log data structure for debugging
                        if (filteredData.length > 0) {
                            console.log(
                                "Sample record fields:",
                                Object.keys(filteredData[0])
                            );
                            console.log(
                                "Sample Maturity_Date:",
                                filteredData[0].Maturity_Date,
                                typeof filteredData[0].Maturity_Date
                            );
                            console.log(
                                "Sample CA_Expiration_Date:",
                                filteredData[0].CA_Expiration_Date,
                                typeof filteredData[0].CA_Expiration_Date
                            );
                            console.log(
                                "Sample Report_Date:",
                                filteredData[0].Report_Date,
                                typeof filteredData[0].Report_Date
                            );
                        }
                        
                        resolve(filteredData);
                    } catch (error) {
                        console.error("Error parsing Excel:", error);
                        reject(error);
                    }
                };
                reader.onerror = () => {
                    console.error("FileReader error while reading Excel file");
                    reject(new Error("Failed to read Excel file"));
                };
                reader.readAsArrayBuffer(blob);
            });
        }

        // Show loading overlay
        function showLoadingOverlay(
            message = "Please wait while we fetch your data...",
            progress = ""
        ) {
            const overlay = document.getElementById("loadingOverlay");
            const messageEl = document.getElementById("loadingMessage");
            const progressEl = document.getElementById("loadingProgress");
            
            if (overlay) {
                overlay.classList.remove("hidden");
                if (messageEl) messageEl.textContent = message;
                if (progressEl) progressEl.textContent = progress;
            }
        }

        // Hide loading overlay
        function hideLoadingOverlay() {
            const overlay = document.getElementById("loadingOverlay");
            if (overlay) {
                overlay.classList.add("hidden");
            }
        }

        // Show loading state
        function showLoadingState() {
            const tbody = document.getElementById("tableBody");
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="py-16">
                            <div class="flex flex-col items-center justify-center">
                                <div class="relative">
                                    <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-200"></div>
                                    <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-600 border-t-transparent absolute top-0 left-0"></div>
                                </div>
                                <div class="mt-6 text-center">
                                    <span class="text-base font-medium text-gray-700">Loading data...</span>
                                    <p class="text-sm text-gray-500 mt-1">Fetching portfolio information from Confluence</p>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        // Show notification
        function showNotification(title, message, type = "success") {
            const colors = {
                success: {
                    bg: "bg-green-100",
                    text: "text-green-600",
                    border: "border-green-200",
                },
                error: {
                    bg: "bg-red-100",
                    text: "text-red-600",
                    border: "border-red-200",
                },
                warning: {
                    bg: "bg-yellow-100",
                    text: "text-yellow-600",
                    border: "border-yellow-200",
                },
                info: {
                    bg: "bg-blue-100",
                    text: "text-blue-600",
                    border: "border-blue-200",
                },
            };
            
            const color = colors[type] || colors.success;
            const notification = document.createElement("div");
            notification.className = `fixed top-4 right-4 ${color.bg} ${color.border} border ${color.text} px-4 py-3 rounded-lg shadow-lg z-50 max-w-md`;
            notification.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="flex-1">
                        <h4 class="font-semibold">${title}</h4>
                        <p class="text-sm">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }


        // Build indexes for fast filtering (one-time operation)
        function buildIndexes() {
            console.log("Building indexes for fast filtering...");
            const startTime = performance.now();
            
            indexCache.byRegion = new Map();
            indexCache.byProduct = new Map();
            indexCache.byRelationship = new Map();
            indexCache.dates = [];
            
            portfolioData.forEach((row, idx) => {
                // Region index
                const region = row.Region;
                if (region) {
                    if (!indexCache.byRegion.has(region)) {
                        indexCache.byRegion.set(region, []);
                    }
                    indexCache.byRegion.get(region).push(idx);
                }
                
                // Product index
                const product = row.Product_Program;
                if (product) {
                    if (!indexCache.byProduct.has(product)) {
                        indexCache.byProduct.set(product, []);
                    }
                    indexCache.byProduct.get(product).push(idx);
                }
                
                // Relationship index
                const relationship = row.Relationship_Name || row.Relationship_ID;
                if (relationship) {
                    if (!indexCache.byRelationship.has(relationship)) {
                        indexCache.byRelationship.set(relationship, []);
                    }
                    indexCache.byRelationship.get(relationship).push(idx);
                }
                
                // Pre-parse dates for faster filtering
                const maturityDate = parseDate(row.Maturity_Date);
                const caDate = parseDate(row.CA_Expiration_Date);
                indexCache.dates.push({
                    maturityDate,
                    caDate,
                });
            });
            
            const endTime = performance.now();
            console.log(
                `Indexes built in ${((endTime - startTime) / 1000).toFixed(
                    2
                )} seconds`
            );
        }
        
        // Generate hash of active filters for cache validation
        function getFilterHash() {
            return (
                JSON.stringify(activeFilters) +
                "_" +
                document.getElementById("searchInput").value
            );
        }

        // Initialize dashboard with data (optimized for large datasets)
        function initializeDashboard() {
            const startTime = performance.now();
            console.log(
                "Initializing dashboard with",
                portfolioData.length,
                "records..."
            );
            
            // Safety check
            if (!portfolioData || portfolioData.length === 0) {
                console.error("No portfolio data loaded!");
                showNotification("Error", "No portfolio data available", "error");
                return;
            }
            
            // Log data structure for debugging
            console.log("Data row example:", portfolioData[0]);
            console.log("Available fields:", Object.keys(portfolioData[0]));
            
            // Step 1: Build indexes (one-time, makes filtering much faster)
            console.time("Build Indexes");
            buildIndexes();
            console.timeEnd("Build Indexes");
            
            // Step 2: Populate filters
            console.time("Populate Filters");
            populateFilterOptions();
            console.timeEnd("Populate Filters");
            
            // Step 3: Update report date
            console.time("Update Report Date");
            updateReportDate();
            console.timeEnd("Update Report Date");
            
            // Step 4: Calculate metrics (with caching)
            console.time("Calculate Metrics");
            calculateMetrics();
            console.timeEnd("Calculate Metrics");
            
            // Step 5: Create charts with sampled data (faster)
            console.time("Create Charts");
            createFacilityTrendChart();
            createRelationshipChart();
            createCreditClassificationChart();
            createROTCEChart();
            console.timeEnd("Create Charts");
            
            // Step 6: Filter and render table (only first page)
            console.time("Filter and Render Table");
            filterData();
            console.timeEnd("Filter and Render Table");
            
            const endTime = performance.now();
            console.log(
                `Dashboard initialized in ${((endTime - startTime) / 1000).toFixed(
                    2
                )} seconds`
            );
        }

        // Populate filter dropdowns with unique values from Confluence data (read-only)
        function populateFilterOptions() {
            if (!portfolioData || portfolioData.length === 0) {
                console.warn("No portfolio data available to populate filters");
                return;
            }

            console.log(
                "Populating filter options from",
                portfolioData.length,
                "records"
            );
            
            // Product Program
            const products = [
                ...new Set(
                    portfolioData.map((row) => row.Product_Program).filter(Boolean)
                ),
            ].sort();
            populateSelect("filterProductProgram", products);
            console.log("Product Programs:", products.length, "options");
            
            // Extending Unit (Control_Unit)
            const units = [
                ...new Set(
                    portfolioData.map((row) => row.Control_Unit).filter(Boolean)
                ),
            ].sort();
            populateSelect("filterExtendingUnit", units);
            console.log("Extending Units:", units.length, "options");
            
            // Facility Type
            const facilityTypes = [
                ...new Set(
                    portfolioData.map((row) => row.Facility_Type).filter(Boolean)
                ),
            ].sort();
            populateSelect("filterFacilityType", facilityTypes);
            console.log("Facility Types:", facilityTypes.length, "options");
            
            // Committed/Uncommitted
            const commitments = [
                ...new Set(
                    portfolioData
                        .map((row) => row["Committed/Uncommitted"])
                        .filter(Boolean)
                ),
            ].sort();
            populateSelect("filterCommitment", commitments);
            console.log("Commitment Status:", commitments.length, "options");
            
            // Team Lead (Underwriter_Team_Lead)
            const teamLeads = [
                ...new Set(
                    portfolioData
                        .map((row) => row.Underwriting_Team_Lead)
                        .filter(Boolean)
                ),
            ].sort();
            populateSelect("filterTeamLead", teamLeads);
            console.log("Team Leads:", teamLeads.length, "options");
            
            // Underwriter (Lead_Underwriter)
            const underwriters = [
                ...new Set(
                    portfolioData.map((row) => row.Lead_Underwriter).filter(Boolean)
                ),
            ].sort();
            populateSelect("filterUnderwriter", underwriters);
            console.log("Underwriters:", underwriters.length, "options");
        }

        // Helper to populate a select element
        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) {
                console.warn(`Select element with id '${selectId}' not found`);
                return;
            }
            const currentValue = select.value;
            
            // Keep the first option (All...)
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            options.forEach((option) => {
                const opt = document.createElement("option");
                opt.value = option;
                opt.textContent = option;
                select.appendChild(opt);
            });
            
            // Restore previous value if it still exists
            if (currentValue && options.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // Apply all filters (OPTIMIZED for 40K+ rows)
        function applyFilters() {
            const startTime = performance.now();
            
            // Get advanced filter values (excluding Region and Status which are in smart filters)
            const filters = {
                productProgram: document.getElementById("filterProductProgram").value,
                extendingUnit: document.getElementById("filterExtendingUnit").value,
                facilityType: document.getElementById("filterFacilityType").value,
                commitment: document.getElementById("filterCommitment").value,
                teamLead: document.getElementById("filterTeamLead").value,
                underwriter: document.getElementById("filterUnderwriter").value,
                caMaturity: document.getElementById("filterCAMaturity").value,
                facilityMaturity: document.getElementById("filterFacilityMaturity")
                    .value,
            };

            // Update active filters object (including Region and Status smart filters)
            activeFilters = {};
            
            // Add smart filters to activeFilters
            if (selectedRegion !== 'all')
                activeFilters["Region"] = selectedRegion;
            if (selectedStatus !== 'all')
                activeFilters["Status"] = selectedStatus;
            if (!includePSE)
                activeFilters["PSE"] = "Excluded";
            
            if (filters.productProgram)
                activeFilters["Product Program"] = filters.productProgram;
            if (filters.extendingUnit)
                activeFilters["Extending Unit"] = filters.extendingUnit;
            if (filters.facilityType)
                activeFilters["Facility Type"] = filters.facilityType;
            if (filters.commitment)
                activeFilters["Commitment Status"] = filters.commitment;
            if (filters.teamLead) activeFilters["Team Lead"] = filters.teamLead;
            if (filters.underwriter)
                activeFilters["Underwriter"] = filters.underwriter;
            if (filters.caMaturity) {
                const days = filters.caMaturity;
                activeFilters["CAs Maturing"] =
                    days === "30"
                        ? "Next 30 Days"
                        : days === "60"
                            ? "Next 60 Days"
                            : days === "90"
                                ? "Next 90 Days"
                                : days === "180"
                                    ? "Next 6 Months"
                                    : "Next Year";
            }
            if (filters.facilityMaturity) {
                const days = filters.facilityMaturity;
                activeFilters["Facilities Maturing"] =
                    days === "30"
                        ? "Next 30 Days"
                        : days === "60"
                            ? "Next 60 Days"
                            : days === "90"
                                ? "Next 90 Days"
                                : days === "180"
                                    ? "Next 6 Months"
                                    : "Next Year";
            }
            
            // Display filter badges and update count
            displayFilterBadges();
            updateFilterCount();
            
            // Check if we can use cache
            const currentHash = getFilterHash();
            if (metricsCache.filterHash === currentHash && metricsCache.filtered) {
                console.log("Using cached filter results");
                filteredData = metricsCache.filtered.data;
                
                // Still need to update charts even when using cache
                requestAnimationFrame(() => {
                    calculateMetricsFromFiltered();
                    createExpirationChartFromFiltered();
                    createFacilityTrendChartFromFiltered();
                    createRelationshipChartFromFiltered();
                    createCreditClassificationChartFromFiltered();
                    createROTCEChartFromFiltered();
                });
                
                currentPage = 1;
                renderTable();
                return;
            }
            
            // Pre-calculate date ranges for date filters (avoid recalculating in loop)
            let caDateRange = null;
            let facilityDateRange = null;
            if (filters.caMaturity) {
                const today = new Date();
                const futureDate = new Date(
                    today.getTime() + parseInt(filters.caMaturity) * 24 * 60 * 60 * 1000
                );
                caDateRange = { today, futureDate };
            }
            if (filters.facilityMaturity) {
                const today = new Date();
                const futureDate = new Date(
                    today.getTime() +
                    parseInt(filters.facilityMaturity) * 24 * 60 * 60 * 1000
                );
                facilityDateRange = { today, futureDate };
            }
            
            const searchTerm = document
                .getElementById("searchInput")
                .value.toLowerCase();
            
            // OPTIMIZED filtering: Use early exits and minimal object access
            filteredData = [];
            for (let i = 0; i < portfolioData.length; i++) {
                const row = portfolioData[i];
                
                // Smart Filters (apply first for performance)
                // Region filter (case-insensitive comparison)
                if (selectedRegion !== "all") {
                    const rowRegion = (row.Region || "").toUpperCase();
                    if (rowRegion !== selectedRegion.toUpperCase()) continue;
                }
                
                // PSE filter (exclude PSE if includePSE is false)
                // Use PSE_non-PSE column from data
                if (!includePSE) {
                    const pseColumn = row["PSE_non-PSE"] || row.PSE_non_PSE || "";
                    const pseValue = String(pseColumn).toUpperCase();
                    // If the column contains "PSE" or similar indicator, skip this row
                    if (pseValue.includes("PSE") || pseValue === "PSE") continue;
                }
                
                // Management Status filter (CM/DM) - case-insensitive comparison
                if (selectedStatus !== "all") {
                    const rowStatus = (row.Management_Status || "").toUpperCase();
                    if (rowStatus !== selectedStatus.toUpperCase()) continue;
                }
                
                // Fast path: Check advanced filter string filters (fastest to fail)
                if (
                    filters.productProgram &&
                    row.Product_Program !== filters.productProgram
                )
                    continue;
                if (
                    filters.extendingUnit &&
                    row.Control_Unit !== filters.extendingUnit
                )
                    continue;
                if (
                    filters.facilityType &&
                    row.Facility_Type !== filters.facilityType
                )
                    continue;
                if (
                    filters.commitment &&
                    row["Committed/Uncommitted"] !== filters.commitment
                )
                    continue;
                if (
                    filters.teamLead &&
                    row.Underwriting_Team_Lead !== filters.teamLead
                )
                    continue;
                if (
                    filters.underwriter &&
                    row.Lead_Underwriter !== filters.underwriter
                )
                    continue;
                
                // Date filters (use pre-parsed dates from index)
                if (caDateRange) {
                    const caDate = indexCache.dates[i].caDate;
                    if (
                        !caDate ||
                        caDate < caDateRange.today ||
                        caDate > caDateRange.futureDate
                    )
                        continue;
                }
                
                if (facilityDateRange) {
                    const maturityDate = indexCache.dates[i].maturityDate;
                    if (
                        !maturityDate ||
                        maturityDate < facilityDateRange.today ||
                        maturityDate > facilityDateRange.futureDate
                    )
                        continue;
                }
                
                // Search filter (most expensive, do last)
            if (searchTerm) {
                    let found = false;
                    for (const value of Object.values(row)) {
                        if (String(value).toLowerCase().includes(searchTerm)) {
                            found = true;
                            break;
                        }
                    }
                    if (!found) continue;
                }
                
                // All filters passed
                filteredData.push(row);
            }
            
            // Cache the results
            metricsCache.filterHash = currentHash;
            metricsCache.filtered = { data: filteredData };
            
            console.log(
                `Filtered ${portfolioData.length} to ${filteredData.length
                } rows in ${(performance.now() - startTime).toFixed(2)}ms`
            );
            
            // Recalculate metrics and charts with filtered data (async to prevent blocking)
            requestAnimationFrame(() => {
            calculateMetricsFromFiltered();
                createExpirationChartFromFiltered();
                createFacilityTrendChartFromFiltered();
            createRelationshipChartFromFiltered();
            createCreditClassificationChartFromFiltered();
                createROTCEChartFromFiltered();
            });

            // Reset to first page and render table immediately
            currentPage = 1;
            renderTable();
        }

        // Apply chart-based filter (cross-filtering)
        function applyChartFilter(filterType, filterValue, displayLabel) {
            console.log(` Chart filter applied: ${filterType} = ${filterValue}`);

            // Set chart filter state
            chartFilter.active = true;
            chartFilter.type = filterType;
            chartFilter.value = filterValue;
            chartFilter.label = displayLabel || filterValue;

            // Display chart filter badge
            displayChartFilterBadge();

            // Apply the filter
            applyFiltersWithChartFilter();
        }

        // Clear chart filter
        function clearChartFilter() {
            console.log(" Chart filter cleared");

            chartFilter.active = false;
            chartFilter.type = null;
            chartFilter.value = null;
            chartFilter.label = null;

            // Remove badge and reapply normal filters
            const badge = document.getElementById("chartFilterBadge");
            if (badge) badge.remove();

            applyFilters();
        }

        // Display chart filter badge
        function displayChartFilterBadge() {
            // Remove existing badge if any
            const existing = document.getElementById("chartFilterBadge");
            if (existing) existing.remove();

            if (!chartFilter.active) return;

            const badgesContainer = document.getElementById("activeFiltersBadges");
            if (!badgesContainer) return;

            badgesContainer.style.display = "flex";

            const badge = document.createElement("span");
            badge.id = "chartFilterBadge";
            badge.className =
                "inline-flex items-center bg-blue-50 text-sm text-blue-700 border-2 border-blue-500 rounded-lg gap-x-2 py-1.5 pl-3 pr-1 font-medium";
            badge.innerHTML = `
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                </svg>
                <span class="text-blue-700">Chart Filter</span>
                <span class="h-4 w-px bg-blue-400"></span>
                <span class="font-semibold text-blue-900">${chartFilter.label}</span>
                <button type="button" onclick="clearChartFilter()" 
                    class="flex h-5 w-5 items-center justify-center rounded text-blue-600 hover:bg-blue-100 hover:text-blue-800"
                    aria-label="Remove">
                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            `;

            // Add as first badge
            badgesContainer.insertBefore(badge, badgesContainer.firstChild);
        }

        // Apply filters with chart filter included
        function applyFiltersWithChartFilter() {
            const startTime = performance.now();

            // Get advanced filter values (excluding Region and Status which are in smart filters)
            const filters = {
                productProgram: document.getElementById("filterProductProgram").value,
                extendingUnit: document.getElementById("filterExtendingUnit").value,
                facilityType: document.getElementById("filterFacilityType").value,
                commitment: document.getElementById("filterCommitment").value,
                teamLead: document.getElementById("filterTeamLead").value,
                underwriter: document.getElementById("filterUnderwriter").value,
                caMaturity: document.getElementById("filterCAMaturity").value,
                facilityMaturity: document.getElementById("filterFacilityMaturity")
                    .value,
            };

            // Update active filters object (including Region and Status smart filters)
            activeFilters = {};
            
            // Add smart filters to activeFilters
            if (selectedRegion !== 'all')
                activeFilters["Region"] = selectedRegion;
            if (selectedStatus !== 'all')
                activeFilters["Status"] = selectedStatus;
            if (!includePSE)
                activeFilters["PSE"] = "Excluded";
            
            if (filters.productProgram)
                activeFilters["Product Program"] = filters.productProgram;
            if (filters.extendingUnit)
                activeFilters["Extending Unit"] = filters.extendingUnit;
            if (filters.facilityType)
                activeFilters["Facility Type"] = filters.facilityType;
            if (filters.commitment)
                activeFilters["Commitment Status"] = filters.commitment;
            if (filters.teamLead) activeFilters["Team Lead"] = filters.teamLead;
            if (filters.underwriter)
                activeFilters["Underwriter"] = filters.underwriter;
            if (filters.caMaturity) {
                const days = filters.caMaturity;
                activeFilters["CAs Maturing"] =
                    days === "30"
                        ? "Next 30 Days"
                        : days === "60"
                            ? "Next 60 Days"
                            : days === "90"
                                ? "Next 90 Days"
                                : days === "180"
                                    ? "Next 6 Months"
                                    : "Next Year";
            }
            if (filters.facilityMaturity) {
                const days = filters.facilityMaturity;
                activeFilters["Facilities Maturing"] =
                    days === "30"
                        ? "Next 30 Days"
                        : days === "60"
                            ? "Next 60 Days"
                            : days === "90"
                                ? "Next 90 Days"
                                : days === "180"
                                    ? "Next 6 Months"
                                    : "Next Year";
            }

            // Display filter badges and update count
            displayFilterBadges();
            updateFilterCount();

            // Pre-calculate date ranges for date filters (avoid recalculating in loop)
            let caDateRange = null;
            let facilityDateRange = null;
            if (filters.caMaturity) {
                const today = new Date();
                const futureDate = new Date(
                    today.getTime() + parseInt(filters.caMaturity) * 24 * 60 * 60 * 1000
                );
                caDateRange = { today, futureDate };
            }
            if (filters.facilityMaturity) {
                const today = new Date();
                const futureDate = new Date(
                    today.getTime() +
                    parseInt(filters.facilityMaturity) * 24 * 60 * 60 * 1000
                );
                facilityDateRange = { today, futureDate };
            }

            const searchTerm = document
                .getElementById("searchInput")
                .value.toLowerCase();

            // OPTIMIZED filtering: Use early exits and minimal object access
            filteredData = [];
            for (let i = 0; i < portfolioData.length; i++) {
                const row = portfolioData[i];

                // Apply chart filter first
                if (chartFilter.active) {
                    let passChartFilter = false;

                    switch (chartFilter.type) {
                        case "relationship":
                            const relName = row.Relationship_Name || row.Relationship_ID;
                            // Remove index number (e.g., "1. ABC Bank" -> "ABC Bank")
                            const cleanValue = chartFilter.value.replace(/^\d+\.\s*/, "");
                            passChartFilter = relName === cleanValue;
                            break;
                        case "product":
                            passChartFilter = row.Product_Program === chartFilter.value;
                            break;
                        case "facilityType":
                            passChartFilter = row.Facility_Type === chartFilter.value;
                            break;
                    }

                    if (!passChartFilter) continue;
                }

                // Smart Filters (apply after chart filter for performance)
                // Region filter (case-insensitive comparison)
                if (selectedRegion !== "all") {
                    const rowRegion = (row.Region || "").toUpperCase();
                    if (rowRegion !== selectedRegion.toUpperCase()) continue;
                }

                // PSE filter (exclude PSE if includePSE is false)
                // Use PSE_non-PSE column from data
                if (!includePSE) {
                    const pseColumn = row["PSE_non-PSE"] || row.PSE_non_PSE || "";
                    const pseValue = String(pseColumn).toUpperCase();
                    // If the column contains "PSE" or similar indicator, skip this row
                    if (pseValue.includes("PSE") || pseValue === "PSE") continue;
                }

                // Management Status filter (CM/DM) - case-insensitive comparison
                if (selectedStatus !== "all") {
                    const rowStatus = (row.Management_Status || "").toUpperCase();
                    if (rowStatus !== selectedStatus.toUpperCase()) continue;
                }

                // Fast path: Check advanced filter string filters (fastest to fail)
                if (
                    filters.productProgram &&
                    row.Product_Program !== filters.productProgram
                )
                    continue;
                if (
                    filters.extendingUnit &&
                    row.Control_Unit !== filters.extendingUnit
                )
                    continue;
                if (
                    filters.facilityType &&
                    row.Facility_Type !== filters.facilityType
                )
                    continue;
                if (
                    filters.commitment &&
                    row["Committed/Uncommitted"] !== filters.commitment
                )
                    continue;
                if (
                    filters.teamLead &&
                    row.Underwriting_Team_Lead !== filters.teamLead
                )
                    continue;
                if (
                    filters.underwriter &&
                    row.Lead_Underwriter !== filters.underwriter
                )
                    continue;

                // Date filters (use pre-parsed dates from index)
                if (caDateRange) {
                    const caDate = indexCache.dates[i].caDate;
                    if (
                        !caDate ||
                        caDate < caDateRange.today ||
                        caDate > caDateRange.futureDate
                    )
                        continue;
                }

                if (facilityDateRange) {
                    const maturityDate = indexCache.dates[i].maturityDate;
                    if (
                        !maturityDate ||
                        maturityDate < facilityDateRange.today ||
                        maturityDate > facilityDateRange.futureDate
                    )
                        continue;
                }

                // Search filter (most expensive, do last)
                if (searchTerm) {
                    let found = false;
                    for (const value of Object.values(row)) {
                        if (String(value).toLowerCase().includes(searchTerm)) {
                            found = true;
                            break;
                        }
                    }
                    if (!found) continue;
                }

                // All filters passed
                filteredData.push(row);
            }

            console.log(
                `Filtered ${portfolioData.length} to ${filteredData.length
                } rows (with chart filter) in ${(
                    performance.now() - startTime
                ).toFixed(2)}ms`
            );

            // Recalculate metrics and charts with filtered data (async to prevent blocking)
            requestAnimationFrame(() => {
                calculateMetricsFromFiltered();
                createExpirationChartFromFiltered();
                createFacilityTrendChartFromFiltered();
                createRelationshipChartFromFiltered();
                createCreditClassificationChartFromFiltered();
                createROTCEChartFromFiltered();
            });
            
            // Reset to first page and render table immediately
            currentPage = 1;
            renderTable();
        }

        // Display filter badges
        function displayFilterBadges() {
            const badgesContainer = document.getElementById("activeFiltersBadges");
            badgesContainer.innerHTML = "";
            
            if (Object.keys(activeFilters).length === 0) {
                badgesContainer.style.display = "none";
                return;
            }
            
            badgesContainer.style.display = "flex";
            
            Object.entries(activeFilters).forEach(([label, value]) => {
                const badge = document.createElement("span");
                badge.className =
                    "inline-flex items-center bg-white text-sm text-gray-600 border border-gray-300 rounded-lg gap-x-2 py-1.5 pl-3 pr-1";
                badge.innerHTML = `
                    <span class="text-gray-600">${label}</span>
                    <span class="h-4 w-px bg-gray-300"></span>
                    <span class="font-medium text-gray-800">${value}</span>
                    <button type="button" onclick="removeFilter('${label}')" 
                        class="flex h-5 w-5 items-center justify-center rounded text-gray-500 hover:bg-gray-100 hover:text-gray-700"
                        aria-label="Remove">
                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                `;
                badgesContainer.appendChild(badge);
            });
        }

        // Remove a specific filter
        function removeFilter(label) {
            // Handle smart filters first
            if (label === "Region") {
                selectRegionFilter('all');
                return;
            }
            
            if (label === "Status") {
                selectStatusFilter('all');
                return;
            }
            
            if (label === "PSE") {
                // Toggle PSE back to include
                includePSE = true;
                const pseToggle = document.getElementById('pseToggle');
                if (pseToggle) {
                    pseToggle.checked = true;
                    // Trigger the change event to update Alpine.js state
                    pseToggle.dispatchEvent(new Event('change'));
                }
                updateFilterCount();
                applyFilters();
                return;
            }
            
            // Handle advanced filters
            const filterMap = {
                "Product Program": "filterProductProgram",
                "Extending Unit": "filterExtendingUnit",
                "Facility Type": "filterFacilityType",
                "Commitment Status": "filterCommitment",
                "Team Lead": "filterTeamLead",
                Underwriter: "filterUnderwriter",
                "CAs Maturing": "filterCAMaturity",
                "Facilities Maturing": "filterFacilityMaturity",
            };
            
            const selectId = filterMap[label];
            if (selectId) {
                const element = document.getElementById(selectId);
                if (element) {
                    element.value = "";
                }
                applyFilters();
            }
        }

        // Clear all filters
        function clearAllFilters() {
            // Clear only advanced filter fields (Region and Status are managed by smart filters)
            document.getElementById("filterProductProgram").value = "";
            document.getElementById("filterExtendingUnit").value = "";
            document.getElementById("filterFacilityType").value = "";
            document.getElementById("filterCommitment").value = "";
            document.getElementById("filterTeamLead").value = "";
            document.getElementById("filterUnderwriter").value = "";
            document.getElementById("filterCAMaturity").value = "";
            document.getElementById("filterFacilityMaturity").value = "";
            
            activeFilters = {};
            applyFilters();
            updateFilterCount();
        }

        // Store temporary filter state when opening popover
        let tempFilterState = {};

        // Toggle filter popover
        function toggleFilterPopover() {
            const popover = document.getElementById("filterPopover");
            if (popover.classList.contains("hidden")) {
                // Opening popover - save current filter state (excluding smart filters)
                tempFilterState = {
                    productProgram: document.getElementById("filterProductProgram")
                        .value,
                    extendingUnit: document.getElementById("filterExtendingUnit").value,
                    facilityType: document.getElementById("filterFacilityType").value,
                    commitment: document.getElementById("filterCommitment").value,
                    teamLead: document.getElementById("filterTeamLead").value,
                    underwriter: document.getElementById("filterUnderwriter").value,
                    caMaturity: document.getElementById("filterCAMaturity").value,
                    facilityMaturity: document.getElementById("filterFacilityMaturity")
                        .value,
                };

                popover.classList.remove("hidden");
                document.body.style.overflow = "hidden"; // Prevent background scrolling
            } else {
                // Closing popover - restore previous filter state (cancel changes)
                document.getElementById("filterProductProgram").value =
                    tempFilterState.productProgram || "";
                document.getElementById("filterExtendingUnit").value =
                    tempFilterState.extendingUnit || "";
                document.getElementById("filterFacilityType").value =
                    tempFilterState.facilityType || "";
                document.getElementById("filterCommitment").value =
                    tempFilterState.commitment || "";
                document.getElementById("filterTeamLead").value =
                    tempFilterState.teamLead || "";
                document.getElementById("filterUnderwriter").value =
                    tempFilterState.underwriter || "";
                document.getElementById("filterCAMaturity").value =
                    tempFilterState.caMaturity || "";
                document.getElementById("filterFacilityMaturity").value =
                    tempFilterState.facilityMaturity || "";

                popover.classList.add("hidden");
                document.body.style.overflow = ""; // Restore scrolling
            }
        }

        // Apply filters and close popover
        function applyFiltersAndClose() {
            applyFilters();
            // Close popover without restoring state (we're applying changes)
            const popover = document.getElementById("filterPopover");
            popover.classList.add("hidden");
            document.body.style.overflow = "";
        }

        // Update filter count badge
        function updateFilterCount() {
            // Count all filters (smart filters are already included in activeFilters)
            let count = Object.keys(activeFilters).length;
            
            const badge = document.getElementById("filterCount");
            
            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove("hidden");
            } else {
                badge.classList.add("hidden");
            }
        }

        // Calculate metrics from filtered data (OPTIMIZED)
        function calculateMetricsFromFiltered() {
            const startTime = performance.now();
            
            let totalFacAmount = 0;
            let totalOSUC = 0;
            let totalOutstanding = 0;
            const relationships = new Set();
            const facilities = new Set();
            
            // Single pass through filtered data
            for (let i = 0; i < filteredData.length; i++) {
                const row = filteredData[i];
                
                totalFacAmount += parseNumber(row.Fac_Amount);
                totalOSUC += parseNumber(row.OSUC);
                
                // Total Outstanding from Total_OS column
                totalOutstanding += parseNumber(row.Total_OS);
                
                const rel = row.Relationship_Name || row.Relationship_ID;
                if (rel) relationships.add(rel);
                
                if (row.Facility_ID) facilities.add(row.Facility_ID);
            }
            
            document.getElementById("totalRelationships").textContent =
                relationships.size.toLocaleString();
            document.getElementById("totalFacilities").textContent =
                facilities.size.toLocaleString();
            document.getElementById("totalOSUC").textContent =
                formatCurrency(totalOSUC);
            document.getElementById("totalFacAmount").textContent =
                formatCurrency(totalFacAmount);
            document.getElementById("totalOutstanding").textContent =
                formatCurrency(totalOutstanding);

            console.log(
                `Filtered metrics calculated in ${(
                    performance.now() - startTime
                ).toFixed(2)}ms`
            );
            
            // Calculate expired metrics from filtered data
            calculateExpiredMetricsFromFiltered();
            
            // Calculate new deals YTD/MTD metrics from filtered data
            calculateNewDealsMetricsFromFiltered();
            
            // Populate pipeline deals table from filtered data
            populatePipelineTable();
        }

        // Calculate Facilities Expired and CAs Expired metrics from filtered data
        function calculateExpiredMetricsFromFiltered() {
            // Get the current report month
            const reportDates = filteredData
                .map((row) => parseDate(row.Report_Date))
                .filter((d) => d);
            if (reportDates.length === 0) return;
            
            const maxReportDate = new Date(Math.max(...reportDates));
            const currentYear = maxReportDate.getFullYear();
            const currentMonth = maxReportDate.getMonth();
            
            // Calculate start and end of current month
            const monthStart = new Date(currentYear, currentMonth, 1);
            monthStart.setHours(0, 0, 0, 0);
            const monthEnd = new Date(currentYear, currentMonth + 1, 0);
            monthEnd.setHours(23, 59, 59, 999);
            
            // Count expired facilities and CAs in current month only
            let facilitiesExpiredCount = 0;
            let facilitiesExpiredAmount = 0;
            const expiredCAs = new Set();
            let casExpiredAmount = 0;
            
            for (let i = 0; i < filteredData.length; i++) {
                const row = filteredData[i];
                
                // Check Facilities Expired (count ALL lines, not unique)
                const maturityDate = parseDate(row.Maturity_Date);
                if (
                    maturityDate &&
                    maturityDate >= monthStart &&
                    maturityDate <= monthEnd &&
                    maturityDate < maxReportDate
                ) {
                    facilitiesExpiredCount++;
                    facilitiesExpiredAmount += parseNumber(
                        row.Fac_Amount || row.Facility_Amount
                    );
                }
                
                // Check CAs Expired (count unique CAIDs, but sum ALL lines, exclude DM)
                const caExpirationDate = parseDate(row.CA_Expiration_Date);
                const managementStatus = (row.Management_Status || "").toUpperCase();
                if (
                    caExpirationDate &&
                    caExpirationDate >= monthStart &&
                    caExpirationDate <= monthEnd &&
                    caExpirationDate < maxReportDate &&
                    row.CAID &&
                    managementStatus !== "DM"
                ) {
                    expiredCAs.add(row.CAID);
                    casExpiredAmount += parseNumber(
                        row.Fac_Amount || row.Facility_Amount
                    );
                }
            }
            
            const casExpiredCount = expiredCAs.size;
            
            // Update DOM
            document.getElementById("facilitiesExpiredCount").textContent =
                facilitiesExpiredCount.toLocaleString();
            document.getElementById("casExpiredCount").textContent =
                casExpiredCount.toLocaleString();
        }

        // Create expiration chart from filtered data
        function createExpirationChartFromFiltered() {
            console.log(
                " Creating filtered facilities expired & expiring bar chart"
            );
            
            // Get the current reporting month from the data
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Generate next 3 months starting from current month
            const next3Months = [];
            for (let i = 0; i < 3; i++) {
                const date = new Date(today);
                date.setMonth(date.getMonth() + i);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, "0");
                next3Months.push(`${year}-${month}`);
            }
            
            // Group by month-year and categorize as expired or expiring
            const monthlyData = {};
            
            // Initialize all 3 months
            next3Months.forEach((monthYear) => {
                monthlyData[monthYear] = {
                    expired: [],
                    expiring: [],
                };
            });
            
            filteredData.forEach((row) => {
                const maturityDate = row.Maturity_Date;
                const facilityId = row.Facility_ID;
                
                if (maturityDate && facilityId) {
                    const dateObj = parseDate(maturityDate);
                    if (dateObj) {
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthYear = `${year}-${month}`;
                        
                        // Only include if it's in our next 3 months
                        if (next3Months.includes(monthYear)) {
                            // Categorize based on whether date is past or future
                            if (dateObj < today) {
                                monthlyData[monthYear].expired.push(facilityId);
                            } else {
                                monthlyData[monthYear].expiring.push(facilityId);
                            }
                        }
                    }
                }
            });
            
            // Prepare data for the next 3 months
            const categories = next3Months.map((m) => {
                const date = new Date(m + "-01");
                return date.toLocaleDateString("en-US", { month: "short" });
            });

            const expiredData = next3Months.map(
                (month) => monthlyData[month].expired.length
            );
            const expiringData = next3Months.map(
                (month) => monthlyData[month].expiring.length
            );
            
            const options = {
                series: [
                    {
                        name: "Expired",
                        data: expiredData,
                    },
                    {
                        name: "Expiring",
                        data: expiringData,
                    },
                ],
                colors: ["#93a8ff", "#465fff"],
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "bar",
                    stacked: false,
                    height: "100%",
                    toolbar: {
                        show: false,
                    },
                    zoom: {
                        enabled: false,
                    },
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: "55%",
                        borderRadius: 8,
                        borderRadiusApplication: "end",
                    },
                },
                dataLabels: {
                    enabled: false,
                },
                xaxis: {
                    categories: categories,
                    axisBorder: {
                        show: false,
                    },
                    axisTicks: {
                        show: false,
                    },
                },
                legend: {
                    show: true,
                    position: "top",
                    horizontalAlign: "left",
                    markers: {
                        size: 5,
                        shape: "circle",
                        radius: 999,
                        strokeWidth: 0,
                    },
                    itemMargin: {
                        horizontal: 10,
                        vertical: 0,
                    },
                },
                yaxis: {
                    title: false,
                },
                grid: {
                    yaxis: {
                        lines: {
                            show: true,
                        },
                    },
                },
                fill: {
                    opacity: 1,
                },
                tooltip: {
                    theme: "light",
                    style: {
                        fontSize: "12px",
                        fontFamily: "Outfit, sans-serif",
                    },
                    x: {
                        show: false,
                    },
                    y: {
                        formatter: function (val) {
                            return val + " facilities";
                        },
                    },
                },
            };

            const chartElement = document.querySelector("#facilityMaturityChart");
            if (!chartElement) {
                console.error("Facility maturity chart element not found");
                return;
            }
            
            if (typeof ApexCharts === "undefined") {
                console.error("ApexCharts library not loaded");
                return;
            }
            
            try {
                if (facilityMaturityChartInstance) {
                    facilityMaturityChartInstance.destroy();
                    facilityMaturityChartInstance = null;
                }
                
                chartElement.innerHTML = "";
                
                facilityMaturityChartInstance = new ApexCharts(chartElement, options);
                facilityMaturityChartInstance.render();
                console.log(
                    " Filtered facility maturity chart rendered successfully"
                );
            } catch (error) {
                console.error(
                    " Error rendering filtered facility maturity chart:",
                    error
                );
            }
        }

        // Create relationship chart from filtered data (OPTIMIZED)
        function createRelationshipChartFromFiltered() {
            const startTime = performance.now();
            const topN = parseInt(document.getElementById("topNFilter").value);
            
            // Use amount type based on filter selection
            let fieldName, seriesName;
            switch (selectedAmountType) {
                case "direct":
                    fieldName = "Direct_OS";
                    seriesName = "Direct OS";
                    break;
                case "contingent":
                    fieldName = "Contingent_OS";
                    seriesName = "Contingent OS";
                    break;
                case "pse":
                    fieldName = "PSE_OS";
                    seriesName = "PSE OS";
                    break;
                case "osuc":
                    fieldName = "OSUC";
                    seriesName = "OSUC";
                    break;
                case "unused":
                    fieldName = "Unused_Committed";
                    seriesName = "Undrawn Commitment";
                    break;
                case "tfa":
                    fieldName = "Fac_Amount";
                    seriesName = "Total Facility Amount";
                    break;
                default:
                    fieldName = "Direct_OS";
                    seriesName = "Direct OS";
            }

            console.log(
                "Creating filtered relationship chart, field:",
                fieldName,
                "dataLength:",
                filteredData.length
            );
            
            // Use Map for better performance - store all exposure types
            const relationshipData = new Map();
            
            // Debug: Sample a few rows to see what we're working with
            if (filteredData.length > 0 && selectedAmountType === "tfa") {
                console.log("DEBUG - Sample first 3 rows of filteredData:");
                for (let i = 0; i < Math.min(3, filteredData.length); i++) {
                    console.log(`Row ${i}:`, {
                        Relationship_Name: filteredData[i].Relationship_Name,
                        Fac_Amount: filteredData[i].Fac_Amount,
                        Facility_Amount: filteredData[i].Facility_Amount,
                        TFA_field_used: filteredData[i].Fac_Amount || filteredData[i].Facility_Amount,
                        TFA_parsed: parseNumber(filteredData[i].Fac_Amount || filteredData[i].Facility_Amount),
                        Direct_OS: filteredData[i].Direct_OS,
                        Direct_OS_parsed: parseNumber(filteredData[i].Direct_OS)
                    });
                }
                
                // Count how many rows have non-zero TFA
                let nonZeroCount = 0;
                let totalFacilityAmount = 0;
                for (let i = 0; i < filteredData.length; i++) {
                    const val = parseNumber(filteredData[i].Fac_Amount || filteredData[i].Facility_Amount);
                    if (val > 0) {
                        nonZeroCount++;
                        totalFacilityAmount += val;
                    }
                }
                console.log(`DEBUG - ${nonZeroCount} out of ${filteredData.length} rows have non-zero TFA`);
                console.log(`DEBUG - Total TFA across all rows: ${formatCurrency(totalFacilityAmount)}`);
            }
            
            for (let i = 0; i < filteredData.length; i++) {
                const row = filteredData[i];
                const relId = row.Relationship_Name || row.Relationship_ID;
                
                if (relId) {
                    if (!relationshipData.has(relId)) {
                        relationshipData.set(relId, {
                            tfa: 0,
                            direct: 0,
                            contingent: 0,
                            pse: 0,
                            osuc: 0,
                            unused: 0,
                            facilityCount: 0,
                        });
                    }
                    
                    const data = relationshipData.get(relId);
                    data.tfa += parseNumber(row.Fac_Amount || row.Facility_Amount);
                    data.direct += parseNumber(row.Direct_OS);
                    data.contingent += parseNumber(row.Contingent_OS);
                    data.pse += parseNumber(row.PSE_OS);
                    data.osuc += parseNumber(row.OSUC);
                    data.unused += parseNumber(row.Unused_Committed);
                    if (row.Facility_ID) data.facilityCount++;
                }
            }
            
            console.log(
                "Total unique filtered relationships:",
                relationshipData.size
            );
            
            // Get the selected field value for sorting
            const relationshipTotals = new Map();
            for (const [relId, data] of relationshipData.entries()) {
                let sortValue = 0;
                switch (selectedAmountType) {
                    case "tfa":
                        sortValue = data.tfa;
                        break;
                    case "direct":
                        sortValue = data.direct;
                        break;
                    case "contingent":
                        sortValue = data.contingent;
                        break;
                    case "pse":
                        sortValue = data.pse;
                        break;
                    case "osuc":
                        sortValue = data.osuc;
                        break;
                    case "unused":
                        sortValue = data.unused;
                        break;
                    default:
                        sortValue = data.direct;
                }
                relationshipTotals.set(relId, sortValue);
            }
            
            // Convert to array and sort
            const sorted = Array.from(relationshipTotals.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, topN);
            
            console.log(
                `Filtered chart aggregated ${filteredData.length} rows, found ${relationshipData.size
                } relationships in ${(performance.now() - startTime).toFixed(2)}ms`
            );
            
            // Add index numbers (1, 2, 3, ...) before relationship names
            const relationships = sorted.map(
                (item, index) => `${index + 1}. ${item[0]}`
            );
            const amounts = sorted.map((item) => item[1]);
            
            // Debug logging for TFA
            console.log("DEBUG - selectedAmountType:", selectedAmountType);
            console.log("DEBUG - seriesName:", seriesName);
            console.log("DEBUG - relationships:", relationships);
            console.log("DEBUG - amounts:", amounts);
            console.log("DEBUG - sorted array:", sorted);
            
            // Handle empty data
            if (relationships.length === 0) {
                console.warn("No filtered relationship data for chart");
                const chartElement = document.querySelector("#relationshipChart");
                if (chartElement) {
                    chartElement.innerHTML = '<div class="flex items-center justify-center h-64 text-gray-500">No data available for the selected filters</div>';
                }
                return;
            }
            
            // Check if all amounts are zero
            const totalAmount = amounts.reduce((sum, val) => sum + val, 0);
            if (totalAmount === 0) {
                console.warn(" All amounts are zero for selectedAmountType:", selectedAmountType);
                const chartElement = document.querySelector("#relationshipChart");
                if (chartElement) {
                    chartElement.innerHTML = `<div class="flex items-center justify-center h-64 text-gray-500">No ${seriesName} data available for the selected filters</div>`;
                }
                return;
            }

            // Calculate dynamic height based on number of relationships (35px per bar, min 350px)
            const calculatedHeight = Math.max(350, relationships.length * 35);
            
            const options = {
                series: [
                    {
                    name: seriesName,
                        data: amounts,
                    },
                ],
                colors: ["#465fff"],
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "bar",
                    height: calculatedHeight,
                    toolbar: {
                        show: false,
                    },
                    events: {
                        dataPointSelection: function (event, chartContext, config) {
                            const selectedIndex = config.dataPointIndex;
                            const selectedRelationship = relationships[selectedIndex];
                            console.log("Relationship clicked:", selectedRelationship);
                            applyChartFilter(
                                "relationship",
                                selectedRelationship,
                                selectedRelationship
                            );
                        },
                    },
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        borderRadius: 5,
                        borderRadiusApplication: "end",
                    },
                },
                dataLabels: {
                    enabled: false,
                },
                stroke: {
                    show: true,
                    width: 4,
                    colors: ["transparent"],
                },
                xaxis: {
                    categories: relationships,
                    labels: {
                        formatter: function (val) {
                            return formatCurrency(val);
                        },
                    },
                    axisBorder: {
                        show: false,
                    },
                    axisTicks: {
                        show: false,
                    },
                },
                yaxis: {
                    title: false,
                    labels: {
                        style: {
                            fontSize: "12px",
                        },
                    },
                },
                legend: {
                    show: true,
                    position: "top",
                    horizontalAlign: "left",
                    fontFamily: "Outfit",
                    markers: {
                        radius: 99,
                    },
                },
                grid: {
                    yaxis: {
                        lines: {
                            show: false,
                        },
                    },
                },
                fill: {
                    opacity: 1,
                },
                tooltip: {
                    theme: "light",
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        const relName = sorted[dataPointIndex][0]; // Get original name without index
                        const data = relationshipData.get(relName);
                        
                        if (!data) return "";
                        
                        let html = `<div class="apexcharts-tooltip-custom" style="padding: 12px; min-width: 220px; background: #ffffff; color: #1f2937; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border: 1px solid #e5e7eb;">`;
                        html += `<div style="font-weight: 600; margin-bottom: 8px; font-size: 13px; color: #1f2937;">${relName}</div>`;
                        html += `<div style="font-size: 11px; color: #666;">`;
                        html += `<div style="margin-bottom: 4px;"><strong>${data.facilityCount}</strong> Facilities</div>`;
                        html += `<div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #e5e7eb;">`;
                        html += `<div>TFA: ${formatCurrency(data.tfa)}</div>`;
                        html += `<div>Direct: ${formatCurrency(data.direct)}</div>`;
                        if (data.contingent > 0) {
                            html += `<div>Contingent: ${formatCurrency(
                                data.contingent
                            )}</div>`;
                        }
                        if (data.pse > 0) {
                            html += `<div>Presettlement Exposure: ${formatCurrency(
                                data.pse
                            )}</div>`;
                        }
                        html += `</div></div></div>`;
                        return html;
                    },
                },
            };

            // Get the chart element and verify it exists
                const chartElement = document.querySelector("#relationshipChart");
                if (!chartElement) {
                console.error(
                    "Filtered relationship chart element #relationshipChart not found in DOM"
                );
                    return;
                }
                
            // Verify ApexCharts is loaded
            if (typeof ApexCharts === "undefined") {
                console.error("ApexCharts library not loaded");
                return;
            }
            
            try {
                // Destroy previous instance
                if (relationshipChartInstance) {
                    relationshipChartInstance.destroy();
                    relationshipChartInstance = null;
                }
                
                // Clear any previous content to avoid ApexCharts errors
                chartElement.innerHTML = "";
                
                // Log chart options for debugging
                console.log("DEBUG - Chart options series:", options.series);
                console.log("DEBUG - Chart options xaxis categories:", options.xaxis.categories);
                
                // Create and render new chart
                relationshipChartInstance = new ApexCharts(chartElement, options);
                relationshipChartInstance.render();
                console.log(
                    " Filtered relationship chart rendered successfully with",
                    relationships.length,
                    "relationships"
                );
            } catch (error) {
                console.error(
                    " Error creating filtered relationship chart:",
                    error
                );
                console.error("Error details:", error.message, error.stack);
            }
        }

        // Smart Filter Functions
        
        // Select Region Filter
        function selectRegionFilter(region) {
            selectedRegion = region;
            
            // Update button styles with min-width (LATAM is wider)
            const regions = ["All", "APAC", "EMEA", "LATAM", "NAM"];
            regions.forEach((r) => {
                const btnId = `btnRegion${r}`;
                const btn = document.getElementById(btnId);
                if (btn) {
                    const minWidth = r === "LATAM" ? "min-w-[60px]" : "min-w-[50px]";
                    if (r.toLowerCase() === region.toLowerCase()) {
                        btn.className = `${minWidth} px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white`;
            } else {
                        btn.className = `${minWidth} px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900`;
                    }
                }
            });
            
            // Update filter count and apply filters
            updateFilterCount();
            applyFilters();
        }
        
        // Toggle PSE (Include/Exclude)
        function togglePSE(include) {
            includePSE = include;
            console.log("PSE filter:", includePSE ? "Include" : "Exclude");
            // Update filter count and apply filters
            updateFilterCount();
            applyFilters();
        }
        
        // Select Status Filter (CM/DM)
        function selectStatusFilter(status) {
            selectedStatus = status;
            
            // Update button styles with min-width
            const statuses = ["All", "CM", "DM"];
            statuses.forEach((s) => {
                const btnId = `btnStatus${s}`;
                const btn = document.getElementById(btnId);
                if (btn) {
                    if (s.toLowerCase() === status.toLowerCase()) {
                        btn.className =
                            "min-w-[45px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white";
            } else {
                        btn.className =
                            "min-w-[45px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900";
                    }
                }
            });
            
            // Update filter count and apply filters
            updateFilterCount();
            applyFilters();
        }
        
        // Select Amount Type Filter (Direct/Contingent/PSE/OSUC/Unused/TFA)
        function selectAmountTypeFilter(type) {
            selectedAmountType = type;
            
            // Update button styles
            const types = { 
                Direct: { id: "direct", minWidth: "65px" },
                Contingent: { id: "contingent", minWidth: "80px" },
                PSE: { id: "pse", minWidth: "50px" },
                OSUC: { id: "osuc", minWidth: "60px" },
                Unused: { id: "unused", minWidth: "90px" },
                TFA: { id: "tfa", minWidth: "50px" },
            };

            Object.keys(types).forEach((t) => {
                const btnId = `btnAmount${t}`;
                const btn = document.getElementById(btnId);
                if (btn) {
                    const minWidth = types[t].minWidth;
                    if (types[t].id === type) {
                        btn.className = `min-w-[${minWidth}] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white`;
                    } else {
                        btn.className = `min-w-[${minWidth}] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900`;
                    }
                }
            });
            
            // Update Top Relationships chart title and subtitle
            const titleElement = document.getElementById("topRelationshipsTitle");
            const subtitleElement = document.getElementById(
                "topRelationshipsSubtitle"
            );
            if (titleElement) {
                if (type === "direct") {
                    titleElement.textContent = "Top Relationships by Direct OS";
                    if (subtitleElement)
                        subtitleElement.textContent =
                            "Largest client exposures ranked by direct outstanding balance";
                } else if (type === "contingent") {
                    titleElement.textContent = "Top Relationships by Contingent OS";
                    if (subtitleElement)
                        subtitleElement.textContent =
                            "Largest client exposures ranked by contingent outstanding balance";
                } else if (type === "pse") {
                    titleElement.textContent =
                        "Top Relationships by Presettlement Exposure";
                    if (subtitleElement)
                        subtitleElement.textContent =
                            "Largest client exposures ranked by presettlement exposure outstanding balance";
                } else if (type === "osuc") {
                    titleElement.textContent = "Top Relationships by OSUC";
                    if (subtitleElement)
                        subtitleElement.textContent =
                            "Largest client exposures ranked by outstandings under commitment";
                } else if (type === "unused") {
                    titleElement.textContent =
                        "Top Relationships by Undrawn Commitment";
                    if (subtitleElement)
                        subtitleElement.textContent =
                            "Largest client exposures ranked by unused commitment available to draw";
                } else if (type === "tfa") {
                    titleElement.textContent =
                        "Top Relationships by Total Facility Amount";
                    if (subtitleElement)
                        subtitleElement.textContent =
                            "Largest client exposures ranked by total committed facility amounts";
                }
            }

            console.log("Amount Type filter:", type);
            // Refresh the Top Relationships chart and ROTCE chart (both should sync)
            if (areFiltersActive()) {
                createRelationshipChartFromFiltered();
                createROTCEChartFromFiltered();
            } else {
                createRelationshipChart();
                createROTCEChart();
            }
        }
        
        // Reset All Filters
        function resetAllFilters() {
            // Reset smart filters
            selectedRegion = "all";
            includePSE = true;
            selectedStatus = "all";
            selectedAmountType = "direct";
            
            // Reset region buttons
            selectRegionFilter("all");
            
            // Reset status buttons
            selectStatusFilter("all");
            
            // Reset amount type buttons
            selectAmountTypeFilter("direct");
            
            // Reset PSE toggle
            const pseToggle = document.getElementById("pseToggle");
            if (pseToggle) {
                pseToggle.checked = true;
            }
            
            // Reset search
            const searchInput = document.getElementById("searchInput");
            if (searchInput) {
                searchInput.value = "";
            }
            
            // Reset advanced filter dropdowns
            document.getElementById("filterProductProgram").value = "";
            document.getElementById("filterExtendingUnit").value = "";
            document.getElementById("filterFacilityType").value = "";
            document.getElementById("filterCommitment").value = "";
            document.getElementById("filterTeamLead").value = "";
            document.getElementById("filterUnderwriter").value = "";
            document.getElementById("filterCAMaturity").value = "";
            document.getElementById("filterFacilityMaturity").value = "";
            
            // Clear active filters
            activeFilters = {};
            displayFilterBadges();
            updateFilterCount();
            
            // Refresh data
            filterData();
            
            showNotification("Success", "All filters have been reset", "success");
        }
        
        // Export Functions
        
        function exportToExcel() {
            try {
                // Prepare data for export
                const exportData = filteredData.map((row) => ({
                    "Report Date": formatDate(row.Report_Date),
                    Region: row.Region || "",
                    "Facility ID": row.Facility_ID || "",
                    "Relationship Name": row.Relationship_Name || "",
                    "Product Program": row.Product_Program || "",
                    "Facility Amount": parseNumber(row.Fac_Amount),
                    "Direct OS": parseNumber(row.Direct_OS),
                    "Maturity Date": formatDate(row.Maturity_Date),
                    "CA Expiration Date": formatDate(row.CA_Expiration_Date),
                    "Control Unit": row.Control_Unit || "",
                    "Facility Type": row.Facility_Type || "",
                    "Commitment Status": row["Committed/Uncommitted"] || "",
                    "Management Status": row.Management_Status || "",
                    "Team Lead": row.Underwriting_Team_Lead || "",
                    Underwriter: row.Lead_Underwriter || "",
                }));
                
                // Create worksheet
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Portfolio Data");
                
                // Generate filename with timestamp
                const timestamp = new Date().toISOString().split("T")[0];
                const filename = `portfolio_export_${timestamp}.xlsx`;
                
                // Save file
                XLSX.writeFile(wb, filename);
                
                showNotification(
                    "Success",
                    `Data exported to ${filename}`,
                    "success"
                );
            } catch (error) {
                console.error("Export error:", error);
                showNotification("Error", "Failed to export to Excel", "error");
            }
        }
        
        function exportToPDF() {
            showNotification(
                "Info",
                "PDF export functionality coming soon",
                "info"
            );
            // TODO: Implement PDF export using jsPDF
        }
        
        function exportToPPT() {
            showNotification(
                "Info",
                "PowerPoint export functionality coming soon",
                "info"
            );
            // TODO: Implement PPT export using PptxGenJS
        }
        
        function exportToPNG() {
            try {
                const dashboard = document.querySelector(".p-4.md\\:p-6");
                html2canvas(dashboard, {
                    scale: 2,
                    backgroundColor: "#f9fafb",
                    logging: false,
                }).then((canvas) => {
                    const link = document.createElement("a");
                    const timestamp = new Date().toISOString().split("T")[0];
                    link.download = `portfolio_dashboard_${timestamp}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                    showNotification("Success", "Dashboard exported as PNG", "success");
                });
            } catch (error) {
                console.error("PNG export error:", error);
                showNotification("Error", "Failed to export as PNG", "error");
            }
        }
        
        // Update Report Date
        function updateReportDate() {
            if (portfolioData && portfolioData.length > 0) {
                // Get the most recent Report_Date from the data
                let maxDate = null;
                for (let i = 0; i < portfolioData.length; i++) {
                    const dateStr = portfolioData[i].Report_Date;
                    if (dateStr) {
                        const date = parseDate(dateStr);
                        if (date && (!maxDate || date > maxDate)) {
                            maxDate = date;
                        }
                    }
                }
                
                if (maxDate) {
                    const formatted = formatDate(maxDate);
                    document.getElementById("reportDate").textContent = formatted;
                } else {
                    document.getElementById("reportDate").textContent = "N/A";
                }
            }
        }

        // Calculate top metrics (OPTIMIZED with caching)
        function calculateMetrics() {
            // Check cache
            if (metricsCache.full) {
                const cached = metricsCache.full;
                document.getElementById("totalRelationships").textContent =
                    cached.relationships.toLocaleString();
                document.getElementById("totalFacilities").textContent =
                    cached.facilities.toLocaleString();
                document.getElementById("totalOSUC").textContent = formatCurrency(
                    cached.osuc
                );
                document.getElementById("totalFacAmount").textContent =
                    formatCurrency(cached.facAmount);
                document.getElementById("totalOutstanding").textContent =
                    formatCurrency(cached.outstanding);
                return;
            }
            
            const startTime = performance.now();
            
            let totalFacAmount = 0;
            let totalOSUC = 0;
            let totalOutstanding = 0;
            const relationships = new Set();
            const facilities = new Set();
            
            // Single pass through data (much faster than multiple passes)
            for (let i = 0; i < portfolioData.length; i++) {
                const row = portfolioData[i];
                
                totalFacAmount += parseNumber(row.Fac_Amount);
                totalOSUC += parseNumber(row.OSUC);
                
                // Total Outstanding from Total_OS column
                totalOutstanding += parseNumber(row.Total_OS);
                
                const rel = row.Relationship_Name || row.Relationship_ID;
                if (rel) relationships.add(rel);
                
                if (row.Facility_ID) facilities.add(row.Facility_ID);
            }
            
            const metrics = {
                relationships: relationships.size,
                facilities: facilities.size,
                osuc: totalOSUC,
                facAmount: totalFacAmount,
                outstanding: totalOutstanding,
            };
            
            // Cache the results
            metricsCache.full = metrics;
            
            document.getElementById("totalRelationships").textContent =
                metrics.relationships.toLocaleString();
            document.getElementById("totalFacilities").textContent =
                metrics.facilities.toLocaleString();
            document.getElementById("totalOSUC").textContent = formatCurrency(
                metrics.osuc
            );
            document.getElementById("totalFacAmount").textContent = formatCurrency(
                metrics.facAmount
            );
            document.getElementById("totalOutstanding").textContent =
                formatCurrency(metrics.outstanding);

            console.log(
                `Metrics calculated in ${(performance.now() - startTime).toFixed(
                    2
                )}ms:`,
                metrics
            );
            
            // Calculate expired metrics
            calculateExpiredMetrics();
            
            // Calculate new deals YTD/MTD metrics
            calculateNewDealsMetrics();
            
            // Populate pipeline deals table
            populatePipelineTable();
        }

        // Calculate Facilities Expired and CAs Expired metrics
        function calculateExpiredMetrics() {
            // Get the current report month
            const reportDates = portfolioData
                .map((row) => parseDate(row.Report_Date))
                .filter((d) => d);
            if (reportDates.length === 0) return;
            
            const maxReportDate = new Date(Math.max(...reportDates));
            const currentYear = maxReportDate.getFullYear();
            const currentMonth = maxReportDate.getMonth();
            
            // Calculate start and end of current month
            const monthStart = new Date(currentYear, currentMonth, 1);
            monthStart.setHours(0, 0, 0, 0);
            const monthEnd = new Date(currentYear, currentMonth + 1, 0);
            monthEnd.setHours(23, 59, 59, 999);
            
            // Count expired facilities and CAs in current month only
            let facilitiesExpiredCount = 0;
            let facilitiesExpiredAmount = 0;
            const expiredCAs = new Set();
            let casExpiredAmount = 0;
            
            for (let i = 0; i < portfolioData.length; i++) {
                const row = portfolioData[i];
                
                // Check Facilities Expired (count ALL lines, not unique)
                const maturityDate = parseDate(row.Maturity_Date);
                if (
                    maturityDate &&
                    maturityDate >= monthStart &&
                    maturityDate <= monthEnd &&
                    maturityDate < maxReportDate
                ) {
                    facilitiesExpiredCount++;
                    facilitiesExpiredAmount += parseNumber(
                        row.Fac_Amount || row.Facility_Amount
                    );
                }
                
                // Check CAs Expired (count unique CAIDs, but sum ALL lines, exclude DM)
                const caExpirationDate = parseDate(row.CA_Expiration_Date);
                const managementStatus = (row.Management_Status || "").toUpperCase();
                if (
                    caExpirationDate &&
                    caExpirationDate >= monthStart &&
                    caExpirationDate <= monthEnd &&
                    caExpirationDate < maxReportDate &&
                    row.CAID &&
                    managementStatus !== "DM"
                ) {
                    expiredCAs.add(row.CAID);
                    casExpiredAmount += parseNumber(
                        row.Fac_Amount || row.Facility_Amount
                    );
                }
            }
            
            const casExpiredCount = expiredCAs.size;
            
            // Update DOM
            document.getElementById("facilitiesExpiredCount").textContent =
                facilitiesExpiredCount.toLocaleString();
            document.getElementById("casExpiredCount").textContent =
                casExpiredCount.toLocaleString();

            console.log("Expired Metrics:", {
                facilitiesExpired: facilitiesExpiredCount,
                facilitiesExpiredAmount: facilitiesExpiredAmount,
                casExpired: casExpiredCount,
                casExpiredAmount: casExpiredAmount,
            });
        }

        // Calculate New Deals Closed YTD and MTD metrics
        function calculateNewDealsMetrics() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            
            // Calculate date ranges
            const ytdStart = new Date(currentYear, 0, 1); // Jan 1 of current year
            ytdStart.setHours(0, 0, 0, 0);
            
            const mtdStart = new Date(currentYear, currentMonth, 1); // 1st of current month
            mtdStart.setHours(0, 0, 0, 0);
            
            const priorYtdStart = new Date(currentYear - 1, 0, 1); // Jan 1 of prior year
            priorYtdStart.setHours(0, 0, 0, 0);
            const priorYtdEnd = new Date(currentYear - 1, currentMonth, now.getDate()); // Same date last year
            priorYtdEnd.setHours(23, 59, 59, 999);
            
            const priorMtdStart = new Date(currentYear, currentMonth - 1, 1); // 1st of prior month
            priorMtdStart.setHours(0, 0, 0, 0);
            const priorMtdEnd = new Date(currentYear, currentMonth - 1, now.getDate()); // Same date prior month
            priorMtdEnd.setHours(23, 59, 59, 999);
            
            // Track unique facilities
            const ytdFacilities = new Set();
            const mtdFacilities = new Set();
            const priorYtdFacilities = new Set();
            const priorMtdFacilities = new Set();
            
            let ytdAmount = 0;
            let mtdAmount = 0;
            let priorYtdAmount = 0;
            let priorMtdAmount = 0;
            
            // Iterate through portfolio data
            for (let i = 0; i < portfolioData.length; i++) {
                const row = portfolioData[i];
                const approvalDate = parseDate(row.Origination_Date);
                const facilityId = row.Facility_ID;
                const facAmount = parseNumber(row.Fac_Amount);
                
                if (!approvalDate || !facilityId) continue;
                
                // Check YTD (current year)
                if (approvalDate >= ytdStart && approvalDate <= now) {
                    if (!ytdFacilities.has(facilityId)) {
                        ytdFacilities.add(facilityId);
                        ytdAmount += facAmount;
                    }
                }
                
                // Check MTD (current month)
                if (approvalDate >= mtdStart && approvalDate <= now) {
                    if (!mtdFacilities.has(facilityId)) {
                        mtdFacilities.add(facilityId);
                        mtdAmount += facAmount;
                    }
                }
                
                // Check prior YTD (same period last year)
                if (approvalDate >= priorYtdStart && approvalDate <= priorYtdEnd) {
                    if (!priorYtdFacilities.has(facilityId)) {
                        priorYtdFacilities.add(facilityId);
                        priorYtdAmount += facAmount;
                    }
                }
                
                // Check prior MTD (same period last month)
                if (approvalDate >= priorMtdStart && approvalDate <= priorMtdEnd) {
                    if (!priorMtdFacilities.has(facilityId)) {
                        priorMtdFacilities.add(facilityId);
                        priorMtdAmount += facAmount;
                    }
                }
            }
            
            // Calculate variances
            const ytdVariance = priorYtdFacilities.size > 0 
                ? ((ytdFacilities.size - priorYtdFacilities.size) / priorYtdFacilities.size) * 100 
                : 0;
            const mtdVariance = priorMtdFacilities.size > 0 
                ? ((mtdFacilities.size - priorMtdFacilities.size) / priorMtdFacilities.size) * 100 
                : 0;
            
            // Update UI - YTD
            document.getElementById('newDealsYTD').textContent = ytdFacilities.size.toLocaleString();
            document.getElementById('newDealsYTDAmount').textContent = formatCurrency(ytdAmount);
            
            const ytdVarianceEl = document.getElementById('newDealsYTDVariance');
            updateVarianceDisplay(ytdVarianceEl, ytdVariance);
            
            // Update UI - MTD
            document.getElementById('newDealsMTD').textContent = mtdFacilities.size.toLocaleString();
            document.getElementById('newDealsMTDAmount').textContent = formatCurrency(mtdAmount);
            
            const mtdVarianceEl = document.getElementById('newDealsMTDVariance');
            updateVarianceDisplay(mtdVarianceEl, mtdVariance);
            
            console.log('New Deals Metrics:', {
                ytd: { count: ytdFacilities.size, amount: ytdAmount, variance: ytdVariance.toFixed(1) + '%' },
                mtd: { count: mtdFacilities.size, amount: mtdAmount, variance: mtdVariance.toFixed(1) + '%' },
                priorYtd: { count: priorYtdFacilities.size, amount: priorYtdAmount },
                priorMtd: { count: priorMtdFacilities.size, amount: priorMtdAmount }
            });
        }
        
        // Helper function to update variance display with colors and icons
        function updateVarianceDisplay(element, variance) {
            const absVariance = Math.abs(variance);
            const displayText = absVariance.toFixed(1) + '%';
            
            if (variance > 0) {
                // Positive variance - green
                element.className = 'flex items-center gap-1 rounded-full bg-success-50 py-0.5 pl-2 pr-2.5 text-sm font-medium text-success-600';
                element.innerHTML = `
                    <svg class="fill-current" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M5.56462 1.62393C5.70193 1.47072 5.90135 1.37432 6.12329 1.37432C6.1236 1.37432 6.12391 1.37432 6.12422 1.37432C6.31631 1.37415 6.50845 1.44731 6.65505 1.59381L9.65514 4.5918C9.94814 4.88459 9.94831 5.35947 9.65552 5.65246C9.36273 5.94546 8.88785 5.94562 8.59486 5.65283L6.87329 3.93247L6.87329 10.125C6.87329 10.5392 6.53751 10.875 6.12329 10.875C5.70908 10.875 5.37329 10.5392 5.37329 10.125L5.37329 3.93578L3.65516 5.65282C3.36218 5.94562 2.8873 5.94547 2.5945 5.65248C2.3017 5.35949 2.30185 4.88462 2.59484 4.59182L5.56462 1.62393Z" fill=""></path>
                    </svg>
                    ${displayText}
                `;
            } else if (variance < 0) {
                // Negative variance - red
                element.className = 'flex items-center gap-1 rounded-full bg-error-50 py-0.5 pl-2 pr-2.5 text-sm font-medium text-error-600';
                element.innerHTML = `
                    <svg class="fill-current" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M5.31462 10.3761C5.45194 10.5293 5.65136 10.6257 5.87329 10.6257C5.8736 10.6257 5.8739 10.6257 5.87421 10.6257C6.0663 10.6259 6.25845 10.5527 6.40505 10.4062L9.40514 7.4082C9.69814 7.11541 9.69831 6.64054 9.40552 6.34754C9.11273 6.05454 8.63785 6.05438 8.34486 6.34717L6.62329 8.06753L6.62329 1.875C6.62329 1.46079 6.28751 1.125 5.87329 1.125C5.45908 1.125 5.12329 1.46079 5.12329 1.875L5.12329 8.06422L3.40516 6.34719C3.11218 6.05439 2.6373 6.05454 2.3445 6.34752C2.0517 6.64051 2.05185 7.11538 2.34484 7.40818L5.31462 10.3761Z" fill=""></path>
                    </svg>
                    ${displayText}
                `;
            } else {
                // No change - gray
                element.className = 'flex items-center gap-1 rounded-full bg-gray-100 py-0.5 pl-2 pr-2.5 text-sm font-medium text-gray-600';
                element.textContent = displayText;
            }
        }

        // Calculate New Deals Closed YTD and MTD metrics from filtered data
        function calculateNewDealsMetricsFromFiltered() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            
            // Calculate date ranges
            const ytdStart = new Date(currentYear, 0, 1);
            ytdStart.setHours(0, 0, 0, 0);
            
            const mtdStart = new Date(currentYear, currentMonth, 1);
            mtdStart.setHours(0, 0, 0, 0);
            
            const priorYtdStart = new Date(currentYear - 1, 0, 1);
            priorYtdStart.setHours(0, 0, 0, 0);
            const priorYtdEnd = new Date(currentYear - 1, currentMonth, now.getDate());
            priorYtdEnd.setHours(23, 59, 59, 999);
            
            const priorMtdStart = new Date(currentYear, currentMonth - 1, 1);
            priorMtdStart.setHours(0, 0, 0, 0);
            const priorMtdEnd = new Date(currentYear, currentMonth - 1, now.getDate());
            priorMtdEnd.setHours(23, 59, 59, 999);
            
            // Track unique facilities
            const ytdFacilities = new Set();
            const mtdFacilities = new Set();
            const priorYtdFacilities = new Set();
            const priorMtdFacilities = new Set();
            
            let ytdAmount = 0;
            let mtdAmount = 0;
            let priorYtdAmount = 0;
            let priorMtdAmount = 0;
            
            // Use filtered data if available, otherwise use portfolio data
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
            
            // Iterate through data
            for (let i = 0; i < dataSource.length; i++) {
                const row = dataSource[i];
                const approvalDate = parseDate(row.Origination_Date);
                const facilityId = row.Facility_ID;
                const facAmount = parseNumber(row.Fac_Amount);
                
                if (!approvalDate || !facilityId) continue;
                
                // Check YTD (current year)
                if (approvalDate >= ytdStart && approvalDate <= now) {
                    if (!ytdFacilities.has(facilityId)) {
                        ytdFacilities.add(facilityId);
                        ytdAmount += facAmount;
                    }
                }
                
                // Check MTD (current month)
                if (approvalDate >= mtdStart && approvalDate <= now) {
                    if (!mtdFacilities.has(facilityId)) {
                        mtdFacilities.add(facilityId);
                        mtdAmount += facAmount;
                    }
                }
                
                // Check prior YTD (same period last year)
                if (approvalDate >= priorYtdStart && approvalDate <= priorYtdEnd) {
                    if (!priorYtdFacilities.has(facilityId)) {
                        priorYtdFacilities.add(facilityId);
                        priorYtdAmount += facAmount;
                    }
                }
                
                // Check prior MTD (same period last month)
                if (approvalDate >= priorMtdStart && approvalDate <= priorMtdEnd) {
                    if (!priorMtdFacilities.has(facilityId)) {
                        priorMtdFacilities.add(facilityId);
                        priorMtdAmount += facAmount;
                    }
                }
            }
            
            // Calculate variances
            const ytdVariance = priorYtdFacilities.size > 0 
                ? ((ytdFacilities.size - priorYtdFacilities.size) / priorYtdFacilities.size) * 100 
                : 0;
            const mtdVariance = priorMtdFacilities.size > 0 
                ? ((mtdFacilities.size - priorMtdFacilities.size) / priorMtdFacilities.size) * 100 
                : 0;
            
            // Update UI - YTD
            document.getElementById('newDealsYTD').textContent = ytdFacilities.size.toLocaleString();
            document.getElementById('newDealsYTDAmount').textContent = formatCurrency(ytdAmount);
            
            const ytdVarianceEl = document.getElementById('newDealsYTDVariance');
            updateVarianceDisplay(ytdVarianceEl, ytdVariance);
            
            // Update UI - MTD
            document.getElementById('newDealsMTD').textContent = mtdFacilities.size.toLocaleString();
            document.getElementById('newDealsMTDAmount').textContent = formatCurrency(mtdAmount);
            
            const mtdVarianceEl = document.getElementById('newDealsMTDVariance');
            updateVarianceDisplay(mtdVarianceEl, mtdVariance);
        }

        // Populate Pipeline Deals Table
        function populatePipelineTable() {
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Find the most recent Report_Date to determine the reporting year
            let mostRecentReportDate = null;
            for (const row of dataSource) {
                const reportDate = parseDate(row.Report_Date);
                if (reportDate && (!mostRecentReportDate || reportDate > mostRecentReportDate)) {
                    mostRecentReportDate = reportDate;
                }
            }
            
            const reportingYear = mostRecentReportDate ? mostRecentReportDate.getFullYear() : today.getFullYear();
            console.log('Pipeline Table - Reporting Year:', reportingYear);
            
            // Define aging buckets (in days) - Always show these 4 rows
            const buckets = [
                { label: '30 days', min: 0, max: 30, count: 0, facilities: new Set(), tfa: 0 },
                { label: '60 days', min: 31, max: 60, count: 0, facilities: new Set(), tfa: 0 },
                { label: '90 days', min: 61, max: 90, count: 0, facilities: new Set(), tfa: 0 },
                { label: 'Over 90 days', min: 91, max: Infinity, count: 0, facilities: new Set(), tfa: 0 }
            ];
            
            // Filter and categorize deals
            dataSource.forEach(row => {
                const originationDate = row.Origination_Date;
                const firstApprovalDate = parseDate(row.Facility_First_Approval_Date);
                const reportDate = parseDate(row.Report_Date);
                const facilityId = row.Facility_ID;
                const tfaAmount = parseNumber(row.Fac_Amount || row.Facility_Amount);
                
                // Only include deals where:
                // 1. Origination_Date is empty
                // 2. Has first approval date
                // 3. Report_Date is in the same year as reporting year
                if ((!originationDate || originationDate.trim() === '') && 
                    firstApprovalDate && 
                    facilityId && 
                    reportDate && 
                    reportDate.getFullYear() === reportingYear) {
                    
                    // Calculate days since approval
                    const daysSinceApproval = Math.floor((today - firstApprovalDate) / (1000 * 60 * 60 * 24));
                    
                    // Find appropriate bucket
                    for (const bucket of buckets) {
                        if (daysSinceApproval >= bucket.min && daysSinceApproval <= bucket.max) {
                            bucket.facilities.add(facilityId);
                            bucket.tfa += tfaAmount;
                            break;
                        }
                    }
                }
            });
            
            // Update bucket counts from unique facilities
            buckets.forEach(bucket => {
                bucket.count = bucket.facilities.size;
            });
            
            // Populate table
            const tableBody = document.getElementById('pipelineTableBody');
            if (!tableBody) return;
            
            // Calculate totals
            const totalCount = buckets.reduce((sum, b) => sum + b.count, 0);
            const totalTFA = buckets.reduce((sum, b) => sum + b.tfa, 0);
            
            // Build table rows - always show all 4 buckets
            let html = '';
            buckets.forEach(bucket => {
                html += `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-5 py-3 text-sm text-gray-700">${bucket.label}</td>
                        <td class="px-5 py-3 text-sm text-gray-900 font-semibold text-right">${bucket.count.toLocaleString()}</td>
                        <td class="px-5 py-3 text-sm text-gray-900 font-semibold text-right">${formatCurrency(bucket.tfa)}</td>
                    </tr>
                `;
            });
            
            // Add total row
            html += `
                <tr class="bg-gray-50 font-semibold border-t-2 border-gray-300">
                    <td class="px-5 py-3 text-sm text-gray-900">Total</td>
                    <td class="px-5 py-3 text-sm text-gray-900 text-right">${totalCount.toLocaleString()}</td>
                    <td class="px-5 py-3 text-sm text-gray-900 text-right">${formatCurrency(totalTFA)}</td>
                </tr>
            `;
            
            tableBody.innerHTML = html;
            
            console.log('Pipeline Table populated:', {
                reportingYear: reportingYear,
                totalFacilities: totalCount,
                totalTFA: formatCurrency(totalTFA),
                buckets: buckets.map(b => ({ label: b.label, count: b.count, tfa: formatCurrency(b.tfa) }))
            });
        }

        // Parse number that might be formatted (e.g., "5.5M", "1.2K", "1,000,000")
        function parseNumber(value) {
            if (!value) return 0;
            
            // If already a number, return it
            if (typeof value === "number") return value;
            
            // Convert to string and clean
            let str = String(value).trim().toUpperCase();
            
            // Remove currency symbols and commas
            str = str.replace(/[$,]/g, "");
            
            // Handle K (thousands)
            if (str.endsWith("K")) {
                return parseFloat(str.replace("K", "")) * 1000;
            }
            
            // Handle M (millions)
            if (str.endsWith("M")) {
                return parseFloat(str.replace("M", "")) * 1000000;
            }
            
            // Handle B (billions)
            if (str.endsWith("B")) {
                return parseFloat(str.replace("B", "")) * 1000000000;
            }
            
            // Regular number
            return parseFloat(str) || 0;
        }

        // Parse percentage values (handles "0.1%", "12.5%", or decimal 0.001)
        function parsePercentage(value) {
            if (!value && value !== 0) return 0;

            // If already a number
            if (typeof value === "number") {
                // If it's a small decimal (< 1), assume it's already in decimal form (0.001 = 0.1%)
                // and convert to percentage
                if (value < 1 && value > -1) {
                    return value * 100;
                }
                return value;
            }

            // Convert to string and clean
            let str = String(value).trim();

            // Remove commas
            str = str.replace(/,/g, "");

            // Handle percentage sign
            if (str.includes("%")) {
                // Remove % and parse - "0.1%" becomes 0.1
                return parseFloat(str.replace("%", "")) || 0;
            }

            // If no % sign, check if it's a small decimal
            const numValue = parseFloat(str);
            if (!isNaN(numValue)) {
                // If it's a small decimal (< 1), assume it's in decimal form and convert
                if (numValue < 1 && numValue > -1) {
                    return numValue * 100;
                }
                return numValue;
            }

            return 0;
        }
        
        // Format currency with M/B notation
        function formatCurrency(value) {
            if (!value || value === 0) return "$0";
            
            const absValue = Math.abs(value);
            
            // Billions
            if (absValue >= 1000000000) {
                return "$" + (value / 1000000000).toFixed(2) + "B";
            }
            
            // Millions
            if (absValue >= 1000000) {
                return "$" + (value / 1000000).toFixed(2) + "M";
            }
            
            // Thousands
            if (absValue >= 1000) {
                return "$" + (value / 1000).toFixed(2) + "K";
            }
            
            // Less than 1000
            return "$" + value.toFixed(2);
        }
        
        // Format currency for detailed display (with commas)
        function formatCurrencyDetailed(value) {
            return new Intl.NumberFormat("en-US", {
                style: "currency",
                currency: "USD",
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            }).format(value);
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return "N/A";
            const date = parseDate(dateString);
            if (!date) return "N/A";
            return date.toLocaleDateString("en-US", {
                year: "numeric",
                month: "short",
                day: "numeric",
            });
        }

        // Create expiration timeline chart (Area chart for Facilities only)
        function createExpirationChart() {
            console.log(" Creating facilities expired & expiring bar chart");
            
            // Get the current reporting month from the data
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Generate next 3 months starting from current month
            const next3Months = [];
            for (let i = 0; i < 3; i++) {
                const date = new Date(today);
                date.setMonth(date.getMonth() + i);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, "0");
                next3Months.push(`${year}-${month}`);
            }
            
            console.log("Next 3 months starting from current:", next3Months);
            
            // Group by month-year and categorize as expired or expiring
            const monthlyData = {};
            
            // Initialize all 3 months
            next3Months.forEach((monthYear) => {
                monthlyData[monthYear] = {
                    expired: [],
                    expiring: [],
                };
            });
            
            portfolioData.forEach((row) => {
                const maturityDate = row.Maturity_Date;
                const facilityId = row.Facility_ID;
                
                if (maturityDate && facilityId) {
                    const dateObj = parseDate(maturityDate);
                    if (dateObj) {
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthYear = `${year}-${month}`;
                        
                        // Only include if it's in our next 3 months
                        if (next3Months.includes(monthYear)) {
                            // Categorize based on whether date is past or future
                            if (dateObj < today) {
                                monthlyData[monthYear].expired.push(facilityId);
                            } else {
                                monthlyData[monthYear].expiring.push(facilityId);
                            }
                        }
                    }
                }
            });
            
            // Prepare data for the next 3 months
            const categories = next3Months.map((m) => {
                const date = new Date(m + "-01");
                return date.toLocaleDateString("en-US", { month: "short" });
            });

            const expiredData = next3Months.map(
                (month) => monthlyData[month].expired.length
            );
            const expiringData = next3Months.map(
                (month) => monthlyData[month].expiring.length
            );

            console.log("Expired:", expiredData);
            console.log("Expiring:", expiringData);
            
            const options = {
                series: [
                    {
                        name: "Expired",
                        data: expiredData,
                    },
                    {
                        name: "Expiring",
                        data: expiringData,
                    },
                ],
                colors: ["#93a8ff", "#465fff"],
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "bar",
                    stacked: false,
                    height: "100%",
                    toolbar: {
                        show: false,
                    },
                    zoom: {
                        enabled: false,
                    },
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: "55%",
                        borderRadius: 8,
                        borderRadiusApplication: "end",
                    },
                },
                dataLabels: {
                    enabled: false,
                },
                xaxis: {
                    categories: categories,
                    axisBorder: {
                        show: false,
                    },
                    axisTicks: {
                        show: false,
                    },
                },
                legend: {
                    show: true,
                    position: "top",
                    horizontalAlign: "left",
                    markers: {
                        size: 5,
                        shape: "circle",
                        radius: 999,
                        strokeWidth: 0,
                    },
                    itemMargin: {
                        horizontal: 10,
                        vertical: 0,
                    },
                },
                yaxis: {
                    title: false,
                },
                grid: {
                    yaxis: {
                        lines: {
                            show: true,
                        },
                    },
                },
                fill: {
                    opacity: 1,
                },
                tooltip: {
                    theme: "light",
                    style: {
                        fontSize: "12px",
                        fontFamily: "Outfit, sans-serif",
                    },
                    x: {
                        show: false,
                    },
                    y: {
                        formatter: function (val) {
                            return val + " facilities";
                        },
                    },
                },
            };

            // Get the chart element and verify it exists
            const chartElement = document.querySelector("#facilityMaturityChart");
            if (!chartElement) {
                console.error(
                    "Facility maturity chart element #facilityMaturityChart not found in DOM"
                );
                return;
            }
            
            // Check if ApexCharts is loaded
            if (typeof ApexCharts === "undefined") {
                console.error("ApexCharts library not loaded yet. Retrying...");
                setTimeout(createExpirationChart, 500);
                return;
            }
            
            try {
                // Destroy existing chart if it exists
                if (facilityMaturityChartInstance) {
                    facilityMaturityChartInstance.destroy();
                    facilityMaturityChartInstance = null;
                }
                
                // Clear the element
                chartElement.innerHTML = "";
                
                // Create and render new chart
                facilityMaturityChartInstance = new ApexCharts(chartElement, options);
                facilityMaturityChartInstance.render();
                console.log(" Facility maturity chart rendered successfully");
            } catch (error) {
                console.error(" Error rendering facility maturity chart:", error);
            }
        }

        // Create combined chart for CAs Coming Due & Facilities Expiring
        function createFacilityTrendChart() {
            console.log(" Creating CAs Coming Due & Facilities Expiring chart");
            
            // Get the current reporting month from the data
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Generate next 3 months starting from current month
            const next3Months = [];
            for (let i = 0; i < 3; i++) {
                const date = new Date(today);
                date.setMonth(date.getMonth() + i);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, "0");
                next3Months.push(`${year}-${month}`);
            }
            
            console.log("Next 3 months starting from current:", next3Months);
            
            // Group by month-year for both CAs and Facilities
            const monthlyData = {};
            
            // Initialize all 3 months
            next3Months.forEach((monthYear) => {
                monthlyData[monthYear] = {
                    casComingDue: new Set(),
                    facilitiesExpiring: [],
                    caAmounts: { tfa: 0, direct: 0, contingent: 0, pse: 0 },
                    facilityAmounts: { tfa: 0, direct: 0, contingent: 0, pse: 0 },
                };
            });
            
            // Collect CAs Coming Due (only future dates, exclude DM)
            portfolioData.forEach((row) => {
                const caExpirationDate = row.CA_Expiration_Date;
                const caid = row.CAID;
                const managementStatus = (row.Management_Status || "").toUpperCase();
                
                if (caExpirationDate && caid && managementStatus !== "DM") {
                    const dateObj = parseDate(caExpirationDate);
                    if (dateObj && dateObj >= today) {
                        // Only future dates (coming due)
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthYear = `${year}-${month}`;
                        
                        // Only include if it's in our next 3 months
                        if (next3Months.includes(monthYear)) {
                            monthlyData[monthYear].casComingDue.add(caid);
                            // Accumulate amounts for CAs (sum ALL lines for each CA)
                            monthlyData[monthYear].caAmounts.tfa += parseNumber(
                                row.Fac_Amount || row.Facility_Amount
                            );
                            monthlyData[monthYear].caAmounts.direct += parseNumber(
                                row.Direct_OS
                            );
                            monthlyData[monthYear].caAmounts.contingent += parseNumber(
                                row.Contingent_OS
                            );
                            monthlyData[monthYear].caAmounts.pse += parseNumber(row.PSE_OS);
                        }
                    }
                }
            });
            
            // Collect Facilities Expiring (only future dates)
            portfolioData.forEach((row) => {
                const maturityDate = row.Maturity_Date;
                const facilityId = row.Facility_ID;
                
                if (maturityDate && facilityId) {
                    const dateObj = parseDate(maturityDate);
                    if (dateObj && dateObj >= today) {
                        // Only future dates (expiring)
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthYear = `${year}-${month}`;
                        
                        // Only include if it's in our next 3 months
                        if (next3Months.includes(monthYear)) {
                            monthlyData[monthYear].facilitiesExpiring.push(facilityId);
                            // Accumulate amounts for Facilities (sum ALL lines)
                            monthlyData[monthYear].facilityAmounts.tfa += parseNumber(
                                row.Fac_Amount || row.Facility_Amount
                            );
                            monthlyData[monthYear].facilityAmounts.direct += parseNumber(
                                row.Direct_OS
                            );
                            monthlyData[monthYear].facilityAmounts.contingent +=
                                parseNumber(row.Contingent_OS);
                            monthlyData[monthYear].facilityAmounts.pse += parseNumber(
                                row.PSE_OS
                            );
                        }
                    }
                }
            });
            
            // Prepare data for the next 3 months
            const categories = next3Months.map((m) => {
                const date = new Date(m + "-01");
                return date.toLocaleDateString("en-US", { month: "short" });
            });

            const casComingDueData = next3Months.map(
                (month) => monthlyData[month].casComingDue.size
            );
            const facilitiesExpiringData = next3Months.map(
                (month) => monthlyData[month].facilitiesExpiring.length
            );

            console.log("CAs Coming Due:", casComingDueData);
            console.log("Facilities Expiring:", facilitiesExpiringData);
            
            // Check if all data is empty
            const totalCAs = casComingDueData.reduce((sum, val) => sum + val, 0);
            const totalFacilities = facilitiesExpiringData.reduce((sum, val) => sum + val, 0);
            
            if (totalCAs === 0 && totalFacilities === 0) {
                console.log(" No expiration data available");
                const chartElement = document.querySelector("#facilityTrendChart");
                if (chartElement) {
                    chartElement.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">No upcoming expirations in the next 3 months</div>';
                }
                return;
            }
            
            const options = {
                series: [
                    {
                        name: "CAs Coming Due",
                        data: casComingDueData,
                    },
                    {
                        name: "Facilities Expiring",
                        data: facilitiesExpiringData,
                    },
                ],
                colors: ["#93a8ff", "#465fff"],
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "bar",
                    stacked: false,
                    height: "100%",
                    toolbar: {
                        show: false,
                    },
                    zoom: {
                        enabled: false,
                    },
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: "55%",
                        borderRadius: 8,
                        borderRadiusApplication: "end",
                    },
                },
                dataLabels: {
                    enabled: false,
                },
                xaxis: {
                    categories: categories,
                    axisBorder: {
                        show: false,
                    },
                    axisTicks: {
                        show: false,
                    },
                },
                legend: {
                    show: true,
                    position: "top",
                    horizontalAlign: "left",
                    markers: {
                        size: 5,
                        shape: "circle",
                        radius: 999,
                        strokeWidth: 0,
                    },
                    itemMargin: {
                        horizontal: 10,
                        vertical: 0,
                    },
                },
                yaxis: {
                    title: false,
                },
                grid: {
                    yaxis: {
                        lines: {
                            show: true,
                        },
                    },
                },
                fill: {
                    opacity: 1,
                },
                tooltip: {
                    theme: "light",
                    shared: true,
                    intersect: false,
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        const monthKey = next3Months[dataPointIndex];
                        const monthData = monthlyData[monthKey];
                        const monthName = categories[dataPointIndex];
                        
                        let html = `<div class="apexcharts-tooltip-custom" style="padding: 12px; min-width: 200px; background: #ffffff; color: #1f2937; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border: 1px solid #e5e7eb;">`;
                        html += `<div style="font-weight: 600; margin-bottom: 8px; font-size: 13px; color: #1f2937;">${monthName}</div>`;
                        
                        // CAs Coming Due
                        const casCount = monthData.casComingDue.size;
                        if (casCount > 0) {
                            html += `<div style="margin-bottom: 6px;">`;
                            html += `<div style="display: flex; align-items: center; margin-bottom: 4px;">`;
                            html += `<span style="width: 8px; height: 8px; background: #93a8ff; border-radius: 50%; margin-right: 6px;"></span>`;
                            html += `<span style="font-weight: 500;">CAs Coming Due: ${casCount}</span>`;
                            html += `</div>`;
                            html += `<div style="padding-left: 14px; font-size: 11px; color: #666;">`;
                            html += `<div>TFA: ${formatCurrency(
                                monthData.caAmounts.tfa
                            )}</div>`;
                            html += `<div>Direct: ${formatCurrency(
                                monthData.caAmounts.direct
                            )}</div>`;
                            if (monthData.caAmounts.contingent > 0) {
                                html += `<div>Contingent: ${formatCurrency(
                                    monthData.caAmounts.contingent
                                )}</div>`;
                            }
                            if (monthData.caAmounts.pse > 0) {
                                html += `<div>Presettlement Exposure: ${formatCurrency(
                                    monthData.caAmounts.pse
                                )}</div>`;
                            }
                            html += `</div></div>`;
                        }
                        
                        // Facilities Expiring
                        const facilitiesCount = monthData.facilitiesExpiring.length;
                        if (facilitiesCount > 0) {
                            html += `<div>`;
                            html += `<div style="display: flex; align-items: center; margin-bottom: 4px;">`;
                            html += `<span style="width: 8px; height: 8px; background: #465fff; border-radius: 50%; margin-right: 6px;"></span>`;
                            html += `<span style="font-weight: 500;">Facilities Expiring: ${facilitiesCount}</span>`;
                            html += `</div>`;
                            html += `<div style="padding-left: 14px; font-size: 11px; color: #666;">`;
                            html += `<div>TFA: ${formatCurrency(
                                monthData.facilityAmounts.tfa
                            )}</div>`;
                            html += `<div>Direct: ${formatCurrency(
                                monthData.facilityAmounts.direct
                            )}</div>`;
                            if (monthData.facilityAmounts.contingent > 0) {
                                html += `<div>Contingent: ${formatCurrency(
                                    monthData.facilityAmounts.contingent
                                )}</div>`;
                            }
                            if (monthData.facilityAmounts.pse > 0) {
                                html += `<div>Presettlement Exposure: ${formatCurrency(
                                    monthData.facilityAmounts.pse
                                )}</div>`;
                            }
                            html += `</div></div>`;
                        }
                        
                        html += `</div>`;
                        return html;
                    },
                },
            };

            // Get the chart element and verify it exists
            const chartElement = document.querySelector("#facilityTrendChart");
            if (!chartElement) {
                console.error(
                    "Facility trend chart element #facilityTrendChart not found in DOM"
                );
                return;
            }
            
            // Verify ApexCharts is loaded
            if (typeof ApexCharts === "undefined") {
                console.error("ApexCharts library not loaded");
                return;
            }
            
            try {
                // Destroy previous instance
                if (facilityTrendChartInstance) {
                    facilityTrendChartInstance.destroy();
                    facilityTrendChartInstance = null;
                }
                
                // Clear any previous content
                chartElement.innerHTML = "";
                
                // Create and render new chart
                facilityTrendChartInstance = new ApexCharts(chartElement, options);
                facilityTrendChartInstance.render();
                console.log(" Facility trend chart rendered successfully");
            } catch (error) {
                console.error(" Error rendering facility trend chart:", error);
            }
        }

        // Create combined chart for CAs Coming Due & Facilities Expiring from filtered data
        function createFacilityTrendChartFromFiltered() {
            console.log(
                " Creating filtered CAs Coming Due & Facilities Expiring chart"
            );
            
            // Get the current reporting month from the data
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Generate next 3 months starting from current month
            const next3Months = [];
            for (let i = 0; i < 3; i++) {
                const date = new Date(today);
                date.setMonth(date.getMonth() + i);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, "0");
                next3Months.push(`${year}-${month}`);
            }
            
            // Group by month-year for both CAs and Facilities
            const monthlyData = {};
            
            // Initialize all 3 months
            next3Months.forEach((monthYear) => {
                monthlyData[monthYear] = {
                    casComingDue: new Set(),
                    facilitiesExpiring: [],
                    caAmounts: { tfa: 0, direct: 0, contingent: 0, pse: 0 },
                    facilityAmounts: { tfa: 0, direct: 0, contingent: 0, pse: 0 },
                };
            });
            
            // Collect CAs Coming Due (only future dates, exclude DM)
            filteredData.forEach((row) => {
                const caExpirationDate = row.CA_Expiration_Date;
                const caid = row.CAID;
                const managementStatus = (row.Management_Status || "").toUpperCase();
                
                if (caExpirationDate && caid && managementStatus !== "DM") {
                    const dateObj = parseDate(caExpirationDate);
                    if (dateObj && dateObj >= today) {
                        // Only future dates (coming due)
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthYear = `${year}-${month}`;
                        
                        // Only include if it's in our next 3 months
                        if (next3Months.includes(monthYear)) {
                            monthlyData[monthYear].casComingDue.add(caid);
                            // Accumulate amounts for CAs (sum ALL lines for each CA)
                            monthlyData[monthYear].caAmounts.tfa += parseNumber(
                                row.Fac_Amount || row.Facility_Amount
                            );
                            monthlyData[monthYear].caAmounts.direct += parseNumber(
                                row.Direct_OS
                            );
                            monthlyData[monthYear].caAmounts.contingent += parseNumber(
                                row.Contingent_OS
                            );
                            monthlyData[monthYear].caAmounts.pse += parseNumber(row.PSE_OS);
                        }
                    }
                }
            });
            
            // Collect Facilities Expiring (only future dates)
            filteredData.forEach((row) => {
                const maturityDate = row.Maturity_Date;
                const facilityId = row.Facility_ID;
                
                if (maturityDate && facilityId) {
                    const dateObj = parseDate(maturityDate);
                    if (dateObj && dateObj >= today) {
                        // Only future dates (expiring)
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthYear = `${year}-${month}`;
                        
                        // Only include if it's in our next 3 months
                        if (next3Months.includes(monthYear)) {
                            monthlyData[monthYear].facilitiesExpiring.push(facilityId);
                            // Accumulate amounts for Facilities (sum ALL lines)
                            monthlyData[monthYear].facilityAmounts.tfa += parseNumber(
                                row.Fac_Amount || row.Facility_Amount
                            );
                            monthlyData[monthYear].facilityAmounts.direct += parseNumber(
                                row.Direct_OS
                            );
                            monthlyData[monthYear].facilityAmounts.contingent +=
                                parseNumber(row.Contingent_OS);
                            monthlyData[monthYear].facilityAmounts.pse += parseNumber(
                                row.PSE_OS
                            );
                        }
                    }
                }
            });
            
            // Prepare data for the next 3 months
            const categories = next3Months.map((m) => {
                const date = new Date(m + "-01");
                return date.toLocaleDateString("en-US", { month: "short" });
            });

            const casComingDueData = next3Months.map(
                (month) => monthlyData[month].casComingDue.size
            );
            const facilitiesExpiringData = next3Months.map(
                (month) => monthlyData[month].facilitiesExpiring.length
            );
            
            // Check if all data is empty
            const totalCAs = casComingDueData.reduce((sum, val) => sum + val, 0);
            const totalFacilities = facilitiesExpiringData.reduce((sum, val) => sum + val, 0);
            
            if (totalCAs === 0 && totalFacilities === 0) {
                console.log(" No expiration data available for filtered results");
                const chartElement = document.querySelector("#facilityTrendChart");
                if (chartElement) {
                    chartElement.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">No upcoming expirations in the next 3 months</div>';
                }
                return;
            }
            
            const options = {
                series: [
                    {
                        name: "CAs Coming Due",
                        data: casComingDueData,
                    },
                    {
                        name: "Facilities Expiring",
                        data: facilitiesExpiringData,
                    },
                ],
                colors: ["#93a8ff", "#465fff"],
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "bar",
                    stacked: false,
                    height: "100%",
                    toolbar: {
                        show: false,
                    },
                    zoom: {
                        enabled: false,
                    },
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: "55%",
                        borderRadius: 8,
                        borderRadiusApplication: "end",
                    },
                },
                dataLabels: {
                    enabled: false,
                },
                xaxis: {
                    categories: categories,
                    axisBorder: {
                        show: false,
                    },
                    axisTicks: {
                        show: false,
                    },
                },
                legend: {
                    show: true,
                    position: "top",
                    horizontalAlign: "left",
                    markers: {
                        size: 5,
                        shape: "circle",
                        radius: 999,
                        strokeWidth: 0,
                    },
                    itemMargin: {
                        horizontal: 10,
                        vertical: 0,
                    },
                },
                yaxis: {
                    title: false,
                },
                grid: {
                    yaxis: {
                        lines: {
                            show: true,
                        },
                    },
                },
                fill: {
                    opacity: 1,
                },
                tooltip: {
                    theme: "light",
                    shared: true,
                    intersect: false,
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        const monthKey = next3Months[dataPointIndex];
                        const monthData = monthlyData[monthKey];
                        const monthName = categories[dataPointIndex];
                        
                        let html = `<div class="apexcharts-tooltip-custom" style="padding: 12px; min-width: 200px; background: #ffffff; color: #1f2937; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border: 1px solid #e5e7eb;">`;
                        html += `<div style="font-weight: 600; margin-bottom: 8px; font-size: 13px; color: #1f2937;">${monthName}</div>`;
                        
                        // CAs Coming Due
                        const casCount = monthData.casComingDue.size;
                        if (casCount > 0) {
                            html += `<div style="margin-bottom: 6px;">`;
                            html += `<div style="display: flex; align-items: center; margin-bottom: 4px;">`;
                            html += `<span style="width: 8px; height: 8px; background: #93a8ff; border-radius: 50%; margin-right: 6px;"></span>`;
                            html += `<span style="font-weight: 500;">CAs Coming Due: ${casCount}</span>`;
                            html += `</div>`;
                            html += `<div style="padding-left: 14px; font-size: 11px; color: #666;">`;
                            html += `<div>TFA: ${formatCurrency(
                                monthData.caAmounts.tfa
                            )}</div>`;
                            html += `<div>Direct: ${formatCurrency(
                                monthData.caAmounts.direct
                            )}</div>`;
                            if (monthData.caAmounts.contingent > 0) {
                                html += `<div>Contingent: ${formatCurrency(
                                    monthData.caAmounts.contingent
                                )}</div>`;
                            }
                            if (monthData.caAmounts.pse > 0) {
                                html += `<div>Presettlement Exposure: ${formatCurrency(
                                    monthData.caAmounts.pse
                                )}</div>`;
                            }
                            html += `</div></div>`;
                        }
                        
                        // Facilities Expiring
                        const facilitiesCount = monthData.facilitiesExpiring.length;
                        if (facilitiesCount > 0) {
                            html += `<div>`;
                            html += `<div style="display: flex; align-items: center; margin-bottom: 4px;">`;
                            html += `<span style="width: 8px; height: 8px; background: #465fff; border-radius: 50%; margin-right: 6px;"></span>`;
                            html += `<span style="font-weight: 500;">Facilities Expiring: ${facilitiesCount}</span>`;
                            html += `</div>`;
                            html += `<div style="padding-left: 14px; font-size: 11px; color: #666;">`;
                            html += `<div>TFA: ${formatCurrency(
                                monthData.facilityAmounts.tfa
                            )}</div>`;
                            html += `<div>Direct: ${formatCurrency(
                                monthData.facilityAmounts.direct
                            )}</div>`;
                            if (monthData.facilityAmounts.contingent > 0) {
                                html += `<div>Contingent: ${formatCurrency(
                                    monthData.facilityAmounts.contingent
                                )}</div>`;
                            }
                            if (monthData.facilityAmounts.pse > 0) {
                                html += `<div>Presettlement Exposure: ${formatCurrency(
                                    monthData.facilityAmounts.pse
                                )}</div>`;
                            }
                            html += `</div></div>`;
                        }
                        
                        html += `</div>`;
                        return html;
                    },
                },
            };

            const chartElement = document.querySelector("#facilityTrendChart");
            if (!chartElement) {
                console.error("Facility trend chart element not found");
                return;
            }
            
            if (typeof ApexCharts === "undefined") {
                console.error("ApexCharts library not loaded");
                return;
            }
            
            try {
                if (facilityTrendChartInstance) {
                    facilityTrendChartInstance.destroy();
                    facilityTrendChartInstance = null;
                }
                
                chartElement.innerHTML = "";
                
                facilityTrendChartInstance = new ApexCharts(chartElement, options);
                facilityTrendChartInstance.render();
                console.log(" Filtered facility trend chart rendered successfully");
            } catch (error) {
                console.error(
                    " Error rendering filtered facility trend chart:",
                    error
                );
            }
        }

        // Parse date in multiple formats (YYYY-MM-DD, DD/MM/YYYY, etc.)
        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            // If it's already a Date object (from Excel parsing), return it
            if (dateStr instanceof Date) {
                return !isNaN(dateStr.getTime()) ? dateStr : null;
            }
            
            // Convert to string for parsing
            const str = String(dateStr).trim();
            if (!str) return null;
            
            try {
                // Handle YYYY-MM-DD format (most common in CSV)
                if (str.includes("-")) {
                    const parts = str.split("-");
                    if (parts.length === 3) {
                        // Check if it's YYYY-MM-DD
                        if (parts[0].length === 4) {
                            const year = parseInt(parts[0]);
                            const month = parseInt(parts[1]) - 1; // JavaScript months are 0-indexed
                            const day = parseInt(parts[2]);
                            const date = new Date(year, month, day);
                            if (!isNaN(date.getTime())) {
                                return date;
                            }
                        }
                    }
                }
                
                // Handle DD/MM/YYYY format
                if (str.includes("/")) {
                    const parts = str.split("/");
                    if (parts.length === 3) {
                        const day = parseInt(parts[0]);
                        const month = parseInt(parts[1]) - 1; // JavaScript months are 0-indexed
                        const year = parseInt(parts[2]);
                        const date = new Date(year, month, day);
                        if (!isNaN(date.getTime())) {
                            return date;
                        }
                    }
                }
                
                // Try standard date parsing as fallback
                const date = new Date(str);
                if (!isNaN(date.getTime())) {
                    return date;
                }
            } catch (e) {
                // Only log occasionally to avoid console spam
                if (Math.random() < 0.01) {
                    console.warn("Invalid date:", str);
                }
            }
            return null;
        }

        // Aggregate expiration data for the next 3 months (counts unique Facilities only)
        function aggregateExpirationData(data) {
            console.log(
                ` Aggregating maturity data for ${data.length} rows (Expired vs Expiring)`
            );
            
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Start of today
            
            // Group by month-year with Sets to track unique Facility IDs
            const expiredByMonth = {}; // { 'YYYY-MM': Set<Facility_ID> }
            const expiringByMonth = {}; // { 'YYYY-MM': Set<Facility_ID> }
            
            let expiredCount = 0;
            let expiringCount = 0;
            let validMaturityDates = 0;
            
            data.forEach((row, index) => {
                const maturityDate = row.Maturity_Date;
                if (maturityDate) {
                    const dateObj = parseDate(maturityDate);
                    if (dateObj && row.Facility_ID) {
                        validMaturityDates++;
                        
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthYear = `${year}-${month}`;
                        
                        // Determine if expired or expiring
                        if (dateObj < today) {
                            // Expired (past date)
                            expiredCount++;
                            if (!expiredByMonth[monthYear]) {
                                expiredByMonth[monthYear] = new Set();
                            }
                            expiredByMonth[monthYear].add(row.Facility_ID);
                        } else {
                            // Expiring (future date)
                            expiringCount++;
                            if (!expiringByMonth[monthYear]) {
                                expiringByMonth[monthYear] = new Set();
                            }
                            expiringByMonth[monthYear].add(row.Facility_ID);
                        }
                        
                        // Log first few for debugging
                        if (index < 3) {
                            const status = dateObj < today ? "Expired" : "Expiring";
                            console.log(
                                `  Row ${index}: Maturity=${maturityDate}  ${monthYear}, Status=${status}, Facility=${row.Facility_ID}`
                            );
                        }
                    }
                }
            });
            
            console.log(`  Valid maturity dates: ${validMaturityDates}`);
            console.log(`  Expired facilities: ${expiredCount}`);
            console.log(`  Expiring facilities: ${expiringCount}`);
            
            // Get all unique months and sort (last 12 months)
            const allMonths = [
                ...new Set([
                    ...Object.keys(expiredByMonth),
                    ...Object.keys(expiringByMonth),
                ]),
            ].sort();
            const last12Months = allMonths.slice(-12); // Get last 12 months
            
            // Convert Sets to counts for each month
            const expiredData = last12Months.map((month) =>
                expiredByMonth[month] ? expiredByMonth[month].size : 0
            );
            const expiringData = last12Months.map((month) =>
                expiringByMonth[month] ? expiringByMonth[month].size : 0
            );
            
            return {
                expired: expiredData,
                expiring: expiringData,
                allMonths: last12Months,
            };
        }

        // Aggregate data by month and year
        function aggregateByMonthYear(data, dateField) {
            console.log(`Aggregating ${data.length} rows by ${dateField}`);
            const grouped = {};
            let validDates = 0;
            let invalidDates = 0;
            
            data.forEach((row, index) => {
                const dateValue = row[dateField];
                if (dateValue) {
                    const dateObj = parseDate(dateValue);
                    if (dateObj) {
                        validDates++;
                        // Format as YYYY-MM
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthYear = `${year}-${month}`;
                        grouped[monthYear] = (grouped[monthYear] || 0) + 1;
                        
                        // Log first few dates for debugging
                        if (index < 3) {
                            console.log(
                                `  Row ${index}: ${dateField}="${dateValue}"  ${monthYear}`
                            );
                        }
                    } else {
                        invalidDates++;
                        if (index < 3) {
                            console.log(
                                `  Row ${index}: ${dateField}="${dateValue}"  INVALID`
                            );
                        }
                    }
                } else {
                    invalidDates++;
                }
            });
            
            console.log(
                `Valid dates: ${validDates}, Invalid/Empty: ${invalidDates}`
            );
            console.log(`Unique months: ${Object.keys(grouped).length}`);
            
            return Object.entries(grouped)
                .map(([month, count]) => ({ month, count }))
                .sort((a, b) => a.month.localeCompare(b.month));
        }

        // Aggregate data by date
        function aggregateByDate(data, dateField) {
            const grouped = {};
            data.forEach((row) => {
                const date = row[dateField];
                if (date) {
                    const monthYear = date.substring(0, 7); // YYYY-MM
                    grouped[monthYear] = (grouped[monthYear] || 0) + 1;
                }
            });
            
            return Object.entries(grouped)
                .map(([date, count]) => ({ date: date + "-01", count }))
                .sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        // Create relationship bar chart (OPTIMIZED)
        function createRelationshipChart() {
            const startTime = performance.now();
            const topN = parseInt(document.getElementById("topNFilter").value);
            
            // Use amount type based on filter selection
            let fieldName, seriesName;
            switch (selectedAmountType) {
                case "direct":
                    fieldName = "Direct_OS";
                    seriesName = "Direct OS";
                    break;
                case "contingent":
                    fieldName = "Contingent_OS";
                    seriesName = "Contingent OS";
                    break;
                case "pse":
                    fieldName = "PSE_OS";
                    seriesName = "PSE OS";
                    break;
                case "osuc":
                    fieldName = "OSUC";
                    seriesName = "OSUC";
                    break;
                case "unused":
                    fieldName = "Unused_Committed";
                    seriesName = "Undrawn Commitment";
                    break;
                case "tfa":
                    fieldName = "Fac_Amount";
                    seriesName = "Total Facility Amount";
                    break;
                default:
                    fieldName = "Direct_OS";
                    seriesName = "Direct OS";
            }

            console.log(
                "Creating relationship chart, field:",
                fieldName,
                "dataLength:",
                portfolioData.length
            );
            
            // Use Map for better performance - store all exposure types
            const relationshipData = new Map();
            
            for (let i = 0; i < portfolioData.length; i++) {
                const row = portfolioData[i];
                const relId = row.Relationship_Name || row.Relationship_ID;
                
                if (relId) {
                    if (!relationshipData.has(relId)) {
                        relationshipData.set(relId, {
                            tfa: 0,
                            direct: 0,
                            contingent: 0,
                            pse: 0,
                            osuc: 0,
                            unused: 0,
                            facilityCount: 0,
                        });
                    }
                    
                    const data = relationshipData.get(relId);
                    data.tfa += parseNumber(row.Fac_Amount || row.Facility_Amount);
                    data.direct += parseNumber(row.Direct_OS);
                    data.contingent += parseNumber(row.Contingent_OS);
                    data.pse += parseNumber(row.PSE_OS);
                    data.osuc += parseNumber(row.OSUC);
                    data.unused += parseNumber(row.Unused_Committed);
                    if (row.Facility_ID) data.facilityCount++;
                }
            }
            
            console.log("Total unique relationships:", relationshipData.size);
            
            // Get the selected field value for sorting
            const relationshipTotals = new Map();
            for (const [relId, data] of relationshipData.entries()) {
                let sortValue = 0;
                switch (selectedAmountType) {
                    case "tfa":
                        sortValue = data.tfa;
                        break;
                    case "direct":
                        sortValue = data.direct;
                        break;
                    case "contingent":
                        sortValue = data.contingent;
                        break;
                    case "pse":
                        sortValue = data.pse;
                        break;
                    case "osuc":
                        sortValue = data.osuc;
                        break;
                    case "unused":
                        sortValue = data.unused;
                        break;
                    default:
                        sortValue = data.direct;
                }
                relationshipTotals.set(relId, sortValue);
            }
            
            // Convert to array and sort (only what we need)
            const sorted = Array.from(relationshipTotals.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, topN);
            
            console.log(
                `Chart aggregated ${portfolioData.length} rows, found ${relationshipTotals.size
                } relationships in ${(performance.now() - startTime).toFixed(2)}ms`
            );
            
            // Add index numbers (1, 2, 3, ...) before relationship names
            const relationships = sorted.map(
                (item, index) => `${index + 1}. ${item[0]}`
            );
            const amounts = sorted.map((item) => item[1]);
            
            // Debug logging for TFA
            console.log("DEBUG (non-filtered) - selectedAmountType:", selectedAmountType);
            console.log("DEBUG (non-filtered) - seriesName:", seriesName);
            console.log("DEBUG (non-filtered) - relationships:", relationships);
            console.log("DEBUG (non-filtered) - amounts:", amounts);
            console.log("DEBUG (non-filtered) - sorted array:", sorted);
            
            // Handle empty data
            if (relationships.length === 0) {
                console.warn("No relationship data for chart");
                return;
            }
            
            // Check if all amounts are zero
            const totalAmount = amounts.reduce((sum, val) => sum + val, 0);
            if (totalAmount === 0) {
                console.warn(" All amounts are zero for selectedAmountType:", selectedAmountType);
                const chartElement = document.querySelector("#relationshipChart");
                if (chartElement) {
                    chartElement.innerHTML = `<div class="flex items-center justify-center h-64 text-gray-500">No ${seriesName} data available</div>`;
                }
                return;
            }

            // Calculate dynamic height based on number of relationships (35px per bar, min 350px)
            const calculatedHeight = Math.max(350, relationships.length * 35);
            
            const options = {
                series: [
                    {
                    name: seriesName,
                        data: amounts,
                    },
                ],
                colors: ["#465fff"],
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "bar",
                    height: calculatedHeight,
                    toolbar: {
                        show: false,
                    },
                    events: {
                        dataPointSelection: function (event, chartContext, config) {
                            const selectedIndex = config.dataPointIndex;
                            const selectedRelationship = relationships[selectedIndex];
                            console.log("Relationship clicked:", selectedRelationship);
                            applyChartFilter(
                                "relationship",
                                selectedRelationship,
                                selectedRelationship
                            );
                        },
                    },
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        borderRadius: 5,
                        borderRadiusApplication: "end",
                    },
                },
                dataLabels: {
                    enabled: false,
                },
                stroke: {
                    show: true,
                    width: 4,
                    colors: ["transparent"],
                },
                xaxis: {
                    categories: relationships,
                    labels: {
                        formatter: function (val) {
                            return formatCurrency(val);
                        },
                    },
                    axisBorder: {
                        show: false,
                    },
                    axisTicks: {
                        show: false,
                    },
                },
                yaxis: {
                    title: false,
                    labels: {
                        style: {
                            fontSize: "12px",
                        },
                    },
                },
                legend: {
                    show: true,
                    position: "top",
                    horizontalAlign: "left",
                    fontFamily: "Outfit",
                    markers: {
                        radius: 99,
                    },
                },
                grid: {
                    yaxis: {
                        lines: {
                            show: false,
                        },
                    },
                },
                fill: {
                    opacity: 1,
                },
                tooltip: {
                    theme: "light",
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        const relName = sorted[dataPointIndex][0]; // Get original name without index
                        const data = relationshipData.get(relName);
                        
                        if (!data) return "";
                        
                        let html = `<div class="apexcharts-tooltip-custom" style="padding: 12px; min-width: 220px; background: #ffffff; color: #1f2937; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border: 1px solid #e5e7eb;">`;
                        html += `<div style="font-weight: 600; margin-bottom: 8px; font-size: 13px; color: #1f2937;">${relName}</div>`;
                        html += `<div style="font-size: 11px; color: #666;">`;
                        html += `<div style="margin-bottom: 4px;"><strong>${data.facilityCount}</strong> Facilities</div>`;
                        html += `<div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #e5e7eb;">`;
                        html += `<div>TFA: ${formatCurrency(data.tfa)}</div>`;
                        html += `<div>Direct: ${formatCurrency(data.direct)}</div>`;
                        if (data.contingent > 0) {
                            html += `<div>Contingent: ${formatCurrency(
                                data.contingent
                            )}</div>`;
                        }
                        if (data.pse > 0) {
                            html += `<div>Presettlement Exposure: ${formatCurrency(
                                data.pse
                            )}</div>`;
                        }
                        html += `</div></div></div>`;
                        return html;
                    },
                },
            };

            // Get the chart element and verify it exists
                const chartElement = document.querySelector("#relationshipChart");
                if (!chartElement) {
                console.error(
                    "Relationship chart element #relationshipChart not found in DOM"
                );
                    return;
                }
                
            // Verify ApexCharts is loaded
            if (typeof ApexCharts === "undefined") {
                console.error("ApexCharts library not loaded");
                return;
            }
            
            try {
                // Destroy previous instance
                if (relationshipChartInstance) {
                    relationshipChartInstance.destroy();
                    relationshipChartInstance = null;
                }
                
                // Clear any previous content to avoid ApexCharts errors
                chartElement.innerHTML = "";
                
                // Create and render new chart
                relationshipChartInstance = new ApexCharts(chartElement, options);
                relationshipChartInstance.render();
                console.log(
                    " Relationship chart rendered successfully with",
                    relationships.length,
                    "relationships"
                );
            } catch (error) {
                console.error(" Error creating relationship chart:", error);
                console.error("Error details:", error.message, error.stack);
            }
        }

        // Helper function to check if any filters are active
        function areFiltersActive() {
            // Check if advanced filters are active
            if (Object.keys(activeFilters).length > 0) return true;
            
            // Check if smart filters are active
            if (selectedRegion !== 'all') return true;
            if (!includePSE) return true;
            if (selectedStatus !== 'all') return true;
            
            // Check if search is active
            const searchTerm = document.getElementById('searchInput')?.value?.trim();
            if (searchTerm && searchTerm.length > 0) return true;
            
            // Check if chart filter is active
            if (chartFilter.active) return true;
            
            return false;
        }

        // Update bar chart
        function updateBarChart() {
            // Debounce to prevent rapid successive calls when switching between Top N values
            if (updateBarChartTimer) {
                clearTimeout(updateBarChartTimer);
            }
            
            updateBarChartTimer = setTimeout(() => {
                console.log(" Updating bar charts (debounced)");
                if (areFiltersActive()) {
                createRelationshipChartFromFiltered();
                createROTCEChartFromFiltered();
            } else {
                createRelationshipChart();
                createROTCEChart();
            }
            }, 100); // 100ms debounce to prevent glitching
        }

        // Filter New Facilities by Period (Current Month or Previous Month)
        function filterNewFacilitiesByPeriod(period) {
            selectedPeriod = period;
            
            // Update button styles to match TailAdmin toggle design
            const currentBtn = document.getElementById("currentMonthBtn");
            const previousBtn = document.getElementById("previousMonthBtn");

            if (period === "current") {
                currentBtn.className =
                    "px-2 py-1 font-medium transition-colors rounded text-xs shadow-xs text-gray-900 bg-white hover:text-gray-900";
                previousBtn.className =
                    "px-2 py-1 font-medium transition-colors rounded text-xs text-gray-500 hover:text-gray-900";
            } else {
                currentBtn.className =
                    "px-2 py-1 font-medium transition-colors rounded text-xs text-gray-500 hover:text-gray-900";
                previousBtn.className =
                    "px-2 py-1 font-medium transition-colors rounded text-xs shadow-xs text-gray-900 bg-white hover:text-gray-900";
            }
            
            // Recreate chart with new period
            if (
                Object.keys(activeFilters).length > 0 ||
                (filteredData.length > 0 &&
                    filteredData.length < portfolioData.length)
            ) {
                createCreditClassificationChartFromFiltered();
            } else {
                createCreditClassificationChart();
            }
        }

        // Create New Facilities Approved in CP by Product Program Donut Chart from all data
        function createCreditClassificationChart() {
            const startTime = performance.now();
            
            console.log(
                "Creating New Facilities Approved in CP by Product Program chart, dataLength:",
                portfolioData.length
            );
            
            // Find the most recent Report_Date to determine "last month"
            let mostRecentReportDate = null;
            for (let i = 0; i < portfolioData.length; i++) {
                const reportDate = parseDate(portfolioData[i].Report_Date);
                if (
                    reportDate &&
                    (!mostRecentReportDate || reportDate > mostRecentReportDate)
                ) {
                    mostRecentReportDate = reportDate;
                }
            }
            
            if (!mostRecentReportDate) {
                console.warn("No valid Report_Date found");
                return;
            }
            
            // Calculate date ranges based on selected period
            let targetStartDate, targetEndDate, periodLabel;
            if (selectedPeriod === "current") {
                // Current month: use the most recent report date's month
                targetStartDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth(),
                    1
                );
                targetStartDate.setHours(0, 0, 0, 0);
                targetEndDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth() + 1,
                    0
                );
                targetEndDate.setHours(23, 59, 59, 999);
                periodLabel = targetStartDate.toLocaleDateString("en-US", {
                    month: "long",
                    year: "numeric",
                });
            } else {
                // Previous month: one month before the most recent report date
                targetStartDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth() - 1,
                    1
                );
                targetStartDate.setHours(0, 0, 0, 0);
                targetEndDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth(),
                    0
                );
                targetEndDate.setHours(23, 59, 59, 999);
                periodLabel = targetStartDate.toLocaleDateString("en-US", {
                    month: "long",
                    year: "numeric",
                });
            }

            console.log("Most recent report date:", mostRecentReportDate);
            console.log("Target period:", periodLabel);
            console.log(
                "Target date range:",
                targetStartDate.toISOString(),
                "to",
                targetEndDate.toISOString()
            );
            console.log("Selected period:", selectedPeriod);
            
            // Track new facilities per product program with amounts
            const productNewFacilities = new Map();
            const productTotalFacilities = new Map();
            const productAmounts = new Map();
            let totalNewCount = 0;
            
            for (let i = 0; i < portfolioData.length; i++) {
                const row = portfolioData[i];
                const productProgram = row.Product_Program || "Unknown";
                const facilityId = row.Facility_ID;
                const firstApprovalDate = parseDate(row.Facility_First_Approval_Date);
                
                if (!facilityId) continue;
                
                // Initialize product program tracking
                if (!productNewFacilities.has(productProgram)) {
                    productNewFacilities.set(productProgram, new Set());
                    productTotalFacilities.set(productProgram, new Set());
                    productAmounts.set(productProgram, {
                        tfa: 0,
                        direct: 0,
                        contingent: 0,
                        pse: 0,
                    });
                }
                
                productTotalFacilities.get(productProgram).add(facilityId);
                
                // Check if facility is "new" (approved within the selected period)
                if (
                    firstApprovalDate &&
                    firstApprovalDate >= targetStartDate &&
                    firstApprovalDate <= targetEndDate
                ) {
                    productNewFacilities.get(productProgram).add(facilityId);
                    totalNewCount++;
                    // Accumulate amounts for new facilities
                    const amounts = productAmounts.get(productProgram);
                    amounts.tfa += parseNumber(row.Facility_Amount);
                    amounts.direct += parseNumber(row.Direct_OS);
                    amounts.contingent += parseNumber(row.Contingent_OS);
                    amounts.pse += parseNumber(row.PSE_OS);
                }
            }
            
            console.log("Product program new facilities:", productNewFacilities);
            console.log(`Found ${totalNewCount} new facilities in ${periodLabel}`);
            
            // Convert to arrays for ApexCharts (only showing new facilities)
            const labels = [];
            const series = [];
            const counts = [];
            
            for (const [
                productProgram,
                newFacilitiesSet,
            ] of productNewFacilities.entries()) {
                const newCount = newFacilitiesSet.size;
                if (newCount > 0) {
                    // Only include product programs with new facilities
                    labels.push(productProgram);
                    series.push(newCount);
                    counts.push(newCount);
                }
            }
            
            // Handle empty data
            if (labels.length === 0) {
                console.warn("No new facilities data available");
                
                // Destroy existing chart instance first
                if (creditClassificationChartInstance) {
                    creditClassificationChartInstance.destroy();
                    creditClassificationChartInstance = null;
                }
                
                const chartElement = document.querySelector(
                    "#creditClassificationChart"
                );
                if (chartElement) {
                    chartElement.innerHTML = `<div class="flex items-center justify-center h-full text-gray-500">No new facilities in ${periodLabel}</div>`;
                }
                // Update chart subtitle even when no data
                const subtitleElement = document.getElementById(
                    "newFacilitiesSubtitle"
                );
                if (subtitleElement) {
                    subtitleElement.textContent = `Facilities first approved in ${periodLabel}`;
                }
                return;
            }
            
            // Calculate total new facilities
            const totalNewFacilities = counts.reduce((a, b) => a + b, 0);
            
            // Define colors matching the TailAdmin style
            const colors = [
                "#3641f5",
                "#7592ff",
                "#dde9ff",
                "#ff6b6b",
                "#ffd93d",
                "#6bcf7f",
                "#c084fc",
            ];
            
            const options = {
                series: series,
                colors: colors.slice(0, labels.length),
                labels: labels,
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "donut",
                    width: 280,
                    height: 280,
                    events: {
                        dataPointSelection: function (event, chartContext, config) {
                            const selectedIndex = config.dataPointIndex;
                            const selectedProduct = labels[selectedIndex];
                            console.log("Product clicked:", selectedProduct);
                            applyChartFilter("product", selectedProduct, selectedProduct);
                        },
                    },
                },
                stroke: {
                    show: false,
                    width: 4,
                    colors: "transparent",
                },
                plotOptions: {
                    pie: {
                        donut: {
                            size: "65%",
                            background: "transparent",
                            labels: {
                                show: true,
                                name: {
                                    show: true,
                                    offsetY: 0,
                                    color: "#1D2939",
                                    fontSize: "12px",
                                    fontWeight: "normal",
                                },
                                value: {
                                    show: true,
                                    offsetY: 10,
                                    color: "#667085",
                                    fontSize: "14px",
                                    formatter: (val) => val.toLocaleString(),
                                },
                                total: {
                                    show: true,
                                    label: "Total New",
                                    color: "#000000",
                                    fontSize: "20px",
                                    fontWeight: "bold",
                                    formatter: () => totalNewFacilities.toLocaleString(),
                                },
                            },
                        },
                    },
                },
                dataLabels: {
                    enabled: false,
                },
                tooltip: {
                    enabled: true,
                    theme: "light",
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        const productProgram = labels[seriesIndex];
                        const count = series[seriesIndex];
                        const amounts = productAmounts.get(productProgram);
                        
                        if (!amounts) return "";
                        
                        let html = `<div class="apexcharts-tooltip-custom" style="padding: 12px; min-width: 200px; background: #ffffff; color: #1f2937; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border: 1px solid #e5e7eb;">`;
                        html += `<div style="font-weight: 600; margin-bottom: 8px; font-size: 13px; color: #1f2937;">${productProgram}</div>`;
                        html += `<div style="font-size: 11px; color: #666;">`;
                        html += `<div style="margin-bottom: 4px;"><strong>${count}</strong> New Facilities</div>`;
                        html += `<div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #e5e7eb;">`;
                        html += `<div>TFA: ${formatCurrency(amounts.tfa)}</div>`;
                        html += `<div>Direct: ${formatCurrency(amounts.direct)}</div>`;
                        if (amounts.contingent > 0) {
                            html += `<div>Contingent: ${formatCurrency(
                                amounts.contingent
                            )}</div>`;
                        }
                        if (amounts.pse > 0) {
                            html += `<div>Presettlement Exposure: ${formatCurrency(
                                amounts.pse
                            )}</div>`;
                        }
                        html += `</div></div></div>`;
                        return html;
                    },
                },
                legend: {
                    show: false,
                },
                responsive: [
                    {
                        breakpoint: 2600,
                        options: {
                            chart: {
                                width: 240,
                                height: 240,
                            },
                        },
                    },
                    {
                        breakpoint: 640,
                        options: {
                            chart: {
                                width: 280,
                                height: 280,
                            },
                        },
                    },
                ],
            };
            
            // Get the chart element and verify it exists
            const chartElement = document.querySelector(
                "#creditClassificationChart"
            );
            if (!chartElement) {
                console.error("Credit classification chart element not found in DOM");
                return;
            }
            
            // Verify ApexCharts is loaded
            if (typeof ApexCharts === "undefined") {
                console.error("ApexCharts library not loaded");
                return;
            }
            
            try {
                // Destroy previous instance
                if (creditClassificationChartInstance) {
                    creditClassificationChartInstance.destroy();
                    creditClassificationChartInstance = null;
                }
                
                // Clear any previous content
                chartElement.innerHTML = "";
                
                // Create and render new chart
                creditClassificationChartInstance = new ApexCharts(
                    chartElement,
                    options
                );
                creditClassificationChartInstance.render();
                
                // Update legend
                updateCreditClassificationLegend(
                    labels,
                    series,
                    counts,
                    totalNewFacilities,
                    colors
                );

                // Update chart subtitle with period
                const subtitleElement = document.getElementById(
                    "newFacilitiesSubtitle"
                );
                if (subtitleElement) {
                    subtitleElement.textContent = `Facilities first approved in ${periodLabel}`;
                }
                
                console.log(
                    " New facilities by region chart rendered successfully"
                );
            } catch (error) {
                console.error(
                    " Error creating credit classification chart:",
                    error
                );
            }
        }

        // Create New Facilities Approved in CP by Product Program Donut Chart from filtered data
        function createCreditClassificationChartFromFiltered() {
            const startTime = performance.now();
            
            console.log(
                "Creating filtered New Facilities Approved in CP by Product Program chart, dataLength:",
                filteredData.length
            );
            
            // Find the most recent Report_Date to determine "last month"
            let mostRecentReportDate = null;
            for (let i = 0; i < filteredData.length; i++) {
                const reportDate = parseDate(filteredData[i].Report_Date);
                if (
                    reportDate &&
                    (!mostRecentReportDate || reportDate > mostRecentReportDate)
                ) {
                    mostRecentReportDate = reportDate;
                }
            }
            
            if (!mostRecentReportDate) {
                console.warn("No valid Report_Date found in filtered data");
                const chartElement = document.querySelector(
                    "#creditClassificationChart"
                );
                if (chartElement) {
                    chartElement.innerHTML =
                        '<div class="flex items-center justify-center h-full text-gray-500">No report date available</div>';
                }
                return;
            }
            
            // Calculate date ranges based on selected period
            let targetStartDate, targetEndDate, periodLabel;
            if (selectedPeriod === "current") {
                // Current month: use the most recent report date's month
                targetStartDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth(),
                    1
                );
                targetStartDate.setHours(0, 0, 0, 0);
                targetEndDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth() + 1,
                    0
                );
                targetEndDate.setHours(23, 59, 59, 999);
                periodLabel = targetStartDate.toLocaleDateString("en-US", {
                    month: "long",
                    year: "numeric",
                });
            } else {
                // Previous month: one month before the most recent report date
                targetStartDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth() - 1,
                    1
                );
                targetStartDate.setHours(0, 0, 0, 0);
                targetEndDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth(),
                    0
                );
                targetEndDate.setHours(23, 59, 59, 999);
                periodLabel = targetStartDate.toLocaleDateString("en-US", {
                    month: "long",
                    year: "numeric",
                });
            }

            console.log(
                "Most recent report date (filtered):",
                mostRecentReportDate
            );
            console.log("Target period (filtered):", periodLabel);
            console.log(
                "Target date range (filtered):",
                targetStartDate.toISOString(),
                "to",
                targetEndDate.toISOString()
            );
            console.log("Selected period:", selectedPeriod);
            
            // Track new facilities per product program with amounts
            const productNewFacilities = new Map();
            const productTotalFacilities = new Map();
            const productAmounts = new Map();
            let totalNewCount = 0;
            
            for (let i = 0; i < filteredData.length; i++) {
                const row = filteredData[i];
                const productProgram = row.Product_Program || "Unknown";
                const facilityId = row.Facility_ID;
                const firstApprovalDate = parseDate(row.Facility_First_Approval_Date);
                
                if (!facilityId) continue;
                
                // Initialize product program tracking
                if (!productNewFacilities.has(productProgram)) {
                    productNewFacilities.set(productProgram, new Set());
                    productTotalFacilities.set(productProgram, new Set());
                    productAmounts.set(productProgram, {
                        tfa: 0,
                        direct: 0,
                        contingent: 0,
                        pse: 0,
                    });
                }
                
                productTotalFacilities.get(productProgram).add(facilityId);
                
                // Check if facility is "new" (approved within the selected period)
                if (
                    firstApprovalDate &&
                    firstApprovalDate >= targetStartDate &&
                    firstApprovalDate <= targetEndDate
                ) {
                    productNewFacilities.get(productProgram).add(facilityId);
                    totalNewCount++;
                    // Accumulate amounts for new facilities
                    const amounts = productAmounts.get(productProgram);
                    amounts.tfa += parseNumber(row.Facility_Amount);
                    amounts.direct += parseNumber(row.Direct_OS);
                    amounts.contingent += parseNumber(row.Contingent_OS);
                    amounts.pse += parseNumber(row.PSE_OS);
                }
            }

            console.log(
                "Product program new facilities (filtered):",
                productNewFacilities
            );
            console.log(
                `Found ${totalNewCount} new facilities in ${periodLabel} (from filtered data)`
            );
            
            // Convert to arrays for ApexCharts (only showing new facilities)
            const labels = [];
            const series = [];
            const counts = [];
            
            for (const [
                productProgram,
                newFacilitiesSet,
            ] of productNewFacilities.entries()) {
                const newCount = newFacilitiesSet.size;
                if (newCount > 0) {
                    // Only include product programs with new facilities
                    labels.push(productProgram);
                    series.push(newCount);
                    counts.push(newCount);
                }
            }
            
            // Handle empty data
            if (labels.length === 0) {
                console.warn("No new facilities data available in filtered dataset");
                
                // Destroy existing chart instance first
                if (creditClassificationChartInstance) {
                    creditClassificationChartInstance.destroy();
                    creditClassificationChartInstance = null;
                }
                
                const chartElement = document.querySelector(
                    "#creditClassificationChart"
                );
                if (chartElement) {
                    chartElement.innerHTML = `<div class="flex items-center justify-center h-full text-gray-500">No new facilities in ${periodLabel}</div>`;
                }
                // Update chart subtitle even when no data
                const subtitleElement = document.getElementById(
                    "newFacilitiesSubtitle"
                );
                if (subtitleElement) {
                    subtitleElement.textContent = `Facilities first approved in ${periodLabel}`;
                }
                return;
            }
            
            // Calculate total new facilities
            const totalNewFacilities = counts.reduce((a, b) => a + b, 0);
            
            // Define colors
            const colors = [
                "#3641f5",
                "#7592ff",
                "#dde9ff",
                "#ff6b6b",
                "#ffd93d",
                "#6bcf7f",
                "#c084fc",
            ];
            
            const options = {
                series: series,
                colors: colors.slice(0, labels.length),
                labels: labels,
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "donut",
                    width: 280,
                    height: 280,
                    events: {
                        dataPointSelection: function (event, chartContext, config) {
                            const selectedIndex = config.dataPointIndex;
                            const selectedProduct = labels[selectedIndex];
                            console.log("Product clicked:", selectedProduct);
                            applyChartFilter("product", selectedProduct, selectedProduct);
                        },
                    },
                },
                stroke: {
                    show: false,
                    width: 4,
                    colors: "transparent",
                },
                plotOptions: {
                    pie: {
                        donut: {
                            size: "65%",
                            background: "transparent",
                            labels: {
                                show: true,
                                name: {
                                    show: true,
                                    offsetY: 0,
                                    color: "#1D2939",
                                    fontSize: "12px",
                                    fontWeight: "normal",
                                },
                                value: {
                                    show: true,
                                    offsetY: 10,
                                    color: "#667085",
                                    fontSize: "14px",
                                    formatter: (val) => val.toLocaleString(),
                                },
                                total: {
                                    show: true,
                                    label: "Total New",
                                    color: "#000000",
                                    fontSize: "20px",
                                    fontWeight: "bold",
                                    formatter: () => totalNewFacilities.toLocaleString(),
                                },
                            },
                        },
                    },
                },
                dataLabels: {
                    enabled: false,
                },
                tooltip: {
                    enabled: true,
                    theme: "light",
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        const productProgram = labels[seriesIndex];
                        const count = series[seriesIndex];
                        const amounts = productAmounts.get(productProgram);
                        
                        if (!amounts) return "";
                        
                        let html = `<div class="apexcharts-tooltip-custom" style="padding: 12px; min-width: 200px; background: #ffffff; color: #1f2937; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border: 1px solid #e5e7eb;">`;
                        html += `<div style="font-weight: 600; margin-bottom: 8px; font-size: 13px; color: #1f2937;">${productProgram}</div>`;
                        html += `<div style="font-size: 11px; color: #666;">`;
                        html += `<div style="margin-bottom: 4px;"><strong>${count}</strong> New Facilities</div>`;
                        html += `<div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #e5e7eb;">`;
                        html += `<div>TFA: ${formatCurrency(amounts.tfa)}</div>`;
                        html += `<div>Direct: ${formatCurrency(amounts.direct)}</div>`;
                        if (amounts.contingent > 0) {
                            html += `<div>Contingent: ${formatCurrency(
                                amounts.contingent
                            )}</div>`;
                        }
                        if (amounts.pse > 0) {
                            html += `<div>Presettlement Exposure: ${formatCurrency(
                                amounts.pse
                            )}</div>`;
                        }
                        html += `</div></div></div>`;
                        return html;
                    },
                },
                legend: {
                    show: false,
                },
                responsive: [
                    {
                        breakpoint: 2600,
                        options: {
                            chart: {
                                width: 240,
                                height: 240,
                            },
                        },
                    },
                    {
                        breakpoint: 640,
                        options: {
                            chart: {
                                width: 280,
                                height: 280,
                            },
                        },
                    },
                ],
            };
            
            const chartElement = document.querySelector(
                "#creditClassificationChart"
            );
            if (!chartElement) {
                console.error("Credit classification chart element not found in DOM");
                return;
            }
            
            if (typeof ApexCharts === "undefined") {
                console.error("ApexCharts library not loaded");
                return;
            }
            
            try {
                if (creditClassificationChartInstance) {
                    creditClassificationChartInstance.destroy();
                    creditClassificationChartInstance = null;
                }
                
                chartElement.innerHTML = "";
                
                creditClassificationChartInstance = new ApexCharts(
                    chartElement,
                    options
                );
                creditClassificationChartInstance.render();
                
                // Update legend
                updateCreditClassificationLegend(
                    labels,
                    series,
                    counts,
                    totalNewFacilities,
                    colors
                );

                // Update chart subtitle with period
                const subtitleElement = document.getElementById(
                    "newFacilitiesSubtitle"
                );
                if (subtitleElement) {
                    subtitleElement.textContent = `Facilities first approved in ${periodLabel}`;
                }
                
                console.log(
                    " New facilities by region chart (filtered) rendered successfully"
                );
            } catch (error) {
                console.error(
                    " Error creating credit classification chart (filtered):",
                    error
                );
            }
        }

        // Update the legend for credit classification chart
        function updateCreditClassificationLegend(
            labels,
            series,
            counts,
            totalAmount,
            colors
        ) {
            const legendElement = document.getElementById(
                "creditClassificationLegend"
            );
            if (!legendElement) return;
            
            let legendHTML = "";
            for (let i = 0; i < labels.length; i++) {
                const percentage = ((series[i] / totalAmount) * 100).toFixed(0);
                const color = colors[i] || "#3641f5";
                
                legendHTML += `
                    <div class="flex items-start gap-2.5">
                        <div class="mt-1.5 h-2 w-2 rounded-full" style="background-color: ${color};"></div>
                        <div>
                            <h5 class="mb-1 font-medium text-gray-800 text-theme-sm">
                                ${labels[i]}
                            </h5>
                            <div class="flex items-center gap-2">
                                <p class="font-medium text-gray-700 text-theme-sm">
                                    ${percentage}%
                                </p>
                                <div class="w-1 h-1 bg-gray-400 rounded-full"></div>
                                <p class="text-gray-500 text-theme-sm">
                                    ${counts[i]} Facilities
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            legendElement.innerHTML = legendHTML;
        }

        // ============================================
        // ROTCE CHART FUNCTIONS
        // ============================================

        // Create ROTCE chart (initial load)
        function createROTCEChart() {
            console.log(" Creating ROTCE Performance chart");
            
            // Get Top N from Top Relationships filter
            const topNRelationships = parseInt(
                document.getElementById("topNFilter").value
            );
            
            // Group ROTCE by relationship
            const rotceByRelationship = new Map();
            const rotceValues = [];
            
            portfolioData.forEach((row) => {
                const relName = row.Relationship_Name || row.Relationship_ID;
                const rotce = parsePercentage(row.ROTCE);
                
                if (relName && !isNaN(rotce)) {
                    if (!rotceByRelationship.has(relName)) {
                        rotceByRelationship.set(relName, []);
                    }
                    rotceByRelationship.get(relName).push(rotce);
                    rotceValues.push(rotce);
                }
            });
            
            // Calculate average ROTCE per relationship
            const relationshipROTCE = [];
            rotceByRelationship.forEach((values, relName) => {
                const average =
                    values.reduce((sum, val) => sum + val, 0) / values.length;
                relationshipROTCE.push({ name: relName, rotce: average });
            });
            
            // Sort by selected amount type from Top Relationships chart to get same top N
            // Get Top Relationships to match their order
            const relationshipData = new Map();
            for (const row of portfolioData) {
                const relId = row.Relationship_Name || row.Relationship_ID;
                if (!relId) continue;
                
                if (!relationshipData.has(relId)) {
                    relationshipData.set(relId, {
                        tfa: 0,
                        direct: 0,
                        contingent: 0,
                        pse: 0,
                        osuc: 0,
                        unused: 0,
                    });
                }
                const data = relationshipData.get(relId);
                data.tfa += parseNumber(row.Fac_Amount || row.Facility_Amount);
                data.direct += parseNumber(row.Direct_OS);
                data.contingent += parseNumber(row.Contingent_OS);
                data.pse += parseNumber(row.PSE_OS);
                data.osuc += parseNumber(row.OSUC);
                data.unused += parseNumber(row.Unused_Committed);
            }

            // Get the selected field value for sorting (sync with Top Relationships chart)
            const relationshipTotals = new Map();
            for (const [relId, data] of relationshipData.entries()) {
                let sortValue = 0;
                switch (selectedAmountType) {
                    case "tfa":
                        sortValue = data.tfa;
                        break;
                    case "direct":
                        sortValue = data.direct;
                        break;
                    case "contingent":
                        sortValue = data.contingent;
                        break;
                    case "pse":
                        sortValue = data.pse;
                        break;
                    case "osuc":
                        sortValue = data.osuc;
                        break;
                    case "unused":
                        sortValue = data.unused;
                        break;
                    default:
                        sortValue = data.direct;
                }
                relationshipTotals.set(relId, sortValue);
            }

            // Get top N relationships by selected exposure type (matching Top Relationships chart)
            const topRelationships = Array.from(relationshipTotals.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, topNRelationships)
                .map((entry) => entry[0]);
            
            // Check if we have any relationships with non-zero values
            const hasValidRelationships = Array.from(relationshipTotals.entries())
                .some(([relId, value]) => value > 0);
            
            console.log("DEBUG ROTCE (non-filtered) - relationshipTotals size:", relationshipTotals.size);
            console.log("DEBUG ROTCE (non-filtered) - hasValidRelationships:", hasValidRelationships);
            console.log("DEBUG ROTCE (non-filtered) - topRelationships length:", topRelationships.length);
            
            // Update subtitle
            const subtitleEl = document.getElementById("rotceSubtitle");
            if (subtitleEl) {
                subtitleEl.textContent = `Top ${topNRelationships} relationships ROTCE performance`;
            }
            
            // If no valid relationships in Top Relationships chart, don't show ROTCE
            if (!hasValidRelationships || topRelationships.length === 0 || relationshipTotals.size === 0) {
                console.log(" No relationships data available - skipping ROTCE chart (non-filtered)");
                const chartElement = document.querySelector("#rotceChart");
                if (chartElement) {
                    chartElement.innerHTML =
                        '<div class="flex items-center justify-center h-full text-gray-500">No data available</div>';
                }
                return;
            }
            
            // Filter and order ROTCE data to match top relationships
            const filteredROTCE = topRelationships
                .map((relName) => relationshipROTCE.find((r) => r.name === relName))
                .filter((r) => r !== undefined);

            // Add index numbers (1, 2, 3, ...) to match Top Relationships chart
            const relationships = filteredROTCE.map(
                (r, index) => `${index + 1}. ${r.name}`
            );
            const avgROTCE = filteredROTCE.map((r) => r.rotce);
            
            // Debug logging for ROTCE
            console.log("DEBUG ROTCE (non-filtered) - selectedAmountType:", selectedAmountType);
            console.log("DEBUG ROTCE (non-filtered) - topRelationships:", topRelationships);
            console.log("DEBUG ROTCE (non-filtered) - relationships:", relationships);
            console.log("DEBUG ROTCE (non-filtered) - avgROTCE:", avgROTCE);
            console.log("DEBUG ROTCE (non-filtered) - filteredROTCE:", filteredROTCE);
            
            // Check if all ROTCE values are zero or NaN
            const validROTCE = avgROTCE.filter(v => !isNaN(v) && v !== 0);
            if (validROTCE.length === 0) {
                console.warn(" No valid ROTCE data for the selected relationships");
                const chartElement = document.querySelector("#rotceChart");
                if (chartElement) {
                    chartElement.innerHTML =
                        '<div class="flex items-center justify-center h-full text-gray-500">No ROTCE data available for these relationships</div>';
                }
                return;
            }
            
            // Conditional colors: red if < 12%, green if >= 12%
            const barColors = avgROTCE.map((rotce) =>
                rotce < 12 ? "#ef4444" : "#10b981"
            );
            
            // Calculate dynamic height
            const calculatedHeight = Math.max(350, relationships.length * 35);
            
            // Create horizontal bar chart
            const chartOptions = {
                series: [
                    {
                        name: "Average ROTCE",
                        data: avgROTCE,
                    },
                ],
                chart: {
                    type: "bar",
                    height: calculatedHeight,
                    toolbar: { show: false },
                    fontFamily: "Outfit, sans-serif",
                },
                colors: barColors,
                plotOptions: {
                    bar: {
                        horizontal: true,
                        columnWidth: "70%",
                        borderRadius: 4,
                        distributed: true, // Enable individual bar colors
                        dataLabels: {
                            position: "center",
                        },
                    },
                },
                dataLabels: {
                    enabled: true,
                    formatter: function (val) {
                        return val.toFixed(1) + "%";
                    },
                    style: {
                        fontSize: "11px",
                        colors: ["#fff"],
                        fontWeight: "bold",
                    },
                },
                annotations: {
                    xaxis: [
                        {
                        x: 12,
                            borderColor: "#f59e0b",
                        strokeDashArray: 8,
                        label: {
                                borderColor: "#f59e0b",
                            style: {
                                    color: "#fff",
                                    background: "#f59e0b",
                                    fontSize: "11px",
                                    fontWeight: "bold",
                                },
                                text: "Target: 12%",
                            },
                        },
                    ],
                },
                xaxis: {
                    categories: relationships,
                    title: {
                        text: "ROTCE (%)",
                        style: {
                            color: "#6B7280",
                            fontSize: "12px",
                        },
                    },
                    labels: {
                        formatter: function (val) {
                            return val.toFixed(0) + "%";
                        },
                        style: {
                            colors: "#6B7280",
                            fontSize: "11px",
                        },
                    },
                },
                yaxis: {
                    labels: {
                        style: {
                            colors: relationships.map(() => "#6B7280"),
                            fontSize: "11px",
                        },
                        maxWidth: 200,
                    },
                },
                grid: {
                    borderColor: "#E5E7EB",
                    xaxis: { lines: { show: true } },
                    yaxis: { lines: { show: false } },
                },
                legend: {
                    show: false,
                },
                tooltip: {
                    theme: "light",
                    style: {
                        fontSize: "12px",
                        fontFamily: "Outfit, sans-serif",
                    },
                    y: {
                        formatter: function (val) {
                            const color = val < 12 ? "Below target" : "Above target";
                            return val.toFixed(2) + "% - " + color;
                        },
                    },
                },
            };

            // Destroy existing chart instance properly
            if (rotceChartInstance) {
                try {
                    rotceChartInstance.destroy();
                } catch (e) {
                    console.log("Error destroying ROTCE chart:", e);
                }
                rotceChartInstance = null;
            }
            
            const chartElement = document.querySelector("#rotceChart");
            if (chartElement) {
                chartElement.innerHTML = "";
            }

            if (relationships.length === 0) {
                chartElement.innerHTML =
                    '<div class="flex items-center justify-center h-full text-gray-500">No ROTCE data available</div>';
                return;
            }

            // Create and store the chart instance
            rotceChartInstance = new ApexCharts(chartElement, chartOptions);
            rotceChartInstance.render();
        }

        // Create ROTCE chart from filtered data
        function createROTCEChartFromFiltered() {
            console.log(" Creating filtered ROTCE Performance chart");

            // Get Top N from Top Relationships filter (synced)
            const topN = parseInt(document.getElementById("topNFilter").value);
            
            // Group ROTCE by relationship from filtered data
            const rotceByRelationship = new Map();
            const rotceValues = [];
            
            const dataSource =
                filteredData.length > 0 ? filteredData : portfolioData;
            
            dataSource.forEach((row) => {
                const relName = row.Relationship_Name || row.Relationship_ID;
                const rotce = parsePercentage(row.ROTCE);
                
                if (relName && !isNaN(rotce)) {
                    if (!rotceByRelationship.has(relName)) {
                        rotceByRelationship.set(relName, []);
                    }
                    rotceByRelationship.get(relName).push(rotce);
                    rotceValues.push(rotce);
                }
            });
            
            // Calculate average ROTCE per relationship
            const relationshipROTCE = [];
            rotceByRelationship.forEach((values, relName) => {
                const average =
                    values.reduce((sum, val) => sum + val, 0) / values.length;
                relationshipROTCE.push({ name: relName, rotce: average });
            });
            
            // Get Top Relationships to match their order
            const relationshipData = new Map();
            for (const row of dataSource) {
                const relId = row.Relationship_Name || row.Relationship_ID;
                if (!relId) continue;
                
                if (!relationshipData.has(relId)) {
                    relationshipData.set(relId, {
                        tfa: 0,
                        direct: 0,
                        contingent: 0,
                        pse: 0,
                        osuc: 0,
                        unused: 0,
                    });
                }
                const data = relationshipData.get(relId);
                data.tfa += parseNumber(row.Fac_Amount || row.Facility_Amount);
                data.direct += parseNumber(row.Direct_OS);
                data.contingent += parseNumber(row.Contingent_OS);
                data.pse += parseNumber(row.PSE_OS);
                data.osuc += parseNumber(row.OSUC);
                data.unused += parseNumber(row.Unused_Committed);
            }

            // Get the selected field value for sorting (sync with Top Relationships chart)
            const relationshipTotals = new Map();
            for (const [relId, data] of relationshipData.entries()) {
                let sortValue = 0;
                switch (selectedAmountType) {
                    case "tfa":
                        sortValue = data.tfa;
                        break;
                    case "direct":
                        sortValue = data.direct;
                        break;
                    case "contingent":
                        sortValue = data.contingent;
                        break;
                    case "pse":
                        sortValue = data.pse;
                        break;
                    case "osuc":
                        sortValue = data.osuc;
                        break;
                    case "unused":
                        sortValue = data.unused;
                        break;
                    default:
                        sortValue = data.direct;
                }
                relationshipTotals.set(relId, sortValue);
            }

            // Get top N relationships by selected exposure type (matching Top Relationships chart)
            const topRelationships = Array.from(relationshipTotals.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, topN)
                .map((entry) => entry[0]);
            
            // Check if we have any relationships with non-zero values
            const hasValidRelationships = Array.from(relationshipTotals.entries())
                .some(([relId, value]) => value > 0);
            
            console.log("DEBUG ROTCE - relationshipTotals size:", relationshipTotals.size);
            console.log("DEBUG ROTCE - hasValidRelationships:", hasValidRelationships);
            console.log("DEBUG ROTCE - topRelationships length:", topRelationships.length);
            
            // Destroy existing chart instance properly
            if (rotceChartInstance) {
                try {
                    rotceChartInstance.destroy();
                } catch (e) {
                    console.log("Error destroying ROTCE chart:", e);
                }
                rotceChartInstance = null;
            }
            
            const chartElement = document.querySelector("#rotceChart");
            if (chartElement) {
                chartElement.innerHTML = "";
            }
            
            // Update subtitle
            const subtitleEl = document.getElementById("rotceSubtitle");
            if (subtitleEl) {
                subtitleEl.textContent = `Top ${topN} relationships ROTCE performance`;
            }
            
            // If no valid relationships in Top Relationships chart, don't show ROTCE
            if (!hasValidRelationships || topRelationships.length === 0 || relationshipTotals.size === 0) {
                console.log(" No relationships data available - skipping ROTCE chart (filtered)");
                if (chartElement) {
                    chartElement.innerHTML =
                        '<div class="flex items-center justify-center h-full text-gray-500">No data available for the selected filters</div>';
                }
                return;
            }
            
            // Filter and order ROTCE data to match top relationships
            const filteredROTCE = topRelationships
                .map((relName) => relationshipROTCE.find((r) => r.name === relName))
                .filter((r) => r !== undefined);

            // Add index numbers (1, 2, 3, ...) to match Top Relationships chart
            const relationships = filteredROTCE.map(
                (r, index) => `${index + 1}. ${r.name}`
            );
            const avgROTCE = filteredROTCE.map((r) => r.rotce);
            
            // Debug logging for ROTCE
            console.log("DEBUG ROTCE (filtered) - selectedAmountType:", selectedAmountType);
            console.log("DEBUG ROTCE (filtered) - topRelationships:", topRelationships);
            console.log("DEBUG ROTCE (filtered) - relationships:", relationships);
            console.log("DEBUG ROTCE (filtered) - avgROTCE:", avgROTCE);
            console.log("DEBUG ROTCE (filtered) - filteredROTCE:", filteredROTCE);
            
            if (relationships.length === 0) {
                chartElement.innerHTML =
                    '<div class="flex items-center justify-center h-full text-gray-500">No ROTCE data available</div>';
                return;
            }
            
            // Check if all ROTCE values are zero or NaN
            const validROTCE = avgROTCE.filter(v => !isNaN(v) && v !== 0);
            if (validROTCE.length === 0) {
                console.warn(" No valid ROTCE data for the selected relationships");
                chartElement.innerHTML =
                    '<div class="flex items-center justify-center h-full text-gray-500">No ROTCE data available for these relationships</div>';
                return;
            }
            
            // Conditional colors: red if < 12%, green if >= 12%
            const barColors = avgROTCE.map((rotce) =>
                rotce < 12 ? "#ef4444" : "#10b981"
            );
            
            // Calculate dynamic height
            const calculatedHeight = Math.max(350, relationships.length * 35);
            
            // Create horizontal bar chart
            const chartOptions = {
                series: [
                    {
                        name: "Average ROTCE",
                        data: avgROTCE,
                    },
                ],
                chart: {
                    type: "bar",
                    height: calculatedHeight,
                    toolbar: { show: false },
                    fontFamily: "Outfit, sans-serif",
                },
                colors: barColors,
                plotOptions: {
                    bar: {
                        horizontal: true,
                        columnWidth: "70%",
                        borderRadius: 4,
                        distributed: true, // Enable individual bar colors
                        dataLabels: {
                            position: "center",
                        },
                    },
                },
                dataLabels: {
                    enabled: true,
                    formatter: function (val) {
                        return val.toFixed(1) + "%";
                    },
                    style: {
                        fontSize: "11px",
                        colors: ["#fff"],
                        fontWeight: "bold",
                    },
                },
                annotations: {
                    xaxis: [
                        {
                        x: 12,
                            borderColor: "#f59e0b",
                        strokeDashArray: 8,
                        label: {
                                borderColor: "#f59e0b",
                            style: {
                                    color: "#fff",
                                    background: "#f59e0b",
                                    fontSize: "11px",
                                    fontWeight: "bold",
                                },
                                text: "Target: 12%",
                            },
                        },
                    ],
                },
                xaxis: {
                    categories: relationships,
                    title: {
                        text: "ROTCE (%)",
                        style: {
                            color: "#6B7280",
                            fontSize: "12px",
                        },
                    },
                    labels: {
                        formatter: function (val) {
                            return val.toFixed(0) + "%";
                        },
                        style: {
                            colors: "#6B7280",
                            fontSize: "11px",
                        },
                    },
                },
                yaxis: {
                    labels: {
                        style: {
                            colors: relationships.map(() => "#6B7280"),
                            fontSize: "11px",
                        },
                        maxWidth: 200,
                    },
                },
                grid: {
                    borderColor: "#E5E7EB",
                    xaxis: { lines: { show: true } },
                    yaxis: { lines: { show: false } },
                },
                legend: {
                    show: false,
                },
                tooltip: {
                    theme: "light",
                    style: {
                        fontSize: "12px",
                        fontFamily: "Outfit, sans-serif",
                    },
                    y: {
                        formatter: function (val) {
                            const color = val < 12 ? "Below target" : "Above target";
                            return val.toFixed(2) + "% - " + color;
                        },
                    },
                },
            };
            
            // Create and store the chart instance
            rotceChartInstance = new ApexCharts(chartElement, chartOptions);
            rotceChartInstance.render();
        }

        // Filter data based on search (works with existing filters)
        function filterData() {
            const startTime = performance.now();
            
            // Check if any smart filters are active
            const smartFiltersActive =
                selectedRegion !== "all" || !includePSE || selectedStatus !== "all";
            
            // If no filters are active (neither advanced nor smart filters), just apply search to all data
            if (Object.keys(activeFilters).length === 0 && !smartFiltersActive) {
                const searchTerm = document
                    .getElementById("searchInput")
                    .value.toLowerCase();
                
                if (searchTerm === "") {
                    filteredData = [...portfolioData];
                    
                    // No search term, show all data - update charts to show full data
                    requestAnimationFrame(() => {
                        createFacilityTrendChart();
                        createRelationshipChart();
                        createCreditClassificationChart();
                        createROTCEChart();
                    });
                } else {
                    // Optimized search
                    filteredData = [];
                    for (let i = 0; i < portfolioData.length; i++) {
                        const row = portfolioData[i];
                        let found = false;
                        for (const value of Object.values(row)) {
                            if (String(value).toLowerCase().includes(searchTerm)) {
                                found = true;
                                break;
                            }
                        }
                        if (found) filteredData.push(row);
                    }
                    
                    // Search term is active, update charts with filtered data
                    requestAnimationFrame(() => {
                        calculateMetricsFromFiltered();
                        createFacilityTrendChartFromFiltered();
                        createRelationshipChartFromFiltered();
                        createCreditClassificationChartFromFiltered();
                        createROTCEChartFromFiltered();
                    });
                }
                
                const elapsed = (performance.now() - startTime).toFixed(0);
                const perfEl = document.getElementById("perfIndicator");
                if (perfEl) {
                    perfEl.textContent = `(${elapsed}ms)`;
                    perfEl.className =
                        elapsed < 100
                            ? "text-green-600 font-medium"
                            : "text-orange-600 font-medium";
                }
                
                currentPage = 1;
                renderTable();
            } else {
                // If filters are active, reapply them (which will include search)
                applyFilters();
            }
        }

        // Render table (optimized for large datasets)
        function renderTable() {
            const tbody = document.getElementById("tableBody");
            
            // Determine which data source to use
            const hasActiveFilters = Object.keys(activeFilters).length > 0 || 
                                     selectedRegion !== "all" || 
                                     !includePSE || 
                                     selectedStatus !== "all" ||
                                     document.getElementById("searchInput").value.trim() !== "";
            
            const dataSource = hasActiveFilters ? filteredData : portfolioData;
            
            const startIdx = (currentPage - 1) * rowsPerPage;
            const endIdx = startIdx + rowsPerPage;
            const pageData = dataSource.slice(startIdx, endIdx);
            
            // Use requestAnimationFrame for smooth rendering
            requestAnimationFrame(() => {
                // Use DocumentFragment for batch DOM insertion (much faster)
                const fragment = document.createDocumentFragment();
                
                pageData.forEach((row) => {
                    const tr = document.createElement("tr");
                    tr.className = "hover:bg-gray-50";
                    tr.innerHTML = `
                        <td class="p-4 text-sm text-gray-700 whitespace-nowrap">${formatDate(
                        row.Report_Date
                    )}</td>
                        <td class="p-4 text-sm text-gray-700 whitespace-nowrap">${row.Region || "N/A"
                        }</td>
                        <td class="p-4 text-sm font-medium text-gray-800 whitespace-nowrap">${row.Facility_ID || "N/A"
                        }</td>
                        <td class="p-4 text-sm text-gray-700">${row.Relationship_Name || "N/A"
                        }</td>
                        <td class="p-4 text-sm text-gray-700">${row.Product_Program || "N/A"
                        }</td>
                        <td class="p-4 text-sm font-medium text-gray-800 whitespace-nowrap">${formatCurrencyDetailed(
                            parseNumber(row.Fac_Amount)
                        )}</td>
                        <td class="p-4 text-sm text-gray-700 whitespace-nowrap">${formatCurrencyDetailed(
                            parseNumber(row.Direct_OS)
                        )}</td>
                        <td class="p-4 text-sm text-gray-700 whitespace-nowrap">${formatDate(
                            row.Maturity_Date
                        )}</td>
                        <td class="p-4 text-sm text-gray-700 whitespace-nowrap">${formatDate(
                            row.CA_Expiration_Date
                        )}</td>
                    `;
                    fragment.appendChild(tr);
                });
                
                // Single DOM operation instead of multiple
                tbody.innerHTML = "";
                tbody.appendChild(fragment);
                updatePagination();
            });
        }

        // Update pagination
        function updatePagination() {
            // Determine which data source to use
            const hasActiveFilters = Object.keys(activeFilters).length > 0 || 
                                     selectedRegion !== "all" || 
                                     !includePSE || 
                                     selectedStatus !== "all" ||
                                     document.getElementById("searchInput").value.trim() !== "";
            
            const dataSource = hasActiveFilters ? filteredData : portfolioData;
            
            const totalPages = Math.ceil(dataSource.length / rowsPerPage);
            const startRow = (currentPage - 1) * rowsPerPage + 1;
            const endRow = Math.min(currentPage * rowsPerPage, dataSource.length);
            
            document.getElementById("startRow").textContent =
                dataSource.length > 0 ? startRow : 0;
            document.getElementById("endRow").textContent = endRow;
            document.getElementById("totalRows").textContent = dataSource.length;
            document.getElementById("currentPage").textContent = currentPage;
            document.getElementById("totalPages").textContent = totalPages;

            document.getElementById("prevBtn").disabled = currentPage === 1;
            document.getElementById("nextBtn").disabled =
                currentPage === totalPages || totalPages === 0;
        }

        // Pagination functions
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        }

        function nextPage() {
            // Determine which data source to use
            const hasActiveFilters = Object.keys(activeFilters).length > 0 || 
                                     selectedRegion !== "all" || 
                                     !includePSE || 
                                     selectedStatus !== "all" ||
                                     document.getElementById("searchInput").value.trim() !== "";
            
            const dataSource = hasActiveFilters ? filteredData : portfolioData;
            const totalPages = Math.ceil(dataSource.length / rowsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        }

        // Alpine.js Portfolio Table Component
        function portfolioTable() {
            return {
                statusFilter: "all",
                sort: { key: "relationship", asc: true },
                page: 1,
                perPage: 20,
                dataVersion: 0, // Used to trigger reactivity when data changes

                init() {
                    // Watch for data changes every second
                    setInterval(() => {
                        if (
                            portfolioData &&
                            portfolioData.length > 0 &&
                            this.dataVersion === 0
                        ) {
                            this.dataVersion++;
                        }
                    }, 1000);
                    
                    // Store reference to this component for external refresh
                    window.portfolioTableComponent = this;
                },
                
                refresh() {
                    // Manually trigger table refresh by incrementing dataVersion
                    this.dataVersion++;
                },

                get rows() {
                    // Convert filteredData to table rows with status calculation
                    // Use filteredData if available, otherwise use portfolioData
                    // Access dataVersion to make this reactive
                    const _ = this.dataVersion;
                    
                    const dataSource =
                        filteredData && filteredData.length > 0
                            ? filteredData
                            : portfolioData;
                    
                    if (!dataSource || dataSource.length === 0) {
                        console.log(
                            "Portfolio Table: No data available. portfolioData length:",
                            portfolioData?.length,
                            "filteredData length:",
                            filteredData?.length
                        );
                        return [];
                    }
                    
                    console.log(
                        "Portfolio Table: Rendering",
                        dataSource.length,
                        "rows"
                    );
                    
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const threeMonthsFromNow = new Date(today);
                    threeMonthsFromNow.setMonth(threeMonthsFromNow.getMonth() + 3);

                    return dataSource.map((row, index) => {
                        const maturityDate = parseDate(row.Maturity_Date);
                        let status = "Active";

                        if (maturityDate) {
                            if (maturityDate < today) {
                                status = "Expired";
                            } else if (maturityDate <= threeMonthsFromNow) {
                                status = "Expiring Soon";
                            }
                        }

                        return {
                            id: index,
                            facilityId: row.Facility_ID || "N/A",
                            relationship:
                                row.Relationship_Name || row.Relationship_ID || "N/A",
                            region: row.Region || "N/A",
                            product: row.Product_Program || "N/A",
                            facilityAmount: formatCurrency(
                                parseNumber(row.Fac_Amount || row.Facility_Amount)
                            ),
                            directOS: formatCurrency(parseNumber(row.Direct_OS)),
                            maturityDate: row.Maturity_Date || "N/A",
                            status: status,
                            // Keep original data for sorting
                            _facilityAmount: parseNumber(
                                row.Fac_Amount || row.Facility_Amount
                            ),
                            _maturityDate: maturityDate,
                        };
                    });
                },

                get filteredRows() {
                    let result = this.rows;

                    // Apply status filter
                    if (this.statusFilter !== "all") {
                        const filterMap = {
                            active: "Active",
                            expiring: "Expiring Soon",
                            expired: "Expired",
                        };
                        result = result.filter(
                            (row) => row.status === filterMap[this.statusFilter]
                        );
                    }

                    return result;
                },

                get sortedRows() {
                    return this.filteredRows.slice().sort((a, b) => {
                        let valA, valB;

                        switch (this.sort.key) {
                            case "amount":
                                valA = a._facilityAmount;
                                valB = b._facilityAmount;
                                break;
                            case "maturity":
                                valA = a._maturityDate ? a._maturityDate.getTime() : 0;
                                valB = b._maturityDate ? b._maturityDate.getTime() : 0;
                                break;
                            default:
                                valA = a[this.sort.key];
                                valB = b[this.sort.key];
                                if (typeof valA === "string") valA = valA.toLowerCase();
                                if (typeof valB === "string") valB = valB.toLowerCase();
                        }

                        if (valA < valB) return this.sort.asc ? -1 : 1;
                        if (valA > valB) return this.sort.asc ? 1 : -1;
                        return 0;
                    });
                },

                get totalPages() {
                    return Math.ceil(this.sortedRows.length / this.perPage) || 1;
                },

                get paginatedRows() {
                    const start = (this.page - 1) * this.perPage;
                    const end = start + this.perPage;
                    return this.sortedRows.slice(start, end);
                },

                get startEntry() {
                    return this.sortedRows.length === 0
                        ? 0
                        : (this.page - 1) * this.perPage + 1;
                },

                get endEntry() {
                    const end = this.page * this.perPage;
                    return end > this.sortedRows.length ? this.sortedRows.length : end;
                },

                get totalRows() {
                    return this.sortedRows.length;
                },

                get displayedRowsCount() {
                    return this.sortedRows.length.toLocaleString();
                },

                get displayPages() {
                    // Show max 7 page numbers
                    const maxPages = 7;
                    const pages = [];

                    if (this.totalPages <= maxPages) {
                        for (let i = 1; i <= this.totalPages; i++) {
                            pages.push(i);
                        }
                    } else {
                        if (this.page <= 4) {
                            for (let i = 1; i <= 5; i++) pages.push(i);
                            pages.push("...");
                            pages.push(this.totalPages);
                        } else if (this.page >= this.totalPages - 3) {
                            pages.push(1);
                            pages.push("...");
                            for (let i = this.totalPages - 4; i <= this.totalPages; i++)
                                pages.push(i);
                        } else {
                            pages.push(1);
                            pages.push("...");
                            for (let i = this.page - 1; i <= this.page + 1; i++)
                                pages.push(i);
                            pages.push("...");
                            pages.push(this.totalPages);
                        }
                    }

                    return pages.filter((p) => typeof p === "number");
                },

                sortBy(key) {
                    if (this.sort.key === key) {
                        this.sort.asc = !this.sort.asc;
                    } else {
                        this.sort.key = key;
                        this.sort.asc = true;
                    }
                    this.page = 1;
                },

                goToPage(n) {
                    if (n >= 1 && n <= this.totalPages) this.page = n;
                },

                applyTableFilters() {
                    this.page = 1; // Reset to first page on filter change
                },

                exportToXLSX() {
                    if (this.sortedRows.length === 0) {
                        alert("No data to export");
                        return;
                    }

                    // Check if XLSX library is loaded
                    if (typeof XLSX === "undefined") {
                        alert(
                            "Export library not loaded. Please refresh the page and try again."
                        );
                        return;
                    }

                    // Prepare data for export
                    const exportData = this.sortedRows.map((row) => ({
                        "Facility ID": row.facilityId,
                        Relationship: row.relationship,
                        Region: row.region,
                        Product: row.product,
                        "Facility Amount": row.facilityAmount,
                        "Direct OS": row.directOS,
                        "Maturity Date": row.maturityDate,
                        Status: row.status,
                    }));

                    // Create workbook and worksheet
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(exportData);

                    // Set column widths
                    ws["!cols"] = [
                        { wch: 15 }, // Facility ID
                        { wch: 30 }, // Relationship
                        { wch: 10 }, // Region
                        { wch: 25 }, // Product
                        { wch: 15 }, // Facility Amount
                        { wch: 15 }, // Direct OS
                        { wch: 12 }, // Maturity Date
                        { wch: 12 }, // Status
                    ];

                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(wb, ws, "Portfolio Details");

                    // Generate filename with current date and status filter
                    const dateStr = new Date().toISOString().split("T")[0];
                    const statusStr =
                        this.statusFilter !== "all" ? `_${this.statusFilter}` : "";
                    const filename = `Wealth_Lending_Portfolio${statusStr}_${dateStr}.xlsx`;

                    // Download file
                    XLSX.writeFile(wb, filename);
                },
            };
        }

        // ========================================
        // CHART DATA VIEWER MODAL FUNCTIONS
        // ========================================

        // Open chart data modal with specific dataset
        function openChartDataModal(chartType) {
            const modal = document.getElementById("chartDataModal");
            const modalTitle = document.getElementById("chartDataModalTitle");
            const modalSubtitle = document.getElementById("chartDataModalSubtitle");
            const tableHeader = document.getElementById("chartDataTableHeader");
            const tableBody = document.getElementById("chartDataTableBody");

            // Determine which data to show
            let data = [];
            let chartName = "";

            switch (chartType) {
                case "expiring":
                    chartName = "CAs & Facilities Expiring";
                    data = getExpiringData();
                    break;
                case "newFacilities":
                    chartName = "New Facilities Approved in CP by Product Program";
                    data = getNewFacilitiesData();
                    break;
                case "topRelationships":
                    chartName = "Top Relationships by " + getExposureTypeName();
                    data = getTopRelationshipsData();
                    break;
                case "rotce":
                    chartName = "ROTCE Performance";
                    data = filteredData.length > 0 ? filteredData : portfolioData;
                    break;
                case "newDealsYTD":
                    chartName = "New Deals Closed YTD";
                    data = getNewDealsYTDData();
                    break;
                case "newDealsMTD":
                    chartName = "New Deals Closed MTD";
                    data = getNewDealsMTDData();
                    break;
                default:
                    data = filteredData.length > 0 ? filteredData : portfolioData;
            }

            // Update modal title
            modalTitle.textContent = chartName + " - Underlying Data";
            modalSubtitle.textContent = `Showing ${data.length} records${filteredData.length > 0 ? " (filtered)" : ""
                }`;

            // Store data and chart name for export
            window.currentChartData = { data, chartName };

            // Build table
            buildDataTable(data, tableHeader, tableBody);

            // Show modal
            modal.classList.remove("hidden");
            document.body.style.overflow = "hidden";
        }

        // Close chart data modal
        function closeChartDataModal() {
            const modal = document.getElementById("chartDataModal");
            modal.classList.add("hidden");
            document.body.style.overflow = "auto";
        }

        // Get exposure type name
        function getExposureTypeName() {
            const names = {
                direct: "Direct OS",
                contingent: "Contingent OS",
                pse: "PSE OS",
                osuc: "OSUC",
                unused: "Undrawn Commitment",
                tfa: "Total Facility Amount",
            };
            return names[selectedAmountType] || "Direct OS";
        }

        // Get expiring data (CAs & Facilities expiring in next 3 months)
        function getExpiringData() {
            const dataSource =
                filteredData.length > 0 ? filteredData : portfolioData;
            console.log("getExpiringData - dataSource length:", dataSource.length);
            const today = new Date();
            const threeMonthsLater = new Date(
                today.getTime() + 90 * 24 * 60 * 60 * 1000
            );

            const result = dataSource.filter((row) => {
                const caExpiry = parseDate(row.CA_Expiration_Date);
                const maturityDate = parseDate(row.Maturity_Date);

                const caExpiring =
                    caExpiry && caExpiry >= today && caExpiry <= threeMonthsLater;
                const facilityExpiring =
                    maturityDate &&
                    maturityDate >= today &&
                    maturityDate <= threeMonthsLater;

                return caExpiring || facilityExpiring;
            });
            
            console.log("getExpiringData - filtered result length:", result.length);
            return result;
        }

        // Get new facilities data (based on selected period)
        function getNewFacilitiesData() {
            const dataSource =
                filteredData.length > 0 ? filteredData : portfolioData;
            console.log(
                "getNewFacilitiesData - dataSource length:",
                dataSource.length,
                "selectedPeriod:",
                selectedPeriod
            );
            const reportDates = dataSource
                .map((row) => parseDate(row.Report_Date))
                .filter((d) => d);
            if (reportDates.length === 0) {
                console.log("getNewFacilitiesData - No report dates found");
                return [];
            }

            const mostRecentReportDate = new Date(Math.max(...reportDates));

            let targetStartDate, targetEndDate;
            if (selectedPeriod === "current") {
                targetStartDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth(),
                    1
                );
                targetStartDate.setHours(0, 0, 0, 0);
                targetEndDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth() + 1,
                    0
                );
                targetEndDate.setHours(23, 59, 59, 999);
            } else {
                targetStartDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth() - 1,
                    1
                );
                targetStartDate.setHours(0, 0, 0, 0);
                targetEndDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth(),
                    0
                );
                targetEndDate.setHours(23, 59, 59, 999);
            }

            const result = dataSource.filter((row) => {
                const firstApprovalDate = parseDate(row.Facility_First_Approval_Date);
                return (
                    firstApprovalDate &&
                    firstApprovalDate >= targetStartDate &&
                    firstApprovalDate <= targetEndDate
                );
            });

            console.log(
                "getNewFacilitiesData - filtered result length:",
                result.length
            );
            return result;
        }

        // Get top relationships data
        function getTopRelationshipsData() {
            const dataSource =
                filteredData.length > 0 ? filteredData : portfolioData;
            const topN = parseInt(document.getElementById("topNFilter").value);
            console.log(
                "getTopRelationshipsData - dataSource length:",
                dataSource.length,
                "topN:",
                topN,
                "selectedAmountType:",
                selectedAmountType
            );

            // Aggregate by relationship
            const relationshipData = new Map();
            for (const row of dataSource) {
                const relId = row.Relationship_Name || row.Relationship_ID;
                if (!relId) continue;

                if (!relationshipData.has(relId)) {
                    relationshipData.set(relId, []);
                }
                relationshipData.get(relId).push(row);
            }

            // Calculate totals for sorting
            const relationshipTotals = new Map();
            for (const [relId, rows] of relationshipData.entries()) {
                let total = 0;
                for (const row of rows) {
                    switch (selectedAmountType) {
                        case "tfa":
                            total += parseNumber(row.Facility_Amount);
                            break;
                        case "direct":
                            total += parseNumber(row.Direct_OS);
                            break;
                        case "contingent":
                            total += parseNumber(row.Contingent_OS);
                            break;
                        case "pse":
                            total += parseNumber(row.PSE_OS);
                            break;
                        case "osuc":
                            total += parseNumber(row.OSUC);
                            break;
                        case "unused":
                            total += parseNumber(row.Unused_Committed);
                            break;
                        default:
                            total += parseNumber(row.Direct_OS);
                    }
                }
                relationshipTotals.set(relId, total);
            }

            // Get top N relationships
            const topRelationships = Array.from(relationshipTotals.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, topN)
                .map(([relId]) => relId);

            // Return all rows for top relationships
            const result = dataSource.filter((row) => {
                const relId = row.Relationship_Name || row.Relationship_ID;
                return topRelationships.includes(relId);
            });
            
            console.log(
                "getTopRelationshipsData - filtered result length:",
                result.length
            );
            return result;
        }

        // Get New Deals YTD data
        function getNewDealsYTDData() {
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
            const now = new Date();
            const currentYear = now.getFullYear();
            const yearStartDate = new Date(currentYear, 0, 1);
            yearStartDate.setHours(0, 0, 0, 0);

            // Get unique facilities with origination date in current year
            const facilitiesSet = new Set();
            const result = dataSource.filter((row) => {
                const originationDate = parseDate(row.Origination_Date);
                const facilityId = row.Facility_ID || row.Facility_Name;
                
                if (originationDate && originationDate >= yearStartDate && originationDate <= now && facilityId) {
                    if (!facilitiesSet.has(facilityId)) {
                        facilitiesSet.add(facilityId);
                        return true;
                    }
                }
                return false;
            });

            console.log("getNewDealsYTDData - filtered result length:", result.length);
            return result;
        }

        // Get New Deals MTD data
        function getNewDealsMTDData() {
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
            const now = new Date();
            const monthStartDate = new Date(now.getFullYear(), now.getMonth(), 1);
            monthStartDate.setHours(0, 0, 0, 0);

            // Get unique facilities with origination date in current month
            const facilitiesSet = new Set();
            const result = dataSource.filter((row) => {
                const originationDate = parseDate(row.Origination_Date);
                const facilityId = row.Facility_ID || row.Facility_Name;
                
                if (originationDate && originationDate >= monthStartDate && originationDate <= now && facilityId) {
                    if (!facilitiesSet.has(facilityId)) {
                        facilitiesSet.add(facilityId);
                        return true;
                    }
                }
                return false;
            });

            console.log("getNewDealsMTDData - filtered result length:", result.length);
            return result;
        }

        // Build data table dynamically
        function buildDataTable(data, tableHeader, tableBody) {
            if (data.length === 0) {
                tableHeader.innerHTML = "";
                tableBody.innerHTML =
                    '<tr><td colspan="100" class="text-center py-8 text-gray-500">No data available</td></tr>';
                return;
            }

            // Get all columns from first row
            const columns = Object.keys(data[0]);

            // Build header
            tableHeader.innerHTML = columns
                .map(
                    (col) =>
                        `<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50 sticky top-0">${col.replace(
                            /_/g,
                            " "
                        )}</th>`
                )
                .join("");

            // Build body (limit to first 500 rows for performance)
            const displayData = data.slice(0, 500);
            tableBody.innerHTML = displayData
                .map(
                    (row, idx) =>
                        `<tr class="${idx % 2 === 0 ? "bg-white" : "bg-gray-50"
                        } hover:bg-blue-50">
                    ${columns
                            .map((col) => {
                    const value = row[col];
                    const formattedValue = formatCellValue(col, value);
                    return `<td class="px-4 py-3 text-sm text-gray-700 whitespace-nowrap">${formattedValue}</td>`;
                            })
                            .join("")}
                </tr>`
                )
                .join("");

            // Show warning if data was truncated
            if (data.length > 500) {
                tableBody.innerHTML += `<tr><td colspan="${columns.length}" class="px-4 py-3 text-center text-sm text-orange-600 bg-orange-50">
                    Showing first 500 of ${data.length} records. Export to see all data.
                </td></tr>`;
            }
        }

        // Format cell value based on column name
        function formatCellValue(column, value) {
            if (value === null || value === undefined || value === "") return "-";

            const col = column.toLowerCase();

            // Format currency columns
            if (
                col.includes("amount") ||
                col.includes("_os") ||
                col.includes("osuc") ||
                col.includes("committed")
            ) {
                const num = parseNumber(value);
                if (!isNaN(num) && num !== 0) {
                    return formatCurrency(num);
                }
            }

            // Format date columns
            if (col.includes("date")) {
                const date = parseDate(value);
                if (date) {
                    return formatDate(date);
                }
            }

            // Format percentage columns
            if (col.includes("rate") || col.includes("percent")) {
                const num = parseFloat(value);
                if (!isNaN(num)) {
                    return num.toFixed(2) + "%";
                }
            }

            return String(value);
        }

        // Open methodology modal with chart-specific information
        function openMethodologyModal(chartType) {
            const modalTitle = document.getElementById("methodologyModalTitle");
            const modalContent = document.getElementById("methodologyModalContent");
            const modal = document.getElementById("methodologyModal");

            // Define methodology content for each chart
            const methodologies = {
                expiring: {
                    title: "CAs & Facilities Expiring - Methodology",
                    content: `
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">What This Chart Shows:</h5>
                                </div>
                                <p class="text-gray-600">Tracks Credit Agreements (CAs) and Facilities that are expiring within the next 3 months, plus expired items from the current reporting month.</p>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Calculation Logic:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong>CAs Expiring:</strong> Count unique CA_IDs where CA_Expiration_Date is within 90 days from today (excludes DM)</li>
                                    <li><strong>Facilities Expiring:</strong> Count Facility_IDs where Maturity_Date is within 90 days from today</li>
                                    <li><strong>CAs Expired:</strong> Count unique CA_IDs where CA_Expiration_Date fell within the current reporting month (excludes DM)</li>
                                    <li><strong>Facilities Expired:</strong> Count Facility_IDs where Maturity_Date fell within the current reporting month</li>
                                    <li><strong>Amounts:</strong> Sum of Fac_Amount for respective CAs/facilities</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Key Columns Used:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><code class="bg-gray-100 px-1 rounded">CA_Expiration_Date</code> - For CA expiration tracking</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Maturity_Date</code> - For facility expiration tracking</li>
                                    <li><code class="bg-gray-100 px-1 rounded">CA_ID</code> - Unique CA identifier</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Facility_ID</code> - Unique facility identifier</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Fac_Amount</code> - Facility amount for value calculations</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Management_Status</code> - To exclude DM status</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Report_Date</code> - Current reporting month reference</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Filters Applied:</h5>
                                </div>
                                <p class="text-gray-600">Respects all active filters (Region, Status, Product Program, etc.) to show only relevant expirations and expired items.</p>
                            </div>
                        </div>
                    `,
                },
                newFacilities: {
                    title:
                        "New Facilities Approved in CP by Product Program - Methodology",
                    content: `
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">What This Chart Shows:</h5>
                                </div>
                                <p class="text-gray-600">Distribution of newly approved facilities by Product Program for the selected reporting period.</p>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Calculation Logic:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong>Current Period:</strong> Facilities where Facility_First_Approval_Date falls within the current reporting month (1st to last day)</li>
                                    <li><strong>Previous Period:</strong> Facilities where Facility_First_Approval_Date falls within the previous month</li>
                                    <li><strong>Grouping:</strong> Aggregated by Product_Program</li>
                                    <li><strong>Count:</strong> Number of unique facilities per product program</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Key Columns Used:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><code class="bg-gray-100 px-1 rounded">Facility_First_Approval_Date</code> - Determines if facility is "new"</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Report_Date</code> - Identifies the current reporting month</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Product_Program</code> - Groups facilities by product type</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Facility_ID</code> - Counts unique new facilities</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Time Period:</h5>
                                </div>
                                <p class="text-gray-600">Captures entire month from 00:00:00 on 1st day to 23:59:59 on last day. Toggle between "Current" and "Previous" month using the period selector.</p>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Filters Applied:</h5>
                                </div>
                                <p class="text-gray-600">Respects all active filters to show new facilities within the selected criteria.</p>
                            </div>
                        </div>
                    `,
                },
                topRelationships: {
                    title: "Top Relationships - Methodology",
                    content: `
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">What This Chart Shows:</h5>
                                </div>
                                <p class="text-gray-600">Top N client relationships ranked by selected exposure metric (Direct OS, Contingent, Presettlement Exposure, OSUC, Undrawn, or TFA).</p>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Calculation Logic:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong>Aggregation:</strong> Sum all facility amounts per relationship</li>
                                    <li><strong>Ranking:</strong> Sort relationships by total exposure (highest to lowest)</li>
                                    <li><strong>Top N:</strong> Display top 10, 20, 50, or 100 relationships (configurable)</li>
                                    <li><strong>Dynamic Metric:</strong> Changes based on selected exposure type</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Key Columns Used:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><code class="bg-gray-100 px-1 rounded">Relationship_Name / Relationship_ID</code> - Groups by client</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Direct_OS</code> - Direct outstanding balance</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Contingent_OS</code> - Contingent outstanding balance</li>
                                    <li><code class="bg-gray-100 px-1 rounded">PSE_OS</code> - Presettlement Exposure outstanding balance</li>
                                    <li><code class="bg-gray-100 px-1 rounded">OSUC</code> - Outstanding under commitment (calculated from Fac_Amount - Direct_OS - Contingent_OS - PSE_OS for committed facilities)</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Unused_Committed</code> - Undrawn commitment (calculated from Fac_Amount - Direct_OS - Contingent_OS - PSE_OS for committed facilities)</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Facility_Amount</code> - Total facility amount</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Committed/Uncommitted</code> - Determines if OSUC and Unused_Committed are calculated or set to $0</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Exposure Types:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong>Direct:</strong> Direct outstanding balance</li>
                                    <li><strong>Contingent:</strong> Contingent liabilities</li>
                                    <li><strong>PSE:</strong> Presettlement Exposure</li>
                                    <li><strong>OSUC<sup class="text-blue-600">*</sup>:</strong> Outstanding Undrawn Committed - Calculated based on Committed/Uncommitted column. If "Committed", OSUC = Fac_Amount - (Direct_OS + Contingent_OS + PSE_OS); else 0</li>
                                    <li><strong>Undrawn<sup class="text-blue-600">*</sup>:</strong> Unused commitment - Calculated based on Committed/Uncommitted column. If "Committed", Unused_Committed = Fac_Amount - (Direct_OS + Contingent_OS + PSE_OS); else 0</li>
                                    <li><strong>TFA:</strong> Total Facility Amount (Total committed facility amounts)</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Filters Applied:</h5>
                                </div>
                                <p class="text-gray-600">Respects all active filters. The exposure type filter ONLY affects this chart.</p>
                            </div>
                        </div>
                    `,
                },
                rotce: {
                    title: "ROTCE Performance - Methodology",
                    content: `
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">What This Chart Shows:</h5>
                                </div>
                                <p class="text-gray-600">Return on Tangible Common Equity (ROTCE) performance for the Top N relationships. Shows average ROTCE percentage for each relationship with color-coded indicators (red = below 12%, green = 12% or above). This chart is synchronized with the Top Relationships chart and displays the same relationships.</p>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Calculation Logic:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong>Relationship Matching:</strong> Identifies the same Top N relationships as shown in the Top Relationships chart (based on Direct OS)</li>
                                    <li><strong>ROTCE Grouping:</strong> Groups all ROTCE values by relationship name</li>
                                    <li><strong>Average ROTCE:</strong> Calculates arithmetic mean of all ROTCE values for each relationship</li>
                                    <li><strong>Color Coding:</strong> Applies red color to bars where ROTCE < 12% (below target) and green color where ROTCE  12% (above target)</li>
                                    <li><strong>12% Threshold Line:</strong> Displays a vertical orange dashed line at 12% ROTCE with "Target: 12%" label to clearly indicate the performance benchmark</li>
                                    <li><strong>Horizontal Bar Chart:</strong> Displays relationships as horizontal bars for easy comparison</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Key Columns Used:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><code class="bg-gray-100 px-1 rounded">ROTCE</code> - Return on Tangible Common Equity percentage</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Relationship_Name / Relationship_ID</code> - Client relationship identifier</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Direct_OS</code> - Used to determine Top N relationships for matching</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Filters Applied:</h5>
                                </div>
                                <p class="text-gray-600">Respects all active filters. ROTCE calculations update dynamically based on filtered data. The Top N filter controls how many relationships to display (10, 20, 50, or 100) and is synchronized with the Top Relationships chart.</p>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Color Indicators:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong class="text-red-600">Red:</strong> ROTCE below 12% (below target performance)</li>
                                    <li><strong class="text-green-600">Green:</strong> ROTCE 12% or above (meets or exceeds target performance)</li>
                                </ul>
                            </div>
                        </div>
                    `,
                },
                newDealsYTD: {
                    title: "New Deals Closed YTD - Methodology",
                    content: `
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">What This Metric Shows:</h5>
                                </div>
                                <p class="text-gray-600">Tracks the count and total amount of new deals (unique facilities) that were closed year-to-date. A deal is considered "closed" if it has an Origination_Date within the current year (from January 1st to today).</p>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Calculation Logic:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong>Time Period:</strong> January 1st of current year through today</li>
                                    <li><strong>Count:</strong> Number of unique facilities (by Facility_ID) with Origination_Date in this period</li>
                                    <li><strong>Amount:</strong> Sum of Facility_Amount (TFA) for these facilities</li>
                                    <li><strong>Variance:</strong> Compares current YTD to prior YTD (same period last year) as a percentage change</li>
                                    <li><strong>Color Coding:</strong> Green with up arrow = positive growth, Red with down arrow = negative growth</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Key Columns Used:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><code class="bg-gray-100 px-1 rounded">Origination_Date</code> - Determines when deal was closed</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Facility_ID</code> - Ensures unique facility count</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Facility_Amount</code> - Total facility amount (TFA)</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Filters Applied:</h5>
                                </div>
                                <p class="text-gray-600">Respects all active filters to show new deals within the selected criteria.</p>
                            </div>
                        </div>
                    `,
                },
                newDealsMTD: {
                    title: "New Deals Closed MTD - Methodology",
                    content: `
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">What This Metric Shows:</h5>
                                </div>
                                <p class="text-gray-600">Tracks the count and total amount of new deals (unique facilities) that were closed month-to-date. A deal is considered "closed" if it has an Origination_Date within the current month (from 1st of the month to today).</p>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Calculation Logic:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong>Time Period:</strong> 1st of current month through today</li>
                                    <li><strong>Count:</strong> Number of unique facilities (by Facility_ID) with Origination_Date in this period</li>
                                    <li><strong>Amount:</strong> Sum of Facility_Amount (TFA) for these facilities</li>
                                    <li><strong>Variance:</strong> Compares current MTD to prior MTD (same period last month) as a percentage change</li>
                                    <li><strong>Color Coding:</strong> Green with up arrow = positive growth, Red with down arrow = negative growth</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Key Columns Used:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><code class="bg-gray-100 px-1 rounded">Origination_Date</code> - Determines when deal was closed</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Facility_ID</code> - Ensures unique facility count</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Facility_Amount</code> - Total facility amount (TFA)</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Filters Applied:</h5>
                                </div>
                                <p class="text-gray-600">Respects all active filters to show new deals within the selected criteria.</p>
                            </div>
                        </div>
                    `,
                },
            };

            // Get methodology content for the chart type
            const methodology = methodologies[chartType] || {
                title: "Chart Methodology",
                content:
                    '<p class="text-gray-600">Methodology information not available.</p>',
            };

            // Update modal content
            modalTitle.textContent = methodology.title;
            modalContent.innerHTML = methodology.content;

            // Show modal
            const modalEl = document.getElementById("methodologyModal");
            if (modalEl) {
                modalEl.classList.remove("hidden");
                modalEl.classList.add("flex");
                document.body.style.overflow = "hidden";
            }
        }

        // Close methodology modal
        function closeMethodologyModal() {
            const modalEl = document.getElementById("methodologyModal");
            if (modalEl) {
                modalEl.classList.add("hidden");
                modalEl.classList.remove("flex");
                document.body.style.overflow = "auto";
            }
        }

        // Export data from the modal (when modal is open)
        function exportModalData() {
            if (
                !window.currentChartData ||
                !window.currentChartData.data ||
                window.currentChartData.data.length === 0
            ) {
                alert("No data available to export");
                return;
            }

            // Check if XLSX library is loaded
            if (typeof XLSX === "undefined") {
                alert(
                    "Export library not loaded. Please refresh the page and try again."
                );
                return;
            }

            const data = window.currentChartData.data;
            const chartName = window.currentChartData.chartName;

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, "Data");

            // Generate filename with chart name and date
            const dateStr = new Date().toISOString().split("T")[0];
            const filename = `${chartName}_${dateStr}.xlsx`;

            // Download file
            XLSX.writeFile(wb, filename);
        }

        // Export chart data to XLSX
        function exportChartData(chartType) {
            // Check if data is loaded
            if (!portfolioData || portfolioData.length === 0) {
                alert("No data available. Please ensure the data is loaded first.");
                return;
            }

            // Check if XLSX library is loaded
            if (typeof XLSX === "undefined") {
                alert(
                    "Export library not loaded. Please refresh the page and try again."
                );
                return;
            }

            // Get data based on chart type
            let data = [];
            let chartName = "";

            switch (chartType) {
                case "expiring":
                    chartName = "CAs_Facilities_Expiring";
                    data = getExpiringData();
                    break;
                case "newFacilities":
                    chartName = "New_Facilities_by_Product_Program";
                    data = getNewFacilitiesData();
                    break;
                case "topRelationships":
                    chartName =
                        "Top_Relationships_by_" + selectedAmountType.toUpperCase();
                    data = getTopRelationshipsData();
                    break;
                case "rotce":
                    chartName = "ROTCE_Performance";
                    data = filteredData.length > 0 ? filteredData : portfolioData;
                    break;
                case "newDealsYTD":
                    chartName = "New_Deals_Closed_YTD";
                    data = getNewDealsYTDData();
                    break;
                case "newDealsMTD":
                    chartName = "New_Deals_Closed_MTD";
                    data = getNewDealsMTDData();
                    break;
            }

            console.log(
                "Export chart data:",
                chartType,
                "Records found:",
                data ? data.length : 0
            );

            if (!data || data.length === 0) {
                alert(
                    "No data to export for this chart. Please check your filters or ensure data matches the chart criteria."
                );
                return;
            }

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, "Data");

            // Generate filename with chart name and date
            const dateStr = new Date().toISOString().split("T")[0];
            const filename = `${chartName}_${dateStr}.xlsx`;

            // Download file
            XLSX.writeFile(wb, filename);
        }
    </script>
</body>

</html>
