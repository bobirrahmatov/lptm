<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Analytics Lending</title>
    <!-- Alpine.js for reactive components -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- SheetJS for Excel/CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jsVectorMap for world map -->
    <link rel="stylesheet" href="https://unpkg.com/jsvectormap@1.5.3/dist/css/jsvectormap.min.css">
    <script src="https://unpkg.com/jsvectormap@1.5.3/dist/js/jsvectormap.min.js"></script>
    <script src="https://unpkg.com/jsvectormap@1.5.3/dist/maps/world.js"></script>
    <!-- html2canvas for PNG export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Custom scrollbar styles */
        .custom-scrollbar::-webkit-scrollbar {
            height: 6px;
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-[10000] flex items-center justify-center hidden">
        <div class="bg-white rounded-2xl p-8 shadow-2xl flex flex-col items-center gap-4 max-w-sm mx-4">
            <div class="relative">
                <div class="w-16 h-16 border-4 border-gray-200 border-t-blue-600 rounded-full animate-spin"></div>
            </div>
            <div class="text-center">
                <h3 class="text-lg font-semibold text-gray-900 mb-1">Loading Portfolio Data</h3>
                <p class="text-sm text-gray-500" id="loadingMessage">Please wait while we fetch your data...</p>
                <p class="text-xs text-gray-400 mt-2" id="loadingProgress"></p>
            </div>
        </div>
    </div>

    <div class="p-4 md:p-6">
        <!-- Page Header -->
        <div class="mb-6 rounded-2xl border border-gray-200 bg-white p-5">
            <!-- Top Row: Search and Report Date -->
            <div class="flex items-center justify-between gap-4 mb-5">
                <!-- Search Input -->
                <div class="flex-1 max-w-2xl">
                    <div class="relative">
                        <span class="pointer-events-none absolute top-1/2 left-4 -translate-y-1/2">
                            <svg class="fill-gray-500" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M3.04199 9.37381C3.04199 5.87712 5.87735 3.04218 9.37533 3.04218C12.8733 3.04218 15.7087 5.87712 15.7087 9.37381C15.7087 12.8705 12.8733 15.7055 9.37533 15.7055C5.87735 15.7055 3.04199 12.8705 3.04199 9.37381ZM9.37533 1.54218C5.04926 1.54218 1.54199 5.04835 1.54199 9.37381C1.54199 13.6993 5.04926 17.2055 9.37533 17.2055C11.2676 17.2055 13.0032 16.5346 14.3572 15.4178L17.1773 18.2381C17.4702 18.531 17.945 18.5311 18.2379 18.2382C18.5308 17.9453 18.5309 17.4704 18.238 17.1775L15.4182 14.3575C16.5367 13.0035 17.2087 11.2671 17.2087 9.37381C17.2087 5.04835 13.7014 1.54218 9.37533 1.54218Z" fill=""></path>
                            </svg>
                        </span>
                        <input type="text" id="searchInput" placeholder="Search facilities, relationships, or any data..." 
                            class="h-11 w-full rounded-lg border border-gray-300 bg-white py-3 pr-4 pl-12 text-sm text-gray-800 placeholder:text-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 focus:outline-none shadow-sm">
                    </div>
                </div>
                
                <!-- Report Date - Subtle -->
                <div class="text-right">
                    <p class="text-xs text-gray-400 font-medium">Last Updated</p>
                    <p class="text-sm font-semibold text-gray-600" id="reportDate">--</p>
                </div>
            </div>
            
            <!-- Filters and Actions Row -->
            <div class="flex flex-wrap items-center gap-4">
                <!-- Region Tabs -->
                <div class="flex items-center gap-2">
                    <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Region:</span>
                    <div class="inline-flex items-center gap-0.5 rounded-lg bg-gray-100 p-0.5">
                        <button id="btnRegionAll" onclick="selectRegionFilter('all')" 
                            class="min-w-[50px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white">
                            All
                        </button>
                        <button id="btnRegionAPAC" onclick="selectRegionFilter('APAC')" 
                            class="min-w-[50px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            APAC
                        </button>
                        <button id="btnRegionEMEA" onclick="selectRegionFilter('EMEA')" 
                            class="min-w-[50px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            EMEA
                        </button>
                        <button id="btnRegionLATAM" onclick="selectRegionFilter('LATAM')" 
                            class="min-w-[60px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            LATAM
                        </button>
                        <button id="btnRegionNAM" onclick="selectRegionFilter('NAM')" 
                            class="min-w-[50px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            NAM
                        </button>
                    </div>
                </div>

                <!-- Divider -->
                <div class="h-8 w-px bg-gray-300"></div>

                <!-- Status Filter -->
                <div class="flex items-center gap-2">
                    <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Status:</span>
                    <div class="inline-flex items-center gap-0.5 rounded-lg bg-gray-100 p-0.5">
                        <button id="btnStatusAll" onclick="selectStatusFilter('all')" 
                            class="min-w-[45px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white">
                            All
                        </button>
                        <button id="btnStatusCM" onclick="selectStatusFilter('CM')" 
                            class="min-w-[45px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            CM
                        </button>
                        <button id="btnStatusDM" onclick="selectStatusFilter('DM')" 
                            class="min-w-[45px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            DM
                        </button>
                    </div>
                </div>

                <!-- Divider -->
                <div class="h-8 w-px bg-gray-300"></div>

                <!-- PSE Toggle -->
                <div x-data="{ pseToggle: true }" class="flex items-center gap-2">
                    <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">PSE:</span>
                    <label for="pseToggle" class="flex cursor-pointer items-center gap-2 select-none">
                        <span class="text-xs font-medium" :class="!pseToggle ? 'text-gray-900' : 'text-gray-500'">Exclude</span>
                        <div class="relative">
                            <input type="checkbox" id="pseToggle" class="sr-only" 
                                @change="pseToggle = !pseToggle; togglePSE(pseToggle)" checked />
                            <div class="block h-5 w-9 rounded-full transition-colors"
                                :class="pseToggle ? 'bg-blue-600' : 'bg-gray-300'"></div>
                            <div :class="pseToggle ? 'translate-x-4' : 'translate-x-0'"
                                class="absolute top-0.5 left-0.5 h-4 w-4 rounded-full bg-white shadow-sm duration-200 ease-in-out"></div>
                        </div>
                        <span class="text-xs font-medium" :class="pseToggle ? 'text-gray-900' : 'text-gray-500'">Include</span>
                    </label>
                </div>

                <!-- Divider -->
                <div class="h-8 w-px bg-gray-300"></div>

                <!-- Metrics By Amount Type Filter -->
                <div class="flex items-center gap-2">
                    <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Amount:</span>
                    <div class="inline-flex items-center gap-0.5 rounded-lg bg-gray-100 p-0.5">
                        <button id="btnAmountOSUC" onclick="selectAmountTypeFilter('osuc')" 
                            class="min-w-[60px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white">
                            OSUC
                        </button>
                        <button id="btnAmountFacility" onclick="selectAmountTypeFilter('facility')" 
                            class="min-w-[60px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            Facility
                        </button>
                    </div>
                </div>

                <!-- Spacer to push buttons to right -->
                <div class="flex-1"></div>

                <!-- Action Buttons -->
                <div class="flex items-center gap-2">
                    <button onclick="toggleFilterPopover()" id="filterButton"
                        class="relative flex items-center gap-1.5 rounded-lg border border-gray-300 bg-white px-3 py-2 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                        </svg>
                        <span>More</span>
                        <span id="filterCount" class="hidden absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-blue-500 text-[10px] font-bold text-white"></span>
                    </button>
                    
                    <button onclick="resetAllFilters()" 
                        class="flex items-center gap-1.5 rounded-lg border border-gray-300 bg-white px-3 py-2 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <span>Reset</span>
                    </button>

                    <!-- Export Dropdown -->
                    <div x-data="{ exportOpen: false }" class="relative">
                        <button @click="exportOpen = !exportOpen" @click.away="exportOpen = false"
                            class="flex items-center gap-1.5 rounded-lg bg-blue-600 hover:bg-blue-700 px-3 py-2 text-xs font-medium text-white transition-colors">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <span>Export</span>
                            <svg class="w-3 h-3 transition-transform" :class="exportOpen ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        
                        <!-- Dropdown Menu -->
                        <div x-show="exportOpen" 
                            x-transition:enter="transition ease-out duration-100"
                            x-transition:enter-start="opacity-0 scale-95"
                            x-transition:enter-end="opacity-100 scale-100"
                            x-transition:leave="transition ease-in duration-75"
                            x-transition:leave-start="opacity-100 scale-100"
                            x-transition:leave-end="opacity-0 scale-95"
                            class="absolute right-0 mt-2 w-44 rounded-lg border border-gray-200 bg-white shadow-xl z-10"
                            style="display: none;">
                            <div class="py-1">
                                <button onclick="exportToExcel()" class="flex w-full items-center gap-2.5 px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 transition-colors">
                                    <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <span class="font-medium">Excel (.xlsx)</span>
                                </button>
                                <button onclick="exportToPDF()" class="flex w-full items-center gap-2.5 px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 transition-colors">
                                    <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <span class="font-medium">PDF (.pdf)</span>
                                </button>
                                <button onclick="exportToPPT()" class="flex w-full items-center gap-2.5 px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 transition-colors">
                                    <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <span class="font-medium">PowerPoint (.pptx)</span>
                                </button>
                                <button onclick="exportToPNG()" class="flex w-full items-center gap-2.5 px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 transition-colors">
                                    <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <span class="font-medium">Image (.png)</span>
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Active Filters Badges -->
            <div id="activeFiltersBadges" class="flex flex-wrap gap-2 mt-4 pt-4 border-t border-gray-200" style="display: none;">
                <!-- Badges will be dynamically added here -->
            </div>
        </div>

        <!-- Advanced Filters Modal -->
        <div id="filterPopover" class="hidden fixed inset-0 flex items-center justify-center p-5 overflow-y-auto z-[9999]">
            <!-- Backdrop -->
            <div class="fixed inset-0 h-full w-full bg-gray-400/50 backdrop-blur-[32px]" onclick="toggleFilterPopover()"></div>
            
            <!-- Modal Content -->
            <div class="relative w-full max-w-[900px] rounded-3xl bg-white p-6 shadow-xl lg:p-10">
                <!-- Close Button -->
                <button onclick="toggleFilterPopover()"
                    class="absolute right-3 top-3 z-999 flex h-9.5 w-9.5 items-center justify-center rounded-full bg-gray-100 text-gray-400 transition-colors hover:bg-gray-200 hover:text-gray-700 sm:right-6 sm:top-6 sm:h-11 sm:w-11">
                    <svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M6.04289 16.5413C5.65237 16.9318 5.65237 17.565 6.04289 17.9555C6.43342 18.346 7.06658 18.346 7.45711 17.9555L11.9987 13.4139L16.5408 17.956C16.9313 18.3466 17.5645 18.3466 17.955 17.956C18.3455 17.5655 18.3455 16.9323 17.955 16.5418L13.4129 11.9997L17.955 7.4576C18.3455 7.06707 18.3455 6.43391 17.955 6.04338C17.5645 5.65286 16.9313 5.65286 16.5408 6.04338L11.9987 10.5855L7.45711 6.0439C7.06658 5.65338 6.43342 5.65338 6.04289 6.0439C5.65237 6.43442 5.65237 7.06759 6.04289 7.45811L10.5845 11.9997L6.04289 16.5413Z" fill="" />
                    </svg>
                </button>

                <div>
                    <!-- Header -->
                    <h4 class="font-semibold text-gray-800 mb-2 text-title-sm">
                        Advanced Filters
                    </h4>
                    <p class="text-sm leading-6 text-gray-500 mb-7">
                        Refine your portfolio view with detailed filter criteria
                    </p>

                    <!-- Filter Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <!-- Product Program Filter -->
                        <div x-data="{ isOptionSelected: false }">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Product Program
                            </label>
                            <div class="relative z-20 bg-transparent">
                                <select id="filterProductProgram"
                                    class="shadow-theme-xs focus:border-blue-300 focus:ring-blue-500/10 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-11 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden"
                                    :class="isOptionSelected && 'text-gray-800'"
                                    @change="isOptionSelected = true">
                                    <option value="" class="text-gray-700">All Programs</option>
                                </select>
                                <span class="pointer-events-none absolute top-1/2 right-4 z-30 -translate-y-1/2 text-gray-500">
                                    <svg class="stroke-current" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4.79175 7.396L10.0001 12.6043L15.2084 7.396" stroke="" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </span>
                            </div>
                        </div>

                        <!-- Extending Unit Filter -->
                        <div x-data="{ isOptionSelected: false }">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Extending Unit
                            </label>
                            <div class="relative z-20 bg-transparent">
                                <select id="filterExtendingUnit"
                                    class="shadow-theme-xs focus:border-blue-300 focus:ring-blue-500/10 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-11 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden"
                                    :class="isOptionSelected && 'text-gray-800'"
                                    @change="isOptionSelected = true">
                                    <option value="" class="text-gray-700">All Units</option>
                                </select>
                                <span class="pointer-events-none absolute top-1/2 right-4 z-30 -translate-y-1/2 text-gray-500">
                                    <svg class="stroke-current" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4.79175 7.396L10.0001 12.6043L15.2084 7.396" stroke="" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </span>
                            </div>
                        </div>

                        <!-- Facility Type Filter -->
                        <div x-data="{ isOptionSelected: false }">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Facility Type
                            </label>
                            <div class="relative z-20 bg-transparent">
                                <select id="filterFacilityType"
                                    class="shadow-theme-xs focus:border-blue-300 focus:ring-blue-500/10 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-11 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden"
                                    :class="isOptionSelected && 'text-gray-800'"
                                    @change="isOptionSelected = true">
                                    <option value="" class="text-gray-700">All Types</option>
                                </select>
                                <span class="pointer-events-none absolute top-1/2 right-4 z-30 -translate-y-1/2 text-gray-500">
                                    <svg class="stroke-current" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4.79175 7.396L10.0001 12.6043L15.2084 7.396" stroke="" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </span>
                            </div>
                        </div>

                        <!-- Commitment Status Filter -->
                        <div x-data="{ isOptionSelected: false }">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Commitment Status
                            </label>
                            <div class="relative z-20 bg-transparent">
                                <select id="filterCommitment"
                                    class="shadow-theme-xs focus:border-blue-300 focus:ring-blue-500/10 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-11 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden"
                                    :class="isOptionSelected && 'text-gray-800'"
                                    @change="isOptionSelected = true">
                                    <option value="" class="text-gray-700">All</option>
                                </select>
                                <span class="pointer-events-none absolute top-1/2 right-4 z-30 -translate-y-1/2 text-gray-500">
                                    <svg class="stroke-current" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4.79175 7.396L10.0001 12.6043L15.2084 7.396" stroke="" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </span>
                            </div>
                        </div>

                        <!-- Team Lead Filter -->
                        <div x-data="{ isOptionSelected: false }">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Team Lead
                            </label>
                            <div class="relative z-20 bg-transparent">
                                <select id="filterTeamLead"
                                    class="shadow-theme-xs focus:border-blue-300 focus:ring-blue-500/10 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-11 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden"
                                    :class="isOptionSelected && 'text-gray-800'"
                                    @change="isOptionSelected = true">
                                    <option value="" class="text-gray-700">All Team Leads</option>
                                </select>
                                <span class="pointer-events-none absolute top-1/2 right-4 z-30 -translate-y-1/2 text-gray-500">
                                    <svg class="stroke-current" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4.79175 7.396L10.0001 12.6043L15.2084 7.396" stroke="" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </span>
                            </div>
                        </div>

                        <!-- Underwriter Filter -->
                        <div x-data="{ isOptionSelected: false }">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Underwriter
                            </label>
                            <div class="relative z-20 bg-transparent">
                                <select id="filterUnderwriter"
                                    class="shadow-theme-xs focus:border-blue-300 focus:ring-blue-500/10 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-11 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden"
                                    :class="isOptionSelected && 'text-gray-800'"
                                    @change="isOptionSelected = true">
                                    <option value="" class="text-gray-700">All Underwriters</option>
                                </select>
                                <span class="pointer-events-none absolute top-1/2 right-4 z-30 -translate-y-1/2 text-gray-500">
                                    <svg class="stroke-current" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4.79175 7.396L10.0001 12.6043L15.2084 7.396" stroke="" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </span>
                            </div>
                        </div>

                        <!-- CA Maturity Filter -->
                        <div x-data="{ isOptionSelected: false }">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                CAs Maturing
                            </label>
                            <div class="relative z-20 bg-transparent">
                                <select id="filterCAMaturity"
                                    class="shadow-theme-xs focus:border-blue-300 focus:ring-blue-500/10 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-11 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden"
                                    :class="isOptionSelected && 'text-gray-800'"
                                    @change="isOptionSelected = true">
                                    <option value="" class="text-gray-700">All Dates</option>
                                    <option value="30" class="text-gray-700">Next 30 Days</option>
                                    <option value="60" class="text-gray-700">Next 60 Days</option>
                                    <option value="90" class="text-gray-700">Next 90 Days</option>
                                    <option value="180" class="text-gray-700">Next 6 Months</option>
                                    <option value="365" class="text-gray-700">Next Year</option>
                                </select>
                                <span class="pointer-events-none absolute top-1/2 right-4 z-30 -translate-y-1/2 text-gray-500">
                                    <svg class="stroke-current" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4.79175 7.396L10.0001 12.6043L15.2084 7.396" stroke="" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </span>
                            </div>
                        </div>

                        <!-- Facility Maturity Filter -->
                        <div x-data="{ isOptionSelected: false }">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Facilities Maturing
                            </label>
                            <div class="relative z-20 bg-transparent">
                                <select id="filterFacilityMaturity"
                                    class="shadow-theme-xs focus:border-blue-300 focus:ring-blue-500/10 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-11 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden"
                                    :class="isOptionSelected && 'text-gray-800'"
                                    @change="isOptionSelected = true">
                                    <option value="" class="text-gray-700">All Dates</option>
                                    <option value="30" class="text-gray-700">Next 30 Days</option>
                                    <option value="60" class="text-gray-700">Next 60 Days</option>
                                    <option value="90" class="text-gray-700">Next 90 Days</option>
                                    <option value="180" class="text-gray-700">Next 6 Months</option>
                                    <option value="365" class="text-gray-700">Next Year</option>
                                </select>
                                <span class="pointer-events-none absolute top-1/2 right-4 z-30 -translate-y-1/2 text-gray-500">
                                    <svg class="stroke-current" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4.79175 7.396L10.0001 12.6043L15.2084 7.396" stroke="" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex items-center justify-between w-full gap-3">
                        <button onclick="clearAllFilters()" type="button"
                            class="text-sm font-medium text-gray-600 hover:text-gray-800 transition-colors">
                            Clear All Filters
                        </button>
                        <div class="flex gap-3">
                            <button onclick="toggleFilterPopover()" type="button"
                                class="flex w-full justify-center rounded-lg border border-gray-300 bg-white px-4 py-3 text-sm font-medium text-gray-700 shadow-theme-xs hover:bg-gray-50 hover:text-gray-800 sm:w-auto">
                                Cancel
                            </button>
                            <button onclick="applyFiltersAndClose()" type="button"
                                class="flex justify-center w-full px-4 py-3 text-sm font-medium text-white rounded-lg bg-blue-600 shadow-theme-xs hover:bg-blue-700 sm:w-auto">
                                Apply Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top 4 Metric Cards -->
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-4 md:gap-6 mb-6">
            <!-- Card 1: Total # of Relationships -->
            <div class="rounded-2xl border border-gray-200 bg-white px-6 pb-5 pt-6">
                <div class="mb-6 flex items-center gap-3">
                    <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-blue-100">
                        <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Total # of Relationships</h3>
                    </div>
                </div>
                <div class="flex items-end justify-between">
                    <div>
                        <h4 class="text-2xl font-bold text-gray-800" id="totalRelationships">0</h4>
                    </div>
                </div>
            </div>

            <!-- Card 2: Total # of Facilities -->
            <div class="rounded-2xl border border-gray-200 bg-white px-6 pb-5 pt-6">
                <div class="mb-6 flex items-center gap-3">
                    <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-green-100">
                        <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Total # of Facilities</h3>
                    </div>
                </div>
                <div class="flex items-end justify-between">
                    <div>
                        <h4 class="text-2xl font-bold text-gray-800" id="totalFacilities">0</h4>
                    </div>
                </div>
            </div>

            <!-- Card 3: Total $ of OSUC -->
            <div class="rounded-2xl border border-gray-200 bg-white px-6 pb-5 pt-6">
                <div class="mb-6 flex items-center gap-3">
                    <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-orange-100">
                        <svg class="h-6 w-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Total $ of OSUC</h3>
                    </div>
                </div>
                <div class="flex items-end justify-between">
                    <div>
                        <h4 class="text-2xl font-bold text-gray-800" id="totalOSUC">$0.00</h4>
                    </div>
                </div>
            </div>

            <!-- Card 4: Total $ of Facility Amount -->
            <div class="rounded-2xl border border-gray-200 bg-white px-6 pb-5 pt-6">
                <div class="mb-6 flex items-center gap-3">
                    <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-red-100">
                        <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Total $ of Facility Amount</h3>
                    </div>
                </div>
                <div class="flex items-end justify-between">
                    <div>
                        <h4 class="text-2xl font-bold text-gray-800" id="totalFacAmount">$0.00</h4>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-12 gap-4 md:gap-6 mb-6">
            <!-- Area Chart: Facilities by Expiration Date -->
            <div class="col-span-12 xl:col-span-4">
                <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6 sm:pt-6 h-full flex flex-col">
                    <div class="flex flex-col gap-4 mb-6 sm:flex-row sm:items-center sm:justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800" id="expirationChartTitle">Facilities Expiring in the Next 3 Months</h3>
                            <p class="mt-1 text-gray-500 text-sm">Monthly count of facilities expiring</p>
                        </div>
                        <div class="flex flex-row-reverse items-center justify-end gap-0.5 sm:flex-col sm:items-start">
                            <div class="flex flex-row-reverse items-center gap-3 sm:flex-row sm:gap-2">
                                <h4 class="text-2xl font-bold text-gray-800" id="totalExpiring">0</h4>
                                <span class="flex items-center gap-1 rounded-full bg-blue-50 px-2 py-0.5 text-xs font-medium text-blue-600">
                                    Total
                                </span>
                            </div>
                            <span class="text-gray-500 text-xs">Facilities Maturing</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-5 mb-5">
                        <div class="flex items-center gap-1.5">
                            <div class="h-2.5 w-2.5 rounded-full" style="background-color: #465FFF;"></div>
                            <p class="text-sm text-gray-500">Facilities</p>
                        </div>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <div id="expirationChart" class="h-[310px] w-full"></div>
                    </div>
                </div>
            </div>

            <!-- Bar Chart: Facility Amount Trend -->
            <div class="col-span-12 xl:col-span-4">
                <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6 sm:pt-6 h-full flex flex-col">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800">Facility Amount Trend</h3>
                        <p class="mt-1 text-gray-500 text-sm">Total facility amount over time</p>
                    </div>
                    <div class="flex items-center gap-5 mb-5">
                        <div class="flex items-center gap-1.5">
                            <div class="h-2.5 w-2.5 rounded-full" style="background-color: #465FFF;"></div>
                            <p class="text-sm text-gray-500">Facility Amount</p>
                        </div>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <div id="facilityTrendChart" class="h-[310px] w-full"></div>
                    </div>
                </div>
            </div>

            <!-- Regional Distribution with Map -->
            <div class="col-span-12 xl:col-span-4">
                <div class="rounded-2xl border border-gray-200 bg-white p-5 sm:p-6 h-full flex flex-col">
                    <div class="flex justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Regional Distribution</h3>
                            <p class="mt-1 text-sm text-gray-500">Expiring soon by region</p>
                        </div>
                    </div>
                    <div class="border-gray-200 my-6 overflow-hidden rounded-2xl border bg-gray-50 px-4 py-6 sm:px-6">
                        <div id="mapOne" class="mapOne map-btn -mx-4 -my-6 h-[212px] w-full"></div>
                    </div>
                    <div class="space-y-5" id="regionList">
                        <!-- Regional statistics will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Bar Chart: Top Relationships by Total Facility Amount / Direct OS -->
        <div class="mb-6">
            <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6 sm:pt-5">
                <div class="flex flex-col gap-5 mb-6 sm:flex-row sm:items-center sm:justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800">Top Relationships by Facility Amount</h3>
                        <p class="mt-1 text-gray-500 text-sm">Showing top relationships by total facility amount</p>
                    </div>
                    <div class="flex items-center">
                        <!-- Top N Selector -->
                        <select id="topNFilter" onchange="updateBarChart()" 
                            class="h-11 rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800">
                            <option value="5">Top 5</option>
                            <option value="10" selected>Top 10</option>
                            <option value="15">Top 15</option>
                            <option value="20">Top 20</option>
                        </select>
                    </div>
                </div>
                <div class="w-full">
                    <div id="relationshipChart" class="-ml-5 pl-2"></div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="overflow-hidden rounded-xl border border-gray-200 bg-white">
            <div class="flex flex-col gap-4 border-b border-gray-200 px-4 py-4 sm:px-5">
                <div class="flex-shrink-0">
                    <h3 class="text-lg font-semibold text-gray-800">Portfolio Details</h3>
                    <p class="text-sm text-gray-500">Detailed lending portfolio data <span id="perfIndicator" class="text-green-600 font-medium"></span></p>
                </div>
            </div>
            <div class="custom-scrollbar overflow-x-auto">
                <table class="w-full table-auto" id="portfolioTable">
                    <thead>
                        <tr class="border-b border-gray-200 bg-gray-50">
                            <th class="p-4 text-left text-xs font-medium text-gray-500 whitespace-nowrap">Report Date</th>
                            <th class="p-4 text-left text-xs font-medium text-gray-500 whitespace-nowrap">Region</th>
                            <th class="p-4 text-left text-xs font-medium text-gray-500 whitespace-nowrap">Facility ID</th>
                            <th class="p-4 text-left text-xs font-medium text-gray-500 whitespace-nowrap">Relationship Name</th>
                            <th class="p-4 text-left text-xs font-medium text-gray-500 whitespace-nowrap">Product Program</th>
                            <th class="p-4 text-left text-xs font-medium text-gray-500 whitespace-nowrap">Facility Amount</th>
                            <th class="p-4 text-left text-xs font-medium text-gray-500 whitespace-nowrap">Direct OS</th>
                            <th class="p-4 text-left text-xs font-medium text-gray-500 whitespace-nowrap">Maturity Date</th>
                            <th class="p-4 text-left text-xs font-medium text-gray-500 whitespace-nowrap">CA Expiration</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-gray-200">
                        <!-- Table rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="flex w-full flex-col items-center justify-between border-t border-gray-200 px-5 py-4 sm:flex-row">
                <div class="pb-3 sm:pb-0">
                    <span class="block text-sm font-medium text-gray-500">
                        Showing <span class="text-gray-800" id="startRow">0</span> to 
                        <span class="text-gray-800" id="endRow">0</span> of 
                        <span class="text-gray-800" id="totalRows">0</span>
                    </span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="previousPage()" id="prevBtn"
                        class="flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50">
                        Previous
                    </button>
                    <span class="text-sm font-medium text-gray-700">
                        Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                    </span>
                    <button onclick="nextPage()" id="nextBtn"
                        class="flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50">
                        Next
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== PORTFOLIO ANALYTICS CONFIGURATION =====
        // This dashboard loads data from Confluence in READ-ONLY mode
        // Similar to cmps.html, data is fetched from an attachment but never modified
        // All filters and options are dynamically populated from the loaded data
        
        // Update these values to match your Confluence page and attachment
        const CONFLUENCE_PAGE_ID = '2740868871'; // Your Confluence page ID
        const CONFLUENCE_FILE_NAME = 'palDashboard.csv'; // Your attachment filename (can be .csv, .xlsx, or .xls)
        const CONFLUENCE_BASE_URL = 'https://cedt-confluence.net/confluence';
        // ==========================================
        
        // ===== PERFORMANCE OPTIMIZATIONS FOR 40K+ ROWS =====
        // 1. INDEX CACHING: Pre-parse dates and build indexes for fast filtering
        // 2. SMART FILTERING: Early exit loops, minimal object access, use for-loops not .filter()
        // 3. RESULT CACHING: Cache filtered results to avoid re-filtering same queries
        // 4. SINGLE-PASS METRICS: Calculate all metrics in one loop instead of multiple passes
        // 5. OPTIMIZED CHARTS: Use Map() instead of objects, limit data points
        // 6. DEBOUNCED SEARCH: 500ms delay to prevent filtering on every keystroke
        // 7. LARGER PAGE SIZE: 50 rows per page (fewer renders = better performance)
        // 8. ASYNC RENDERING: Use requestAnimationFrame to prevent UI blocking
        // 
        // Expected Performance: 40K rows should filter in 50-200ms (was 2-5 seconds)
        // =====================================================

        // Global variables
        let portfolioData = [];
        let filteredData = [];
        let currentPage = 1;
        let rowsPerPage = 20; // Show 20 rows per page, load more on pagination
        let expirationChartInstance = null;
        let searchDebounceTimer = null;
        let relationshipChartInstance = null;
        let mapInstance = null;  // Store map instance for updates
        let facilityTrendChartInstance = null;  // Store facility trend chart instance
        let activeFilters = {};
        let selectedMetricType = 'facilityAmount'; // Default to Facility Amount
        let selectedTrendLevel = 'facility'; // Default to Facility Level for trend chart
        
        // Smart Filter States
        let selectedRegion = 'all'; // all, APAC, EMEA, LATAM, NAM
        let includePSE = true; // true = include PSE, false = exclude PSE
        let selectedStatus = 'all'; // all, CM, DM
        let selectedAmountType = 'osuc'; // osuc, facility (for metrics)
        
        // Performance optimization: Cache for expensive calculations
        let metricsCache = {
            full: null,
            filtered: null,
            filterHash: ''
        };
        let indexCache = {
            byRegion: null,
            byProduct: null,
            byRelationship: null,
            dates: null
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== Portfolio Analytics Dashboard ===');
            console.log('READ-ONLY mode - Loading data from Confluence');
            console.log('Page ID:', CONFLUENCE_PAGE_ID);
            console.log('File:', CONFLUENCE_FILE_NAME);
            console.log('=====================================');
            
            // Verify all required libraries are loaded
            if (typeof ApexCharts === 'undefined') {
                console.error(' ApexCharts library not loaded! Charts will not work.');
                showNotification('Error', 'ApexCharts library failed to load. Please refresh the page.', 'error');
            } else {
                console.log(' ApexCharts library loaded successfully');
            }
            
            if (typeof jsVectorMap === 'undefined') {
                console.warn('  jsVectorMap library not loaded. Map will not be displayed.');
            } else {
                console.log(' jsVectorMap library loaded successfully');
            }
            
            if (typeof XLSX === 'undefined') {
                console.warn('  XLSX library not loaded. Excel file parsing may not work.');
            } else {
                console.log(' XLSX library loaded successfully');
            }
            
            // Load data from Confluence attachment
            loadDataFromCSV();
            
            // Setup search functionality with debouncing (increased for large datasets)
            document.getElementById('searchInput').addEventListener('input', function() {
                // Clear previous timer
                if (searchDebounceTimer) {
                    clearTimeout(searchDebounceTimer);
                }
                
                // Set new timer - wait 500ms after user stops typing (longer for 40K rows)
                searchDebounceTimer = setTimeout(() => {
                    filterData();
                }, 500);
            });
        });

        // Refresh data from Confluence (read-only, no write operations)
        async function refreshData() {
            showLoadingState();
            try {
                console.log('Refreshing data from Confluence...');
                const data = await fetchDataFromConfluence();
                
                if (data && data.length > 0) {
                    portfolioData = data;
                    
                    // Clear all caches
                    metricsCache = { full: null, filtered: null, filterHash: '' };
                    indexCache = { byRegion: null, byProduct: null, byRelationship: null, dates: null };
                    
                    // Rebuild indexes
                    buildIndexes();
                    
                    // Repopulate filter options with fresh data
                    populateFilterOptions();
                    
                    // Recalculate all metrics and charts
                    calculateMetrics();
                    createExpirationChart();
                    createFacilityTrendChart();
                    createRegionalChart();
                    createRelationshipChart();
                    
                    // Reset filters and reload data
                    activeFilters = {};
                    displayFilterBadges();
                    updateFilterCount();
                    filterData();
                    
                    showNotification('Success', `Refreshed ${data.length.toLocaleString()} records successfully`, 'success');
                } else {
                    console.error('No data received from Confluence');
                    showNotification('Error', 'Failed to refresh data from Confluence', 'error');
                }
            } catch (error) {
                console.error('Error refreshing data:', error);
                showNotification('Error', 'Failed to refresh data: ' + error.message, 'error');
            }
        }

        // Load data from Confluence attachment (read-only)
        async function loadDataFromCSV() {
            showLoadingOverlay('Fetching data from Confluence...', 'Connecting to server...');
            showLoadingState();
            
            try {
                const data = await fetchDataFromConfluence();
                
                if (data && data.length > 0) {
                    portfolioData = data;
                    console.log(`Loaded ${data.length} records from Confluence`);
                    
                    showLoadingOverlay('Processing data...', `Loading ${data.length.toLocaleString()} records...`);
                    
                    // Use setTimeout to allow UI to update
                    setTimeout(() => {
                        initializeDashboard();
                        hideLoadingOverlay();
                        showNotification('Success', `Loaded ${data.length.toLocaleString()} records successfully`, 'success');
                    }, 100);
                } else {
                    console.warn('No data from Confluence, using sample data');
                    hideLoadingOverlay();
                    showNotification('Warning', 'No data found in Confluence attachment', 'warning');
                    loadSampleData();
                }
            } catch (error) {
                console.error('Error loading data from Confluence:', error);
                hideLoadingOverlay();
                showNotification('Warning', 'Failed to load from Confluence, using sample data', 'warning');
                loadSampleData();
            }
        }

        // Fetch data from Confluence attachment (read-only, no updates)
        async function fetchDataFromConfluence() {
            try {
                // Construct Confluence API URL
                const url = `${CONFLUENCE_BASE_URL}/download/attachments/${CONFLUENCE_PAGE_ID}/${CONFLUENCE_FILE_NAME}?api=v2`;
                
                console.log('Fetching portfolio data from Confluence:', url);
                console.log('File name:', CONFLUENCE_FILE_NAME);
                
                const response = await fetch(url, {
                    headers: {
                        'X-Atlassian-Token': 'no-check'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch ${CONFLUENCE_FILE_NAME}: ${response.status} ${response.statusText}`);
                }

                console.log('Successfully fetched file from Confluence');
                const blob = await response.blob();
                console.log('Blob size:', blob.size, 'bytes');
                
                // Parse based on file type
                if (CONFLUENCE_FILE_NAME.endsWith('.csv')) {
                    console.log('Parsing CSV file...');
                    return await parseCSVBlob(blob);
                } else if (CONFLUENCE_FILE_NAME.endsWith('.xlsx') || CONFLUENCE_FILE_NAME.endsWith('.xls')) {
                    console.log('Parsing Excel file...');
                    return await parseExcelBlob(blob);
                }
                
                throw new Error('Unsupported file format. Please use .csv, .xlsx, or .xls files.');

            } catch (error) {
                console.error('Error fetching data from Confluence:', error.message);
                return null;
            }
        }

        // Parse CSV blob (read-only)
        async function parseCSVBlob(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n');
                        const headers = lines[0].split(',').map(h => h.trim());
                        
                        console.log('CSV Headers:', headers);
                        
                        const data = [];
                        for (let i = 1; i < lines.length; i++) {
                            if (lines[i].trim()) {
                                const values = lines[i].split(',');
                                const row = {};
                                headers.forEach((header, index) => {
                                    row[header] = values[index] ? values[index].trim() : '';
                                });
                                // Only add rows with Facility_ID
                                if (row.Facility_ID) {
                                    data.push(row);
                                }
                            }
                        }
                        
                        console.log(`Parsed ${data.length} records from CSV`);
                        resolve(data);
                    } catch (error) {
                        console.error('Error parsing CSV:', error);
                        reject(error);
                    }
                };
                reader.onerror = () => {
                    console.error('FileReader error while reading CSV');
                    reject(new Error('Failed to read CSV file'));
                };
                reader.readAsText(blob);
            });
        }

        // Parse Excel blob (read-only)
        async function parseExcelBlob(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        
                        // Important: cellDates: true converts Excel date serial numbers to JS Dates
                        const workbook = XLSX.read(data, { 
                            type: 'array',
                            cellDates: true,  // Convert Excel dates to JavaScript dates
                            cellNF: false,
                            cellText: false
                        });
                        
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        
                        console.log('Excel Sheet Name:', workbook.SheetNames[0]);
                        
                        // Convert sheet to JSON with date formatting
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
                            raw: false,  // Don't use raw values (converts dates to strings)
                            dateNF: 'yyyy-mm-dd'  // Date format
                        });
                        
                        console.log(`Total rows in Excel: ${jsonData.length}`);
                        
                        // Filter out empty rows (rows without Facility_ID)
                        const filteredData = jsonData.filter(row => row.Facility_ID);
                        
                        console.log(`Parsed ${filteredData.length} valid records from Excel`);
                        
                        // Log sample data structure for debugging
                        if (filteredData.length > 0) {
                            console.log('Sample record fields:', Object.keys(filteredData[0]));
                            console.log('Sample Maturity_Date:', filteredData[0].Maturity_Date, typeof filteredData[0].Maturity_Date);
                            console.log('Sample CA_Expiration_Date:', filteredData[0].CA_Expiration_Date, typeof filteredData[0].CA_Expiration_Date);
                            console.log('Sample Report_Date:', filteredData[0].Report_Date, typeof filteredData[0].Report_Date);
                        }
                        
                        resolve(filteredData);
                    } catch (error) {
                        console.error('Error parsing Excel:', error);
                        reject(error);
                    }
                };
                reader.onerror = () => {
                    console.error('FileReader error while reading Excel file');
                    reject(new Error('Failed to read Excel file'));
                };
                reader.readAsArrayBuffer(blob);
            });
        }

        // Show loading overlay
        function showLoadingOverlay(message = 'Please wait while we fetch your data...', progress = '') {
            const overlay = document.getElementById('loadingOverlay');
            const messageEl = document.getElementById('loadingMessage');
            const progressEl = document.getElementById('loadingProgress');
            
            if (overlay) {
                overlay.classList.remove('hidden');
                if (messageEl) messageEl.textContent = message;
                if (progressEl) progressEl.textContent = progress;
            }
        }

        // Hide loading overlay
        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
        }

        // Show loading state
        function showLoadingState() {
            const tbody = document.getElementById('tableBody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="py-16">
                            <div class="flex flex-col items-center justify-center">
                                <div class="relative">
                                    <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-200"></div>
                                    <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-600 border-t-transparent absolute top-0 left-0"></div>
                                </div>
                                <div class="mt-6 text-center">
                                    <span class="text-base font-medium text-gray-700">Loading data...</span>
                                    <p class="text-sm text-gray-500 mt-1">Fetching portfolio information from Confluence</p>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        // Show notification
        function showNotification(title, message, type = 'success') {
            const colors = {
                success: { bg: 'bg-green-100', text: 'text-green-600', border: 'border-green-200' },
                error: { bg: 'bg-red-100', text: 'text-red-600', border: 'border-red-200' },
                warning: { bg: 'bg-yellow-100', text: 'text-yellow-600', border: 'border-yellow-200' }
            };
            
            const color = colors[type] || colors.success;
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${color.bg} ${color.border} border ${color.text} px-4 py-3 rounded-lg shadow-lg z-50 max-w-md`;
            notification.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="flex-1">
                        <h4 class="font-semibold">${title}</h4>
                        <p class="text-sm">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Load sample data if CSV is not available
        function loadSampleData() {
            portfolioData = [
                {
                    Report_Date: '2024-01-15',
                    Region: 'NAM',
                    Facility_ID: 'FAC001',
                    Parent_Facility_ID: 'PFAC001',
                    Product_Program: 'Commercial Lending',
                    Management_Status: 'Active',
                    Facility_Type: 'Term Loan',
                    'Committed/Uncommitted': 'Committed',
                    Risk_Category: 'Low',
                    Relationship_ID: 'REL001',
                    Relationship_Name: 'ABC Corporation',
                    CAID: 'CAID001',
                    Lead_Underwriter: 'John Smith',
                    Underwriting_Team_Lead: 'Jane Doe',
                    Control_Unit: 'CU-001',
                    Fac_Amount: '5000000',
                    Total_Reported_Fac_Amount: '5000000',
                    Direct_OS: '3000000',
                    Contingent_OS: '500000',
                    PSE_OS: '0',
                    Unused_Committed: '1500000',
                    Total_Comm_Exposure: '5000000',
                    Maturity_Date: '2025-12-31',
                    Prodict_Underwriter: 'John Smith',
                    CA_Expiration_Date: '2025-06-30'
                },
                // Add more sample data as needed
            ];
            initializeDashboard();
        }

        // Build indexes for fast filtering (one-time operation)
        function buildIndexes() {
            console.log('Building indexes for fast filtering...');
            const startTime = performance.now();
            
            indexCache.byRegion = new Map();
            indexCache.byProduct = new Map();
            indexCache.byRelationship = new Map();
            indexCache.dates = [];
            
            portfolioData.forEach((row, idx) => {
                // Region index
                const region = row.Region;
                if (region) {
                    if (!indexCache.byRegion.has(region)) {
                        indexCache.byRegion.set(region, []);
                    }
                    indexCache.byRegion.get(region).push(idx);
                }
                
                // Product index
                const product = row.Product_Program;
                if (product) {
                    if (!indexCache.byProduct.has(product)) {
                        indexCache.byProduct.set(product, []);
                    }
                    indexCache.byProduct.get(product).push(idx);
                }
                
                // Relationship index
                const relationship = row.Relationship_Name || row.Relationship_ID;
                if (relationship) {
                    if (!indexCache.byRelationship.has(relationship)) {
                        indexCache.byRelationship.set(relationship, []);
                    }
                    indexCache.byRelationship.get(relationship).push(idx);
                }
                
                // Pre-parse dates for faster filtering
                const maturityDate = parseDate(row.Maturity_Date);
                const caDate = parseDate(row.CA_Expiration_Date);
                indexCache.dates.push({
                    maturityDate,
                    caDate
                });
            });
            
            const endTime = performance.now();
            console.log(`Indexes built in ${((endTime - startTime) / 1000).toFixed(2)} seconds`);
        }
        
        // Generate hash of active filters for cache validation
        function getFilterHash() {
            return JSON.stringify(activeFilters) + '_' + document.getElementById('searchInput').value;
        }

        // Initialize dashboard with data (optimized for large datasets)
        function initializeDashboard() {
            const startTime = performance.now();
            console.log('Initializing dashboard with', portfolioData.length, 'records...');
            
            // Safety check
            if (!portfolioData || portfolioData.length === 0) {
                console.error('No portfolio data loaded!');
                showNotification('Error', 'No portfolio data available', 'error');
                return;
            }
            
            // Log sample data to verify structure
            console.log('Sample data row:', portfolioData[0]);
            console.log('Available fields:', Object.keys(portfolioData[0]));
            
            // Step 1: Build indexes (one-time, makes filtering much faster)
            console.time('Build Indexes');
            buildIndexes();
            console.timeEnd('Build Indexes');
            
            // Step 2: Populate filters
            console.time('Populate Filters');
            populateFilterOptions();
            console.timeEnd('Populate Filters');
            
            // Step 3: Update report date
            console.time('Update Report Date');
            updateReportDate();
            console.timeEnd('Update Report Date');
            
            // Step 4: Calculate metrics (with caching)
            console.time('Calculate Metrics');
            calculateMetrics();
            console.timeEnd('Calculate Metrics');
            
            // Step 5: Create charts with sampled data (faster)
            console.time('Create Charts');
            createExpirationChart();
            createFacilityTrendChart();
            createRegionalChart();
            createRelationshipChart();
            console.timeEnd('Create Charts');
            
            // Step 6: Filter and render table (only first page)
            console.time('Filter and Render Table');
            filterData();
            console.timeEnd('Filter and Render Table');
            
            const endTime = performance.now();
            console.log(`Dashboard initialized in ${((endTime - startTime) / 1000).toFixed(2)} seconds`);
        }

        // Populate filter dropdowns with unique values from Confluence data (read-only)
        function populateFilterOptions() {
            if (!portfolioData || portfolioData.length === 0) {
                console.warn('No portfolio data available to populate filters');
                return;
            }

            console.log('Populating filter options from', portfolioData.length, 'records');
            
            // Product Program
            const products = [...new Set(portfolioData.map(row => row.Product_Program).filter(Boolean))].sort();
            populateSelect('filterProductProgram', products);
            console.log('Product Programs:', products.length, 'options');
            
            // Extending Unit (Control_Unit)
            const units = [...new Set(portfolioData.map(row => row.Control_Unit).filter(Boolean))].sort();
            populateSelect('filterExtendingUnit', units);
            console.log('Extending Units:', units.length, 'options');
            
            // Facility Type
            const facilityTypes = [...new Set(portfolioData.map(row => row.Facility_Type).filter(Boolean))].sort();
            populateSelect('filterFacilityType', facilityTypes);
            console.log('Facility Types:', facilityTypes.length, 'options');
            
            // Committed/Uncommitted
            const commitments = [...new Set(portfolioData.map(row => row['Committed/Uncommitted']).filter(Boolean))].sort();
            populateSelect('filterCommitment', commitments);
            console.log('Commitment Status:', commitments.length, 'options');
            
            // Team Lead (Underwriter_Team_Lead)
            const teamLeads = [...new Set(portfolioData.map(row => row.Underwriting_Team_Lead).filter(Boolean))].sort();
            populateSelect('filterTeamLead', teamLeads);
            console.log('Team Leads:', teamLeads.length, 'options');
            
            // Underwriter (Lead_Underwriter)
            const underwriters = [...new Set(portfolioData.map(row => row.Lead_Underwriter).filter(Boolean))].sort();
            populateSelect('filterUnderwriter', underwriters);
            console.log('Underwriters:', underwriters.length, 'options');
        }

        // Helper to populate a select element
        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) {
                console.warn(`Select element with id '${selectId}' not found`);
                return;
            }
            const currentValue = select.value;
            
            // Keep the first option (All...)
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                select.appendChild(opt);
            });
            
            // Restore previous value if it still exists
            if (currentValue && options.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // Apply all filters (OPTIMIZED for 40K+ rows)
        function applyFilters() {
            const startTime = performance.now();
            
            // Get advanced filter values (excluding Region and Status which are in smart filters)
            const filters = {
                productProgram: document.getElementById('filterProductProgram').value,
                extendingUnit: document.getElementById('filterExtendingUnit').value,
                facilityType: document.getElementById('filterFacilityType').value,
                commitment: document.getElementById('filterCommitment').value,
                teamLead: document.getElementById('filterTeamLead').value,
                underwriter: document.getElementById('filterUnderwriter').value,
                caMaturity: document.getElementById('filterCAMaturity').value,
                facilityMaturity: document.getElementById('filterFacilityMaturity').value
            };
            
            // Update active filters object (Region and Status are managed by smart filters)
            activeFilters = {};
            if (filters.productProgram) activeFilters['Product Program'] = filters.productProgram;
            if (filters.extendingUnit) activeFilters['Extending Unit'] = filters.extendingUnit;
            if (filters.facilityType) activeFilters['Facility Type'] = filters.facilityType;
            if (filters.commitment) activeFilters['Commitment Status'] = filters.commitment;
            if (filters.teamLead) activeFilters['Team Lead'] = filters.teamLead;
            if (filters.underwriter) activeFilters['Underwriter'] = filters.underwriter;
            if (filters.caMaturity) {
                const days = filters.caMaturity;
                activeFilters['CAs Maturing'] = days === '30' ? 'Next 30 Days' :
                                               days === '60' ? 'Next 60 Days' :
                                               days === '90' ? 'Next 90 Days' :
                                               days === '180' ? 'Next 6 Months' : 'Next Year';
            }
            if (filters.facilityMaturity) {
                const days = filters.facilityMaturity;
                activeFilters['Facilities Maturing'] = days === '30' ? 'Next 30 Days' :
                                                       days === '60' ? 'Next 60 Days' :
                                                       days === '90' ? 'Next 90 Days' :
                                                       days === '180' ? 'Next 6 Months' : 'Next Year';
            }
            
            // Display filter badges and update count
            displayFilterBadges();
            updateFilterCount();
            
            // Check if we can use cache
            const currentHash = getFilterHash();
            if (metricsCache.filterHash === currentHash && metricsCache.filtered) {
                console.log('Using cached filter results');
                filteredData = metricsCache.filtered.data;
                currentPage = 1;
                renderTable();
                return;
            }
            
            // Pre-calculate date ranges for date filters (avoid recalculating in loop)
            let caDateRange = null;
            let facilityDateRange = null;
            if (filters.caMaturity) {
                const today = new Date();
                const futureDate = new Date(today.getTime() + parseInt(filters.caMaturity) * 24 * 60 * 60 * 1000);
                caDateRange = { today, futureDate };
            }
            if (filters.facilityMaturity) {
                const today = new Date();
                const futureDate = new Date(today.getTime() + parseInt(filters.facilityMaturity) * 24 * 60 * 60 * 1000);
                facilityDateRange = { today, futureDate };
            }
            
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            // OPTIMIZED filtering: Use early exits and minimal object access
            filteredData = [];
            for (let i = 0; i < portfolioData.length; i++) {
                const row = portfolioData[i];
                
                // Smart Filters (apply first for performance)
                // Region filter
                if (selectedRegion !== 'all' && row.Region !== selectedRegion) continue;
                
                // PSE filter (exclude PSE if includePSE is false)
                // Assuming PSE data might be in Product_Program or a specific column
                if (!includePSE) {
                    const productProgram = (row.Product_Program || '').toUpperCase();
                    if (productProgram.includes('PSE')) continue;
                }
                
                // Management Status filter (CM/DM)
                if (selectedStatus !== 'all' && row.Management_Status !== selectedStatus) continue;
                
                // Fast path: Check advanced filter string filters (fastest to fail)
                if (filters.productProgram && row.Product_Program !== filters.productProgram) continue;
                if (filters.extendingUnit && row.Control_Unit !== filters.extendingUnit) continue;
                if (filters.facilityType && row.Facility_Type !== filters.facilityType) continue;
                if (filters.commitment && row['Committed/Uncommitted'] !== filters.commitment) continue;
                if (filters.teamLead && row.Underwriting_Team_Lead !== filters.teamLead) continue;
                if (filters.underwriter && row.Lead_Underwriter !== filters.underwriter) continue;
                
                // Date filters (use pre-parsed dates from index)
                if (caDateRange) {
                    const caDate = indexCache.dates[i].caDate;
                    if (!caDate || caDate < caDateRange.today || caDate > caDateRange.futureDate) continue;
                }
                
                if (facilityDateRange) {
                    const maturityDate = indexCache.dates[i].maturityDate;
                    if (!maturityDate || maturityDate < facilityDateRange.today || maturityDate > facilityDateRange.futureDate) continue;
                }
                
                // Search filter (most expensive, do last)
                if (searchTerm) {
                    let found = false;
                    for (const value of Object.values(row)) {
                        if (String(value).toLowerCase().includes(searchTerm)) {
                            found = true;
                            break;
                        }
                    }
                    if (!found) continue;
                }
                
                // All filters passed
                filteredData.push(row);
            }
            
            // Cache the results
            metricsCache.filterHash = currentHash;
            metricsCache.filtered = { data: filteredData };
            
            console.log(`Filtered ${portfolioData.length} to ${filteredData.length} rows in ${(performance.now() - startTime).toFixed(2)}ms`);
            
            // Recalculate metrics and charts with filtered data (async to prevent blocking)
            requestAnimationFrame(() => {
                calculateMetricsFromFiltered();
                createExpirationChartFromFiltered();
                createFacilityTrendChartFromFiltered();
                createRegionalChartFromFiltered();
                createRelationshipChartFromFiltered();
            });
            
            // Reset to first page and render table immediately
            currentPage = 1;
            renderTable();
        }

        // Display filter badges
        function displayFilterBadges() {
            const badgesContainer = document.getElementById('activeFiltersBadges');
            badgesContainer.innerHTML = '';
            
            if (Object.keys(activeFilters).length === 0) {
                badgesContainer.style.display = 'none';
                return;
            }
            
            badgesContainer.style.display = 'flex';
            
            Object.entries(activeFilters).forEach(([label, value]) => {
                const badge = document.createElement('span');
                badge.className = 'inline-flex items-center bg-white text-sm text-gray-600 border border-gray-300 rounded-lg gap-x-2 py-1.5 pl-3 pr-1';
                badge.innerHTML = `
                    <span class="text-gray-600">${label}</span>
                    <span class="h-4 w-px bg-gray-300"></span>
                    <span class="font-medium text-gray-800">${value}</span>
                    <button type="button" onclick="removeFilter('${label}')" 
                        class="flex h-5 w-5 items-center justify-center rounded text-gray-500 hover:bg-gray-100 hover:text-gray-700"
                        aria-label="Remove">
                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                `;
                badgesContainer.appendChild(badge);
            });
        }

        // Remove a specific filter
        function removeFilter(label) {
            const filterMap = {
                'Product Program': 'filterProductProgram',
                'Extending Unit': 'filterExtendingUnit',
                'Facility Type': 'filterFacilityType',
                'Commitment Status': 'filterCommitment',
                'Team Lead': 'filterTeamLead',
                'Underwriter': 'filterUnderwriter',
                'CAs Maturing': 'filterCAMaturity',
                'Facilities Maturing': 'filterFacilityMaturity'
            };
            
            const selectId = filterMap[label];
            if (selectId) {
                const element = document.getElementById(selectId);
                if (element) {
                    element.value = '';
                    applyFilters();
                }
            }
        }

        // Clear all filters
        function clearAllFilters() {
            // Clear only advanced filter fields (Region and Status are managed by smart filters)
            document.getElementById('filterProductProgram').value = '';
            document.getElementById('filterExtendingUnit').value = '';
            document.getElementById('filterFacilityType').value = '';
            document.getElementById('filterCommitment').value = '';
            document.getElementById('filterTeamLead').value = '';
            document.getElementById('filterUnderwriter').value = '';
            document.getElementById('filterCAMaturity').value = '';
            document.getElementById('filterFacilityMaturity').value = '';
            
            activeFilters = {};
            applyFilters();
            updateFilterCount();
        }

        // Store temporary filter state when opening popover
        let tempFilterState = {};

        // Toggle filter popover
        function toggleFilterPopover() {
            const popover = document.getElementById('filterPopover');
            if (popover.classList.contains('hidden')) {
                // Opening popover - save current filter state (excluding smart filters)
                tempFilterState = {
                    productProgram: document.getElementById('filterProductProgram').value,
                    extendingUnit: document.getElementById('filterExtendingUnit').value,
                    facilityType: document.getElementById('filterFacilityType').value,
                    commitment: document.getElementById('filterCommitment').value,
                    teamLead: document.getElementById('filterTeamLead').value,
                    underwriter: document.getElementById('filterUnderwriter').value,
                    caMaturity: document.getElementById('filterCAMaturity').value,
                    facilityMaturity: document.getElementById('filterFacilityMaturity').value
                };
                
                popover.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            } else {
                // Closing popover - restore previous filter state (cancel changes)
                document.getElementById('filterProductProgram').value = tempFilterState.productProgram || '';
                document.getElementById('filterExtendingUnit').value = tempFilterState.extendingUnit || '';
                document.getElementById('filterFacilityType').value = tempFilterState.facilityType || '';
                document.getElementById('filterCommitment').value = tempFilterState.commitment || '';
                document.getElementById('filterTeamLead').value = tempFilterState.teamLead || '';
                document.getElementById('filterUnderwriter').value = tempFilterState.underwriter || '';
                document.getElementById('filterCAMaturity').value = tempFilterState.caMaturity || '';
                document.getElementById('filterFacilityMaturity').value = tempFilterState.facilityMaturity || '';
                
                popover.classList.add('hidden');
                document.body.style.overflow = ''; // Restore scrolling
            }
        }

        // Apply filters and close popover
        function applyFiltersAndClose() {
            applyFilters();
            // Close popover without restoring state (we're applying changes)
            const popover = document.getElementById('filterPopover');
            popover.classList.add('hidden');
            document.body.style.overflow = '';
        }

        // Update filter count badge
        function updateFilterCount() {
            const count = Object.keys(activeFilters).length;
            const badge = document.getElementById('filterCount');
            
            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // Calculate metrics from filtered data (OPTIMIZED)
        function calculateMetricsFromFiltered() {
            const startTime = performance.now();
            
            let totalFacAmount = 0;
            let totalOSUC = 0;
            const relationships = new Set();
            const facilities = new Set();
            
            // Single pass through filtered data
            for (let i = 0; i < filteredData.length; i++) {
                const row = filteredData[i];
                
                totalFacAmount += parseNumber(row.Fac_Amount);
                totalOSUC += parseNumber(row.Direct_OS);
                
                const rel = row.Relationship_Name || row.Relationship_ID;
                if (rel) relationships.add(rel);
                
                if (row.Facility_ID) facilities.add(row.Facility_ID);
            }
            
            document.getElementById('totalRelationships').textContent = relationships.size.toLocaleString();
            document.getElementById('totalFacilities').textContent = facilities.size.toLocaleString();
            document.getElementById('totalOSUC').textContent = formatCurrency(totalOSUC);
            document.getElementById('totalFacAmount').textContent = formatCurrency(totalFacAmount);
            
            console.log(`Filtered metrics calculated in ${(performance.now() - startTime).toFixed(2)}ms`);
        }

        // Create expiration chart from filtered data
        function createExpirationChartFromFiltered() {
            console.log(' Creating filtered expiration chart with', filteredData.length, 'records');
            
            // Update title dynamically based on active filters and search
            const titleElement = document.getElementById('expirationChartTitle');
            if (titleElement) {
                // Build filter description
                const filterParts = [];
                
                // Check for search term
                const searchTerm = document.getElementById('searchInput').value;
                if (searchTerm && searchTerm.trim() !== '') {
                    filterParts.push(`Search: "${searchTerm.trim()}"`);
                }
                
                if (activeFilters.Region && activeFilters.Region.length > 0) {
                    filterParts.push(activeFilters.Region.join(', '));
                }
                if (activeFilters.Product_Program && activeFilters.Product_Program.length > 0) {
                    if (activeFilters.Product_Program.length === 1) {
                        filterParts.push(activeFilters.Product_Program[0]);
                    } else {
                        filterParts.push(`${activeFilters.Product_Program.length} Products`);
                    }
                }
                if (activeFilters.Relationship_Name && activeFilters.Relationship_Name.length > 0) {
                    if (activeFilters.Relationship_Name.length === 1) {
                        filterParts.push(activeFilters.Relationship_Name[0]);
                    } else {
                        filterParts.push(`${activeFilters.Relationship_Name.length} Relationships`);
                    }
                }
                
                const filterText = filterParts.length > 0 ? ` (${filterParts.join(', ')})` : '';
                titleElement.textContent = `Facilities Expiring in the Next 3 Months${filterText}`;
            }
            
            const expirationData = aggregateExpirationData(filteredData);
            
            console.log('Filtered aggregated expiration data:', expirationData);
            
            // Handle empty data
            if (!expirationData || expirationData.allMonths.length === 0) {
                console.warn(' No filtered expiration data found for the next 3 months');
                document.getElementById('totalExpiring').textContent = '0';
                
                // Show empty chart message
                const chartElement = document.querySelector("#expirationChart");
                if (chartElement) {
                    chartElement.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">No filtered data expiring in the next 3 months</div>';
                }
                return;
            }
            
            const allMonths = expirationData.allMonths;
            
            const facilitySeries = expirationData.facilities.map(d => d.count);
            
            console.log('Filtered facility series:', facilitySeries);
            
            const totalExpiring = facilitySeries.reduce((a, b) => a + b, 0);
            console.log('Total filtered facilities expiring:', totalExpiring);
            document.getElementById('totalExpiring').textContent = totalExpiring.toLocaleString();
            
            const options = {
                series: [
                    {
                        name: 'Facilities',
                        data: facilitySeries
                    }
                ],
                legend: {
                    show: false,
                    position: 'top',
                    horizontalAlign: 'left'
                },
                colors: ['#465FFF'],
                chart: {
                    fontFamily: 'system-ui, -apple-system, sans-serif',
                    height: 310,
                    type: 'area',
                    toolbar: {
                        show: false
                    }
                },
                fill: {
                    gradient: {
                        enabled: true,
                        opacityFrom: 0.55,
                        opacityTo: 0
                    }
                },
                stroke: {
                    curve: 'smooth',
                    width: [2]
                },
                markers: {
                    size: 0
                },
                labels: {
                    show: false,
                    position: 'top'
                },
                grid: {
                    xaxis: {
                        lines: {
                            show: false
                        }
                    },
                    yaxis: {
                        lines: {
                            show: true
                        }
                    }
                },
                dataLabels: {
                    enabled: false
                },
                tooltip: {
                    x: {
                        formatter: function(value, { dataPointIndex }) {
                            const monthStr = allMonths[dataPointIndex];
                            if (monthStr) {
                                const date = new Date(monthStr + '-01');
                                return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                            }
                            return value;
                        }
                    }
                },
                xaxis: {
                    type: 'category',
                    categories: allMonths.map(m => {
                        const date = new Date(m + '-01');
                        return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    }),
                    axisBorder: {
                        show: false
                    },
                    axisTicks: {
                        show: false
                    }
                },
                yaxis: {
                    title: {
                        style: {
                            fontSize: '0px'
                        }
                    }
                }
            };

            // Get the chart element and verify it exists
            const chartElement = document.querySelector("#expirationChart");
            if (!chartElement) {
                console.error('Filtered expiration chart element #expirationChart not found in DOM');
                return;
            }
            
            // Verify ApexCharts is loaded
            if (typeof ApexCharts === 'undefined') {
                console.error('ApexCharts library not loaded');
                return;
            }
            
            try {
                // Destroy previous instance
                if (expirationChartInstance) {
                    expirationChartInstance.destroy();
                    expirationChartInstance = null;
                }
                
                // Clear any previous content to avoid ApexCharts errors
                chartElement.innerHTML = '';
                
                // Create and render new chart
                expirationChartInstance = new ApexCharts(chartElement, options);
                expirationChartInstance.render();
                console.log(' Filtered expiration chart rendered successfully with Facilities series');
            } catch (error) {
                console.error(' Error rendering filtered expiration chart:', error);
                console.error('Error details:', error.message, error.stack);
            }
        }

        // Create regional chart from filtered data
        function createRegionalChartFromFiltered() {
            initializeMapFromFiltered();
            
            const regionCounts = getRegionCountsFromFiltered();
            const totalCount = Object.values(regionCounts).reduce((a, b) => a + b, 0);
            
            const sortedRegions = Object.entries(regionCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const regionInfo = {
                'NAM': { code: 'NAM', name: 'United States', color: 'bg-blue-500' },
                'EMEA': { code: 'EMEA', name: 'Luxembourg', color: 'bg-green-500' },
                'APAC': { code: 'APAC', name: 'Malaysia', color: 'bg-orange-500' },
                'LATAM': { code: 'LATAM', name: 'Brazil', color: 'bg-purple-500' },
                'MEA': { code: 'MEA', name: 'Middle East & Africa', color: 'bg-red-500' }
            };
            
            const regionList = document.getElementById('regionList');
            regionList.innerHTML = '';
            
            const countLabel = 'Facilities';
            
            sortedRegions.forEach(([region, count]) => {
                const percentage = totalCount > 0 ? ((count / totalCount) * 100).toFixed(0) : 0;
                const info = regionInfo[region] || { code: region, name: region, color: 'bg-gray-500' };
                
                const regionItem = document.createElement('div');
                regionItem.className = 'flex items-center justify-between';
                regionItem.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 flex items-center justify-center rounded-full ${info.color} text-white font-semibold text-xs">
                            ${info.code}
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-gray-800">${info.code}</p>
                            <span class="block text-xs text-gray-500">${count} ${countLabel}</span>
                        </div>
                    </div>
                    <div class="flex w-full max-w-[140px] items-center gap-3">
                        <div class="relative block h-2 w-full max-w-[100px] rounded-sm bg-gray-200">
                            <div class="absolute left-0 top-0 flex h-full items-center justify-center rounded-sm bg-blue-500 text-xs font-medium text-white"
                                style="width: ${percentage}%"></div>
                        </div>
                        <p class="text-sm font-medium text-gray-800">${percentage}%</p>
                    </div>
                `;
                regionList.appendChild(regionItem);
            });
        }

        // Initialize map from filtered data
        function initializeMapFromFiltered() {
            try {
                const mapElement = document.getElementById('mapOne');
                if (!mapElement) {
                    console.warn('Map element #mapOne not found, skipping filtered map initialization');
                    return;
                }
                
                // Check if jsVectorMap is available
                if (typeof jsVectorMap === 'undefined') {
                    console.warn('jsVectorMap library not loaded, skipping filtered map initialization');
                    return;
                }
                
                const regionCoords = {
                    'NAM': { coords: [37.0902, -95.7129], name: 'United States' },
                    'EMEA': { coords: [49.6116, 6.1319], name: 'Luxembourg' },
                    'APAC': { coords: [3.1390, 101.6869], name: 'Malaysia' },
                    'LATAM': { coords: [-23.5505, -46.6333], name: 'Brazil' },
                    'MEA': { coords: [25.2048, 55.2708], name: 'Middle East' }
                };
                
                const regionCounts = getRegionCountsFromFiltered();
                console.log('Filtered region counts for map:', regionCounts);
                
                const markers = [];
                
                Object.keys(regionCounts).forEach(region => {
                    if (regionCoords[region]) {
                        markers.push({
                            name: regionCoords[region].name,
                            coords: regionCoords[region].coords
                        });
                    }
                });
                
                // Destroy existing map instance if it exists
                if (mapInstance) {
                    try {
                        mapInstance.destroy();
                        mapInstance = null;
                    } catch (e) {
                        console.warn('  Error destroying filtered map:', e);
                    }
                }
                
                // Clear existing map DOM
                mapElement.innerHTML = '';
                
                // Small delay to ensure DOM is ready
                setTimeout(() => {
                    mapInstance = new jsVectorMap({
                        selector: '#mapOne',
                        map: 'world',
                        zoomButtons: false,
                        regionStyle: {
                            initial: {
                                fill: '#D9D9D9'
                            },
                            hover: {
                                fillOpacity: 1,
                                fill: '#465fff'
                            }
                        },
                        markers: markers,
                        markerStyle: {
                            initial: {
                                strokeWidth: 1,
                        fill: '#465fff',
                        fillOpacity: 1,
                        r: 4
                    },
                    hover: {
                        fill: '#465fff',
                        fillOpacity: 1
                    }
                }
            });
                    console.log(' Filtered map initialized successfully with', markers.length, 'markers');
                }, 50); // Small delay to ensure DOM is ready
            } catch (error) {
                console.error('Error initializing filtered map:', error);
                // Map is optional, continue without it
            }
        }

        // Get region counts from filtered data
        function getRegionCountsFromFiltered() {
            console.log(' getRegionCountsFromFiltered called');
            const regionCounts = {};
            const today = new Date();
            const threeMonthsLater = new Date(today.getTime() + 90 * 24 * 60 * 60 * 1000);
            
            // Count unique Facility IDs
            console.log('Counting filtered Facility IDs by region (expiring in next 90 days)');
            const regionFacilities = {};
            let totalExpiring = 0;
            
            filteredData.forEach(row => {
                const maturityDate = parseDate(row.Maturity_Date);
                if (maturityDate && maturityDate <= threeMonthsLater && maturityDate >= today) {
                    const region = row.Region || 'Unknown';
                    const facilityId = row.Facility_ID;
                    
                    if (!regionFacilities[region]) {
                        regionFacilities[region] = new Set();
                    }
                    if (facilityId) {
                        regionFacilities[region].add(facilityId);
                        totalExpiring++;
                    }
                }
            });
            
            // Convert Set sizes to counts
            Object.keys(regionFacilities).forEach(region => {
                regionCounts[region] = regionFacilities[region].size;
            });
            
            console.log(`Found ${totalExpiring} filtered expiring facilities across ${Object.keys(regionCounts).length} regions:`, regionCounts);
            
            return regionCounts;
        }

        // Create relationship chart from filtered data (OPTIMIZED)
        function createRelationshipChartFromFiltered() {
            const startTime = performance.now();
            const topN = parseInt(document.getElementById('topNFilter').value);
            
            // Always use Facility Amount
            const fieldName = 'Fac_Amount';
            const seriesName = 'Facility Amount';
            
            console.log('Creating filtered relationship chart, field:', fieldName, 'dataLength:', filteredData.length);
            
            // Use Map for better performance
            const relationshipTotals = new Map();
            
            for (let i = 0; i < filteredData.length; i++) {
                const row = filteredData[i];
                const relId = row.Relationship_Name || row.Relationship_ID;
                const amount = parseNumber(row[fieldName]);
                
                if (relId && amount > 0) {
                    relationshipTotals.set(relId, (relationshipTotals.get(relId) || 0) + amount);
                }
            }
            
            console.log('Total unique filtered relationships:', relationshipTotals.size);
            
            // Convert to array and sort
            const sorted = Array.from(relationshipTotals.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, topN);
            
            console.log(`Filtered chart aggregated ${filteredData.length} rows, found ${relationshipTotals.size} relationships in ${(performance.now() - startTime).toFixed(2)}ms`);
            
            // Add index numbers (1, 2, 3, ...) before relationship names
            const relationships = sorted.map((item, index) => `${index + 1}. ${item[0]}`);
            const amounts = sorted.map(item => item[1]);
            
            // Handle empty data
            if (relationships.length === 0) {
                console.warn('No filtered relationship data for chart');
                return;
            }
            
            const options = {
                series: [{
                    name: seriesName,
                    data: amounts
                }],
                colors: ['#465fff'],
                chart: {
                    fontFamily: 'Outfit, sans-serif',
                    type: 'bar',
                    height: 350,
                    toolbar: {
                        show: false
                    }
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        borderRadius: 5,
                        borderRadiusApplication: 'end'
                    }
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    show: true,
                    width: 4,
                    colors: ['transparent']
                },
                xaxis: {
                    labels: {
                        formatter: function(val) {
                            return formatCurrency(val);
                        }
                    },
                    axisBorder: {
                        show: false
                    },
                    axisTicks: {
                        show: false
                    }
                },
                yaxis: {
                    categories: relationships,
                    title: false,
                    labels: {
                        style: {
                            fontSize: '12px'
                        }
                    }
                },
                legend: {
                    show: true,
                    position: 'top',
                    horizontalAlign: 'left',
                    fontFamily: 'Outfit',
                    markers: {
                        radius: 99
                    }
                },
                grid: {
                    yaxis: {
                        lines: {
                            show: false
                        }
                    }
                },
                fill: {
                    opacity: 1
                },
                tooltip: {
                    x: {
                        show: false
                    },
                    y: {
                        formatter: function(val) {
                            return formatCurrency(val);
                        }
                    }
                }
            };

            // Get the chart element and verify it exists
            const chartElement = document.querySelector("#relationshipChart");
            if (!chartElement) {
                console.error('Filtered relationship chart element #relationshipChart not found in DOM');
                return;
            }
            
            // Verify ApexCharts is loaded
            if (typeof ApexCharts === 'undefined') {
                console.error('ApexCharts library not loaded');
                return;
            }
            
            try {
                // Destroy previous instance
                if (relationshipChartInstance) {
                    relationshipChartInstance.destroy();
                    relationshipChartInstance = null;
                }
                
                // Clear any previous content to avoid ApexCharts errors
                chartElement.innerHTML = '';
                
                // Create and render new chart
                relationshipChartInstance = new ApexCharts(chartElement, options);
                relationshipChartInstance.render();
                console.log(' Filtered relationship chart rendered successfully with', relationships.length, 'relationships');
            } catch (error) {
                console.error(' Error creating filtered relationship chart:', error);
                console.error('Error details:', error.message, error.stack);
            }
        }

        // Smart Filter Functions
        
        // Select Region Filter
        function selectRegionFilter(region) {
            selectedRegion = region;
            
            // Update button styles with min-width (LATAM is wider)
            const regions = ['All', 'APAC', 'EMEA', 'LATAM', 'NAM'];
            regions.forEach(r => {
                const btnId = `btnRegion${r}`;
                const btn = document.getElementById(btnId);
                if (btn) {
                    const minWidth = r === 'LATAM' ? 'min-w-[60px]' : 'min-w-[50px]';
                    if (r.toLowerCase() === region.toLowerCase()) {
                        btn.className = `${minWidth} px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white`;
                    } else {
                        btn.className = `${minWidth} px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900`;
                    }
                }
            });
            
            // Apply filters
            applyFilters();
        }
        
        // Toggle PSE (Include/Exclude)
        function togglePSE(include) {
            includePSE = include;
            console.log('PSE filter:', includePSE ? 'Include' : 'Exclude');
            // Apply filters
            applyFilters();
        }
        
        // Select Status Filter (CM/DM)
        function selectStatusFilter(status) {
            selectedStatus = status;
            
            // Update button styles with min-width
            const statuses = ['All', 'CM', 'DM'];
            statuses.forEach(s => {
                const btnId = `btnStatus${s}`;
                const btn = document.getElementById(btnId);
                if (btn) {
                    if (s.toLowerCase() === status.toLowerCase()) {
                        btn.className = 'min-w-[45px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white';
                    } else {
                        btn.className = 'min-w-[45px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900';
                    }
                }
            });
            
            // Apply filters
            applyFilters();
        }
        
        // Select Amount Type Filter (OSUC/Facility)
        function selectAmountTypeFilter(type) {
            selectedAmountType = type;
            
            // Update button styles with min-width
            const types = { 'OSUC': 'osuc', 'Facility': 'facility' };
            Object.keys(types).forEach(t => {
                const btnId = `btnAmount${t}`;
                const btn = document.getElementById(btnId);
                if (btn) {
                    if (types[t] === type) {
                        btn.className = 'min-w-[60px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white';
                    } else {
                        btn.className = 'min-w-[60px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900';
                    }
                }
            });
            
            console.log('Amount Type filter:', type);
            // Refresh metrics display based on new selection
            if (filteredData.length > 0) {
                calculateMetricsFromFiltered();
            } else {
                calculateMetrics();
            }
        }
        
        // Reset All Filters
        function resetAllFilters() {
            // Reset smart filters
            selectedRegion = 'all';
            includePSE = true;
            selectedStatus = 'all';
            selectedAmountType = 'osuc';
            
            // Reset region buttons
            selectRegionFilter('all');
            
            // Reset status buttons
            selectStatusFilter('all');
            
            // Reset amount type buttons
            selectAmountTypeFilter('osuc');
            
            // Reset PSE toggle
            const pseToggle = document.getElementById('pseToggle');
            if (pseToggle) {
                pseToggle.checked = true;
            }
            
            // Reset search
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
            }
            
            // Reset advanced filter dropdowns
            document.getElementById('filterProductProgram').value = '';
            document.getElementById('filterExtendingUnit').value = '';
            document.getElementById('filterFacilityType').value = '';
            document.getElementById('filterCommitment').value = '';
            document.getElementById('filterTeamLead').value = '';
            document.getElementById('filterUnderwriter').value = '';
            document.getElementById('filterCAMaturity').value = '';
            document.getElementById('filterFacilityMaturity').value = '';
            
            // Clear active filters
            activeFilters = {};
            displayFilterBadges();
            updateFilterCount();
            
            // Refresh data
            filterData();
            
            showNotification('Success', 'All filters have been reset', 'success');
        }
        
        // Export Functions
        
        function exportToExcel() {
            try {
                // Prepare data for export
                const exportData = filteredData.map(row => ({
                    'Report Date': formatDate(row.Report_Date),
                    'Region': row.Region || '',
                    'Facility ID': row.Facility_ID || '',
                    'Relationship Name': row.Relationship_Name || '',
                    'Product Program': row.Product_Program || '',
                    'Facility Amount': parseNumber(row.Fac_Amount),
                    'Direct OS': parseNumber(row.Direct_OS),
                    'Maturity Date': formatDate(row.Maturity_Date),
                    'CA Expiration Date': formatDate(row.CA_Expiration_Date),
                    'Control Unit': row.Control_Unit || '',
                    'Facility Type': row.Facility_Type || '',
                    'Commitment Status': row['Committed/Uncommitted'] || '',
                    'Management Status': row.Management_Status || '',
                    'Team Lead': row.Underwriting_Team_Lead || '',
                    'Underwriter': row.Lead_Underwriter || ''
                }));
                
                // Create worksheet
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Portfolio Data');
                
                // Generate filename with timestamp
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = `portfolio_export_${timestamp}.xlsx`;
                
                // Save file
                XLSX.writeFile(wb, filename);
                
                showNotification('Success', `Data exported to ${filename}`, 'success');
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Error', 'Failed to export to Excel', 'error');
            }
        }
        
        function exportToPDF() {
            showNotification('Info', 'PDF export functionality coming soon', 'info');
            // TODO: Implement PDF export using jsPDF
        }
        
        function exportToPPT() {
            showNotification('Info', 'PowerPoint export functionality coming soon', 'info');
            // TODO: Implement PPT export using PptxGenJS
        }
        
        function exportToPNG() {
            try {
                const dashboard = document.querySelector('.p-4.md\\:p-6');
                html2canvas(dashboard, {
                    scale: 2,
                    backgroundColor: '#f9fafb',
                    logging: false
                }).then(canvas => {
                    const link = document.createElement('a');
                    const timestamp = new Date().toISOString().split('T')[0];
                    link.download = `portfolio_dashboard_${timestamp}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                    showNotification('Success', 'Dashboard exported as PNG', 'success');
                });
            } catch (error) {
                console.error('PNG export error:', error);
                showNotification('Error', 'Failed to export as PNG', 'error');
            }
        }
        
        // Update Report Date
        function updateReportDate() {
            if (portfolioData && portfolioData.length > 0) {
                // Get the most recent Report_Date from the data
                let maxDate = null;
                for (let i = 0; i < portfolioData.length; i++) {
                    const dateStr = portfolioData[i].Report_Date;
                    if (dateStr) {
                        const date = parseDate(dateStr);
                        if (date && (!maxDate || date > maxDate)) {
                            maxDate = date;
                        }
                    }
                }
                
                if (maxDate) {
                    const formatted = formatDate(maxDate);
                    document.getElementById('reportDate').textContent = formatted;
                } else {
                    document.getElementById('reportDate').textContent = 'N/A';
                }
            }
        }

        // Calculate top metrics (OPTIMIZED with caching)
        function calculateMetrics() {
            // Check cache
            if (metricsCache.full) {
                const cached = metricsCache.full;
                document.getElementById('totalRelationships').textContent = cached.relationships.toLocaleString();
                document.getElementById('totalFacilities').textContent = cached.facilities.toLocaleString();
                document.getElementById('totalOSUC').textContent = formatCurrency(cached.osuc);
                document.getElementById('totalFacAmount').textContent = formatCurrency(cached.facAmount);
                return;
            }
            
            const startTime = performance.now();
            
            let totalFacAmount = 0;
            let totalOSUC = 0;
            const relationships = new Set();
            const facilities = new Set();
            
            // Single pass through data (much faster than multiple passes)
            for (let i = 0; i < portfolioData.length; i++) {
                const row = portfolioData[i];
                
                totalFacAmount += parseNumber(row.Fac_Amount);
                totalOSUC += parseNumber(row.Direct_OS);
                
                const rel = row.Relationship_Name || row.Relationship_ID;
                if (rel) relationships.add(rel);
                
                if (row.Facility_ID) facilities.add(row.Facility_ID);
            }
            
            const metrics = {
                relationships: relationships.size,
                facilities: facilities.size,
                osuc: totalOSUC,
                facAmount: totalFacAmount
            };
            
            // Cache the results
            metricsCache.full = metrics;
            
            document.getElementById('totalRelationships').textContent = metrics.relationships.toLocaleString();
            document.getElementById('totalFacilities').textContent = metrics.facilities.toLocaleString();
            document.getElementById('totalOSUC').textContent = formatCurrency(metrics.osuc);
            document.getElementById('totalFacAmount').textContent = formatCurrency(metrics.facAmount);
            
            console.log(`Metrics calculated in ${(performance.now() - startTime).toFixed(2)}ms:`, metrics);
        }

        // Parse number that might be formatted (e.g., "5.5M", "1.2K", "1,000,000")
        function parseNumber(value) {
            if (!value) return 0;
            
            // If already a number, return it
            if (typeof value === 'number') return value;
            
            // Convert to string and clean
            let str = String(value).trim().toUpperCase();
            
            // Remove currency symbols and commas
            str = str.replace(/[$,]/g, '');
            
            // Handle K (thousands)
            if (str.endsWith('K')) {
                return parseFloat(str.replace('K', '')) * 1000;
            }
            
            // Handle M (millions)
            if (str.endsWith('M')) {
                return parseFloat(str.replace('M', '')) * 1000000;
            }
            
            // Handle B (billions)
            if (str.endsWith('B')) {
                return parseFloat(str.replace('B', '')) * 1000000000;
            }
            
            // Regular number
            return parseFloat(str) || 0;
        }
        
        // Format currency with M/B notation
        function formatCurrency(value) {
            if (!value || value === 0) return '$0';
            
            const absValue = Math.abs(value);
            
            // Billions
            if (absValue >= 1000000000) {
                return '$' + (value / 1000000000).toFixed(2) + 'B';
            }
            
            // Millions
            if (absValue >= 1000000) {
                return '$' + (value / 1000000).toFixed(2) + 'M';
            }
            
            // Thousands
            if (absValue >= 1000) {
                return '$' + (value / 1000).toFixed(2) + 'K';
            }
            
            // Less than 1000
            return '$' + value.toFixed(2);
        }
        
        // Format currency for detailed display (with commas)
        function formatCurrencyDetailed(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = parseDate(dateString);
            if (!date) return 'N/A';
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        // Create expiration timeline chart (Area chart for Facilities only)
        function createExpirationChart() {
            console.log(' Creating expiration chart with', portfolioData.length, 'records');
            
            // Update title to "Facilities Expiring in the Next 3 Months" (no filter applied)
            const titleElement = document.getElementById('expirationChartTitle');
            if (titleElement) {
                titleElement.textContent = 'Facilities Expiring in the Next 3 Months';
            }
            
            const expirationData = aggregateExpirationData(portfolioData);
            
            console.log('Aggregated expiration data:', expirationData);
            
            // Handle empty data
            if (!expirationData || expirationData.allMonths.length === 0) {
                console.warn(' No expiration data found for the next 3 months');
                document.getElementById('totalExpiring').textContent = '0';
                
                // Show empty chart message
                const chartElement = document.querySelector("#expirationChart");
                if (chartElement) {
                    chartElement.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">No data expiring in the next 3 months</div>';
                }
                return;
            }
            
            const allMonths = expirationData.allMonths;
            console.log('Months with data:', allMonths);
            
            const facilitySeries = expirationData.facilities.map(d => d.count);
            
            console.log('Facility series:', facilitySeries);
            
            // Calculate total expiring facilities
            const totalExpiring = facilitySeries.reduce((a, b) => a + b, 0);
            console.log('Total facilities expiring:', totalExpiring);
            document.getElementById('totalExpiring').textContent = totalExpiring.toLocaleString();
            
            const options = {
                series: [
                    {
                        name: 'Facilities',
                        data: facilitySeries
                    }
                ],
                legend: {
                    show: false,
                    position: 'top',
                    horizontalAlign: 'left'
                },
                colors: ['#465FFF'],
                chart: {
                    fontFamily: 'system-ui, -apple-system, sans-serif',
                    height: 310,
                    type: 'area',
                    toolbar: {
                        show: false
                    }
                },
                fill: {
                    gradient: {
                        enabled: true,
                        opacityFrom: 0.55,
                        opacityTo: 0
                    }
                },
                stroke: {
                    curve: 'smooth',
                    width: [2]
                },
                markers: {
                    size: 0
                },
                labels: {
                    show: false,
                    position: 'top'
                },
                grid: {
                    xaxis: {
                        lines: {
                            show: false
                        }
                    },
                    yaxis: {
                        lines: {
                            show: true
                        }
                    }
                },
                dataLabels: {
                    enabled: false
                },
                tooltip: {
                    x: {
                        formatter: function(value, { dataPointIndex }) {
                            const monthStr = allMonths[dataPointIndex];
                            if (monthStr) {
                                const date = new Date(monthStr + '-01');
                                return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                            }
                            return value;
                        }
                    }
                },
                xaxis: {
                    type: 'category',
                    categories: allMonths.map(m => {
                        const date = new Date(m + '-01');
                        return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    }),
                    axisBorder: {
                        show: false
                    },
                    axisTicks: {
                        show: false
                    }
                },
                yaxis: {
                    title: {
                        style: {
                            fontSize: '0px'
                        }
                    }
                }
            };

            // Get the chart element and verify it exists
            const chartElement = document.querySelector("#expirationChart");
            if (!chartElement) {
                console.error('Expiration chart element #expirationChart not found in DOM');
                return;
            }
            
            // Verify ApexCharts is loaded
            if (typeof ApexCharts === 'undefined') {
                console.error('ApexCharts library not loaded');
                return;
            }
            
            try {
                // Destroy previous instance
                if (expirationChartInstance) {
                    expirationChartInstance.destroy();
                    expirationChartInstance = null;
                }
                
                // Clear any previous content to avoid ApexCharts errors
                chartElement.innerHTML = '';
                
                // Create and render new chart
                expirationChartInstance = new ApexCharts(chartElement, options);
                expirationChartInstance.render();
                console.log(' Expiration chart rendered successfully with Facilities series');
            } catch (error) {
                console.error(' Error rendering expiration chart:', error);
                console.error('Error details:', error.message, error.stack);
            }
        }

        // Select trend level (facility or relationship)
        function selectTrendLevel(level) {
            console.log(' Trend level toggle clicked:', level);
            selectedTrendLevel = level;
            
            // Update button styles
            const btnFacility = document.getElementById('btnTrendFacilityLevel');
            const btnRelationship = document.getElementById('btnTrendRelationshipLevel');
            
            if (level === 'facility') {
                btnFacility.className = 'px-3 py-2 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white';
                btnRelationship.className = 'px-3 py-2 font-medium transition-colors rounded-md text-xs text-gray-500 hover:text-gray-900';
            } else {
                btnFacility.className = 'px-3 py-2 font-medium transition-colors rounded-md text-xs text-gray-500 hover:text-gray-900';
                btnRelationship.className = 'px-3 py-2 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white';
            }
            
            // Update the chart
            if (Object.keys(activeFilters).length > 0) {
                createFacilityTrendChartFromFiltered();
            } else {
                createFacilityTrendChart();
            }
        }

        // Create facility amount trend bar chart
        function createFacilityTrendChart() {
            console.log(' Creating facility trend chart, level:', selectedTrendLevel);
            
            // Calculate date range: last 12 months
            const today = new Date();
            const twelveMonthsAgo = new Date(today);
            twelveMonthsAgo.setMonth(twelveMonthsAgo.getMonth() - 12);
            
            // Group by month-year and aggregate Facility Amount
            const monthlyData = {}; // { 'YYYY-MM': { facilities: Set, relationships: Set, amount: 0 } }
            
            portfolioData.forEach(row => {
                const reportDate = row.Report_Date;
                if (reportDate) {
                    const dateObj = parseDate(reportDate);
                    if (dateObj && dateObj >= twelveMonthsAgo && dateObj <= today) {
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                        const monthYear = `${year}-${month}`;
                        
                        if (!monthlyData[monthYear]) {
                            monthlyData[monthYear] = {
                                facilities: new Set(),
                                relationships: new Set(),
                                amount: 0
                            };
                        }
                        
                        // Track unique IDs
                        if (row.Facility_ID) {
                            monthlyData[monthYear].facilities.add(row.Facility_ID);
                        }
                        if (row.Relationship_ID || row.Relationship_Name) {
                            monthlyData[monthYear].relationships.add(row.Relationship_ID || row.Relationship_Name);
                        }
                        
                        // Sum facility amount
                        const amount = parseNumber(row.Fac_Amount);
                        if (amount > 0) {
                            monthlyData[monthYear].amount += amount;
                        }
                    }
                }
            });
            
            // Get all months sorted
            const allMonths = Object.keys(monthlyData).sort();
            console.log('Months with data:', allMonths);
            
            // Determine which count to use based on selected level
            const categories = allMonths.map(m => {
                const date = new Date(m + '-01');
                return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            });
            
            const amounts = allMonths.map(month => {
                return monthlyData[month].amount;
            });
            
            console.log('Monthly amounts:', amounts);
            
            // Handle empty data
            if (allMonths.length === 0) {
                const chartElement = document.querySelector("#facilityTrendChart");
                if (chartElement) {
                    chartElement.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">No data available for the last 12 months</div>';
                }
                return;
            }
            
            const options = {
                series: [{
                    name: 'Facility Amount',
                    data: amounts
                }],
                chart: {
                    type: 'bar',
                    height: 310,
                    fontFamily: 'system-ui, -apple-system, sans-serif',
                    toolbar: {
                        show: false
                    }
                },
                plotOptions: {
                    bar: {
                        borderRadius: 4,
                        columnWidth: '60%'
                    }
                },
                colors: ['#465FFF'],
                dataLabels: {
                    enabled: false
                },
                xaxis: {
                    categories: categories,
                    axisBorder: {
                        show: false
                    },
                    axisTicks: {
                        show: false
                    },
                    labels: {
                        style: {
                            fontSize: '11px'
                        }
                    }
                },
                yaxis: {
                    labels: {
                        formatter: function(val) {
                            return formatCurrency(val);
                        }
                    }
                },
                grid: {
                    borderColor: '#E5E7EB',
                    xaxis: {
                        lines: {
                            show: false
                        }
                    },
                    yaxis: {
                        lines: {
                            show: true
                        }
                    }
                },
                tooltip: {
                    y: {
                        formatter: function(val) {
                            return formatCurrency(val);
                        }
                    }
                }
            };

            // Get the chart element and verify it exists
            const chartElement = document.querySelector("#facilityTrendChart");
            if (!chartElement) {
                console.error('Facility trend chart element #facilityTrendChart not found in DOM');
                return;
            }
            
            // Verify ApexCharts is loaded
            if (typeof ApexCharts === 'undefined') {
                console.error('ApexCharts library not loaded');
                return;
            }
            
            try {
                // Destroy previous instance
                if (facilityTrendChartInstance) {
                    facilityTrendChartInstance.destroy();
                    facilityTrendChartInstance = null;
                }
                
                // Clear any previous content
                chartElement.innerHTML = '';
                
                // Create and render new chart
                facilityTrendChartInstance = new ApexCharts(chartElement, options);
                facilityTrendChartInstance.render();
                console.log(' Facility trend chart rendered successfully');
            } catch (error) {
                console.error(' Error rendering facility trend chart:', error);
            }
        }

        // Create facility trend chart from filtered data
        function createFacilityTrendChartFromFiltered() {
            console.log(' Creating filtered facility trend chart, level:', selectedTrendLevel);
            
            // Calculate date range: last 12 months
            const today = new Date();
            const twelveMonthsAgo = new Date(today);
            twelveMonthsAgo.setMonth(twelveMonthsAgo.getMonth() - 12);
            
            // Group by month-year and aggregate Facility Amount
            const monthlyData = {}; // { 'YYYY-MM': { facilities: Set, relationships: Set, amount: 0 } }
            
            filteredData.forEach(row => {
                const reportDate = row.Report_Date;
                if (reportDate) {
                    const dateObj = parseDate(reportDate);
                    if (dateObj && dateObj >= twelveMonthsAgo && dateObj <= today) {
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                        const monthYear = `${year}-${month}`;
                        
                        if (!monthlyData[monthYear]) {
                            monthlyData[monthYear] = {
                                facilities: new Set(),
                                relationships: new Set(),
                                amount: 0
                            };
                        }
                        
                        // Track unique IDs
                        if (row.Facility_ID) {
                            monthlyData[monthYear].facilities.add(row.Facility_ID);
                        }
                        if (row.Relationship_ID || row.Relationship_Name) {
                            monthlyData[monthYear].relationships.add(row.Relationship_ID || row.Relationship_Name);
                        }
                        
                        // Sum facility amount
                        const amount = parseNumber(row.Fac_Amount);
                        if (amount > 0) {
                            monthlyData[monthYear].amount += amount;
                        }
                    }
                }
            });
            
            // Get all months sorted
            const allMonths = Object.keys(monthlyData).sort();
            
            // Handle empty data
            if (allMonths.length === 0) {
                const chartElement = document.querySelector("#facilityTrendChart");
                if (chartElement) {
                    chartElement.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">No filtered data available for the last 12 months</div>';
                }
                return;
            }
            
            const categories = allMonths.map(m => {
                const date = new Date(m + '-01');
                return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            });
            
            const amounts = allMonths.map(month => {
                return monthlyData[month].amount;
            });
            
            const options = {
                series: [{
                    name: 'Facility Amount',
                    data: amounts
                }],
                chart: {
                    type: 'bar',
                    height: 310,
                    fontFamily: 'system-ui, -apple-system, sans-serif',
                    toolbar: {
                        show: false
                    }
                },
                plotOptions: {
                    bar: {
                        borderRadius: 4,
                        columnWidth: '60%'
                    }
                },
                colors: ['#465FFF'],
                dataLabels: {
                    enabled: false
                },
                xaxis: {
                    categories: categories,
                    axisBorder: {
                        show: false
                    },
                    axisTicks: {
                        show: false
                    },
                    labels: {
                        style: {
                            fontSize: '11px'
                        }
                    }
                },
                yaxis: {
                    labels: {
                        formatter: function(val) {
                            return formatCurrency(val);
                        }
                    }
                },
                grid: {
                    borderColor: '#E5E7EB',
                    xaxis: {
                        lines: {
                            show: false
                        }
                    },
                    yaxis: {
                        lines: {
                            show: true
                        }
                    }
                },
                tooltip: {
                    y: {
                        formatter: function(val) {
                            return formatCurrency(val);
                        }
                    }
                }
            };

            const chartElement = document.querySelector("#facilityTrendChart");
            if (!chartElement) {
                console.error('Facility trend chart element not found');
                return;
            }
            
            if (typeof ApexCharts === 'undefined') {
                console.error('ApexCharts library not loaded');
                return;
            }
            
            try {
                if (facilityTrendChartInstance) {
                    facilityTrendChartInstance.destroy();
                    facilityTrendChartInstance = null;
                }
                
                chartElement.innerHTML = '';
                
                facilityTrendChartInstance = new ApexCharts(chartElement, options);
                facilityTrendChartInstance.render();
                console.log(' Filtered facility trend chart rendered successfully');
            } catch (error) {
                console.error(' Error rendering filtered facility trend chart:', error);
            }
        }

        // Parse date in multiple formats (YYYY-MM-DD, DD/MM/YYYY, etc.)
        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            // If it's already a Date object (from Excel parsing), return it
            if (dateStr instanceof Date) {
                return !isNaN(dateStr.getTime()) ? dateStr : null;
            }
            
            // Convert to string for parsing
            const str = String(dateStr).trim();
            if (!str) return null;
            
            try {
                // Handle YYYY-MM-DD format (most common in CSV)
                if (str.includes('-')) {
                    const parts = str.split('-');
                    if (parts.length === 3) {
                        // Check if it's YYYY-MM-DD
                        if (parts[0].length === 4) {
                            const year = parseInt(parts[0]);
                            const month = parseInt(parts[1]) - 1; // JavaScript months are 0-indexed
                            const day = parseInt(parts[2]);
                            const date = new Date(year, month, day);
                            if (!isNaN(date.getTime())) {
                                return date;
                            }
                        }
                    }
                }
                
                // Handle DD/MM/YYYY format
                if (str.includes('/')) {
                    const parts = str.split('/');
                    if (parts.length === 3) {
                        const day = parseInt(parts[0]);
                        const month = parseInt(parts[1]) - 1; // JavaScript months are 0-indexed
                        const year = parseInt(parts[2]);
                        const date = new Date(year, month, day);
                        if (!isNaN(date.getTime())) {
                            return date;
                        }
                    }
                }
                
                // Try standard date parsing as fallback
                const date = new Date(str);
                if (!isNaN(date.getTime())) {
                    return date;
                }
            } catch (e) {
                // Only log occasionally to avoid console spam
                if (Math.random() < 0.01) {
                    console.warn('Invalid date:', str);
                }
            }
            return null;
        }

        // Aggregate expiration data for the next 3 months (counts unique Facilities only)
        function aggregateExpirationData(data) {
            console.log(` Aggregating expiration data for ${data.length} rows (next 3 months only)`);
            
            // Calculate date range: today to 3 months from now
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Start of today
            const threeMonthsLater = new Date(today);
            threeMonthsLater.setMonth(threeMonthsLater.getMonth() + 3);
            
            console.log(`  Date range: ${today.toLocaleDateString()} to ${threeMonthsLater.toLocaleDateString()}`);
            
            // Group by month-year with Sets to track unique Facility IDs
            const facilitiesByMonth = {};    // { 'YYYY-MM': Set<Facility_ID> }
            
            let validMaturityDates = 0;
            let filteredCount = 0;
            
            data.forEach((row, index) => {
                // Check Maturity_Date for facilities
                const maturityDate = row.Maturity_Date;
                if (maturityDate) {
                    const dateObj = parseDate(maturityDate);
                    if (dateObj && dateObj >= today && dateObj <= threeMonthsLater) {
                        validMaturityDates++;
                        filteredCount++;
                        
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                        const monthYear = `${year}-${month}`;
                        
                        // Track unique Facility IDs
                        if (row.Facility_ID) {
                            if (!facilitiesByMonth[monthYear]) {
                                facilitiesByMonth[monthYear] = new Set();
                            }
                            facilitiesByMonth[monthYear].add(row.Facility_ID);
                        }
                        
                        // Log first few for debugging
                        if (index < 3) {
                            console.log(`  Row ${index}: Maturity=${maturityDate}  ${monthYear}, Facility=${row.Facility_ID}`);
                        }
                    }
                }
            });
            
            console.log(`  Valid maturity dates in range: ${validMaturityDates}`);
            console.log(`  Unique months: ${Object.keys(facilitiesByMonth).length}`);
            
            // Get all unique months and sort
            const allMonths = Object.keys(facilitiesByMonth).sort();
            
            // Convert Sets to counts
            const facilityData = allMonths.map(month => ({
                month,
                count: facilitiesByMonth[month] ? facilitiesByMonth[month].size : 0
            }));
            
            return {
                facilities: facilityData,
                allMonths
            };
        }

        // Aggregate data by month and year
        function aggregateByMonthYear(data, dateField) {
            console.log(`Aggregating ${data.length} rows by ${dateField}`);
            const grouped = {};
            let validDates = 0;
            let invalidDates = 0;
            
            data.forEach((row, index) => {
                const dateValue = row[dateField];
                if (dateValue) {
                    const dateObj = parseDate(dateValue);
                    if (dateObj) {
                        validDates++;
                        // Format as YYYY-MM
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                        const monthYear = `${year}-${month}`;
                        grouped[monthYear] = (grouped[monthYear] || 0) + 1;
                        
                        // Log first few dates for debugging
                        if (index < 3) {
                            console.log(`  Row ${index}: ${dateField}="${dateValue}"  ${monthYear}`);
                        }
                    } else {
                        invalidDates++;
                        if (index < 3) {
                            console.log(`  Row ${index}: ${dateField}="${dateValue}"  INVALID`);
                        }
                    }
                } else {
                    invalidDates++;
                }
            });
            
            console.log(`Valid dates: ${validDates}, Invalid/Empty: ${invalidDates}`);
            console.log(`Unique months: ${Object.keys(grouped).length}`);
            
            return Object.entries(grouped)
                .map(([month, count]) => ({ month, count }))
                .sort((a, b) => a.month.localeCompare(b.month));
        }

        // Aggregate data by date
        function aggregateByDate(data, dateField) {
            const grouped = {};
            data.forEach(row => {
                const date = row[dateField];
                if (date) {
                    const monthYear = date.substring(0, 7); // YYYY-MM
                    grouped[monthYear] = (grouped[monthYear] || 0) + 1;
                }
            });
            
            return Object.entries(grouped)
                .map(([date, count]) => ({ date: date + '-01', count }))
                .sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        // Initialize world map
        function initializeMap() {
            try {
                const mapElement = document.getElementById('mapOne');
                if (!mapElement) {
                    console.warn('Map element #mapOne not found, skipping map initialization');
                    return;
                }
                
                // Check if jsVectorMap is available
                if (typeof jsVectorMap === 'undefined') {
                    console.warn('jsVectorMap library not loaded, skipping map initialization');
                    return;
                }
                
                // Get region coordinates for markers
                const regionCoords = {
                    'NAM': { coords: [37.0902, -95.7129], name: 'United States' },
                    'EMEA': { coords: [49.6116, 6.1319], name: 'Luxembourg' },
                    'APAC': { coords: [3.1390, 101.6869], name: 'Malaysia' },
                    'LATAM': { coords: [-23.5505, -46.6333], name: 'Brazil' },
                    'MEA': { coords: [25.2048, 55.2708], name: 'Middle East' }
                };
                
                const regionCounts = getRegionCounts();
                console.log('Region counts for map:', regionCounts);
                
                const markers = [];
                
                Object.keys(regionCounts).forEach(region => {
                    if (regionCoords[region]) {
                        markers.push({
                            name: regionCoords[region].name,
                            coords: regionCoords[region].coords
                        });
                    }
                });
                
                // Destroy existing map instance if it exists
                if (mapInstance) {
                    try {
                        mapInstance.destroy();
                        mapInstance = null;
                    } catch (e) {
                        console.warn('  Error destroying map:', e);
                    }
                }
                
                // Clear existing map DOM
                mapElement.innerHTML = '';
                
                // Small delay to ensure DOM is ready
                setTimeout(() => {
                    mapInstance = new jsVectorMap({
                        selector: '#mapOne',
                        map: 'world',
                        zoomButtons: false,
                        regionStyle: {
                            initial: {
                                fill: '#D9D9D9'
                            },
                            hover: {
                                fillOpacity: 1,
                                fill: '#465fff'
                            }
                        },
                        markers: markers,
                        markerStyle: {
                            initial: {
                                strokeWidth: 1,
                                fill: '#465fff',
                                fillOpacity: 1,
                        r: 4
                    },
                    hover: {
                        fill: '#465fff',
                        fillOpacity: 1
                    }
                }
            });
                    console.log(' Map initialized successfully with', markers.length, 'markers');
                }, 50); // Small delay to ensure DOM is ready
            } catch (error) {
                console.error('Error initializing map:', error);
                // Map is optional, continue without it
            }
        }
        
        // Get region counts for facilities expiring soon
        function getRegionCounts() {
            console.log(' getRegionCounts called');
            const regionCounts = {};
            const today = new Date();
            const threeMonthsLater = new Date(today.getTime() + 90 * 24 * 60 * 60 * 1000);
            
            // Count unique Facility IDs
            console.log('Counting Facility IDs by region (expiring in next 90 days)');
            const regionFacilities = {};
            let totalExpiring = 0;
            
            portfolioData.forEach(row => {
                const maturityDate = parseDate(row.Maturity_Date);
                if (maturityDate && maturityDate <= threeMonthsLater && maturityDate >= today) {
                    const region = row.Region || 'Unknown';
                    const facilityId = row.Facility_ID;
                    
                    if (!regionFacilities[region]) {
                        regionFacilities[region] = new Set();
                    }
                    if (facilityId) {
                        regionFacilities[region].add(facilityId);
                        totalExpiring++;
                    }
                }
            });
            
            // Convert Set sizes to counts
            Object.keys(regionFacilities).forEach(region => {
                regionCounts[region] = regionFacilities[region].size;
            });
            
            console.log(`Found ${totalExpiring} expiring facilities across ${Object.keys(regionCounts).length} regions:`, regionCounts);
            
            return regionCounts;
        }
        
        // Create regional distribution chart with map and list
        function createRegionalChart() {
            initializeMap();
            
            const regionCounts = getRegionCounts();
            const totalCount = Object.values(regionCounts).reduce((a, b) => a + b, 0);
            
            // Sort regions by count (descending)
            const sortedRegions = Object.entries(regionCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5); // Top 5 regions
            
            // Region flag/icon mapping
            const regionInfo = {
                'NAM': { code: 'NAM', name: 'United States', color: 'bg-blue-500' },
                'EMEA': { code: 'EMEA', name: 'Luxembourg', color: 'bg-green-500' },
                'APAC': { code: 'APAC', name: 'Malaysia', color: 'bg-orange-500' },
                'LATAM': { code: 'LATAM', name: 'Brazil', color: 'bg-purple-500' },
                'MEA': { code: 'MEA', name: 'Middle East & Africa', color: 'bg-red-500' }
            };
            
            const regionList = document.getElementById('regionList');
            regionList.innerHTML = '';
            
            const countLabel = 'Facilities';
            
            sortedRegions.forEach(([region, count]) => {
                const percentage = totalCount > 0 ? ((count / totalCount) * 100).toFixed(0) : 0;
                const info = regionInfo[region] || { code: region, name: region, color: 'bg-gray-500' };
                
                const regionItem = document.createElement('div');
                regionItem.className = 'flex items-center justify-between';
                regionItem.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 flex items-center justify-center rounded-full ${info.color} text-white font-semibold text-xs">
                            ${info.code}
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-gray-800">${info.code}</p>
                            <span class="block text-xs text-gray-500">${count} ${countLabel}</span>
                        </div>
                    </div>
                    <div class="flex w-full max-w-[140px] items-center gap-3">
                        <div class="relative block h-2 w-full max-w-[100px] rounded-sm bg-gray-200">
                            <div class="absolute left-0 top-0 flex h-full items-center justify-center rounded-sm bg-blue-500 text-xs font-medium text-white"
                                style="width: ${percentage}%"></div>
                        </div>
                        <p class="text-sm font-medium text-gray-800">${percentage}%</p>
                    </div>
                `;
                regionList.appendChild(regionItem);
            });
        }

        // Create relationship bar chart (OPTIMIZED)
        function createRelationshipChart() {
            const startTime = performance.now();
            const topN = parseInt(document.getElementById('topNFilter').value);
            
            // Always use Facility Amount
            const fieldName = 'Fac_Amount';
            const seriesName = 'Facility Amount';
            
            console.log('Creating relationship chart, field:', fieldName, 'dataLength:', portfolioData.length);
            
            // Use Map for better performance with large datasets
            const relationshipTotals = new Map();
            
            for (let i = 0; i < portfolioData.length; i++) {
                const row = portfolioData[i];
                const relId = row.Relationship_Name || row.Relationship_ID;
                const amount = parseNumber(row[fieldName]);
                
                // Debug first few rows
                if (i < 3) {
                    console.log(`Row ${i}: relId="${relId}", amount=${amount}, fieldName=${fieldName}, row[fieldName]=${row[fieldName]}`);
                }
                
                if (relId && amount > 0) {
                    relationshipTotals.set(relId, (relationshipTotals.get(relId) || 0) + amount);
                }
            }
            
            console.log('Total unique relationships:', relationshipTotals.size);
            
            // Convert to array and sort (only what we need)
            const sorted = Array.from(relationshipTotals.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, topN);
            
            console.log(`Chart aggregated ${portfolioData.length} rows, found ${relationshipTotals.size} relationships in ${(performance.now() - startTime).toFixed(2)}ms`);
            
            // Add index numbers (1, 2, 3, ...) before relationship names
            const relationships = sorted.map((item, index) => `${index + 1}. ${item[0]}`);
            const amounts = sorted.map(item => item[1]);
            
            // Handle empty data
            if (relationships.length === 0) {
                console.warn('No relationship data for chart');
                return;
            }
            
            const options = {
                series: [{
                    name: seriesName,
                    data: amounts
                }],
                colors: ['#465fff'],
                chart: {
                    fontFamily: 'Outfit, sans-serif',
                    type: 'bar',
                    height: 350,
                    toolbar: {
                        show: false
                    }
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        borderRadius: 5,
                        borderRadiusApplication: 'end'
                    }
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    show: true,
                    width: 4,
                    colors: ['transparent']
                },
                xaxis: {
                    labels: {
                        formatter: function(val) {
                            return formatCurrency(val);
                        }
                    },
                    axisBorder: {
                        show: false
                    },
                    axisTicks: {
                        show: false
                    }
                },
                yaxis: {
                    categories: relationships,
                    title: false,
                    labels: {
                        style: {
                            fontSize: '12px'
                        }
                    }
                },
                legend: {
                    show: true,
                    position: 'top',
                    horizontalAlign: 'left',
                    fontFamily: 'Outfit',
                    markers: {
                        radius: 99
                    }
                },
                grid: {
                    yaxis: {
                        lines: {
                            show: false
                        }
                    }
                },
                fill: {
                    opacity: 1
                },
                tooltip: {
                    x: {
                        show: false
                    },
                    y: {
                        formatter: function(val) {
                            return formatCurrency(val);
                        }
                    }
                }
            };

            // Get the chart element and verify it exists
            const chartElement = document.querySelector("#relationshipChart");
            if (!chartElement) {
                console.error('Relationship chart element #relationshipChart not found in DOM');
                return;
            }
            
            // Verify ApexCharts is loaded
            if (typeof ApexCharts === 'undefined') {
                console.error('ApexCharts library not loaded');
                return;
            }
            
            try {
                // Destroy previous instance
                if (relationshipChartInstance) {
                    relationshipChartInstance.destroy();
                    relationshipChartInstance = null;
                }
                
                // Clear any previous content to avoid ApexCharts errors
                chartElement.innerHTML = '';
                
                // Create and render new chart
                relationshipChartInstance = new ApexCharts(chartElement, options);
                relationshipChartInstance.render();
                console.log(' Relationship chart rendered successfully with', relationships.length, 'relationships');
            } catch (error) {
                console.error(' Error creating relationship chart:', error);
                console.error('Error details:', error.message, error.stack);
            }
        }


        // Update bar chart
        function updateBarChart() {
            if (Object.keys(activeFilters).length > 0) {
                createRelationshipChartFromFiltered();
            } else {
                createRelationshipChart();
            }
        }

        // Filter data based on search (works with existing filters)
        function filterData() {
            const startTime = performance.now();
            
            // If no filters are active, just apply search to all data
            if (Object.keys(activeFilters).length === 0) {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                
                if (searchTerm === '') {
                    filteredData = [...portfolioData];
                    
                    // No search term, show all data - update charts to show full data
                    requestAnimationFrame(() => {
                        createExpirationChart();
                        createFacilityTrendChart();
                        createRegionalChart();
                        createRelationshipChart();
                    });
                } else {
                    // Optimized search
                    filteredData = [];
                    for (let i = 0; i < portfolioData.length; i++) {
                        const row = portfolioData[i];
                        let found = false;
                        for (const value of Object.values(row)) {
                            if (String(value).toLowerCase().includes(searchTerm)) {
                                found = true;
                                break;
                            }
                        }
                        if (found) filteredData.push(row);
                    }
                    
                    // Search term is active, update charts with filtered data
                    requestAnimationFrame(() => {
                        calculateMetricsFromFiltered();
                        createExpirationChartFromFiltered();
                        createFacilityTrendChartFromFiltered();
                        createRegionalChartFromFiltered();
                        createRelationshipChartFromFiltered();
                    });
                }
                
                const elapsed = (performance.now() - startTime).toFixed(0);
                const perfEl = document.getElementById('perfIndicator');
                if (perfEl) {
                    perfEl.textContent = `(${elapsed}ms)`;
                    perfEl.className = elapsed < 100 ? 'text-green-600 font-medium' : 'text-orange-600 font-medium';
                }
                
                currentPage = 1;
                renderTable();
            } else {
                // If filters are active, reapply them (which will include search)
                applyFilters();
            }
        }

        // Render table (optimized for large datasets)
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const startIdx = (currentPage - 1) * rowsPerPage;
            const endIdx = startIdx + rowsPerPage;
            const pageData = filteredData.slice(startIdx, endIdx);
            
            // Use requestAnimationFrame for smooth rendering
            requestAnimationFrame(() => {
                // Use DocumentFragment for batch DOM insertion (much faster)
                const fragment = document.createDocumentFragment();
                
                pageData.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="p-4 text-sm text-gray-700 whitespace-nowrap">${formatDate(row.Report_Date)}</td>
                        <td class="p-4 text-sm text-gray-700 whitespace-nowrap">${row.Region || 'N/A'}</td>
                        <td class="p-4 text-sm font-medium text-gray-800 whitespace-nowrap">${row.Facility_ID || 'N/A'}</td>
                        <td class="p-4 text-sm text-gray-700">${row.Relationship_Name || 'N/A'}</td>
                        <td class="p-4 text-sm text-gray-700">${row.Product_Program || 'N/A'}</td>
                        <td class="p-4 text-sm font-medium text-gray-800 whitespace-nowrap">${formatCurrencyDetailed(parseNumber(row.Fac_Amount))}</td>
                        <td class="p-4 text-sm text-gray-700 whitespace-nowrap">${formatCurrencyDetailed(parseNumber(row.Direct_OS))}</td>
                        <td class="p-4 text-sm text-gray-700 whitespace-nowrap">${formatDate(row.Maturity_Date)}</td>
                        <td class="p-4 text-sm text-gray-700 whitespace-nowrap">${formatDate(row.CA_Expiration_Date)}</td>
                    `;
                    fragment.appendChild(tr);
                });
                
                // Single DOM operation instead of multiple
                tbody.innerHTML = '';
                tbody.appendChild(fragment);
                updatePagination();
            });
        }

        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            const startRow = (currentPage - 1) * rowsPerPage + 1;
            const endRow = Math.min(currentPage * rowsPerPage, filteredData.length);
            
            document.getElementById('startRow').textContent = filteredData.length > 0 ? startRow : 0;
            document.getElementById('endRow').textContent = endRow;
            document.getElementById('totalRows').textContent = filteredData.length;
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
            
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages || totalPages === 0;
        }

        // Pagination functions
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        }

    </script>
</body>
</html>

