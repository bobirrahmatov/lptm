<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portfolio Analytics Lending</title>
    <!-- Alpine.js for reactive components -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        success: {
                            50: '#f0fdf4',
                            500: '#10b981',
                            600: '#059669',
                            700: '#047857'
                        },
                        danger: '#dc2626',
                        warning: '#f59e0b'
                    },
                    boxShadow: {
                        'theme-lg': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    </script>
    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- SheetJS for Excel/CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- html2canvas for PNG export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Custom scrollbar styles */
        .custom-scrollbar::-webkit-scrollbar {
            height: 6px;
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* TailAdmin custom theme sizes */
        .text-theme-sm {
            font-size: 0.875rem;
            /* 14px */
            line-height: 1.25rem;
            /* 20px */
        }

        /* Chart dark style for consistent sizing */
        .chartDarkStyle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 280px;
            height: 280px;
        }
        
        @media (max-width: 640px) {
            .chartDarkStyle {
                width: 280px;
                height: 280px;
            }
        }
        
        @media (min-width: 2600px) {
            .chartDarkStyle {
                width: 240px;
                height: 240px;
            }
        }

        /* Consistent Tooltip Styling for All Charts */
        .apexcharts-tooltip {
            background: #ffffff !important;
            border: 1px solid #e5e7eb !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
            color: #1f2937 !important;
            border-radius: 8px !important;
        }
        
        .apexcharts-tooltip-custom {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .apexcharts-tooltip * {
            color: inherit !important;
        }
        
        .apexcharts-tooltip .apexcharts-tooltip-title {
            background: #f9fafb !important;
            border-bottom: 1px solid #e5e7eb !important;
            color: #1f2937 !important;
        }

        /* Notification animations */
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Z-index utilities */
        .z-9999 {
            z-index: 9999;
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Loading Overlay -->
    <div id="loadingOverlay"
        class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-[10000] flex items-center justify-center hidden">
        <div class="bg-white rounded-2xl p-8 shadow-2xl flex flex-col items-center gap-5 max-w-md mx-4 w-80">
            <!-- Spinning Circle -->
            <div class="relative">
                <div class="w-20 h-20 border-4 border-gray-200 border-t-blue-600 rounded-full animate-spin"></div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
            </div>
            </div>
            <!-- Text -->
            <div class="text-center w-full">
                <h3 class="text-lg font-semibold text-gray-900 mb-2" id="loadingMessage">
                    Loading Portfolio Data
                </h3>
                <p class="text-sm text-blue-600 font-medium" id="loadingProgress">
                    Please wait while we fetch your data...
                </p>
            </div>
            <!-- Progress Bar -->
            <div class="w-full">
                <div class="flex justify-between text-xs text-gray-500 mb-1">
                    <span>Progress</span>
                    <span id="loadingPercent">0%</span>
                </div>
                <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div id="loadingProgressBar" class="h-full bg-blue-600 rounded-full" style="width: 0%"></div>
                </div>
                <p class="text-xs text-gray-400 mt-2 text-center">
                    Large files may take a moment to process
                </p>
            </div>
        </div>
    </div>

    <div class="p-4 md:p-6" x-data="{ activeTab: 'overview' }">
        <!-- Tab Navigation -->
        <div class="mb-6">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-2 overflow-x-auto custom-scrollbar">
                    <button
                        class="inline-flex items-center gap-2 border-b-2 px-4 py-3 text-sm font-medium transition-colors duration-200 ease-in-out whitespace-nowrap"
                        :class="activeTab === 'overview' ? 'text-blue-600 border-blue-600' : 'bg-transparent text-gray-500 border-transparent hover:text-gray-700'"
                        @click="activeTab = 'overview'">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        Portfolio Overview
                    </button>
                    <button
                        class="inline-flex items-center gap-2 border-b-2 px-4 py-3 text-sm font-medium transition-colors duration-200 ease-in-out whitespace-nowrap"
                        :class="activeTab === 'balances' ? 'text-blue-600 border-blue-600' : 'bg-transparent text-gray-500 border-transparent hover:text-gray-700'"
                        @click="activeTab = 'balances'">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Portfolio Balances
                    </button>
                    <button
                        class="inline-flex items-center gap-2 border-b-2 px-4 py-3 text-sm font-medium transition-colors duration-200 ease-in-out whitespace-nowrap"
                        :class="activeTab === 'team' ? 'text-blue-600 border-blue-600' : 'bg-transparent text-gray-500 border-transparent hover:text-gray-700'"
                        @click="activeTab = 'team'">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        Team View
                    </button>
                    <button
                        class="inline-flex items-center gap-2 border-b-2 px-4 py-3 text-sm font-medium transition-colors duration-200 ease-in-out whitespace-nowrap"
                        :class="activeTab === 'topnames' ? 'text-blue-600 border-blue-600' : 'bg-transparent text-gray-500 border-transparent hover:text-gray-700'"
                        @click="activeTab = 'topnames'">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                        </svg>
                        Top Names
                    </button>
                    <button
                        class="inline-flex items-center gap-2 border-b-2 px-4 py-3 text-sm font-medium transition-colors duration-200 ease-in-out whitespace-nowrap"
                        :class="activeTab === 'covenants' ? 'text-blue-600 border-blue-600' : 'bg-transparent text-gray-500 border-transparent hover:text-gray-700'"
                        @click="activeTab = 'covenants'">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Covenants
                    </button>
                    <button
                        class="inline-flex items-center gap-2 border-b-2 px-4 py-3 text-sm font-medium transition-colors duration-200 ease-in-out whitespace-nowrap"
                        :class="activeTab === 'ccm' ? 'text-blue-600 border-blue-600' : 'bg-transparent text-gray-500 border-transparent hover:text-gray-700'"
                        @click="activeTab = 'ccm'">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Credit Reviews
                    </button>
                </nav>
            </div>
        </div>

        <!-- Portfolio Overview Tab Content -->
        <div x-show="activeTab === 'overview'">
        <!-- Page Header -->
        <div class="mb-6 rounded-2xl border border-gray-200 bg-white p-5">
            <!-- First Row: Search Bar, Action Buttons, and Last Updated -->
            <div class="flex items-center justify-between gap-4 mb-5">
                <!-- Left: Search Input -->
                <div class="relative flex-1 max-w-2xl">
                    <span class="pointer-events-none absolute top-1/2 left-4 -translate-y-1/2">
                        <svg class="fill-gray-500" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd"
                                d="M3.04199 9.37381C3.04199 5.87712 5.87735 3.04218 9.37533 3.04218C12.8733 3.04218 15.7087 5.87712 15.7087 9.37381C15.7087 12.8705 12.8733 15.7055 9.37533 15.7055C5.87735 15.7055 3.04199 12.8705 3.04199 9.37381ZM9.37533 1.54218C5.04926 1.54218 1.54199 5.04835 1.54199 9.37381C1.54199 13.6993 5.04926 17.2055 9.37533 17.2055C11.2676 17.2055 13.0032 16.5346 14.3572 15.4178L17.1773 18.2381C17.4702 18.531 17.945 18.5311 18.2379 18.2382C18.5308 17.9453 18.5309 17.4704 18.238 17.1775L15.4182 14.3575C16.5367 13.0035 17.2087 11.2671 17.2087 9.37381C17.2087 5.04835 13.7014 1.54218 9.37533 1.54218Z"
                                fill=""></path>
                        </svg>
                    </span>
                    <input type="text" id="searchInput" placeholder="Search facilities, relationships, or any data..." 
                        class="h-11 w-full rounded-lg border border-gray-300 bg-white py-3 pr-4 pl-12 text-sm text-gray-800 placeholder:text-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 focus:outline-none shadow-sm" />
                </div>
                
                <!-- Middle: Action Buttons -->
                <div class="flex items-center gap-2">
                    <button onclick="toggleFilterPopover()" id="filterButton"
                        class="relative flex items-center gap-1.5 rounded-lg border border-gray-300 bg-white px-3 py-2 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z">
                            </path>
                        </svg>
                        <span>More</span>
                        <span id="filterCount"
                            class="hidden absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-blue-500 text-[10px] font-bold text-white"></span>
                    </button>

                    <button onclick="resetAllFilters()" 
                        class="flex items-center gap-1.5 rounded-lg border border-gray-300 bg-white px-3 py-2 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                            </path>
                        </svg>
                        <span>Reset</span>
                    </button>

                    <!-- Export Dropdown -->
                    <div x-data="{ exportOpen: false }" class="relative">
                        <button @click="exportOpen = !exportOpen" @click.away="exportOpen = false"
                            class="flex items-center gap-1.5 rounded-lg bg-blue-600 hover:bg-blue-700 px-3 py-2 text-xs font-medium text-white transition-colors">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                </path>
                            </svg>
                            <span>Export</span>
                            <svg class="w-3 h-3 transition-transform" :class="exportOpen ? 'rotate-180' : ''"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        
                        <!-- Dropdown Menu -->
                        <div x-show="exportOpen" x-transition:enter="transition ease-out duration-100"
                            x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
                            x-transition:leave="transition ease-in duration-75"
                            x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
                            class="absolute right-0 mt-2 w-44 rounded-lg border border-gray-200 bg-white shadow-xl z-10"
                            style="display: none">
                            <div class="py-1">
                                <button onclick="exportToExcel()"
                                    class="flex w-full items-center gap-2.5 px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 transition-colors">
                                    <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                        </path>
                                    </svg>
                                    <span class="font-medium">Excel (.xlsx)</span>
                                </button>
                                <button onclick="exportToPDF()"
                                    class="flex w-full items-center gap-2.5 px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 transition-colors">
                                    <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z">
                                        </path>
                                    </svg>
                                    <span class="font-medium">PDF (.pdf)</span>
                                </button>
                                <button onclick="exportToPPT()"
                                    class="flex w-full items-center gap-2.5 px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 transition-colors">
                                    <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                        </path>
                                    </svg>
                                    <span class="font-medium">PowerPoint (.pptx)</span>
                                </button>
                                <button onclick="exportToPNG()"
                                    class="flex w-full items-center gap-2.5 px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 transition-colors">
                                    <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                                        </path>
                                    </svg>
                                    <span class="font-medium">Image (.png)</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                    
                <!-- Right: Last Updated -->
                <div class="text-right shrink-0">
                    <p class="text-xs text-gray-400 font-medium">Last Updated</p>
                    <p class="text-sm font-semibold text-gray-600" id="reportDate">
                        --
                    </p>
                </div>
            </div>
            
            <!-- Second Row: All Filter Tabs -->
            <div class="flex flex-wrap items-center gap-4">
                <!-- Region Tabs -->
                <div class="flex items-center gap-2">
                    <span class="text-xs font-medium text-gray-500 tracking-wider">Region:</span>
                    <div class="inline-flex items-center gap-0.5 rounded-lg bg-gray-100 p-0.5">
                        <button id="btnRegionAll" onclick="selectRegionFilter('all')" 
                            class="min-w-[50px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white">
                            All
                        </button>
                        <button id="btnRegionAPAC" onclick="selectRegionFilter('APAC')" 
                            class="min-w-[50px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            APAC
                        </button>
                        <button id="btnRegionEMEA" onclick="selectRegionFilter('EMEA')" 
                            class="min-w-[50px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            EMEA
                        </button>
                        <button id="btnRegionLATAM" onclick="selectRegionFilter('LATAM')" 
                            class="min-w-[60px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            LATAM
                        </button>
                        <button id="btnRegionNAM" onclick="selectRegionFilter('NAM')" 
                            class="min-w-[50px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            NAM
                        </button>
                    </div>
                    </div>
                    
                <!-- Divider -->
                <div class="h-8 w-px bg-gray-300"></div>

                <!-- Status Filter -->
                <div class="flex items-center gap-2">
                    <span class="text-xs font-medium text-gray-500 tracking-wider">Status:</span>
                    <div class="inline-flex items-center gap-0.5 rounded-lg bg-gray-100 p-0.5">
                        <button id="btnStatusAll" onclick="selectStatusFilter('all')" 
                            class="min-w-[45px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white">
                            All
                        </button>
                        <button id="btnStatusCM" onclick="selectStatusFilter('CM')" 
                            class="min-w-[45px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            CM
                        </button>
                        <button id="btnStatusDM" onclick="selectStatusFilter('DM')" 
                            class="min-w-[45px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            DM
                        </button>
                    </div>
                </div>

                <!-- Divider -->
                <div class="h-8 w-px bg-gray-300"></div>

                <!-- Commitment Status Filter -->
                <div class="flex items-center gap-2">
                    <span class="text-xs font-medium text-gray-500 tracking-wider">Commitment:</span>
                    <div class="inline-flex items-center gap-0.5 rounded-lg bg-gray-100 p-0.5">
                        <button id="btnCommitmentAll" onclick="selectCommitmentFilter('all')" 
                            class="min-w-[45px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white">
                            All
                        </button>
                        <button id="btnCommitmentCommitted" onclick="selectCommitmentFilter('Committed')" 
                            class="min-w-[85px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            Committed
                        </button>
                        <button id="btnCommitmentUncommitted" onclick="selectCommitmentFilter('Uncommitted')" 
                            class="min-w-[100px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            Uncommitted
                        </button>
                    </div>
                </div>

                <!-- Divider -->
                <div class="h-8 w-px bg-gray-300"></div>

                <!-- PSE Toggle -->
                <div x-data="{ pseToggle: true }" class="flex items-center gap-2">
                    <span class="text-xs font-medium text-gray-500 tracking-wider">PSE:</span>
                    <label for="pseToggle" class="flex cursor-pointer items-center gap-2 select-none">
                        <span class="text-xs font-medium"
                            :class="!pseToggle ? 'text-gray-900' : 'text-gray-500'">Exclude</span>
                        <div class="relative">
                            <input type="checkbox" id="pseToggle" class="sr-only" 
                                @change="pseToggle = $event.target.checked; togglePSE($event.target.checked)" checked />
                            <div class="block h-5 w-9 rounded-full transition-colors"
                                :class="pseToggle ? 'bg-blue-600' : 'bg-gray-300'"></div>
                            <div :class="pseToggle ? 'translate-x-4' : 'translate-x-0'"
                                class="absolute top-0.5 left-0.5 h-4 w-4 rounded-full bg-white shadow-sm duration-200 ease-in-out">
                        </div>
                        </div>
                        <span class="text-xs font-medium"
                            :class="pseToggle ? 'text-gray-900' : 'text-gray-500'">Include</span>
                    </label>
                </div>

            </div>

            <!-- Active Filters Badges -->
            <div id="activeFiltersBadges" class="flex flex-wrap gap-2 mt-4 pt-4 border-t border-gray-200"
                style="display: none">
                <!-- Badges will be dynamically added here -->
            </div>
            
            <!-- Footnote -->
            <p class="text-xs text-gray-400 mt-4 pt-3 border-t border-gray-100">
                <span class="italic">Note:</span> OSUC and Outstanding balances are from regional credit platforms.
            </p>
        </div>

        <!-- Advanced Filters Modal -->
        <div id="filterPopover"
            class="hidden fixed inset-0 flex items-center justify-center p-5 overflow-y-auto z-[9999]">
            <!-- Backdrop -->
            <div class="fixed inset-0 h-full w-full bg-gray-400/50 backdrop-blur-[32px]"
                onclick="toggleFilterPopover()"></div>
            
            <!-- Modal Content -->
            <div class="relative w-full max-w-[900px] rounded-3xl bg-white p-6 shadow-xl lg:p-10">
                <!-- Close Button -->
                <button onclick="toggleFilterPopover()" type="button"
                    class="absolute right-3 top-3 z-[9999] flex h-9.5 w-9.5 items-center justify-center rounded-full bg-gray-100 text-gray-400 transition-colors hover:bg-gray-200 hover:text-gray-700 sm:right-6 sm:top-6 sm:h-11 sm:w-11 cursor-pointer">
                    <svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M6.04289 16.5413C5.65237 16.9318 5.65237 17.565 6.04289 17.9555C6.43342 18.346 7.06658 18.346 7.45711 17.9555L11.9987 13.4139L16.5408 17.956C16.9313 18.3466 17.5645 18.3466 17.955 17.956C18.3455 17.5655 18.3455 16.9323 17.955 16.5418L13.4129 11.9997L17.955 7.4576C18.3455 7.06707 18.3455 6.43391 17.955 6.04338C17.5645 5.65286 16.9313 5.65286 16.5408 6.04338L11.9987 10.5855L7.45711 6.0439C7.06658 5.65338 6.43342 5.65338 6.04289 6.0439C5.65237 6.43442 5.65237 7.06759 6.04289 7.45811L10.5845 11.9997L6.04289 16.5413Z"
                            fill="" />
                            </svg>
                        </button>

                            <div>
                    <!-- Header -->
                    <h4 class="font-semibold text-gray-800 mb-2 text-title-sm">
                        Advanced Filters
                    </h4>
                    <p class="text-sm leading-6 text-gray-500 mb-7">
                        Refine your portfolio view with detailed filter criteria
                    </p>

                    <!-- Filter Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <!-- Product Program Filter -->
                        <div x-data="{ isOptionSelected: false }">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Product Program
                            </label>
                            <div class="relative z-20 bg-transparent">
                                <select id="filterProductProgram"
                                    class="shadow-theme-xs focus:border-blue-300 focus:ring-blue-500/10 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-11 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden"
                                    :class="isOptionSelected && 'text-gray-800'" @change="isOptionSelected = true"
                                    onchange="applyFilters()">
                                    <option value="" class="text-gray-700">All Programs</option>
                                </select>
                                <span
                                    class="pointer-events-none absolute top-1/2 right-4 z-30 -translate-y-1/2 text-gray-500">
                                    <svg class="stroke-current" width="20" height="20" viewBox="0 0 20 20" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4.79175 7.396L10.0001 12.6043L15.2084 7.396" stroke=""
                                            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </span>
                            </div>
                            </div>

                            <!-- Extending Unit Filter -->
                        <div x-data="{ isOptionSelected: false }">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Extending Unit
                            </label>
                            <div class="relative z-20 bg-transparent">
                                <select id="filterExtendingUnit"
                                    class="shadow-theme-xs focus:border-blue-300 focus:ring-blue-500/10 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-11 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden"
                                    :class="isOptionSelected && 'text-gray-800'" @change="isOptionSelected = true"
                                    onchange="applyFilters()">
                                    <option value="" class="text-gray-700">All Units</option>
                                </select>
                                <span
                                    class="pointer-events-none absolute top-1/2 right-4 z-30 -translate-y-1/2 text-gray-500">
                                    <svg class="stroke-current" width="20" height="20" viewBox="0 0 20 20" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4.79175 7.396L10.0001 12.6043L15.2084 7.396" stroke=""
                                            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </span>
                            </div>
                            </div>

                            <!-- Facility Type Filter -->
                        <div x-data="{ isOptionSelected: false }">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Facility Type
                            </label>
                            <div class="relative z-20 bg-transparent">
                                <select id="filterFacilityType"
                                    class="shadow-theme-xs focus:border-blue-300 focus:ring-blue-500/10 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-11 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden"
                                    :class="isOptionSelected && 'text-gray-800'" @change="isOptionSelected = true"
                                    onchange="applyFilters()">
                                    <option value="" class="text-gray-700">All Types</option>
                                </select>
                                <span
                                    class="pointer-events-none absolute top-1/2 right-4 z-30 -translate-y-1/2 text-gray-500">
                                    <svg class="stroke-current" width="20" height="20" viewBox="0 0 20 20" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4.79175 7.396L10.0001 12.6043L15.2084 7.396" stroke=""
                                            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </span>
                            </div>
                            </div>

                        <!-- Commitment Status Filter -->
                        <div x-data="{ isOptionSelected: false }">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Commitment Status
                            </label>
                            <div class="relative z-20 bg-transparent">
                                <select id="filterCommitment"
                                    class="shadow-theme-xs focus:border-blue-300 focus:ring-blue-500/10 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-11 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden"
                                    :class="isOptionSelected && 'text-gray-800'" @change="isOptionSelected = true"
                                    onchange="applyFilters()">
                                    <option value="" class="text-gray-700">All</option>
                                </select>
                                <span
                                    class="pointer-events-none absolute top-1/2 right-4 z-30 -translate-y-1/2 text-gray-500">
                                    <svg class="stroke-current" width="20" height="20" viewBox="0 0 20 20" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4.79175 7.396L10.0001 12.6043L15.2084 7.396" stroke=""
                                            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </span>
                            </div>
                            </div>

                            <!-- Team Lead Filter -->
                        <div x-data="{ isOptionSelected: false }">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Team Lead
                            </label>
                            <div class="relative z-20 bg-transparent">
                                <select id="filterTeamLead"
                                    class="shadow-theme-xs focus:border-blue-300 focus:ring-blue-500/10 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-11 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden"
                                    :class="isOptionSelected && 'text-gray-800'" @change="isOptionSelected = true"
                                    onchange="applyFilters()">
                                    <option value="" class="text-gray-700">
                                        All Team Leads
                                    </option>
                                </select>
                                <span
                                    class="pointer-events-none absolute top-1/2 right-4 z-30 -translate-y-1/2 text-gray-500">
                                    <svg class="stroke-current" width="20" height="20" viewBox="0 0 20 20" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4.79175 7.396L10.0001 12.6043L15.2084 7.396" stroke=""
                                            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </span>
                            </div>
                            </div>

                            <!-- Underwriter Filter -->
                        <div x-data="{ isOptionSelected: false }">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Underwriter
                            </label>
                            <div class="relative z-20 bg-transparent">
                                <select id="filterUnderwriter"
                                    class="shadow-theme-xs focus:border-blue-300 focus:ring-blue-500/10 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-11 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden"
                                    :class="isOptionSelected && 'text-gray-800'" @change="isOptionSelected = true"
                                    onchange="applyFilters()">
                                    <option value="" class="text-gray-700">
                                        All Underwriters
                                    </option>
                                </select>
                                <span
                                    class="pointer-events-none absolute top-1/2 right-4 z-30 -translate-y-1/2 text-gray-500">
                                    <svg class="stroke-current" width="20" height="20" viewBox="0 0 20 20" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4.79175 7.396L10.0001 12.6043L15.2084 7.396" stroke=""
                                            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </span>
                            </div>
                            </div>

                            <!-- CA Maturity Filter -->
                        <div x-data="{ isOptionSelected: false }">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                CAs Maturing
                            </label>
                            <div class="relative z-20 bg-transparent">
                                <select id="filterCAMaturity"
                                    class="shadow-theme-xs focus:border-blue-300 focus:ring-blue-500/10 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-11 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden"
                                    :class="isOptionSelected && 'text-gray-800'" @change="isOptionSelected = true"
                                    onchange="applyFilters()">
                                    <option value="" class="text-gray-700">All Dates</option>
                                    <option value="30" class="text-gray-700">
                                        Next 30 Days
                                    </option>
                                    <option value="60" class="text-gray-700">
                                        Next 60 Days
                                    </option>
                                    <option value="90" class="text-gray-700">
                                        Next 90 Days
                                    </option>
                                    <option value="180" class="text-gray-700">
                                        Next 6 Months
                                    </option>
                                    <option value="365" class="text-gray-700">Next Year</option>
                                </select>
                                <span
                                    class="pointer-events-none absolute top-1/2 right-4 z-30 -translate-y-1/2 text-gray-500">
                                    <svg class="stroke-current" width="20" height="20" viewBox="0 0 20 20" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4.79175 7.396L10.0001 12.6043L15.2084 7.396" stroke=""
                                            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </span>
                            </div>
                            </div>

                            <!-- Facility Maturity Filter -->
                        <div x-data="{ isOptionSelected: false }">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Facilities Maturing
                            </label>
                            <div class="relative z-20 bg-transparent">
                                <select id="filterFacilityMaturity"
                                    class="shadow-theme-xs focus:border-blue-300 focus:ring-blue-500/10 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-11 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden"
                                    :class="isOptionSelected && 'text-gray-800'" @change="isOptionSelected = true"
                                    onchange="applyFilters()">
                                    <option value="" class="text-gray-700">All Dates</option>
                                    <option value="30" class="text-gray-700">
                                        Next 30 Days
                                    </option>
                                    <option value="60" class="text-gray-700">
                                        Next 60 Days
                                    </option>
                                    <option value="90" class="text-gray-700">
                                        Next 90 Days
                                    </option>
                                    <option value="180" class="text-gray-700">
                                        Next 6 Months
                                    </option>
                                    <option value="365" class="text-gray-700">Next Year</option>
                                </select>
                                <span
                                    class="pointer-events-none absolute top-1/2 right-4 z-30 -translate-y-1/2 text-gray-500">
                                    <svg class="stroke-current" width="20" height="20" viewBox="0 0 20 20" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4.79175 7.396L10.0001 12.6043L15.2084 7.396" stroke=""
                                            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex items-center justify-between w-full gap-3">
                        <button onclick="clearAllFilters()" type="button"
                            class="text-sm font-medium text-gray-600 hover:text-gray-800 transition-colors">
                            Clear All Filters
                        </button>
                        <div class="flex gap-3">
                            <button onclick="toggleFilterPopover()" type="button"
                                class="flex w-full justify-center rounded-lg border border-gray-300 bg-white px-4 py-3 text-sm font-medium text-gray-700 shadow-theme-xs hover:bg-gray-50 hover:text-gray-800 sm:w-auto">
                                Cancel
                            </button>
                            <button onclick="applyFiltersAndClose()" type="button"
                                class="flex justify-center w-full px-4 py-3 text-sm font-medium text-white rounded-lg bg-blue-600 shadow-theme-xs hover:bg-blue-700 sm:w-auto">
                                Apply Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Metric Cards -->
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 md:gap-6 mb-6">
            <!-- Card 1: Total $ of Facility Amount (TFA) -->
            <div class="rounded-2xl border border-gray-200 bg-white p-5 flex flex-col relative">
                <!-- Action Buttons - Absolute Top Right -->
                <div class="absolute top-2 right-2 flex items-center gap-0.5">
                    <button onclick="openExpandModal('tfa')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                        <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                            <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                        </svg>
                    </button>
                    <div x-data="{openDropDown: false}" class="relative">
                        <button @click="openDropDown = !openDropDown"
                            :class="openDropDown ? 'text-gray-900' : 'text-gray-600 hover:text-gray-900'"
                            class="transition-colors p-1">
                            <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.3" stroke="currentColor">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M10.2441 6C10.2441 5.0335 11.0276 4.25 11.9941 4.25H12.0041C12.9706 4.25 13.7541 5.0335 13.7541 6C13.7541 6.9665 12.9706 7.75 12.0041 7.75H11.9941C11.0276 7.75 10.2441 6.9665 10.2441 6ZM10.2441 18C10.2441 17.0335 11.0276 16.25 11.9941 16.25H12.0041C12.9706 16.25 13.7541 17.0335 13.7541 18C13.7541 18.9665 12.9706 19.75 12.0041 19.75H11.9941C11.0276 19.75 10.2441 18.9665 10.2441 18ZM11.9941 10.25C11.0276 10.25 10.2441 11.0335 10.2441 12C10.2441 12.9665 11.0276 13.75 11.9941 13.75H12.0041C12.9706 13.75 13.7541 12.9665 13.7541 12C13.7541 11.0335 12.9706 10.25 12.0041 10.25H11.9941Z" fill="" />
                            </svg>
                        </button>
                        <div x-show="openDropDown" @click.outside="openDropDown = false"
                            class="absolute right-0 top-full z-40 w-40 space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                            <button onclick="openChartDataModal('tfa')" @click="openDropDown = false"
                                class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                View Data
                            </button>
                            <button onclick="openMethodologyModal('tfa')" @click="openDropDown = false"
                                class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                View Methodology
                            </button>
                            <button onclick="exportChartData('tfa')" @click="openDropDown = false"
                                class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                Download Data
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex items-start gap-3 pr-14 flex-1">
                    <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-red-100">
                        <svg class="h-5 w-5 shrink-0 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">TFA</h3>
                        <p class="text-xs text-gray-400">(Total Facilities Approved)</p>
                    </div>
                </div>
                <p class="text-2xl font-bold text-gray-900 text-center mt-3" id="totalFacAmount">$0.00</p>
            </div>

            <!-- Card 2: Total $ of OSUC -->
            <div class="rounded-2xl border border-gray-200 bg-white p-5 flex flex-col relative">
                <!-- Action Buttons - Absolute Top Right -->
                <div class="absolute top-2 right-2 flex items-center gap-0.5">
                    <button onclick="openExpandModal('osuc')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                        <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                            <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                        </svg>
                    </button>
                    <div x-data="{openDropDown: false}" class="relative">
                        <button @click="openDropDown = !openDropDown"
                            :class="openDropDown ? 'text-gray-900' : 'text-gray-600 hover:text-gray-900'"
                            class="transition-colors p-1">
                            <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.3" stroke="currentColor">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M10.2441 6C10.2441 5.0335 11.0276 4.25 11.9941 4.25H12.0041C12.9706 4.25 13.7541 5.0335 13.7541 6C13.7541 6.9665 12.9706 7.75 12.0041 7.75H11.9941C11.0276 7.75 10.2441 6.9665 10.2441 6ZM10.2441 18C10.2441 17.0335 11.0276 16.25 11.9941 16.25H12.0041C12.9706 16.25 13.7541 17.0335 13.7541 18C13.7541 18.9665 12.9706 19.75 12.0041 19.75H11.9941C11.0276 19.75 10.2441 18.9665 10.2441 18ZM11.9941 10.25C11.0276 10.25 10.2441 11.0335 10.2441 12C10.2441 12.9665 11.0276 13.75 11.9941 13.75H12.0041C12.9706 13.75 13.7541 12.9665 13.7541 12C13.7541 11.0335 12.9706 10.25 12.0041 10.25H11.9941Z" fill="" />
                            </svg>
                        </button>
                        <div x-show="openDropDown" @click.outside="openDropDown = false"
                            class="absolute right-0 top-full z-40 w-40 space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                            <button onclick="openChartDataModal('osuc')" @click="openDropDown = false"
                                class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                View Data
                            </button>
                            <button onclick="openMethodologyModal('osuc')" @click="openDropDown = false"
                                class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                View Methodology
                            </button>
                            <button onclick="exportChartData('osuc')" @click="openDropDown = false"
                                class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                Download Data
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex items-start gap-3 pr-14 flex-1">
                    <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-orange-100">
                        <svg class="h-5 w-5 shrink-0 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">OSUC<sup class="text-blue-600">*</sup></h3>
                        <p class="text-xs text-gray-400">(OS + Unused Commitment)</p>
                    </div>
                </div>
                <p class="text-2xl font-bold text-gray-900 text-center mt-3" id="totalOSUC">$0.00</p>
            </div>

            <!-- Card 3: Total Outstanding -->
            <div class="rounded-2xl border border-gray-200 bg-white p-5 flex flex-col relative">
                <!-- Action Buttons - Absolute Top Right -->
                <div class="absolute top-2 right-2 flex items-center gap-0.5">
                    <button onclick="openExpandModal('outstanding')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                        <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                            <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                        </svg>
                    </button>
                    <div x-data="{openDropDown: false}" class="relative">
                        <button @click="openDropDown = !openDropDown"
                            :class="openDropDown ? 'text-gray-900' : 'text-gray-600 hover:text-gray-900'"
                            class="transition-colors p-1">
                            <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.3" stroke="currentColor">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M10.2441 6C10.2441 5.0335 11.0276 4.25 11.9941 4.25H12.0041C12.9706 4.25 13.7541 5.0335 13.7541 6C13.7541 6.9665 12.9706 7.75 12.0041 7.75H11.9941C11.0276 7.75 10.2441 6.9665 10.2441 6ZM10.2441 18C10.2441 17.0335 11.0276 16.25 11.9941 16.25H12.0041C12.9706 16.25 13.7541 17.0335 13.7541 18C13.7541 18.9665 12.9706 19.75 12.0041 19.75H11.9941C11.0276 19.75 10.2441 18.9665 10.2441 18ZM11.9941 10.25C11.0276 10.25 10.2441 11.0335 10.2441 12C10.2441 12.9665 11.0276 13.75 11.9941 13.75H12.0041C12.9706 13.75 13.7541 12.9665 13.7541 12C13.7541 11.0335 12.9706 10.25 12.0041 10.25H11.9941Z" fill="" />
                            </svg>
                        </button>
                        <div x-show="openDropDown" @click.outside="openDropDown = false"
                            class="absolute right-0 top-full z-40 w-40 space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                            <button onclick="openChartDataModal('outstanding')" @click="openDropDown = false"
                                class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                View Data
                            </button>
                            <button onclick="openMethodologyModal('outstanding')" @click="openDropDown = false"
                                class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                View Methodology
                            </button>
                            <button onclick="exportChartData('outstanding')" @click="openDropDown = false"
                                class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                Download Data
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex items-start gap-3 pr-14 flex-1">
                    <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-purple-100">
                        <svg class="h-5 w-5 shrink-0 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Outstanding</h3>
                        <p class="text-xs text-gray-400">(Direct + Contingent + PSE)</p>
                    </div>
                </div>
                <p class="text-2xl font-bold text-gray-900 text-center mt-3" id="totalOutstanding">$0.00</p>
            </div>

            <!-- Card 4: Total # of Facilities -->
            <div class="rounded-2xl border border-gray-200 bg-white p-5 flex flex-col relative">
                <!-- Action Buttons - Absolute Top Right -->
                <div class="absolute top-2 right-2 flex items-center gap-0.5">
                    <button onclick="openExpandModal('facilities')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                        <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                            <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                        </svg>
                    </button>
                    <div x-data="{openDropDown: false}" class="relative">
                        <button @click="openDropDown = !openDropDown"
                            :class="openDropDown ? 'text-gray-900' : 'text-gray-600 hover:text-gray-900'"
                            class="transition-colors p-1">
                            <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.3" stroke="currentColor">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M10.2441 6C10.2441 5.0335 11.0276 4.25 11.9941 4.25H12.0041C12.9706 4.25 13.7541 5.0335 13.7541 6C13.7541 6.9665 12.9706 7.75 12.0041 7.75H11.9941C11.0276 7.75 10.2441 6.9665 10.2441 6ZM10.2441 18C10.2441 17.0335 11.0276 16.25 11.9941 16.25H12.0041C12.9706 16.25 13.7541 17.0335 13.7541 18C13.7541 18.9665 12.9706 19.75 12.0041 19.75H11.9941C11.0276 19.75 10.2441 18.9665 10.2441 18ZM11.9941 10.25C11.0276 10.25 10.2441 11.0335 10.2441 12C10.2441 12.9665 11.0276 13.75 11.9941 13.75H12.0041C12.9706 13.75 13.7541 12.9665 13.7541 12C13.7541 11.0335 12.9706 10.25 12.0041 10.25H11.9941Z" fill="" />
                            </svg>
                        </button>
                        <div x-show="openDropDown" @click.outside="openDropDown = false"
                            class="absolute right-0 top-full z-40 w-40 space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                            <button onclick="openChartDataModal('facilities')" @click="openDropDown = false"
                                class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                View Data
                            </button>
                            <button onclick="openMethodologyModal('facilities')" @click="openDropDown = false"
                                class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                View Methodology
                            </button>
                            <button onclick="exportChartData('facilities')" @click="openDropDown = false"
                                class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                Download Data
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex items-start gap-3 pr-14 flex-1">
                    <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-green-100">
                        <svg class="h-5 w-5 shrink-0 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Facilities</h3>
                        <p class="text-xs text-gray-400">(Total Count)</p>
                    </div>
                </div>
                <p class="text-2xl font-bold text-gray-900 text-center mt-3" id="totalFacilities">0</p>
            </div>

            <!-- Card 5: Total # of Relationships -->
            <div class="rounded-2xl border border-gray-200 bg-white p-5 flex flex-col relative">
                <!-- Action Buttons - Absolute Top Right -->
                <div class="absolute top-2 right-2 flex items-center gap-0.5">
                    <button onclick="openExpandModal('relationships')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                        <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                            <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                        </svg>
                    </button>
                    <div x-data="{openDropDown: false}" class="relative">
                        <button @click="openDropDown = !openDropDown"
                            :class="openDropDown ? 'text-gray-900' : 'text-gray-600 hover:text-gray-900'"
                            class="transition-colors p-1">
                            <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.3" stroke="currentColor">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M10.2441 6C10.2441 5.0335 11.0276 4.25 11.9941 4.25H12.0041C12.9706 4.25 13.7541 5.0335 13.7541 6C13.7541 6.9665 12.9706 7.75 12.0041 7.75H11.9941C11.0276 7.75 10.2441 6.9665 10.2441 6ZM10.2441 18C10.2441 17.0335 11.0276 16.25 11.9941 16.25H12.0041C12.9706 16.25 13.7541 17.0335 13.7541 18C13.7541 18.9665 12.9706 19.75 12.0041 19.75H11.9941C11.0276 19.75 10.2441 18.9665 10.2441 18ZM11.9941 10.25C11.0276 10.25 10.2441 11.0335 10.2441 12C10.2441 12.9665 11.0276 13.75 11.9941 13.75H12.0041C12.9706 13.75 13.7541 12.9665 13.7541 12C13.7541 11.0335 12.9706 10.25 12.0041 10.25H11.9941Z" fill="" />
                            </svg>
                        </button>
                        <div x-show="openDropDown" @click.outside="openDropDown = false"
                            class="absolute right-0 top-full z-40 w-40 space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                            <button onclick="openChartDataModal('relationships')" @click="openDropDown = false"
                                class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                View Data
                            </button>
                            <button onclick="openMethodologyModal('relationships')" @click="openDropDown = false"
                                class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                View Methodology
                            </button>
                            <button onclick="exportChartData('relationships')" @click="openDropDown = false"
                                class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                Download Data
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex items-start gap-3 pr-14 flex-1">
                    <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-blue-100">
                        <svg class="h-5 w-5 shrink-0 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Relationships</h3>
                        <p class="text-xs text-gray-400">(Total Count)</p>
                    </div>
                </div>
                <p class="text-2xl font-bold text-gray-900 text-center mt-3" id="totalRelationships">0</p>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-12 gap-4 md:gap-6 mb-6">
            <!-- Bar Chart: CAs Coming Due & Facilities Expiring -->
            <div class="col-span-12 xl:col-span-4">
                <div class="rounded-2xl border border-gray-200 bg-white p-5 sm:p-6 h-full flex flex-col relative">
                    <!-- Action Buttons - Absolute Top Right -->
                    <div class="absolute top-3 right-3 flex items-center gap-0.5">
                        <button onclick="openExpandModal('expiring')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                            <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                                <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                                    </svg>
                        </button>
                            <div x-data="{openDropDown: false}" class="relative">
                                <button @click="openDropDown = !openDropDown"
                                    :class="openDropDown ? 'text-gray-900' : 'text-gray-600 hover:text-gray-900'"
                                class="transition-colors p-1">
                                <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M10.2441 6C10.2441 5.0335 11.0276 4.25 11.9941 4.25H12.0041C12.9706 4.25 13.7541 5.0335 13.7541 6C13.7541 6.9665 12.9706 7.75 12.0041 7.75H11.9941C11.0276 7.75 10.2441 6.9665 10.2441 6ZM10.2441 18C10.2441 17.0335 11.0276 16.25 11.9941 16.25H12.0041C12.9706 16.25 13.7541 17.0335 13.7541 18C13.7541 18.9665 12.9706 19.75 12.0041 19.75H11.9941C11.0276 19.75 10.2441 18.9665 10.2441 18ZM11.9941 10.25C11.0276 10.25 10.2441 11.0335 10.2441 12C10.2441 12.9665 11.0276 13.75 11.9941 13.75H12.0041C12.9706 13.75 13.7541 12.9665 13.7541 12C13.7541 11.0335 12.9706 10.25 12.0041 10.25H11.9941Z" fill="" />
                                    </svg>
                                </button>
                                <div x-show="openDropDown" @click.outside="openDropDown = false"
                                    class="absolute right-0 top-full z-40 w-40 space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                    <button onclick="openChartDataModal('expiring')" @click="openDropDown = false"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        View Data
                                    </button>
                                    <button onclick="openMethodologyModal('expiring')" @click="openDropDown = false"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        View Methodology
                                    </button>
                                    <button onclick="exportChartData('expiring')" @click="openDropDown = false"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        Export Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    <div class="mb-5 pr-16">
                                <h3 class="text-lg font-semibold text-gray-800">
                                    CAs & Facilities Expiring
                                </h3>
                            <!-- Expired Metrics (Inline) -->
                            <div class="flex items-center gap-4 mt-2">
                                <div class="flex items-center gap-1.5">
                                    <svg class="h-2 w-2 text-blue-500" fill="currentColor" viewBox="0 0 8 8">
                                        <circle cx="4" cy="4" r="4" />
                                    </svg>
                                    <span class="text-xs text-gray-600">CAs Expired:</span>
                                    <span class="text-xs font-semibold text-gray-900" id="casExpiredCount">0</span>
                                </div>
                                <div class="flex items-center gap-1.5">
                                    <svg class="h-2 w-2 text-orange-500" fill="currentColor" viewBox="0 0 8 8">
                                        <circle cx="4" cy="4" r="4" />
                                    </svg>
                                    <span class="text-xs text-gray-600">Facilities Expired:</span>
                                <span class="text-xs font-semibold text-gray-900" id="facilitiesExpiredCount">0</span>
                                </div>
                            </div>
                                <p class="mt-1 text-sm text-gray-500">
                                    Upcoming expirations for the next 3 months
                                </p>
                        </div>
                        <div class="flex-1 flex items-center">
                            <div id="facilityTrendChart" class="-ml-5 w-full" style="min-height: 350px"></div>
                    </div>
                </div>
            </div>

            <!-- Donut Chart: New Facilities Approved  -->
            <div class="col-span-12 xl:col-span-4">
                <div class="rounded-2xl border border-gray-200 bg-white p-5 sm:p-6 h-full flex flex-col relative">
                    <!-- Action Buttons - Absolute Top Right -->
                    <div class="absolute top-3 right-3 flex items-center gap-0.5">
                        <button onclick="openExpandModal('newFacilities')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                            <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                                <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                            </svg>
                        </button>
                            <div x-data="{openDropDown: false}" class="relative">
                                <button @click="openDropDown = !openDropDown"
                                    :class="openDropDown ? 'text-gray-900' : 'text-gray-600 hover:text-gray-900'"
                                class="transition-colors p-1">
                                <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M10.2441 6C10.2441 5.0335 11.0276 4.25 11.9941 4.25H12.0041C12.9706 4.25 13.7541 5.0335 13.7541 6C13.7541 6.9665 12.9706 7.75 12.0041 7.75H11.9941C11.0276 7.75 10.2441 6.9665 10.2441 6ZM10.2441 18C10.2441 17.0335 11.0276 16.25 11.9941 16.25H12.0041C12.9706 16.25 13.7541 17.0335 13.7541 18C13.7541 18.9665 12.9706 19.75 12.0041 19.75H11.9941C11.0276 19.75 10.2441 18.9665 10.2441 18ZM11.9941 10.25C11.0276 10.25 10.2441 11.0335 10.2441 12C10.2441 12.9665 11.0276 13.75 11.9941 13.75H12.0041C12.9706 13.75 13.7541 12.9665 13.7541 12C13.7541 11.0335 12.9706 10.25 12.0041 10.25H11.9941Z" fill="" />
                                    </svg>
                                </button>
                                <div x-show="openDropDown" @click.outside="openDropDown = false"
                                    class="absolute right-0 top-full z-40 w-40 space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                <button onclick="openChartDataModal('newFacilities')" @click="openDropDown = false"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        View Data
                                    </button>
                                <button onclick="openMethodologyModal('newFacilities')" @click="openDropDown = false"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        View Methodology
                                    </button>
                                <button onclick="exportChartData('newFacilities')" @click="openDropDown = false"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        Export Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    <div class="flex flex-col gap-3 mb-5 sm:flex-row sm:items-start sm:justify-between pr-16">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">
                                New Facilities Approved 
                            </h3>
                            <p class="mt-1 text-sm text-gray-500" id="newFacilitiesSubtitle">
                                Facilities approved in reporting month
                            </p>
                        </div>
                        <div class="inline-flex w-fit items-center gap-0.5 rounded-lg bg-gray-100 p-0.5">
                            <button id="currentMonthBtn" onclick="filterNewFacilitiesByPeriod('current')" 
                                class="px-2 py-1 font-medium transition-colors rounded text-xs shadow-xs text-gray-900 bg-white hover:text-gray-900">
                                Current
                            </button>
                            <button id="previousMonthBtn" onclick="filterNewFacilitiesByPeriod('previous')" 
                                class="px-2 py-1 font-medium transition-colors rounded text-xs text-gray-500 hover:text-gray-900">
                                Previous
                            </button>
                        </div>
                    </div>
                    <div class="flex flex-col items-center justify-center gap-8 xl:flex-row flex-1">
                        <div id="creditClassificationChart" class="chartDarkStyle" style="min-height: 280px; min-width: 280px;"></div>
                        <div id="creditClassificationLegend"
                            class="flex flex-col items-start gap-6 sm:flex-row xl:flex-col">
                            <!-- Legend items will be dynamically generated -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- New Deals Section -->
            <div class="col-span-12 xl:col-span-4 flex flex-col h-full">
                <!-- Metric Group One -->
                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 md:gap-6 mb-6">
                    <!-- Metric Item Start -->
                    <div class="rounded-2xl border border-gray-200 bg-white p-5 md:p-6 relative">
                        <!-- Action Buttons - Absolute Top Right -->
                        <div class="absolute top-2 right-2 flex items-center gap-0.5">
                            <button onclick="openExpandModal('newDealsYTD')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                                <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                                    <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                            </svg>
                            </button>
                            <div x-data="{openDropDown: false}" class="relative">
                                <button @click="openDropDown = !openDropDown"
                                    :class="openDropDown ? 'text-gray-900' : 'text-gray-600 hover:text-gray-900'"
                                    class="transition-colors p-1">
                                    <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M10.2441 6C10.2441 5.0335 11.0276 4.25 11.9941 4.25H12.0041C12.9706 4.25 13.7541 5.0335 13.7541 6C13.7541 6.9665 12.9706 7.75 12.0041 7.75H11.9941C11.0276 7.75 10.2441 6.9665 10.2441 6ZM10.2441 18C10.2441 17.0335 11.0276 16.25 11.9941 16.25H12.0041C12.9706 16.25 13.7541 17.0335 13.7541 18C13.7541 18.9665 12.9706 19.75 12.0041 19.75H11.9941C11.0276 19.75 10.2441 18.9665 10.2441 18ZM11.9941 10.25C11.0276 10.25 10.2441 11.0335 10.2441 12C10.2441 12.9665 11.0276 13.75 11.9941 13.75H12.0041C12.9706 13.75 13.7541 12.9665 13.7541 12C13.7541 11.0335 12.9706 10.25 12.0041 10.25H11.9941Z" fill="" />
                                </svg>
                                </button>
                                <div x-show="openDropDown" @click.outside="openDropDown = false"
                                    class="absolute right-0 top-full z-40 w-40 space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                    <button onclick="openChartDataModal('newDealsYTD')" @click="openDropDown = false"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        View Data
                                    </button>
                                    <button onclick="openMethodologyModal('newDealsYTD')" @click="openDropDown = false"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        View Methodology
                                    </button>
                                    <button onclick="exportChartData('newDealsYTD')" @click="openDropDown = false"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        Export Data
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start gap-3 pr-14 flex-1">
                            <div>
                                <span class="text-sm font-medium text-gray-500">New Deals</span>
                                <p class="text-xs text-gray-400">Closed YTD</p>
                            </div>
                        </div>
                        <div class="flex items-end justify-between">
                            <div>
                                <h4 id="newDealsYTD" class="text-title-sm font-bold text-gray-800">0</h4>
                                <p class="text-xs text-gray-400 mt-1">
                                    <span id="newDealsYTDAmount">$0</span>
                                </p>
                            </div>
                            <span id="newDealsYTDVariance"
                                class="flex items-center gap-1 rounded-full bg-gray-100 py-0.5 pl-2 pr-2.5 text-sm font-medium text-gray-600">
                                0%
                            </span>
                        </div>
                    </div>
                    <!-- Metric Item End -->

                    <!-- Metric Item Start -->
                    <div class="rounded-2xl border border-gray-200 bg-white p-5 md:p-6 relative">
                        <!-- Action Buttons - Absolute Top Right -->
                        <div class="absolute top-2 right-2 flex items-center gap-0.5">
                            <button onclick="openExpandModal('newDealsMTD')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                                <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                                    <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                            </svg>
                            </button>
                            <div x-data="{openDropDown: false}" class="relative">
                                <button @click="openDropDown = !openDropDown"
                                    :class="openDropDown ? 'text-gray-900' : 'text-gray-600 hover:text-gray-900'"
                                    class="transition-colors p-1">
                                    <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M10.2441 6C10.2441 5.0335 11.0276 4.25 11.9941 4.25H12.0041C12.9706 4.25 13.7541 5.0335 13.7541 6C13.7541 6.9665 12.9706 7.75 12.0041 7.75H11.9941C11.0276 7.75 10.2441 6.9665 10.2441 6ZM10.2441 18C10.2441 17.0335 11.0276 16.25 11.9941 16.25H12.0041C12.9706 16.25 13.7541 17.0335 13.7541 18C13.7541 18.9665 12.9706 19.75 12.0041 19.75H11.9941C11.0276 19.75 10.2441 18.9665 10.2441 18ZM11.9941 10.25C11.0276 10.25 10.2441 11.0335 10.2441 12C10.2441 12.9665 11.0276 13.75 11.9941 13.75H12.0041C12.9706 13.75 13.7541 12.9665 13.7541 12C13.7541 11.0335 12.9706 10.25 12.0041 10.25H11.9941Z" fill="" />
                                </svg>
                                </button>
                                <div x-show="openDropDown" @click.outside="openDropDown = false"
                                    class="absolute right-0 top-full z-40 w-40 space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                    <button onclick="openChartDataModal('newDealsMTD')" @click="openDropDown = false"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        View Data
                                    </button>
                                    <button onclick="openMethodologyModal('newDealsMTD')" @click="openDropDown = false"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        View Methodology
                                    </button>
                                    <button onclick="exportChartData('newDealsMTD')" @click="openDropDown = false"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        Export Data
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start gap-3 pr-14 flex-1">
                            <div>
                                <span class="text-sm font-medium text-gray-500">New Deals</span>
                                <p class="text-xs text-gray-400">Closed MTD</p>
                            </div>
                        </div>
                        <div class="flex items-end justify-between">
                            <div>
                                <h4 id="newDealsMTD" class="text-title-sm font-bold text-gray-800">0</h4>
                                <p class="text-xs text-gray-400 mt-1">
                                    <span id="newDealsMTDAmount">$0</span>
                                </p>
                            </div>
                            <span id="newDealsMTDVariance"
                                class="flex items-center gap-1 rounded-full bg-gray-100 py-0.5 pl-2 pr-2.5 text-sm font-medium text-gray-600">
                                0%
                            </span>
                        </div>
                    </div>
                    <!-- Metric Item End -->
                </div>
                <!-- Metric Group One -->

                <!-- ====== Pipeline Table Start -->
                <div class="overflow-hidden rounded-2xl border border-gray-200 bg-white flex-1 flex flex-col relative">
                    <!-- Action Buttons - Absolute Top Right -->
                    <div class="absolute top-3 right-3 flex items-center gap-0.5 z-10">
                        <button onclick="openExpandModal('pipeline')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                            <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                                <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                            </svg>
                        </button>
                        <div x-data="{openDropDown: false}" class="relative">
                            <button @click="openDropDown = !openDropDown"
                                :class="openDropDown ? 'text-gray-900' : 'text-gray-600 hover:text-gray-900'"
                                class="transition-colors p-1">
                                <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M10.2441 6C10.2441 5.0335 11.0276 4.25 11.9941 4.25H12.0041C12.9706 4.25 13.7541 5.0335 13.7541 6C13.7541 6.9665 12.9706 7.75 12.0041 7.75H11.9941C11.0276 7.75 10.2441 6.9665 10.2441 6ZM10.2441 18C10.2441 17.0335 11.0276 16.25 11.9941 16.25H12.0041C12.9706 16.25 13.7541 17.0335 13.7541 18C13.7541 18.9665 12.9706 19.75 12.0041 19.75H11.9941C11.0276 19.75 10.2441 18.9665 10.2441 18ZM11.9941 10.25C11.0276 10.25 10.2441 11.0335 10.2441 12C10.2441 12.9665 11.0276 13.75 11.9941 13.75H12.0041C12.9706 13.75 13.7541 12.9665 13.7541 12C13.7541 11.0335 12.9706 10.25 12.0041 10.25H11.9941Z" fill="" />
                                </svg>
                            </button>
                            <div x-show="openDropDown" @click.outside="openDropDown = false"
                                class="absolute right-0 top-full z-40 w-40 space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                <button onclick="openChartDataModal('pipeline')" @click="openDropDown = false"
                                    class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                    View Data
                                </button>
                                <button onclick="openMethodologyModal('pipeline')" @click="openDropDown = false"
                                    class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                    View Methodology
                                </button>
                                <button onclick="exportChartData('pipeline')" @click="openDropDown = false"
                                    class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                    Export Data
                            </button>
                        </div>
                    </div>
                    </div>
                    <div class="px-5 pt-5 sm:px-6 sm:pt-6 pb-4 pr-16">
                        <h3 class="text-lg font-semibold text-gray-800">
                            Deals Pending Closure
                        </h3>
                        <p class="mt-1 text-sm text-gray-500">
                            NAM and LATAM only
                        </p>
                    </div>
                    <div class="max-w-full overflow-x-auto flex-1">
                        <table class="w-full table-auto h-full">
                            <thead>
                                <tr class="bg-gray-50 text-left">
                                    <th class="px-5 py-3 text-xs font-semibold text-gray-700 tracking-wider">
                                        Aging Bucket</th>
                                    <th
                                        class="px-5 py-3 text-xs font-semibold text-gray-700 tracking-wider text-right">
                                        Count</th>
                                    <th
                                        class="px-5 py-3 text-xs font-semibold text-gray-700 tracking-wider text-right">
                                        Total TFA</th>
                                </tr>
                            </thead>
                            <tbody id="pipelineTableBody" class="divide-y divide-gray-200">
                                <tr>
                                    <td colspan="3" class="px-5 py-4 text-center text-sm text-gray-500">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- ====== Pipeline Table End -->
            </div>
        </div>

        <!-- Bar Chart and Donut Chart Side by Side -->
        <div class="mb-6 grid grid-cols-12 gap-4 md:gap-6">
        <!-- Bar Chart: Top Relationships by Total Facility Amount / Direct OS -->
            <div class="col-span-12 xl:col-span-6">
                <div
                    class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6 sm:pt-5 h-full flex flex-col">
                    <div class="mb-6 relative pr-48">
                    <div class="pr-0">
                            <h3 class="text-lg font-semibold text-gray-800" id="topRelationshipsTitle">
                                Top Relationships
                            </h3>
                            <p class="mt-1 text-gray-500 text-sm" id="topRelationshipsSubtitle">
                                Top relationships by exposure type - Direct OS
                            </p>
                    </div>
                        <!-- Filters - Fixed Position at Top Right -->
                        <div class="absolute right-0 top-0 flex items-center gap-2">
                            <!-- Exposure Type Dropdown -->
                            <div x-data="{openExposure: false, exposureType: 'direct', exposureLabels: {direct: 'Direct', contingent: 'Contingent', pse: 'PSE', osuc: 'OSUC', unused: 'Undrawn', tfa: 'TFA'}}" class="relative">
                                <button @click="openExposure = !openExposure"
                                    class="inline-flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                    <span x-text="exposureLabels[exposureType]">Direct</span>
                                    <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                                <div x-show="openExposure" @click.outside="openExposure = false"
                                    class="absolute right-0 top-full z-40 w-32 space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                    <button
                                        @click="exposureType = 'direct'; openExposure = false; selectAmountTypeFilter('direct');"
                                        :class="exposureType === 'direct' ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                        class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                        Direct
                                    </button>
                                    <button
                                        @click="exposureType = 'contingent'; openExposure = false; selectAmountTypeFilter('contingent');"
                                        :class="exposureType === 'contingent' ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                        class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                        Contingent
                                    </button>
                                    <button
                                        @click="exposureType = 'pse'; openExposure = false; selectAmountTypeFilter('pse');"
                                        :class="exposureType === 'pse' ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                        class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                        PSE
                                    </button>
                                    <button
                                        @click="exposureType = 'osuc'; openExposure = false; selectAmountTypeFilter('osuc');"
                                        :class="exposureType === 'osuc' ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                        class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                        OSUC
                                    </button>
                                    <button
                                        @click="exposureType = 'unused'; openExposure = false; selectAmountTypeFilter('unused');"
                                        :class="exposureType === 'unused' ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                        class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                        Undrawn
                                    </button>
                                    <button
                                        @click="exposureType = 'tfa'; openExposure = false; selectAmountTypeFilter('tfa');"
                                        :class="exposureType === 'tfa' ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                        class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                        TFA
                                    </button>
                                </div>
                            </div>
                            <!-- Top N Filter -->
                            <div x-data="{openTopN: false, topNRelationships: 10}" class="relative">
                                <button @click="openTopN = !openTopN"
                                    class="inline-flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                    <span>Top <span x-text="topNRelationships"></span></span>
                                    <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                                <div x-show="openTopN" @click.outside="openTopN = false"
                                    class="absolute right-0 top-full z-40 w-28 space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                    <button
                                        @click="topNRelationships = 10; openTopN = false; document.getElementById('topNFilter').value = 10; updateBarChart();"
                                        :class="topNRelationships === 10 ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                        class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                        Top 10
                                    </button>
                                    <button
                                        @click="topNRelationships = 20; openTopN = false; document.getElementById('topNFilter').value = 20; updateBarChart();"
                                        :class="topNRelationships === 20 ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                        class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                        Top 20
                                    </button>
                                    <button
                                        @click="topNRelationships = 30; openTopN = false; document.getElementById('topNFilter').value = 30; updateBarChart();"
                                        :class="topNRelationships === 30 ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                        class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                        Top 30
                                    </button>
                                    <button
                                        @click="topNRelationships = 40; openTopN = false; document.getElementById('topNFilter').value = 40; updateBarChart();"
                                        :class="topNRelationships === 40 ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                        class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                        Top 40
                                    </button>
                                    <button
                                        @click="topNRelationships = 50; openTopN = false; document.getElementById('topNFilter').value = 50; updateBarChart();"
                                        :class="topNRelationships === 50 ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                        class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                        Top 50
                                    </button>
                                    <button
                                        @click="topNRelationships = 100; openTopN = false; document.getElementById('topNFilter').value = 100; updateBarChart();"
                                        :class="topNRelationships === 100 ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                        class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                        Top 100
                                    </button>
                    </div>
                            </div>
                            <!-- Expand Button -->
                            <button onclick="openExpandModal('topRelationships')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                                <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                                    <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                                </svg>
                            </button>
                            <!-- Three Dots Menu -->
                            <div x-data="{openDropDown: false}" class="relative">
                                <button @click="openDropDown = !openDropDown"
                                    :class="openDropDown ? 'text-gray-900' : 'text-gray-600 hover:text-gray-900'"
                                    class="transition-colors p-1">
                                    <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M10.2441 6C10.2441 5.0335 11.0276 4.25 11.9941 4.25H12.0041C12.9706 4.25 13.7541 5.0335 13.7541 6C13.7541 6.9665 12.9706 7.75 12.0041 7.75H11.9941C11.0276 7.75 10.2441 6.9665 10.2441 6ZM10.2441 18C10.2441 17.0335 11.0276 16.25 11.9941 16.25H12.0041C12.9706 16.25 13.7541 17.0335 13.7541 18C13.7541 18.9665 12.9706 19.75 12.0041 19.75H11.9941C11.0276 19.75 10.2441 18.9665 10.2441 18ZM11.9941 10.25C11.0276 10.25 10.2441 11.0335 10.2441 12C10.2441 12.9665 11.0276 13.75 11.9941 13.75H12.0041C12.9706 13.75 13.7541 12.9665 13.7541 12C13.7541 11.0335 12.9706 10.25 12.0041 10.25H11.9941Z" fill="" />
                                    </svg>
                                </button>
                                <div x-show="openDropDown" @click.outside="openDropDown = false"
                                    class="absolute right-0 top-full z-40 w-40 space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                    <button onclick="openChartDataModal('topRelationships')" @click="openDropDown = false"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        View Data
                                    </button>
                                    <button onclick="openMethodologyModal('topRelationships')" @click="openDropDown = false"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        View Methodology
                                    </button>
                                    <button onclick="exportChartData('topRelationships')" @click="openDropDown = false"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        Export Data
                                    </button>
                </div>
                    </div>
                        </div>
                        <!-- Hidden elements for backward compatibility with existing JavaScript -->
                        <select id="topNFilter" style="display: none;">
                            <option value="10" selected>Top 10</option>
                            <option value="20">Top 20</option>
                            <option value="30">Top 30</option>
                            <option value="40">Top 40</option>
                            <option value="50">Top 50</option>
                            <option value="100">Top 100</option>
                        </select>
                        <button id="btnAmountDirect" style="display: none;"></button>
                        <button id="btnAmountContingent" style="display: none;"></button>
                        <button id="btnAmountPSE" style="display: none;"></button>
                        <button id="btnAmountOSUC" style="display: none;"></button>
                        <button id="btnAmountUnused" style="display: none;"></button>
                        <button id="btnAmountTFA" style="display: none;"></button>
                    </div>
                    <div class="flex-1 w-full overflow-y-auto overflow-x-hidden custom-scrollbar"
                        style="max-height: 450px">
                        <div id="relationshipChart" class="-ml-5 pl-2"></div>
                    </div>
                </div>
            </div>

            <!-- ROTCE Performance -->
            <div class="col-span-12 xl:col-span-6">
                <div
                    class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6 sm:pt-5 h-full flex flex-col">
                    <div class="mb-5 flex items-start justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">
                                ROTCE Performance
                            </h3>
                            <p class="mt-1 text-gray-500 text-sm" id="rotceSubtitle">
                                Top N relationships ROTCE performance
                            </p>
                        </div>
                        <div class="flex items-center gap-0.5">
                            <!-- Expand Button -->
                            <button onclick="openExpandModal('rotce')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                                <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                                    <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                                </svg>
                            </button>
                            <!-- Three Dots Menu -->
                        <div x-data="{openDropDown: false}" class="relative">
                                <button @click="openDropDown = !openDropDown"
                                    :class="openDropDown ? 'text-gray-900' : 'text-gray-600 hover:text-gray-900'"
                                    class="transition-colors p-1">
                                    <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M10.2441 6C10.2441 5.0335 11.0276 4.25 11.9941 4.25H12.0041C12.9706 4.25 13.7541 5.0335 13.7541 6C13.7541 6.9665 12.9706 7.75 12.0041 7.75H11.9941C11.0276 7.75 10.2441 6.9665 10.2441 6ZM10.2441 18C10.2441 17.0335 11.0276 16.25 11.9941 16.25H12.0041C12.9706 16.25 13.7541 17.0335 13.7541 18C13.7541 18.9665 12.9706 19.75 12.0041 19.75H11.9941C11.0276 19.75 10.2441 18.9665 10.2441 18ZM11.9941 10.25C11.0276 10.25 10.2441 11.0335 10.2441 12C10.2441 12.9665 11.0276 13.75 11.9941 13.75H12.0041C12.9706 13.75 13.7541 12.9665 13.7541 12C13.7541 11.0335 12.9706 10.25 12.0041 10.25H11.9941Z" fill="" />
                                    </svg>
                                </button>
                                <div x-show="openDropDown" @click.outside="openDropDown = false"
                                    class="absolute right-0 z-40 w-40 p-2 space-y-1 bg-white border border-gray-200 shadow-theme-lg top-full rounded-2xl mt-2">
                                    <button onclick="openChartDataModal('rotce')" @click="openDropDown = false"
                                        class="flex w-full px-3 py-2 font-medium text-left text-gray-500 rounded-lg text-xs hover:bg-gray-100 hover:text-gray-700">
                                        View Data
                                    </button>
                                    <button onclick="openMethodologyModal('rotce')" @click="openDropDown = false"
                                        class="flex w-full px-3 py-2 font-medium text-left text-gray-500 rounded-lg text-xs hover:bg-gray-100 hover:text-gray-700">
                                        View Methodology
                                    </button>
                                    <button onclick="exportChartData('rotce')" @click="openDropDown = false"
                                        class="flex w-full px-3 py-2 font-medium text-left text-gray-500 rounded-lg text-xs hover:bg-gray-100 hover:text-gray-700">
                                        Export Data
                                    </button>
                                </div>
                                </div>
                        </div>
                    </div>

                    <!-- ROTCE Chart -->
                    <div class="flex-1 w-full overflow-y-auto overflow-x-hidden custom-scrollbar"
                        style="max-height: 450px">
                        <div id="rotceChart" class="-ml-5 pl-2" style="min-height: 280px;">
                            <!-- Chart will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Covenants and Reviews Section -->
        <div class="grid grid-cols-12 gap-4 md:gap-6 mb-6">
            <!-- Covenant Monitoring Dashboard (Past Due Covenants) -->
            <div class="col-span-12 xl:col-span-4">
                <div class="overflow-hidden rounded-2xl border border-gray-200 bg-white h-full flex flex-col relative" x-data="{ covenantView: 'pastDue' }">
                    <!-- Action Buttons - Absolute Top Right -->
                    <div class="absolute top-2 right-2 flex items-center gap-0.5 z-10">
                        <button onclick="openExpandModal('covenantMonitoring')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                            <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                                <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                            </svg>
                        </button>
                        <div x-data="{openDropDown: false}" class="relative">
                            <button @click="openDropDown = !openDropDown"
                                :class="openDropDown ? 'text-gray-900' : 'text-gray-600 hover:text-gray-900'"
                                class="transition-colors p-1">
                                <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.3" stroke="currentColor">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M10.2441 6C10.2441 5.0335 11.0276 4.25 11.9941 4.25H12.0041C12.9706 4.25 13.7541 5.0335 13.7541 6C13.7541 6.9665 12.9706 7.75 12.0041 7.75H11.9941C11.0276 7.75 10.2441 6.9665 10.2441 6ZM10.2441 18C10.2441 17.0335 11.0276 16.25 11.9941 16.25H12.0041C12.9706 16.25 13.7541 17.0335 13.7541 18C13.7541 18.9665 12.9706 19.75 12.0041 19.75H11.9941C11.0276 19.75 10.2441 18.9665 10.2441 18ZM11.9941 10.25C11.0276 10.25 10.2441 11.0335 10.2441 12C10.2441 12.9665 11.0276 13.75 11.9941 13.75H12.0041C12.9706 13.75 13.7541 12.9665 13.7541 12C13.7541 11.0335 12.9706 10.25 12.0041 10.25H11.9941Z" fill="" />
                                </svg>
                            </button>
                            <div x-show="openDropDown" @click.outside="openDropDown = false"
                                class="absolute right-0 top-full z-40 w-48 space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                <button @click="openDropDown = false; openChartDataModal('covenantMonitoring')"
                                    class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                    View Data
                                </button>
                                <button @click="openDropDown = false; openMethodologyModal('covenantMonitoring')"
                                    class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                    View Methodology
                                </button>
                                <button @click="openDropDown = false; exportChartData('covenantMonitoring')"
                                    class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                    Export Data
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between px-5 pt-5 sm:px-6 sm:pt-6 pb-4">
                        <div class="pr-14">
                            <h3 class="text-lg font-semibold text-gray-800" x-text="covenantView === 'pastDue' ? 'Past Due Covenants' : 'Coming Due Covenants'">
                                Past Due Covenants
                    </h3>
                            <p class="mt-1 text-sm text-gray-500" x-text="covenantView === 'pastDue' ? 'Covenants past their due date' : 'Covenants due in the next 30 days'">
                                Covenants past their due date
                    </p>
                </div>
                        <div class="flex items-center gap-2">
                            <!-- Toggle Filter (Smaller) -->
                            <div class="flex items-center gap-1 bg-gray-100 rounded-lg p-0.5">
                                <button @click="covenantView = 'pastDue'; updateCovenantChart('pastDue')"
                                    :class="covenantView === 'pastDue' ? 'bg-white shadow-sm text-gray-900 font-medium' : 'text-gray-600'"
                                    class="px-2 py-1 text-xs rounded-md transition-all duration-200">
                                    Past Due
                                </button>
                                <button @click="covenantView = 'comingDue'; updateCovenantChart('comingDue')"
                                    :class="covenantView === 'comingDue' ? 'bg-white shadow-sm text-gray-900 font-medium' : 'text-gray-600'"
                                    class="px-2 py-1 text-xs rounded-md transition-all duration-200">
                                    Coming Due
                                </button>
                </div>
            </div>
            </div>

                    <!-- Donut Chart and Legends -->
                    <div class="flex flex-col items-center px-5 py-6 flex-1">
                        <div id="covenantMonitoringChart" class="chartDarkStyle"></div>
                        <div id="covenantMonitoringLegend" class="flex flex-row items-center justify-center gap-4 sm:gap-6 mt-6 flex-wrap">
                            <!-- Legend items will be dynamically generated -->
                                </div>
                    </div>
                </div>
            </div>

            <!-- Regional Distribution Table -->
            <div class="col-span-12 xl:col-span-4">
                <div class="overflow-hidden rounded-2xl border border-gray-200 bg-white h-full flex flex-col relative">
                    <!-- Action Buttons - Absolute Top Right -->
                    <div class="absolute top-2 right-2 flex items-center gap-0.5 z-10">
                        <button onclick="openExpandModal('covenantRegional')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                            <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                                <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                            </svg>
                        </button>
                        <div x-data="{openDropDown: false}" class="relative">
                                <button @click="openDropDown = !openDropDown"
                                :class="openDropDown ? 'text-gray-900' : 'text-gray-600 hover:text-gray-900'"
                                class="transition-colors p-1">
                                <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.3" stroke="currentColor">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M10.2441 6C10.2441 5.0335 11.0276 4.25 11.9941 4.25H12.0041C12.9706 4.25 13.7541 5.0335 13.7541 6C13.7541 6.9665 12.9706 7.75 12.0041 7.75H11.9941C11.0276 7.75 10.2441 6.9665 10.2441 6ZM10.2441 18C10.2441 17.0335 11.0276 16.25 11.9941 16.25H12.0041C12.9706 16.25 13.7541 17.0335 13.7541 18C13.7541 18.9665 12.9706 19.75 12.0041 19.75H11.9941C11.0276 19.75 10.2441 18.9665 10.2441 18ZM11.9941 10.25C11.0276 10.25 10.2441 11.0335 10.2441 12C10.2441 12.9665 11.0276 13.75 11.9941 13.75H12.0041C12.9706 13.75 13.7541 12.9665 13.7541 12C13.7541 11.0335 12.9706 10.25 12.0041 10.25H11.9941Z" fill="" />
                            </svg>
                                </button>
                                <div x-show="openDropDown" @click.outside="openDropDown = false"
                                    class="absolute right-0 top-full z-40 w-48 space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                <button @click="openDropDown = false; openChartDataModal('covenantRegional')"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        View Data
                                    </button>
                                <button @click="openDropDown = false; openMethodologyModal('covenantRegional')"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        View Methodology
                                    </button>
                                <button @click="openDropDown = false; exportChartData('covenantRegional')"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        Export Data
                        </button>
                                </div>
                    </div>
                </div>
                    <div class="flex items-center justify-between px-5 pt-5 sm:px-6 sm:pt-6 pb-4">
                        <div class="pr-14">
                            <h3 class="text-lg font-semibold text-gray-800" id="covenantRegionalTableTitle">
                                Past Due Covenants by Region
                            </h3>
                            <p class="mt-1 text-sm text-gray-500" id="covenantRegionalTableSubtitle">
                                Regional breakdown of past due covenants
                            </p>
                    </div>
                </div>
                    <div class="max-w-full overflow-x-auto flex-1">
                        <table class="w-full table-auto h-full">
                    <thead>
                                <tr class="bg-gray-50 text-left" id="covenantRegionalTableHeader">
                                    <th class="px-2 py-2 text-xs font-semibold text-gray-700 tracking-wider whitespace-nowrap">Region</th>
                                    <th class="px-2 py-2 text-xs font-semibold text-gray-700 tracking-wider text-center whitespace-nowrap">1-45</th>
                                    <th class="px-2 py-2 text-xs font-semibold text-gray-700 tracking-wider text-center whitespace-nowrap">46-90</th>
                                    <th class="px-2 py-2 text-xs font-semibold text-gray-700 tracking-wider text-center whitespace-nowrap">&gt;90</th>
                                    <th class="px-2 py-2 text-xs font-semibold text-gray-700 tracking-wider text-center whitespace-nowrap">Total</th>
                                    <th class="px-2 py-2 text-xs font-semibold text-gray-700 tracking-wider text-center whitespace-nowrap">Sum</th>
                                    <th class="px-2 py-2 text-xs font-semibold text-gray-700 tracking-wider text-center whitespace-nowrap" style="min-width: 70px;">% Total</th>
                                </tr>
                            </thead>
                            <tbody id="covenantRegionalTableBody" class="divide-y divide-gray-200">
                                <tr>
                                    <td colspan="7" class="px-5 py-4 text-center text-sm text-gray-500">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
            </div>
                </div>
            </div>

            <!-- CCM Regional Distribution Chart (Stacked Bar) -->
            <div class="col-span-12 xl:col-span-4">
                <div class="rounded-2xl border border-gray-200 bg-white p-5 sm:p-6 h-full flex flex-col pb-0 relative">
                    <!-- Action Buttons - Absolute Top Right -->
                    <div class="absolute top-2 right-2 flex items-center gap-0.5 z-10">
                        <button onclick="openExpandModal('ccmRegionalChart')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                            <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                                <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                            </svg>
                        </button>
                        <div x-data="{openDropDown: false}" class="relative">
                            <button @click="openDropDown = !openDropDown"
                                :class="openDropDown ? 'text-gray-900' : 'text-gray-600 hover:text-gray-900'"
                                class="transition-colors p-1">
                                <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.3" stroke="currentColor">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M10.2441 6C10.2441 5.0335 11.0276 4.25 11.9941 4.25H12.0041C12.9706 4.25 13.7541 5.0335 13.7541 6C13.7541 6.9665 12.9706 7.75 12.0041 7.75H11.9941C11.0276 7.75 10.2441 6.9665 10.2441 6ZM10.2441 18C10.2441 17.0335 11.0276 16.25 11.9941 16.25H12.0041C12.9706 16.25 13.7541 17.0335 13.7541 18C13.7541 18.9665 12.9706 19.75 12.0041 19.75H11.9941C11.0276 19.75 10.2441 18.9665 10.2441 18ZM11.9941 10.25C11.0276 10.25 10.2441 11.0335 10.2441 12C10.2441 12.9665 11.0276 13.75 11.9941 13.75H12.0041C12.9706 13.75 13.7541 12.9665 13.7541 12C13.7541 11.0335 12.9706 10.25 12.0041 10.25H11.9941Z" fill="" />
                                        </svg>
                            </button>
                            <div x-show="openDropDown" @click.outside="openDropDown = false"
                                class="absolute right-0 top-full z-40 w-40 space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                <button @click="openDropDown = false; openChartDataModal('ccmRegionalChart')"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        View Data
                                    </button>
                                <button @click="openDropDown = false; openMethodologyModal('ccmRegionalChart')"
                                        class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                        View Methodology
                                    </button>
                                <button @click="openDropDown = false; exportChartData('ccmRegionalChart')"
                                    class="flex w-full rounded-lg px-3 py-2 text-left text-xs font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-700">
                                    Export Data
                        </button>
                    </div>
                        </div>
                    </div>
                    <div class="mb-6 flex justify-between">
                        <div class="pr-14">
                            <h3 class="text-lg font-semibold text-gray-800">
                                Criticized/Classified Memos & Reviews
                            </h3>
                            <p class="mt-1 text-sm text-gray-500">
                                Regional distribution of credit committee memo status
                            </p>
                        </div>
                    </div>
                    <div class="flex-1 flex items-center">
                        <div id="ccmRegionalChart" class="w-full"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Important Notes -->
        <div class="overflow-hidden rounded-xl border border-gray-200 bg-white">
            <div class="flex items-center gap-3 px-5 py-4">
                <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-blue-100 shrink-0">
                    <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="flex-1">
                    <h4 class="text-sm font-semibold text-gray-800 mb-1">
                        Important Notes
                    </h4>
                    <div class="text-xs text-gray-600 space-y-2.5">
                        <div class="flex items-start gap-2">
                            <span class="font-semibold text-gray-700 mt-0.5">*</span>
                            <p>
                                <span class="font-semibold text-gray-700">Unused Commitment (UC):</span>
                                Undrawn portion of committed facility.
                            </p>
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="font-semibold text-gray-700 mt-0.5">*</span>
                            <p>
                                <span class="font-semibold text-gray-700">Outstanding (OS):</span>
                                Drawn amount or calculated exposure.
                            </p>
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="font-semibold text-gray-700 mt-0.5">*</span>
                            <p>
                                <span class="font-semibold text-gray-700">OSUC (Outstanding and Unused Commitment):</span>
                                For committed facilities, OSUC = Outstanding + Unused Commitment. For uncommitted facilities, OSUC = Outstanding.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Methodology Modal -->
        <div id="methodologyModal" class="fixed inset-0 z-[9999] hidden items-center justify-center p-5">
            <div class="modal-close-btn fixed inset-0 h-full w-full bg-gray-400/50 backdrop-blur-[32px]"
                onclick="closeMethodologyModal()"></div>
            <div class="relative w-full max-w-[600px] max-h-[85vh] rounded-3xl bg-white shadow-2xl flex flex-col">
                <!-- Close button -->
                <button onclick="closeMethodologyModal()" type="button"
                    class="absolute right-3 top-3 z-[9999] flex h-9.5 w-9.5 items-center justify-center rounded-full bg-gray-100 text-gray-400 transition-colors hover:bg-gray-200 hover:text-gray-700 sm:right-6 sm:top-6 sm:h-11 sm:w-11 cursor-pointer">
                    <svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M6.04289 16.5413C5.65237 16.9318 5.65237 17.565 6.04289 17.9555C6.43342 18.346 7.06658 18.346 7.45711 17.9555L11.9987 13.4139L16.5408 17.956C16.9313 18.3466 17.5645 18.3466 17.955 17.956C18.3455 17.5655 18.3455 16.9323 17.955 16.5418L13.4129 11.9997L17.955 7.4576C18.3455 7.06707 18.3455 6.43391 17.955 6.04338C17.5645 5.65286 16.9313 5.65286 16.5408 6.04338L11.9987 10.5855L7.45711 6.0439C7.06658 5.65338 6.43342 5.65338 6.04289 6.0439C5.65237 6.43442 5.65237 7.06759 6.04289 7.45811L10.5845 11.9997L6.04289 16.5413Z"
                            fill="" />
                    </svg>
                </button>

                <!-- Fixed Header -->
                <div class="flex-shrink-0 text-center p-6 lg:px-10 lg:pt-10 lg:pb-6">
                    <div class="relative flex items-center justify-center z-1 mb-4">
                        <svg class="fill-blue-50" width="70" height="70" viewBox="0 0 90 90" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M34.364 6.85053C38.6205 -2.28351 51.3795 -2.28351 55.636 6.85053C58.0129 11.951 63.5594 14.6722 68.9556 13.3853C78.6192 11.0807 86.5743 21.2433 82.2185 30.3287C79.7862 35.402 81.1561 41.5165 85.5082 45.0122C93.3019 51.2725 90.4628 63.9451 80.7747 66.1403C75.3648 67.3661 71.5265 72.2695 71.5572 77.9156C71.6123 88.0265 60.1169 93.6664 52.3918 87.3184C48.0781 83.7737 41.9219 83.7737 37.6082 87.3184C29.8831 93.6664 18.3877 88.0266 18.4428 77.9156C18.4735 72.2695 14.6352 67.3661 9.22531 66.1403C-0.462787 63.9451 -3.30193 51.2725 4.49185 45.0122C8.84391 41.5165 10.2138 35.402 7.78151 30.3287C3.42572 21.2433 11.3808 11.0807 21.0444 13.3853C26.4406 14.6722 31.9871 11.951 34.364 6.85053Z"
                                fill="" fill-opacity="" />
                        </svg>
                        <span class="absolute -translate-x-1/2 -translate-y-1/2 left-1/2 top-1/2">
                            <svg class="fill-blue-600" width="32" height="32" viewBox="0 0 38 38" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" clip-rule="evenodd"
                                    d="M5.85547 18.9998C5.85547 11.7396 11.7411 5.854 19.0013 5.854C26.2615 5.854 32.1471 11.7396 32.1471 18.9998C32.1471 26.2601 26.2615 32.1457 19.0013 32.1457C11.7411 32.1457 5.85547 26.2601 5.85547 18.9998ZM19.0013 2.854C10.0842 2.854 2.85547 10.0827 2.85547 18.9998C2.85547 27.9169 10.0842 35.1457 19.0013 35.1457C27.9184 35.1457 35.1471 27.9169 35.1471 18.9998C35.1471 10.0827 27.9184 2.854 19.0013 2.854ZM16.9999 11.9145C16.9999 13.0191 17.8953 13.9145 18.9999 13.9145H19.0015C20.106 13.9145 21.0015 13.0191 21.0015 11.9145C21.0015 10.81 20.106 9.91454 19.0015 9.91454H18.9999C17.8953 9.91454 16.9999 10.81 16.9999 11.9145ZM19.0014 27.8171C18.173 27.8171 17.5014 27.1455 17.5014 26.3171V17.3293C17.5014 16.5008 18.173 15.8293 19.0014 15.8293C19.8299 15.8293 20.5014 16.5008 20.5014 17.3293L20.5014 26.3171C20.5014 27.1455 19.8299 27.8171 19.0014 27.8171Z"
                                    fill="" />
                            </svg>
                        </span>
    </div>

                    <h4 class="text-xl font-semibold text-gray-800 sm:text-2xl" id="methodologyModalTitle">
                        Chart Methodology
                    </h4>
                </div>

                <!-- Scrollable Content -->
                <div class="flex-1 overflow-y-auto px-6 lg:px-10">
                    <div class="text-sm leading-6 text-gray-600 text-left pb-4" id="methodologyModalContent">
                        <!-- Dynamic content will be inserted here -->
                    </div>
                </div>

                <!-- Fixed Footer -->
                <div class="flex-shrink-0 border-t border-gray-100 p-6 lg:px-10 lg:pb-10 lg:pt-6">
                    <div class="flex items-center justify-center w-full">
                        <button type="button" onclick="closeMethodologyModal()"
                            class="flex justify-center w-full px-4 py-3 text-sm font-medium text-white rounded-lg bg-blue-600 shadow-theme-xs hover:bg-blue-700 sm:w-auto">
                            Okay, Got It
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Data Viewer Modal -->
        <div id="chartDataModal" class="fixed inset-0 z-[9999] hidden overflow-y-auto" aria-labelledby="modal-title"
            role="dialog" aria-modal="true">
            <!-- Background overlay -->
            <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" onclick="closeChartDataModal()">
            </div>

            <!-- Modal panel -->
            <div class="flex min-h-full items-center justify-center p-4">
                <div
                    class="relative w-full max-w-7xl transform overflow-hidden rounded-2xl bg-white shadow-2xl transition-all">
                    <!-- Modal header -->
                    <div class="border-b border-gray-200 bg-white px-6 py-4">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-900" id="chartDataModalTitle">
                                    Chart Data
                                </h3>
                                <p class="mt-1 text-sm text-gray-500" id="chartDataModalSubtitle">
                                    Viewing underlying data
                                </p>
                            </div>
                            <div class="flex items-center gap-3">
                                <!-- Clear All Filters Button -->
                                <button id="clearFiltersBtn" onclick="clearAllTableFilters()" 
                                    class="hidden items-center gap-2 rounded-lg border border-red-300 bg-red-50 px-4 py-2 text-sm font-medium text-red-700 hover:bg-red-100 transition-colors">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                    Clear All Filters
                                </button>
                                <button onclick="exportModalData()"
                                    class="flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                        </path>
                                    </svg>
                                    Export XLSX
                                </button>
                                <button onclick="closeChartDataModal()" type="button"
                                    class="flex h-9.5 w-9.5 items-center justify-center rounded-full bg-gray-100 text-gray-400 transition-colors hover:bg-gray-200 hover:text-gray-700 sm:h-11 sm:w-11 cursor-pointer">
                                    <svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" clip-rule="evenodd"
                                            d="M6.04289 16.5413C5.65237 16.9318 5.65237 17.565 6.04289 17.9555C6.43342 18.346 7.06658 18.346 7.45711 17.9555L11.9987 13.4139L16.5408 17.956C16.9313 18.3466 17.5645 18.3466 17.955 17.956C18.3455 17.5655 18.3455 16.9323 17.955 16.5418L13.4129 11.9997L17.955 7.4576C18.3455 7.06707 18.3455 6.43391 17.955 6.04338C17.5645 5.65286 16.9313 5.65286 16.5408 6.04338L11.9987 10.5855L7.45711 6.0439C7.06658 5.65338 6.43342 5.65338 6.04289 6.0439C5.65237 6.43442 5.65237 7.06759 6.04289 7.45811L10.5845 11.9997L6.04289 16.5413Z"
                                            fill="" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Modal body with scrollable table -->
                    <div class="max-h-[70vh] overflow-auto bg-white">
                        <table class="min-w-full">
                            <thead class="sticky top-0 z-40 bg-gray-50 border-b-2 border-gray-300">
                                <tr id="chartDataTableHeader">
                                    <!-- Dynamic headers will be inserted here -->
                                </tr>
                                <tr id="chartDataTableFilters">
                                    <!-- Dynamic filter inputs will be inserted here -->
                                </tr>
                            </thead>
                            <tbody id="chartDataTableBody" class="divide-y divide-gray-200 bg-white">
                                <!-- Dynamic rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Modal footer with pagination -->
                    <div class="border-t border-gray-200 bg-gray-50 px-6 py-4" x-data="{openPageSize: false, pageSize: 100}">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                            <p class="text-sm text-gray-500">
                                    Showing <span id="dataRowsStart">0</span> to <span id="dataRowsEnd">0</span> of <span id="dataTotalRows">0</span> records
                                </p>
                                <!-- Page Size Dropdown -->
                                <div class="relative">
                                    <button @click="openPageSize = !openPageSize"
                                        class="inline-flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                        <span x-text="pageSize + ' per page'"></span>
                                        <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>
                                    <div x-show="openPageSize" @click.outside="openPageSize = false"
                                        class="absolute left-0 bottom-full z-40 w-32 space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mb-2">
                                        <button
                                            @click="pageSize = 50; openPageSize = false; document.getElementById('dataPageSize').value = 50; document.getElementById('dataPageSize').dispatchEvent(new Event('change'));"
                                            :class="pageSize === 50 ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                            class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                            50 per page
                                        </button>
                                        <button
                                            @click="pageSize = 100; openPageSize = false; document.getElementById('dataPageSize').value = 100; document.getElementById('dataPageSize').dispatchEvent(new Event('change'));"
                                            :class="pageSize === 100 ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                            class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                            100 per page
                                        </button>
                                        <button
                                            @click="pageSize = 250; openPageSize = false; document.getElementById('dataPageSize').value = 250; document.getElementById('dataPageSize').dispatchEvent(new Event('change'));"
                                            :class="pageSize === 250 ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                            class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                            250 per page
                                        </button>
                                        <button
                                            @click="pageSize = 500; openPageSize = false; document.getElementById('dataPageSize').value = 500; document.getElementById('dataPageSize').dispatchEvent(new Event('change'));"
                                            :class="pageSize === 500 ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                            class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                            500 per page
                            </button>
                        </div>
                    </div>
                                <!-- Hidden select for backward compatibility -->
                                <select id="dataPageSize" style="display: none;">
                                    <option value="50">50 per page</option>
                                    <option value="100" selected>100 per page</option>
                                    <option value="250">250 per page</option>
                                    <option value="500">500 per page</option>
                                </select>
                </div>
                            <div class="flex items-center gap-2">
                                <button id="dataPrevBtn" class="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                    Previous
                                </button>
                                <span class="text-sm text-gray-600">
                                    Page <span id="dataCurrentPage">1</span> of <span id="dataTotalPages">1</span>
                                </span>
                                <button id="dataNextBtn" class="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                    Next
                                </button>
            </div>
        </div>
        </div>
            </div>
        </div>
        </div>
        </div>

        <!-- Expand/Details Modal -->
        <div id="expandModal" class="fixed inset-0 z-[9999] hidden overflow-y-auto" aria-labelledby="expand-modal-title" role="dialog" aria-modal="true">
            <!-- Background overlay -->
            <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" onclick="closeExpandModal()"></div>

            <!-- Modal panel -->
            <div class="flex min-h-full items-center justify-center p-4">
                <div class="relative w-full max-w-[1400px] transform overflow-hidden rounded-2xl bg-white shadow-2xl transition-all">
                    <!-- Modal header -->
                    <div class="border-b border-gray-200 bg-white px-6 py-4">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-900" id="expandModalTitle">
                                    Details
                                </h3>
                                <p class="mt-1 text-sm text-gray-500" id="expandModalSubtitle">
                                    Expanded view with additional details
                                </p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="viewDataFromExpandModal()" type="button"
                                    class="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                    View Data
                                </button>
                                <button onclick="closeExpandModal()" type="button"
                                    class="flex h-9.5 w-9.5 items-center justify-center rounded-full bg-gray-100 text-gray-400 transition-colors hover:bg-gray-200 hover:text-gray-700 sm:h-11 sm:w-11 cursor-pointer">
                                    <svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M6.04289 16.5413C5.65237 16.9318 5.65237 17.565 6.04289 17.9555C6.43342 18.346 7.06658 18.346 7.45711 17.9555L11.9987 13.4139L16.5408 17.956C16.9313 18.3466 17.5645 18.3466 17.955 17.956C18.3455 17.5655 18.3455 16.9323 17.955 16.5418L13.4129 11.9997L17.955 7.4576C18.3455 7.06707 18.3455 6.43391 17.955 6.04338C17.5645 5.65286 16.9313 5.65286 16.5408 6.04338L11.9987 10.5855L7.45711 6.0439C7.06658 5.65338 6.43342 5.65338 6.04289 6.0439C5.65237 6.43442 5.65237 7.06759 6.04289 7.45811L10.5845 11.9997L6.04289 16.5413Z" fill="" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Modal content -->
                    <div class="max-h-[75vh] overflow-auto bg-white p-6" id="expandModalContent">
                        <!-- Dynamic content will be inserted here -->
                        <div class="flex items-center justify-center py-12 text-gray-400">
                            <svg class="animate-spin h-8 w-8 mr-3" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Loading details...
                        </div>
                    </div>

                    <!-- Modal footer -->
                    <div class="border-t border-gray-200 bg-gray-50 px-6 py-4">
                        <p class="text-sm text-gray-500" id="expandModalFooterText">
                            Click outside or press ESC to close
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- End Portfolio Overview Tab -->

        <!-- Portfolio Balances Tab Content -->
        <div x-show="activeTab === 'balances'" style="display: none;">
            <!-- Logistics-Style Layout: 3 Horizontal Metric Cards + Large Chart + Side Panel -->
            
            <!-- Row 1: 3 Horizontal Metric Cards (Logistics Style) -->
            <div class="mb-6 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3 md:gap-6">
                <!-- Total Notional Balance - Horizontal Card -->
                <article class="flex items-center gap-5 rounded-2xl border border-gray-200 bg-white p-4">
                    <div class="inline-flex h-16 w-16 shrink-0 items-center justify-center rounded-xl bg-blue-100 text-blue-600">
                        <svg class="h-7 w-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                </div>
                    <div>
                        <h3 class="text-2xl font-semibold text-gray-800">$--</h3>
                        <p class="flex items-center gap-3 text-gray-500">
                            Total Notional Balance
                            <span class="inline-flex items-center justify-center gap-1 rounded-full bg-green-100 px-2.5 py-0.5 text-sm font-medium text-green-600">+--</span>
                        </p>
                    </div>
                </article>
                
                <!-- Total Committed Balance - Horizontal Card -->
                <article class="flex items-center gap-5 rounded-2xl border border-gray-200 bg-white p-4">
                    <div class="inline-flex h-16 w-16 shrink-0 items-center justify-center rounded-xl bg-green-100 text-green-600">
                        <svg class="h-7 w-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-2xl font-semibold text-gray-800">$--</h3>
                        <p class="flex items-center gap-3 text-gray-500">
                            Total Committed
                            <span class="inline-flex items-center justify-center gap-1 rounded-full bg-green-100 px-2.5 py-0.5 text-sm font-medium text-green-600">+--</span>
                        </p>
                    </div>
                </article>

                <!-- Total Outstanding - Horizontal Card -->
                <article class="flex items-center gap-5 rounded-2xl border border-gray-200 bg-white p-4">
                    <div class="inline-flex h-16 w-16 shrink-0 items-center justify-center rounded-xl bg-purple-100 text-purple-600">
                        <svg class="h-7 w-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-2xl font-semibold text-gray-800">$--</h3>
                        <p class="flex items-center gap-3 text-gray-500">
                            Total Outstanding
                            <span class="inline-flex items-center justify-center gap-1 rounded-full bg-amber-100 px-2.5 py-0.5 text-sm font-medium text-amber-600">--% util</span>
                        </p>
                    </div>
                </article>
            </div>

            <!-- Row 2: Large Chart (8) + Side Panel (4) -->
            <div class="mb-6 grid grid-cols-12 gap-4 md:gap-6">
                <!-- Balance Trend Chart - Large -->
                <div class="col-span-12 xl:col-span-8">
                    <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6 h-full">
                        <div class="mb-5 flex items-start justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">Balance Trend Over Time</h3>
                                <p class="mt-1 text-gray-500 text-sm">Historical trend of portfolio balances across reporting periods</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="rounded-lg px-3 py-1.5 text-sm font-medium text-gray-500 hover:bg-gray-100">1M</button>
                                <button class="rounded-lg px-3 py-1.5 text-sm font-medium bg-blue-100 text-blue-600">3M</button>
                                <button class="rounded-lg px-3 py-1.5 text-sm font-medium text-gray-500 hover:bg-gray-100">YTD</button>
                            </div>
                        </div>
                        <div class="flex items-center justify-center h-80 bg-gray-50 rounded-lg">
                            <div class="text-center text-gray-400">
                                <svg class="h-12 w-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                            </svg>
                                <p class="text-sm font-medium">Area Chart Placeholder</p>
                                <p class="text-xs mt-1">Balance trend with Notional, Committed, Outstanding lines</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Regional Distribution - Side Panel -->
                <div class="col-span-12 xl:col-span-4">
                    <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6 h-full">
                        <div class="mb-5">
                            <h3 class="text-lg font-semibold text-gray-800">Regional Distribution</h3>
                            <p class="mt-1 text-gray-500 text-sm">Balance breakdown by region</p>
                        </div>
                        <div class="space-y-4">
                            <!-- APAC -->
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="h-3 w-3 rounded-full bg-blue-500"></div>
                                    <span class="text-sm text-gray-600">APAC</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-24 h-2 bg-gray-100 rounded-full overflow-hidden">
                                        <div class="h-full bg-blue-500 rounded-full" style="width: 35%"></div>
                                    </div>
                                    <span class="text-sm font-medium text-gray-800 w-12 text-right">35%</span>
                                </div>
                            </div>
                            <!-- EMEA -->
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="h-3 w-3 rounded-full bg-green-500"></div>
                                    <span class="text-sm text-gray-600">EMEA</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-24 h-2 bg-gray-100 rounded-full overflow-hidden">
                                        <div class="h-full bg-green-500 rounded-full" style="width: 28%"></div>
                                    </div>
                                    <span class="text-sm font-medium text-gray-800 w-12 text-right">28%</span>
                                </div>
                            </div>
                            <!-- NAM -->
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="h-3 w-3 rounded-full bg-purple-500"></div>
                                    <span class="text-sm text-gray-600">NAM</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-24 h-2 bg-gray-100 rounded-full overflow-hidden">
                                        <div class="h-full bg-purple-500 rounded-full" style="width: 25%"></div>
                                    </div>
                                    <span class="text-sm font-medium text-gray-800 w-12 text-right">25%</span>
                                </div>
                            </div>
                            <!-- LATAM -->
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="h-3 w-3 rounded-full bg-amber-500"></div>
                                    <span class="text-sm text-gray-600">LATAM</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-24 h-2 bg-gray-100 rounded-full overflow-hidden">
                                        <div class="h-full bg-amber-500 rounded-full" style="width: 12%"></div>
                                    </div>
                                    <span class="text-sm font-medium text-gray-800 w-12 text-right">12%</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6 pt-4 border-t border-gray-100">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-500">Total Portfolio</span>
                                <span class="font-semibold text-gray-800">$-- B</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Row 3: Full Width Table -->
            <div class="mb-6">
                <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6">
                    <div class="mb-5 flex items-start justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Balance Breakdown by Product Program</h3>
                            <p class="mt-1 text-gray-500 text-sm">Detailed breakdown with notional, committed, outstanding balances and utilization</p>
                        </div>
                        <button class="flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-1.5 text-sm font-medium text-gray-600 hover:bg-gray-50">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                    </svg>
                            Export
                                </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-gray-500">
                            <thead class="text-sm text-gray-700 bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left whitespace-nowrap">Product Program</th>
                                    <th class="px-4 py-3 text-right whitespace-nowrap">Notional</th>
                                    <th class="px-4 py-3 text-right whitespace-nowrap">Committed</th>
                                    <th class="px-4 py-3 text-right whitespace-nowrap">Outstanding</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">Utilization</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b hover:bg-gray-50">
                                    <td colspan="6" class="px-4 py-8 text-center text-gray-400">
                                        <div class="flex flex-col items-center gap-2">
                                            <svg class="h-8 w-8 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                            <p class="text-sm">Placeholder for balance breakdown by Product_Program_Name</p>
                            </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>
        </div>
        <!-- End Portfolio Balances Tab -->

        <!-- Team View Tab Content - eCommerce Style Layout -->
        <div x-show="activeTab === 'team'" style="display: none;">
            <!-- Row 1: Metrics (7) + Donut Chart (5) - eCommerce style -->
            <div class="mb-6 grid grid-cols-12 gap-4 md:gap-6">
                <!-- Left Column: Stacked Metrics + Bar Chart -->
                <div class="col-span-12 xl:col-span-7 space-y-6">
                    <!-- 2x2 Metric Cards Grid -->
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Total Team Leads -->
                        <div class="rounded-2xl border border-gray-200 bg-white p-5">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">Team Leads</p>
                                    <h3 class="text-2xl font-bold text-gray-900 mt-1">--</h3>
                </div>
                                <div class="flex h-12 w-12 items-center justify-center rounded-full bg-blue-100">
                                    <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">Unique Underwriting_Team_Lead</p>
            </div>
            
                        <!-- Total Underwriters -->
                        <div class="rounded-2xl border border-gray-200 bg-white p-5">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">Underwriters</p>
                                    <h3 class="text-2xl font-bold text-gray-900 mt-1">--</h3>
                    </div>
                                <div class="flex h-12 w-12 items-center justify-center rounded-full bg-green-100">
                                    <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">Unique Lead_Underwriter</p>
                    </div>
                    
                        <!-- Avg Portfolio -->
                        <div class="rounded-2xl border border-gray-200 bg-white p-5">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">Avg Portfolio</p>
                                    <h3 class="text-2xl font-bold text-gray-900 mt-1">$--</h3>
                                </div>
                                <div class="flex h-12 w-12 items-center justify-center rounded-full bg-purple-100">
                                    <svg class="h-6 w-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">Average TFA per team lead</p>
                        </div>
                        
                        <!-- Total TFA -->
                        <div class="rounded-2xl border border-gray-200 bg-white p-5">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">Total TFA</p>
                                    <h3 class="text-2xl font-bold text-gray-900 mt-1">$--</h3>
                                </div>
                                <div class="flex h-12 w-12 items-center justify-center rounded-full bg-amber-100">
                                    <svg class="h-6 w-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">Sum of all team portfolios</p>
                    </div>
                </div>

                    <!-- Team Performance Bar Chart -->
                    <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6">
                        <div class="mb-5 flex items-start justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">Top Team Leads by TFA</h3>
                                <p class="mt-1 text-gray-500 text-sm">Portfolio size comparison across team leads</p>
                        </div>
                        </div>
                        <div class="flex items-center justify-center h-64 bg-gray-50 rounded-lg">
                            <div class="text-center text-gray-400">
                                <svg class="h-12 w-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                <p class="text-sm font-medium">Horizontal Bar Chart Placeholder</p>
                                <p class="text-xs mt-1">Top 10 team leads by total facility amount</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: ROTCE Donut Chart -->
                <div class="col-span-12 xl:col-span-5">
                    <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6 h-full">
                        <div class="mb-5 flex items-start justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">ROTCE Distribution</h3>
                                <p class="mt-1 text-gray-500 text-sm">Team performance against 12% target</p>
                            </div>
                            <span class="inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-700">
                                Target: 12%
                            </span>
                        </div>
                        <div class="flex items-center justify-center h-64 bg-gray-50 rounded-lg mb-5">
                            <div class="text-center text-gray-400">
                                <svg class="h-16 w-16 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                                </svg>
                                <p class="text-sm font-medium">Donut Chart Placeholder</p>
                                <p class="text-xs mt-1">Above/Below target distribution</p>
                            </div>
                        </div>
                        <!-- Legend -->
                        <div class="flex items-center justify-center gap-6">
                <div class="flex items-center gap-2">
                                <div class="h-3 w-3 rounded-full bg-green-500"></div>
                                <span class="text-sm text-gray-600">Above Target</span>
                                <span class="text-sm font-semibold text-gray-800">--%</span>
                    </div>
                            <div class="flex items-center gap-2">
                                <div class="h-3 w-3 rounded-full bg-red-500"></div>
                                <span class="text-sm text-gray-600">Below Target</span>
                                <span class="text-sm font-semibold text-gray-800">--%</span>
                </div>
            </div>
                    </div>
            </div>
        </div>
        
            <!-- Row 2: Full Width Team Table -->
            <div class="mb-6">
                <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6">
                    <div class="mb-5 flex items-start justify-between">
                    <div>
                            <h3 class="text-lg font-semibold text-gray-800">Portfolio by Team Lead</h3>
                            <p class="mt-1 text-gray-500 text-sm">Detailed breakdown by Underwriting_Team_Lead with performance metrics</p>
                    </div>
                        <div class="flex items-center gap-2">
                            <input type="text" placeholder="Search team lead..." class="rounded-lg border border-gray-200 px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button class="flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-1.5 text-sm font-medium text-gray-600 hover:bg-gray-50">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                    </svg>
                                Export
                                    </button>
                    </div>
                            </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-gray-500">
                            <thead class="text-sm text-gray-700 bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left whitespace-nowrap">Team Lead</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">Relationships</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">Facilities</th>
                                    <th class="px-4 py-3 text-right whitespace-nowrap">Total TFA</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">Avg ROTCE</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b hover:bg-gray-50">
                                    <td colspan="6" class="px-4 py-8 text-center text-gray-400">
                                        <div class="flex flex-col items-center gap-2">
                                            <svg class="h-8 w-8 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                            <p class="text-sm">Placeholder for team portfolio breakdown</p>
                </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                        </div>
                    </div>
        </div>
        <!-- End Team View Tab -->

        <!-- Top Names Tab Content - Marketing Style Layout -->
        <div x-show="activeTab === 'topnames'" style="display: none;">
            <!-- Row 1: Full Width Metrics (like Marketing) -->
            <div class="mb-6 grid grid-cols-2 gap-4 sm:grid-cols-4 md:gap-6">
                <!-- Total Relationships -->
                <div class="rounded-2xl border border-gray-200 bg-white p-5">
                    <div class="flex items-center gap-3">
                        <span class="flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-blue-100">
                            <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                        </span>
                        <div>
                            <p class="text-sm text-gray-500">Relationships</p>
                            <h3 class="text-xl font-bold text-gray-800">--</h3>
                    </div>
                </div>
            </div>

                <!-- Top 10 Concentration -->
                <div class="rounded-2xl border border-gray-200 bg-white p-5">
                    <div class="flex items-center gap-3">
                        <span class="flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-amber-100">
                            <svg class="h-5 w-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                            </svg>
                        </span>
                        <div>
                            <p class="text-sm text-gray-500">Top 10 Concentration</p>
                            <h3 class="text-xl font-bold text-gray-800">--%</h3>
                        </div>
                    </div>
                </div>
                
                <!-- Total TFA -->
                <div class="rounded-2xl border border-gray-200 bg-white p-5">
                    <div class="flex items-center gap-3">
                        <span class="flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-green-100">
                            <svg class="h-5 w-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                        </span>
                        <div>
                            <p class="text-sm text-gray-500">Total TFA</p>
                            <h3 class="text-xl font-bold text-gray-800">$--</h3>
                                </div>
                        </div>
                    </div>

                <!-- Avg Size -->
                <div class="rounded-2xl border border-gray-200 bg-white p-5">
                    <div class="flex items-center gap-3">
                        <span class="flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-purple-100">
                            <svg class="h-5 w-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                        </span>
                        <div>
                            <p class="text-sm text-gray-500">Avg Size</p>
                            <h3 class="text-xl font-bold text-gray-800">$--</h3>
                    </div>
                </div>
            </div>
        </div>

            <!-- Row 2: Main Content (8) + Side Panel (4) - Marketing Style -->
            <div class="mb-6 grid grid-cols-12 gap-4 md:gap-6">
                <!-- Left: Chart + Table Stacked -->
                <div class="col-span-12 xl:col-span-8 space-y-6">
                    <!-- Concentration Area Chart -->
            <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6">
                <div class="mb-5 flex items-start justify-between">
                    <div>
                                <h3 class="text-lg font-semibold text-gray-800">Portfolio Concentration Trend</h3>
                                <p class="mt-1 text-gray-500 text-sm">Top 10 relationships share over time</p>
                    </div>
                            <div class="flex items-center gap-2">
                                <button class="rounded-lg px-3 py-1.5 text-sm font-medium text-gray-500 hover:bg-gray-100">Weekly</button>
                                <button class="rounded-lg px-3 py-1.5 text-sm font-medium bg-blue-100 text-blue-600">Monthly</button>
                                <button class="rounded-lg px-3 py-1.5 text-sm font-medium text-gray-500 hover:bg-gray-100">Quarterly</button>
                            </div>
                        </div>
                        <div class="flex items-center justify-center h-64 bg-gray-50 rounded-lg">
                            <div class="text-center text-gray-400">
                                <svg class="h-12 w-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                            </svg>
                                <p class="text-sm font-medium">Area Chart Placeholder</p>
                                <p class="text-xs mt-1">Concentration trend over time</p>
                        </div>
                    </div>
                </div>

                    <!-- Top Relationships Table -->
                    <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6">
                        <div class="mb-5 flex items-start justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">Top Relationships</h3>
                                <p class="mt-1 text-gray-500 text-sm">Ranked by total facility amount</p>
                            </div>
                            <select class="rounded-lg border border-gray-200 px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option>Top 10</option>
                                <option>Top 25</option>
                                <option>Top 50</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto">
                    <table class="w-full text-sm text-gray-500">
                        <thead class="text-sm text-gray-700 bg-gray-50">
                            <tr>
                                        <th class="px-4 py-3 text-left whitespace-nowrap">#</th>
                                        <th class="px-4 py-3 text-left whitespace-nowrap">Relationship</th>
                                        <th class="px-4 py-3 text-right whitespace-nowrap">TFA</th>
                                        <th class="px-4 py-3 text-center whitespace-nowrap">ROTCE</th>
                                        <th class="px-4 py-3 text-center whitespace-nowrap">Share</th>
                            </tr>
                        </thead>
                                <tbody>
                            <tr class="border-b hover:bg-gray-50">
                                        <td colspan="5" class="px-4 py-8 text-center text-gray-400">
                                            <div class="flex flex-col items-center gap-2">
                                                <svg class="h-8 w-8 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                                </svg>
                                                <p class="text-sm">Placeholder for top relationships</p>
                                    </div>
                                </td>
                            </tr>
                                </tbody>
                            </table>
                                    </div>
                                    </div>
                </div>
                
                <!-- Right: Stacked Side Panels (Traffic Source Style) -->
                <div class="col-span-12 xl:col-span-4 space-y-6">
                    <!-- Concentration Donut -->
                    <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6">
                        <div class="mb-5">
                            <h3 class="text-lg font-semibold text-gray-800">Portfolio Breakdown</h3>
                            <p class="mt-1 text-gray-500 text-sm">Concentration distribution</p>
                                    </div>
                        <div class="flex items-center justify-center h-48 bg-gray-50 rounded-lg mb-4">
                            <div class="text-center text-gray-400">
                                <svg class="h-12 w-12 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                                </svg>
                                <p class="text-xs">Donut Chart</p>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between text-sm">
                                <div class="flex items-center gap-2">
                                    <div class="h-3 w-3 rounded-full bg-blue-500"></div>
                                    <span class="text-gray-600">Top 10</span>
                                </div>
                                <span class="font-medium text-gray-800">--%</span>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <div class="flex items-center gap-2">
                                    <div class="h-3 w-3 rounded-full bg-gray-300"></div>
                                    <span class="text-gray-600">Others</span>
                                </div>
                                <span class="font-medium text-gray-800">--%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Size Distribution -->
                    <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6">
                        <div class="mb-5">
                            <h3 class="text-lg font-semibold text-gray-800">Size Distribution</h3>
                            <p class="mt-1 text-gray-500 text-sm">Relationships by size bucket</p>
                                    </div>
                        <div class="space-y-3">
                            <!-- >$100M -->
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-600">&gt;$100M</span>
                                    <span class="font-medium text-gray-800">-- names</span>
                                </div>
                                <div class="h-2 w-full bg-gray-100 rounded-full overflow-hidden">
                                    <div class="h-full bg-blue-500 rounded-full" style="width: 15%"></div>
                                </div>
                            </div>
                            <!-- $50-100M -->
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-600">$50-100M</span>
                                    <span class="font-medium text-gray-800">-- names</span>
                                </div>
                                <div class="h-2 w-full bg-gray-100 rounded-full overflow-hidden">
                                    <div class="h-full bg-green-500 rounded-full" style="width: 25%"></div>
                                </div>
                            </div>
                            <!-- $10-50M -->
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-600">$10-50M</span>
                                    <span class="font-medium text-gray-800">-- names</span>
                                </div>
                                <div class="h-2 w-full bg-gray-100 rounded-full overflow-hidden">
                                    <div class="h-full bg-purple-500 rounded-full" style="width: 40%"></div>
                                </div>
                            </div>
                            <!-- <$10M -->
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-600">&lt;$10M</span>
                                    <span class="font-medium text-gray-800">-- names</span>
                                </div>
                                <div class="h-2 w-full bg-gray-100 rounded-full overflow-hidden">
                                    <div class="h-full bg-amber-500 rounded-full" style="width: 55%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Top Names Tab -->

        <!-- Covenants Tab Content - CRM Style Layout -->
        <div x-show="activeTab === 'covenants'" style="display: none;">
            <!-- Row 1: Full Width Metrics -->
            <div class="mb-6 grid grid-cols-2 gap-4 sm:grid-cols-4 md:gap-6">
                <!-- Total Covenants -->
                <div class="rounded-2xl border border-gray-200 bg-white p-5">
                    <div class="flex flex-col">
                        <span class="text-sm text-gray-500">Total Covenants</span>
                        <div class="flex items-baseline gap-2 mt-1">
                            <h3 class="text-2xl font-bold text-gray-800">--</h3>
                            <span class="text-xs text-gray-400">unique</span>
                                    </div>
                    </div>
                </div>
                <!-- Past Due -->
                <div class="rounded-2xl border border-red-200 bg-red-50 p-5">
                    <div class="flex flex-col">
                        <span class="text-sm text-red-600">Past Due</span>
                        <div class="flex items-baseline gap-2 mt-1">
                            <h3 class="text-2xl font-bold text-red-700">--</h3>
                            <span class="inline-flex items-center gap-1 text-xs text-red-600">
                                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                needs attention
                            </span>
                        </div>
                    </div>
                </div>
                <!-- Coming Due -->
                <div class="rounded-2xl border border-amber-200 bg-amber-50 p-5">
                    <div class="flex flex-col">
                        <span class="text-sm text-amber-600">Coming Due (30d)</span>
                        <div class="flex items-baseline gap-2 mt-1">
                            <h3 class="text-2xl font-bold text-amber-700">--</h3>
                            <span class="inline-flex items-center gap-1 text-xs text-amber-600">
                                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                upcoming
                            </span>
                        </div>
                    </div>
                </div>
                <!-- Compliance Rate -->
                <div class="rounded-2xl border border-green-200 bg-green-50 p-5">
                    <div class="flex flex-col">
                        <span class="text-sm text-green-600">Compliance Rate</span>
                        <div class="flex items-baseline gap-2 mt-1">
                            <h3 class="text-2xl font-bold text-green-700">--%</h3>
                            <span class="inline-flex items-center gap-1 text-xs text-green-600">
                                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                on-time
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Row 2: Large Chart (8) + Side Donut (4) - CRM Style -->
            <div class="mb-6 grid grid-cols-12 gap-4 md:gap-6">
                <!-- Covenant Aging Timeline -->
                <div class="col-span-12 xl:col-span-8">
                    <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6 h-full">
                        <div class="mb-5 flex items-start justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">Covenant Aging Timeline</h3>
                                <p class="mt-1 text-gray-500 text-sm">Past due and coming due covenants by aging bucket</p>
                                    </div>
                            <div x-data="{ selected: 'all' }" class="flex items-center gap-0.5 rounded-lg bg-gray-100 p-0.5">
                                <button @click="selected = 'all'" :class="selected === 'all' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500'" class="rounded-md px-3 py-1.5 text-sm font-medium">All</button>
                                <button @click="selected = 'pastdue'" :class="selected === 'pastdue' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500'" class="rounded-md px-3 py-1.5 text-sm font-medium">Past Due</button>
                                <button @click="selected = 'coming'" :class="selected === 'coming' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500'" class="rounded-md px-3 py-1.5 text-sm font-medium">Coming</button>
                            </div>
                        </div>
                        <div class="flex items-center justify-center h-72 bg-gray-50 rounded-lg">
                            <div class="text-center text-gray-400">
                                <svg class="h-12 w-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                <p class="text-sm font-medium">Stacked Bar Chart Placeholder</p>
                                <p class="text-xs mt-1">Aging buckets: 1-45, 46-90, >90 days</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Status Distribution Donut -->
                <div class="col-span-12 xl:col-span-4">
                    <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6 h-full">
                        <div class="mb-5">
                            <h3 class="text-lg font-semibold text-gray-800">Status Distribution</h3>
                            <p class="mt-1 text-gray-500 text-sm">Current covenant status breakdown</p>
                                    </div>
                        <div class="flex items-center justify-center h-48 bg-gray-50 rounded-lg mb-4">
                            <div class="text-center text-gray-400">
                                <svg class="h-12 w-12 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                                </svg>
                                <p class="text-xs">Donut Chart</p>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between text-sm">
                                <div class="flex items-center gap-2"><div class="h-3 w-3 rounded-full bg-red-500"></div><span class="text-gray-600">Past Due</span></div>
                                <span class="font-medium text-gray-800">-- (--%)</span>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <div class="flex items-center gap-2"><div class="h-3 w-3 rounded-full bg-amber-500"></div><span class="text-gray-600">Coming Due</span></div>
                                <span class="font-medium text-gray-800">-- (--%)</span>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <div class="flex items-center gap-2"><div class="h-3 w-3 rounded-full bg-green-500"></div><span class="text-gray-600">On Track</span></div>
                                <span class="font-medium text-gray-800">-- (--%)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Row 3: Regional Summary (6) + Upcoming Schedule (6) - CRM Style -->
            <div class="mb-6 grid grid-cols-12 gap-4 md:gap-6">
                <!-- Regional Summary -->
                <div class="col-span-12 xl:col-span-6">
                    <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6 h-full">
                        <div class="mb-5">
                            <h3 class="text-lg font-semibold text-gray-800">Regional Summary</h3>
                            <p class="mt-1 text-gray-500 text-sm">Covenant status by region</p>
                                    </div>
                        <div class="space-y-4">
                            <!-- Region rows with progress bars -->
                            <div class="flex items-center gap-4">
                                <span class="w-16 text-sm font-medium text-gray-600">APAC</span>
                                <div class="flex-1 flex h-4 rounded-full overflow-hidden bg-gray-100">
                                    <div class="bg-red-500" style="width: 15%"></div>
                                    <div class="bg-amber-500" style="width: 25%"></div>
                                    <div class="bg-green-500" style="width: 60%"></div>
                                </div>
                                <span class="w-12 text-right text-sm text-gray-600">--</span>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="w-16 text-sm font-medium text-gray-600">EMEA</span>
                                <div class="flex-1 flex h-4 rounded-full overflow-hidden bg-gray-100">
                                    <div class="bg-red-500" style="width: 10%"></div>
                                    <div class="bg-amber-500" style="width: 20%"></div>
                                    <div class="bg-green-500" style="width: 70%"></div>
                                </div>
                                <span class="w-12 text-right text-sm text-gray-600">--</span>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="w-16 text-sm font-medium text-gray-600">NAM</span>
                                <div class="flex-1 flex h-4 rounded-full overflow-hidden bg-gray-100">
                                    <div class="bg-red-500" style="width: 20%"></div>
                                    <div class="bg-amber-500" style="width: 15%"></div>
                                    <div class="bg-green-500" style="width: 65%"></div>
                                </div>
                                <span class="w-12 text-right text-sm text-gray-600">--</span>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="w-16 text-sm font-medium text-gray-600">LATAM</span>
                                <div class="flex-1 flex h-4 rounded-full overflow-hidden bg-gray-100">
                                    <div class="bg-red-500" style="width: 5%"></div>
                                    <div class="bg-amber-500" style="width: 30%"></div>
                                    <div class="bg-green-500" style="width: 65%"></div>
                                </div>
                                <span class="w-12 text-right text-sm text-gray-600">--</span>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-100 flex items-center justify-center gap-6 text-xs">
                            <div class="flex items-center gap-1"><div class="h-2 w-2 rounded-full bg-red-500"></div>Past Due</div>
                            <div class="flex items-center gap-1"><div class="h-2 w-2 rounded-full bg-amber-500"></div>Coming Due</div>
                            <div class="flex items-center gap-1"><div class="h-2 w-2 rounded-full bg-green-500"></div>On Track</div>
                        </div>
                    </div>
                </div>
                
                <!-- Upcoming Covenants Schedule -->
                <div class="col-span-12 xl:col-span-6">
                    <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6 h-full">
                        <div class="mb-5">
                            <h3 class="text-lg font-semibold text-gray-800">Upcoming Schedule</h3>
                            <p class="mt-1 text-gray-500 text-sm">Covenants due in next 30 days</p>
                                    </div>
                        <div class="space-y-3">
                            <div class="flex items-center justify-center h-40 bg-gray-50 rounded-lg">
                                <div class="text-center text-gray-400">
                                    <svg class="h-8 w-8 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <p class="text-sm">Calendar View Placeholder</p>
                                    <p class="text-xs mt-1">Upcoming covenant due dates</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Row 4: Full Width Details Table -->
            <div class="mb-6">
                <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6">
                    <div class="mb-5 flex items-start justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Covenant Details</h3>
                            <p class="mt-1 text-gray-500 text-sm">Complete list of all covenants</p>
                                    </div>
                        <div class="flex items-center gap-2">
                            <input type="text" placeholder="Search covenants..." class="rounded-lg border border-gray-200 px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <select class="rounded-lg border border-gray-200 px-3 py-1.5 text-sm focus:outline-none">
                                <option>All Status</option>
                                <option>Past Due</option>
                                <option>Coming Due</option>
                                <option>On Track</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-gray-500">
                            <thead class="text-sm text-gray-700 bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left whitespace-nowrap">Covenant #</th>
                                    <th class="px-4 py-3 text-left whitespace-nowrap">Relationship</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">Region</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">Due Date</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">Status</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">Days</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr class="border-b hover:bg-gray-50">
                                    <td colspan="6" class="px-4 py-8 text-center text-gray-400">
                                        <div class="flex flex-col items-center gap-2">
                                            <svg class="h-8 w-8 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <p class="text-sm">Placeholder for covenant details</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                    </div>
            </div>
        </div>
        <!-- End Covenants Tab -->

        <!-- Credit Reviews (CCM) Tab Content - SaaS Style Layout -->
        <div x-show="activeTab === 'ccm'" style="display: none;">
            <!-- Row 1: Metrics with sparklines (SaaS Style) -->
            <div class="mb-6 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4 md:gap-6">
                <!-- Total CCMs -->
                <div class="rounded-2xl border border-gray-200 bg-white p-5">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Total Reviews</p>
                            <h3 class="text-3xl font-bold text-gray-800 mt-2">--</h3>
                            <p class="text-xs text-gray-400 mt-1">Active CCM records</p>
                        </div>
                        <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-blue-100">
                            <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                        </div>
                </div>
                
                <!-- Past Due -->
                <div class="rounded-2xl border border-gray-200 bg-white p-5">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Past Due</p>
                            <h3 class="text-3xl font-bold text-red-600 mt-2">--</h3>
                            <p class="text-xs text-red-500 mt-1 flex items-center gap-1">
                                <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg>
                                Needs attention
                            </p>
                        </div>
                        <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-red-100">
                            <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                    </div>
                </div>
            </div>
                
                <!-- Coming Due -->
                <div class="rounded-2xl border border-gray-200 bg-white p-5">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Coming Due</p>
                            <h3 class="text-3xl font-bold text-amber-600 mt-2">--</h3>
                            <p class="text-xs text-amber-500 mt-1">Within current month</p>
                        </div>
                        <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-amber-100">
                            <svg class="h-6 w-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
        </div>
        </div>

                <!-- Open -->
                <div class="rounded-2xl border border-gray-200 bg-white p-5">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Open</p>
                            <h3 class="text-3xl font-bold text-green-600 mt-2">--</h3>
                            <p class="text-xs text-green-500 mt-1">Future due dates</p>
                        </div>
                        <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-green-100">
                            <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
            </div>
        </div>

            <!-- Row 2: Main Content (7/8) + Side Panel (5/4) - SaaS Style -->
            <div class="mb-6 gap-5 space-y-5 sm:gap-6 sm:space-y-6 xl:grid xl:grid-cols-12 xl:space-y-0">
                <!-- Left: Stacked Charts -->
                <div class="xl:col-span-7 2xl:col-span-8">
                    <div class="space-y-5 sm:space-y-6">
                        <!-- Two charts side by side -->
                        <div class="grid gap-5 sm:gap-6 lg:grid-cols-2">
                            <!-- Status Breakdown Donut -->
                            <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6">
                                <div class="mb-4">
                                    <h3 class="text-lg font-semibold text-gray-800">Status Breakdown</h3>
                                    <p class="text-sm text-gray-500">Current distribution</p>
                                </div>
                                <div class="flex items-center justify-center h-48 bg-gray-50 rounded-lg">
                                    <div class="text-center text-gray-400">
                                        <svg class="h-10 w-10 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                                        </svg>
                                        <p class="text-xs">Donut Chart</p>
            </div>
        </div>
                            </div>
                            
                            <!-- Risk Rating Distribution -->
                            <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6">
                                <div class="mb-4">
                                    <h3 class="text-lg font-semibold text-gray-800">Risk Rating Dist.</h3>
                                    <p class="text-sm text-gray-500">By classification</p>
                                </div>
                                <div class="flex items-center justify-center h-48 bg-gray-50 rounded-lg">
                                    <div class="text-center text-gray-400">
                                        <svg class="h-10 w-10 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                        <p class="text-xs">Bar Chart</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Regional Stacked Chart -->
                        <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6">
                            <div class="mb-5 flex items-start justify-between">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800">Regional Overview</h3>
                                    <p class="text-gray-500 text-sm">Status distribution by region</p>
                                </div>
                                <select class="rounded-lg border border-gray-200 px-3 py-1.5 text-sm focus:outline-none">
                                    <option>All Regions</option>
                                    <option>APAC</option>
                                    <option>EMEA</option>
                                    <option>NAM</option>
                                    <option>LATAM</option>
                                </select>
                            </div>
                            <div class="flex items-center justify-center h-56 bg-gray-50 rounded-lg">
                                <div class="text-center text-gray-400">
                                    <svg class="h-12 w-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <p class="text-sm font-medium">Grouped Bar Chart Placeholder</p>
                                    <p class="text-xs mt-1">Past Due / Coming Due / Open by region</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right: Performance Panel (SaaS Style) -->
                <div class="space-y-6 xl:col-span-5 2xl:col-span-4">
                    <!-- Performance Card with Tabs -->
                    <div class="rounded-2xl border border-gray-200 bg-white p-6">
                        <div class="mb-6 flex justify-between">
                            <h3 class="text-lg font-semibold text-gray-800">Performance</h3>
                        </div>
                        <div x-data="{selected: 'region'}">
                            <div class="flex w-full items-center gap-0.5 rounded-lg bg-gray-100 p-0.5 mb-4">
                                <button @click="selected = 'region'" :class="selected === 'region' ? 'shadow-sm text-gray-900 bg-white' : 'text-gray-500'" class="text-sm w-full rounded-md px-3 py-2 font-medium">By Region</button>
                                <button @click="selected = 'approver'" :class="selected === 'approver' ? 'shadow-sm text-gray-900 bg-white' : 'text-gray-500'" class="text-sm w-full rounded-md px-3 py-2 font-medium">By Approver</button>
                            </div>
                            
                            <!-- Region View -->
                            <div x-show="selected === 'region'" class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">APAC</span>
                                    <div class="flex items-center gap-2">
                                        <div class="w-32 h-2 bg-gray-100 rounded-full overflow-hidden">
                                            <div class="h-full bg-blue-500 rounded-full" style="width: 35%"></div>
                                        </div>
                                        <span class="text-sm font-medium text-gray-800 w-8 text-right">--</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">EMEA</span>
                                    <div class="flex items-center gap-2">
                                        <div class="w-32 h-2 bg-gray-100 rounded-full overflow-hidden">
                                            <div class="h-full bg-green-500 rounded-full" style="width: 28%"></div>
                                        </div>
                                        <span class="text-sm font-medium text-gray-800 w-8 text-right">--</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">NAM</span>
                                    <div class="flex items-center gap-2">
                                        <div class="w-32 h-2 bg-gray-100 rounded-full overflow-hidden">
                                            <div class="h-full bg-purple-500 rounded-full" style="width: 25%"></div>
                                        </div>
                                        <span class="text-sm font-medium text-gray-800 w-8 text-right">--</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">LATAM</span>
                                    <div class="flex items-center gap-2">
                                        <div class="w-32 h-2 bg-gray-100 rounded-full overflow-hidden">
                                            <div class="h-full bg-amber-500 rounded-full" style="width: 12%"></div>
                                        </div>
                                        <span class="text-sm font-medium text-gray-800 w-8 text-right">--</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Approver View -->
                            <div x-show="selected === 'approver'" class="space-y-3">
                                <div class="flex items-center justify-center h-32 bg-gray-50 rounded-lg">
                                    <p class="text-sm text-gray-400">Approver breakdown placeholder</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions Card -->
                    <div class="rounded-2xl border border-gray-200 bg-white p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Quick Summary</h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                <span class="text-sm text-gray-600">Oldest Past Due</span>
                                <span class="text-sm font-medium text-red-600">-- days</span>
                            </div>
                            <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                <span class="text-sm text-gray-600">Due This Week</span>
                                <span class="text-sm font-medium text-amber-600">--</span>
                            </div>
                            <div class="flex items-center justify-between py-2">
                                <span class="text-sm text-gray-600">Avg Days to Due</span>
                                <span class="text-sm font-medium text-gray-800">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Row 3: Full Width Details Table -->
            <div class="mb-6">
                <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6">
                    <div class="mb-5 flex items-start justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Credit Review Details</h3>
                            <p class="mt-1 text-gray-500 text-sm">Complete list of all credit committee memos</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="text" placeholder="Search..." class="rounded-lg border border-gray-200 px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-40">
                            <select class="rounded-lg border border-gray-200 px-3 py-1.5 text-sm focus:outline-none">
                                <option>All Status</option>
                                <option>Past Due</option>
                                <option>Coming Due</option>
                                <option>Open</option>
                            </select>
                            <button class="flex items-center gap-1 rounded-lg bg-blue-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-blue-700">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                                Export
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-gray-500">
                            <thead class="text-sm text-gray-700 bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left whitespace-nowrap">Relationship</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">Region</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">Risk Rating</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">Due Date</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">Status</th>
                                    <th class="px-4 py-3 text-left whitespace-nowrap">Approver</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b hover:bg-gray-50">
                                    <td colspan="6" class="px-4 py-8 text-center text-gray-400">
                                        <div class="flex flex-col items-center gap-2">
                                            <svg class="h-8 w-8 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                            <p class="text-sm">Placeholder for CCM details</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ETL Process Note -->
            <div class="overflow-hidden rounded-xl border border-blue-100 bg-blue-50">
                <div class="flex items-start gap-3 px-5 py-4">
                    <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-blue-100">
                        <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h4 class="text-sm font-semibold text-blue-800 mb-1">Data ETL Process</h4>
                        <p class="text-xs text-blue-700">Before loading, the ETL process standardizes regional files into one, filters out Credit_Classification = Pass and Loss, keeps only CM in DM/CM_Flag, then creates a standardized file for this dashboard.</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Credit Reviews Tab -->
    </div>

    <script>
        // ===== PORTFOLIO ANALYTICS CONFIGURATION =====
        // This dashboard loads data from Confluence in READ-ONLY mode
        // Similar to cmps.html, data is fetched from an attachment but never modified
        // All filters and options are dynamically populated from the loaded data
        
        // Update these values to match your Confluence page and attachment
        const CONFLUENCE_PAGE_ID = "3229979875"; // Your Confluence page ID
        const CONFLUENCE_FILE_NAME = "Portfolio_tw.xlsx"; // Your attachment filename (can be .csv, .xlsx, or .xls)
        const CONFLUENCE_COVENANTS_FILE = "Covenants_tw.xlsx"; // Covenants data file
        const CONFLUENCE_CCM_FILE = "CCM_tw.xlsx"; // CCM (Credit Committee Memos) data file
        const CONFLUENCE_BASE_URL = "https://cedt-confluence.nam.nsroot.net/confluence";
        // ==========================================
        
        // ===== PERFORMANCE OPTIMIZATIONS FOR 40K+ ROWS =====
        // 1. INDEX CACHING: Pre-parse dates and build indexes for fast filtering
        // 2. SMART FILTERING: Early exit loops, minimal object access, use for-loops not .filter()
        // 3. RESULT CACHING: Cache filtered results to avoid re-filtering same queries
        // 4. SINGLE-PASS METRICS: Calculate all metrics in one loop instead of multiple passes
        // 5. OPTIMIZED CHARTS: Use Map() instead of objects, limit data points
        // 6. DEBOUNCED SEARCH: 500ms delay to prevent filtering on every keystroke
        // 7. LARGER PAGE SIZE: 50 rows per page (fewer renders = better performance)
        // 8. ASYNC RENDERING: Use requestAnimationFrame to prevent UI blocking
        // 
        // Expected Performance: 40K rows should filter in 50-200ms (was 2-5 seconds)
        // =====================================================

        // Global variables
        let portfolioData = [];
        let covenantsData = []; // Separate covenant data from Covenants_tw.xlsx
        let ccmData = []; // CCM (Credit Committee Memos) data from CCM_tw.xlsx
        let filteredData = [];


        let expirationChartInstance = null;
        let searchDebounceTimer = null;
        let relationshipChartInstance = null;
        let facilityTrendChartInstance = null; // Store facility trend chart instance
        let facilityMaturityChartInstance = null; // Store facility maturity chart instance
        let creditClassificationChartInstance = null; // Store credit classification chart instance
        let rotceChartInstance = null; // Store ROTCE chart instance
        let updateBarChartTimer = null; // Debounce timer for bar chart updates
        let activeFilters = {};
        let selectedMetricType = "facilityAmount"; // Default to Facility Amount
        
        // Smart Filter States
        let selectedRegion = "all"; // all, APAC, EMEA, LATAM, NAM
        let includePSE = true; // true = include PSE, false = exclude PSE
        let selectedStatus = "all"; // all, CM, DM
        let selectedCommitmentStatus = "all"; // all, Committed, Uncommitted
        let selectedAmountType = "direct"; // direct, contingent, pse, osuc, tfa (for metrics)
        let selectedPeriod = "current"; // current, previous (for New Facilities Approved  chart)
        
        // Chart View States (for View Data filtering)
        let currentCovenantViewType = "pastDue"; // pastDue, comingDue
        let currentCCMViewType = "pastDue"; // pastDue, comingDue, open
        
        // Reporting Month (derived from max Report_Date in data)
        let reportingMonth = null; // Will be set after data loads
        
        // Get the reporting month from portfolio data (max Report_Date)
        function getReportingMonth() {
            if (reportingMonth) return reportingMonth;
            
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
            if (!dataSource || dataSource.length === 0) {
                // Fallback to current date if no data
                return new Date();
            }
            
            // Get max Report_Date from data
            const reportDates = dataSource
                .map(row => parseDate(row.Report_Date))
                .filter(d => d !== null);
            
            if (reportDates.length === 0) {
                return new Date();
            }
            
            reportingMonth = new Date(Math.max(...reportDates));
            console.log(' Reporting Month set to:', reportingMonth.toLocaleDateString());
            return reportingMonth;
        }
        
        // Get reporting month start and end dates
        function getReportingMonthRange() {
            const repMonth = getReportingMonth();
            const monthStart = new Date(repMonth.getFullYear(), repMonth.getMonth(), 1);
            monthStart.setHours(0, 0, 0, 0);
            const monthEnd = new Date(repMonth.getFullYear(), repMonth.getMonth() + 1, 0);
            monthEnd.setHours(23, 59, 59, 999);
            return { monthStart, monthEnd, reportingMonth: repMonth };
        }

        // Cross-filtering state management
        let chartFilter = {
            active: false,
            type: null, // 'relationship', 'region', 'product', 'facilityType', etc.
            value: null, // The clicked value (e.g., relationship name, region name, etc.)
            label: null, // Display label for UI
        };
        
        // Performance optimization: Cache for expensive calculations
        let metricsCache = {
            full: null,
            filtered: null,
            filterHash: "",
        };
        let indexCache = {
            byRegion: null,
            byProduct: null,
            byRelationship: null,
            dates: null,
        };

        // ============================================
        // DUMMY DATA GENERATOR (REMOVE LATER)
        // ============================================
        function generateDummyData() {
            const regions = ['APAC', 'EMEA', 'NAM', 'LATAM'];
            const relationships = ['ABC Corp', 'XYZ Industries', 'Global Traders', 'Tech Solutions', 'Finance Group', 'Energy Co', 'Retail Chain', 'Manufacturing Ltd', 'Logistics Inc', 'Pharma Corp', 'Auto Parts Ltd', 'Food Services', 'Telecom Systems', 'Banking Solutions', 'Insurance Corp'];
            const products = ['Revolving Credit', 'Term Loan', 'Letter of Credit', 'Guarantee', 'Trade Finance'];
            const facilityTypes = ['Committed', 'Uncommitted'];
            const managementStatus = ['CM', 'DM'];
            const caReview = ['Yes', 'No', ''];
            
            const data = [];
            const reportDate = new Date(2024, 10, 28); // Nov 28, 2024
            
            for (let i = 0; i < 500; i++) {
                const region = regions[Math.floor(Math.random() * regions.length)];
                const relationship = relationships[Math.floor(Math.random() * relationships.length)];
                const relationshipId = `REL-${Math.floor(Math.random() * 1000)}`;
                const caid = `CA-${Math.floor(Math.random() * 10000)}`;
                const facilityId = `FAC-${i + 1000}`;
                const facAmount = Math.floor(Math.random() * 50000000) + 1000000;
                const directOS = facAmount * (Math.random() * 0.7);
                const contingentOS = (facAmount - directOS) * (Math.random() * 0.5);
                const pseOS = (facAmount - directOS - contingentOS) * (Math.random() * 0.3);
                
                // Generate maturity dates (some in Nov, Dec, Jan, Feb)
                const monthOffset = Math.floor(Math.random() * 4) - 1; // -1 to 2
                const maturityDate = new Date(2024, 10 + monthOffset, Math.floor(Math.random() * 28) + 1);
                
                // Generate CA expiration dates
                const caMonthOffset = Math.floor(Math.random() * 4) - 1;
                const caExpirationDate = new Date(2024, 10 + caMonthOffset, Math.floor(Math.random() * 28) + 1);
                
                // For some records, set dates to weekend after Nov 28
                if (Math.random() < 0.1 && monthOffset === 0) {
                    maturityDate.setDate(29 + Math.floor(Math.random() * 2)); // Nov 29 or 30
                }
                
                const mgmtStatus = managementStatus[Math.random() < 0.9 ? 0 : 1]; // 90% CM, 10% DM
                const review = region === 'EMEA' ? caReview[Math.floor(Math.random() * 3)] : 'Yes';
                
                data.push({
                    Report_Date: formatDateForDummy(reportDate),
                    Region: region,
                    Relationship_Name: relationship,
                    Relationship_ID: relationshipId,
                    CAID: caid,
                    Facility_ID: facilityId,
                    Fac_Amount: facAmount,
                    Facility_Amount: facAmount,
                    Direct_OS: directOS,
                    Contingent_OS: contingentOS,
                    PSE_OS: pseOS,
                    Maturity_Date: formatDateForDummy(maturityDate),
                    CA_Expiration_Date: formatDateForDummy(caExpirationDate),
                    Product_Program: products[Math.floor(Math.random() * products.length)],
                    Facility_Type: facilityTypes[Math.floor(Math.random() * facilityTypes.length)],
                    'Committed/Uncommitted': facilityTypes[Math.floor(Math.random() * facilityTypes.length)],
                    Management_Status: mgmtStatus,
                    CA_Review: review,
                    Origination_Date: Math.random() < 0.3 ? '' : formatDateForDummy(new Date(2024, Math.floor(Math.random() * 11), Math.floor(Math.random() * 28) + 1)),
                    Facility_First_Approval_Date: formatDateForDummy(new Date(2024, Math.floor(Math.random() * 11), Math.floor(Math.random() * 28) + 1)),
                    ROTCE: (Math.random() * 30 + 5).toFixed(2),
                    Underwriting_Team_Lead: 'John Doe',
                    Lead_Underwriter: 'Jane Smith',
                    Control_Unit: 'CU-' + Math.floor(Math.random() * 100),
                });
            }
            
            return data;
        }
        
        function formatDateForDummy(date) {
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const year = date.getFullYear();
            return `${month}/${day}/${year}`;
        }
        // ============================================
        // END DUMMY DATA GENERATOR
        // ============================================

        // Initialize on page load
        document.addEventListener("DOMContentLoaded", function () {
            console.log("=== Portfolio Analytics Dashboard ===");
            console.log("READ-ONLY mode - Loading data from Confluence");
            console.log("Page ID:", CONFLUENCE_PAGE_ID);
            console.log("File:", CONFLUENCE_FILE_NAME);
            console.log("=====================================");
            
            // Verify all required libraries are loaded
            if (typeof ApexCharts === "undefined") {
                console.error(
                    " ApexCharts library not loaded! Charts will not work."
                );
                showNotification(
                    "Error",
                    "ApexCharts library failed to load. Please refresh the page.",
                    "error"
                );
            } else {
                console.log(" ApexCharts library loaded successfully");
            }

            if (typeof XLSX === "undefined") {
                console.warn(
                    "  XLSX library not loaded. Excel file parsing may not work."
                );
            } else {
                console.log(" XLSX library loaded successfully");
            }
            
            // TEMPORARY: Use dummy data for testing (REMOVE LATER)
            console.warn(" USING DUMMY DATA FOR TESTING - REMOVE LATER!");
            portfolioData = generateDummyData();
            console.log(` Generated ${portfolioData.length} dummy records`);
            hideLoadingOverlay();
            
            // Calculate metrics and populate charts
            calculateMetrics();
            populateCovenantMonitoringData();
            createCovenantMonitoringChart('pastDue');
            updateCovenantRegionalTable('pastDue');
            calculateCCMStats();
            createCCMRegionalChart();
            updateCCMStats('pastDue');
            
            // Load actual data from Confluence (commented out for testing)
            // loadDataFromCSV();
            
            // Initialize charts - show loading/no-data state immediately
            setTimeout(() => {
                // Show initial no-data messages for charts that depend on portfolio data
                const chartInits = [
                    { id: '#facilityTrendChart', name: 'CAs & Facilities Expiring' },
                    { id: '#creditClassificationChart', name: 'New Facilities Approved' },
                    { id: '#relationshipChart', name: 'Top Relationships' },
                    { id: '#rotceChart', name: 'ROTCE Performance' }
                ];
                
                chartInits.forEach(({ id, name }) => {
                    const el = document.querySelector(id);
                    if (el) {
                        // Check if element has no actual chart content (just comments or whitespace)
                        const hasChart = el.querySelector('.apexcharts-canvas');
                        const hasNoDataMsg = el.querySelector('div[style*="flex"]');
                        if (!hasChart && !hasNoDataMsg) {
                            el.innerHTML = generateNoDataMessage(name);
                        }
                    }
                });
                
                // Initialize covenant and CCM charts
                populateCovenantMonitoringData();
                createCovenantMonitoringChart('pastDue');
                updateCovenantRegionalTable('pastDue');
                calculateCCMStats();
                createCCMRegionalChart();
            }, 100);
            
            // Setup search functionality with debouncing (increased for large datasets)
            document
                .getElementById("searchInput")
                .addEventListener("input", function () {
                // Clear previous timer
                if (searchDebounceTimer) {
                    clearTimeout(searchDebounceTimer);
                }
                
                // Set new timer - wait 500ms after user stops typing (longer for 40K rows)
                searchDebounceTimer = setTimeout(() => {
                    filterData();
                }, 500);
            });
        });

        // Refresh data from Confluence (read-only, no write operations)
        async function refreshData() {
            try {
                console.log("Refreshing data from Confluence...");
                const data = await fetchDataFromConfluence();
                
                if (data && data.length > 0) {
                    portfolioData = data;
                    
                    // Clear all caches
                    metricsCache = { full: null, filtered: null, filterHash: "" };
                    indexCache = {
                        byRegion: null,
                        byProduct: null,
                        byRelationship: null,
                        dates: null,
                    };
                    
                    // Rebuild indexes
                    buildIndexes();
                    
                    // Repopulate filter options with fresh data
                    populateFilterOptions();
                    
                    // Recalculate all metrics and charts
                    calculateMetrics();
                    createFacilityTrendChart();
                    createRelationshipChart();
                    createCreditClassificationChart();
                    createROTCEChart();
                    
                    // Reset filters and reload data
                    activeFilters = {};
                    displayFilterBadges();
                    updateFilterCount();
                    filterData();
                    
                    showNotification(
                        "Success",
                        `Refreshed ${data.length.toLocaleString()} records successfully`,
                        "success"
                    );
                } else {
                    console.error("No data received from Confluence");
                    showNotification(
                        "Error",
                        "Failed to refresh data from Confluence",
                        "error"
                    );
                }
            } catch (error) {
                console.error("Error refreshing data:", error);
                showNotification(
                    "Error",
                    "Failed to refresh data: " + error.message,
                    "error"
                );
            }
        }

        // Load data from Confluence attachment (read-only)
        async function loadDataFromCSV() {
            const loadStartTime = performance.now();
            
            showLoadingOverlay(
                "Connecting to Confluence...",
                "Establishing connection...",
                5
            );
            
            try {
                // Start loading covenant and CCM data in parallel (they're smaller files)
                showLoadingOverlay(
                    "Fetching data files...",
                    "Loading Portfolio, Covenants & CCM data...",
                    10
                );
                
                const covenantDataPromise = fetchCovenantsFromConfluence();
                const ccmDataPromise = fetchCCMFromConfluence();
                
                // Load portfolio data (largest file) - 10% to 40%
                showLoadingOverlay(
                    "Fetching Portfolio data...",
                    "Downloading portfolio file...",
                    15
                );
                
                const data = await fetchDataFromConfluence();
                
                if (data && data.length > 0) {
                    portfolioData = data;
                    console.log(` Loaded ${data.length} portfolio records`);
                    
                    // Reset reporting month to recalculate from new data
                    reportingMonth = null;
                    const repMonth = getReportingMonth();
                    console.log(` Reporting Month: ${repMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`);
                    
                    showLoadingOverlay(
                        "Portfolio data loaded",
                        `Portfolio: ${data.length.toLocaleString()} records loaded`,
                        40
                    );
                    
                    // Wait for covenant data - 40% to 50%
                    showLoadingOverlay(
                        "Loading Covenants data...",
                        "Fetching covenant records...",
                        45
                    );
                    
                    const covenantResult = await covenantDataPromise;
                    if (covenantResult && covenantResult.length > 0) {
                        covenantsData = covenantResult;
                        console.log(` Loaded ${covenantResult.length} covenant records`);
                    } else {
                        console.warn(` No covenant data loaded from ${CONFLUENCE_COVENANTS_FILE}`);
                        covenantsData = [];
                    }
                    
                    showLoadingOverlay(
                        "Covenants data loaded",
                        `Covenants: ${covenantsData.length.toLocaleString()} records`,
                        50
                    );
                    
                    // Wait for CCM data - 50% to 60%
                    showLoadingOverlay(
                        "Loading CCM data...",
                        "Fetching CCM records...",
                        55
                    );
                    
                    const ccmResult = await ccmDataPromise;
                    if (ccmResult && ccmResult.length > 0) {
                        ccmData = ccmResult;
                        console.log(` Loaded ${ccmResult.length} CCM records`);
                    } else {
                        console.warn(` No CCM data loaded from ${CONFLUENCE_CCM_FILE}`);
                        ccmData = [];
                    }
                    
                    showLoadingOverlay(
                        "CCM data loaded",
                        `CCM: ${ccmData.length.toLocaleString()} records`,
                        60
                    );
                    
                    showLoadingOverlay(
                        "Initializing dashboard...",
                        "Building charts and metrics...",
                        70
                    );
                    
                    // Use setTimeout to allow UI to update before heavy processing
                    setTimeout(() => {
                        showLoadingOverlay(
                            "Processing data...",
                            "Calculating metrics...",
                            80
                        );
                        
                        setTimeout(() => {
                            showLoadingOverlay(
                                "Finalizing...",
                                "Almost done...",
                                90
                            );
                            
                        initializeDashboard();
                            
                            const loadTime = ((performance.now() - loadStartTime) / 1000).toFixed(1);
                            
                            showLoadingOverlay(
                                "Complete!",
                                "Dashboard ready",
                                100
                            );
                            
                            setTimeout(() => {
                        hideLoadingOverlay();
                                
                        showNotification(
                            "Success",
                                    `Loaded ${data.length.toLocaleString()} records in ${loadTime}s`,
                            "success"
                        );
                                
                                console.log(` Dashboard loaded in ${loadTime}s`);
                            }, 300);
                        }, 50);
                    }, 100);
                } else {
                    console.error("No data from Confluence");
                    hideLoadingOverlay();
                    showNotification(
                        "Error",
                        "No data found in Confluence attachment",
                        "error"
                    );
                }
            } catch (error) {
                console.error("Error loading data from Confluence:", error);
                hideLoadingOverlay();
                showNotification(
                    "Error",
                    "Failed to load data from Confluence: " + error.message,
                    "error"
                );
            }
        }

        // Fetch data from Confluence attachment (read-only, no updates)
        async function fetchDataFromConfluence() {
            try {
                // Construct Confluence API URL
                const url = `${CONFLUENCE_BASE_URL}/download/attachments/${CONFLUENCE_PAGE_ID}/${CONFLUENCE_FILE_NAME}?api=v2`;
                
                console.log("Fetching portfolio data from Confluence:", url);
                console.log("File name:", CONFLUENCE_FILE_NAME);
                
                const response = await fetch(url, {
                    headers: {
                        "X-Atlassian-Token": "no-check",
                    },
                });

                if (!response.ok) {
                    throw new Error(
                        `Failed to fetch ${CONFLUENCE_FILE_NAME}: ${response.status} ${response.statusText}`
                    );
                }

                console.log("Successfully fetched file from Confluence");
                const blob = await response.blob();
                console.log("Blob size:", blob.size, "bytes");
                
                // Parse based on file type with progress updates (10-40% range)
                let portfolioProgressStart = 10;
                let portfolioProgressEnd = 40;
                const progressCallback = (msg, percent = null) => {
                    let finalPercent = null;
                    if (percent !== null) {
                        // Map the percent to the portfolio loading range (15-40%)
                        finalPercent = Math.round(portfolioProgressStart + (percent / 100) * (portfolioProgressEnd - portfolioProgressStart));
                    }
                    showLoadingOverlay("Loading Portfolio Data...", msg, finalPercent);
                };
                
                if (CONFLUENCE_FILE_NAME.endsWith(".csv")) {
                    console.log("Parsing CSV file...");
                    return await parseCSVBlob(blob);
                } else if (
                    CONFLUENCE_FILE_NAME.endsWith(".xlsx") ||
                    CONFLUENCE_FILE_NAME.endsWith(".xls")
                ) {
                    console.log("Parsing Excel file (this may take a moment for large files)...");
                    progressCallback("Preparing to parse Excel...");
                    return await parseExcelBlob(blob, progressCallback);
                }
                
                throw new Error(
                    "Unsupported file format. Please use .csv, .xlsx, or .xls files."
                );
            } catch (error) {
                console.error("Error fetching data from Confluence:", error.message);
                return null;
            }
        }

        // Fetch covenant data from Confluence attachment (separate file)
        async function fetchCovenantsFromConfluence() {
            try {
                // Construct Confluence API URL for covenants file
                const url = `${CONFLUENCE_BASE_URL}/download/attachments/${CONFLUENCE_PAGE_ID}/${CONFLUENCE_COVENANTS_FILE}?api=v2`;
                
                console.log("Fetching covenant data from Confluence:", url);
                console.log("Covenants file name:", CONFLUENCE_COVENANTS_FILE);
                
                const response = await fetch(url, {
                    headers: {
                        "X-Atlassian-Token": "no-check",
                    },
                });

                if (!response.ok) {
                    console.warn(
                        `Failed to fetch ${CONFLUENCE_COVENANTS_FILE}: ${response.status} ${response.statusText}. Covenants will not be available.`
                    );
                    return null;
                }

                console.log("Successfully fetched covenant file from Confluence");
                const blob = await response.blob();
                console.log("Covenant blob size:", blob.size, "bytes");
                
                // Parse Excel file (covenants are in .xlsx format)
                if (CONFLUENCE_COVENANTS_FILE.endsWith(".xlsx") || CONFLUENCE_COVENANTS_FILE.endsWith(".xls")) {
                    console.log("Parsing covenant Excel file...");
                    return await parseCovenantExcelBlob(blob);
                }
                
                throw new Error("Covenant file must be .xlsx or .xls format");
            } catch (error) {
                console.error("Error fetching covenant data from Confluence:", error.message);
                return null;
            }
        }

        // Parse Covenant Excel blob (separate parser for covenant files)
        async function parseCovenantExcelBlob(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        
                        const workbook = XLSX.read(data, { 
                            type: "array",
                            cellDates: true,
                            cellNF: false,
                            cellText: false,
                        });
                        
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        
                        console.log(" Covenant Excel Sheet Name:", workbook.SheetNames[0]);
                        
                        // Convert sheet to JSON
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
                            raw: false,
                            dateNF: "yyyy-mm-dd",
                        });
                        
                        console.log(` Total covenant rows in Excel: ${jsonData.length}`);
                        
                        // Don't filter by Facility_ID - covenants might use different key fields
                        // Filter out completely empty rows
                        const filteredData = jsonData.filter((row) => {
                            // Keep row if it has any non-empty values
                            return Object.values(row).some(val => val !== null && val !== undefined && val !== '');
                        });
                        
                        console.log(` Parsed ${filteredData.length} valid covenant records from Excel`);
                        
                        // Log data structure for debugging
                        if (filteredData.length > 0) {
                            console.log(" Covenant record fields:", Object.keys(filteredData[0]));
                            console.log(" Sample covenant record:", filteredData[0]);
                        }
                        
                        resolve(filteredData);
                    } catch (error) {
                        console.error("Error parsing covenant Excel:", error);
                        reject(error);
                    }
                };
                reader.onerror = function (error) {
                    console.error("FileReader error:", error);
                    reject(error);
                };
                reader.readAsArrayBuffer(blob);
            });
        }

        // Fetch CCM data from Confluence
        async function fetchCCMFromConfluence() {
            try {
                // Construct Confluence API URL for CCM file
                const url = `${CONFLUENCE_BASE_URL}/download/attachments/${CONFLUENCE_PAGE_ID}/${CONFLUENCE_CCM_FILE}?api=v2`;
                
                console.log("Fetching CCM data from Confluence:", url);
                console.log("CCM file name:", CONFLUENCE_CCM_FILE);
                
                const response = await fetch(url, {
                    headers: {
                        "X-Atlassian-Token": "no-check",
                    },
                });

                if (!response.ok) {
                    console.warn(
                        `Failed to fetch ${CONFLUENCE_CCM_FILE}: ${response.status} ${response.statusText}. CCM data will not be available.`
                    );
                    return null;
                }

                console.log("Successfully fetched CCM file from Confluence");
                const blob = await response.blob();
                console.log("CCM blob size:", blob.size, "bytes");
                
                // Parse Excel file (CCM is in .xlsx format)
                if (CONFLUENCE_CCM_FILE.endsWith(".xlsx") || CONFLUENCE_CCM_FILE.endsWith(".xls")) {
                    console.log("Parsing CCM Excel file...");
                    return await parseCCMExcelBlob(blob);
                }
                
                throw new Error("CCM file must be .xlsx or .xls format");
            } catch (error) {
                console.error("Error fetching CCM data from Confluence:", error.message);
                return null;
            }
        }

        // Parse CCM Excel blob
        async function parseCCMExcelBlob(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        
                        const workbook = XLSX.read(data, { 
                            type: "array",
                            cellDates: true,
                            cellNF: false,
                            cellText: false,
                        });
                        
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        
                        console.log(" CCM Excel Sheet Name:", workbook.SheetNames[0]);
                        
                        // Convert sheet to JSON
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
                            raw: false,
                            dateNF: "yyyy-mm-dd",
                        });
                        
                        console.log(` Total CCM rows in Excel: ${jsonData.length}`);
                        
                        // Filter out completely empty rows
                        const filteredData = jsonData.filter((row) => {
                            // Keep row if it has any non-empty values
                            return Object.values(row).some(val => val !== null && val !== undefined && val !== '');
                        });
                        
                        console.log(` Parsed ${filteredData.length} valid CCM records from Excel`);
                        
                        // Log data structure for debugging
                        if (filteredData.length > 0) {
                            console.log(" CCM record fields:", Object.keys(filteredData[0]));
                            console.log(" Sample CCM record:", filteredData[0]);
                        }
                        
                        resolve(filteredData);
                    } catch (error) {
                        console.error("Error parsing CCM Excel:", error);
                        reject(error);
                    }
                };
                reader.onerror = function (error) {
                    console.error("FileReader error:", error);
                    reject(error);
                };
                reader.readAsArrayBuffer(blob);
            });
        }

        // Parse CSV blob (read-only)
        async function parseCSVBlob(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const text = e.target.result;
                        const lines = text.split("\n");
                        const headers = lines[0].split(",").map((h) => h.trim());
                        
                        console.log("CSV Headers:", headers);
                        
                        const data = [];
                        for (let i = 1; i < lines.length; i++) {
                            if (lines[i].trim()) {
                                const values = lines[i].split(",");
                                const row = {};
                                headers.forEach((header, index) => {
                                    row[header] = values[index] ? values[index].trim() : "";
                                });
                                // Only add rows with Facility_ID
                                if (row.Facility_ID) {
                                    data.push(row);
                                }
                            }
                        }
                        
                        console.log(`Parsed ${data.length} records from CSV`);
                        resolve(data);
                    } catch (error) {
                        console.error("Error parsing CSV:", error);
                        reject(error);
                    }
                };
                reader.onerror = () => {
                    console.error("FileReader error while reading CSV");
                    reject(new Error("Failed to read CSV file"));
                };
                reader.readAsText(blob);
            });
        }

        // Parse Excel blob (read-only) - OPTIMIZED for large files
        async function parseExcelBlob(blob, progressCallback = null) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onprogress = function(e) {
                    if (e.lengthComputable && progressCallback) {
                        const percent = Math.round((e.loaded / e.total) * 30);
                        progressCallback(`Reading file...`, percent);
                    }
                };
                
                reader.onload = function (e) {
                    try {
                        if (progressCallback) progressCallback("Parsing Excel structure...", 35);
                        
                        const data = new Uint8Array(e.target.result);
                        const startTime = performance.now();
                        
                        // OPTIMIZED: Use minimal parsing options for speed
                        const workbook = XLSX.read(data, { 
                            type: "array",
                            cellDates: true,
                            cellNF: false,
                            cellText: false,
                            cellStyles: false,
                            sheetStubs: false,
                        });
                        
                        const parseTime = performance.now() - startTime;
                        console.log(`Excel parsed in ${(parseTime/1000).toFixed(2)}s`);
                        
                        if (progressCallback) progressCallback("Converting to data rows...", 60);
                        
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        console.log("Excel Sheet Name:", workbook.SheetNames[0]);
                        
                        // OPTIMIZED: Convert sheet to JSON
                        const convertStart = performance.now();
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
                            raw: false,
                            dateNF: "yyyy-mm-dd",
                            defval: "",
                        });
                        const convertTime = performance.now() - convertStart;
                        console.log(`Converted ${jsonData.length} rows in ${(convertTime/1000).toFixed(2)}s`);
                        
                        if (progressCallback) progressCallback(`Filtering ${jsonData.length.toLocaleString()} rows...`, 90);
                        
                        // Filter for rows with Facility_ID
                        const filteredData = jsonData.filter((row) => row.Facility_ID);
                        
                        console.log(`Parsed ${filteredData.length} valid records from Excel`);
                        
                        // Log sample data for debugging
                        if (filteredData.length > 0) {
                            console.log("Sample record fields:", Object.keys(filteredData[0]));
                        }
                        
                        if (progressCallback) progressCallback(`Portfolio data ready (${filteredData.length.toLocaleString()} records)`, 100);
                        
                        resolve(filteredData);
                    } catch (error) {
                        console.error("Error parsing Excel:", error);
                        reject(error);
                    }
                };
                reader.onerror = () => {
                    console.error("FileReader error while reading Excel file");
                    reject(new Error("Failed to read Excel file"));
                };
                reader.readAsArrayBuffer(blob);
            });
        }

        // Show loading overlay with title, progress and percentage
        function showLoadingOverlay(
            title = "Loading Portfolio Data",
            progress = "Please wait while we fetch your data...",
            percent = null
        ) {
            const overlay = document.getElementById("loadingOverlay");
            const titleEl = document.getElementById("loadingMessage");
            const progressEl = document.getElementById("loadingProgress");
            const percentEl = document.getElementById("loadingPercent");
            const progressBar = document.getElementById("loadingProgressBar");
            
            if (overlay) {
                overlay.classList.remove("hidden");
                if (titleEl) titleEl.textContent = title;
                if (progressEl) progressEl.textContent = progress;
                
                // Update percentage if provided
                if (percent !== null && percentEl && progressBar) {
                    const clampedPercent = Math.min(100, Math.max(0, percent));
                    percentEl.textContent = `${Math.round(clampedPercent)}%`;
                    progressBar.style.width = `${clampedPercent}%`;
                }
            }
        }
        
        // Update just the loading percentage
        function updateLoadingPercent(percent) {
            const percentEl = document.getElementById("loadingPercent");
            const progressBar = document.getElementById("loadingProgressBar");
            
            if (percentEl && progressBar) {
                const clampedPercent = Math.min(100, Math.max(0, percent));
                percentEl.textContent = `${Math.round(clampedPercent)}%`;
                progressBar.style.width = `${clampedPercent}%`;
            }
        }

        // Hide loading overlay
        function hideLoadingOverlay() {
            const overlay = document.getElementById("loadingOverlay");
            if (overlay) {
                overlay.classList.add("hidden");
            }
        }

        // Show notification (TailAdmin style - matching alerts.html)
        function showNotification(title, message, type = "success") {
            const configs = {
                success: {
                    bgColor: "bg-success-50",
                    borderColor: "border-success-500",
                    textColor: "text-success-500",
                    icon: `<svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M3.70186 12.0001C3.70186 7.41711 7.41711 3.70186 12.0001 3.70186C16.5831 3.70186 20.2984 7.41711 20.2984 12.0001C20.2984 16.5831 16.5831 20.2984 12.0001 20.2984C7.41711 20.2984 3.70186 16.5831 3.70186 12.0001ZM12.0001 1.90186C6.423 1.90186 1.90186 6.423 1.90186 12.0001C1.90186 17.5772 6.423 22.0984 12.0001 22.0984C17.5772 22.0984 22.0984 17.5772 22.0984 12.0001C22.0984 6.423 17.5772 1.90186 12.0001 1.90186ZM15.6197 10.7395C15.9712 10.388 15.9712 9.81819 15.6197 9.46672C15.2683 9.11525 14.6984 9.11525 14.347 9.46672L11.1894 12.6243L9.6533 11.0883C9.30183 10.7368 8.73198 10.7368 8.38051 11.0883C8.02904 11.4397 8.02904 12.0096 8.38051 12.3611L10.553 14.5335C10.7217 14.7023 10.9507 14.7971 11.1894 14.7971C11.428 14.7971 11.657 14.7023 11.8257 14.5335L15.6197 10.7395Z" fill=""/>
                    </svg>`
                },
                error: {
                    bgColor: "bg-error-50",
                    borderColor: "border-error-500",
                    textColor: "text-error-500",
                    icon: `<svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M20.3499 12.0004C20.3499 16.612 16.6115 20.3504 11.9999 20.3504C7.38832 20.3504 3.6499 16.612 3.6499 12.0004C3.6499 7.38881 7.38833 3.65039 11.9999 3.65039C16.6115 3.65039 20.3499 7.38881 20.3499 12.0004ZM11.9999 22.1504C17.6056 22.1504 22.1499 17.6061 22.1499 12.0004C22.1499 6.3947 17.6056 1.85039 11.9999 1.85039C6.39421 1.85039 1.8499 6.3947 1.8499 12.0004C1.8499 17.6061 6.39421 22.1504 11.9999 22.1504ZM13.0008 16.4753C13.0008 15.923 12.5531 15.4753 12.0008 15.4753L11.9998 15.4753C11.4475 15.4753 10.9998 15.923 10.9998 16.4753C10.9998 17.0276 11.4475 17.4753 11.9998 17.4753L12.0008 17.4753C12.5531 17.4753 13.0008 17.0276 13.0008 16.4753ZM11.9998 6.62898C12.414 6.62898 12.7498 6.96476 12.7498 7.37898L12.7498 13.0555C12.7498 13.4697 12.414 13.8055 11.9998 13.8055C11.5856 13.8055 11.2498 13.4697 11.2498 13.0555L11.2498 7.37898C11.2498 6.96476 11.5856 6.62898 11.9998 6.62898Z" fill="#F04438"/>
                    </svg>`
                },
                warning: {
                    bgColor: "bg-warning-50",
                    borderColor: "border-warning-500",
                    textColor: "text-warning-500",
                    icon: `<svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M3.6501 12.0001C3.6501 7.38852 7.38852 3.6501 12.0001 3.6501C16.6117 3.6501 20.3501 7.38852 20.3501 12.0001C20.3501 16.6117 16.6117 20.3501 12.0001 20.3501C7.38852 20.3501 3.6501 16.6117 3.6501 12.0001ZM12.0001 1.8501C6.39441 1.8501 1.8501 6.39441 1.8501 12.0001C1.8501 17.6058 6.39441 22.1501 12.0001 22.1501C17.6058 22.1501 22.1501 17.6058 22.1501 12.0001C22.1501 6.39441 17.6058 1.8501 12.0001 1.8501ZM10.9992 7.52517C10.9992 8.07746 11.4469 8.52517 11.9992 8.52517H12.0002C12.5525 8.52517 13.0002 8.07746 13.0002 7.52517C13.0002 6.97289 12.5525 6.52517 12.0002 6.52517H11.9992C11.4469 6.52517 10.9992 6.97289 10.9992 7.52517ZM12.0002 17.3715C11.586 17.3715 11.2502 17.0357 11.2502 16.6215V10.945C11.2502 10.5308 11.586 10.195 12.0002 10.195C12.4144 10.195 12.7502 10.5308 12.7502 10.945V16.6215C12.7502 17.0357 12.4144 17.3715 12.0002 17.3715Z" fill=""/>
                    </svg>`
                },
                info: {
                    bgColor: "bg-blue-light-50",
                    borderColor: "border-blue-light-500",
                    textColor: "text-blue-light-500",
                    icon: `<svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M3.6501 11.9996C3.6501 7.38803 7.38852 3.64961 12.0001 3.64961C16.6117 3.64961 20.3501 7.38803 20.3501 11.9996C20.3501 16.6112 16.6117 20.3496 12.0001 20.3496C7.38852 20.3496 3.6501 16.6112 3.6501 11.9996ZM12.0001 1.84961C6.39441 1.84961 1.8501 6.39392 1.8501 11.9996C1.8501 17.6053 6.39441 22.1496 12.0001 22.1496C17.6058 22.1496 22.1501 17.6053 22.1501 11.9996C22.1501 6.39392 17.6058 1.84961 12.0001 1.84961ZM10.9992 7.52468C10.9992 8.07697 11.4469 8.52468 11.9992 8.52468H12.0002C12.5525 8.52468 13.0002 8.07697 13.0002 7.52468C13.0002 6.9724 12.5525 6.52468 12.0002 6.52468H11.9992C11.4469 6.52468 10.9992 6.9724 10.9992 7.52468ZM12.0002 17.371C11.586 17.371 11.2502 17.0352 11.2502 16.621V10.9445C11.2502 10.5303 11.586 10.1945 12.0002 10.1945C12.4144 10.1945 12.7502 10.5303 12.7502 10.9445V16.621C12.7502 17.0352 12.4144 17.371 12.0002 17.371Z" fill=""/>
                    </svg>`
                },
            };

            const config = configs[type] || configs.success;
            const notification = document.createElement("div");

            // Create notification with TailAdmin alert styling with solid background
            notification.className = `fixed top-6 right-6 z-9999 max-w-md rounded-xl border ${config.borderColor} bg-white p-4 shadow-lg transform transition-all duration-300 ease-out`;
            notification.style.animation = 'slideInRight 0.3s ease-out';
            
            // Add background color overlay as inline style for solid appearance
            notification.style.position = 'fixed';
            notification.style.backgroundColor = 'white';

            notification.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="-mt-0.5 ${config.textColor}">
                        ${config.icon}
                    </div>
                    <div class="flex-1">
                        <h4 class="mb-1 text-sm font-semibold text-gray-800">
                            ${title}
                        </h4>
                        <p class="text-sm text-gray-500">
                            ${message}
                        </p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600 transition-colors -mt-0.5">
                        <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M4.29289 4.29289C4.68342 3.90237 5.31658 3.90237 5.70711 4.29289L10 8.58579L14.2929 4.29289C14.6834 3.90237 15.3166 3.90237 15.7071 4.29289C16.0976 4.68342 16.0976 5.31658 15.7071 5.70711L11.4142 10L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L10 11.4142L5.70711 15.7071C5.31658 16.0976 4.68342 16.0976 4.29289 15.7071C3.90237 15.3166 3.90237 14.6834 4.29289 14.2929L8.58579 10L4.29289 5.70711C3.90237 5.31658 3.90237 4.68342 4.29289 4.29289Z" fill=""/>
                        </svg>
                    </button>
                </div>
            `;

            document.body.appendChild(notification);
            
            // Auto-dismiss after 5 seconds with fade out animation
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
                }, 300);
            }, 5000);
        }


        // Build indexes for fast filtering (one-time operation)
        function buildIndexes() {
            console.log("Building indexes for fast filtering...");
            const startTime = performance.now();
            
            indexCache.byRegion = new Map();
            indexCache.byProduct = new Map();
            indexCache.byRelationship = new Map();
            indexCache.dates = [];
            
            portfolioData.forEach((row, idx) => {
                // Region index
                const region = row.Region;
                if (region) {
                    if (!indexCache.byRegion.has(region)) {
                        indexCache.byRegion.set(region, []);
                    }
                    indexCache.byRegion.get(region).push(idx);
                }
                
                // Product index
                const product = row.Product_Program;
                if (product) {
                    if (!indexCache.byProduct.has(product)) {
                        indexCache.byProduct.set(product, []);
                    }
                    indexCache.byProduct.get(product).push(idx);
                }
                
                // Relationship index
                const relationship = row.Relationship_Name || row.Relationship_ID;
                if (relationship) {
                    if (!indexCache.byRelationship.has(relationship)) {
                        indexCache.byRelationship.set(relationship, []);
                    }
                    indexCache.byRelationship.get(relationship).push(idx);
                }
                
                // Pre-parse dates for faster filtering
                const maturityDate = parseDate(row.Maturity_Date);
                const caDate = parseDate(row.CA_Expiration_Date);
                indexCache.dates.push({
                    maturityDate,
                    caDate,
                });
            });
            
            const endTime = performance.now();
            console.log(
                `Indexes built in ${((endTime - startTime) / 1000).toFixed(
                    2
                )} seconds`
            );
        }
        
        // Generate hash of active filters for cache validation
        function getFilterHash() {
            return (
                JSON.stringify(activeFilters) +
                "_" +
                document.getElementById("searchInput").value
            );
        }

        // Initialize dashboard with data (optimized for large datasets)
        function initializeDashboard() {
            const startTime = performance.now();
            console.log(
                "Initializing dashboard with",
                portfolioData.length,
                "records..."
            );
            
            // Safety check
            if (!portfolioData || portfolioData.length === 0) {
                console.error("No portfolio data loaded!");
                showNotification("Error", "No portfolio data available", "error");
                return;
            }
            
            // Log data structure for debugging
            console.log("Data row example:", portfolioData[0]);
            console.log("Available fields:", Object.keys(portfolioData[0]));
            
            // Step 1: Build indexes (one-time, makes filtering much faster)
            console.time("Build Indexes");
            buildIndexes();
            console.timeEnd("Build Indexes");
            
            // Step 2: Populate filters
            console.time("Populate Filters");
            populateFilterOptions();
            console.timeEnd("Populate Filters");
            
            // Step 3: Update report date
            console.time("Update Report Date");
            updateReportDate();
            console.timeEnd("Update Report Date");
            
            // Step 4: Calculate metrics (with caching)
            console.time("Calculate Metrics");
            calculateMetrics();
            console.timeEnd("Calculate Metrics");
            
            // Step 5: Create charts with sampled data (faster)
            console.time("Create Charts");
            createFacilityTrendChart();
            createRelationshipChart();
            createCreditClassificationChart();
            createROTCEChart();
            console.timeEnd("Create Charts");
            
            // Ensure no charts are left blank - show no-data message as fallback
            setTimeout(() => {
                const chartChecks = [
                    { id: '#facilityTrendChart', name: 'CAs & Facilities Expiring' },
                    { id: '#creditClassificationChart', name: 'New Facilities Approved' },
                    { id: '#relationshipChart', name: 'Top Relationships' },
                    { id: '#rotceChart', name: 'ROTCE Performance' }
                ];
                
                chartChecks.forEach(({ id, name }) => {
                    const el = document.querySelector(id);
                    if (el) {
                        const hasChart = el.querySelector('.apexcharts-canvas');
                        const hasNoDataMsg = el.innerHTML.includes('No data available');
                        
                        // If no chart and no existing no-data message, show no-data message
                        if (!hasChart && !hasNoDataMsg) {
                            console.log(` Chart ${name} is blank, showing no-data message`);
                            el.innerHTML = generateNoDataMessage(name);
                        }
                    }
                });
            }, 200);
            
            // Step 6: Filter and render table (only first page)
            console.time("Filter and Render Table");
            filterData();
            console.timeEnd("Filter and Render Table");
            
            const endTime = performance.now();
            console.log(
                `Dashboard initialized in ${((endTime - startTime) / 1000).toFixed(
                    2
                )} seconds`
            );
        }

        // Populate filter dropdowns with unique values from Confluence data (read-only)
        function populateFilterOptions() {
            if (!portfolioData || portfolioData.length === 0) {
                console.warn("No portfolio data available to populate filters");
                return;
            }

            console.log(
                "Populating filter options from",
                portfolioData.length,
                "records"
            );
            
            // Product Program
            const products = [
                ...new Set(
                    portfolioData.map((row) => row.Product_Program).filter(Boolean)
                ),
            ].sort();
            populateSelect("filterProductProgram", products);
            console.log("Product Programs:", products.length, "options");
            
            // Extending Unit (Control_Unit)
            const units = [
                ...new Set(
                    portfolioData.map((row) => row.Control_Unit).filter(Boolean)
                ),
            ].sort();
            populateSelect("filterExtendingUnit", units);
            console.log("Extending Units:", units.length, "options");
            
            // Facility Type
            const facilityTypes = [
                ...new Set(
                    portfolioData.map((row) => row.Facility_Type).filter(Boolean)
                ),
            ].sort();
            populateSelect("filterFacilityType", facilityTypes);
            console.log("Facility Types:", facilityTypes.length, "options");
            
            // Committed/Uncommitted
            const commitments = [
                ...new Set(
                    portfolioData
                        .map((row) => row["Committed/Uncommitted"])
                        .filter(Boolean)
                ),
            ].sort();
            populateSelect("filterCommitment", commitments);
            console.log("Commitment Status:", commitments.length, "options");
            
            // Team Lead (Underwriter_Team_Lead)
            const teamLeads = [
                ...new Set(
                    portfolioData
                        .map((row) => row.Underwriting_Team_Lead)
                        .filter(Boolean)
                ),
            ].sort();
            populateSelect("filterTeamLead", teamLeads);
            console.log("Team Leads:", teamLeads.length, "options");
            
            // Underwriter (Lead_Underwriter)
            const underwriters = [
                ...new Set(
                    portfolioData.map((row) => row.Lead_Underwriter).filter(Boolean)
                ),
            ].sort();
            populateSelect("filterUnderwriter", underwriters);
            console.log("Underwriters:", underwriters.length, "options");
        }

        // Helper to populate a select element
        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) {
                console.warn(`Select element with id '${selectId}' not found`);
                return;
            }
            const currentValue = select.value;
            
            // Keep the first option (All...)
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            options.forEach((option) => {
                const opt = document.createElement("option");
                opt.value = option;
                opt.textContent = option;
                select.appendChild(opt);
            });
            
            // Restore previous value if it still exists
            if (currentValue && options.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // Apply all filters (OPTIMIZED for 40K+ rows)
        function applyFilters() {
            const startTime = performance.now();
            
            // Get advanced filter values (excluding Region, Status, and Commitment Status which are in smart filters)
            const filters = {
                productProgram: document.getElementById("filterProductProgram").value,
                extendingUnit: document.getElementById("filterExtendingUnit").value,
                facilityType: document.getElementById("filterFacilityType").value,
                teamLead: document.getElementById("filterTeamLead").value,
                underwriter: document.getElementById("filterUnderwriter").value,
                caMaturity: document.getElementById("filterCAMaturity").value,
                facilityMaturity: document.getElementById("filterFacilityMaturity")
                    .value,
            };

            // Update active filters object (including Region, Status, and Commitment Status smart filters)
            activeFilters = {};
            
            // Add smart filters to activeFilters
            if (selectedRegion !== 'all')
                activeFilters["Region"] = selectedRegion;
            if (selectedStatus !== 'all')
                activeFilters["Status"] = selectedStatus;
            if (selectedCommitmentStatus !== 'all')
                activeFilters["Commitment Status"] = selectedCommitmentStatus;
            if (!includePSE)
                activeFilters["PSE"] = "Excluded";
            
            if (filters.productProgram)
                activeFilters["Product Program"] = filters.productProgram;
            if (filters.extendingUnit)
                activeFilters["Extending Unit"] = filters.extendingUnit;
            if (filters.facilityType)
                activeFilters["Facility Type"] = filters.facilityType;
            if (filters.teamLead) activeFilters["Team Lead"] = filters.teamLead;
            if (filters.underwriter)
                activeFilters["Underwriter"] = filters.underwriter;
            if (filters.caMaturity) {
                const days = filters.caMaturity;
                activeFilters["CAs Maturing"] =
                    days === "30"
                        ? "Next 30 Days"
                        : days === "60"
                            ? "Next 60 Days"
                            : days === "90"
                                ? "Next 90 Days"
                                : days === "180"
                                    ? "Next 6 Months"
                                    : "Next Year";
            }
            if (filters.facilityMaturity) {
                const days = filters.facilityMaturity;
                activeFilters["Facilities Maturing"] =
                    days === "30"
                        ? "Next 30 Days"
                        : days === "60"
                            ? "Next 60 Days"
                            : days === "90"
                                ? "Next 90 Days"
                                : days === "180"
                                    ? "Next 6 Months"
                                    : "Next Year";
            }
            
            // Display filter badges and update count
            displayFilterBadges();
            updateFilterCount();
            
            // Check if we can use cache
            const currentHash = getFilterHash();
            if (metricsCache.filterHash === currentHash && metricsCache.filtered) {
                console.log("Using cached filter results");
                filteredData = metricsCache.filtered.data;
                
                // Still need to update charts even when using cache
                requestAnimationFrame(() => {
                    calculateMetricsFromFiltered();
                    createExpirationChartFromFiltered();
                    createFacilityTrendChartFromFiltered();
                    createRelationshipChartFromFiltered();
                    createCreditClassificationChartFromFiltered();
                    createROTCEChartFromFiltered();
                });
                
                return;
            }
            
            // Pre-calculate date ranges for date filters (avoid recalculating in loop)
            let caDateRange = null;
            let facilityDateRange = null;
            if (filters.caMaturity) {
                const today = new Date();
                const futureDate = new Date(
                    today.getTime() + parseInt(filters.caMaturity) * 24 * 60 * 60 * 1000
                );
                caDateRange = { today, futureDate };
            }
            if (filters.facilityMaturity) {
                const today = new Date();
                const futureDate = new Date(
                    today.getTime() +
                    parseInt(filters.facilityMaturity) * 24 * 60 * 60 * 1000
                );
                facilityDateRange = { today, futureDate };
            }
            
            const searchTerm = document
                .getElementById("searchInput")
                .value.toLowerCase();
            
            // OPTIMIZED filtering: Use early exits and minimal object access
            filteredData = [];
            for (let i = 0; i < portfolioData.length; i++) {
                const row = portfolioData[i];
                
                // Smart Filters (apply first for performance)
                // Region filter (case-insensitive comparison)
                if (selectedRegion !== "all") {
                    const rowRegion = (row.Region || "").toUpperCase();
                    if (rowRegion !== selectedRegion.toUpperCase()) continue;
                }
                
                // PSE filter (exclude PSE if includePSE is false)
                // Use PSE_non-PSE column from data (values: "PSE" or "non-PSE")
                if (!includePSE) {
                    const pseColumn = row["PSE_non-PSE"] || row.PSE_non_PSE || "";
                    const pseValue = String(pseColumn).trim().toUpperCase();
                    // Skip rows where value is exactly "PSE" (not "non-PSE")
                    if (pseValue === "PSE") continue;
                }
                
                // Management Status filter (CM/DM) - case-insensitive comparison
                if (selectedStatus !== "all") {
                    const rowStatus = (row.Management_Status || "").toUpperCase();
                    if (rowStatus !== selectedStatus.toUpperCase()) continue;
                }
                
                // Commitment Status filter (Committed/Uncommitted)
                if (selectedCommitmentStatus !== "all") {
                    const rowCommitment = row["Committed/Uncommitted"] || "";
                    if (rowCommitment !== selectedCommitmentStatus) continue;
                }
                
                // Fast path: Check advanced filter string filters (fastest to fail)
                if (
                    filters.productProgram &&
                    row.Product_Program !== filters.productProgram
                )
                    continue;
                if (
                    filters.extendingUnit &&
                    row.Control_Unit !== filters.extendingUnit
                )
                    continue;
                if (
                    filters.facilityType &&
                    row.Facility_Type !== filters.facilityType
                )
                    continue;
                if (
                    filters.teamLead &&
                    row.Underwriting_Team_Lead !== filters.teamLead
                )
                    continue;
                if (
                    filters.underwriter &&
                    row.Lead_Underwriter !== filters.underwriter
                )
                    continue;
                
                // Date filters (use pre-parsed dates from index)
                if (caDateRange) {
                    const caDate = indexCache.dates[i].caDate;
                    if (
                        !caDate ||
                        caDate < caDateRange.today ||
                        caDate > caDateRange.futureDate
                    )
                        continue;
                }
                
                if (facilityDateRange) {
                    const maturityDate = indexCache.dates[i].maturityDate;
                    if (
                        !maturityDate ||
                        maturityDate < facilityDateRange.today ||
                        maturityDate > facilityDateRange.futureDate
                    )
                        continue;
                }
                
                // Search filter (most expensive, do last)
            if (searchTerm) {
                    let found = false;
                    for (const value of Object.values(row)) {
                        if (String(value).toLowerCase().includes(searchTerm)) {
                            found = true;
                            break;
                        }
                    }
                    if (!found) continue;
                }
                
                // All filters passed
                filteredData.push(row);
            }
            
            // Cache the results
            metricsCache.filterHash = currentHash;
            metricsCache.filtered = { data: filteredData };
            
            console.log(
                `Filtered ${portfolioData.length} to ${filteredData.length
                } rows in ${(performance.now() - startTime).toFixed(2)}ms`
            );
            
            // Recalculate metrics and charts with filtered data (async to prevent blocking)
            requestAnimationFrame(() => {
            calculateMetricsFromFiltered();
                createExpirationChartFromFiltered();
                createFacilityTrendChartFromFiltered();
            createRelationshipChartFromFiltered();
            createCreditClassificationChartFromFiltered();
                createROTCEChartFromFiltered();
                
                // Update covenant and CCM charts with region filter
                populateCovenantMonitoringData();
                createCovenantMonitoringChart('pastDue');
                updateCovenantRegionalTable('pastDue');
                calculateCCMStats();
                createCCMRegionalChart();
            });

            // Reset to first page and render table immediately
            currentPage = 1;
            renderTable();
        }

        // Apply chart-based filter (cross-filtering)
        function applyChartFilter(filterType, filterValue, displayLabel) {
            console.log(` Chart filter applied: ${filterType} = ${filterValue}`);

            // Set chart filter state
            chartFilter.active = true;
            chartFilter.type = filterType;
            chartFilter.value = filterValue;
            chartFilter.label = displayLabel || filterValue;

            // Display chart filter badge
            displayChartFilterBadge();

            // Apply the filter
            applyFiltersWithChartFilter();
        }

        // Clear chart filter
        function clearChartFilter() {
            console.log(" Chart filter cleared");

            chartFilter.active = false;
            chartFilter.type = null;
            chartFilter.value = null;
            chartFilter.label = null;

            // Remove badge and reapply normal filters
            const badge = document.getElementById("chartFilterBadge");
            if (badge) badge.remove();

            applyFilters();
        }

        // Display chart filter badge
        function displayChartFilterBadge() {
            // Remove existing badges if any
            const existing = document.getElementById("chartFilterBadge");
            if (existing) existing.remove();
            const pbExisting = document.getElementById("pb-chartFilterBadge");
            if (pbExisting) pbExisting.remove();

            if (!chartFilter.active) return;

            // Update Portfolio Overview badges
            const badgesContainer = document.getElementById("activeFiltersBadges");
            if (badgesContainer) {
                badgesContainer.style.display = "flex";

                const badge = document.createElement("span");
                badge.id = "chartFilterBadge";
                badge.className =
                    "inline-flex items-center bg-blue-50 text-sm text-blue-700 border-2 border-blue-500 rounded-lg gap-x-2 py-1.5 pl-3 pr-1 font-medium";
                badge.innerHTML = `
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                    </svg>
                    <span class="text-blue-700">Chart Filter</span>
                    <span class="h-4 w-px bg-blue-400"></span>
                    <span class="font-semibold text-blue-900">${chartFilter.label}</span>
                    <button type="button" onclick="clearChartFilter()" 
                        class="flex h-5 w-5 items-center justify-center rounded text-blue-600 hover:bg-blue-100 hover:text-blue-800"
                        aria-label="Remove">
                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                `;

                // Add as first badge
                badgesContainer.insertBefore(badge, badgesContainer.firstChild);
            }
        }

        // Apply filters with chart filter included
        function applyFiltersWithChartFilter() {
            const startTime = performance.now();

            // Get advanced filter values (excluding Region, Status, and Commitment Status which are in smart filters)
            const filters = {
                productProgram: document.getElementById("filterProductProgram").value,
                extendingUnit: document.getElementById("filterExtendingUnit").value,
                facilityType: document.getElementById("filterFacilityType").value,
                teamLead: document.getElementById("filterTeamLead").value,
                underwriter: document.getElementById("filterUnderwriter").value,
                caMaturity: document.getElementById("filterCAMaturity").value,
                facilityMaturity: document.getElementById("filterFacilityMaturity")
                    .value,
            };

            // Update active filters object (including Region, Status, and Commitment Status smart filters)
            activeFilters = {};
            
            // Add smart filters to activeFilters
            if (selectedRegion !== 'all')
                activeFilters["Region"] = selectedRegion;
            if (selectedStatus !== 'all')
                activeFilters["Status"] = selectedStatus;
            if (selectedCommitmentStatus !== 'all')
                activeFilters["Commitment Status"] = selectedCommitmentStatus;
            if (!includePSE)
                activeFilters["PSE"] = "Excluded";
            
            if (filters.productProgram)
                activeFilters["Product Program"] = filters.productProgram;
            if (filters.extendingUnit)
                activeFilters["Extending Unit"] = filters.extendingUnit;
            if (filters.facilityType)
                activeFilters["Facility Type"] = filters.facilityType;
            if (filters.teamLead) activeFilters["Team Lead"] = filters.teamLead;
            if (filters.underwriter)
                activeFilters["Underwriter"] = filters.underwriter;
            if (filters.caMaturity) {
                const days = filters.caMaturity;
                activeFilters["CAs Maturing"] =
                    days === "30"
                        ? "Next 30 Days"
                        : days === "60"
                            ? "Next 60 Days"
                            : days === "90"
                                ? "Next 90 Days"
                                : days === "180"
                                    ? "Next 6 Months"
                                    : "Next Year";
            }
            if (filters.facilityMaturity) {
                const days = filters.facilityMaturity;
                activeFilters["Facilities Maturing"] =
                    days === "30"
                        ? "Next 30 Days"
                        : days === "60"
                            ? "Next 60 Days"
                            : days === "90"
                                ? "Next 90 Days"
                                : days === "180"
                                    ? "Next 6 Months"
                                    : "Next Year";
            }

            // Display filter badges and update count
            displayFilterBadges();
            updateFilterCount();

            // Pre-calculate date ranges for date filters (avoid recalculating in loop)
            let caDateRange = null;
            let facilityDateRange = null;
            if (filters.caMaturity) {
                const today = new Date();
                const futureDate = new Date(
                    today.getTime() + parseInt(filters.caMaturity) * 24 * 60 * 60 * 1000
                );
                caDateRange = { today, futureDate };
            }
            if (filters.facilityMaturity) {
                const today = new Date();
                const futureDate = new Date(
                    today.getTime() +
                    parseInt(filters.facilityMaturity) * 24 * 60 * 60 * 1000
                );
                facilityDateRange = { today, futureDate };
            }

            const searchTerm = document
                .getElementById("searchInput")
                .value.toLowerCase();

            // OPTIMIZED filtering: Use early exits and minimal object access
            filteredData = [];
            for (let i = 0; i < portfolioData.length; i++) {
                const row = portfolioData[i];

                // Apply chart filter first
                if (chartFilter.active) {
                    let passChartFilter = false;

                    switch (chartFilter.type) {
                        case "relationship":
                            const relName = row.Relationship_Name || row.Relationship_ID;
                            // Remove index number (e.g., "1. ABC Bank" -> "ABC Bank")
                            const cleanValue = chartFilter.value.replace(/^\d+\.\s*/, "");
                            passChartFilter = relName === cleanValue;
                            break;
                        case "product":
                            passChartFilter = row.Product_Program === chartFilter.value;
                            break;
                        case "facilityType":
                            passChartFilter = row.Facility_Type === chartFilter.value;
                            break;
                    }

                    if (!passChartFilter) continue;
                }

                // Smart Filters (apply after chart filter for performance)
                // Region filter (case-insensitive comparison)
                if (selectedRegion !== "all") {
                    const rowRegion = (row.Region || "").toUpperCase();
                    if (rowRegion !== selectedRegion.toUpperCase()) continue;
                }

                // PSE filter (exclude PSE if includePSE is false)
                // Use PSE_non-PSE column from data (values: "PSE" or "non-PSE")
                if (!includePSE) {
                    const pseColumn = row["PSE_non-PSE"] || row.PSE_non_PSE || "";
                    const pseValue = String(pseColumn).trim().toUpperCase();
                    // Skip rows where value is exactly "PSE" (not "non-PSE")
                    if (pseValue === "PSE") continue;
                }

                // Management Status filter (CM/DM) - case-insensitive comparison
                if (selectedStatus !== "all") {
                    const rowStatus = (row.Management_Status || "").toUpperCase();
                    if (rowStatus !== selectedStatus.toUpperCase()) continue;
                }

                // Commitment Status filter (Committed/Uncommitted)
                if (selectedCommitmentStatus !== "all") {
                    const rowCommitment = row["Committed/Uncommitted"] || "";
                    if (rowCommitment !== selectedCommitmentStatus) continue;
                }

                // Fast path: Check advanced filter string filters (fastest to fail)
                if (
                    filters.productProgram &&
                    row.Product_Program !== filters.productProgram
                )
                    continue;
                if (
                    filters.extendingUnit &&
                    row.Control_Unit !== filters.extendingUnit
                )
                    continue;
                if (
                    filters.facilityType &&
                    row.Facility_Type !== filters.facilityType
                )
                    continue;
                if (
                    filters.teamLead &&
                    row.Underwriting_Team_Lead !== filters.teamLead
                )
                    continue;
                if (
                    filters.underwriter &&
                    row.Lead_Underwriter !== filters.underwriter
                )
                    continue;

                // Date filters (use pre-parsed dates from index)
                if (caDateRange) {
                    const caDate = indexCache.dates[i].caDate;
                    if (
                        !caDate ||
                        caDate < caDateRange.today ||
                        caDate > caDateRange.futureDate
                    )
                        continue;
                }

                if (facilityDateRange) {
                    const maturityDate = indexCache.dates[i].maturityDate;
                    if (
                        !maturityDate ||
                        maturityDate < facilityDateRange.today ||
                        maturityDate > facilityDateRange.futureDate
                    )
                        continue;
                }

                // Search filter (most expensive, do last)
                if (searchTerm) {
                    let found = false;
                    for (const value of Object.values(row)) {
                        if (String(value).toLowerCase().includes(searchTerm)) {
                            found = true;
                            break;
                        }
                    }
                    if (!found) continue;
                }

                // All filters passed
                filteredData.push(row);
            }

            console.log(
                `Filtered ${portfolioData.length} to ${filteredData.length
                } rows (with chart filter) in ${(
                    performance.now() - startTime
                ).toFixed(2)}ms`
            );

            // Recalculate metrics and charts with filtered data (async to prevent blocking)
            requestAnimationFrame(() => {
                calculateMetricsFromFiltered();
                createExpirationChartFromFiltered();
                createFacilityTrendChartFromFiltered();
                createRelationshipChartFromFiltered();
                createCreditClassificationChartFromFiltered();
                createROTCEChartFromFiltered();
                
                // Update covenant and CCM charts with region filter
                populateCovenantMonitoringData();
                createCovenantMonitoringChart('pastDue');
                updateCovenantRegionalTable('pastDue');
                calculateCCMStats();
                createCCMRegionalChart();
            });
            
            // Reset to first page and render table immediately
            currentPage = 1;
            renderTable();
        }

        // Display filter badges
        function displayFilterBadges() {
            const badgesContainer = document.getElementById("activeFiltersBadges");
            
            if (badgesContainer) badgesContainer.innerHTML = "";
            
            if (Object.keys(activeFilters).length === 0) {
                if (badgesContainer) badgesContainer.style.display = "none";
                return;
            }
            
            if (badgesContainer) badgesContainer.style.display = "flex";
            
            Object.entries(activeFilters).forEach(([label, value]) => {
                // Create badge for Portfolio Overview
                if (badgesContainer) {
                    const badge = document.createElement("span");
                    badge.className =
                        "inline-flex items-center bg-white text-sm text-gray-600 border border-gray-300 rounded-lg gap-x-2 py-1.5 pl-3 pr-1";
                    badge.innerHTML = `
                        <span class="text-gray-600">${label}</span>
                        <span class="h-4 w-px bg-gray-300"></span>
                        <span class="font-medium text-gray-800">${value}</span>
                        <button type="button" onclick="removeFilter('${label}')" 
                            class="flex h-5 w-5 items-center justify-center rounded text-gray-500 hover:bg-gray-100 hover:text-gray-700"
                            aria-label="Remove">
                            <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    `;
                    badgesContainer.appendChild(badge);
                }
            });
        }

        // Remove a specific filter
        function removeFilter(label) {
            // Handle smart filters first
            if (label === "Region") {
                selectRegionFilter('all');
                return;
            }
            
            if (label === "Status") {
                selectStatusFilter('all');
                return;
            }
            
            if (label === "Commitment Status") {
                selectCommitmentFilter('all');
                return;
            }
            
            if (label === "PSE") {
                // Toggle PSE back to include
                includePSE = true;
                const pseToggle = document.getElementById('pseToggle');
                if (pseToggle) {
                    pseToggle.checked = true;
                    // Trigger the change event to update Alpine.js state
                    pseToggle.dispatchEvent(new Event('change'));
                }
                updateFilterCount();
                applyFilters();
                return;
            }
            
            // Handle advanced filters
            const filterMap = {
                "Product Program": "filterProductProgram",
                "Extending Unit": "filterExtendingUnit",
                "Facility Type": "filterFacilityType",
                "Team Lead": "filterTeamLead",
                Underwriter: "filterUnderwriter",
                "CAs Maturing": "filterCAMaturity",
                "Facilities Maturing": "filterFacilityMaturity",
            };
            
            const selectId = filterMap[label];
            if (selectId) {
                const element = document.getElementById(selectId);
                if (element) {
                    element.value = "";
                }
                applyFilters();
            }
        }

        // Clear all filters
        function clearAllFilters() {
            // Clear only advanced filter fields (Region and Status are managed by smart filters)
            document.getElementById("filterProductProgram").value = "";
            document.getElementById("filterExtendingUnit").value = "";
            document.getElementById("filterFacilityType").value = "";
            document.getElementById("filterCommitment").value = "";
            document.getElementById("filterTeamLead").value = "";
            document.getElementById("filterUnderwriter").value = "";
            document.getElementById("filterCAMaturity").value = "";
            document.getElementById("filterFacilityMaturity").value = "";
            
            activeFilters = {};
            applyFilters();
            updateFilterCount();
        }

        // Store temporary filter state when opening popover
        let tempFilterState = {};

        // Toggle filter popover
        function toggleFilterPopover() {
            const popover = document.getElementById("filterPopover");
            if (popover.classList.contains("hidden")) {
                // Opening popover - save current filter state (excluding smart filters)
                tempFilterState = {
                    productProgram: document.getElementById("filterProductProgram")
                        .value,
                    extendingUnit: document.getElementById("filterExtendingUnit").value,
                    facilityType: document.getElementById("filterFacilityType").value,
                    commitment: document.getElementById("filterCommitment").value,
                    teamLead: document.getElementById("filterTeamLead").value,
                    underwriter: document.getElementById("filterUnderwriter").value,
                    caMaturity: document.getElementById("filterCAMaturity").value,
                    facilityMaturity: document.getElementById("filterFacilityMaturity")
                        .value,
                };

                popover.classList.remove("hidden");
                document.body.style.overflow = "hidden"; // Prevent background scrolling
            } else {
                // Closing popover - restore previous filter state (cancel changes)
                document.getElementById("filterProductProgram").value =
                    tempFilterState.productProgram || "";
                document.getElementById("filterExtendingUnit").value =
                    tempFilterState.extendingUnit || "";
                document.getElementById("filterFacilityType").value =
                    tempFilterState.facilityType || "";
                document.getElementById("filterCommitment").value =
                    tempFilterState.commitment || "";
                document.getElementById("filterTeamLead").value =
                    tempFilterState.teamLead || "";
                document.getElementById("filterUnderwriter").value =
                    tempFilterState.underwriter || "";
                document.getElementById("filterCAMaturity").value =
                    tempFilterState.caMaturity || "";
                document.getElementById("filterFacilityMaturity").value =
                    tempFilterState.facilityMaturity || "";

                popover.classList.add("hidden");
                document.body.style.overflow = ""; // Restore scrolling
            }
        }

        // Apply filters and close popover
        function applyFiltersAndClose() {
            applyFilters();
            // Close popover without restoring state (we're applying changes)
            const popover = document.getElementById("filterPopover");
            popover.classList.add("hidden");
            document.body.style.overflow = "";
        }

        // Update filter count badge
        function updateFilterCount() {
            // Count all filters (smart filters are already included in activeFilters)
            let count = Object.keys(activeFilters).length;
            
            const badge = document.getElementById("filterCount");
            
            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove("hidden");
            } else {
                badge.classList.add("hidden");
            }
        }

        // Calculate metrics from filtered data (OPTIMIZED)
        function calculateMetricsFromFiltered() {
            const startTime = performance.now();
            
            let totalFacAmount = 0;
            let totalOSUC = 0;
            let totalOutstanding = 0;
            const relationships = new Set();
            const facilities = new Set();
            
            // Single pass through filtered data
            for (let i = 0; i < filteredData.length; i++) {
                const row = filteredData[i];
                
                totalFacAmount += parseNumber(row.Fac_Amount);
                totalOSUC += parseNumber(row.OSUC);
                
                // Total Outstanding from Total_OS column
                totalOutstanding += parseNumber(row.Total_OS);
                
                // Use Relationship_ID for unique count (not Relationship_Name which may have duplicates)
                if (row.Relationship_ID) relationships.add(row.Relationship_ID);
                
                if (row.Facility_ID) facilities.add(row.Facility_ID);
            }
            
            document.getElementById("totalRelationships").textContent =
                relationships.size.toLocaleString();
            document.getElementById("totalFacilities").textContent =
                facilities.size.toLocaleString();
            document.getElementById("totalOSUC").textContent =
                formatCurrency(totalOSUC);
            document.getElementById("totalFacAmount").textContent =
                formatCurrency(totalFacAmount);
            document.getElementById("totalOutstanding").textContent =
                formatCurrency(totalOutstanding);

            console.log(
                `Filtered metrics calculated in ${(
                    performance.now() - startTime
                ).toFixed(2)}ms`
            );
            
            // Calculate expired metrics from filtered data
            calculateExpiredMetricsFromFiltered();
            
            // Calculate new deals YTD/MTD metrics from filtered data
            calculateNewDealsMetricsFromFiltered();

            // Populate pipeline deals table from filtered data
            populatePipelineTable();

            // Populate Covenant Monitoring data and chart
            populateCovenantMonitoringData();
            createCovenantMonitoringChart('pastDue');
            updateCovenantRegionalTable('pastDue');
            
            // Calculate and display CCM stats
            calculateCCMStats();
            createCCMRegionalChart();
            updateCCMStats('pastDue');
        }

        // Calculate Facilities Expired and CAs Expired metrics from filtered data
        function calculateExpiredMetricsFromFiltered() {
            // Get the current report month
            const reportDates = filteredData
                .map((row) => parseDate(row.Report_Date))
                .filter((d) => d);
            if (reportDates.length === 0) return;
            
            const maxReportDate = new Date(Math.max(...reportDates));
            const currentYear = maxReportDate.getFullYear();
            const currentMonth = maxReportDate.getMonth();
            
            // Calculate start and end of current month
            const monthStart = new Date(currentYear, currentMonth, 1);
            monthStart.setHours(0, 0, 0, 0);
            const monthEnd = new Date(currentYear, currentMonth + 1, 0);
            monthEnd.setHours(23, 59, 59, 999);
            
            // Count expired facilities and CAs in current month only
            const expiredFacilities = new Set(); // Track unique Facility IDs
            let facilitiesExpiredAmount = 0;
            const expiredCAs = new Set();
            const expiredCAsEMEAByRelationship = new Set(); // For EMEA: track unique Relationship_IDs
            let casExpiredAmount = 0;
            
            for (let i = 0; i < filteredData.length; i++) {
                const row = filteredData[i];
                const managementStatus = (row.Management_Status || "").toUpperCase();
                
                // Check Facilities Expired (count unique Facility IDs, exclude DM)
                const maturityDate = parseDate(row.Maturity_Date);
                if (
                    maturityDate &&
                    maturityDate >= monthStart &&
                    maturityDate <= monthEnd &&
                    maturityDate < maxReportDate &&
                    row.Facility_ID &&
                    managementStatus !== "DM"
                ) {
                    expiredFacilities.add(row.Facility_ID);
                    facilitiesExpiredAmount += parseNumber(
                        row.Fac_Amount || row.Facility_Amount
                    );
                }
                
                // Check CAs Expired (count unique CAIDs for non-EMEA, unique Relationship_IDs for EMEA, but sum ALL lines, exclude DM)
                const caExpirationDate = parseDate(row.CA_Expiration_Date);
                const region = (row.Region || "").toUpperCase();
                
                if (
                    caExpirationDate &&
                    caExpirationDate >= monthStart &&
                    caExpirationDate <= monthEnd &&
                    caExpirationDate < maxReportDate &&
                    managementStatus !== "DM"
                ) {
                    // For EMEA: count unique Relationship_IDs instead of CAIDs
                    if (region === "EMEA" && row.Relationship_ID) {
                        expiredCAsEMEAByRelationship.add(row.Relationship_ID);
                    } else if (row.CAID) {
                        // For non-EMEA: count unique CAIDs
                        expiredCAs.add(row.CAID);
                    }
                    
                    casExpiredAmount += parseNumber(
                        row.Fac_Amount || row.Facility_Amount
                    );
                }
            }
            
            // Combine counts: non-EMEA CAIDs + EMEA Relationship_IDs
            const casExpiredCount = expiredCAs.size + expiredCAsEMEAByRelationship.size;
            const facilitiesExpiredCount = expiredFacilities.size;
            
            // Update DOM
            document.getElementById("facilitiesExpiredCount").textContent =
                facilitiesExpiredCount.toLocaleString();
            document.getElementById("casExpiredCount").textContent =
                casExpiredCount.toLocaleString();
        }

        // Create expiration chart from filtered data
        function createExpirationChartFromFiltered() {
            console.log(
                " Creating filtered facilities expired & expiring bar chart"
            );
            
            // Get the current reporting month from the data
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Generate next 3 months starting from current month
            const next3Months = [];
            for (let i = 0; i < 3; i++) {
                const date = new Date(today);
                date.setMonth(date.getMonth() + i);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, "0");
                next3Months.push(`${year}-${month}`);
            }
            
            // Group by month-year and categorize as expired or expiring
            const monthlyData = {};
            
            // Initialize all 3 months
            next3Months.forEach((monthYear) => {
                monthlyData[monthYear] = {
                    expired: [],
                    expiring: [],
                };
            });
            
            filteredData.forEach((row) => {
                const maturityDate = row.Maturity_Date;
                const facilityId = row.Facility_ID;
                
                if (maturityDate && facilityId) {
                    const dateObj = parseDate(maturityDate);
                    if (dateObj) {
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthYear = `${year}-${month}`;
                        
                        // Only include if it's in our next 3 months
                        if (next3Months.includes(monthYear)) {
                            // Categorize based on whether date is past or future
                            if (dateObj < today) {
                                monthlyData[monthYear].expired.push(facilityId);
                            } else {
                                monthlyData[monthYear].expiring.push(facilityId);
                            }
                        }
                    }
                }
            });
            
            // Prepare data for the next 3 months
            const categories = next3Months.map((m) => {
                const date = new Date(m + "-01");
                return date.toLocaleDateString("en-US", { month: "short" });
            });

            const expiredData = next3Months.map(
                (month) => monthlyData[month].expired.length
            );
            const expiringData = next3Months.map(
                (month) => monthlyData[month].expiring.length
            );
            
            const options = {
                series: [
                    {
                        name: "Expired",
                        data: expiredData,
                    },
                    {
                        name: "Expiring",
                        data: expiringData,
                    },
                ],
                colors: ["#93a8ff", "#465fff"],
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "bar",
                    stacked: false,
                    height: "100%",
                    toolbar: {
                        show: false,
                    },
                    zoom: {
                        enabled: false,
                    },
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: "55%",
                        borderRadius: 8,
                        borderRadiusApplication: "end",
                        dataLabels: {
                            position: 'top',
                        },
                    },
                },
                dataLabels: {
                    enabled: true,
                    offsetY: -30,
                    style: {
                        fontSize: '11px',
                        fontWeight: 500,
                        colors: ['#374151']
                    },
                    background: {
                        enabled: true,
                        foreColor: '#374151',
                        backgroundColor: '#F3F4F6',
                        borderRadius: 12,
                        padding: 8,
                        opacity: 1,
                        borderWidth: 0
                    },
                    formatter: function(val, opts) {
                        return val;
                    }
                },
                xaxis: {
                    categories: categories,
                    axisBorder: {
                        show: false,
                    },
                    axisTicks: {
                        show: false,
                    },
                    labels: {
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                },
                legend: {
                    show: true,
                    position: "top",
                    horizontalAlign: "left",
                    fontFamily: "Outfit, sans-serif",
                    fontSize: "12px",
                    markers: {
                        size: 5,
                        shape: "circle",
                        radius: 999,
                        strokeWidth: 0,
                    },
                    itemMargin: {
                        horizontal: 10,
                        vertical: 0,
                    },
                },
                yaxis: {
                    title: false,
                    labels: {
                        align: 'left',
                        offsetX: -10,
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                },
                grid: {
                    xaxis: {
                        lines: {
                            show: true,
                        },
                    },
                    yaxis: {
                        lines: {
                            show: false,
                        },
                    },
                },
                fill: {
                    opacity: 1,
                },
                tooltip: {
                    theme: "light",
                    style: {
                        fontSize: "12px",
                        fontFamily: "Outfit, sans-serif",
                    },
                    x: {
                        show: false,
                    },
                    y: {
                        formatter: function (val) {
                            return val + " facilities";
                        },
                    },
                },
            };

            const chartElement = document.querySelector("#facilityMaturityChart");
            if (!chartElement) {
                console.error("Facility maturity chart element not found");
                return;
            }
            
            if (typeof ApexCharts === "undefined") {
                console.error("ApexCharts library not loaded");
                return;
            }
            
            try {
                if (facilityMaturityChartInstance) {
                    facilityMaturityChartInstance.destroy();
                    facilityMaturityChartInstance = null;
                }
                
                chartElement.innerHTML = "";
                
                facilityMaturityChartInstance = new ApexCharts(chartElement, options);
                facilityMaturityChartInstance.render();
                console.log(
                    " Filtered facility maturity chart rendered successfully"
                );
            } catch (error) {
                console.error(
                    " Error rendering filtered facility maturity chart:",
                    error
                );
            }
        }

        // Create relationship chart from filtered data (OPTIMIZED)
        function createRelationshipChartFromFiltered() {
            const startTime = performance.now();
            const topN = parseInt(document.getElementById("topNFilter").value);
            
            // Use amount type based on filter selection
            let fieldName, seriesName;
            switch (selectedAmountType) {
                case "direct":
                    fieldName = "Direct_OS";
                    seriesName = "Direct OS";
                    break;
                case "contingent":
                    fieldName = "Contingent_OS";
                    seriesName = "Contingent OS";
                    break;
                case "pse":
                    fieldName = "PSE_OS";
                    seriesName = "PSE OS";
                    break;
                case "osuc":
                    fieldName = "OSUC";
                    seriesName = "OSUC";
                    break;
                case "unused":
                    fieldName = "Unused_Committed";
                    seriesName = "Undrawn Commitment";
                    break;
                case "tfa":
                    fieldName = "Fac_Amount";
                    seriesName = "Total Facility Amount";
                    break;
                default:
                    fieldName = "Direct_OS";
                    seriesName = "Direct OS";
            }

            console.log(
                "Creating filtered relationship chart, field:",
                fieldName,
                "dataLength:",
                filteredData.length
            );
            
            // Use Map for better performance - store all exposure types
            const relationshipData = new Map();

            // Debug: Sample a few rows to see what we're working with
            if (filteredData.length > 0 && selectedAmountType === "tfa") {
                console.log("DEBUG - Sample first 3 rows of filteredData:");
                for (let i = 0; i < Math.min(3, filteredData.length); i++) {
                    console.log(`Row ${i}:`, {
                        Relationship_Name: filteredData[i].Relationship_Name,
                        Fac_Amount: filteredData[i].Fac_Amount,
                        Facility_Amount: filteredData[i].Facility_Amount,
                        TFA_field_used: filteredData[i].Fac_Amount || filteredData[i].Facility_Amount,
                        TFA_parsed: parseNumber(filteredData[i].Fac_Amount || filteredData[i].Facility_Amount),
                        Direct_OS: filteredData[i].Direct_OS,
                        Direct_OS_parsed: parseNumber(filteredData[i].Direct_OS)
                    });
                }

                // Count how many rows have non-zero TFA
                let nonZeroCount = 0;
                let totalFacilityAmount = 0;
                for (let i = 0; i < filteredData.length; i++) {
                    const val = parseNumber(filteredData[i].Fac_Amount || filteredData[i].Facility_Amount);
                    if (val > 0) {
                        nonZeroCount++;
                        totalFacilityAmount += val;
                    }
                }
                console.log(`DEBUG - ${nonZeroCount} out of ${filteredData.length} rows have non-zero TFA`);
                console.log(`DEBUG - Total TFA across all rows: ${formatCurrency(totalFacilityAmount)}`);
            }
            
            for (let i = 0; i < filteredData.length; i++) {
                const row = filteredData[i];
                const relId = row.Relationship_Name || row.Relationship_ID;
                
                if (relId) {
                    if (!relationshipData.has(relId)) {
                        relationshipData.set(relId, {
                            tfa: 0,
                            direct: 0,
                            contingent: 0,
                            pse: 0,
                            osuc: 0,
                            unused: 0,
                            facilityCount: 0,
                        });
                    }
                    
                    const data = relationshipData.get(relId);
                    data.tfa += parseNumber(row.Fac_Amount || row.Facility_Amount);
                    data.direct += parseNumber(row.Direct_OS);
                    data.contingent += parseNumber(row.Contingent_OS);
                    data.pse += parseNumber(row.PSE_OS);
                    data.osuc += parseNumber(row.OSUC);
                    data.unused += parseNumber(row.Unused_Committed);
                    if (row.Facility_ID) data.facilityCount++;
                }
            }
            
            console.log(
                "Total unique filtered relationships:",
                relationshipData.size
            );
            
            // Get the selected field value for sorting
            const relationshipTotals = new Map();
            for (const [relId, data] of relationshipData.entries()) {
                let sortValue = 0;
                switch (selectedAmountType) {
                    case "tfa":
                        sortValue = data.tfa;
                        break;
                    case "direct":
                        sortValue = data.direct;
                        break;
                    case "contingent":
                        sortValue = data.contingent;
                        break;
                    case "pse":
                        sortValue = data.pse;
                        break;
                    case "osuc":
                        sortValue = data.osuc;
                        break;
                    case "unused":
                        sortValue = data.unused;
                        break;
                    default:
                        sortValue = data.direct;
                }
                relationshipTotals.set(relId, sortValue);
            }
            
            // Convert to array and sort
            const sorted = Array.from(relationshipTotals.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, topN);
            
            console.log(
                `Filtered chart aggregated ${filteredData.length} rows, found ${relationshipData.size
                } relationships in ${(performance.now() - startTime).toFixed(2)}ms`
            );
            
            // Add index numbers (1, 2, 3, ...) before relationship names
            const relationships = sorted.map(
                (item, index) => `${index + 1}. ${item[0]}`
            );
            const amounts = sorted.map((item) => item[1]);

            // Debug logging for TFA
            console.log("DEBUG - selectedAmountType:", selectedAmountType);
            console.log("DEBUG - seriesName:", seriesName);
            console.log("DEBUG - relationships:", relationships);
            console.log("DEBUG - amounts:", amounts);
            console.log("DEBUG - sorted array:", sorted);
            
            // Handle empty data
            if (relationships.length === 0) {
                console.warn("No filtered relationship data for chart");
                const chartElement = document.querySelector("#relationshipChart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('Top Relationships');
                }
                return;
            }

            // Check if all amounts are zero
            const totalAmount = amounts.reduce((sum, val) => sum + val, 0);
            if (totalAmount === 0) {
                console.warn(" All amounts are zero for selectedAmountType:", selectedAmountType);
                const chartElement = document.querySelector("#relationshipChart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('Top Relationships');
                }
                return;
            }

            // Calculate dynamic height based on number of relationships (35px per bar, min 350px)
            const calculatedHeight = Math.max(350, relationships.length * 35);
            
            const options = {
                series: [
                    {
                    name: seriesName,
                        data: amounts,
                    },
                ],
                colors: ["#465fff"],
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "bar",
                    height: calculatedHeight,
                    toolbar: {
                        show: false,
                    },
                    events: {
                        dataPointSelection: function (event, chartContext, config) {
                            const selectedIndex = config.dataPointIndex;
                            const selectedRelationship = relationships[selectedIndex];
                            console.log("Relationship clicked:", selectedRelationship);
                            applyChartFilter(
                                "relationship",
                                selectedRelationship,
                                selectedRelationship
                            );
                        },
                    },
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        borderRadius: 5,
                        borderRadiusApplication: "end",
                        dataLabels: {
                            position: 'top',
                        },
                    },
                },
                dataLabels: {
                    enabled: true,
                    textAnchor: 'start',
                    offsetX: 30,
                    style: {
                        fontSize: '11px',
                        fontWeight: 500,
                        colors: ['#374151']
                    },
                    background: {
                        enabled: true,
                        foreColor: '#374151',
                        backgroundColor: '#F3F4F6',
                        borderRadius: 12,
                        padding: 8,
                        opacity: 1,
                        borderWidth: 0
                    },
                    formatter: function(val) {
                        return formatCurrency(val);
                    }
                },
                stroke: {
                    show: true,
                    width: 4,
                    colors: ["transparent"],
                },
                xaxis: {
                    categories: relationships,
                    labels: {
                        formatter: function (val) {
                            return formatCurrency(val);
                        },
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                    axisBorder: {
                        show: false,
                    },
                    axisTicks: {
                        show: false,
                    },
                },
                yaxis: {
                    title: false,
                    labels: {
                        align: 'left',
                        offsetX: -10,
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                },
                legend: {
                    show: true,
                    position: "top",
                    horizontalAlign: "left",
                    fontFamily: "Outfit, sans-serif",
                    fontSize: "12px",
                    markers: {
                        radius: 99,
                    },
                },
                grid: {
                    xaxis: {
                        lines: {
                            show: true,
                        },
                    },
                    yaxis: {
                        lines: {
                            show: false,
                        },
                    },
                },
                fill: {
                    opacity: 1,
                },
                tooltip: {
                    theme: "light",
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        const relName = sorted[dataPointIndex][0]; // Get original name without index
                        const data = relationshipData.get(relName);
                        
                        if (!data) return "";
                        
                        let html = `<div class="apexcharts-tooltip-custom" style="padding: 12px; min-width: 220px; background: #ffffff; color: #1f2937; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border: 1px solid #e5e7eb;">`;
                        html += `<div style="font-weight: 600; margin-bottom: 8px; font-size: 13px; color: #1f2937;">${relName}</div>`;
                        html += `<div style="font-size: 11px; color: #666;">`;
                        html += `<div style="margin-bottom: 4px;"><strong>${data.facilityCount}</strong> Facilities</div>`;
                        html += `<div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #e5e7eb;">`;
                        html += `<div>TFA: ${formatCurrency(data.tfa)}</div>`;
                        html += `<div>Direct: ${formatCurrency(data.direct)}</div>`;
                        if (data.contingent > 0) {
                            html += `<div>Contingent: ${formatCurrency(
                                data.contingent
                            )}</div>`;
                        }
                        if (data.pse > 0) {
                            html += `<div>Presettlement Exposure: ${formatCurrency(
                                data.pse
                            )}</div>`;
                        }
                        html += `</div></div></div>`;
                        return html;
                    },
                },
            };

            // Get the chart element and verify it exists
                const chartElement = document.querySelector("#relationshipChart");
                if (!chartElement) {
                console.error(
                    "Filtered relationship chart element #relationshipChart not found in DOM"
                );
                    return;
                }
                
            // Verify ApexCharts is loaded
            if (typeof ApexCharts === "undefined") {
                console.error("ApexCharts library not loaded");
                return;
            }
            
            try {
                // Destroy previous instance
                if (relationshipChartInstance) {
                    relationshipChartInstance.destroy();
                    relationshipChartInstance = null;
                }
                
                // Clear any previous content to avoid ApexCharts errors
                chartElement.innerHTML = "";

                // Log chart options for debugging
                console.log("DEBUG - Chart options series:", options.series);
                console.log("DEBUG - Chart options xaxis categories:", options.xaxis.categories);
                
                // Create and render new chart
                relationshipChartInstance = new ApexCharts(chartElement, options);
                relationshipChartInstance.render();
                console.log(
                    " Filtered relationship chart rendered successfully with",
                    relationships.length,
                    "relationships"
                );
            } catch (error) {
                console.error(
                    " Error creating filtered relationship chart:",
                    error
                );
                console.error("Error details:", error.message, error.stack);
            }
        }

        // Smart Filter Functions
        
        // Flag to prevent multiple filter applications during batch operations
        let isResettingFilters = false;
        
        // Select Region Filter (optimized)
        function selectRegionFilter(region) {
            selectedRegion = region;
            
            // Update button styles using helper
            updateRegionButtonsUI(region);
            
            // Only apply filters if not in batch reset mode
            if (!isResettingFilters) {
            updateFilterCount();
            applyFilters();
            }
        }
        
        // Toggle PSE (Include/Exclude) - optimized
        function togglePSE(include) {
            includePSE = include;
            console.log("PSE filter:", includePSE ? "Include" : "Exclude");
            
            // Only apply filters if not in batch reset mode
            if (!isResettingFilters) {
            updateFilterCount();
            applyFilters();
            }
        }
        
        // Select Status Filter (CM/DM) - optimized
        function selectStatusFilter(status) {
            selectedStatus = status;
            
            // Update button styles using helper
            updateStatusButtonsUI(status);
            
            // Only apply filters if not in batch reset mode
            if (!isResettingFilters) {
            updateFilterCount();
            applyFilters();
            }
        }
        
        // Select Commitment Status Filter (Committed/Uncommitted) - optimized
        function selectCommitmentFilter(commitment) {
            selectedCommitmentStatus = commitment;
            
            // Update button styles using helper
            updateCommitmentButtonsUI(commitment);
            
            // Only apply filters if not in batch reset mode
            if (!isResettingFilters) {
            updateFilterCount();
            applyFilters();
            }
        }
        
        // Select Amount Type Filter (Direct/Contingent/PSE/OSUC/Unused/TFA) - optimized
        function selectAmountTypeFilter(type) {
            selectedAmountType = type;
            
            // Update button styles using helper
            updateAmountTypeButtonsUI(type);
            
            // Update chart titles
            updateAmountTypeTitles(type);
            
            // Update Alpine.js dropdown state if it exists
            const exposureDropdown = document.querySelector('[x-data*="openExposure"]');
            if (exposureDropdown && exposureDropdown.__x) {
                exposureDropdown.__x.$data.exposureType = type;
            }

            console.log("Amount Type filter:", type);
            
            // Only refresh charts if not in batch reset mode
            if (!isResettingFilters) {
                // Refresh the Top Relationships chart and ROTCE chart (both tabs should sync)
            if (areFiltersActive()) {
                createRelationshipChartFromFiltered();
                createROTCEChartFromFiltered();
            } else {
                createRelationshipChart();
                createROTCEChart();
            }
        }
        }
        
        // Helper: Update amount type chart titles
        function updateAmountTypeTitles(type) {
            const titleElement = document.getElementById("topRelationshipsTitle");
            const subtitleElement = document.getElementById("topRelationshipsSubtitle");
            
            const exposureNames = {
                direct: "Direct OS",
                contingent: "Contingent OS",
                pse: "Presettlement Exposure",
                osuc: "OSUC",
                unused: "Undrawn Commitment",
                tfa: "Total Facility Amount"
            };
            
            const exposureName = exposureNames[type] || exposureNames.direct;
            
            if (titleElement) titleElement.textContent = "Top Relationships";
            if (subtitleElement) subtitleElement.textContent = `Top relationships by exposure type - ${exposureName}`;
        }
        
        // Reset All Filters (OPTIMIZED - batch UI updates, single filter application)
        function resetAllFilters() {
            console.log(' Resetting all filters...');
            const startTime = performance.now();
            
            // Set flag to prevent intermediate filter applications
            isResettingFilters = true;
            
            // Reset smart filters to default values (no UI updates yet)
            selectedRegion = "all";
            includePSE = true;
            selectedStatus = "all";
            selectedCommitmentStatus = "all";
            selectedAmountType = "direct";
            
            // Batch UI updates using requestAnimationFrame for smooth rendering
            requestAnimationFrame(() => {
                // Reset PSE toggle checkbox
            const pseToggle = document.getElementById("pseToggle");
            if (pseToggle) {
                pseToggle.checked = true;
            }
            
                // Reset region buttons UI (both tabs) - UI only, no filter application
                updateRegionButtonsUI("all");
            
                // Reset status buttons UI (both tabs) - UI only
                updateStatusButtonsUI("all");
            
                // Reset commitment status buttons UI - UI only
                updateCommitmentButtonsUI("all");
            
                // Reset amount type buttons UI - UI only
                updateAmountTypeButtonsUI("direct");
            
            // Reset search
            const searchInput = document.getElementById("searchInput");
            if (searchInput) {
                searchInput.value = "";
            }
            
                // Reset advanced filter dropdowns in single loop
            const filterIds = [
                    "filterProductProgram", "filterExtendingUnit", "filterFacilityType",
                    "filterCommitment", "filterTeamLead", "filterUnderwriter",
                    "filterCAMaturity", "filterFacilityMaturity"
            ];
            filterIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = "";
            });
            
            // Clear active filters object
            activeFilters = {};
            displayFilterBadges();
            updateFilterCount();
            
                // Clear flag and apply filters ONCE
                isResettingFilters = false;
                
                // Use setTimeout to allow UI to update before heavy processing
                setTimeout(() => {
                    applyFilters();
                    const elapsed = (performance.now() - startTime).toFixed(0);
                    console.log(` All filters reset in ${elapsed}ms`);
            showNotification("Success", "All filters have been reset", "success");
                }, 10);
            });
        }
        
        // Helper: Update region buttons UI only (no filter application) - Portfolio Overview only
        function updateRegionButtonsUI(region) {
            const regions = ["All", "APAC", "EMEA", "LATAM", "NAM"];
            regions.forEach((r) => {
                const minWidth = r === "LATAM" ? "min-w-[60px]" : "min-w-[50px]";
                const activeClass = `${minWidth} px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white`;
                const inactiveClass = `${minWidth} px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900`;
                const isActive = r.toLowerCase() === region.toLowerCase();
                
                const btn = document.getElementById(`btnRegion${r}`);
                if (btn) btn.className = isActive ? activeClass : inactiveClass;
            });
        }
        
        // Helper: Update status buttons UI only (no filter application) - Portfolio Overview only
        function updateStatusButtonsUI(status) {
            const statuses = ["All", "CM", "DM"];
            statuses.forEach((s) => {
                const activeClass = "min-w-[45px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white";
                const inactiveClass = "min-w-[45px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900";
                const isActive = s.toLowerCase() === status.toLowerCase();
                
                const btn = document.getElementById(`btnStatus${s}`);
                if (btn) btn.className = isActive ? activeClass : inactiveClass;
            });
        }
        
        // Helper: Update commitment status buttons UI only (no filter application)
        function updateCommitmentButtonsUI(commitment) {
            const commitments = { All: "all", Committed: "Committed", Uncommitted: "Uncommitted" };
            Object.keys(commitments).forEach((key) => {
                const value = commitments[key];
                const minWidth = key === "All" ? "45px" : key === "Committed" ? "85px" : "100px";
                const activeClass = `min-w-[${minWidth}] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white`;
                const inactiveClass = `min-w-[${minWidth}] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900`;
                const isActive = value.toLowerCase() === commitment.toLowerCase();
                
                const btn = document.getElementById(`btnCommitment${key}`);
                if (btn) btn.className = isActive ? activeClass : inactiveClass;
            });
        }
        
        // Helper: Update amount type buttons UI only (no filter application) - Portfolio Overview only
        function updateAmountTypeButtonsUI(type) {
            const types = { 
                Direct: { id: "direct", minWidth: "65px" },
                Contingent: { id: "contingent", minWidth: "80px" },
                PSE: { id: "pse", minWidth: "50px" },
                OSUC: { id: "osuc", minWidth: "60px" },
                Unused: { id: "unused", minWidth: "90px" },
                TFA: { id: "tfa", minWidth: "50px" },
            };
            
            Object.keys(types).forEach((t) => {
                const minWidth = types[t].minWidth;
                const activeClass = `min-w-[${minWidth}] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white`;
                const inactiveClass = `min-w-[${minWidth}] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900`;
                const isActive = types[t].id === type;
                
                const btn = document.getElementById(`btnAmount${t}`);
                if (btn) btn.className = isActive ? activeClass : inactiveClass;
            });
        }
        
        
        // Export Functions
        
        function exportToExcel() {
            try {
                // Prepare data for export
                const exportData = filteredData.map((row) => ({
                    "Report Date": formatDate(row.Report_Date),
                    Region: row.Region || "",
                    "Facility ID": row.Facility_ID || "",
                    "Relationship Name": row.Relationship_Name || "",
                    "Product Program": row.Product_Program || "",
                    "Facility Amount": parseNumber(row.Fac_Amount),
                    "Direct OS": parseNumber(row.Direct_OS),
                    "Maturity Date": formatDate(row.Maturity_Date),
                    "CA Expiration Date": formatDate(row.CA_Expiration_Date),
                    "Control Unit": row.Control_Unit || "",
                    "Facility Type": row.Facility_Type || "",
                    "Commitment Status": row["Committed/Uncommitted"] || "",
                    "Management Status": row.Management_Status || "",
                    "Team Lead": row.Underwriting_Team_Lead || "",
                    Underwriter: row.Lead_Underwriter || "",
                }));
                
                // Create worksheet
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Portfolio Data");
                
                // Generate filename with timestamp
                const timestamp = new Date().toISOString().split("T")[0];
                const filename = `portfolio_export_${timestamp}.xlsx`;
                
                // Save file
                XLSX.writeFile(wb, filename);
                
                showNotification(
                    "Success",
                    `Data exported to ${filename}`,
                    "success"
                );
            } catch (error) {
                console.error("Export error:", error);
                showNotification("Error", "Failed to export to Excel", "error");
            }
        }
        
        function exportToPDF() {
            showNotification(
                "Info",
                "PDF export functionality coming soon",
                "info"
            );
            // TODO: Implement PDF export using jsPDF
        }
        
        function exportToPPT() {
            showNotification(
                "Info",
                "PowerPoint export functionality coming soon",
                "info"
            );
            // TODO: Implement PPT export using PptxGenJS
        }
        
        function exportToPNG() {
            try {
                const dashboard = document.querySelector(".p-4.md\\:p-6");
                html2canvas(dashboard, {
                    scale: 2,
                    backgroundColor: "#f9fafb",
                    logging: false,
                }).then((canvas) => {
                    const link = document.createElement("a");
                    const timestamp = new Date().toISOString().split("T")[0];
                    link.download = `portfolio_dashboard_${timestamp}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                    showNotification("Success", "Dashboard exported as PNG", "success");
                });
            } catch (error) {
                console.error("PNG export error:", error);
                showNotification("Error", "Failed to export as PNG", "error");
            }
        }
        
        // Update Report Date
        function updateReportDate() {
            if (portfolioData && portfolioData.length > 0) {
                // Get the most recent Report_Date from the data
                let maxDate = null;
                for (let i = 0; i < portfolioData.length; i++) {
                    const dateStr = portfolioData[i].Report_Date;
                    if (dateStr) {
                        const date = parseDate(dateStr);
                        if (date && (!maxDate || date > maxDate)) {
                            maxDate = date;
                        }
                    }
                }
                
                if (maxDate) {
                    const formatted = formatDate(maxDate);
                    document.getElementById("reportDate").textContent = formatted;
                } else {
                    document.getElementById("reportDate").textContent = "N/A";
                }
            }
        }

        // Calculate top metrics (OPTIMIZED with caching)
        function calculateMetrics() {
            // Check cache
            if (metricsCache.full) {
                const cached = metricsCache.full;
                document.getElementById("totalRelationships").textContent =
                    cached.relationships.toLocaleString();
                document.getElementById("totalFacilities").textContent =
                    cached.facilities.toLocaleString();
                document.getElementById("totalOSUC").textContent = formatCurrency(
                    cached.osuc
                );
                document.getElementById("totalFacAmount").textContent =
                    formatCurrency(cached.facAmount);
                document.getElementById("totalOutstanding").textContent =
                    formatCurrency(cached.outstanding);
                return;
            }
            
            const startTime = performance.now();
            
            let totalFacAmount = 0;
            let totalOSUC = 0;
            let totalOutstanding = 0;
            const relationships = new Set();
            const facilities = new Set();
            
            // Single pass through data (much faster than multiple passes)
            for (let i = 0; i < portfolioData.length; i++) {
                const row = portfolioData[i];
                
                totalFacAmount += parseNumber(row.Fac_Amount);
                totalOSUC += parseNumber(row.OSUC);
                
                // Total Outstanding from Total_OS column
                totalOutstanding += parseNumber(row.Total_OS);
                
                // Use Relationship_ID for unique count (not Relationship_Name which may have duplicates)
                if (row.Relationship_ID) relationships.add(row.Relationship_ID);
                
                if (row.Facility_ID) facilities.add(row.Facility_ID);
            }
            
            const metrics = {
                relationships: relationships.size,
                facilities: facilities.size,
                osuc: totalOSUC,
                facAmount: totalFacAmount,
                outstanding: totalOutstanding,
            };
            
            // Cache the results
            metricsCache.full = metrics;
            
            document.getElementById("totalRelationships").textContent =
                metrics.relationships.toLocaleString();
            document.getElementById("totalFacilities").textContent =
                metrics.facilities.toLocaleString();
            document.getElementById("totalOSUC").textContent = formatCurrency(
                metrics.osuc
            );
            document.getElementById("totalFacAmount").textContent = formatCurrency(
                metrics.facAmount
            );
            document.getElementById("totalOutstanding").textContent =
                formatCurrency(metrics.outstanding);

            console.log(
                `Metrics calculated in ${(performance.now() - startTime).toFixed(
                    2
                )}ms:`,
                metrics
            );
            
            // Calculate expired metrics
            calculateExpiredMetrics();
            
            // Calculate new deals YTD/MTD metrics
            calculateNewDealsMetrics();

            // Populate pipeline deals table
            populatePipelineTable();

            // Populate Covenant Monitoring data and chart
            populateCovenantMonitoringData();
            createCovenantMonitoringChart('pastDue');
            updateCovenantRegionalTable('pastDue');
            
            // Calculate and display CCM stats
            calculateCCMStats();
            createCCMRegionalChart ();
            updateCCMStats('pastDue');
        }

        // Calculate Facilities Expired and CAs Expired metrics
        function calculateExpiredMetrics() {
            // Get the current report month
            const reportDates = portfolioData
                .map((row) => parseDate(row.Report_Date))
                .filter((d) => d);
            if (reportDates.length === 0) return;
            
            const maxReportDate = new Date(Math.max(...reportDates));
            const currentYear = maxReportDate.getFullYear();
            const currentMonth = maxReportDate.getMonth();
            
            // Calculate start and end of current month
            const monthStart = new Date(currentYear, currentMonth, 1);
            monthStart.setHours(0, 0, 0, 0);
            const monthEnd = new Date(currentYear, currentMonth + 1, 0);
            monthEnd.setHours(23, 59, 59, 999);
            
            // Count expired facilities and CAs in current month only
            const expiredFacilities = new Set(); // Track unique Facility IDs
            let facilitiesExpiredAmount = 0;
            const expiredCAs = new Set();
            const expiredCAsEMEAByRelationship = new Set(); // For EMEA: track unique Relationship_IDs
            let casExpiredAmount = 0;
            
            for (let i = 0; i < portfolioData.length; i++) {
                const row = portfolioData[i];
                const managementStatus = (row.Management_Status || "").toUpperCase();
                
                // Check Facilities Expired (count unique Facility IDs, exclude DM)
                const maturityDate = parseDate(row.Maturity_Date);
                if (
                    maturityDate &&
                    maturityDate >= monthStart &&
                    maturityDate <= monthEnd &&
                    maturityDate < maxReportDate &&
                    row.Facility_ID &&
                    managementStatus !== "DM"
                ) {
                    expiredFacilities.add(row.Facility_ID);
                    facilitiesExpiredAmount += parseNumber(
                        row.Fac_Amount || row.Facility_Amount
                    );
                }
                
                // Check CAs Expired (count unique CAIDs for non-EMEA, unique Relationship_IDs for EMEA, but sum ALL lines, exclude DM)
                const caExpirationDate = parseDate(row.CA_Expiration_Date);
                const region = (row.Region || "").toUpperCase();
                
                if (
                    caExpirationDate &&
                    caExpirationDate >= monthStart &&
                    caExpirationDate <= monthEnd &&
                    caExpirationDate < maxReportDate &&
                    managementStatus !== "DM"
                ) {
                    // For EMEA: count unique Relationship_IDs instead of CAIDs
                    if (region === "EMEA" && row.Relationship_ID) {
                        expiredCAsEMEAByRelationship.add(row.Relationship_ID);
                    } else if (row.CAID) {
                        // For non-EMEA: count unique CAIDs
                        expiredCAs.add(row.CAID);
                    }
                    
                    casExpiredAmount += parseNumber(
                        row.Fac_Amount || row.Facility_Amount
                    );
                }
            }
            
            // Combine counts: non-EMEA CAIDs + EMEA Relationship_IDs
            const casExpiredCount = expiredCAs.size + expiredCAsEMEAByRelationship.size;
            const facilitiesExpiredCount = expiredFacilities.size;
            
            // Update DOM
            document.getElementById("facilitiesExpiredCount").textContent =
                facilitiesExpiredCount.toLocaleString();
            document.getElementById("casExpiredCount").textContent =
                casExpiredCount.toLocaleString();

            console.log("Expired Metrics:", {
                facilitiesExpired: facilitiesExpiredCount,
                facilitiesExpiredAmount: facilitiesExpiredAmount,
                casExpired: casExpiredCount,
                casExpiredAmount: casExpiredAmount,
            });
        }

        // Calculate New Deals Closed YTD and MTD metrics
        function calculateNewDealsMetrics() {
            // Use reporting month instead of actual current date
            const { monthStart, monthEnd, reportingMonth: repMonth } = getReportingMonthRange();
            const currentYear = repMonth.getFullYear();
            const currentMonth = repMonth.getMonth();
            const reportDay = repMonth.getDate();
            
            // Calculate date ranges based on reporting month
            const ytdStart = new Date(currentYear, 0, 1); // Jan 1 of reporting year
            ytdStart.setHours(0, 0, 0, 0);
            
            const mtdStart = new Date(currentYear, currentMonth, 1); // 1st of reporting month
            mtdStart.setHours(0, 0, 0, 0);
            
            const priorYtdStart = new Date(currentYear - 1, 0, 1); // Jan 1 of prior year
            priorYtdStart.setHours(0, 0, 0, 0);
            const priorYtdEnd = new Date(currentYear - 1, currentMonth, reportDay); // Same date last year
            priorYtdEnd.setHours(23, 59, 59, 999);
            
            const priorMtdStart = new Date(currentYear, currentMonth - 1, 1); // 1st of prior month
            priorMtdStart.setHours(0, 0, 0, 0);
            const priorMtdEnd = new Date(currentYear, currentMonth - 1, reportDay); // Same date prior month
            priorMtdEnd.setHours(23, 59, 59, 999);
            
            // Track unique facilities
            const ytdFacilities = new Set();
            const mtdFacilities = new Set();
            const priorYtdFacilities = new Set();
            const priorMtdFacilities = new Set();
            
            let ytdAmount = 0;
            let mtdAmount = 0;
            let priorYtdAmount = 0;
            let priorMtdAmount = 0;
            
            // Iterate through portfolio data
            for (let i = 0; i < portfolioData.length; i++) {
                const row = portfolioData[i];

                // Always exclude PSE for New Deals metrics
                const pseColumn = row["PSE_non-PSE"] || row.PSE_non_PSE || "";
                const pseValue = String(pseColumn).trim().toUpperCase();
                if (pseValue === "PSE") continue;

                const approvalDate = parseDate(row.Origination_Date);
                const facilityId = row.Facility_ID;
                const facAmount = parseNumber(row.Fac_Amount);
                
                if (!approvalDate || !facilityId) continue;
                
                // Check YTD (reporting year)
                if (approvalDate >= ytdStart && approvalDate <= repMonth) {
                    if (!ytdFacilities.has(facilityId)) {
                        ytdFacilities.add(facilityId);
                        ytdAmount += facAmount;
                    }
                }
                
                // Check MTD (reporting month)
                if (approvalDate >= mtdStart && approvalDate <= repMonth) {
                    if (!mtdFacilities.has(facilityId)) {
                        mtdFacilities.add(facilityId);
                        mtdAmount += facAmount;
                    }
                }
                
                // Check prior YTD (same period last year)
                if (approvalDate >= priorYtdStart && approvalDate <= priorYtdEnd) {
                    if (!priorYtdFacilities.has(facilityId)) {
                        priorYtdFacilities.add(facilityId);
                        priorYtdAmount += facAmount;
                    }
                }
                
                // Check prior MTD (same period last month)
                if (approvalDate >= priorMtdStart && approvalDate <= priorMtdEnd) {
                    if (!priorMtdFacilities.has(facilityId)) {
                        priorMtdFacilities.add(facilityId);
                        priorMtdAmount += facAmount;
                    }
                }
            }
            
            // Calculate variances
            const ytdVariance = priorYtdFacilities.size > 0 
                ? ((ytdFacilities.size - priorYtdFacilities.size) / priorYtdFacilities.size) * 100 
                : 0;
            const mtdVariance = priorMtdFacilities.size > 0 
                ? ((mtdFacilities.size - priorMtdFacilities.size) / priorMtdFacilities.size) * 100 
                : 0;
            
            // Update UI - YTD
            document.getElementById('newDealsYTD').textContent = ytdFacilities.size.toLocaleString();
            document.getElementById('newDealsYTDAmount').textContent = formatCurrency(ytdAmount);
            
            const ytdVarianceEl = document.getElementById('newDealsYTDVariance');
            updateVarianceDisplay(ytdVarianceEl, ytdVariance);
            
            // Update UI - MTD
            document.getElementById('newDealsMTD').textContent = mtdFacilities.size.toLocaleString();
            document.getElementById('newDealsMTDAmount').textContent = formatCurrency(mtdAmount);
            
            const mtdVarianceEl = document.getElementById('newDealsMTDVariance');
            updateVarianceDisplay(mtdVarianceEl, mtdVariance);
            
            console.log('New Deals Metrics:', {
                ytd: { count: ytdFacilities.size, amount: ytdAmount, variance: ytdVariance.toFixed(1) + '%' },
                mtd: { count: mtdFacilities.size, amount: mtdAmount, variance: mtdVariance.toFixed(1) + '%' },
                priorYtd: { count: priorYtdFacilities.size, amount: priorYtdAmount },
                priorMtd: { count: priorMtdFacilities.size, amount: priorMtdAmount }
            });
        }
        
        // Helper function to update variance display with colors and icons
        function updateVarianceDisplay(element, variance) {
            const absVariance = Math.abs(variance);
            const displayText = absVariance.toFixed(1) + '%';
            
            if (variance > 0) {
                // Positive variance - green
                element.className = 'flex items-center gap-1 rounded-full bg-green-100 py-0.5 pl-2 pr-2.5 text-sm font-medium text-green-600';
                element.innerHTML = `
                    <svg class="fill-current" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M5.56462 1.62393C5.70193 1.47072 5.90135 1.37432 6.12329 1.37432C6.1236 1.37432 6.12391 1.37432 6.12422 1.37432C6.31631 1.37415 6.50845 1.44731 6.65505 1.59381L9.65514 4.5918C9.94814 4.88459 9.94831 5.35947 9.65552 5.65246C9.36273 5.94546 8.88785 5.94562 8.59486 5.65283L6.87329 3.93247L6.87329 10.125C6.87329 10.5392 6.53751 10.875 6.12329 10.875C5.70908 10.875 5.37329 10.5392 5.37329 10.125L5.37329 3.93578L3.65516 5.65282C3.36218 5.94562 2.8873 5.94547 2.5945 5.65248C2.3017 5.35949 2.30185 4.88462 2.59484 4.59182L5.56462 1.62393Z" fill=""></path>
                    </svg>
                    ${displayText}
                `;
            } else if (variance < 0) {
                // Negative variance - red
                element.className = 'flex items-center gap-1 rounded-full bg-red-100 py-0.5 pl-2 pr-2.5 text-sm font-medium text-red-600';
                element.innerHTML = `
                    <svg class="fill-current" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M5.31462 10.3761C5.45194 10.5293 5.65136 10.6257 5.87329 10.6257C5.8736 10.6257 5.8739 10.6257 5.87421 10.6257C6.0663 10.6259 6.25845 10.5527 6.40505 10.4062L9.40514 7.4082C9.69814 7.11541 9.69831 6.64054 9.40552 6.34754C9.11273 6.05454 8.63785 6.05438 8.34486 6.34717L6.62329 8.06753L6.62329 1.875C6.62329 1.46079 6.28751 1.125 5.87329 1.125C5.45908 1.125 5.12329 1.46079 5.12329 1.875L5.12329 8.06422L3.40516 6.34719C3.11218 6.05439 2.6373 6.05454 2.3445 6.34752C2.0517 6.64051 2.05185 7.11538 2.34484 7.40818L5.31462 10.3761Z" fill=""></path>
                    </svg>
                    ${displayText}
                `;
            } else {
                // No change - gray
                element.className = 'flex items-center gap-1 rounded-full bg-gray-100 py-0.5 pl-2 pr-2.5 text-sm font-medium text-gray-600';
                element.textContent = displayText;
            }
        }

        // Calculate New Deals Closed YTD and MTD metrics from filtered data
        function calculateNewDealsMetricsFromFiltered() {
            // Use reporting month instead of actual current date
            const { monthStart, monthEnd, reportingMonth: repMonth } = getReportingMonthRange();
            const currentYear = repMonth.getFullYear();
            const currentMonth = repMonth.getMonth();
            const reportDay = repMonth.getDate();
            
            // Calculate date ranges based on reporting month
            const ytdStart = new Date(currentYear, 0, 1);
            ytdStart.setHours(0, 0, 0, 0);
            
            const mtdStart = new Date(currentYear, currentMonth, 1);
            mtdStart.setHours(0, 0, 0, 0);
            
            const priorYtdStart = new Date(currentYear - 1, 0, 1);
            priorYtdStart.setHours(0, 0, 0, 0);
            const priorYtdEnd = new Date(currentYear - 1, currentMonth, reportDay);
            priorYtdEnd.setHours(23, 59, 59, 999);
            
            const priorMtdStart = new Date(currentYear, currentMonth - 1, 1);
            priorMtdStart.setHours(0, 0, 0, 0);
            const priorMtdEnd = new Date(currentYear, currentMonth - 1, reportDay);
            priorMtdEnd.setHours(23, 59, 59, 999);
            
            // Track unique facilities
            const ytdFacilities = new Set();
            const mtdFacilities = new Set();
            const priorYtdFacilities = new Set();
            const priorMtdFacilities = new Set();
            
            let ytdAmount = 0;
            let mtdAmount = 0;
            let priorYtdAmount = 0;
            let priorMtdAmount = 0;
            
            // Use filtered data if available, otherwise use portfolio data
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
            
            // Iterate through data
            for (let i = 0; i < dataSource.length; i++) {
                const row = dataSource[i];

                // Always exclude PSE for New Deals metrics
                const pseColumn = row["PSE_non-PSE"] || row.PSE_non_PSE || "";
                const pseValue = String(pseColumn).trim().toUpperCase();
                if (pseValue === "PSE") continue;

                const approvalDate = parseDate(row.Origination_Date);
                const facilityId = row.Facility_ID;
                const facAmount = parseNumber(row.Fac_Amount);
                
                if (!approvalDate || !facilityId) continue;
                
                // Check YTD (reporting year)
                if (approvalDate >= ytdStart && approvalDate <= repMonth) {
                    if (!ytdFacilities.has(facilityId)) {
                        ytdFacilities.add(facilityId);
                        ytdAmount += facAmount;
                    }
                }
                
                // Check MTD (reporting month)
                if (approvalDate >= mtdStart && approvalDate <= repMonth) {
                    if (!mtdFacilities.has(facilityId)) {
                        mtdFacilities.add(facilityId);
                        mtdAmount += facAmount;
                    }
                }
                
                // Check prior YTD (same period last year)
                if (approvalDate >= priorYtdStart && approvalDate <= priorYtdEnd) {
                    if (!priorYtdFacilities.has(facilityId)) {
                        priorYtdFacilities.add(facilityId);
                        priorYtdAmount += facAmount;
                    }
                }
                
                // Check prior MTD (same period last month)
                if (approvalDate >= priorMtdStart && approvalDate <= priorMtdEnd) {
                    if (!priorMtdFacilities.has(facilityId)) {
                        priorMtdFacilities.add(facilityId);
                        priorMtdAmount += facAmount;
                    }
                }
            }
            
            // Calculate variances
            const ytdVariance = priorYtdFacilities.size > 0 
                ? ((ytdFacilities.size - priorYtdFacilities.size) / priorYtdFacilities.size) * 100 
                : 0;
            const mtdVariance = priorMtdFacilities.size > 0 
                ? ((mtdFacilities.size - priorMtdFacilities.size) / priorMtdFacilities.size) * 100 
                : 0;
            
            // Update UI - YTD
            document.getElementById('newDealsYTD').textContent = ytdFacilities.size.toLocaleString();
            document.getElementById('newDealsYTDAmount').textContent = formatCurrency(ytdAmount);
            
            const ytdVarianceEl = document.getElementById('newDealsYTDVariance');
            updateVarianceDisplay(ytdVarianceEl, ytdVariance);
            
            // Update UI - MTD
            document.getElementById('newDealsMTD').textContent = mtdFacilities.size.toLocaleString();
            document.getElementById('newDealsMTDAmount').textContent = formatCurrency(mtdAmount);
            
            const mtdVarianceEl = document.getElementById('newDealsMTDVariance');
            updateVarianceDisplay(mtdVarianceEl, mtdVariance);
        }

        function populatePipelineTable() {
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Get the current year for filtering
            const currentYear = today.getFullYear();
            console.log('Pipeline Table - Current Year:', currentYear);

            // Define excluded facility types
            const excludedFacilityTypes = [
                'Cash Management-DOL',
                'Cash Management-ACH',
                'Settlement',
                'Overdraft Line',
                'Collateral Monitoring Line',
                'Outgoing TPC',
                'Credit Card',
                'Guaranty',
                'Cash Management-Other',
                'B&I Margin Loan',
                'Cash Management-BACS',
                'SAFE - Prime Finance',
                'Clearing',
                'Agency Clearing',
                'SAFE - Financing',
                'B&I Short Market Values',
                'Term Loan',
                'Residential First Mortgage-Standard',
                'B&I Non-Purpose Loan',
                'Unallocated'
            ];

            // Define aging buckets (in days) - Always show these 4 rows
            const buckets = [
                { label: '0-30 Days', min: 0, max: 30, count: 0, facilities: new Set(), tfa: 0 },
                { label: '31-60 Days', min: 31, max: 60, count: 0, facilities: new Set(), tfa: 0 },
                { label: '61-90 Days', min: 61, max: 90, count: 0, facilities: new Set(), tfa: 0 },
                { label: '>90 Days', min: 91, max: Infinity, count: 0, facilities: new Set(), tfa: 0 }
            ];

            // Filter and categorize deals
            dataSource.forEach(row => {
                // Always exclude PSE for Deals Pending Closure
                const pseColumn = row["PSE_non-PSE"] || row.PSE_non_PSE || "";
                const pseValue = String(pseColumn).trim().toUpperCase();
                if (pseValue === "PSE") return;

                // Only include NAM and LATAM regions
                const region = String(row.Region || "").trim().toUpperCase();
                if (region !== "NAM" && region !== "LATAM") return;

                // Exclude specific facility types
                const facilityType = String(row.Facility_Type || "").trim();
                if (excludedFacilityTypes.includes(facilityType)) return;

                const originationDate = row.Origination_Date;
                const firstApprovalDate = parseDate(row.Facility_First_Approval_Date);
                const facilityId = row.Facility_ID;
                const tfaAmount = parseNumber(row.Fac_Amount || row.Facility_Amount);

                // Only include deals where:
                // 1. Origination_Date is empty or null
                // 2. Has first approval date
                // 3. Facility_First_Approval_Date is in the current year
                // 4. PSE is excluded (checked above)
                // 5. Only NAM and LATAM regions (checked above)
                // 6. Excluded facility types are filtered out (checked above)
                if ((!originationDate || originationDate.trim() === '') &&
                    firstApprovalDate &&
                    facilityId &&
                    firstApprovalDate.getFullYear() === currentYear) {

                    // Calculate days since approval
                    const daysSinceApproval = Math.floor((today - firstApprovalDate) / (1000 * 60 * 60 * 24));

                    // Find appropriate bucket
                    for (const bucket of buckets) {
                        if (daysSinceApproval >= bucket.min && daysSinceApproval <= bucket.max) {
                            bucket.facilities.add(facilityId);
                            bucket.tfa += tfaAmount;
                            break;
                        }
                    }
                }
            });

            // Update bucket counts from unique facilities
            buckets.forEach(bucket => {
                bucket.count = bucket.facilities.size;
            });

            // Populate table
            const tableBody = document.getElementById('pipelineTableBody');
            if (!tableBody) return;

            // Calculate totals
            const totalCount = buckets.reduce((sum, b) => sum + b.count, 0);
            const totalTFA = buckets.reduce((sum, b) => sum + b.tfa, 0);

            // Build table rows - always show all 4 buckets
            let html = '';
            buckets.forEach(bucket => {
                html += `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-5 py-3 text-sm text-gray-700">${bucket.label}</td>
                        <td class="px-5 py-3 text-sm text-gray-900 font-semibold text-right">${bucket.count.toLocaleString()}</td>
                        <td class="px-5 py-3 text-sm text-gray-900 font-semibold text-right">${formatCurrency(bucket.tfa)}</td>
                    </tr>
                `;
            });

            // Add total row
            html += `
                <tr class="bg-gray-50 font-semibold border-t-2 border-gray-300">
                    <td class="px-5 py-3 text-sm text-gray-900">Total</td>
                    <td class="px-5 py-3 text-sm text-gray-900 text-right">${totalCount.toLocaleString()}</td>
                    <td class="px-5 py-3 text-sm text-gray-900 text-right">${formatCurrency(totalTFA)}</td>
                </tr>
            `;

            tableBody.innerHTML = html;

            console.log('Pipeline Table populated:', {
                currentYear: currentYear,
                totalFacilities: totalCount,
                totalTFA: formatCurrency(totalTFA),
                buckets: buckets.map(b => ({ label: b.label, count: b.count, tfa: formatCurrency(b.tfa) }))
            });
        }
        // Create Covenant Monitoring Chart (Radial Gauge Style)
        let covenantMonitoringChartInstance = null;
        let currentCovenantData = {
            pastDue: {
                count: 0,
                categories: []
            },
            comingDue: {
                count: 0,
                categories: []
            }
        };

        // Function to populate covenant monitoring data from live data
        function populateCovenantMonitoringData() {
            console.log(' Populating Covenant Monitoring Data from Covenants file');
            
            // Use covenant data if available, otherwise fallback to portfolio data
            const dataSource = covenantsData.length > 0 ? covenantsData : (filteredData.length > 0 ? filteredData : portfolioData);
            
            console.log('Using data source with', dataSource.length, 'records');
            console.log('Covenant data available:', covenantsData.length > 0 ? 'Yes' : 'No');
            
            // Initialize category buckets - Breakdown shows ALL categories
            const pastDueBuckets = {
                '1-45 Days': { count: 0 },
                '46-90 Days': { count: 0 },
                '>90 Days': { count: 0 }
            };
            
            // For gauge - only track 46-90 and >90
            const pastDueGaugeBuckets = {
                '46-90 Days': { count: 0 },
                '>90 Days': { count: 0 }
            };
            
            // Coming Due only shows next 30 days
            const comingDueBuckets = {
                'Next 30 Days': { count: 0 }
            };
            
            let pastDueTotalAll = 0;  // Total including 1-45 days (for breakdown)
            let pastDueTotalGauge = 0; // Total for gauge (46-90 + >90 only)
            let comingDueTotal = 0;
            
            dataSource.forEach(row => {
                // Use exact field names from dataLoader export
                const status = String(row.Coming_Due_Past_Due || "").trim().toLowerCase();
                const pastDueCategory = String(row.Past_Due_Category || "").trim();
                const region = String(row.Region || "").trim().toUpperCase();
                
                // Apply region filter if active
                if (selectedRegion !== 'all' && region !== selectedRegion.toUpperCase()) return;
                
                // Process Past Due covenants using Coming_Due_Past_Due and Past_Due_Category from dataLoader
                if (status === 'past due') {
                    pastDueTotalAll++;
                    
                    // Debug: Log first few past due records to see actual category values
                    if (pastDueTotalAll <= 3) {
                        console.log(`DEBUG Past Due Record ${pastDueTotalAll}:`, {
                            status: row.Coming_Due_Past_Due,
                            category: row.Past_Due_Category,
                            categoryTrimmed: pastDueCategory,
                            region: region
                        });
                    }
                    
                    // Use Past_Due_Category from dataLoader (normalized categories: "0-30 Days", "31-45 Days", "46-60 Days", "61-90 Days", ">90 Days")
                    if (pastDueCategory === '>90 Days') {
                        pastDueBuckets['>90 Days'].count++;
                        pastDueGaugeBuckets['>90 Days'].count++;
                        pastDueTotalGauge++;
                    } else if (pastDueCategory === '61-90 Days' || pastDueCategory === '46-60 Days') {
                        pastDueBuckets['46-90 Days'].count++;
                        pastDueGaugeBuckets['46-90 Days'].count++;
                        pastDueTotalGauge++;
                    } else if (pastDueCategory === '0-30 Days' || pastDueCategory === '31-45 Days') {
                        // 1-45 days - only in breakdown, not in gauge
                        pastDueBuckets['1-45 Days'].count++;
                    } else {
                        // Catch any unmatched categories
                        if (pastDueTotalAll <= 5) {
                            console.warn(` Unmatched Past_Due_Category: "${pastDueCategory}"`, row);
                        }
                    }
                }
                
                // Process Coming Due covenants
                if (status === 'coming due') {
                    comingDueBuckets['Next 30 Days'].count++;
                    comingDueTotal++;
                }
            });
            
            // Convert buckets to categories with percentages (for breakdown display)
            const pastDueCategories = Object.entries(pastDueBuckets).map(([label, data]) => ({
                label: label,
                count: data.count,
                percentage: pastDueTotalAll > 0 ? parseFloat(((data.count / pastDueTotalAll) * 100).toFixed(1)) : 0
            }));
            
            // Gauge data for donut chart (only 46-90 and >90)
            const pastDueGaugeCategories = Object.entries(pastDueGaugeBuckets).map(([label, data]) => ({
                label: label,
                count: data.count,
                percentage: pastDueTotalGauge > 0 ? parseFloat(((data.count / pastDueTotalGauge) * 100).toFixed(1)) : 0
            }));
            
            const comingDueCategories = Object.entries(comingDueBuckets).map(([label, data]) => ({
                label: label,
                count: data.count,
                percentage: comingDueTotal > 0 ? parseFloat(((data.count / comingDueTotal) * 100).toFixed(1)) : 0
            }));
            
            // Update global covenant data
            currentCovenantData.pastDue = {
                count: pastDueTotalGauge,  // Gauge shows only 46-90 + >90
                totalAll: pastDueTotalAll,  // Total including 1-45 days
                categories: pastDueCategories,  // All categories for breakdown
                gaugeCategories: pastDueGaugeCategories  // Only 46-90 and >90 for donut chart
            };
            
            currentCovenantData.comingDue = {
                count: comingDueTotal,
                categories: comingDueCategories
            };
            
            console.log(` Covenant Monitoring: ${pastDueTotalGauge} Past Due in gauge (46+ days), ${pastDueTotalAll} total past due, ${comingDueTotal} Coming Due (next 30 days)`);
        }

        function createCovenantMonitoringChart(viewType = 'pastDue') {
            console.log('Creating Covenant Monitoring Chart:', viewType);
            
            const chartElement = document.getElementById("covenantMonitoringChart");
            if (!chartElement) {
                console.error('Chart element "covenantMonitoringChart" not found');
                return;
            }

            const data = currentCovenantData[viewType];
            const isPastDue = viewType === 'pastDue';

            let series, labels, colors, totalCount;

            if (isPastDue) {
                // For Past Due: Show ALL categories (1-45, 46-90, >90) with matching colors
                const categories = data.categories || [];
                // Color mapping for each category
                const colorMap = {
                    '1-45 Days': "#dde9ff",
                    '46-90 Days': "#7592ff",
                    '>90 Days': "#3641f5"
                };
                // Filter out categories with zero count
                const filteredCategories = categories.filter(cat => cat.count > 0);
                series = filteredCategories.map(cat => cat.count);
                labels = filteredCategories.map(cat => cat.label);
                colors = filteredCategories.map(cat => colorMap[cat.label] || "#7592ff");
                totalCount = data.totalAll || data.count;
            } else {
                // For Coming Due: Show next 30 days (only if count > 0)
                if (data.count > 0) {
                    series = [data.count];
                    labels = ["Next 30 Days"];
                    colors = ["#10B981"]; // Keep green for Coming Due
                } else {
                    series = [];
                    labels = [];
                    colors = [];
                }
                totalCount = data.count;
            }

            // Handle empty data - show no data message
            if (series.length === 0 || totalCount === 0) {
                console.log(" No covenant data available for", viewType);
                // Destroy existing chart if it exists
                if (covenantMonitoringChartInstance) {
                    covenantMonitoringChartInstance.destroy();
                    covenantMonitoringChartInstance = null;
                }
                chartElement.innerHTML = generateNoDataMessage(isPastDue ? 'Past Due Covenants' : 'Coming Due Covenants');
                // Clear the legend
                const legendElement = document.getElementById("covenantMonitoringLegend");
                if (legendElement) {
                    legendElement.innerHTML = '';
                }
                return;
            }

            const options = {
                series: series,
                colors: colors,
                labels: labels,
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "donut",
                    width: 280,
                    height: 280,
                },
                stroke: {
                    show: false,
                    width: 4,
                    colors: "transparent",
                },
                plotOptions: {
                    pie: {
                        donut: {
                            size: "65%",
                            background: "transparent",
                            labels: {
                                show: true,
                                name: {
                                    show: true,
                                    offsetY: 0,
                                    color: "#1D2939",
                                    fontSize: "12px",
                                    fontWeight: "normal",
                                },
                                value: {
                                    show: true,
                                    offsetY: 10,
                                    color: "#667085",
                                    fontSize: "14px",
                                    formatter: (val) => val.toLocaleString(),
                                },
                                total: {
                                    show: true,
                                    label: isPastDue ? "Past Due" : "Coming Due",
                                    color: "#000000",
                                    fontSize: "20px",
                                    fontWeight: "bold",
                                    formatter: () => totalCount.toLocaleString(),
                                },
                            },
                        },
                    },
                        },
                        dataLabels: {
                    enabled: false,
                            },
                tooltip: {
                    enabled: true,
                    theme: "light",
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        const label = labels[seriesIndex];
                        const count = series[seriesIndex];
                        const percentage = totalCount > 0 ? ((count / totalCount) * 100).toFixed(1) : 0;
                        
                        let html = `<div class="apexcharts-tooltip-custom" style="padding: 12px; min-width: 180px; background: #ffffff; color: #1f2937; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border: 1px solid #e5e7eb;">`;
                        html += `<div style="font-weight: 600; margin-bottom: 8px; font-size: 13px; color: #1f2937;">${label}</div>`;
                        html += `<div style="font-size: 11px; color: #666;">`;
                        html += `<div style="margin-bottom: 4px;"><strong>${count}</strong></div>`;
                        html += `<div><strong>${percentage}%</strong> of Total</div>`;
                        html += `</div></div>`;
                        return html;
                    }
                },
                legend: {
                    show: false,
                            },
                responsive: [
                    {
                        breakpoint: 2600,
                        options: {
                            chart: {
                                width: 240,
                                height: 240,
                        },
                    },
                },
                    {
                        breakpoint: 640,
                        options: {
                            chart: {
                                width: 280,
                                height: 280,
                },
                        },
                },
                ],
            };

            // Destroy existing chart if it exists
            if (covenantMonitoringChartInstance) {
                covenantMonitoringChartInstance.destroy();
            }

            chartElement.innerHTML = "";
            covenantMonitoringChartInstance = new ApexCharts(chartElement, options);
            covenantMonitoringChartInstance.render();
            console.log('Covenant Monitoring chart rendered successfully');

            // Update custom legend
            updateCovenantMonitoringLegend(labels, series, totalCount, colors);
        }

        // Update the legend for covenant monitoring chart
        function updateCovenantMonitoringLegend(labels, series, totalCount, colors) {
            const legendElement = document.getElementById("covenantMonitoringLegend");
            if (!legendElement) return;

            let legendHTML = "";
            for (let i = 0; i < labels.length; i++) {
                const color = colors[i] || "#3641f5";
                const count = series[i] || 0;
            
                legendHTML += `
                    <div class="flex flex-col items-center gap-2">
                            <div class="flex items-center gap-2">
                            <div class="h-2.5 w-2.5 rounded-full flex-shrink-0" style="background-color: ${color};"></div>
                            <span class="text-xs font-medium text-gray-700">${labels[i]}</span>
                    </div>
                        <div class="text-lg font-bold text-gray-900">${count}</div>
                </div>
            `;
            }

            legendElement.innerHTML = legendHTML;
        }
        
        // Update region distribution for covenant monitoring
        // Removed updateCovenantRegionDistribution - region data now integrated in legends

        function updateCovenantChart(viewType) {
            console.log('Updating covenant chart to:', viewType);
            currentCovenantViewType = viewType; // Update global state for View Data
            createCovenantMonitoringChart(viewType);
            updateCovenantRegionalTable(viewType);
        }

        // Update the regional distribution table based on view type
        function updateCovenantRegionalTable(viewType = 'pastDue') {
            console.log('Updating regional table for:', viewType);
            
            const titleEl = document.getElementById('covenantRegionalTableTitle');
            const subtitleEl = document.getElementById('covenantRegionalTableSubtitle');
            const headerEl = document.getElementById('covenantRegionalTableHeader');
            const tableBody = document.getElementById('covenantRegionalTableBody');
            
            if (!tableBody) return;
            
            const isPastDue = viewType === 'pastDue';
            
            // Update title and subtitle
            if (titleEl) {
                titleEl.textContent = isPastDue ? 'Past Due Covenants by Region' : 'Coming Due Covenants by Region';
            }
            if (subtitleEl) {
                subtitleEl.textContent = isPastDue ? 'Regional breakdown of past due covenants' : 'Regional breakdown of covenants due in 30 days';
            }
            
            // Update table headers
            if (headerEl) {
                if (isPastDue) {
                    headerEl.innerHTML = `
                        <th class="px-2 py-2 text-xs font-semibold text-gray-700 tracking-wider whitespace-nowrap">Region</th>
                        <th class="px-2 py-2 text-xs font-semibold text-gray-700 tracking-wider text-center whitespace-nowrap">1-45</th>
                        <th class="px-2 py-2 text-xs font-semibold text-gray-700 tracking-wider text-center whitespace-nowrap">46-90</th>
                        <th class="px-2 py-2 text-xs font-semibold text-gray-700 tracking-wider text-center whitespace-nowrap">&gt;90</th>
                        <th class="px-2 py-2 text-xs font-semibold text-gray-700 tracking-wider text-center whitespace-nowrap">Total</th>
                        <th class="px-2 py-2 text-xs font-semibold text-gray-700 tracking-wider text-center whitespace-nowrap">Sum</th>
                        <th class="px-2 py-2 text-xs font-semibold text-gray-700 tracking-wider text-center whitespace-nowrap" style="min-width: 70px;">% Total</th>
                    `;
                } else {
                    headerEl.innerHTML = `
                        <th class="px-2 py-2 text-xs font-semibold text-gray-700 tracking-wider whitespace-nowrap">Region</th>
                        <th class="px-2 py-2 text-xs font-semibold text-gray-700 tracking-wider text-center whitespace-nowrap">Due (30d)</th>
                        <th class="px-2 py-2 text-xs font-semibold text-gray-700 tracking-wider text-center whitespace-nowrap">Total</th>
                        <th class="px-2 py-2 text-xs font-semibold text-gray-700 tracking-wider text-center whitespace-nowrap">Sum</th>
                        <th class="px-2 py-2 text-xs font-semibold text-gray-700 tracking-wider text-center whitespace-nowrap" style="min-width: 70px;">% Total</th>
                    `;
                }
            }
            
            // Calculate regional distribution
            const dataSource = covenantsData.length > 0 ? covenantsData : portfolioData;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const regions = ['APAC', 'EMEA', 'NAM', 'LATAM'];
            const regionalData = {};
            const regionPopulation = {}; // Total covenants per region (no status filter)
            
            regions.forEach(region => {
                regionalData[region] = {
                    '1-30': 0,
                    '31-45': 0,
                    '46-60': 0,
                    '61-90': 0,
                    '>90': 0,
                    'comingDue': 0
                };
                regionPopulation[region] = 0;
            });
            
            // FIRST PASS: Count total covenants per region (Population - no status filter)
            let totalPopulation = 0;
            
            dataSource.forEach(row => {
                const region = String(row.Region || "").trim().toUpperCase();
                
                if (!regions.includes(region)) return;
                
                // Apply region filter if active
                if (selectedRegion !== 'all' && region !== selectedRegion.toUpperCase()) return;
                
                regionPopulation[region]++;
                totalPopulation++;
            });
            
            // SECOND PASS: Count by status categories using dataLoader fields
            let regionalDebugCount = 0;
            dataSource.forEach(row => {
                // Use exact field names from dataLoader export
                const status = String(row.Coming_Due_Past_Due || "").trim().toLowerCase();
                const region = String(row.Region || "").trim().toUpperCase();
                const pastDueCategory = String(row.Past_Due_Category || "").trim();
                
                if (!regions.includes(region)) return;
                
                // Apply region filter if active
                if (selectedRegion !== 'all' && region !== selectedRegion.toUpperCase()) return;
                
                // For Past Due covenants - use Past_Due_Category from dataLoader (normalized categories)
                if (status === 'past due') {
                    regionalDebugCount++;
                    
                    // Debug: Log first few regional past due records
                    if (regionalDebugCount <= 3) {
                        console.log(`DEBUG Regional Past Due Record ${regionalDebugCount}:`, {
                            status: row.Coming_Due_Past_Due,
                            category: row.Past_Due_Category,
                            categoryTrimmed: pastDueCategory,
                            region: region
                        });
                    }
                    
                    if (pastDueCategory === '>90 Days') {
                        regionalData[region]['>90']++;
                    } else if (pastDueCategory === '61-90 Days') {
                        regionalData[region]['61-90']++;
                    } else if (pastDueCategory === '46-60 Days') {
                        regionalData[region]['46-60']++;
                    } else if (pastDueCategory === '31-45 Days') {
                        regionalData[region]['31-45']++;
                    } else if (pastDueCategory === '0-30 Days') {
                        regionalData[region]['1-30']++;
                    } else {
                        // Catch any unmatched categories
                        if (regionalDebugCount <= 5) {
                            console.warn(` Regional: Unmatched Past_Due_Category: "${pastDueCategory}"`, row);
                        }
                    }
                }
                
                // For Coming Due covenants - Coming_Due_Past_Due = "Coming Due" means it's coming due
                if (status === 'coming due') {
                    regionalData[region]['comingDue']++;
                }
            });
            
            // Calculate totals for percentage calculation
            let grandTotalPastDue = 0;
            let grandTotalComingDue = 0;
            
            regions.forEach(region => {
                const pastDueCount = regionalData[region]['1-30'] + regionalData[region]['31-45'] + 
                                     regionalData[region]['46-60'] + regionalData[region]['61-90'] + 
                                     regionalData[region]['>90'];
                grandTotalPastDue += pastDueCount;
                grandTotalComingDue += regionalData[region]['comingDue'];
            });
            
            const grandTotal = grandTotalPastDue + grandTotalComingDue;
            
            // Build table rows - only for regions that have data
            let html = '';
            let total145 = 0;
            let total4690 = 0;
            let totalOver90 = 0;
            let totalComingDue = 0;
            
            // Filter regions to only include those with population > 0
            const regionsWithData = regions.filter(region => regionPopulation[region] > 0);
            
            regionsWithData.forEach(region => {
                // Calculate combined columns
                const count145 = regionalData[region]['1-30'] + regionalData[region]['31-45'];
                const count4690 = regionalData[region]['46-60'] + regionalData[region]['61-90'];
                const countOver90 = regionalData[region]['>90'];
                const countComingDue = regionalData[region]['comingDue'];
                
                total145 += count145;
                total4690 += count4690;
                totalOver90 += countOver90;
                totalComingDue += countComingDue;
                
                // Calculate region totals
                const regionPastDueTotal = count145 + count4690 + countOver90;
                // Population is the total unique covenants for this region (calculated in first pass, no status filter)
                const regPopulation = regionPopulation[region];
                
                if (isPastDue) {
                    // % of Total = Past Due Total for this region / Total Population
                    const percentOfTotal = totalPopulation > 0 ? ((regionPastDueTotal / totalPopulation) * 100).toFixed(1) : 0;
                    
                html += `
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            <td class="px-2 py-2 text-xs font-medium text-gray-700">${region}</td>
                            <td class="px-2 py-2 text-xs text-gray-700 text-center font-semibold">${count145}</td>
                            <td class="px-2 py-2 text-xs text-gray-700 text-center font-semibold">${count4690}</td>
                            <td class="px-2 py-2 text-xs text-gray-700 text-center font-semibold">${countOver90}</td>
                            <td class="px-2 py-2 text-xs text-gray-900 text-center font-bold">${regionPastDueTotal}</td>
                            <td class="px-2 py-2 text-xs text-gray-900 text-center font-bold">${regPopulation}</td>
                            <td class="px-2 py-2 text-xs">
                                <div class="relative w-full h-4 bg-gray-100 rounded overflow-hidden">
                                    <div class="absolute top-0 left-0 h-full bg-blue-500 rounded transition-all duration-300" style="width: ${percentOfTotal}%"></div>
                                    <span class="absolute inset-0 flex items-center justify-center text-xs font-semibold text-gray-800">${percentOfTotal}%</span>
                            </div>
                            </td>
                        </tr>
                    `;
                } else {
                    // % of Total = Coming Due for this region / Total Population
                    const percentOfTotal = totalPopulation > 0 ? ((countComingDue / totalPopulation) * 100).toFixed(1) : 0;
                    
                    html += `
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            <td class="px-2 py-2 text-xs font-medium text-gray-700">${region}</td>
                            <td class="px-2 py-2 text-xs text-gray-700 text-center font-semibold">${countComingDue}</td>
                            <td class="px-2 py-2 text-xs text-gray-900 text-center font-bold">${countComingDue}</td>
                            <td class="px-2 py-2 text-xs text-gray-900 text-center font-bold">${regPopulation}</td>
                            <td class="px-2 py-2 text-xs">
                                <div class="relative w-full h-4 bg-gray-100 rounded overflow-hidden">
                                    <div class="absolute top-0 left-0 h-full bg-green-500 rounded transition-all duration-300" style="width: ${percentOfTotal}%"></div>
                                    <span class="absolute inset-0 flex items-center justify-center text-xs font-semibold text-gray-800">${percentOfTotal}%</span>
                                    </div>
                            </td>
                        </tr>
                    `;
                }
            });
            
            // Add total row
            const totalPastDue = total145 + total4690 + totalOver90;
            
            if (isPastDue) {
                const totalPercentOfTotal = totalPopulation > 0 ? ((totalPastDue / totalPopulation) * 100).toFixed(1) : 0;
                html += `
                    <tr class="bg-gray-50 font-bold border-t-2 border-gray-200">
                        <td class="px-2 py-2 text-xs text-gray-900">Total</td>
                        <td class="px-2 py-2 text-xs text-gray-900 text-center">${total145}</td>
                        <td class="px-2 py-2 text-xs text-gray-900 text-center">${total4690}</td>
                        <td class="px-2 py-2 text-xs text-gray-900 text-center">${totalOver90}</td>
                        <td class="px-2 py-2 text-xs text-gray-900 text-center">${totalPastDue}</td>
                        <td class="px-2 py-2 text-xs text-gray-900 text-center">${totalPopulation}</td>
                        <td class="px-2 py-2 text-xs">
                            <div class="relative w-full h-4 bg-gray-200 rounded overflow-hidden">
                                <div class="absolute top-0 left-0 h-full bg-blue-600 rounded" style="width: ${totalPercentOfTotal}%"></div>
                                <span class="absolute inset-0 flex items-center justify-center text-xs font-bold text-white">${totalPercentOfTotal}%</span>
                                </div>
                        </td>
                    </tr>
                `;
            } else {
                const totalPercentOfTotal = totalPopulation > 0 ? ((totalComingDue / totalPopulation) * 100).toFixed(1) : 0;
                html += `
                    <tr class="bg-gray-50 font-bold border-t-2 border-gray-200">
                        <td class="px-2 py-2 text-xs text-gray-900">Total</td>
                        <td class="px-2 py-2 text-xs text-gray-900 text-center">${totalComingDue}</td>
                        <td class="px-2 py-2 text-xs text-gray-900 text-center">${totalComingDue}</td>
                        <td class="px-2 py-2 text-xs text-gray-900 text-center">${totalPopulation}</td>
                        <td class="px-2 py-2 text-xs">
                            <div class="relative w-full h-4 bg-gray-200 rounded overflow-hidden">
                                <div class="absolute top-0 left-0 h-full bg-green-600 rounded" style="width: ${totalPercentOfTotal}%"></div>
                                <span class="absolute inset-0 flex items-center justify-center text-xs font-bold text-white">${totalPercentOfTotal}%</span>
                            </div>
                        </td>
                    </tr>
                `;
            }
            
            tableBody.innerHTML = html;
            
            // Store regional data globally for potential use elsewhere
            window.covenantRegionalData = regionalData;
        }

        // Create the CCM regional stacked bar chart
        let ccmRegionalChartInstance = null;
        
        function createCCMRegionalChart() {
            console.log('Creating CCM regional stacked bar chart');
            
            const chartElement = document.getElementById("ccmRegionalChart");
            if (!chartElement) {
                console.error('Chart element "ccmRegionalChart" not found');
                return;
            }
            
            const allRegions = ['APAC', 'EMEA', 'NAM', 'LATAM'];
            
            // Filter out regions that have no data (all zeros)
            const regions = allRegions.filter(region => {
                const regionKey = region.toLowerCase();
                const total = (currentCCMData.pastDue[regionKey] || 0) + 
                              (currentCCMData.comingDue[regionKey] || 0) + 
                              (currentCCMData.open[regionKey] || 0);
                return total > 0;
            });
            
            // If no regions have data, show no data message
            if (regions.length === 0) {
                console.log('No CCM data available for any region');
                // Destroy existing chart if it exists
                if (ccmRegionalChartInstance) {
                    ccmRegionalChartInstance.destroy();
                    ccmRegionalChartInstance = null;
                }
                const ccmChartEl = document.querySelector("#ccmRegionalChart");
                if (ccmChartEl) {
                    ccmChartEl.innerHTML = generateNoDataMessage('Criticized/Classified Memos & Reviews');
                }
                return;
            }
            
            // Prepare series data from currentCCMData (only for regions with data)
            const series = [
                {
                    name: "Past Due",
                    data: regions.map(region => currentCCMData.pastDue[region.toLowerCase()] || 0)
                },
                {
                    name: "Coming Due",
                    data: regions.map(region => currentCCMData.comingDue[region.toLowerCase()] || 0)
                },
                {
                    name: "Open",
                    data: regions.map(region => currentCCMData.open[region.toLowerCase()] || 0)
                }
            ];
            
            const options = {
                series: series,
                colors: ["#2a31d8", "#465fff", "#7592ff"],
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "bar",
                    stacked: true,
                    height: "100%",
                    toolbar: {
                        show: false,
                    },
                    zoom: {
                        enabled: false,
                    },
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: "39%",
                        borderRadius: 10,
                        borderRadiusApplication: "end",
                        borderRadiusWhenStacked: "last",
                    },
                },
                dataLabels: {
                    enabled: true,
                    formatter: function (val) {
                        return val > 0 ? val : '';
                    },
                    style: {
                        fontSize: '12px',
                        fontWeight: 600,
                        colors: ['#fff']
                    },
                    dropShadow: {
                        enabled: false
                    }
                },
                xaxis: {
                    categories: regions,
                    axisBorder: {
                        show: false,
                    },
                    axisTicks: {
                        show: false,
                    },
                    labels: {
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                },
                legend: {
                    show: true,
                    position: "top",
                    horizontalAlign: "left",
                    fontFamily: "Outfit, sans-serif",
                    fontSize: "12px",
                    markers: {
                        size: 5,
                        shape: "circle",
                        radius: 999,
                        strokeWidth: 0,
                    },
                    itemMargin: {
                        horizontal: 10,
                        vertical: 0,
                    },
                },
                yaxis: {
                    title: false,
                    labels: {
                        align: 'left',
                        offsetX: -10,
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                },
                grid: {
                    yaxis: {
                        lines: {
                            show: true,
                        },
                    },
                },
                fill: {
                    opacity: 1,
                },
                tooltip: {
                    theme: "light",
                    style: {
                        fontSize: "12px",
                        fontFamily: "Outfit, sans-serif",
                    },
                    x: {
                        show: false,
                    },
                    y: {
                        formatter: function (val) {
                            return val + " CCMs";
                        },
                    },
                },
            };
            
            // Destroy existing chart if it exists
            if (ccmRegionalChartInstance) {
                ccmRegionalChartInstance.destroy();
            }
            
            chartElement.innerHTML = "";
            ccmRegionalChartInstance = new ApexCharts(chartElement, options);
            ccmRegionalChartInstance.render();
            console.log('CCM regional stacked chart rendered successfully');
        }

        // Make it globally accessible for Alpine.js
        window.updateCovenantChart = updateCovenantChart;

        // CCM (Credit Committee Memos) Functions
        let currentCCMData = {
            pastDue: { apac: 0, emea: 0, nam: 0, latam: 0 },
            comingDue: { apac: 0, emea: 0, nam: 0, latam: 0 },
            open: { apac: 0, emea: 0, nam: 0, latam: 0 }
        };

        // Calculate CCM stats by region and status
        function calculateCCMStats() {
            console.log(' Calculating CCM Stats');
            
            if (!ccmData || ccmData.length === 0) {
                console.warn('No CCM data available');
                return;
            }

            // Use reporting month instead of actual current date
            const { monthStart: reportingMonthStart, monthEnd: reportingMonthEnd, reportingMonth: repMonth } = getReportingMonthRange();
            
            // For CCM, use reporting month as the reference point
            const referenceDate = new Date(repMonth);
            referenceDate.setHours(0, 0, 0, 0);

            // Initialize counters
            const stats = {
                pastDue: { APAC: 0, EMEA: 0, NAM: 0, LATAM: 0 },
                comingDue: { APAC: 0, EMEA: 0, NAM: 0, LATAM: 0 },
                open: { APAC: 0, EMEA: 0, NAM: 0, LATAM: 0 }
            };

            ccmData.forEach(row => {
                const region = String(row.Region || "").trim().toUpperCase();
                // Use CCM_Status from dataLoader export if available
                const ccmStatus = String(row.CCM_Status || "").trim().toLowerCase();
                
                if (!region) return;
                
                // Ensure region is valid
                if (!['APAC', 'EMEA', 'NAM', 'LATAM'].includes(region)) return;
                
                // Apply region filter if active
                if (selectedRegion !== 'all' && region !== selectedRegion.toUpperCase()) return;

                // Use CCM_Status from dataLoader (already calculated based on Next_CCM_Approval_Date)
                if (ccmStatus === 'past due') {
                    stats.pastDue[region]++;
                } else if (ccmStatus === 'coming due') {
                    stats.comingDue[region]++;
                } else if (ccmStatus === 'open') {
                    stats.open[region]++;
                }
            });

            // Convert to lowercase for consistency
            currentCCMData = {
                pastDue: {
                    apac: stats.pastDue.APAC,
                    emea: stats.pastDue.EMEA,
                    nam: stats.pastDue.NAM,
                    latam: stats.pastDue.LATAM
                },
                comingDue: {
                    apac: stats.comingDue.APAC,
                    emea: stats.comingDue.EMEA,
                    nam: stats.comingDue.NAM,
                    latam: stats.comingDue.LATAM
                },
                open: {
                    apac: stats.open.APAC,
                    emea: stats.open.EMEA,
                    nam: stats.open.NAM,
                    latam: stats.open.LATAM
                }
            };

            console.log('CCM Stats calculated:', currentCCMData);
        }

        // Update CCM display based on selected filter
        function updateCCMStats(filter) {
            console.log('Updating CCM stats for filter:', filter);
            
            // Update the CCM chart
            createCCMRegionalChart();
        }

        // Make updateCCMStats globally accessible
        window.updateCCMStats = updateCCMStats;

        // Parse number that might be formatted (e.g., "5.5M", "1.2K", "1,000,000")
        function parseNumber(value) {
            if (!value) return 0;
            
            // If already a number, return it
            if (typeof value === "number") return value;
            
            // Convert to string and clean
            let str = String(value).trim().toUpperCase();
            
            // Remove currency symbols and commas
            str = str.replace(/[$,]/g, "");
            
            // Handle K (thousands)
            if (str.endsWith("K")) {
                return parseFloat(str.replace("K", "")) * 1000;
            }
            
            // Handle M (millions)
            if (str.endsWith("M")) {
                return parseFloat(str.replace("M", "")) * 1000000;
            }
            
            // Handle B (billions)
            if (str.endsWith("B")) {
                return parseFloat(str.replace("B", "")) * 1000000000;
            }
            
            // Regular number
            return parseFloat(str) || 0;
        }

        // Parse percentage values (handles "0.1%", "12.5%", or decimal 0.001)
        function parsePercentage(value) {
            if (!value && value !== 0) return 0;

            // If already a number
            if (typeof value === "number") {
                // If it's a small decimal (< 1), assume it's already in decimal form (0.001 = 0.1%)
                // and convert to percentage
                if (value < 1 && value > -1) {
                    return value * 100;
                }
                return value;
            }

            // Convert to string and clean
            let str = String(value).trim();

            // Remove commas
            str = str.replace(/,/g, "");

            // Handle percentage sign
            if (str.includes("%")) {
                // Remove % and parse - "0.1%" becomes 0.1
                return parseFloat(str.replace("%", "")) || 0;
            }

            // If no % sign, check if it's a small decimal
            const numValue = parseFloat(str);
            if (!isNaN(numValue)) {
                // If it's a small decimal (< 1), assume it's in decimal form and convert
                if (numValue < 1 && numValue > -1) {
                    return numValue * 100;
                }
                return numValue;
            }

            return 0;
        }
        
        // Get active filters text for display in no-data messages
        function getActiveFiltersText() {
            const filters = [];
            const addedFilters = new Set(); // Track to avoid duplicates
            
            // Smart filters
            if (selectedRegion !== 'all') {
                const key = `Region: ${selectedRegion}`;
                filters.push(key);
                addedFilters.add(key.toLowerCase());
            }
            if (!includePSE) {
                filters.push('PSE: Excluded');
            }
            if (selectedStatus !== 'all') {
                filters.push(`Status: ${selectedStatus}`);
            }
            if (selectedCommitmentStatus !== 'all') {
                filters.push(`Commitment: ${selectedCommitmentStatus}`);
            }
            
            // Advanced filters
            Object.entries(activeFilters).forEach(([label, value]) => {
                const key = `${label}: ${value}`;
                if (!addedFilters.has(key.toLowerCase())) {
                    filters.push(key);
                    addedFilters.add(key.toLowerCase());
                }
            });
            
            // Search term
            const searchTerm = document.getElementById('searchInput')?.value?.trim();
            if (searchTerm && searchTerm.length > 0) {
                filters.push(`Search: "${searchTerm}"`);
            }
            
            // Chart filter (avoid duplicates)
            if (chartFilter.active) {
                const chartFilterKey = `${chartFilter.type}: ${chartFilter.value}`;
                if (!addedFilters.has(chartFilterKey.toLowerCase())) {
                    filters.push(chartFilterKey);
                }
            }
            
            return filters;
        }
        
        // Generate consistent "no data" HTML message with active filters
        function generateNoDataMessage(chartTitle = '') {
            const filters = getActiveFiltersText();
            
            let html = '<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; min-width: 200px; min-height: 280px; height: 100%; text-align: center; padding: 1.5rem; box-sizing: border-box;">';
            html += '<svg style="width: 48px; height: 48px; margin-bottom: 12px;" fill="none" stroke="#d1d5db" viewBox="0 0 24 24">';
            html += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>';
            html += '</svg>';
            html += '<p style="font-size: 14px; font-weight: 500; color: #4b5563; margin: 0 0 4px 0;">No data available' + (chartTitle ? ' for ' + chartTitle : '') + '</p>';
            
            if (filters.length > 0) {
                html += '<p style="font-size: 12px; color: #9ca3af; max-width: 280px; margin: 0;">Applied filters: ' + filters.join(', ') + '</p>';
            } else {
                html += '<p style="font-size: 12px; color: #9ca3af; margin: 0;">No filters applied</p>';
            }
            
            html += '</div>';
            return html;
        }
        
        // Format currency with M/B notation
        function formatCurrency(value) {
            if (!value || value === 0) return "$0";
            
            const absValue = Math.abs(value);
            
            // Billions
            if (absValue >= 1000000000) {
                return "$" + (value / 1000000000).toFixed(2) + "B";
            }
            
            // Millions
            if (absValue >= 1000000) {
                return "$" + (value / 1000000).toFixed(2) + "M";
            }
            
            // Thousands
            if (absValue >= 1000) {
                return "$" + (value / 1000).toFixed(2) + "K";
            }
            
            // Less than 1000
            return "$" + value.toFixed(2);
        }
        
        // Format currency for detailed display (with commas)
        function formatCurrencyDetailed(value) {
            return new Intl.NumberFormat("en-US", {
                style: "currency",
                currency: "USD",
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            }).format(value);
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return "N/A";
            const date = parseDate(dateString);
            if (!date) return "N/A";
            return date.toLocaleDateString("en-US", {
                year: "numeric",
                month: "short",
                day: "numeric",
            });
        }

        // Create expiration timeline chart (Area chart for Facilities only)
        function createExpirationChart() {
            console.log(" Creating facilities expired & expiring bar chart");
            
            // Get the current reporting month from the data
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Generate next 3 months starting from current month
            const next3Months = [];
            for (let i = 0; i < 3; i++) {
                const date = new Date(today);
                date.setMonth(date.getMonth() + i);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, "0");
                next3Months.push(`${year}-${month}`);
            }
            
            console.log("Next 3 months starting from current:", next3Months);
            
            // Group by month-year and categorize as expired or expiring
            const monthlyData = {};
            
            // Initialize all 3 months
            next3Months.forEach((monthYear) => {
                monthlyData[monthYear] = {
                    expired: [],
                    expiring: [],
                };
            });
            
            portfolioData.forEach((row) => {
                const maturityDate = row.Maturity_Date;
                const facilityId = row.Facility_ID;
                
                if (maturityDate && facilityId) {
                    const dateObj = parseDate(maturityDate);
                    if (dateObj) {
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthYear = `${year}-${month}`;
                        
                        // Only include if it's in our next 3 months
                        if (next3Months.includes(monthYear)) {
                            // Categorize based on whether date is past or future
                            if (dateObj < today) {
                                monthlyData[monthYear].expired.push(facilityId);
                            } else {
                                monthlyData[monthYear].expiring.push(facilityId);
                            }
                        }
                    }
                }
            });
            
            // Prepare data for the next 3 months
            const categories = next3Months.map((m) => {
                const date = new Date(m + "-01");
                return date.toLocaleDateString("en-US", { month: "short" });
            });

            const expiredData = next3Months.map(
                (month) => monthlyData[month].expired.length
            );
            const expiringData = next3Months.map(
                (month) => monthlyData[month].expiring.length
            );

            console.log("Expired:", expiredData);
            console.log("Expiring:", expiringData);
            
            const options = {
                series: [
                    {
                        name: "Expired",
                        data: expiredData,
                    },
                    {
                        name: "Expiring",
                        data: expiringData,
                    },
                ],
                colors: ["#93a8ff", "#465fff"],
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "bar",
                    stacked: false,
                    height: "100%",
                    toolbar: {
                        show: false,
                    },
                    zoom: {
                        enabled: false,
                    },
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: "55%",
                        borderRadius: 8,
                        borderRadiusApplication: "end",
                        dataLabels: {
                            position: 'top',
                        },
                    },
                },
                dataLabels: {
                    enabled: true,
                    offsetY: -30,
                    style: {
                        fontSize: '11px',
                        fontWeight: 500,
                        colors: ['#374151']
                    },
                    background: {
                        enabled: true,
                        foreColor: '#374151',
                        backgroundColor: '#F3F4F6',
                        borderRadius: 12,
                        padding: 8,
                        opacity: 1,
                        borderWidth: 0
                    },
                    formatter: function(val, opts) {
                        return val;
                    }
                },
                xaxis: {
                    categories: categories,
                    axisBorder: {
                        show: false,
                    },
                    axisTicks: {
                        show: false,
                    },
                    labels: {
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                },
                legend: {
                    show: true,
                    position: "top",
                    horizontalAlign: "left",
                    fontFamily: "Outfit, sans-serif",
                    fontSize: "12px",
                    markers: {
                        size: 5,
                        shape: "circle",
                        radius: 999,
                        strokeWidth: 0,
                    },
                    itemMargin: {
                        horizontal: 10,
                        vertical: 0,
                    },
                },
                yaxis: {
                    title: false,
                    labels: {
                        align: 'left',
                        offsetX: -10,
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                },
                grid: {
                    xaxis: {
                        lines: {
                            show: true,
                        },
                    },
                    yaxis: {
                        lines: {
                            show: false,
                        },
                    },
                },
                fill: {
                    opacity: 1,
                },
                tooltip: {
                    theme: "light",
                    style: {
                        fontSize: "12px",
                        fontFamily: "Outfit, sans-serif",
                    },
                    x: {
                        show: false,
                    },
                    y: {
                        formatter: function (val) {
                            return val + " facilities";
                        },
                    },
                },
            };

            // Get the chart element and verify it exists
            const chartElement = document.querySelector("#facilityMaturityChart");
            if (!chartElement) {
                console.error(
                    "Facility maturity chart element #facilityMaturityChart not found in DOM"
                );
                return;
            }
            
            // Check if ApexCharts is loaded
            if (typeof ApexCharts === "undefined") {
                console.error("ApexCharts library not loaded yet. Retrying...");
                setTimeout(createExpirationChart, 500);
                return;
            }
            
            try {
                // Destroy existing chart if it exists
                if (facilityMaturityChartInstance) {
                    facilityMaturityChartInstance.destroy();
                    facilityMaturityChartInstance = null;
                }
                
                // Clear the element
                chartElement.innerHTML = "";
                
                // Create and render new chart
                facilityMaturityChartInstance = new ApexCharts(chartElement, options);
                facilityMaturityChartInstance.render();
                console.log(" Facility maturity chart rendered successfully");
            } catch (error) {
                console.error(" Error rendering facility maturity chart:", error);
            }
        }

        // Helper: Check if a date is the last business day of the month
        function checkIfLastBusinessDayOfMonth(date) {
            const testDate = new Date(date);
            const year = testDate.getFullYear();
            const month = testDate.getMonth();
            
            // Get the last day of the month
            const lastDayOfMonth = new Date(year, month + 1, 0);
            
            // Find the last business day (skip weekends going backwards)
            let lastBusinessDay = new Date(lastDayOfMonth);
            while (lastBusinessDay.getDay() === 0 || lastBusinessDay.getDay() === 6) {
                lastBusinessDay.setDate(lastBusinessDay.getDate() - 1);
            }
            
            // Compare dates (ignore time)
            testDate.setHours(0, 0, 0, 0);
            lastBusinessDay.setHours(0, 0, 0, 0);
            
            return testDate.getTime() === lastBusinessDay.getTime();
        }

        // Helper: Get weekend dates after the report date in the same month
        function getWeekendDatesAfterReportDate(reportDate) {
            const excludedDates = [];
            const year = reportDate.getFullYear();
            const month = reportDate.getMonth();
            const lastDayOfMonth = new Date(year, month + 1, 0).getDate();
            
            // Check dates after report date until end of month
            for (let day = reportDate.getDate() + 1; day <= lastDayOfMonth; day++) {
                const checkDate = new Date(year, month, day);
                const dayOfWeek = checkDate.getDay();
                
                // If it's Saturday (6) or Sunday (0), add to excluded list
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    excludedDates.push(new Date(checkDate));
                }
            }
            
            return excludedDates;
        }

        // Helper: Check if a date is in the excluded weekend dates list
        function isDateInExcludedList(dateToCheck, excludedDates) {
            if (!excludedDates || excludedDates.length === 0) return false;
            
            const checkTime = new Date(dateToCheck);
            checkTime.setHours(0, 0, 0, 0);
            
            return excludedDates.some(excludedDate => {
                const excludedTime = new Date(excludedDate);
                excludedTime.setHours(0, 0, 0, 0);
                return checkTime.getTime() === excludedTime.getTime();
            });
        }

        // Create combined chart for CAs Coming Due & Facilities Expiring
        function createFacilityTrendChart() {
            console.log(" Creating CAs Coming Due & Facilities Expiring chart");
            
            // Check if we have data
            if (!portfolioData || portfolioData.length === 0) {
                console.log(" No portfolio data available for CAs & Facilities Expiring chart");
                const chartElement = document.querySelector("#facilityTrendChart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('CAs & Facilities Expiring');
                }
                return;
            }
            
            // Get the current reporting month from the data
            const reportDates = portfolioData
                .map((row) => parseDate(row.Report_Date))
                .filter((d) => d);
            if (reportDates.length === 0) {
                console.log(" No valid report dates found");
                return;
            }
            const maxReportDate = new Date(Math.max(...reportDates));
            maxReportDate.setHours(0, 0, 0, 0);
            
            // Check if report date is last business day of the month
            const isLastBusinessDay = checkIfLastBusinessDayOfMonth(maxReportDate);
            
            // Get excluded weekend dates (if report date is last business day AND there are weekends after it)
            const excludedWeekendDates = isLastBusinessDay ? getWeekendDatesAfterReportDate(maxReportDate) : [];
            
            // Generate next 3 months starting from report date
            // ONLY skip current month if there are actual weekend dates to exclude
            const startMonthOffset = (excludedWeekendDates.length > 0) ? 1 : 0;
            const next3Months = [];
            for (let i = 0; i < 3; i++) {
                const date = new Date(maxReportDate);
                date.setMonth(date.getMonth() + startMonthOffset + i);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, "0");
                next3Months.push(`${year}-${month}`);
            }
            
            console.log("Next 3 months starting from report date:", next3Months, "Report Date:", maxReportDate, "Is Last Business Day:", isLastBusinessDay, "Excluded Weekend Dates:", excludedWeekendDates, "Has Excluded Dates:", excludedWeekendDates.length > 0);
            
            // Group by month-year for both CAs and Facilities
            const monthlyData = {};
            
            // Initialize all 3 months
            next3Months.forEach((monthYear) => {
                monthlyData[monthYear] = {
                    casComingDueByRelationship: new Set(), // Unique Relationship_IDs for all regions
                    facilitiesExpiring: new Set(), // Unique Facility IDs
                    caAmounts: { tfa: 0, direct: 0, contingent: 0, pse: 0 },
                    facilityAmounts: { tfa: 0, direct: 0, contingent: 0, pse: 0 },
                };
            });
            
            // Collect CAs Coming Due (only future dates from report date, exclude DM)
            // Use unique Relationship_IDs for all regions (EMEA requires CA_Review = "Yes")
            // Exclude weekend dates if report date is last business day of month
            portfolioData.forEach((row) => {
                const caExpirationDate = row.CA_Expiration_Date;
                const managementStatus = (row.Management_Status || "").toUpperCase();
                const region = (row.Region || "").toUpperCase();
                const caReview = (row.CA_Review || "").trim();
                
                if (caExpirationDate && managementStatus !== "DM") {
                    const dateObj = parseDate(caExpirationDate);
                    if (dateObj && dateObj >= maxReportDate) {
                        // Skip if this date is in the excluded weekend dates
                        if (isDateInExcludedList(dateObj, excludedWeekendDates)) {
                            return;
                        }
                        
                        // Only future dates (coming due from report date)
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthYear = `${year}-${month}`;
                        
                        // Only include if it's in our next 3 months
                        if (next3Months.includes(monthYear)) {
                            // For EMEA: require CA_Review = "Yes"
                            // For all other regions: count all CAs
                            // All regions use unique Relationship_IDs
                            if (region === "EMEA") {
                                if (caReview === "Yes" && row.Relationship_ID) {
                                    monthlyData[monthYear].casComingDueByRelationship.add(row.Relationship_ID);
                                    // Accumulate amounts for EMEA CAs (sum ALL lines)
                                    monthlyData[monthYear].caAmounts.tfa += parseNumber(
                                        row.Fac_Amount || row.Facility_Amount
                                    );
                                    monthlyData[monthYear].caAmounts.direct += parseNumber(
                                        row.Direct_OS
                                    );
                                    monthlyData[monthYear].caAmounts.contingent += parseNumber(
                                        row.Contingent_OS
                                    );
                                    monthlyData[monthYear].caAmounts.pse += parseNumber(row.PSE_OS);
                                }
                            } else {
                                // For non-EMEA: count unique Relationship_IDs
                                if (row.Relationship_ID) {
                                    monthlyData[monthYear].casComingDueByRelationship.add(row.Relationship_ID);
                                    // Accumulate amounts for non-EMEA CAs (sum ALL lines)
                                    monthlyData[monthYear].caAmounts.tfa += parseNumber(
                                        row.Fac_Amount || row.Facility_Amount
                                    );
                                    monthlyData[monthYear].caAmounts.direct += parseNumber(
                                        row.Direct_OS
                                    );
                                    monthlyData[monthYear].caAmounts.contingent += parseNumber(
                                        row.Contingent_OS
                                    );
                                    monthlyData[monthYear].caAmounts.pse += parseNumber(row.PSE_OS);
                                }
                            }
                        }
                    }
                }
            });
            
            // Collect Facilities Expiring (only future dates from report date, exclude DM)
            // Exclude weekend dates if report date is last business day of month
            portfolioData.forEach((row) => {
                const maturityDate = row.Maturity_Date;
                const facilityId = row.Facility_ID;
                const managementStatus = (row.Management_Status || "").toUpperCase();
                
                if (maturityDate && facilityId && managementStatus !== "DM") {
                    const dateObj = parseDate(maturityDate);
                    if (dateObj && dateObj >= maxReportDate) {
                        // Skip if this date is in the excluded weekend dates
                        if (isDateInExcludedList(dateObj, excludedWeekendDates)) {
                            return;
                        }
                        
                        // Only future dates (expiring from report date)
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthYear = `${year}-${month}`;
                        
                        // Only include if it's in our next 3 months
                        if (next3Months.includes(monthYear)) {
                            monthlyData[monthYear].facilitiesExpiring.add(facilityId); // Use add for Set
                            // Accumulate amounts for Facilities (sum ALL lines)
                            monthlyData[monthYear].facilityAmounts.tfa += parseNumber(
                                row.Fac_Amount || row.Facility_Amount
                            );
                            monthlyData[monthYear].facilityAmounts.direct += parseNumber(
                                row.Direct_OS
                            );
                            monthlyData[monthYear].facilityAmounts.contingent +=
                                parseNumber(row.Contingent_OS);
                            monthlyData[monthYear].facilityAmounts.pse += parseNumber(
                                row.PSE_OS
                            );
                        }
                    }
                }
            });
            
            // Prepare data for the next 3 months
            const categories = next3Months.map((m) => {
                const date = new Date(m + "-01");
                return date.toLocaleDateString("en-US", { month: "short" });
            });

            const casComingDueData = next3Months.map(
                (month) => monthlyData[month].casComingDueByRelationship.size
            );
            const facilitiesExpiringData = next3Months.map(
                (month) => monthlyData[month].facilitiesExpiring.size // Changed from .length to .size
            );

            console.log("CAs Coming Due:", casComingDueData);
            console.log("Facilities Expiring:", facilitiesExpiringData);

            // Check if all data is empty
            const totalCAs = casComingDueData.reduce((sum, val) => sum + val, 0);
            const totalFacilities = facilitiesExpiringData.reduce((sum, val) => sum + val, 0);

            if (totalCAs === 0 && totalFacilities === 0) {
                console.log(" No expiration data available");
                const chartElement = document.querySelector("#facilityTrendChart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('CAs & Facilities Expiring');
                }
                return;
            }
            
            const options = {
                series: [
                    {
                        name: "CAs Coming Due",
                        data: casComingDueData,
                    },
                    {
                        name: "Facilities Expiring",
                        data: facilitiesExpiringData,
                    },
                ],
                colors: ["#93a8ff", "#465fff"],
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "bar",
                    stacked: false,
                    height: "100%",
                    toolbar: {
                        show: false,
                    },
                    zoom: {
                        enabled: false,
                    },
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: "55%",
                        borderRadius: 8,
                        borderRadiusApplication: "end",
                        dataLabels: {
                            position: 'top',
                        },
                    },
                },
                dataLabels: {
                    enabled: true,
                    offsetY: -30,
                    style: {
                        fontSize: '11px',
                        fontWeight: 500,
                        colors: ['#374151']
                    },
                    background: {
                        enabled: true,
                        foreColor: '#374151',
                        backgroundColor: '#F3F4F6',
                        borderRadius: 12,
                        padding: 8,
                        opacity: 1,
                        borderWidth: 0
                    },
                    formatter: function(val, opts) {
                        return val;
                    }
                },
                xaxis: {
                    categories: categories,
                    axisBorder: {
                        show: false,
                    },
                    axisTicks: {
                        show: false,
                    },
                },
                legend: {
                    show: true,
                    position: "top",
                    horizontalAlign: "left",
                    markers: {
                        size: 5,
                        shape: "circle",
                        radius: 999,
                        strokeWidth: 0,
                    },
                    itemMargin: {
                        horizontal: 10,
                        vertical: 0,
                    },
                },
                yaxis: {
                    title: false,
                    labels: {
                        align: 'left',
                        offsetX: -10,
                    },
                },
                grid: {
                    yaxis: {
                        lines: {
                            show: true,
                        },
                    },
                },
                fill: {
                    opacity: 1,
                },
                tooltip: {
                    theme: "light",
                    shared: true,
                    intersect: false,
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        const monthKey = next3Months[dataPointIndex];
                        const monthData = monthlyData[monthKey];
                        const monthName = categories[dataPointIndex];
                        
                        let html = `<div class="apexcharts-tooltip-custom" style="padding: 12px; min-width: 200px; background: #ffffff; color: #1f2937; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border: 1px solid #e5e7eb;">`;
                        html += `<div style="font-weight: 600; margin-bottom: 8px; font-size: 13px; color: #1f2937;">${monthName}</div>`;
                        
                        // CAs Coming Due (unique Relationship_IDs for all regions)
                        const casCount = monthData.casComingDueByRelationship.size;
                        if (casCount > 0) {
                            html += `<div style="margin-bottom: 6px;">`;
                            html += `<div style="display: flex; align-items: center; margin-bottom: 4px;">`;
                            html += `<span style="width: 8px; height: 8px; background: #93a8ff; border-radius: 50%; margin-right: 6px;"></span>`;
                            html += `<span style="font-weight: 500;">CAs Coming Due: ${casCount}</span>`;
                            html += `</div>`;
                            html += `<div style="padding-left: 14px; font-size: 11px; color: #666;">`;
                            html += `<div>TFA: ${formatCurrency(
                                monthData.caAmounts.tfa
                            )}</div>`;
                            html += `<div>Direct: ${formatCurrency(
                                monthData.caAmounts.direct
                            )}</div>`;
                            if (monthData.caAmounts.contingent > 0) {
                                html += `<div>Contingent: ${formatCurrency(
                                    monthData.caAmounts.contingent
                                )}</div>`;
                            }
                            if (monthData.caAmounts.pse > 0) {
                                html += `<div>Presettlement Exposure: ${formatCurrency(
                                    monthData.caAmounts.pse
                                )}</div>`;
                            }
                            html += `</div></div>`;
                        }
                        
                        // Facilities Expiring
                        const facilitiesCount = monthData.facilitiesExpiring.size; // Changed from .length to .size
                        if (facilitiesCount > 0) {
                            html += `<div>`;
                            html += `<div style="display: flex; align-items: center; margin-bottom: 4px;">`;
                            html += `<span style="width: 8px; height: 8px; background: #465fff; border-radius: 50%; margin-right: 6px;"></span>`;
                            html += `<span style="font-weight: 500;">Facilities Expiring: ${facilitiesCount}</span>`;
                            html += `</div>`;
                            html += `<div style="padding-left: 14px; font-size: 11px; color: #666;">`;
                            html += `<div>TFA: ${formatCurrency(
                                monthData.facilityAmounts.tfa
                            )}</div>`;
                            html += `<div>Direct: ${formatCurrency(
                                monthData.facilityAmounts.direct
                            )}</div>`;
                            if (monthData.facilityAmounts.contingent > 0) {
                                html += `<div>Contingent: ${formatCurrency(
                                    monthData.facilityAmounts.contingent
                                )}</div>`;
                            }
                            if (monthData.facilityAmounts.pse > 0) {
                                html += `<div>Presettlement Exposure: ${formatCurrency(
                                    monthData.facilityAmounts.pse
                                )}</div>`;
                            }
                            html += `</div></div>`;
                        }
                        
                        html += `</div>`;
                        return html;
                    },
                },
            };

            // Get the chart element and verify it exists
            const chartElement = document.querySelector("#facilityTrendChart");
            if (!chartElement) {
                console.error(
                    "Facility trend chart element #facilityTrendChart not found in DOM"
                );
                return;
            }
            
            // Verify ApexCharts is loaded
            if (typeof ApexCharts === "undefined") {
                console.error("ApexCharts library not loaded");
                chartElement.innerHTML = generateNoDataMessage('CAs & Facilities Expiring');
                return;
            }
            
            try {
                // Destroy previous instance
                if (facilityTrendChartInstance) {
                    facilityTrendChartInstance.destroy();
                    facilityTrendChartInstance = null;
                }
                
                // Clear any previous content
                chartElement.innerHTML = "";
                
                // Create and render new chart
                facilityTrendChartInstance = new ApexCharts(chartElement, options);
                facilityTrendChartInstance.render();
                console.log(" Facility trend chart rendered successfully");
            } catch (error) {
                console.error(" Error rendering facility trend chart:", error);
                chartElement.innerHTML = generateNoDataMessage('CAs & Facilities Expiring');
            }
        }

        // Create combined chart for CAs Coming Due & Facilities Expiring from filtered data
        function createFacilityTrendChartFromFiltered() {
            console.log(
                " Creating filtered CAs Coming Due & Facilities Expiring chart"
            );
            
            // Check if we have filtered data
            if (!filteredData || filteredData.length === 0) {
                console.log(" No filtered data available for CAs & Facilities Expiring chart");
                const chartElement = document.querySelector("#facilityTrendChart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('CAs & Facilities Expiring');
                }
                return;
            }
            
            // Get the current reporting month from the data
            const reportDates = filteredData
                .map((row) => parseDate(row.Report_Date))
                .filter((d) => d);
            if (reportDates.length === 0) {
                console.log(" No valid report dates found in filtered data");
                return;
            }
            const maxReportDate = new Date(Math.max(...reportDates));
            maxReportDate.setHours(0, 0, 0, 0);
            
            // Check if report date is last business day of the month
            const isLastBusinessDay = checkIfLastBusinessDayOfMonth(maxReportDate);
            
            // Get excluded weekend dates (if report date is last business day AND there are weekends after it)
            const excludedWeekendDates = isLastBusinessDay ? getWeekendDatesAfterReportDate(maxReportDate) : [];
            
            // Generate next 3 months starting from report date
            // ONLY skip current month if there are actual weekend dates to exclude
            const startMonthOffset = (excludedWeekendDates.length > 0) ? 1 : 0;
            const next3Months = [];
            for (let i = 0; i < 3; i++) {
                const date = new Date(maxReportDate);
                date.setMonth(date.getMonth() + startMonthOffset + i);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, "0");
                next3Months.push(`${year}-${month}`);
            }
            
            // Group by month-year for both CAs and Facilities
            const monthlyData = {};
            
            // Initialize all 3 months
            next3Months.forEach((monthYear) => {
                monthlyData[monthYear] = {
                    casComingDueByRelationship: new Set(), // Unique Relationship_IDs for all regions
                    facilitiesExpiring: new Set(), // Unique Facility IDs
                    caAmounts: { tfa: 0, direct: 0, contingent: 0, pse: 0 },
                    facilityAmounts: { tfa: 0, direct: 0, contingent: 0, pse: 0 },
                };
            });
            
            // Collect CAs Coming Due (only future dates from report date, exclude DM)
            // Use unique Relationship_IDs for all regions (EMEA requires CA_Review = "Yes")
            // Exclude weekend dates if report date is last business day of month
            filteredData.forEach((row) => {
                const caExpirationDate = row.CA_Expiration_Date;
                const managementStatus = (row.Management_Status || "").toUpperCase();
                const region = (row.Region || "").toUpperCase();
                const caReview = (row.CA_Review || "").trim();
                
                if (caExpirationDate && managementStatus !== "DM") {
                    const dateObj = parseDate(caExpirationDate);
                    if (dateObj && dateObj >= maxReportDate) {
                        // Skip if this date is in the excluded weekend dates
                        if (isDateInExcludedList(dateObj, excludedWeekendDates)) {
                            return;
                        }
                        
                        // Only future dates (coming due from report date)
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthYear = `${year}-${month}`;
                        
                        // Only include if it's in our next 3 months
                        if (next3Months.includes(monthYear)) {
                            // For EMEA: require CA_Review = "Yes"
                            // For all other regions: count all CAs
                            // All regions use unique Relationship_IDs
                            if (region === "EMEA") {
                                if (caReview === "Yes" && row.Relationship_ID) {
                                    monthlyData[monthYear].casComingDueByRelationship.add(row.Relationship_ID);
                                    // Accumulate amounts for EMEA CAs (sum ALL lines)
                                    monthlyData[monthYear].caAmounts.tfa += parseNumber(
                                        row.Fac_Amount || row.Facility_Amount
                                    );
                                    monthlyData[monthYear].caAmounts.direct += parseNumber(
                                        row.Direct_OS
                                    );
                                    monthlyData[monthYear].caAmounts.contingent += parseNumber(
                                        row.Contingent_OS
                                    );
                                    monthlyData[monthYear].caAmounts.pse += parseNumber(row.PSE_OS);
                                }
                            } else {
                                // For non-EMEA: count unique Relationship_IDs
                                if (row.Relationship_ID) {
                                    monthlyData[monthYear].casComingDueByRelationship.add(row.Relationship_ID);
                                    // Accumulate amounts for non-EMEA CAs (sum ALL lines)
                                    monthlyData[monthYear].caAmounts.tfa += parseNumber(
                                        row.Fac_Amount || row.Facility_Amount
                                    );
                                    monthlyData[monthYear].caAmounts.direct += parseNumber(
                                        row.Direct_OS
                                    );
                                    monthlyData[monthYear].caAmounts.contingent += parseNumber(
                                        row.Contingent_OS
                                    );
                                    monthlyData[monthYear].caAmounts.pse += parseNumber(row.PSE_OS);
                                }
                            }
                        }
                    }
                }
            });
            
            // Collect Facilities Expiring (only future dates from report date, exclude DM)
            // Exclude weekend dates if report date is last business day of month
            filteredData.forEach((row) => {
                const maturityDate = row.Maturity_Date;
                const facilityId = row.Facility_ID;
                const managementStatus = (row.Management_Status || "").toUpperCase();
                
                if (maturityDate && facilityId && managementStatus !== "DM") {
                    const dateObj = parseDate(maturityDate);
                    if (dateObj && dateObj >= maxReportDate) {
                        // Skip if this date is in the excluded weekend dates
                        if (isDateInExcludedList(dateObj, excludedWeekendDates)) {
                            return;
                        }
                        
                        // Only future dates (expiring from report date)
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthYear = `${year}-${month}`;
                        
                        // Only include if it's in our next 3 months
                        if (next3Months.includes(monthYear)) {
                            monthlyData[monthYear].facilitiesExpiring.add(facilityId); // Use add for Set
                            // Accumulate amounts for Facilities (sum ALL lines)
                            monthlyData[monthYear].facilityAmounts.tfa += parseNumber(
                                row.Fac_Amount || row.Facility_Amount
                            );
                            monthlyData[monthYear].facilityAmounts.direct += parseNumber(
                                row.Direct_OS
                            );
                            monthlyData[monthYear].facilityAmounts.contingent +=
                                parseNumber(row.Contingent_OS);
                            monthlyData[monthYear].facilityAmounts.pse += parseNumber(
                                row.PSE_OS
                            );
                        }
                    }
                }
            });
            
            // Prepare data for the next 3 months
            const categories = next3Months.map((m) => {
                const date = new Date(m + "-01");
                return date.toLocaleDateString("en-US", { month: "short" });
            });

            const casComingDueData = next3Months.map(
                (month) => monthlyData[month].casComingDueByRelationship.size
            );
            const facilitiesExpiringData = next3Months.map(
                (month) => monthlyData[month].facilitiesExpiring.size // Changed from .length to .size
            );

            // Check if all data is empty
            const totalCAs = casComingDueData.reduce((sum, val) => sum + val, 0);
            const totalFacilities = facilitiesExpiringData.reduce((sum, val) => sum + val, 0);

            if (totalCAs === 0 && totalFacilities === 0) {
                console.log(" No expiration data available for filtered results");
                const chartElement = document.querySelector("#facilityTrendChart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('CAs & Facilities Expiring');
                }
                return;
            }
            
            const options = {
                series: [
                    {
                        name: "CAs Coming Due",
                        data: casComingDueData,
                    },
                    {
                        name: "Facilities Expiring",
                        data: facilitiesExpiringData,
                    },
                ],
                colors: ["#93a8ff", "#465fff"],
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "bar",
                    stacked: false,
                    height: "100%",
                    toolbar: {
                        show: false,
                    },
                    zoom: {
                        enabled: false,
                    },
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: "55%",
                        borderRadius: 8,
                        borderRadiusApplication: "end",
                        dataLabels: {
                            position: 'top',
                        },
                    },
                },
                dataLabels: {
                    enabled: true,
                    offsetY: -30,
                    style: {
                        fontSize: '11px',
                        fontWeight: 500,
                        colors: ['#374151']
                    },
                    background: {
                        enabled: true,
                        foreColor: '#374151',
                        backgroundColor: '#F3F4F6',
                        borderRadius: 12,
                        padding: 8,
                        opacity: 1,
                        borderWidth: 0
                    },
                    formatter: function(val, opts) {
                        return val;
                    }
                },
                xaxis: {
                    categories: categories,
                    axisBorder: {
                        show: false,
                    },
                    axisTicks: {
                        show: false,
                    },
                },
                legend: {
                    show: true,
                    position: "top",
                    horizontalAlign: "left",
                    markers: {
                        size: 5,
                        shape: "circle",
                        radius: 999,
                        strokeWidth: 0,
                    },
                    itemMargin: {
                        horizontal: 10,
                        vertical: 0,
                    },
                },
                yaxis: {
                    title: false,
                    labels: {
                        align: 'left',
                        offsetX: -10,
                    },
                },
                grid: {
                    yaxis: {
                        lines: {
                            show: true,
                        },
                    },
                },
                fill: {
                    opacity: 1,
                },
                tooltip: {
                    theme: "light",
                    shared: true,
                    intersect: false,
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        const monthKey = next3Months[dataPointIndex];
                        const monthData = monthlyData[monthKey];
                        const monthName = categories[dataPointIndex];
                        
                        let html = `<div class="apexcharts-tooltip-custom" style="padding: 12px; min-width: 200px; background: #ffffff; color: #1f2937; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border: 1px solid #e5e7eb;">`;
                        html += `<div style="font-weight: 600; margin-bottom: 8px; font-size: 13px; color: #1f2937;">${monthName}</div>`;
                        
                        // CAs Coming Due (unique Relationship_IDs for all regions)
                        const casCount = monthData.casComingDueByRelationship.size;
                        if (casCount > 0) {
                            html += `<div style="margin-bottom: 6px;">`;
                            html += `<div style="display: flex; align-items: center; margin-bottom: 4px;">`;
                            html += `<span style="width: 8px; height: 8px; background: #93a8ff; border-radius: 50%; margin-right: 6px;"></span>`;
                            html += `<span style="font-weight: 500;">CAs Coming Due: ${casCount}</span>`;
                            html += `</div>`;
                            html += `<div style="padding-left: 14px; font-size: 11px; color: #666;">`;
                            html += `<div>TFA: ${formatCurrency(
                                monthData.caAmounts.tfa
                            )}</div>`;
                            html += `<div>Direct: ${formatCurrency(
                                monthData.caAmounts.direct
                            )}</div>`;
                            if (monthData.caAmounts.contingent > 0) {
                                html += `<div>Contingent: ${formatCurrency(
                                    monthData.caAmounts.contingent
                                )}</div>`;
                            }
                            if (monthData.caAmounts.pse > 0) {
                                html += `<div>Presettlement Exposure: ${formatCurrency(
                                    monthData.caAmounts.pse
                                )}</div>`;
                            }
                            html += `</div></div>`;
                        }
                        
                        // Facilities Expiring
                        const facilitiesCount = monthData.facilitiesExpiring.size; // Changed from .length to .size
                        if (facilitiesCount > 0) {
                            html += `<div>`;
                            html += `<div style="display: flex; align-items: center; margin-bottom: 4px;">`;
                            html += `<span style="width: 8px; height: 8px; background: #465fff; border-radius: 50%; margin-right: 6px;"></span>`;
                            html += `<span style="font-weight: 500;">Facilities Expiring: ${facilitiesCount}</span>`;
                            html += `</div>`;
                            html += `<div style="padding-left: 14px; font-size: 11px; color: #666;">`;
                            html += `<div>TFA: ${formatCurrency(
                                monthData.facilityAmounts.tfa
                            )}</div>`;
                            html += `<div>Direct: ${formatCurrency(
                                monthData.facilityAmounts.direct
                            )}</div>`;
                            if (monthData.facilityAmounts.contingent > 0) {
                                html += `<div>Contingent: ${formatCurrency(
                                    monthData.facilityAmounts.contingent
                                )}</div>`;
                            }
                            if (monthData.facilityAmounts.pse > 0) {
                                html += `<div>Presettlement Exposure: ${formatCurrency(
                                    monthData.facilityAmounts.pse
                                )}</div>`;
                            }
                            html += `</div></div>`;
                        }
                        
                        html += `</div>`;
                        return html;
                    },
                },
            };

            const chartElement = document.querySelector("#facilityTrendChart");
            if (!chartElement) {
                console.error("Facility trend chart element not found");
                return;
            }
            
            if (typeof ApexCharts === "undefined") {
                console.error("ApexCharts library not loaded");
                chartElement.innerHTML = generateNoDataMessage('CAs & Facilities Expiring');
                return;
            }
            
            try {
                if (facilityTrendChartInstance) {
                    facilityTrendChartInstance.destroy();
                    facilityTrendChartInstance = null;
                }
                
                chartElement.innerHTML = "";
                
                facilityTrendChartInstance = new ApexCharts(chartElement, options);
                facilityTrendChartInstance.render();
                console.log(" Filtered facility trend chart rendered successfully");
            } catch (error) {
                console.error(
                    " Error rendering filtered facility trend chart:",
                    error
                );
                chartElement.innerHTML = generateNoDataMessage('CAs & Facilities Expiring');
            }
        }

        // Parse date in multiple formats (YYYY-MM-DD, DD/MM/YYYY, etc.)
        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            // If it's already a Date object (from Excel parsing), return it
            if (dateStr instanceof Date) {
                return !isNaN(dateStr.getTime()) ? dateStr : null;
            }
            
            // Convert to string for parsing
            const str = String(dateStr).trim();
            if (!str) return null;
            
            try {
                // Handle YYYY-MM-DD format (most common in CSV)
                if (str.includes("-")) {
                    const parts = str.split("-");
                    if (parts.length === 3) {
                        // Check if it's YYYY-MM-DD
                        if (parts[0].length === 4) {
                            const year = parseInt(parts[0]);
                            const month = parseInt(parts[1]) - 1; // JavaScript months are 0-indexed
                            const day = parseInt(parts[2]);
                            const date = new Date(year, month, day);
                            if (!isNaN(date.getTime())) {
                                return date;
                            }
                        }
                    }
                }
                
                // Handle DD/MM/YYYY format
                if (str.includes("/")) {
                    const parts = str.split("/");
                    if (parts.length === 3) {
                        const day = parseInt(parts[0]);
                        const month = parseInt(parts[1]) - 1; // JavaScript months are 0-indexed
                        const year = parseInt(parts[2]);
                        const date = new Date(year, month, day);
                        if (!isNaN(date.getTime())) {
                            return date;
                        }
                    }
                }
                
                // Handle "MMM DD, YYYY" format (e.g., "Jan 15, 2024" or "Dec 1, 2023")
                // This also handles "MMMM DD, YYYY" (e.g., "January 15, 2024")
                const monthDayYearPattern = /^([A-Za-z]+)\s+(\d{1,2}),?\s+(\d{4})$/;
                const match = str.match(monthDayYearPattern);
                if (match) {
                    const monthStr = match[1];
                    const day = parseInt(match[2]);
                    const year = parseInt(match[3]);
                    
                    // Parse month name to number
                    const date = new Date(`${monthStr} ${day}, ${year}`);
                    if (!isNaN(date.getTime())) {
                        return date;
                    }
                }
                
                // Try standard date parsing as fallback (handles many formats)
                const date = new Date(str);
                if (!isNaN(date.getTime())) {
                    return date;
                }
            } catch (e) {
                // Only log occasionally to avoid console spam
                if (Math.random() < 0.01) {
                    console.warn("Invalid date:", str);
                }
            }
            return null;
        }

        // Aggregate expiration data for the next 3 months (counts unique Facilities only, excludes DM)
        function aggregateExpirationData(data) {
            console.log(
                ` Aggregating maturity data for ${data.length} rows (Expired vs Expiring)`
            );
            
            // Get report date from data
            const reportDates = data
                .map((row) => parseDate(row.Report_Date))
                .filter((d) => d);
            if (reportDates.length === 0) {
                console.log(" No valid report dates found");
                return { categories: [], expiredData: [], expiringData: [] };
            }
            const maxReportDate = new Date(Math.max(...reportDates));
            maxReportDate.setHours(0, 0, 0, 0);
            
            // Group by month-year with Sets to track unique Facility IDs
            const expiredByMonth = {}; // { 'YYYY-MM': Set<Facility_ID> }
            const expiringByMonth = {}; // { 'YYYY-MM': Set<Facility_ID> }
            
            let expiredCount = 0;
            let expiringCount = 0;
            let validMaturityDates = 0;
            
            data.forEach((row, index) => {
                const maturityDate = row.Maturity_Date;
                const managementStatus = (row.Management_Status || "").toUpperCase();
                
                if (maturityDate && managementStatus !== "DM") {
                    const dateObj = parseDate(maturityDate);
                    if (dateObj && row.Facility_ID) {
                        validMaturityDates++;
                        
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthYear = `${year}-${month}`;
                        
                        // Determine if expired or expiring (based on report date)
                        if (dateObj < maxReportDate) {
                            // Expired (before report date)
                            expiredCount++;
                            if (!expiredByMonth[monthYear]) {
                                expiredByMonth[monthYear] = new Set();
                            }
                            expiredByMonth[monthYear].add(row.Facility_ID);
                        } else {
                            // Expiring (on or after report date)
                            expiringCount++;
                            if (!expiringByMonth[monthYear]) {
                                expiringByMonth[monthYear] = new Set();
                            }
                            expiringByMonth[monthYear].add(row.Facility_ID);
                        }
                        
                        // Log first few for debugging
                        if (index < 3) {
                            const status = dateObj < maxReportDate ? "Expired" : "Expiring";
                            console.log(
                                `  Row ${index}: Maturity=${maturityDate}  ${monthYear}, Status=${status}, Facility=${row.Facility_ID}, Report Date=${maxReportDate}`
                            );
                        }
                    }
                }
            });
            
            console.log(`  Valid maturity dates: ${validMaturityDates}`);
            console.log(`  Expired facilities: ${expiredCount}`);
            console.log(`  Expiring facilities: ${expiringCount}`);
            
            // Get all unique months and sort (last 12 months)
            const allMonths = [
                ...new Set([
                    ...Object.keys(expiredByMonth),
                    ...Object.keys(expiringByMonth),
                ]),
            ].sort();
            const last12Months = allMonths.slice(-12); // Get last 12 months
            
            // Convert Sets to counts for each month
            const expiredData = last12Months.map((month) =>
                expiredByMonth[month] ? expiredByMonth[month].size : 0
            );
            const expiringData = last12Months.map((month) =>
                expiringByMonth[month] ? expiringByMonth[month].size : 0
            );
            
            return {
                expired: expiredData,
                expiring: expiringData,
                allMonths: last12Months,
            };
        }

        // Aggregate data by month and year
        function aggregateByMonthYear(data, dateField) {
            console.log(`Aggregating ${data.length} rows by ${dateField}`);
            const grouped = {};
            let validDates = 0;
            let invalidDates = 0;
            
            data.forEach((row, index) => {
                const dateValue = row[dateField];
                if (dateValue) {
                    const dateObj = parseDate(dateValue);
                    if (dateObj) {
                        validDates++;
                        // Format as YYYY-MM
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthYear = `${year}-${month}`;
                        grouped[monthYear] = (grouped[monthYear] || 0) + 1;
                        
                        // Log first few dates for debugging
                        if (index < 3) {
                            console.log(
                                `  Row ${index}: ${dateField}="${dateValue}"  ${monthYear}`
                            );
                        }
                    } else {
                        invalidDates++;
                        if (index < 3) {
                            console.log(
                                `  Row ${index}: ${dateField}="${dateValue}"  INVALID`
                            );
                        }
                    }
                } else {
                    invalidDates++;
                }
            });
            
            console.log(
                `Valid dates: ${validDates}, Invalid/Empty: ${invalidDates}`
            );
            console.log(`Unique months: ${Object.keys(grouped).length}`);
            
            return Object.entries(grouped)
                .map(([month, count]) => ({ month, count }))
                .sort((a, b) => a.month.localeCompare(b.month));
        }

        // Aggregate data by date
        function aggregateByDate(data, dateField) {
            const grouped = {};
            data.forEach((row) => {
                const date = row[dateField];
                if (date) {
                    const monthYear = date.substring(0, 7); // YYYY-MM
                    grouped[monthYear] = (grouped[monthYear] || 0) + 1;
                }
            });
            
            return Object.entries(grouped)
                .map(([date, count]) => ({ date: date + "-01", count }))
                .sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        // Create relationship bar chart (OPTIMIZED)
        function createRelationshipChart() {
            const startTime = performance.now();
            const topN = parseInt(document.getElementById("topNFilter").value);
            
            // Use amount type based on filter selection
            let fieldName, seriesName;
            switch (selectedAmountType) {
                case "direct":
                    fieldName = "Direct_OS";
                    seriesName = "Direct OS";
                    break;
                case "contingent":
                    fieldName = "Contingent_OS";
                    seriesName = "Contingent OS";
                    break;
                case "pse":
                    fieldName = "PSE_OS";
                    seriesName = "PSE OS";
                    break;
                case "osuc":
                    fieldName = "OSUC";
                    seriesName = "OSUC";
                    break;
                case "unused":
                    fieldName = "Unused_Committed";
                    seriesName = "Undrawn Commitment";
                    break;
                case "tfa":
                    fieldName = "Fac_Amount";
                    seriesName = "Total Facility Amount";
                    break;
                default:
                    fieldName = "Direct_OS";
                    seriesName = "Direct OS";
            }

            console.log(
                "Creating relationship chart, field:",
                fieldName,
                "dataLength:",
                portfolioData.length
            );
            
            // Use Map for better performance - store all exposure types
            const relationshipData = new Map();
            
            for (let i = 0; i < portfolioData.length; i++) {
                const row = portfolioData[i];
                const relId = row.Relationship_Name || row.Relationship_ID;
                
                if (relId) {
                    if (!relationshipData.has(relId)) {
                        relationshipData.set(relId, {
                            tfa: 0,
                            direct: 0,
                            contingent: 0,
                            pse: 0,
                            osuc: 0,
                            unused: 0,
                            facilityCount: 0,
                        });
                    }
                    
                    const data = relationshipData.get(relId);
                    data.tfa += parseNumber(row.Fac_Amount || row.Facility_Amount);
                    data.direct += parseNumber(row.Direct_OS);
                    data.contingent += parseNumber(row.Contingent_OS);
                    data.pse += parseNumber(row.PSE_OS);
                    data.osuc += parseNumber(row.OSUC);
                    data.unused += parseNumber(row.Unused_Committed);
                    if (row.Facility_ID) data.facilityCount++;
                }
            }
            
            console.log("Total unique relationships:", relationshipData.size);
            
            // Get the selected field value for sorting
            const relationshipTotals = new Map();
            for (const [relId, data] of relationshipData.entries()) {
                let sortValue = 0;
                switch (selectedAmountType) {
                    case "tfa":
                        sortValue = data.tfa;
                        break;
                    case "direct":
                        sortValue = data.direct;
                        break;
                    case "contingent":
                        sortValue = data.contingent;
                        break;
                    case "pse":
                        sortValue = data.pse;
                        break;
                    case "osuc":
                        sortValue = data.osuc;
                        break;
                    case "unused":
                        sortValue = data.unused;
                        break;
                    default:
                        sortValue = data.direct;
                }
                relationshipTotals.set(relId, sortValue);
            }
            
            // Convert to array and sort (only what we need)
            const sorted = Array.from(relationshipTotals.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, topN);
            
            console.log(
                `Chart aggregated ${portfolioData.length} rows, found ${relationshipTotals.size
                } relationships in ${(performance.now() - startTime).toFixed(2)}ms`
            );
            
            // Add index numbers (1, 2, 3, ...) before relationship names
            const relationships = sorted.map(
                (item, index) => `${index + 1}. ${item[0]}`
            );
            const amounts = sorted.map((item) => item[1]);

            // Debug logging for TFA
            console.log("DEBUG (non-filtered) - selectedAmountType:", selectedAmountType);
            console.log("DEBUG (non-filtered) - seriesName:", seriesName);
            console.log("DEBUG (non-filtered) - relationships:", relationships);
            console.log("DEBUG (non-filtered) - amounts:", amounts);
            console.log("DEBUG (non-filtered) - sorted array:", sorted);
            
            // Handle empty data
            if (relationships.length === 0) {
                console.warn("No relationship data for chart");
                return;
            }

            // Check if all amounts are zero
            const totalAmount = amounts.reduce((sum, val) => sum + val, 0);
            if (totalAmount === 0) {
                console.warn(" All amounts are zero for selectedAmountType:", selectedAmountType);
                const chartElement = document.querySelector("#relationshipChart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('Top Relationships');
                }
                return;
            }

            // Calculate dynamic height based on number of relationships (35px per bar, min 350px)
            const calculatedHeight = Math.max(350, relationships.length * 35);
            
            const options = {
                series: [
                    {
                    name: seriesName,
                        data: amounts,
                    },
                ],
                colors: ["#465fff"],
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "bar",
                    height: calculatedHeight,
                    toolbar: {
                        show: false,
                    },
                    events: {
                        dataPointSelection: function (event, chartContext, config) {
                            const selectedIndex = config.dataPointIndex;
                            const selectedRelationship = relationships[selectedIndex];
                            console.log("Relationship clicked:", selectedRelationship);
                            applyChartFilter(
                                "relationship",
                                selectedRelationship,
                                selectedRelationship
                            );
                        },
                    },
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        borderRadius: 5,
                        borderRadiusApplication: "end",
                        dataLabels: {
                            position: 'top',
                        },
                    },
                },
                dataLabels: {
                    enabled: true,
                    textAnchor: 'start',
                    offsetX: 30,
                    style: {
                        fontSize: '11px',
                        fontWeight: 500,
                        colors: ['#374151']
                    },
                    background: {
                        enabled: true,
                        foreColor: '#374151',
                        backgroundColor: '#F3F4F6',
                        borderRadius: 12,
                        padding: 8,
                        opacity: 1,
                        borderWidth: 0
                    },
                    formatter: function(val) {
                        return formatCurrency(val);
                    }
                },
                stroke: {
                    show: true,
                    width: 4,
                    colors: ["transparent"],
                },
                xaxis: {
                    categories: relationships,
                    labels: {
                        formatter: function (val) {
                            return formatCurrency(val);
                        },
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                    axisBorder: {
                        show: false,
                    },
                    axisTicks: {
                        show: false,
                    },
                },
                yaxis: {
                    title: false,
                    labels: {
                        align: 'left',
                        offsetX: -10,
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                },
                legend: {
                    show: true,
                    position: "top",
                    horizontalAlign: "left",
                    fontFamily: "Outfit, sans-serif",
                    fontSize: "12px",
                    markers: {
                        radius: 99,
                    },
                },
                grid: {
                    xaxis: {
                        lines: {
                            show: true,
                        },
                    },
                    yaxis: {
                        lines: {
                            show: false,
                        },
                    },
                },
                fill: {
                    opacity: 1,
                },
                tooltip: {
                    theme: "light",
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        const relName = sorted[dataPointIndex][0]; // Get original name without index
                        const data = relationshipData.get(relName);
                        
                        if (!data) return "";
                        
                        let html = `<div class="apexcharts-tooltip-custom" style="padding: 12px; min-width: 220px; background: #ffffff; color: #1f2937; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border: 1px solid #e5e7eb;">`;
                        html += `<div style="font-weight: 600; margin-bottom: 8px; font-size: 13px; color: #1f2937;">${relName}</div>`;
                        html += `<div style="font-size: 11px; color: #666;">`;
                        html += `<div style="margin-bottom: 4px;"><strong>${data.facilityCount}</strong> Facilities</div>`;
                        html += `<div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #e5e7eb;">`;
                        html += `<div>TFA: ${formatCurrency(data.tfa)}</div>`;
                        html += `<div>Direct: ${formatCurrency(data.direct)}</div>`;
                        if (data.contingent > 0) {
                            html += `<div>Contingent: ${formatCurrency(
                                data.contingent
                            )}</div>`;
                        }
                        if (data.pse > 0) {
                            html += `<div>Presettlement Exposure: ${formatCurrency(
                                data.pse
                            )}</div>`;
                        }
                        html += `</div></div></div>`;
                        return html;
                    },
                },
            };

            // Get the chart element and verify it exists
                const chartElement = document.querySelector("#relationshipChart");
                if (!chartElement) {
                console.error(
                    "Relationship chart element #relationshipChart not found in DOM"
                );
                    return;
                }
                
            // Verify ApexCharts is loaded
            if (typeof ApexCharts === "undefined") {
                console.error("ApexCharts library not loaded");
                return;
            }
            
            try {
                // Destroy previous instance
                if (relationshipChartInstance) {
                    relationshipChartInstance.destroy();
                    relationshipChartInstance = null;
                }
                
                // Clear any previous content to avoid ApexCharts errors
                chartElement.innerHTML = "";
                
                // Create and render new chart
                relationshipChartInstance = new ApexCharts(chartElement, options);
                relationshipChartInstance.render();
                console.log(
                    " Relationship chart rendered successfully with",
                    relationships.length,
                    "relationships"
                );
            } catch (error) {
                console.error(" Error creating relationship chart:", error);
                console.error("Error details:", error.message, error.stack);
            }
        }

        // Helper function to check if any filters are active
        function areFiltersActive() {
            // Check if advanced filters are active
            if (Object.keys(activeFilters).length > 0) return true;
            
            // Check if smart filters are active
            if (selectedRegion !== 'all') return true;
            if (!includePSE) return true;
            if (selectedStatus !== 'all') return true;
            if (selectedCommitmentStatus !== 'all') return true;
            
            // Check if search is active
            const searchTerm = document.getElementById('searchInput')?.value?.trim();
            if (searchTerm && searchTerm.length > 0) return true;
            
            // Check if chart filter is active
            if (chartFilter.active) return true;
            
            return false;
        }

        // Update bar chart
        function updateBarChart() {
            // Debounce to prevent rapid successive calls when switching between Top N values
            if (updateBarChartTimer) {
                clearTimeout(updateBarChartTimer);
            }
            
            updateBarChartTimer = setTimeout(() => {
                console.log(" Updating bar charts (debounced)");
                if (areFiltersActive()) {
                createRelationshipChartFromFiltered();
                createROTCEChartFromFiltered();
            } else {
                createRelationshipChart();
                createROTCEChart();
            }
            }, 100); // 100ms debounce to prevent glitching
        }

        // Filter New Facilities by Period (Current Month or Previous Month)
        function filterNewFacilitiesByPeriod(period) {
            selectedPeriod = period;
            
            // Update button styles to match TailAdmin toggle design
            const currentBtn = document.getElementById("currentMonthBtn");
            const previousBtn = document.getElementById("previousMonthBtn");

            if (period === "current") {
                currentBtn.className =
                    "px-2 py-1 font-medium transition-colors rounded text-xs shadow-xs text-gray-900 bg-white hover:text-gray-900";
                previousBtn.className =
                    "px-2 py-1 font-medium transition-colors rounded text-xs text-gray-500 hover:text-gray-900";
            } else {
                currentBtn.className =
                    "px-2 py-1 font-medium transition-colors rounded text-xs text-gray-500 hover:text-gray-900";
                previousBtn.className =
                    "px-2 py-1 font-medium transition-colors rounded text-xs shadow-xs text-gray-900 bg-white hover:text-gray-900";
            }
            
            // Recreate chart with new period
            if (
                Object.keys(activeFilters).length > 0 ||
                (filteredData.length > 0 &&
                    filteredData.length < portfolioData.length)
            ) {
                createCreditClassificationChartFromFiltered();
            } else {
                createCreditClassificationChart();
            }
        }

        // Create New Facilities Approved  Donut Chart from all data
        function createCreditClassificationChart() {
            const startTime = performance.now();
            
            console.log(
                "Creating New Facilities Approved  chart, dataLength:",
                portfolioData.length
            );
            
            // Check if we have data
            if (!portfolioData || portfolioData.length === 0) {
                console.log(" No portfolio data available for New Facilities Approved chart");
                const chartElement = document.querySelector("#creditClassificationChart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('New Facilities Approved');
                }
                return;
            }
            
            // Find the most recent Report_Date to determine "last month"
            let mostRecentReportDate = null;
            for (let i = 0; i < portfolioData.length; i++) {
                const reportDate = parseDate(portfolioData[i].Report_Date);
                if (
                    reportDate &&
                    (!mostRecentReportDate || reportDate > mostRecentReportDate)
                ) {
                    mostRecentReportDate = reportDate;
                }
            }
            
            if (!mostRecentReportDate) {
                console.warn("No valid Report_Date found");
                const chartElement = document.querySelector("#creditClassificationChart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('New Facilities Approved');
                }
                return;
            }
            
            // Calculate date ranges based on selected period
            let targetStartDate, targetEndDate, periodLabel;
            if (selectedPeriod === "current") {
                // Current month: use the most recent report date's month
                targetStartDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth(),
                    1
                );
                targetStartDate.setHours(0, 0, 0, 0);
                targetEndDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth() + 1,
                    0
                );
                targetEndDate.setHours(23, 59, 59, 999);
                periodLabel = targetStartDate.toLocaleDateString("en-US", {
                    month: "long",
                    year: "numeric",
                });
            } else {
                // Previous month: one month before the most recent report date
                targetStartDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth() - 1,
                    1
                );
                targetStartDate.setHours(0, 0, 0, 0);
                targetEndDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth(),
                    0
                );
                targetEndDate.setHours(23, 59, 59, 999);
                periodLabel = targetStartDate.toLocaleDateString("en-US", {
                    month: "long",
                    year: "numeric",
                });
            }

            console.log("Most recent report date:", mostRecentReportDate);
            console.log("Target period:", periodLabel);
            console.log(
                "Target date range:",
                targetStartDate.toISOString(),
                "to",
                targetEndDate.toISOString()
            );
            console.log("Selected period:", selectedPeriod);
            
            // Track new facilities per product program with amounts
            const productNewFacilities = new Map();
            const productTotalFacilities = new Map();
            const productAmounts = new Map();
            let totalNewCount = 0;
            
            for (let i = 0; i < portfolioData.length; i++) {
                const row = portfolioData[i];
                const productProgram = row.Product_Program || "Unknown";
                const facilityId = row.Facility_ID;
                const region = (row.Region || "").toUpperCase();
                
                // For EMEA, use Origination_Date; for others, use Facility_First_Approval_Date
                const approvalDate = region === "EMEA" 
                    ? parseDate(row.Origination_Date)
                    : parseDate(row.Facility_First_Approval_Date);
                
                if (!facilityId) continue;
                
                // Initialize product program tracking
                if (!productNewFacilities.has(productProgram)) {
                    productNewFacilities.set(productProgram, new Set());
                    productTotalFacilities.set(productProgram, new Set());
                    productAmounts.set(productProgram, {
                        tfa: 0,
                        direct: 0,
                        contingent: 0,
                        pse: 0,
                    });
                }
                
                productTotalFacilities.get(productProgram).add(facilityId);
                
                // Check if facility is "new" (approved within the selected period)
                if (
                    approvalDate &&
                    approvalDate >= targetStartDate &&
                    approvalDate <= targetEndDate
                ) {
                    productNewFacilities.get(productProgram).add(facilityId);
                    totalNewCount++;
                    // Accumulate amounts for new facilities
                    const amounts = productAmounts.get(productProgram);
                    amounts.tfa += parseNumber(row.Facility_Amount);
                    amounts.direct += parseNumber(row.Direct_OS);
                    amounts.contingent += parseNumber(row.Contingent_OS);
                    amounts.pse += parseNumber(row.PSE_OS);
                }
            }
            
            console.log("Product program new facilities:", productNewFacilities);
            console.log(`Found ${totalNewCount} new facilities in ${periodLabel}`);
            
            // Convert to arrays for ApexCharts (only showing new facilities)
            const labels = [];
            const series = [];
            const counts = [];
            
            for (const [
                productProgram,
                newFacilitiesSet,
            ] of productNewFacilities.entries()) {
                const newCount = newFacilitiesSet.size;
                if (newCount > 0) {
                    // Only include product programs with new facilities
                    labels.push(productProgram);
                    series.push(newCount);
                    counts.push(newCount);
                }
            }
            
            // Handle empty data
            if (labels.length === 0) {
                console.warn("No new facilities data available");

                // Destroy existing chart instance first
                if (creditClassificationChartInstance) {
                    creditClassificationChartInstance.destroy();
                    creditClassificationChartInstance = null;
                }

                const chartElement = document.querySelector(
                    "#creditClassificationChart"
                );
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage(`New Facilities (${periodLabel})`);
                }
                // Update chart subtitle even when no data
                const subtitleElement = document.getElementById(
                    "newFacilitiesSubtitle"
                );
                if (subtitleElement) {
                    subtitleElement.textContent = `Facilities first approved in ${periodLabel}`;
                }
                return;
            }
            
            // Calculate total new facilities
            const totalNewFacilities = counts.reduce((a, b) => a + b, 0);
            
            // Define colors matching the TailAdmin style
            const colors = [
                "#3641f5",
                "#7592ff",
                "#dde9ff",
                "#ff6b6b",
                "#ffd93d",
                "#6bcf7f",
                "#c084fc",
            ];
            
            const options = {
                series: series,
                colors: colors.slice(0, labels.length),
                labels: labels,
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "donut",
                    width: 280,
                    height: 280,
                    events: {
                        dataPointSelection: function (event, chartContext, config) {
                            const selectedIndex = config.dataPointIndex;
                            const selectedProduct = labels[selectedIndex];
                            console.log("Product clicked:", selectedProduct);
                            applyChartFilter("product", selectedProduct, selectedProduct);
                        },
                    },
                },
                stroke: {
                    show: false,
                    width: 4,
                    colors: "transparent",
                },
                plotOptions: {
                    pie: {
                        donut: {
                            size: "65%",
                            background: "transparent",
                            labels: {
                                show: true,
                                name: {
                                    show: true,
                                    offsetY: 0,
                                    color: "#1D2939",
                                    fontSize: "12px",
                                    fontWeight: "normal",
                                },
                                value: {
                                    show: true,
                                    offsetY: 10,
                                    color: "#667085",
                                    fontSize: "14px",
                                    formatter: (val) => val.toLocaleString(),
                                },
                                total: {
                                    show: true,
                                    label: "Total New",
                                    color: "#000000",
                                    fontSize: "20px",
                                    fontWeight: "bold",
                                    formatter: () => totalNewFacilities.toLocaleString(),
                                },
                            },
                        },
                    },
                },
                dataLabels: {
                    enabled: false,
                },
                tooltip: {
                    enabled: true,
                    theme: "light",
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        const productProgram = labels[seriesIndex];
                        const count = series[seriesIndex];
                        const amounts = productAmounts.get(productProgram);
                        
                        if (!amounts) return "";
                        
                        let html = `<div class="apexcharts-tooltip-custom" style="padding: 12px; min-width: 200px; background: #ffffff; color: #1f2937; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border: 1px solid #e5e7eb;">`;
                        html += `<div style="font-weight: 600; margin-bottom: 8px; font-size: 13px; color: #1f2937;">${productProgram}</div>`;
                        html += `<div style="font-size: 11px; color: #666;">`;
                        html += `<div style="margin-bottom: 4px;"><strong>${count}</strong> New Facilities</div>`;
                        html += `<div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #e5e7eb;">`;
                        html += `<div>TFA: ${formatCurrency(amounts.tfa)}</div>`;
                        html += `<div>Direct: ${formatCurrency(amounts.direct)}</div>`;
                        if (amounts.contingent > 0) {
                            html += `<div>Contingent: ${formatCurrency(
                                amounts.contingent
                            )}</div>`;
                        }
                        if (amounts.pse > 0) {
                            html += `<div>Presettlement Exposure: ${formatCurrency(
                                amounts.pse
                            )}</div>`;
                        }
                        html += `</div></div></div>`;
                        return html;
                    },
                },
                legend: {
                    show: false,
                },
                responsive: [
                    {
                        breakpoint: 2600,
                        options: {
                            chart: {
                                width: 240,
                                height: 240,
                            },
                        },
                    },
                    {
                        breakpoint: 640,
                        options: {
                            chart: {
                                width: 280,
                                height: 280,
                            },
                        },
                    },
                ],
            };
            
            // Get the chart element and verify it exists
            const chartElement = document.querySelector(
                "#creditClassificationChart"
            );
            if (!chartElement) {
                console.error("Credit classification chart element not found in DOM");
                return;
            }
            
            // Verify ApexCharts is loaded
            if (typeof ApexCharts === "undefined") {
                console.error("ApexCharts library not loaded");
                chartElement.innerHTML = generateNoDataMessage('New Facilities Approved');
                return;
            }
            
            try {
                // Destroy previous instance
                if (creditClassificationChartInstance) {
                    creditClassificationChartInstance.destroy();
                    creditClassificationChartInstance = null;
                }
                
                // Clear any previous content
                chartElement.innerHTML = "";
                
                // Create and render new chart
                creditClassificationChartInstance = new ApexCharts(
                    chartElement,
                    options
                );
                creditClassificationChartInstance.render();
                
                // Update legend
                updateCreditClassificationLegend(
                    labels,
                    series,
                    counts,
                    totalNewFacilities,
                    colors
                );

                // Update chart subtitle with period
                const subtitleElement = document.getElementById(
                    "newFacilitiesSubtitle"
                );
                if (subtitleElement) {
                    subtitleElement.textContent = `Facilities first approved in ${periodLabel}`;
                }
                
                console.log(
                    " New facilities by region chart rendered successfully"
                );
            } catch (error) {
                console.error(
                    " Error creating credit classification chart:",
                    error
                );
                chartElement.innerHTML = generateNoDataMessage('New Facilities Approved');
            }
        }

        // Create New Facilities Approved  Donut Chart from filtered data
        function createCreditClassificationChartFromFiltered() {
            const startTime = performance.now();
            
            console.log(
                "Creating filtered New Facilities Approved  chart, dataLength:",
                filteredData.length
            );
            
            // Check if we have filtered data
            if (!filteredData || filteredData.length === 0) {
                console.log(" No filtered data available for New Facilities Approved chart");
                const chartElement = document.querySelector("#creditClassificationChart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('New Facilities Approved');
                }
                return;
            }
            
            // Find the most recent Report_Date to determine "last month"
            let mostRecentReportDate = null;
            for (let i = 0; i < filteredData.length; i++) {
                const reportDate = parseDate(filteredData[i].Report_Date);
                if (
                    reportDate &&
                    (!mostRecentReportDate || reportDate > mostRecentReportDate)
                ) {
                    mostRecentReportDate = reportDate;
                }
            }
            
            if (!mostRecentReportDate) {
                console.warn("No valid Report_Date found in filtered data");
                const chartElement = document.querySelector(
                    "#creditClassificationChart"
                );
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('New Facilities Approved');
                }
                return;
            }
            
            // Calculate date ranges based on selected period
            let targetStartDate, targetEndDate, periodLabel;
            if (selectedPeriod === "current") {
                // Current month: use the most recent report date's month
                targetStartDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth(),
                    1
                );
                targetStartDate.setHours(0, 0, 0, 0);
                targetEndDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth() + 1,
                    0
                );
                targetEndDate.setHours(23, 59, 59, 999);
                periodLabel = targetStartDate.toLocaleDateString("en-US", {
                    month: "long",
                    year: "numeric",
                });
            } else {
                // Previous month: one month before the most recent report date
                targetStartDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth() - 1,
                    1
                );
                targetStartDate.setHours(0, 0, 0, 0);
                targetEndDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth(),
                    0
                );
                targetEndDate.setHours(23, 59, 59, 999);
                periodLabel = targetStartDate.toLocaleDateString("en-US", {
                    month: "long",
                    year: "numeric",
                });
            }

            console.log(
                "Most recent report date (filtered):",
                mostRecentReportDate
            );
            console.log("Target period (filtered):", periodLabel);
            console.log(
                "Target date range (filtered):",
                targetStartDate.toISOString(),
                "to",
                targetEndDate.toISOString()
            );
            console.log("Selected period:", selectedPeriod);
            
            // Track new facilities per product program with amounts
            const productNewFacilities = new Map();
            const productTotalFacilities = new Map();
            const productAmounts = new Map();
            let totalNewCount = 0;
            
            for (let i = 0; i < filteredData.length; i++) {
                const row = filteredData[i];
                const productProgram = row.Product_Program || "Unknown";
                const facilityId = row.Facility_ID;
                const region = (row.Region || "").toUpperCase();
                
                // For EMEA, use Origination_Date; for others, use Facility_First_Approval_Date
                const approvalDate = region === "EMEA" 
                    ? parseDate(row.Origination_Date)
                    : parseDate(row.Facility_First_Approval_Date);
                
                if (!facilityId) continue;
                
                // Initialize product program tracking
                if (!productNewFacilities.has(productProgram)) {
                    productNewFacilities.set(productProgram, new Set());
                    productTotalFacilities.set(productProgram, new Set());
                    productAmounts.set(productProgram, {
                        tfa: 0,
                        direct: 0,
                        contingent: 0,
                        pse: 0,
                    });
                }
                
                productTotalFacilities.get(productProgram).add(facilityId);
                
                // Check if facility is "new" (approved within the selected period)
                if (
                    approvalDate &&
                    approvalDate >= targetStartDate &&
                    approvalDate <= targetEndDate
                ) {
                    productNewFacilities.get(productProgram).add(facilityId);
                    totalNewCount++;
                    // Accumulate amounts for new facilities
                    const amounts = productAmounts.get(productProgram);
                    amounts.tfa += parseNumber(row.Facility_Amount);
                    amounts.direct += parseNumber(row.Direct_OS);
                    amounts.contingent += parseNumber(row.Contingent_OS);
                    amounts.pse += parseNumber(row.PSE_OS);
                }
            }

            console.log(
                "Product program new facilities (filtered):",
                productNewFacilities
            );
            console.log(
                `Found ${totalNewCount} new facilities in ${periodLabel} (from filtered data)`
            );
            
            // Convert to arrays for ApexCharts (only showing new facilities)
            const labels = [];
            const series = [];
            const counts = [];
            
            for (const [
                productProgram,
                newFacilitiesSet,
            ] of productNewFacilities.entries()) {
                const newCount = newFacilitiesSet.size;
                if (newCount > 0) {
                    // Only include product programs with new facilities
                    labels.push(productProgram);
                    series.push(newCount);
                    counts.push(newCount);
                }
            }
            
            // Handle empty data
            if (labels.length === 0) {
                console.warn("No new facilities data available in filtered dataset");

                // Destroy existing chart instance first
                if (creditClassificationChartInstance) {
                    creditClassificationChartInstance.destroy();
                    creditClassificationChartInstance = null;
                }

                const chartElement = document.querySelector(
                    "#creditClassificationChart"
                );
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage(`New Facilities (${periodLabel})`);
                }
                // Update chart subtitle even when no data
                const subtitleElement = document.getElementById(
                    "newFacilitiesSubtitle"
                );
                if (subtitleElement) {
                    subtitleElement.textContent = `Facilities first approved in ${periodLabel}`;
                }
                return;
            }
            
            // Calculate total new facilities
            const totalNewFacilities = counts.reduce((a, b) => a + b, 0);
            
            // Define colors
            const colors = [
                "#3641f5",
                "#7592ff",
                "#dde9ff",
                "#ff6b6b",
                "#ffd93d",
                "#6bcf7f",
                "#c084fc",
            ];
            
            const options = {
                series: series,
                colors: colors.slice(0, labels.length),
                labels: labels,
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "donut",
                    width: 280,
                    height: 280,
                    events: {
                        dataPointSelection: function (event, chartContext, config) {
                            const selectedIndex = config.dataPointIndex;
                            const selectedProduct = labels[selectedIndex];
                            console.log("Product clicked:", selectedProduct);
                            applyChartFilter("product", selectedProduct, selectedProduct);
                        },
                    },
                },
                stroke: {
                    show: false,
                    width: 4,
                    colors: "transparent",
                },
                plotOptions: {
                    pie: {
                        donut: {
                            size: "65%",
                            background: "transparent",
                            labels: {
                                show: true,
                                name: {
                                    show: true,
                                    offsetY: 0,
                                    color: "#1D2939",
                                    fontSize: "12px",
                                    fontWeight: "normal",
                                },
                                value: {
                                    show: true,
                                    offsetY: 10,
                                    color: "#667085",
                                    fontSize: "14px",
                                    formatter: (val) => val.toLocaleString(),
                                },
                                total: {
                                    show: true,
                                    label: "Total New",
                                    color: "#000000",
                                    fontSize: "20px",
                                    fontWeight: "bold",
                                    formatter: () => totalNewFacilities.toLocaleString(),
                                },
                            },
                        },
                    },
                },
                dataLabels: {
                    enabled: false,
                },
                tooltip: {
                    enabled: true,
                    theme: "light",
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        const productProgram = labels[seriesIndex];
                        const count = series[seriesIndex];
                        const amounts = productAmounts.get(productProgram);
                        
                        if (!amounts) return "";
                        
                        let html = `<div class="apexcharts-tooltip-custom" style="padding: 12px; min-width: 200px; background: #ffffff; color: #1f2937; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border: 1px solid #e5e7eb;">`;
                        html += `<div style="font-weight: 600; margin-bottom: 8px; font-size: 13px; color: #1f2937;">${productProgram}</div>`;
                        html += `<div style="font-size: 11px; color: #666;">`;
                        html += `<div style="margin-bottom: 4px;"><strong>${count}</strong> New Facilities</div>`;
                        html += `<div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #e5e7eb;">`;
                        html += `<div>TFA: ${formatCurrency(amounts.tfa)}</div>`;
                        html += `<div>Direct: ${formatCurrency(amounts.direct)}</div>`;
                        if (amounts.contingent > 0) {
                            html += `<div>Contingent: ${formatCurrency(
                                amounts.contingent
                            )}</div>`;
                        }
                        if (amounts.pse > 0) {
                            html += `<div>Presettlement Exposure: ${formatCurrency(
                                amounts.pse
                            )}</div>`;
                        }
                        html += `</div></div></div>`;
                        return html;
                    },
                },
                legend: {
                    show: false,
                },
                responsive: [
                    {
                        breakpoint: 2600,
                        options: {
                            chart: {
                                width: 240,
                                height: 240,
                            },
                        },
                    },
                    {
                        breakpoint: 640,
                        options: {
                            chart: {
                                width: 280,
                                height: 280,
                            },
                        },
                    },
                ],
            };
            
            const chartElement = document.querySelector(
                "#creditClassificationChart"
            );
            if (!chartElement) {
                console.error("Credit classification chart element not found in DOM");
                return;
            }
            
            if (typeof ApexCharts === "undefined") {
                console.error("ApexCharts library not loaded");
                chartElement.innerHTML = generateNoDataMessage('New Facilities Approved');
                return;
            }
            
            try {
                if (creditClassificationChartInstance) {
                    creditClassificationChartInstance.destroy();
                    creditClassificationChartInstance = null;
                }
                
                chartElement.innerHTML = "";
                
                creditClassificationChartInstance = new ApexCharts(
                    chartElement,
                    options
                );
                creditClassificationChartInstance.render();
                
                // Update legend
                updateCreditClassificationLegend(
                    labels,
                    series,
                    counts,
                    totalNewFacilities,
                    colors
                );

                // Update chart subtitle with period
                const subtitleElement = document.getElementById(
                    "newFacilitiesSubtitle"
                );
                if (subtitleElement) {
                    subtitleElement.textContent = `Facilities first approved in ${periodLabel}`;
                }
                
                console.log(
                    " New facilities by region chart (filtered) rendered successfully"
                );
            } catch (error) {
                console.error(
                    " Error creating credit classification chart (filtered):",
                    error
                );
                chartElement.innerHTML = generateNoDataMessage('New Facilities Approved');
            }
        }

        // Update the legend for credit classification chart
        function updateCreditClassificationLegend(
            labels,
            series,
            counts,
            totalAmount,
            colors
        ) {
            const legendElement = document.getElementById(
                "creditClassificationLegend"
            );
            if (!legendElement) return;
            
            let legendHTML = "";
            for (let i = 0; i < labels.length; i++) {
                const percentage = ((series[i] / totalAmount) * 100).toFixed(0);
                const color = colors[i] || "#3641f5";
                
                legendHTML += `
                    <div class="flex items-start gap-2.5">
                        <div class="mt-1.5 h-2 w-2 rounded-full" style="background-color: ${color};"></div>
                        <div>
                            <h5 class="mb-1 font-medium text-gray-800 text-theme-sm">
                                ${labels[i]}
                            </h5>
                            <div class="flex items-center gap-2">
                                <p class="font-medium text-gray-700 text-theme-sm">
                                    ${percentage}%
                                </p>
                                <div class="w-1 h-1 bg-gray-400 rounded-full"></div>
                                <p class="text-gray-500 text-theme-sm">
                                    ${counts[i]}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            legendElement.innerHTML = legendHTML;
        }

        // ============================================
        // ROTCE CHART FUNCTIONS
        // ============================================

        // Create ROTCE chart (initial load)
        function createROTCEChart() {
            console.log(" Creating ROTCE Performance chart");
            
            const chartElement = document.querySelector("#rotceChart");
            
            // Check if we have portfolio data
            if (!portfolioData || portfolioData.length === 0) {
                console.log(" No portfolio data available for ROTCE chart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('ROTCE Performance');
                }
                return;
            }
            
            // Get Top N from Top Relationships filter
            const topNRelationships = parseInt(
                document.getElementById("topNFilter").value
            );
            
            // Group ROTCE by relationship
            const rotceByRelationship = new Map();
            const rotceValues = [];
            
            portfolioData.forEach((row) => {
                const relName = row.Relationship_Name || row.Relationship_ID;
                const rotce = parsePercentage(row.ROTCE);
                
                if (relName && !isNaN(rotce)) {
                    if (!rotceByRelationship.has(relName)) {
                        rotceByRelationship.set(relName, []);
                    }
                    rotceByRelationship.get(relName).push(rotce);
                    rotceValues.push(rotce);
                }
            });
            
            // Calculate average ROTCE per relationship
            const relationshipROTCE = [];
            rotceByRelationship.forEach((values, relName) => {
                const average =
                    values.reduce((sum, val) => sum + val, 0) / values.length;
                relationshipROTCE.push({ name: relName, rotce: average });
            });
            
            // Sort by selected amount type from Top Relationships chart to get same top N
            // Get Top Relationships to match their order
            const relationshipData = new Map();
            for (const row of portfolioData) {
                const relId = row.Relationship_Name || row.Relationship_ID;
                if (!relId) continue;
                
                if (!relationshipData.has(relId)) {
                    relationshipData.set(relId, {
                        tfa: 0,
                        direct: 0,
                        contingent: 0,
                        pse: 0,
                        osuc: 0,
                        unused: 0,
                    });
                }
                const data = relationshipData.get(relId);
                data.tfa += parseNumber(row.Fac_Amount || row.Facility_Amount);
                data.direct += parseNumber(row.Direct_OS);
                data.contingent += parseNumber(row.Contingent_OS);
                data.pse += parseNumber(row.PSE_OS);
                data.osuc += parseNumber(row.OSUC);
                data.unused += parseNumber(row.Unused_Committed);
            }

            // Get the selected field value for sorting (sync with Top Relationships chart)
            const relationshipTotals = new Map();
            for (const [relId, data] of relationshipData.entries()) {
                let sortValue = 0;
                switch (selectedAmountType) {
                    case "tfa":
                        sortValue = data.tfa;
                        break;
                    case "direct":
                        sortValue = data.direct;
                        break;
                    case "contingent":
                        sortValue = data.contingent;
                        break;
                    case "pse":
                        sortValue = data.pse;
                        break;
                    case "osuc":
                        sortValue = data.osuc;
                        break;
                    case "unused":
                        sortValue = data.unused;
                        break;
                    default:
                        sortValue = data.direct;
                }
                relationshipTotals.set(relId, sortValue);
            }

            // Get top N relationships by selected exposure type (matching Top Relationships chart)
            const topRelationships = Array.from(relationshipTotals.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, topNRelationships)
                .map((entry) => entry[0]);
            
            // Check if we have any relationships with non-zero values
            const hasValidRelationships = Array.from(relationshipTotals.entries())
                .some(([relId, value]) => value > 0);

            console.log("DEBUG ROTCE (non-filtered) - relationshipTotals size:", relationshipTotals.size);
            console.log("DEBUG ROTCE (non-filtered) - hasValidRelationships:", hasValidRelationships);
            console.log("DEBUG ROTCE (non-filtered) - topRelationships length:", topRelationships.length);

            // Update subtitle
            const subtitleEl = document.getElementById("rotceSubtitle");
            if (subtitleEl) {
                subtitleEl.textContent = `Top ${topNRelationships} relationships ROTCE performance`;
            }

            // If no valid relationships in Top Relationships chart, don't show ROTCE
            if (!hasValidRelationships || topRelationships.length === 0 || relationshipTotals.size === 0) {
                console.log(" No relationships data available - skipping ROTCE chart (non-filtered)");
                const chartElement = document.querySelector("#rotceChart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('ROTCE Performance');
                }
                return;
            }
            
            // Filter and order ROTCE data to match top relationships
            const filteredROTCE = topRelationships
                .map((relName) => relationshipROTCE.find((r) => r.name === relName))
                .filter((r) => r !== undefined);

            // Add index numbers (1, 2, 3, ...) to match Top Relationships chart
            const relationships = filteredROTCE.map(
                (r, index) => `${index + 1}. ${r.name}`
            );
            const avgROTCE = filteredROTCE.map((r) => r.rotce);
            
            // Debug logging for ROTCE
            console.log("DEBUG ROTCE (non-filtered) - selectedAmountType:", selectedAmountType);
            console.log("DEBUG ROTCE (non-filtered) - topRelationships:", topRelationships);
            console.log("DEBUG ROTCE (non-filtered) - relationships:", relationships);
            console.log("DEBUG ROTCE (non-filtered) - avgROTCE:", avgROTCE);
            console.log("DEBUG ROTCE (non-filtered) - filteredROTCE:", filteredROTCE);

            // Check if all ROTCE values are zero or NaN
            const validROTCE = avgROTCE.filter(v => !isNaN(v) && v !== 0);
            if (validROTCE.length === 0) {
                console.warn(" No valid ROTCE data for the selected relationships");
                const chartElement = document.querySelector("#rotceChart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('ROTCE Performance');
                }
                return;
            }
            
            // Conditional colors: red if < 12%, green if >= 12%
            const barColors = avgROTCE.map((rotce) =>
                rotce < 12 ? "#ef4444" : "#10b981"
            );
            
            // Calculate dynamic height
            const calculatedHeight = Math.max(350, relationships.length * 35);
            
            // Create horizontal bar chart
            const chartOptions = {
                series: [
                    {
                        name: "Average ROTCE",
                        data: avgROTCE,
                    },
                ],
                chart: {
                    type: "bar",
                    height: calculatedHeight,
                    toolbar: { show: false },
                    fontFamily: "Outfit, sans-serif",
                },
                colors: barColors,
                plotOptions: {
                    bar: {
                        horizontal: true,
                        columnWidth: "70%",
                        borderRadius: 4,
                        distributed: true, // Enable individual bar colors
                        dataLabels: {
                            position: "center",
                        },
                    },
                },
                dataLabels: {
                    enabled: true,
                    formatter: function (val) {
                        return val.toFixed(1) + "%";
                    },
                    style: {
                        fontSize: "12px",
                        fontFamily: "Outfit, sans-serif",
                        colors: ["#fff"],
                        fontWeight: "bold",
                    },
                },
                annotations: {
                    xaxis: [
                        {
                        x: 12,
                            borderColor: "#f59e0b",
                        strokeDashArray: 8,
                        label: {
                                borderColor: "#f59e0b",
                            style: {
                                    color: "#fff",
                                    background: "#f59e0b",
                                    fontSize: "12px",
                                    fontFamily: "Outfit, sans-serif",
                                    fontWeight: "bold",
                                },
                                text: "Target: 12%",
                            },
                        },
                    ],
                },
                xaxis: {
                    categories: relationships,
                    title: {
                        text: "ROTCE (%)",
                        style: {
                            color: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                    labels: {
                        formatter: function (val) {
                            return val.toFixed(0) + "%";
                        },
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                },
                yaxis: {
                    labels: {
                        align: 'left',
                        offsetX: -10,
                        style: {
                            colors: relationships.map(() => "#6B7280"),
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                        maxWidth: 200,
                    },
                },
                grid: {
                    borderColor: "#E5E7EB",
                    xaxis: { lines: { show: true } },
                    yaxis: { lines: { show: false } },
                },
                legend: {
                    show: false,
                },
                tooltip: {
                    theme: "light",
                    style: {
                        fontSize: "12px",
                        fontFamily: "Outfit, sans-serif",
                    },
                    y: {
                        formatter: function (val) {
                            const color = val < 12 ? "Below target" : "Above target";
                            return val.toFixed(2) + "% - " + color;
                        },
                    },
                },
            };

            // Destroy existing chart instance properly
            if (rotceChartInstance) {
                try {
                    rotceChartInstance.destroy();
                } catch (e) {
                    console.log("Error destroying ROTCE chart:", e);
                }
                rotceChartInstance = null;
            }
            
            // Use the chartElement from the top of the function
            if (chartElement) {
                chartElement.innerHTML = "";
            }

            if (relationships.length === 0) {
                chartElement.innerHTML = generateNoDataMessage('ROTCE Performance');
                return;
            }

            // Create and store the chart instance
            try {
            rotceChartInstance = new ApexCharts(chartElement, chartOptions);
            rotceChartInstance.render();
                console.log(" ROTCE chart rendered successfully");
            } catch (error) {
                console.error(" Error rendering ROTCE chart:", error);
                chartElement.innerHTML = generateNoDataMessage('ROTCE Performance');
            }
        }

        // Create ROTCE chart from filtered data
        function createROTCEChartFromFiltered() {
            console.log(" Creating filtered ROTCE Performance chart");

            const chartElement = document.querySelector("#rotceChart");
            
            // Check if we have data
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
            if (!dataSource || dataSource.length === 0) {
                console.log(" No data available for filtered ROTCE chart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('ROTCE Performance');
                }
                return;
            }

            // Get Top N from Top Relationships filter (synced)
            const topN = parseInt(document.getElementById("topNFilter").value);
            
            // Group ROTCE by relationship from filtered data
            const rotceByRelationship = new Map();
            const rotceValues = [];
            
            dataSource.forEach((row) => {
                const relName = row.Relationship_Name || row.Relationship_ID;
                const rotce = parsePercentage(row.ROTCE);
                
                if (relName && !isNaN(rotce)) {
                    if (!rotceByRelationship.has(relName)) {
                        rotceByRelationship.set(relName, []);
                    }
                    rotceByRelationship.get(relName).push(rotce);
                    rotceValues.push(rotce);
                }
            });
            
            // Calculate average ROTCE per relationship
            const relationshipROTCE = [];
            rotceByRelationship.forEach((values, relName) => {
                const average =
                    values.reduce((sum, val) => sum + val, 0) / values.length;
                relationshipROTCE.push({ name: relName, rotce: average });
            });
            
            // Get Top Relationships to match their order
            const relationshipData = new Map();
            for (const row of dataSource) {
                const relId = row.Relationship_Name || row.Relationship_ID;
                if (!relId) continue;
                
                if (!relationshipData.has(relId)) {
                    relationshipData.set(relId, {
                        tfa: 0,
                        direct: 0,
                        contingent: 0,
                        pse: 0,
                        osuc: 0,
                        unused: 0,
                    });
                }
                const data = relationshipData.get(relId);
                data.tfa += parseNumber(row.Fac_Amount || row.Facility_Amount);
                data.direct += parseNumber(row.Direct_OS);
                data.contingent += parseNumber(row.Contingent_OS);
                data.pse += parseNumber(row.PSE_OS);
                data.osuc += parseNumber(row.OSUC);
                data.unused += parseNumber(row.Unused_Committed);
            }

            // Get the selected field value for sorting (sync with Top Relationships chart)
            const relationshipTotals = new Map();
            for (const [relId, data] of relationshipData.entries()) {
                let sortValue = 0;
                switch (selectedAmountType) {
                    case "tfa":
                        sortValue = data.tfa;
                        break;
                    case "direct":
                        sortValue = data.direct;
                        break;
                    case "contingent":
                        sortValue = data.contingent;
                        break;
                    case "pse":
                        sortValue = data.pse;
                        break;
                    case "osuc":
                        sortValue = data.osuc;
                        break;
                    case "unused":
                        sortValue = data.unused;
                        break;
                    default:
                        sortValue = data.direct;
                }
                relationshipTotals.set(relId, sortValue);
            }

            // Get top N relationships by selected exposure type (matching Top Relationships chart)
            const topRelationships = Array.from(relationshipTotals.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, topN)
                .map((entry) => entry[0]);
            
            // Check if we have any relationships with non-zero values
            const hasValidRelationships = Array.from(relationshipTotals.entries())
                .some(([relId, value]) => value > 0);

            console.log("DEBUG ROTCE - relationshipTotals size:", relationshipTotals.size);
            console.log("DEBUG ROTCE - hasValidRelationships:", hasValidRelationships);
            console.log("DEBUG ROTCE - topRelationships length:", topRelationships.length);
            
            // Destroy existing chart instance properly
            if (rotceChartInstance) {
                try {
                    rotceChartInstance.destroy();
                } catch (e) {
                    console.log("Error destroying ROTCE chart:", e);
                }
                rotceChartInstance = null;
            }
            
            // Use the chartElement from the top of the function
            if (chartElement) {
                chartElement.innerHTML = "";
            }

            // Update subtitle
            const subtitleEl = document.getElementById("rotceSubtitle");
            if (subtitleEl) {
                subtitleEl.textContent = `Top ${topN} relationships ROTCE performance`;
            }

            // If no valid relationships in Top Relationships chart, don't show ROTCE
            if (!hasValidRelationships || topRelationships.length === 0 || relationshipTotals.size === 0) {
                console.log(" No relationships data available - skipping ROTCE chart (filtered)");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('ROTCE Performance');
                }
                return;
            }

            // Filter and order ROTCE data to match top relationships
            const filteredROTCE = topRelationships
                .map((relName) => relationshipROTCE.find((r) => r.name === relName))
                .filter((r) => r !== undefined);

            // Add index numbers (1, 2, 3, ...) to match Top Relationships chart
            const relationships = filteredROTCE.map(
                (r, index) => `${index + 1}. ${r.name}`
            );
            const avgROTCE = filteredROTCE.map((r) => r.rotce);

            // Debug logging for ROTCE
            console.log("DEBUG ROTCE (filtered) - selectedAmountType:", selectedAmountType);
            console.log("DEBUG ROTCE (filtered) - topRelationships:", topRelationships);
            console.log("DEBUG ROTCE (filtered) - relationships:", relationships);
            console.log("DEBUG ROTCE (filtered) - avgROTCE:", avgROTCE);
            console.log("DEBUG ROTCE (filtered) - filteredROTCE:", filteredROTCE);
            
            if (relationships.length === 0) {
                chartElement.innerHTML = generateNoDataMessage('ROTCE Performance');
                return;
            }

            // Check if all ROTCE values are zero or NaN
            const validROTCE = avgROTCE.filter(v => !isNaN(v) && v !== 0);
            if (validROTCE.length === 0) {
                console.warn(" No valid ROTCE data for the selected relationships");
                chartElement.innerHTML = generateNoDataMessage('ROTCE Performance');
                return;
            }
            
            // Conditional colors: red if < 12%, green if >= 12%
            const barColors = avgROTCE.map((rotce) =>
                rotce < 12 ? "#ef4444" : "#10b981"
            );
            
            // Calculate dynamic height
            const calculatedHeight = Math.max(350, relationships.length * 35);
            
            // Create horizontal bar chart
            const chartOptions = {
                series: [
                    {
                        name: "Average ROTCE",
                        data: avgROTCE,
                    },
                ],
                chart: {
                    type: "bar",
                    height: calculatedHeight,
                    toolbar: { show: false },
                    fontFamily: "Outfit, sans-serif",
                },
                colors: barColors,
                plotOptions: {
                    bar: {
                        horizontal: true,
                        columnWidth: "70%",
                        borderRadius: 4,
                        distributed: true, // Enable individual bar colors
                        dataLabels: {
                            position: "center",
                        },
                    },
                },
                dataLabels: {
                    enabled: true,
                    formatter: function (val) {
                        return val.toFixed(1) + "%";
                    },
                    style: {
                        fontSize: "12px",
                        fontFamily: "Outfit, sans-serif",
                        colors: ["#fff"],
                        fontWeight: "bold",
                    },
                },
                annotations: {
                    xaxis: [
                        {
                        x: 12,
                            borderColor: "#f59e0b",
                        strokeDashArray: 8,
                        label: {
                                borderColor: "#f59e0b",
                            style: {
                                    color: "#fff",
                                    background: "#f59e0b",
                                    fontSize: "12px",
                                    fontFamily: "Outfit, sans-serif",
                                    fontWeight: "bold",
                                },
                                text: "Target: 12%",
                            },
                        },
                    ],
                },
                xaxis: {
                    categories: relationships,
                    title: {
                        text: "ROTCE (%)",
                        style: {
                            color: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                    labels: {
                        formatter: function (val) {
                            return val.toFixed(0) + "%";
                        },
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                },
                yaxis: {
                    labels: {
                        align: 'left',
                        offsetX: -10,
                        style: {
                            colors: relationships.map(() => "#6B7280"),
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                        maxWidth: 200,
                    },
                },
                grid: {
                    borderColor: "#E5E7EB",
                    xaxis: { lines: { show: true } },
                    yaxis: { lines: { show: false } },
                },
                legend: {
                    show: false,
                },
                tooltip: {
                    theme: "light",
                    style: {
                        fontSize: "12px",
                        fontFamily: "Outfit, sans-serif",
                    },
                    y: {
                        formatter: function (val) {
                            const color = val < 12 ? "Below target" : "Above target";
                            return val.toFixed(2) + "% - " + color;
                        },
                    },
                },
            };
            
            // Create and store the chart instance
            try {
            rotceChartInstance = new ApexCharts(chartElement, chartOptions);
            rotceChartInstance.render();
                console.log(" Filtered ROTCE chart rendered successfully");
            } catch (error) {
                console.error(" Error rendering filtered ROTCE chart:", error);
                chartElement.innerHTML = generateNoDataMessage('ROTCE Performance');
            }
        }

        // Filter data based on search (works with existing filters)
        function filterData() {
            const startTime = performance.now();
            
            // Check if any smart filters are active
            const smartFiltersActive =
                selectedRegion !== "all" || !includePSE || selectedStatus !== "all";
            
            // If no filters are active (neither advanced nor smart filters), just apply search to all data
            if (Object.keys(activeFilters).length === 0 && !smartFiltersActive) {
                const searchTerm = document
                    .getElementById("searchInput")
                    .value.toLowerCase();
                
                if (searchTerm === "") {
                    filteredData = [...portfolioData];
                    
                    // No search term, show all data - update charts to show full data
                    requestAnimationFrame(() => {
                        createFacilityTrendChart();
                        createRelationshipChart();
                        createCreditClassificationChart();
                        createROTCEChart();
                    });
                } else {
                    // Optimized search
                    filteredData = [];
                    for (let i = 0; i < portfolioData.length; i++) {
                        const row = portfolioData[i];
                        let found = false;
                        for (const value of Object.values(row)) {
                            if (String(value).toLowerCase().includes(searchTerm)) {
                                found = true;
                                break;
                            }
                        }
                        if (found) filteredData.push(row);
                    }
                    
                    // Search term is active, update charts with filtered data
                    requestAnimationFrame(() => {
                        calculateMetricsFromFiltered();
                        createFacilityTrendChartFromFiltered();
                        createRelationshipChartFromFiltered();
                        createCreditClassificationChartFromFiltered();
                        createROTCEChartFromFiltered();
                    });
                }
                
            } else {
                // If filters are active, reapply them (which will include search)
                applyFilters();
            }
        }

        // ========================================
        // EXPAND/DETAILS MODAL FUNCTIONS
        // ========================================

        let currentExpandType = null;

        // Define details content for each chart/card type
        const expandModalDetails = {
            // Top 5 Metric Cards
            tfa: {
                title: "Total Facilities Approved (TFA)",
                subtitle: "Complete breakdown of all approved facility amounts",
                content: `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-red-50 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-red-600" id="expandTfaTotal">$0.00</p>
                                <p class="text-sm text-gray-600 mt-1">Total TFA</p>
                            </div>
                            <div class="bg-gray-50 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-gray-800" id="expandTfaFacilities">0</p>
                                <p class="text-sm text-gray-600 mt-1">Total Facilities</p>
                            </div>
                            <div class="bg-blue-50 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-blue-600" id="expandTfaAvg">$0.00</p>
                                <p class="text-sm text-gray-600 mt-1">Avg per Facility</p>
                            </div>
                        </div>
                        <div class="border-t pt-4">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3">Methodology</h4>
                            <p class="text-sm text-gray-600">TFA represents the sum of all Facility_Amount values across the filtered portfolio. This includes both committed and uncommitted facilities.</p>
                        </div>
                    </div>
                `
            },
            osuc: {
                title: "Outstanding Under Commitment (OSUC)",
                subtitle: "Breakdown of outstanding amounts and unused commitments",
                content: `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-orange-50 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-orange-600" id="expandOsucTotal">$0.00</p>
                                <p class="text-sm text-gray-600 mt-1">Total OSUC</p>
                            </div>
                            <div class="bg-blue-50 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-blue-600" id="expandOsucOS">$0.00</p>
                                <p class="text-sm text-gray-600 mt-1">Outstanding Balance</p>
                            </div>
                            <div class="bg-green-50 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-green-600" id="expandOsucUnused">$0.00</p>
                                <p class="text-sm text-gray-600 mt-1">Unused Commitment</p>
                            </div>
                        </div>
                        <div class="border-t pt-4">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3">Methodology</h4>
                            <p class="text-sm text-gray-600">OSUC is calculated for committed facilities only. It represents the sum of outstanding balances plus unused commitments. For uncommitted facilities, OSUC is set to $0.</p>
                        </div>
                    </div>
                `
            },
            outstanding: {
                title: "Total Outstanding",
                subtitle: "Combined direct, contingent, and PSE exposures",
                content: `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="bg-purple-50 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-purple-600" id="expandOsTotal">$0.00</p>
                                <p class="text-sm text-gray-600 mt-1">Total Outstanding</p>
                            </div>
                            <div class="bg-blue-50 rounded-xl p-4 text-center">
                                <p class="text-xl font-bold text-blue-600" id="expandOsDirect">$0.00</p>
                                <p class="text-sm text-gray-600 mt-1">Direct OS</p>
                            </div>
                            <div class="bg-amber-50 rounded-xl p-4 text-center">
                                <p class="text-xl font-bold text-amber-600" id="expandOsContingent">$0.00</p>
                                <p class="text-sm text-gray-600 mt-1">Contingent OS</p>
                            </div>
                            <div class="bg-teal-50 rounded-xl p-4 text-center">
                                <p class="text-xl font-bold text-teal-600" id="expandOsPse">$0.00</p>
                                <p class="text-sm text-gray-600 mt-1">PSE OS</p>
                            </div>
                        </div>
                        <div class="border-t pt-4">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3">Methodology</h4>
                            <p class="text-sm text-gray-600">Outstanding = Direct_OS + Contingent_OS + PSE_OS. This represents the total credit exposure across all exposure types.</p>
                        </div>
                    </div>
                `
            },
            facilities: {
                title: "Total Facilities",
                subtitle: "Count of all facilities in the portfolio",
                content: `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-green-50 rounded-xl p-4 text-center">
                                <p class="text-3xl font-bold text-green-600" id="expandFacTotal">0</p>
                                <p class="text-sm text-gray-600 mt-1">Total Facilities</p>
                            </div>
                            <div class="bg-gray-50 rounded-xl p-4 text-center">
                                <p class="text-3xl font-bold text-gray-800" id="expandFacRelationships">0</p>
                                <p class="text-sm text-gray-600 mt-1">Unique Relationships</p>
                            </div>
                        </div>
                        <div class="border-t pt-4">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3">Methodology</h4>
                            <p class="text-sm text-gray-600">Facility count is based on unique Facility_ID values in the filtered dataset. Each row in the source data represents one facility.</p>
                        </div>
                    </div>
                `
            },
            relationships: {
                title: "Total Relationships",
                subtitle: "Count of unique client relationships",
                content: `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-blue-50 rounded-xl p-4 text-center">
                                <p class="text-3xl font-bold text-blue-600" id="expandRelTotal">0</p>
                                <p class="text-sm text-gray-600 mt-1">Total Relationships</p>
                            </div>
                            <div class="bg-gray-50 rounded-xl p-4 text-center">
                                <p class="text-3xl font-bold text-gray-800" id="expandRelAvgFac">0</p>
                                <p class="text-sm text-gray-600 mt-1">Avg Facilities per Relationship</p>
                            </div>
                        </div>
                        <div class="border-t pt-4">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3">Methodology</h4>
                            <p class="text-sm text-gray-600">Relationship count is based on unique Relationship_ID or Relationship_Name values. Multiple facilities may belong to the same relationship.</p>
                        </div>
                    </div>
                `
            },
            // Chart cards - generic details for now
            expiring: {
                title: "CAs & Facilities Expiring",
                subtitle: "Credit agreements and facilities approaching maturity",
                content: `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-blue-50 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-blue-600" id="expandExpCAs">0</p>
                                <p class="text-sm text-gray-600 mt-1">CAs Expiring (3 months)</p>
                            </div>
                            <div class="bg-orange-50 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-orange-600" id="expandExpFac">0</p>
                                <p class="text-sm text-gray-600 mt-1">Facilities Expiring (3 months)</p>
                            </div>
                        </div>
                        <div class="border-t pt-4">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3">Methodology</h4>
                            <p class="text-sm text-gray-600">Shows CAs and facilities expiring within the next 3 months based on CA_Expiry_Date and Facility_Expiry_Date fields.</p>
                        </div>
                    </div>
                `
            }
        };

        // Open expand modal with specific content
        function openExpandModal(chartType) {
            currentExpandType = chartType;
            const modal = document.getElementById("expandModal");
            const modalTitle = document.getElementById("expandModalTitle");
            const modalSubtitle = document.getElementById("expandModalSubtitle");
            const modalContent = document.getElementById("expandModalContent");

            // Get details for this chart type or use default
            const details = expandModalDetails[chartType] || {
                title: chartType.charAt(0).toUpperCase() + chartType.slice(1).replace(/([A-Z])/g, ' $1'),
                subtitle: "Expanded view with additional details",
                content: `
                    <div class="space-y-4">
                        <div class="bg-gray-50 rounded-xl p-6 text-center">
                            <p class="text-gray-600">Detailed view for this chart will show additional metrics and breakdowns.</p>
                            <p class="text-sm text-gray-400 mt-2">Click "View Data" below to see the underlying data.</p>
                        </div>
                    </div>
                `
            };

            modalTitle.textContent = details.title;
            modalSubtitle.textContent = details.subtitle;
            modalContent.innerHTML = details.content;

            // Populate dynamic values based on chart type
            populateExpandModalValues(chartType);

            // Show modal
            modal.classList.remove("hidden");
            document.body.style.overflow = "hidden";
        }

        // Populate values in the expand modal
        function populateExpandModalValues(chartType) {
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
            const content = document.getElementById('expandModalContent');
            
            // Show loading state
            content.innerHTML = `
                <div class="flex items-center justify-center py-12 text-gray-400">
                    <svg class="animate-spin h-8 w-8 mr-3" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Loading details...
                </div>
            `;
            
            // Defer rendering for performance
            setTimeout(() => {
                content.innerHTML = generateExpandedView(chartType, dataSource);
                // Initialize any charts if needed
                initializeExpandCharts(chartType, dataSource);
            }, 50);
        }
        
        // Generate expanded view HTML based on chart type
        function generateExpandedView(chartType, dataSource) {
            switch(chartType) {
                case 'tfa':
                    return generateTFAExpandedView(dataSource);
                case 'osuc':
                    return generateOSUCExpandedView(dataSource);
                case 'outstanding':
                    return generateOutstandingExpandedView(dataSource);
                case 'facilities':
                    return generateFacilitiesExpandedView(dataSource);
                case 'relationships':
                    return generateRelationshipsExpandedView(dataSource);
                case 'expiring':
                    return generateExpiringExpandedView(dataSource);
                case 'newFacilities':
                    return generateNewFacilitiesExpandedView(dataSource);
                case 'newDealsYTD':
                    return generateNewDealsYTDExpandedView(dataSource);
                case 'newDealsMTD':
                    return generateNewDealsMTDExpandedView(dataSource);
                case 'pipeline':
                    return generatePipelineExpandedView(dataSource);
                case 'topRelationships':
                    return generateTopRelationshipsExpandedView(dataSource);
                case 'rotce':
                    return generateROTCEExpandedView(dataSource);
                case 'covenantMonitoring':
                    return generateCovenantExpandedView(dataSource);
                case 'covenantRegional':
                    return generateCovenantRegionalExpandedView(dataSource);
                case 'ccmRegionalChart':
                    return generateCCMExpandedView(dataSource);
                default:
                    return '<p class="text-gray-500">No detailed view available for this chart.</p>';
            }
        }

        // Generate TFA Expanded View
        function generateTFAExpandedView(dataSource) {
            const totalTfa = dataSource.reduce((sum, row) => sum + parseNumber(row.Fac_Amount || row.Facility_Amount), 0);
            const totalFacilities = new Set(dataSource.map(r => r.Facility_ID).filter(Boolean)).size;
            const totalRelationships = new Set(dataSource.map(r => r.Relationship_Name || r.Relationship_ID).filter(Boolean)).size;
            const avgPerFacility = totalFacilities > 0 ? totalTfa / totalFacilities : 0;
            const avgPerRelationship = totalRelationships > 0 ? totalTfa / totalRelationships : 0;
            
            // Group by Client (Relationship)
            const byClient = {};
            dataSource.forEach(row => {
                const client = row.Relationship_Name || row.Relationship_ID || 'Unknown';
                if (!byClient[client]) byClient[client] = 0;
                byClient[client] += parseNumber(row.Fac_Amount || row.Facility_Amount);
            });
            
            // Group by Product Program
            const byProgram = {};
            dataSource.forEach(row => {
                const program = row.Product_Program || 'Unknown';
                if (!byProgram[program]) byProgram[program] = 0;
                byProgram[program] += parseNumber(row.Fac_Amount || row.Facility_Amount);
            });
            
            // Get Top 10 clients
            const topClients = Object.entries(byClient)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            // Get all programs sorted
            const sortedPrograms = Object.entries(byProgram)
                .sort((a, b) => b[1] - a[1]);
            
            return `
                <!-- Key Metrics Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="flex h-11 w-11 items-center justify-center rounded-lg bg-blue-100">
                                <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Total TFA</p>
                                <h3 class="text-xl font-bold text-gray-900">${formatCurrency(totalTfa)}</h3>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="flex h-11 w-11 items-center justify-center rounded-lg bg-green-100">
                                <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Total Relationships</p>
                                <h3 class="text-xl font-bold text-gray-900">${totalRelationships.toLocaleString()}</h3>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="flex h-11 w-11 items-center justify-center rounded-lg bg-orange-100">
                                <svg class="h-6 w-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Total Facilities</p>
                                <h3 class="text-xl font-bold text-gray-900">${totalFacilities.toLocaleString()}</h3>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="flex h-11 w-11 items-center justify-center rounded-lg bg-purple-100">
                                <svg class="h-6 w-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">Avg per Relationship</p>
                                <h3 class="text-xl font-bold text-gray-900">${formatCurrency(avgPerRelationship)}</h3>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- TFA by Client (Top 10) -->
                    <div class="rounded-xl border border-gray-200 bg-white">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">TFA by Client (Top 10)</h3>
                            <p class="text-xs text-gray-500 mt-1">Largest clients by facility amount</p>
                        </div>
                        <div class="p-6">
                            <div id="tfaClientChart" style="min-height: 350px;"></div>
                        </div>
                    </div>
                    
                    <!-- TFA by Product Program - Donut Chart with Legends -->
                    <div class="rounded-xl border border-gray-200 bg-white">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">TFA by Product Program</h3>
                            <p class="text-xs text-gray-500 mt-1">Distribution across product programs</p>
                        </div>
                        <div class="p-6">
                            <div class="flex flex-row items-center justify-center gap-8">
                                <!-- Donut Chart -->
                                <div class="flex-shrink-0">
                                    <div id="tfaProgramDonutChart"></div>
                                </div>
                                
                                <!-- Legend / Details List - Right Side -->
                                <div class="flex-1 max-w-md">
                                    <div id="tfaProgramList" class="space-y-3">
                                        ${sortedPrograms.map(([program, amount], index) => {
                                            const colors = ["#3641f5", "#7592ff", "#dde9ff", "#ff6b6b", "#ffd93d", "#6bcf7f", "#c084fc"];
                                            const color = colors[index % colors.length];
                                            // Format amount in billions or millions
                                            const formattedAmount = amount >= 1000000000 
                                                ? `$${(amount / 1000000000).toFixed(2)}B`
                                                : `$${(amount / 1000000).toFixed(1)}M`;
                                            return `
                                                <div class="flex items-center gap-3 py-2">
                                                    <div class="w-4 h-4 rounded-sm flex-shrink-0" style="background-color: ${color};"></div>
                                                    <p class="text-sm font-medium text-gray-800 flex-1">${program}</p>
                                                    <p class="text-sm font-semibold text-gray-900">${formattedAmount}</p>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Initialize charts in expanded views
        function initializeExpandCharts(chartType, dataSource) {
            if (chartType === 'tfa') {
                initializeTFAChart(dataSource);
            }
            // Add other chart initializations as needed
        }
        
        // Initialize TFA Charts
        function initializeTFAChart(dataSource) {
            // 1. TFA by Client (Top 10) - Bar Chart (like Top Relationships)
            const byClient = {};
            dataSource.forEach(row => {
                const client = row.Relationship_Name || row.Relationship_ID || 'Unknown';
                if (!byClient[client]) byClient[client] = 0;
                byClient[client] += parseNumber(row.Fac_Amount || row.Facility_Amount);
            });
            
            const topClients = Object.entries(byClient)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const clientLabels = topClients.map(([name], idx) => `${idx + 1}. ${name}`);
            const clientValues = topClients.map(([, amount]) => amount);
            
            // Calculate dynamic height based on number of clients (35px per bar, min 350px)
            const calculatedHeight = Math.max(350, clientLabels.length * 35);
            
            // Client Bar Chart Options (matching Top Relationships style)
            const clientChartOptions = {
                series: [{
                    name: 'TFA Amount',
                    data: clientValues,
                }],
                colors: ["#465fff"], // Same blue as Top Relationships
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "bar",
                    height: calculatedHeight,
                    toolbar: {
                        show: false,
                    },
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        borderRadius: 5,
                        borderRadiusApplication: "end",
                        dataLabels: {
                            position: 'top',
                        },
                    },
                },
                dataLabels: {
                    enabled: true,
                    textAnchor: 'start',
                    offsetX: 30,
                    style: {
                        fontSize: '11px',
                        fontWeight: 500,
                        colors: ['#374151']
                    },
                    background: {
                        enabled: true,
                        foreColor: '#374151',
                        backgroundColor: '#F3F4F6',
                        borderRadius: 12,
                        padding: 8,
                        opacity: 1,
                        borderWidth: 0
                    },
                    formatter: function(val) {
                        return formatCurrency(val);
                    }
                },
                stroke: {
                    show: true,
                    width: 4,
                    colors: ["transparent"],
                },
                xaxis: {
                    categories: clientLabels,
                    labels: {
                        formatter: function (val) {
                            return formatCurrency(val);
                        },
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                    axisBorder: {
                        show: false,
                    },
                    axisTicks: {
                        show: false,
                    },
                },
                yaxis: {
                    title: false,
                    labels: {
                        align: 'left',
                        offsetX: -10,
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                },
                legend: {
                    show: true,
                    position: "top",
                    horizontalAlign: "left",
                    fontFamily: "Outfit, sans-serif",
                    fontSize: "12px",
                    markers: {
                        radius: 99,
                    },
                },
                grid: {
                    xaxis: {
                        lines: {
                            show: true,
                        },
                    },
                    yaxis: {
                        lines: {
                            show: false,
                        },
                    },
                },
                fill: {
                    opacity: 1,
                },
                tooltip: {
                    theme: "light",
                    y: {
                        formatter: function(val) {
                            return formatCurrency(val);
                        }
                    }
                },
            };
            
            // 2. TFA by Product Program - Donut Chart
            const byProgram = {};
            dataSource.forEach(row => {
                const program = row.Product_Program || 'Unknown';
                if (!byProgram[program]) byProgram[program] = 0;
                byProgram[program] += parseNumber(row.Fac_Amount || row.Facility_Amount);
            });
            
            const sortedPrograms = Object.entries(byProgram)
                .sort((a, b) => b[1] - a[1]);
            
            const programLabels = sortedPrograms.map(([name]) => name);
            const programValues = sortedPrograms.map(([, amount]) => amount);
            const totalTfa = programValues.reduce((a, b) => a + b, 0);
            
            // Donut chart colors (matching New Facilities Approved style)
            const donutColors = [
                "#3641f5",  // Primary blue
                "#7592ff",  // Light blue
                "#dde9ff",  // Lighter blue
                "#ff6b6b",  // Red
                "#ffd93d",  // Yellow
                "#6bcf7f",  // Green
                "#c084fc",  // Purple
            ];
            
            // Program Donut Chart Options (matching TailAdmin pie chart style)
            const programChartOptions = {
                series: programValues,
                colors: donutColors.slice(0, programLabels.length),
                labels: programLabels,
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "donut",
                    width: 300,
                    height: 300,
                },
                stroke: {
                    show: false,
                },
                plotOptions: {
                    pie: {
                        donut: {
                            size: "65%",
                            background: "transparent",
                            labels: {
                                show: true,
                                name: {
                                    show: true,
                                    offsetY: -10,
                                    color: "#1D2939",
                                    fontSize: "14px",
                                    fontWeight: "600",
                                },
                                value: {
                                    show: true,
                                    offsetY: 10,
                                    color: "#667085",
                                    fontSize: "16px",
                                    fontWeight: "700",
                                    formatter: (val) => formatCurrency(val),
                                },
                                total: {
                                    show: true,
                                    label: "Total TFA",
                                    color: "#111827",
                                    fontSize: "16px",
                                    fontWeight: "700",
                                    formatter: () => formatCurrency(totalTfa),
                                },
                            },
                        },
                    },
                },
                dataLabels: {
                    enabled: false,
                },
                legend: {
                    show: false, // Hide built-in legend, using custom HTML legend
                },
                tooltip: {
                    enabled: true,
                    theme: "light",
                    y: {
                        formatter: function(val, opts) {
                            const percentage = ((val / totalTfa) * 100).toFixed(1);
                            return formatCurrency(val) + ' (' + percentage + '%)';
                        }
                    }
                },
            };
            
            // Render both charts
            const clientChartEl = document.getElementById('tfaClientChart');
            const programDonutChartEl = document.getElementById('tfaProgramDonutChart');
            
            if (clientChartEl && typeof ApexCharts !== 'undefined') {
                const clientChart = new ApexCharts(clientChartEl, clientChartOptions);
                clientChart.render();
            }
            
            if (programDonutChartEl && typeof ApexCharts !== 'undefined') {
                const programDonutChart = new ApexCharts(programDonutChartEl, programChartOptions);
                programDonutChart.render();
            }
        }
        
        // Placeholder functions for other chart types (to be implemented similarly)
        function generateOSUCExpandedView(dataSource) {
            return '<p class="text-gray-500">OSUC detailed view - to be implemented</p>';
        }
        function generateOutstandingExpandedView(dataSource) {
            return '<p class="text-gray-500">Outstanding detailed view - to be implemented</p>';
        }
        function generateFacilitiesExpandedView(dataSource) {
            return '<p class="text-gray-500">Facilities detailed view - to be implemented</p>';
        }
        function generateRelationshipsExpandedView(dataSource) {
            return '<p class="text-gray-500">Relationships detailed view - to be implemented</p>';
        }
        function generateExpiringExpandedView(dataSource) {
            return '<p class="text-gray-500">Expiring detailed view - to be implemented</p>';
        }
        function generateNewFacilitiesExpandedView(dataSource) {
            return '<p class="text-gray-500">New Facilities detailed view - to be implemented</p>';
        }
        function generateNewDealsYTDExpandedView(dataSource) {
            return '<p class="text-gray-500">New Deals YTD detailed view - to be implemented</p>';
        }
        function generateNewDealsMTDExpandedView(dataSource) {
            return '<p class="text-gray-500">New Deals MTD detailed view - to be implemented</p>';
        }
        function generatePipelineExpandedView(dataSource) {
            return '<p class="text-gray-500">Pipeline detailed view - to be implemented</p>';
        }
        function generateTopRelationshipsExpandedView(dataSource) {
            return '<p class="text-gray-500">Top Relationships detailed view - to be implemented</p>';
        }
        function generateROTCEExpandedView(dataSource) {
            return '<p class="text-gray-500">ROTCE detailed view - to be implemented</p>';
        }
        function generateCovenantExpandedView(dataSource) {
            return '<p class="text-gray-500">Covenant detailed view - to be implemented</p>';
        }
        function generateCovenantRegionalExpandedView(dataSource) {
            return '<p class="text-gray-500">Covenant Regional detailed view - to be implemented</p>';
        }
        function generateCCMExpandedView(dataSource) {
            return '<p class="text-gray-500">CCM detailed view - to be implemented</p>';
        }
        
        // Close expand modal
        function closeExpandModal() {
            const modal = document.getElementById("expandModal");
            modal.classList.add("hidden");
            document.body.style.overflow = "auto";
            currentExpandType = null;
        }
        
        // View data from expand modal - closes expand modal first
        function viewDataFromExpandModal() {
            const chartType = currentExpandType;
            closeExpandModal();
            // Small delay to ensure modal is closed before opening the next one
            setTimeout(() => {
                openChartDataModal(chartType);
            }, 100);
        }

        // Add keyboard listener for ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const expandModal = document.getElementById("expandModal");
                if (expandModal && !expandModal.classList.contains('hidden')) {
                    closeExpandModal();
                }
            }
        });

        // ========================================
        // CHART DATA VIEWER MODAL FUNCTIONS
        // ========================================

        // Open chart data modal with specific dataset
        function openChartDataModal(chartType) {
            const modal = document.getElementById("chartDataModal");
            const modalTitle = document.getElementById("chartDataModalTitle");
            const modalSubtitle = document.getElementById("chartDataModalSubtitle");
            const tableHeader = document.getElementById("chartDataTableHeader");
            const tableBody = document.getElementById("chartDataTableBody");

            // Show modal immediately with loading state
            modal.classList.remove("hidden");
            document.body.style.overflow = "hidden";
            
            // Show loading state
            tableHeader.innerHTML = '<th colspan="100" class="px-4 py-8 text-center text-gray-500">Loading...</th>';
            tableBody.innerHTML = '';
            document.getElementById("chartDataTableFilters").innerHTML = '';
            
            // Defer data loading to next frame for instant modal opening
            requestAnimationFrame(() => {
                setTimeout(() => {
                    loadChartData(chartType, modalTitle, modalSubtitle, tableHeader, tableBody);
                }, 10);
            });
        }

        function loadChartData(chartType, modalTitle, modalSubtitle, tableHeader, tableBody) {
            // Determine which data to show
            let data = [];
            let chartName = "";

            switch (chartType) {
                // Top 5 Metric Cards
                case "tfa":
                    chartName = "Total Facilities Approved (TFA)";
                    data = filteredData.length > 0 ? filteredData : portfolioData;
                    break;
                case "osuc":
                    chartName = "Outstanding Under Commitment (OSUC)";
                    data = filteredData.length > 0 ? filteredData : portfolioData;
                    break;
                case "outstanding":
                    chartName = "Total Outstanding Balance";
                    data = filteredData.length > 0 ? filteredData : portfolioData;
                    break;
                case "facilities":
                    chartName = "Total Facilities";
                    data = filteredData.length > 0 ? filteredData : portfolioData;
                    break;
                case "relationships":
                    chartName = "Total Relationships";
                    data = filteredData.length > 0 ? filteredData : portfolioData;
                    break;
                // Chart Cards
                case "expiring":
                    chartName = "CAs & Facilities Expiring";
                    data = getExpiringData();
                    break;
                case "newFacilities":
                    chartName = "New Facilities Approved ";
                    data = getNewFacilitiesData();
                    break;
                case "topRelationships":
                    chartName = "Top Relationships by " + getExposureTypeName();
                    data = getTopRelationshipsData();
                    break;
                case "rotce":
                    chartName = "ROTCE Performance";
                    data = getROTCEData();
                    break;
                case "newDealsYTD":
                    chartName = "New Deals Closed YTD";
                    data = getNewDealsYTDData();
                    break;
                case "newDealsMTD":
                    chartName = "New Deals Closed MTD";
                    data = getNewDealsMTDData();
                    break;
                case "covenantsByProgram":
                    chartName = "Covenants by Product Program";
                    data = getCovenantsByProgramData();
                    break;
                case "covenantMonitoring":
                    chartName = currentCovenantViewType === 'pastDue' ? "Past Due Covenants" : "Coming Due Covenants";
                    data = getCovenantMonitoringData();
                    break;
                case "covenantRegional":
                    chartName = currentCovenantViewType === 'pastDue' ? "Past Due Covenants by Region" : "Coming Due Covenants by Region";
                    data = getCovenantRegionalData();
                    break;
                case "ccmRegionalChart":
                    chartName = "Criticized/Classified Memos & Reviews";
                    data = getCCMFilteredData();
                    break;
                case "ccmStats":
                    chartName = "Credit Committee Memos";
                    data = getCCMFilteredData();
                    break;
                case "pipeline":
                    chartName = "Deals Pending Closure";
                    data = filteredData.length > 0 ? filteredData : portfolioData;
                    break;
                default:
                    data = filteredData.length > 0 ? filteredData : portfolioData;
            }

            // Update modal title
            modalTitle.textContent = chartName + " - Underlying Data";
            
            // Build filter description
            let filterDesc = [];
            if (filteredData.length > 0 && filteredData.length < portfolioData.length) {
                filterDesc.push("portfolio filters applied");
            }
            if (selectedRegion !== 'all') {
                filterDesc.push(`Region: ${selectedRegion.toUpperCase()}`);
            }
            // Add view type for covenant charts
            if (chartType === 'covenantMonitoring' || chartType === 'covenantRegional') {
                filterDesc.push(`View: ${currentCovenantViewType === 'pastDue' ? 'Past Due' : 'Coming Due (30 days)'}`);
            }
            // Add status info for CCM charts
            if (chartType === 'ccmRegionalChart' || chartType === 'ccmStats') {
                filterDesc.push("All CCM statuses (Past Due, Coming Due, Open)");
            }
            
            const filterText = filterDesc.length > 0 ? ` (${filterDesc.join(", ")})` : "";
            modalSubtitle.textContent = `Showing ${data.length} records${filterText}`;

            // Store data and chart name for export
            window.currentChartData = { data, chartName };

            // Build table
            buildDataTable(data, tableHeader, tableBody);
        }

        // Close chart data modal
        function closeChartDataModal() {
            const modal = document.getElementById("chartDataModal");
            modal.classList.add("hidden");
            document.body.style.overflow = "auto";
        }

        // Get exposure type name
        function getExposureTypeName() {
            const names = {
                direct: "Direct OS",
                contingent: "Contingent OS",
                pse: "PSE OS",
                osuc: "OSUC",
                unused: "Undrawn Commitment",
                tfa: "Total Facility Amount",
            };
            return names[selectedAmountType] || "Direct OS";
        }

        // Get expiring data (CAs & Facilities expiring in next 3 months, excludes DM, EMEA CAs require CA_Review = "Yes")
        function getExpiringData() {
            const dataSource =
                filteredData.length > 0 ? filteredData : portfolioData;
            console.log("getExpiringData - dataSource length:", dataSource.length);
            
            // Get report date from data
            const reportDates = dataSource
                .map((row) => parseDate(row.Report_Date))
                .filter((d) => d);
            if (reportDates.length === 0) {
                console.log(" No valid report dates found");
                return [];
            }
            const maxReportDate = new Date(Math.max(...reportDates));
            maxReportDate.setHours(0, 0, 0, 0);
            
            const threeMonthsLater = new Date(maxReportDate);
            threeMonthsLater.setMonth(threeMonthsLater.getMonth() + 3);

            const result = dataSource.filter((row) => {
                const managementStatus = (row.Management_Status || "").toUpperCase();
                const region = (row.Region || "").toUpperCase();
                const caReview = (row.CA_Review || "").trim();
                
                // Exclude DM status
                if (managementStatus === "DM") return false;
                
                const caExpiry = parseDate(row.CA_Expiration_Date);
                const maturityDate = parseDate(row.Maturity_Date);

                const caExpiring =
                    caExpiry && caExpiry >= maxReportDate && caExpiry <= threeMonthsLater;
                const facilityExpiring =
                    maturityDate &&
                    maturityDate >= maxReportDate &&
                    maturityDate <= threeMonthsLater;

                // For CA expiring in EMEA, require CA_Review = "Yes"
                if (caExpiring && region === "EMEA" && caReview !== "Yes") {
                    return facilityExpiring; // Only include if facility is also expiring
                }

                return caExpiring || facilityExpiring;
            });
            
            console.log("getExpiringData - filtered result length:", result.length);
            return result;
        }

        // Get new facilities data (based on selected period)
        function getNewFacilitiesData() {
            const dataSource =
                filteredData.length > 0 ? filteredData : portfolioData;
            console.log(
                "getNewFacilitiesData - dataSource length:",
                dataSource.length,
                "selectedPeriod:",
                selectedPeriod
            );
            const reportDates = dataSource
                .map((row) => parseDate(row.Report_Date))
                .filter((d) => d);
            if (reportDates.length === 0) {
                console.log("getNewFacilitiesData - No report dates found");
                return [];
            }

            const mostRecentReportDate = new Date(Math.max(...reportDates));

            let targetStartDate, targetEndDate;
            if (selectedPeriod === "current") {
                targetStartDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth(),
                    1
                );
                targetStartDate.setHours(0, 0, 0, 0);
                targetEndDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth() + 1,
                    0
                );
                targetEndDate.setHours(23, 59, 59, 999);
            } else {
                targetStartDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth() - 1,
                    1
                );
                targetStartDate.setHours(0, 0, 0, 0);
                targetEndDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth(),
                    0
                );
                targetEndDate.setHours(23, 59, 59, 999);
            }

            const result = dataSource.filter((row) => {
                const firstApprovalDate = parseDate(row.Facility_First_Approval_Date);
                return (
                    firstApprovalDate &&
                    firstApprovalDate >= targetStartDate &&
                    firstApprovalDate <= targetEndDate
                );
            });

            console.log(
                "getNewFacilitiesData - filtered result length:",
                result.length
            );
            return result;
        }

        // Get top relationships data
        function getTopRelationshipsData() {
            const dataSource =
                filteredData.length > 0 ? filteredData : portfolioData;
            const topN = parseInt(document.getElementById("topNFilter").value);
            console.log(
                "getTopRelationshipsData - dataSource length:",
                dataSource.length,
                "topN:",
                topN,
                "selectedAmountType:",
                selectedAmountType
            );

            // Aggregate by relationship
            const relationshipData = new Map();
            for (const row of dataSource) {
                const relId = row.Relationship_Name || row.Relationship_ID;
                if (!relId) continue;

                if (!relationshipData.has(relId)) {
                    relationshipData.set(relId, []);
                }
                relationshipData.get(relId).push(row);
            }

            // Calculate totals for sorting
            const relationshipTotals = new Map();
            for (const [relId, rows] of relationshipData.entries()) {
                let total = 0;
                for (const row of rows) {
                    switch (selectedAmountType) {
                        case "tfa":
                            total += parseNumber(row.Facility_Amount);
                            break;
                        case "direct":
                            total += parseNumber(row.Direct_OS);
                            break;
                        case "contingent":
                            total += parseNumber(row.Contingent_OS);
                            break;
                        case "pse":
                            total += parseNumber(row.PSE_OS);
                            break;
                        case "osuc":
                            total += parseNumber(row.OSUC);
                            break;
                        case "unused":
                            total += parseNumber(row.Unused_Committed);
                            break;
                        default:
                            total += parseNumber(row.Direct_OS);
                    }
                }
                relationshipTotals.set(relId, total);
            }

            // Get top N relationships
            const topRelationships = Array.from(relationshipTotals.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, topN)
                .map(([relId]) => relId);

            // Return all rows for top relationships
            const result = dataSource.filter((row) => {
                const relId = row.Relationship_Name || row.Relationship_ID;
                return topRelationships.includes(relId);
            });
            
            console.log(
                "getTopRelationshipsData - filtered result length:",
                result.length
            );
            return result;
        }

        // Get New Deals YTD data
        function getNewDealsYTDData() {
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
            
            // Use reporting month instead of actual current date
            const { monthStart, monthEnd, reportingMonth: repMonth } = getReportingMonthRange();
            const currentYear = repMonth.getFullYear();
            const yearStartDate = new Date(currentYear, 0, 1);
            yearStartDate.setHours(0, 0, 0, 0);

            // Get unique facilities with origination date in reporting year (up to reporting month)
            const facilitiesSet = new Set();
            const result = dataSource.filter((row) => {
                const originationDate = parseDate(row.Origination_Date);
                const facilityId = row.Facility_ID || row.Facility_Name;
                const region = String(row.Region || "").trim().toUpperCase();
                
                // Apply region filter if active
                if (selectedRegion !== 'all' && region !== selectedRegion.toUpperCase()) return false;
                
                if (originationDate && originationDate >= yearStartDate && originationDate <= repMonth && facilityId) {
                    if (!facilitiesSet.has(facilityId)) {
                        facilitiesSet.add(facilityId);
                        return true;
                    }
                }
                return false;
            });

            console.log("getNewDealsYTDData - filtered result length:", result.length);
            return result;
        }

        // Get New Deals MTD data
        function getNewDealsMTDData() {
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;

            // Use reporting month instead of actual current date
            const { monthStart, monthEnd, reportingMonth: repMonth } = getReportingMonthRange();

            // Get unique facilities with origination date in reporting month
            const facilitiesSet = new Set();
            const result = dataSource.filter((row) => {
                const originationDate = parseDate(row.Origination_Date);
                const facilityId = row.Facility_ID || row.Facility_Name;
                const region = String(row.Region || "").trim().toUpperCase();
                
                // Apply region filter if active
                if (selectedRegion !== 'all' && region !== selectedRegion.toUpperCase()) return false;
                
                if (originationDate && originationDate >= monthStart && originationDate <= monthEnd && facilityId) {
                    if (!facilitiesSet.has(facilityId)) {
                        facilitiesSet.add(facilityId);
                        return true;
                    }
                }
                return false;
            });

            console.log("getNewDealsMTDData - filtered result length:", result.length);
            return result;
        }

        // Get covenants by product program data
        function getCovenantsByProgramData() {
            // Use covenant data if available, otherwise fall back to portfolio data
            const dataSource = covenantsData.length > 0 ? covenantsData : (filteredData.length > 0 ? filteredData : portfolioData);
            
            console.log("getCovenantsByProgramData - using", covenantsData.length > 0 ? "covenant data" : "portfolio data");
            
            // Filter for rows that have covenant data and apply region filter
            const result = dataSource.filter((row) => {
                const programName = String(row.Product_Program_Name || "").trim();
                const region = String(row.Region || "").trim().toUpperCase();
                
                // Skip if no program name
                if (programName === "") return false;
                
                // Apply region filter if active
                if (selectedRegion !== 'all' && region !== selectedRegion.toUpperCase()) return false;
                
                return true;
            });
            
            console.log("getCovenantsByProgramData - filtered result length:", result.length);
            return result;
        }

        // Get covenant monitoring data (filtered by current view type: pastDue or comingDue)
        function getCovenantMonitoringData() {
            // Use covenant data if available, otherwise fall back to portfolio data
            const dataSource = covenantsData.length > 0 ? covenantsData : (filteredData.length > 0 ? filteredData : portfolioData);
            
            console.log("getCovenantMonitoringData - using", covenantsData.length > 0 ? "covenant data" : "portfolio data", "view:", currentCovenantViewType);
            
            // Filter for rows based on current view type using exact dataLoader field names
            const result = dataSource.filter((row) => {
                // Use exact field name from dataLoader: Coming_Due_Past_Due
                const status = String(row.Coming_Due_Past_Due || "").trim().toLowerCase();
                const region = String(row.Region || "").trim().toUpperCase();
                
                // Apply region filter if active
                if (selectedRegion !== 'all' && region !== selectedRegion.toUpperCase()) return false;
                
                // Apply view type filter using Coming_Due_Past_Due from dataLoader
                if (currentCovenantViewType === 'pastDue') {
                    if (status !== 'past due') return false;
                } else if (currentCovenantViewType === 'comingDue') {
                    if (status !== 'coming due') return false;
                }
                
                return true;
            });
            
            console.log("getCovenantMonitoringData - filtered result length:", result.length);
            return result;
        }
        
        // Get covenant regional data (for Past Due Covenants by Region table - filtered by current view type)
        function getCovenantRegionalData() {
            const dataSource = covenantsData.length > 0 ? covenantsData : portfolioData;
            
            console.log("getCovenantRegionalData - view:", currentCovenantViewType);
            
            // Filter based on current view type using exact dataLoader field names
            const result = dataSource.filter((row) => {
                // Use exact field name from dataLoader: Coming_Due_Past_Due
                const status = String(row.Coming_Due_Past_Due || "").trim().toLowerCase();
                const region = String(row.Region || "").trim().toUpperCase();
                
                // Apply region filter if active
                if (selectedRegion !== 'all' && region !== selectedRegion.toUpperCase()) return false;
                
                // Apply view type filter using Coming_Due_Past_Due from dataLoader
                if (currentCovenantViewType === 'pastDue') {
                    if (status !== 'past due') return false;
                } else if (currentCovenantViewType === 'comingDue') {
                    if (status !== 'coming due') return false;
                }
                
                return true;
            });
            
            console.log("getCovenantRegionalData - filtered result length:", result.length);
            return result;
        }
        
        // Get CCM data with filters applied (includes status categorization)
        function getCCMFilteredData() {
            if (!ccmData || ccmData.length === 0) return [];
            
            // Filter CCM data based on region filter and use CCM_Status from dataLoader
            const result = ccmData.filter((row) => {
                const region = String(row.Region || "").trim().toUpperCase();
                
                // Apply region filter if active
                if (selectedRegion !== 'all' && region !== selectedRegion.toUpperCase()) return false;
                
                return true;
            }).map((row) => {
                // Use CCM_Status from dataLoader export directly
                return {
                    ...row,
                    Computed_CCM_Status: row.CCM_Status || 'Unknown'
                };
            });
            
            console.log("getCCMFilteredData - filtered result length:", result.length);
            return result;
        }
        
        // Get ROTCE data for the top N relationships (matching chart logic)
        function getROTCEData() {
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
            const topN = parseInt(document.getElementById("topNFilter").value);
            
            // Build relationship data map (same logic as chart)
            const relationshipData = new Map();
            for (const row of dataSource) {
                const relId = row.Relationship_Name || row.Relationship_ID;
                if (!relId) continue;
                
                if (!relationshipData.has(relId)) {
                    relationshipData.set(relId, {
                        tfa: 0,
                        direct: 0,
                        contingent: 0,
                        pse: 0,
                        osuc: 0,
                        unused: 0,
                    });
                }
                const data = relationshipData.get(relId);
                data.tfa += parseNumber(row.Fac_Amount || row.Facility_Amount);
                data.direct += parseNumber(row.Direct_OS);
                data.contingent += parseNumber(row.Contingent_OS);
                data.pse += parseNumber(row.PSE_OS);
                data.osuc += parseNumber(row.OSUC);
                data.unused += parseNumber(row.Unused_Committed);
            }
            
            // Get the selected field value for sorting
            const relationshipTotals = new Map();
            for (const [relId, data] of relationshipData.entries()) {
                let sortValue = 0;
                switch (selectedAmountType) {
                    case "tfa": sortValue = data.tfa; break;
                    case "direct": sortValue = data.direct; break;
                    case "contingent": sortValue = data.contingent; break;
                    case "pse": sortValue = data.pse; break;
                    case "osuc": sortValue = data.osuc; break;
                    case "unused": sortValue = data.unused; break;
                    default: sortValue = data.direct;
                }
                relationshipTotals.set(relId, sortValue);
            }
            
            // Get top N relationships by selected exposure type
            const topRelationships = Array.from(relationshipTotals.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, topN)
                .map(([relId]) => relId);
            
            // Return rows for top relationships that have ROTCE data
            const result = dataSource.filter((row) => {
                const relId = row.Relationship_Name || row.Relationship_ID;
                const rotce = row.ROTCE;
                return topRelationships.includes(relId) && rotce !== undefined && rotce !== null && rotce !== '';
            });
            
            console.log("getROTCEData - filtered result length:", result.length);
            return result;
        }

        // Build data table dynamically
        // Global variables for table state
        let tableState = {
            data: [],
            filteredData: [],
            columns: [],
            currentPage: 1,
            pageSize: 100,
            columnFilters: {}
        };

        function buildDataTable(data, tableHeader, tableBody) {
            if (data.length === 0) {
                tableHeader.innerHTML = "";
                document.getElementById("chartDataTableFilters").innerHTML = "";
                tableBody.innerHTML =
                    '<tr><td colspan="100" class="text-center py-8 text-gray-500">No data available</td></tr>';
                updatePaginationControls(0, 0, 0);
                return;
            }

            // Initialize table state
            tableState.data = data;
            tableState.columns = Object.keys(data[0]);
            tableState.currentPage = 1;
            tableState.columnFilters = {};
            
            // Apply filters to get filtered data
            applyTableFilters();

            // Build header
            buildTableHeader(tableHeader);
            
            // Build filter row
            buildFilterRow();

            // Render current page
            renderTablePage(tableBody);
            
            // Setup pagination controls
            setupPaginationControls();
        }

        function buildTableHeader(tableHeader) {
            tableHeader.innerHTML = tableState.columns
                .map(
                    (col) =>
                        `<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 tracking-wider bg-gray-50">${col.replace(
                            /_/g,
                            " "
                        )}</th>`
                )
                .join("");
        }

        function buildFilterRow() {
            const filterRow = document.getElementById("chartDataTableFilters");
            
            // Get unique values for each column and detect column types
            const columnInfo = {};
            tableState.columns.forEach(col => {
                const uniqueValues = [...new Set(tableState.data.map(row => row[col]))];
                const cleanValues = uniqueValues.filter(v => v !== null && v !== undefined && v !== '');
                
                // Detect if column is numeric/amount
                const colLower = col.toLowerCase();
                const isAmountColumn = colLower.includes('amount') || 
                                      colLower.includes('_os') || 
                                      colLower.includes('osuc') || 
                                      colLower.includes('committed') ||
                                      colLower.includes('outstanding') ||
                                      colLower.includes('balance') ||
                                      colLower.includes('tfa') ||
                                      colLower.includes('exposure');
                
                const isNumericColumn = isAmountColumn || colLower.includes('rate') || colLower.includes('percent') || colLower.includes('rotce');
                
                // Check if values are actually numeric
                const sampleValues = cleanValues.slice(0, 10);
                const areValuesNumeric = sampleValues.length > 0 && 
                                        sampleValues.every(v => !isNaN(parseFloat(String(v).replace(/[$,]/g, ''))));
                
                columnInfo[col] = {
                    values: cleanValues.sort().slice(0, 100),
                    isNumeric: isNumericColumn && areValuesNumeric,
                    isAmount: isAmountColumn && areValuesNumeric,
                    isCategorical: cleanValues.length <= 50 && !isNumericColumn
                };
            });
            
            filterRow.innerHTML = tableState.columns
                .map((col, idx) => {
                    const info = columnInfo[col];
                    const currentFilter = tableState.columnFilters[col] || '';
                    
                    // Amount/Numeric columns - show range filter
                    if (info.isAmount || info.isNumeric) {
                        const currentOp = tableState.columnFilterOps?.[col] || 'range';
                        const currentMin = tableState.columnFilterMin?.[col] || '';
                        const currentMax = tableState.columnFilterMax?.[col] || '';
                        const currentExact = tableState.columnFilterExact?.[col] || '';
                        const displayText = (typeof currentFilter === 'object' && currentFilter.display) ? currentFilter.display : 'Filter...';
                        
                        return `<th class="px-4 py-2 bg-gray-50" 
                                    x-data="{open${idx}: false, filterOp${idx}: '${currentOp}'}">
                            <button @click="open${idx} = !open${idx}"
                                class="inline-flex items-center justify-between w-full gap-1 rounded-lg border border-gray-300 bg-white px-2 py-1 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                <span class="truncate max-w-[100px]">${displayText}</span>
                                <svg class="h-3 w-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            <div x-show="open${idx}" @click.outside="open${idx} = false"
                                class="absolute z-[100] w-64 space-y-2 rounded-2xl border border-gray-200 bg-white p-3 shadow-theme-lg mt-2">
                                <div class="text-xs font-semibold text-gray-700 mb-2">${col.replace(/_/g, ' ')}</div>
                                
                                <!-- Filter Type Selector -->
                                <div class="grid grid-cols-2 gap-1 mb-2">
                                    <button @click="filterOp${idx} = 'exact'"
                                        :class="filterOp${idx} === 'exact' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                        class="px-2 py-1 text-xs rounded transition-colors">
                                        Exact
                                    </button>
                                    <button @click="filterOp${idx} = 'range'"
                                        :class="filterOp${idx} === 'range' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                        class="px-2 py-1 text-xs rounded transition-colors">
                                        Range
                                    </button>
                                    <button @click="filterOp${idx} = 'greater'"
                                        :class="filterOp${idx} === 'greater' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                        class="px-2 py-1 text-xs rounded transition-colors">
                                        Greater
                                    </button>
                                    <button @click="filterOp${idx} = 'less'"
                                        :class="filterOp${idx} === 'less' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                        class="px-2 py-1 text-xs rounded transition-colors">
                                        Less
                                    </button>
                                </div>
                                
                                <!-- Exact Match Filter -->
                                <div x-show="filterOp${idx} === 'exact'" class="space-y-2">
                                    <div>
                                        <label class="text-xs text-gray-600 mb-1 block">Exact Value</label>
                                        <input type="number" id="exact${idx}" placeholder="Enter exact amount" 
                                            class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                            value="${currentExact}">
                                    </div>
                                    <button @click="open${idx} = false; window.applyNumericFilter('${col}', 'exact', document.getElementById('exact${idx}').value);"
                                        class="w-full px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">
                                        Apply Filter
                                    </button>
                                </div>
                                
                                <!-- Range Filter -->
                                <div x-show="filterOp${idx} === 'range'" class="space-y-2">
                                    <div>
                                        <label class="text-xs text-gray-600 mb-1 block">Min Value</label>
                                        <input type="number" id="min${idx}" placeholder="Min" 
                                            class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                            value="${currentMin}">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-600 mb-1 block">Max Value</label>
                                        <input type="number" id="max${idx}" placeholder="Max" 
                                            class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                            value="${currentMax}">
                                    </div>
                                    <button @click="open${idx} = false; window.applyNumericFilter('${col}', 'range', document.getElementById('min${idx}').value, document.getElementById('max${idx}').value);"
                                        class="w-full px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">
                                        Apply Range
                                    </button>
                                </div>
                                
                                <!-- Greater Than Filter -->
                                <div x-show="filterOp${idx} === 'greater'" class="space-y-2">
                                    <div>
                                        <label class="text-xs text-gray-600 mb-1 block">Greater Than</label>
                                        <input type="number" id="greater${idx}" placeholder="Enter value" 
                                            class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                            value="${currentMin}">
                                    </div>
                                    <button @click="open${idx} = false; window.applyNumericFilter('${col}', 'greater', document.getElementById('greater${idx}').value);"
                                        class="w-full px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">
                                        Apply Filter
                                    </button>
                                </div>
                                
                                <!-- Less Than Filter -->
                                <div x-show="filterOp${idx} === 'less'" class="space-y-2">
                                    <div>
                                        <label class="text-xs text-gray-600 mb-1 block">Less Than</label>
                                        <input type="number" id="less${idx}" placeholder="Enter value" 
                                            class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                            value="${currentMax}">
                                    </div>
                                    <button @click="open${idx} = false; window.applyNumericFilter('${col}', 'less', document.getElementById('less${idx}').value);"
                                        class="w-full px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">
                                        Apply Filter
                                    </button>
                                </div>
                                
                                <!-- Clear Button -->
                                <button @click="open${idx} = false; window.clearNumericFilter('${col}');"
                                    class="w-full px-3 py-1.5 text-xs font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                                    Clear Filter
                                </button>
                            </div>
                        </th>`;
                    }
                    
                    // Categorical columns with few values - show dropdown
                    if (info.isCategorical) {
                        const displayText = currentFilter || 'All';
                        
                        return `<th class="px-4 py-2 bg-gray-50" 
                                    x-data="{open${idx}: false, selected${idx}: '${currentFilter}'}">
                            <button @click="open${idx} = !open${idx}"
                                class="inline-flex items-center justify-between w-full gap-2 rounded-lg border border-gray-300 bg-white px-2 py-1 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                <span class="truncate max-w-[120px]" x-text="selected${idx} || 'All'"></span>
                                <svg class="h-3 w-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            <div x-show="open${idx}" @click.outside="open${idx} = false"
                                class="absolute z-[100] w-48 max-h-64 overflow-y-auto space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                <button
                                    @click="selected${idx} = ''; open${idx} = false; window.applyColumnFilter('${col}', '');"
                                    :class="selected${idx} === '' ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                    class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                    All
                                </button>
                                ${info.values.map(value => {
                                    const displayValue = String(value).substring(0, 50);
                                    const safeValue = String(value).replace(/'/g, "\\'");
                                    return `<button
                                        @click="selected${idx} = '${safeValue}'; open${idx} = false; window.applyColumnFilter('${col}', '${safeValue}');"
                                        :class="selected${idx} === '${safeValue}' ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                        class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors truncate">
                                        ${displayValue}
                                    </button>`;
                                }).join('')}
                            </div>
                        </th>`;
                    }
                    
                    // Text search for other columns
                    return `<th class="px-4 py-2 bg-gray-50">
                        <input 
                            type="text" 
                            placeholder="Search..." 
                            data-column="${col}"
                            data-column-index="${idx}"
                            class="table-filter-input w-full px-2 py-1 text-xs border border-gray-300 rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                            value="${currentFilter}"
                        />
                    </th>`;
                })
                .join("");
            
            // Add event listeners to text filter inputs
            filterRow.querySelectorAll('.table-filter-input').forEach(input => {
                input.addEventListener('input', debounce((e) => {
                    const column = e.target.dataset.column;
                    const value = e.target.value.trim().toLowerCase();
                    
                    if (value) {
                        tableState.columnFilters[column] = value;
                    } else {
                        delete tableState.columnFilters[column];
                    }
                    
                    tableState.currentPage = 1;
                    applyTableFilters();
                    renderTablePage(document.getElementById("chartDataTableBody"));
                    setupPaginationControls();
                    updateClearFiltersButton();
                }, 300));
            });
        }
        
        // Global function to apply numeric filter
        window.applyNumericFilter = function(column, operator, minOrValue, maxValue) {
            // Initialize filter ops storage if not exists
            if (!tableState.columnFilterOps) tableState.columnFilterOps = {};
            if (!tableState.columnFilterMin) tableState.columnFilterMin = {};
            if (!tableState.columnFilterMax) tableState.columnFilterMax = {};
            if (!tableState.columnFilterExact) tableState.columnFilterExact = {};
            
            tableState.columnFilterOps[column] = operator;
            
            if (operator === 'exact') {
                const value = parseFloat(minOrValue);
                if (!isNaN(value)) {
                    tableState.columnFilters[column] = {
                        type: 'exact',
                        value: value,
                        display: `= ${formatShortNumber(value)}`
                    };
                    tableState.columnFilterExact[column] = minOrValue;
                } else {
                    delete tableState.columnFilters[column];
                    delete tableState.columnFilterExact[column];
                }
            } else if (operator === 'range') {
                const min = minOrValue ? parseFloat(minOrValue) : null;
                const max = maxValue ? parseFloat(maxValue) : null;
                
                if (min !== null || max !== null) {
                    tableState.columnFilters[column] = {
                        type: 'range',
                        min: min,
                        max: max,
                        display: min !== null && max !== null ? `${formatShortNumber(min)} - ${formatShortNumber(max)}` :
                                min !== null ? ` ${formatShortNumber(min)}` :
                                ` ${formatShortNumber(max)}`
                    };
                    tableState.columnFilterMin[column] = minOrValue;
                    tableState.columnFilterMax[column] = maxValue;
                } else {
                    delete tableState.columnFilters[column];
                    delete tableState.columnFilterMin[column];
                    delete tableState.columnFilterMax[column];
                }
            } else if (operator === 'greater') {
                const value = parseFloat(minOrValue);
                if (!isNaN(value)) {
                    tableState.columnFilters[column] = {
                        type: 'greater',
                        value: value,
                        display: `> ${formatShortNumber(value)}`
                    };
                    tableState.columnFilterMin[column] = minOrValue;
                } else {
                    delete tableState.columnFilters[column];
                    delete tableState.columnFilterMin[column];
                }
            } else if (operator === 'less') {
                const value = parseFloat(minOrValue);
                if (!isNaN(value)) {
                    tableState.columnFilters[column] = {
                        type: 'less',
                        value: value,
                        display: `< ${formatShortNumber(value)}`
                    };
                    tableState.columnFilterMax[column] = minOrValue;
                } else {
                    delete tableState.columnFilters[column];
                    delete tableState.columnFilterMax[column];
                }
            }
            
            tableState.currentPage = 1;
            applyTableFilters();
            renderTablePage(document.getElementById("chartDataTableBody"));
            setupPaginationControls();
            updateClearFiltersButton();
        };
        
        // Global function to clear numeric filter
        window.clearNumericFilter = function(column) {
            delete tableState.columnFilters[column];
            if (tableState.columnFilterOps) delete tableState.columnFilterOps[column];
            if (tableState.columnFilterMin) delete tableState.columnFilterMin[column];
            if (tableState.columnFilterMax) delete tableState.columnFilterMax[column];
            if (tableState.columnFilterExact) delete tableState.columnFilterExact[column];
            
            tableState.currentPage = 1;
            applyTableFilters();
            renderTablePage(document.getElementById("chartDataTableBody"));
            setupPaginationControls();
            updateClearFiltersButton();
        };
        
        // Global function to clear all table filters
        window.clearAllTableFilters = function() {
            // Clear all filter states
            tableState.columnFilters = {};
            if (tableState.columnFilterOps) tableState.columnFilterOps = {};
            if (tableState.columnFilterMin) tableState.columnFilterMin = {};
            if (tableState.columnFilterMax) tableState.columnFilterMax = {};
            if (tableState.columnFilterExact) tableState.columnFilterExact = {};
            
            // Reset to first page
            tableState.currentPage = 1;
            
            // Reapply filters (will clear everything)
            applyTableFilters();
            renderTablePage(document.getElementById("chartDataTableBody"));
            setupPaginationControls();
            
            // Rebuild filter row to reset all dropdowns and inputs
            buildFilterRow();
            
            // Hide clear button
            updateClearFiltersButton();
        };
        
        // Function to show/hide clear filters button
        function updateClearFiltersButton() {
            const hasFilters = Object.keys(tableState.columnFilters).length > 0;
            const button = document.getElementById('clearFiltersBtn');
            if (button) {
                if (hasFilters) {
                    button.classList.remove('hidden');
                    button.classList.add('flex');
                } else {
                    button.classList.add('hidden');
                    button.classList.remove('flex');
                }
            }
        }
        
        // Format number for display
        function formatShortNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toFixed(0);
        }
        
        // Global function to apply column filter from dropdown
        window.applyColumnFilter = function(column, value) {
            if (value) {
                tableState.columnFilters[column] = value.toLowerCase();
            } else {
                delete tableState.columnFilters[column];
            }
            
            tableState.currentPage = 1;
            applyTableFilters();
            renderTablePage(document.getElementById("chartDataTableBody"));
            setupPaginationControls();
            updateClearFiltersButton();
        };

        function applyTableFilters() {
            const filters = tableState.columnFilters;
            const hasFilters = Object.keys(filters).length > 0;
            
            if (!hasFilters) {
                tableState.filteredData = tableState.data;
                return;
            }
            
            tableState.filteredData = tableState.data.filter(row => {
                return Object.entries(filters).every(([column, filterValue]) => {
                    // Handle numeric filters (exact, range, greater, less)
                    if (typeof filterValue === 'object' && filterValue.type) {
                        const cellValue = parseFloat(String(row[column] || '').replace(/[$,]/g, ''));
                        
                        if (isNaN(cellValue)) return false;
                        
                        if (filterValue.type === 'exact') {
                            return cellValue === filterValue.value;
                        } else if (filterValue.type === 'range') {
                            const min = filterValue.min;
                            const max = filterValue.max;
                            if (min !== null && max !== null) {
                                return cellValue >= min && cellValue <= max;
                            } else if (min !== null) {
                                return cellValue >= min;
                            } else if (max !== null) {
                                return cellValue <= max;
                            }
                            return true;
                        } else if (filterValue.type === 'greater') {
                            return cellValue > filterValue.value;
                        } else if (filterValue.type === 'less') {
                            return cellValue < filterValue.value;
                        }
                    }
                    
                    // Handle text filters
                    const cellValue = String(row[column] || '').toLowerCase();
                    return cellValue.includes(filterValue);
                });
            });
        }

        function renderTablePage(tableBody) {
            const data = tableState.filteredData;
            const pageSize = tableState.pageSize;
            const currentPage = tableState.currentPage;
            const startIdx = (currentPage - 1) * pageSize;
            const endIdx = Math.min(startIdx + pageSize, data.length);
            const pageData = data.slice(startIdx, endIdx);

            if (pageData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${tableState.columns.length}" class="text-center py-8 text-gray-500">No matching records found</td></tr>`;
                updatePaginationControls(0, 0, data.length);
                return;
            }

            tableBody.innerHTML = pageData
                .map(
                    (row, idx) =>
                        `<tr class="${(startIdx + idx) % 2 === 0 ? "bg-white" : "bg-gray-50"
                        } hover:bg-blue-50">
                    ${tableState.columns
                            .map((col) => {
                    const value = row[col];
                    const formattedValue = formatCellValue(col, value);
                    return `<td class="px-4 py-3 text-sm text-gray-700 whitespace-nowrap">${formattedValue}</td>`;
                            })
                            .join("")}
                </tr>`
                )
                .join("");

            updatePaginationControls(startIdx + 1, endIdx, data.length);
        }

        function setupPaginationControls() {
            const pageSize = tableState.pageSize;
            const totalRows = tableState.filteredData.length;
            const totalPages = Math.ceil(totalRows / pageSize);
            
            const prevBtn = document.getElementById('dataPrevBtn');
            const nextBtn = document.getElementById('dataNextBtn');
            const pageSizeSelect = document.getElementById('dataPageSize');
            
            // Update page selector
            pageSizeSelect.value = pageSize;
            
            // Update buttons
            prevBtn.disabled = tableState.currentPage <= 1;
            nextBtn.disabled = tableState.currentPage >= totalPages;
            
            document.getElementById('dataCurrentPage').textContent = tableState.currentPage;
            document.getElementById('dataTotalPages').textContent = totalPages || 1;
            
            // Remove old event listeners by cloning
            const newPrevBtn = prevBtn.cloneNode(true);
            const newNextBtn = nextBtn.cloneNode(true);
            const newPageSizeSelect = pageSizeSelect.cloneNode(true);
            
            prevBtn.parentNode.replaceChild(newPrevBtn, prevBtn);
            nextBtn.parentNode.replaceChild(newNextBtn, nextBtn);
            pageSizeSelect.parentNode.replaceChild(newPageSizeSelect, pageSizeSelect);
            
            // Add new event listeners
            newPrevBtn.addEventListener('click', () => {
                if (tableState.currentPage > 1) {
                    tableState.currentPage--;
                    renderTablePage(document.getElementById("chartDataTableBody"));
                    setupPaginationControls();
                }
            });
            
            newNextBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(tableState.filteredData.length / tableState.pageSize);
                if (tableState.currentPage < totalPages) {
                    tableState.currentPage++;
                    renderTablePage(document.getElementById("chartDataTableBody"));
                    setupPaginationControls();
                }
            });
            
            newPageSizeSelect.addEventListener('change', (e) => {
                tableState.pageSize = parseInt(e.target.value);
                tableState.currentPage = 1;
                renderTablePage(document.getElementById("chartDataTableBody"));
                setupPaginationControls();
            });
        }

        function updatePaginationControls(start, end, total) {
            document.getElementById('dataRowsStart').textContent = start;
            document.getElementById('dataRowsEnd').textContent = end;
            document.getElementById('dataTotalRows').textContent = total;
        }

        // Debounce helper function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Format cell value based on column name
        function formatCellValue(column, value) {
            if (value === null || value === undefined || value === "") return "-";

            const col = column.toLowerCase();

            // Format currency columns
            if (
                col.includes("amount") ||
                col.includes("_os") ||
                col.includes("osuc") ||
                col.includes("committed")
            ) {
                const num = parseNumber(value);
                if (!isNaN(num) && num !== 0) {
                    return formatCurrency(num);
                }
            }

            // Format date columns
            if (col.includes("date")) {
                const date = parseDate(value);
                if (date) {
                    return formatDate(date);
                }
            }

            // Format percentage columns
            if (col.includes("rate") || col.includes("percent")) {
                const num = parseFloat(value);
                if (!isNaN(num)) {
                    return num.toFixed(2) + "%";
                }
            }

            return String(value);
        }

        // Open methodology modal with chart-specific information
        function openMethodologyModal(chartType) {
            const modalTitle = document.getElementById("methodologyModalTitle");
            const modalContent = document.getElementById("methodologyModalContent");
            const modal = document.getElementById("methodologyModal");

            // Define methodology content for each chart
            const methodologies = {
                // Top 5 Metric Cards Methodologies
                tfa: {
                    title: "Total Facilities Approved (TFA) - Methodology",
                    content: `
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">What This Metric Shows:</h5>
                                </div>
                                <p class="text-gray-600">Total Facilities Approved (TFA) represents the sum of all approved facility amounts across the portfolio.</p>
                            </div>
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Calculation:</h5>
                                </div>
                                <p class="text-gray-600">TFA = SUM(Facility_Amount) for all facilities in the filtered portfolio. Includes both committed and uncommitted facilities.</p>
                            </div>
                        </div>
                    `,
                },
                osuc: {
                    title: "Outstanding Under Commitment (OSUC) - Methodology",
                    content: `
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">What This Metric Shows:</h5>
                                </div>
                                <p class="text-gray-600">OSUC represents the Outstanding balance plus Unused Commitment for committed facilities only.</p>
                            </div>
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Calculation:</h5>
                                </div>
                                <p class="text-gray-600">OSUC = SUM(OSUC) where Committed/Uncommitted = "Committed". For committed facilities, OSUC = Facility_Amount - (Direct_OS + Contingent_OS + PSE_OS). Uncommitted facilities have OSUC = $0.</p>
                            </div>
                        </div>
                    `,
                },
                outstanding: {
                    title: "Total Outstanding - Methodology",
                    content: `
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">What This Metric Shows:</h5>
                                </div>
                                <p class="text-gray-600">Total Outstanding represents the combined credit exposure across all exposure types.</p>
                            </div>
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Calculation:</h5>
                                </div>
                                <p class="text-gray-600">Outstanding = SUM(Direct_OS) + SUM(Contingent_OS) + SUM(PSE_OS). This captures funded balances, contingent liabilities, and presettlement exposure.</p>
                            </div>
                        </div>
                    `,
                },
                facilities: {
                    title: "Total Facilities - Methodology",
                    content: `
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">What This Metric Shows:</h5>
                                </div>
                                <p class="text-gray-600">Total count of all facilities in the filtered portfolio.</p>
                            </div>
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Calculation:</h5>
                                </div>
                                <p class="text-gray-600">Facilities Count = COUNT(DISTINCT Facility_ID). Each row in the source data typically represents one facility.</p>
                            </div>
                        </div>
                    `,
                },
                relationships: {
                    title: "Total Relationships - Methodology",
                    content: `
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">What This Metric Shows:</h5>
                                </div>
                                <p class="text-gray-600">Total count of unique client relationships in the filtered portfolio.</p>
                            </div>
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Calculation:</h5>
                                </div>
                                <p class="text-gray-600">Relationships = COUNT(DISTINCT Relationship_ID or Relationship_Name). Multiple facilities may belong to the same relationship.</p>
                            </div>
                        </div>
                    `,
                },
                // Chart Cards Methodologies
                expiring: {
                    title: "CAs & Facilities Expiring - Methodology",
                    content: `
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">What This Chart Shows:</h5>
                                </div>
                                <p class="text-gray-600">Tracks Credit Agreements (CAs) and Facilities that are expiring within the next 3 months, plus expired items from the current reporting month.</p>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Calculation Logic:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong>CAs Expiring:</strong> Count unique CA_IDs where CA_Expiration_Date is within 90 days from the report date (excludes DM). For EMEA region only, count unique Relationship_IDs (instead of CA_IDs) and requires CA_Review = "Yes".</li>
                                    <li><strong>Facilities Expiring:</strong> Count Facility_IDs where Maturity_Date is within 90 days from the report date (excludes DM)</li>
                                    <li><strong>CAs Expired:</strong> Count unique CA_IDs where CA_Expiration_Date fell within the current reporting month (excludes DM). For EMEA region only, count unique Relationship_IDs instead of unique CA_IDs.</li>
                                    <li><strong>Facilities Expired:</strong> Count Facility_IDs where Maturity_Date fell within the current reporting month (excludes DM)</li>
                                    <li><strong>Amounts:</strong> Sum of Fac_Amount for respective CAs/facilities</li>
                                    <li><strong>Report Date Reference:</strong> All date comparisons (expiring/expired) are based on the report date from the data, not today's date</li>
                                    <li><strong>Weekend Exclusion Logic:</strong> If the report date is the last business day of the month AND there are weekend dates (Saturday/Sunday) after the report date within the same month, any CA/Facility expiring on those weekend dates are excluded, and the chart shows the next 3 complete months starting from the following month. If the last business day has no weekend dates after it (e.g., Dec 31st on a weekday), the current month is included normally.</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Key Columns Used:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><code class="bg-gray-100 px-1 rounded">CA_Expiration_Date</code> - For CA expiration tracking</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Maturity_Date</code> - For facility expiration tracking</li>
                                    <li><code class="bg-gray-100 px-1 rounded">CA_ID</code> - Unique CA identifier</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Facility_ID</code> - Unique facility identifier</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Fac_Amount</code> - Facility amount for value calculations</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Management_Status</code> - To exclude DM status</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Region</code> - For EMEA-specific logic (Relationship_ID counting and CA_Review filter)</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Relationship_ID</code> - For EMEA expired CAs counting</li>
                                    <li><code class="bg-gray-100 px-1 rounded">CA_Review</code> - For EMEA CAs expiring (must be "Yes")</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Report_Date</code> - Current reporting month reference (all expiring/expired comparisons use report date, not today's date)</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Filters Applied:</h5>
                                </div>
                                <p class="text-gray-600">Respects all active filters (Region, Status, Product Program, etc.) to show only relevant expirations and expired items.</p>
                            </div>
                        </div>
                    `,
                },
                newFacilities: {
                    title:
                        "New Facilities Approved  - Methodology",
                    content: `
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">What This Chart Shows:</h5>
                                </div>
                                <p class="text-gray-600">Distribution of newly approved facilities by Product Program for the selected reporting period.</p>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Calculation Logic:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong>Current Period:</strong> Facilities where Facility_First_Approval_Date falls within the current reporting month (1st to last day)</li>
                                    <li><strong>Previous Period:</strong> Facilities where Facility_First_Approval_Date falls within the previous month</li>
                                    <li><strong>Grouping:</strong> Aggregated by Product_Program</li>
                                    <li><strong>Count:</strong> Number of unique facilities per product program</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Key Columns Used:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><code class="bg-gray-100 px-1 rounded">Facility_First_Approval_Date</code> - Determines if facility is "new"</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Report_Date</code> - Identifies the current reporting month</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Product_Program</code> - Groups facilities by product type</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Facility_ID</code> - Counts unique new facilities</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Time Period:</h5>
                                </div>
                                <p class="text-gray-600">Captures entire month from 00:00:00 on 1st day to 23:59:59 on last day. Toggle between "Current" and "Previous" month using the period selector.</p>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Filters Applied:</h5>
                                </div>
                                <p class="text-gray-600">Respects all active filters to show new facilities within the selected criteria.</p>
                            </div>
                        </div>
                    `,
                },
                topRelationships: {
                    title: "Top Relationships - Methodology",
                    content: `
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">What This Chart Shows:</h5>
                                </div>
                                <p class="text-gray-600">Top N client relationships ranked by selected exposure metric (Direct OS, Contingent, Presettlement Exposure, OSUC, Undrawn, or TFA).</p>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Calculation Logic:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong>Aggregation:</strong> Sum all facility amounts per relationship</li>
                                    <li><strong>Ranking:</strong> Sort relationships by total exposure (highest to lowest)</li>
                                    <li><strong>Top N:</strong> Display top 10, 20, 50, or 100 relationships (configurable)</li>
                                    <li><strong>Dynamic Metric:</strong> Changes based on selected exposure type</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Key Columns Used:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><code class="bg-gray-100 px-1 rounded">Relationship_Name / Relationship_ID</code> - Groups by client</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Direct_OS</code> - Direct outstanding balance</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Contingent_OS</code> - Contingent outstanding balance</li>
                                    <li><code class="bg-gray-100 px-1 rounded">PSE_OS</code> - Presettlement Exposure outstanding balance</li>
                                    <li><code class="bg-gray-100 px-1 rounded">OSUC</code> - Outstanding under commitment (calculated from Fac_Amount - Direct_OS - Contingent_OS - PSE_OS for committed facilities)</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Unused_Committed</code> - Undrawn commitment (calculated from Fac_Amount - Direct_OS - Contingent_OS - PSE_OS for committed facilities)</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Facility_Amount</code> - Total facility amount</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Committed/Uncommitted</code> - Determines if OSUC and Unused_Committed are calculated or set to $0</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Exposure Types:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong>Direct:</strong> Direct outstanding balance</li>
                                    <li><strong>Contingent:</strong> Contingent liabilities</li>
                                    <li><strong>PSE:</strong> Presettlement Exposure</li>
                                    <li><strong>OSUC<sup class="text-blue-600">*</sup>:</strong> Outstanding Undrawn Committed - Calculated based on Committed/Uncommitted column. If "Committed", OSUC = Fac_Amount - (Direct_OS + Contingent_OS + PSE_OS); else 0</li>
                                    <li><strong>Undrawn<sup class="text-blue-600">*</sup>:</strong> Unused commitment - Calculated based on Committed/Uncommitted column. If "Committed", Unused_Committed = Fac_Amount - (Direct_OS + Contingent_OS + PSE_OS); else 0</li>
                                    <li><strong>TFA:</strong> Total Facility Amount (Total committed facility amounts)</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Filters Applied:</h5>
                                </div>
                                <p class="text-gray-600">Respects all active filters. The exposure type filter ONLY affects this chart.</p>
                            </div>
                        </div>
                    `,
                },
                rotce: {
                    title: "ROTCE Performance - Methodology",
                    content: `
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">What This Chart Shows:</h5>
                                </div>
                                <p class="text-gray-600">Return on Tangible Common Equity (ROTCE) performance for the Top N relationships. Shows average ROTCE percentage for each relationship with color-coded indicators (red = below 12%, green = 12% or above). This chart is synchronized with the Top Relationships chart and displays the same relationships.</p>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Calculation Logic:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong>Relationship Matching:</strong> Identifies the same Top N relationships as shown in the Top Relationships chart (based on Direct OS)</li>
                                    <li><strong>ROTCE Grouping:</strong> Groups all ROTCE values by relationship name</li>
                                    <li><strong>Average ROTCE:</strong> Calculates arithmetic mean of all ROTCE values for each relationship</li>
                                    <li><strong>Color Coding:</strong> Applies red color to bars where ROTCE < 12% (below target) and green color where ROTCE  12% (above target)</li>
                                    <li><strong>12% Threshold Line:</strong> Displays a vertical orange dashed line at 12% ROTCE with "Target: 12%" label to clearly indicate the performance benchmark</li>
                                    <li><strong>Horizontal Bar Chart:</strong> Displays relationships as horizontal bars for easy comparison</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Key Columns Used:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><code class="bg-gray-100 px-1 rounded">ROTCE</code> - Return on Tangible Common Equity percentage</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Relationship_Name / Relationship_ID</code> - Client relationship identifier</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Direct_OS</code> - Used to determine Top N relationships for matching</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Filters Applied:</h5>
                                </div>
                                <p class="text-gray-600">Respects all active filters. ROTCE calculations update dynamically based on filtered data. The Top N filter controls how many relationships to display (10, 20, 50, or 100) and is synchronized with the Top Relationships chart.</p>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Color Indicators:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong class="text-red-600">Red:</strong> ROTCE below 12% (below target performance)</li>
                                    <li><strong class="text-green-600">Green:</strong> ROTCE 12% or above (meets or exceeds target performance)</li>
                                </ul>
                            </div>
                        </div>
                    `,
                },
                newDealsYTD: {
                    title: "New Deals Closed YTD - Methodology",
                    content: `
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">What This Metric Shows:</h5>
                                </div>
                                <p class="text-gray-600">Tracks the count and total amount of new deals (unique facilities) that were closed year-to-date. A deal is considered "closed" if it has an Origination_Date within the current year (from January 1st to today). <strong>Note: PSE deals are always excluded from this metric.</strong></p>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Calculation Logic:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong>Time Period:</strong> January 1st of current year through today</li>
                                    <li><strong>Count:</strong> Number of unique facilities (by Facility_ID) with Origination_Date in this period</li>
                                    <li><strong>Amount:</strong> Sum of Facility_Amount (TFA) for these facilities</li>
                                    <li><strong>Variance:</strong> Compares current YTD to prior YTD (same period last year) as a percentage change</li>
                                    <li><strong>Color Coding:</strong> Green with up arrow = positive growth, Red with down arrow = negative growth</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Key Columns Used:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><code class="bg-gray-100 px-1 rounded">Origination_Date</code> - Determines when deal was closed</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Facility_ID</code> - Ensures unique facility count</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Facility_Amount</code> - Total facility amount (TFA)</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Filters Applied:</h5>
                                </div>
                                <p class="text-gray-600">Respects all active filters to show new deals within the selected criteria.</p>
                            </div>
                        </div>
                    `,
                },
                newDealsMTD: {
                    title: "New Deals Closed MTD - Methodology",
                    content: `
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">What This Metric Shows:</h5>
                                </div>
                                <p class="text-gray-600">Tracks the count and total amount of new deals (unique facilities) that were closed month-to-date. A deal is considered "closed" if it has an Origination_Date within the current month (from 1st of the month to today). <strong>Note: PSE deals are always excluded from this metric.</strong></p>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Calculation Logic:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong>Time Period:</strong> 1st of current month through today</li>
                                    <li><strong>Count:</strong> Number of unique facilities (by Facility_ID) with Origination_Date in this period</li>
                                    <li><strong>Amount:</strong> Sum of Facility_Amount (TFA) for these facilities</li>
                                    <li><strong>Variance:</strong> Compares current MTD to prior MTD (same period last month) as a percentage change</li>
                                    <li><strong>Color Coding:</strong> Green with up arrow = positive growth, Red with down arrow = negative growth</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Key Columns Used:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><code class="bg-gray-100 px-1 rounded">Origination_Date</code> - Determines when deal was closed</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Facility_ID</code> - Ensures unique facility count</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Facility_Amount</code> - Total facility amount (TFA)</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Filters Applied:</h5>
                                </div>
                                <p class="text-gray-600">Respects all active filters to show new deals within the selected criteria.</p>
                            </div>
                        </div>
                    `,
                },
                pipeline: {
                    title: "Deals Pending Closure - Methodology",
                    content: `
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">What This Table Shows:</h5>
                                </div>
                                <p class="text-gray-600">Tracks facilities that have been approved but not yet originated, grouped by how long they have been waiting since approval. Shows only data where the Facility_First_Approval_Date is in the current year. <strong>Note: PSE deals are always excluded from this table.</strong></p>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Calculation Logic:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong>Inclusion Criteria:</strong> Facilities where Origination_Date is empty/null AND Facility_First_Approval_Date year matches current year AND PSE_non-PSE is not "PSE" (non-PSE only) AND Region is NAM or LATAM only</li>
                                    <li><strong>Aging Calculation:</strong> Days Since Approval = Today's Date - Facility_First_Approval_Date</li>
                                    <li><strong>0-30 Days:</strong> 0-30 days since first approval</li>
                                    <li><strong>31-60 Days:</strong> 31-60 days since first approval</li>
                                    <li><strong>61-90 Days:</strong> 61-90 days since first approval</li>
                                    <li><strong>>90 Days:</strong> 91+ days since first approval</li>
                                    <li><strong>Count:</strong> Number of unique Facility_IDs in each bucket</li>
                                    <li><strong>Total TFA:</strong> Sum of Fac_Amount for facilities in each bucket</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Key Columns Used:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><code class="bg-gray-100 px-1 rounded">Origination_Date</code> - Must be empty/null for pipeline deals</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Facility_First_Approval_Date</code> - Starting point for aging calculation and year filter (must be in current year)</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Facility_ID</code> - For unique facility count</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Fac_Amount</code> - Total Facility Amount (TFA)</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Region</code> - Only NAM and LATAM regions included</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Facility_Type</code> - Excludes specific facility types</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Filters Applied:</h5>
                                </div>
                                <p class="text-gray-600 mb-2">This table has hardcoded filters that are always applied in addition to user-selected filters:</p>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong>Regions:</strong> Only NAM and LATAM (hardcoded)</li>
                                    <li><strong>Facility Types excluded:</strong> PSE, Cash Management, Clearing, TPC, B&I</li>
                                    <li><strong>User Filters:</strong> Respects other active filters (Status, Product Program, etc.)</li>
                                </ul>
                            </div>
                            
                            <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded">
                                <div class="flex items-start gap-2">
                                    <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div>
                                        <p class="font-semibold text-blue-900 text-sm">Note:</p>
                                        <p class="text-blue-800 text-sm">All 4 aging buckets (0-30, 31-60, 61-90, >90 Days) are always displayed. Buckets with zero facilities will show a count of 0. Only NAM and LATAM regions are included in this analysis.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `,
                },
                covenantsByProgram: {
                    title: "Covenants by Product Program - Methodology",
                    content: `
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">What This Table Shows:</h5>
                                </div>
                                <p class="text-gray-600">Summary of covenant counts grouped by Product Program. This provides a high-level view of covenant distribution across different product types in the portfolio.</p>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Calculation Logic:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong>Grouping:</strong> Data is grouped by Product_Program_Name from the covenant data file</li>
                                    <li><strong>Number of Covenants:</strong> Count of all covenant records for each Product Program</li>
                                    <li><strong>Sorting:</strong> Programs are sorted by covenant count in descending order (highest first)</li>
                                    <li><strong>Totals Row:</strong> Bottom row shows aggregate count across all programs</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Key Columns Used:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><code class="bg-gray-100 px-1 rounded">Product_Program_Name</code> - Product program classification for grouping</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Covenant_Number</code> - Covenant identifier</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Filters Applied:</h5>
                                </div>
                                <p class="text-gray-600">Respects all active filters (Region, Status, etc.) to show covenant distribution within the selected criteria. Updates dynamically when filters change.</p>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Use Case:</h5>
                                </div>
                                <p class="text-gray-600">This summary helps identify which product programs have the highest covenant monitoring requirements, enabling portfolio managers to prioritize resources and attention accordingly.</p>
                            </div>
                        </div>
                    `,
                },
                covenantMonitoring: {
                    title: "Covenant Monitoring - Methodology",
                    content: `
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">What This Chart Shows:</h5>
                                </div>
                                <p class="text-gray-600">A comprehensive covenant monitoring dashboard for Managing Directors showing both Past Due and Coming Due covenants. The radial gauge displays total covenant count, while the breakdown shows distribution by aging categories.</p>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12M8 12h12m-7 5h7M3 7h.01M3 12h.01M3 17h.01"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Two Views:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong>Past Due View:</strong> Shows covenants that have missed their deadline, categorized by severity in 3 aggregated buckets (1-45, 46-90, >90 days)</li>
                                    <li><strong>Coming Due View:</strong> Shows covenants approaching their deadline, categorized in 3 aggregated buckets (1-45, 46-90, >90 days)</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Calculation Logic:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong>Data Source:</strong> Covenants_tw.xlsx file</li>
                                    <li><strong>Status Filter:</strong> Filter by Coming_Due_Past_Due column value</li>
                                    <li><strong>Past Due:</strong> Donut chart displays all categories (<strong>1-45 Days</strong> lightest blue, <strong>46-90 Days</strong> medium blue, <strong>&gt;90 Days</strong> darkest blue) with color intensity increasing by severity. Center shows total past due count</li>
                                    <li><strong>Coming Due:</strong> Donut chart shows covenants due in the <strong>next 30 days</strong> calculated from Covenant_Due_Date, in green color. Center shows total coming due count</li>
                                    <li><strong>Custom Legend:</strong> Side-by-side layout with percentage and count for each category, matching the exact style of "New Facilities Approved "</li>
                                    <li><strong>Date Formats:</strong> Supports multiple formats including DD/MM/YYYY, YYYY-MM-DD, and MMM DD, YYYY (e.g., Jan 15, 2024)</li>
                                    <li><strong>Toggle Views:</strong> Switch between Past Due and Coming Due using the toggle buttons. Title, subtitle, center label, and legend update dynamically</li>
                                    <li><strong>Visual Style:</strong> Identical to "New Facilities Approved " chart - same colors, fonts, layout, legend style, and spacing</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Aggregated Risk Categories (Display Buckets):</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong class="text-red-700">>90 Days (Critical):</strong> Severe breach - immediate action required</li>
                                    <li><strong class="text-orange-600">46-90 Days (High):</strong> Escalated risk - urgent follow-up and remediation needed</li>
                                    <li><strong class="text-yellow-600">1-45 Days (Moderate):</strong> Recent past due - combines 0-30 and 31-45 day buckets from source file for consolidated view</li>
                                </ul>
                                <p class="text-sm text-gray-500 italic mt-2">Note: The source file (Covenants_tw.xlsx) contains more granular buckets (0-30, 31-45, 46-60, 61-90, >90 Days), which are aggregated here into 3 display buckets for clearer reporting.</p>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Key Columns Used:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><code class="bg-gray-100 px-1 rounded">Coming_Due_Past_Due</code> - Status indicator ("Past Due" or "Coming Due")</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Past_Due_Category</code> - Normalized aging classification (0-30, 31-45, 46-60, 61-90, >90 Days)</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Covenant_Number</code> - Unique covenant identifier</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Covenant_Due_Date</code> - Deadline for covenant compliance</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Days_Past_Due</code> - Number of days overdue (reference only)</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Relationship_Name</code> - Client relationship</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Decision Support:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong>Covenant Count:</strong> Number of covenants requiring attention in each status</li>
                                    <li><strong>Past Due Focus:</strong> Prioritize remediation based on aging severity</li>
                                    <li><strong>Coming Due Proactive:</strong> Early warning system to prevent future breaches</li>
                                    <li><strong>Risk Concentration:</strong> Identify if issues are concentrated in specific aging buckets</li>
                                    <li><strong>Trend Analysis:</strong> Monitor if Past Due population is growing or shrinking over time</li>
                                </ul>
                            </div>
                            
                            <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded">
                                <div class="flex items-start gap-2">
                                    <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div>
                                        <p class="font-semibold text-blue-900 text-sm">Toggle Between Views:</p>
                                        <p class="text-blue-800 text-sm">Use the Past Due/Coming Due toggle to switch between reactive (past due) and proactive (coming due) monitoring modes. Both views show total covenant count and detailed breakdowns by aging category.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-red-50 border-l-4 border-red-500 p-3 rounded">
                                <div class="flex items-start gap-2">
                                    <svg class="w-5 h-5 text-red-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                    </svg>
                                    <div>
                                        <p class="font-semibold text-red-900 text-sm">Critical Alert:</p>
                                        <p class="text-red-800 text-sm">Any Past Due covenants in the ">90 days" category represent critical covenant breaches requiring immediate attention. These may trigger cross-default provisions, require formal waivers, or necessitate credit committee review. High TFA exposure in Past Due status indicates elevated portfolio risk.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `,
                },
                covenantRegional: {
                    title: "Past Due Covenants by Region - Methodology",
                    content: `
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">What This Table Shows:</h5>
                                </div>
                                <p class="text-gray-600">Regional breakdown of past due covenants across time buckets (1-45 Days, 46-90 Days, >90 Days) with percentage of total and coming due covenants (next 30 days). Shows both Past Due and Coming Due regional distribution with visual progress bars for percentage comparison. Dynamically updates based on the Past Due/Coming Due toggle selection.</p>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Table Columns:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong>Region:</strong> Geographic region (APAC, EMEA, NAM, LATAM)</li>
                                    <li><strong>1-45 Days:</strong> Covenants past due for 1-45 days (combines 0-30 and 31-45 day buckets)</li>
                                    <li><strong>46-90 Days:</strong> Covenants past due for 46-90 days (combines 46-60 and 61-90 day buckets)</li>
                                    <li><strong>>90 Days:</strong> Covenants past due for more than 90 days</li>
                                    <li><strong>% Total:</strong> Percentage of covenants for the current view (Past Due or Coming Due) relative to the grand total of all covenants (Past Due + Coming Due across all regions)</li>
                                    <li><strong>Total:</strong> Sum of covenants for the current view (Past Due sum or Coming Due count) for that region</li>
                                    <li><strong>Population:</strong> Total count of all covenants for that region (Past Due + Coming Due combined)</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Calculation Logic:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong>Data Source:</strong> Covenants_tw.xlsx file</li>
                                    <li><strong>Past Due View:</strong>
                                        <ul class="list-circle list-inside ml-6 mt-1">
                                            <li>1-45 Days: 0-30 Days + 31-45 Days past due covenants</li>
                                            <li>46-90 Days: 46-60 Days + 61-90 Days past due covenants</li>
                                            <li>>90 Days: Covenants past due for more than 90 days</li>
                                            <li>Total: Sum of all three categories (1-45 + 46-90 + >90) per region</li>
                                            <li>% Total: (Region's Past Due Total / Grand Total of all covenants)  100</li>
                                        </ul>
                                    </li>
                                    <li><strong>Coming Due View:</strong>
                                        <ul class="list-circle list-inside ml-6 mt-1">
                                            <li>Due (30d): Covenants due within the next 30 days (from Covenant_Due_Date)</li>
                                            <li>Total: Count of coming due covenants per region</li>
                                            <li>% Total: (Region's Coming Due / Grand Total of all covenants)  100</li>
                                        </ul>
                                    </li>
                                    <li><strong>Population:</strong> Region's Past Due Total + Region's Coming Due (all covenants for that region)</li>
                                    <li><strong>Grand Total:</strong> Sum of all Past Due + all Coming Due across all regions</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Key Columns Used:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><code class="bg-gray-100 px-1 rounded">Region</code> - Geographic region classification</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Coming_Due_Past_Due</code> - Status indicator</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Past_Due_Category</code> - Normalized time bucket (0-30, 31-45, 46-60, 61-90, >90 Days)</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Covenant_Due_Date</code> - Deadline for compliance</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Covenant_Number</code> - Unique covenant identifier</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Business Insights:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong>Regional Risk Concentration:</strong> Identify which regions have the highest past due counts</li>
                                    <li><strong>Aging Analysis:</strong> Compare severity across regions (>90 days is most critical)</li>
                                    <li><strong>Proactive Management:</strong> Coming Due view helps prioritize upcoming compliance requirements</li>
                                    <li><strong>Resource Allocation:</strong> Direct compliance resources to regions with highest concentrations</li>
                                    <li><strong>Total Column:</strong> Shows overall regional exposure regardless of aging bucket</li>
                                </ul>
                            </div>
                            
                            <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded">
                                <div class="flex items-start gap-2">
                                    <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div>
                                        <p class="font-semibold text-blue-900 text-sm">Dynamic View Toggle:</p>
                                        <p class="text-blue-800 text-sm">This table updates dynamically when you toggle between Past Due and Coming Due views. The header columns and data adjust automatically to show the relevant time buckets or coming due period.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `,
                },
                ccmRegionalChart: {
                    title: "Criticized/Classified Memos & Reviews - Methodology",
                    content: `
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">What This Chart Shows:</h5>
                                </div>
                                <p class="text-gray-600">Regional distribution of Credit Committee Memos (CCMs) by status: Past Due, Coming Due, and Open. Displays the count of CCMs across APAC, EMEA, NAM, and LATAM regions in a stacked bar chart format.</p>
                            </div>
                            
                            <div class="bg-indigo-50 border-l-4 border-indigo-500 p-3 rounded">
                                <div class="flex items-start gap-2">
                                    <svg class="w-5 h-5 text-indigo-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                                    </svg>
                                    <div>
                                        <p class="font-semibold text-indigo-900 text-sm">ETL Process:</p>
                                        <p class="text-indigo-800 text-sm">Before loading the data, we have an ETL Process that standardizes the regional files into one unified dataset. The ETL filters out records where <code class="bg-indigo-100 px-1 rounded">Credit_Classification</code> equals "Pass" or "Loss", and keeps only records where <code class="bg-indigo-100 px-1 rounded">DM/CM_Flag</code> equals "CM". The process then standardizes the data and creates one consolidated file for this dashboard to consume.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Calculation Logic:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong>Data Source:</strong> CCM_tw.xlsx file (after ETL processing)</li>
                                    <li><strong>Past Due:</strong> CCMs where <code class="bg-gray-100 px-1 rounded">Next_CCM_Approval_Date</code> is before the reporting month</li>
                                    <li><strong>Coming Due:</strong> CCMs where <code class="bg-gray-100 px-1 rounded">Next_CCM_Approval_Date</code> falls within the reporting month</li>
                                    <li><strong>Open:</strong> CCMs where <code class="bg-gray-100 px-1 rounded">Next_CCM_Approval_Date</code> is after the reporting month</li>
                                    <li><strong>Regional Grouping:</strong> Aggregated by Region (APAC, EMEA, NAM, LATAM)</li>
                                    <li><strong>Visual Style:</strong> Vertical stacked bar chart with blue color gradient (Past Due: darkest, Coming Due: medium, Open: lightest)</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">Key Columns Used:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><code class="bg-gray-100 px-1 rounded">Report_Date</code> - Current reporting period</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Region</code> - Geographic region (APAC, EMEA, NAM, LATAM)</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Relationship_ID</code> - Unique relationship identifier</li>
                                    <li><code class="bg-gray-100 px-1 rounded">CAID</code> - Credit Agreement ID</li>
                                    <li><code class="bg-gray-100 px-1 rounded">DM/CM_Flag</code> - Designates if record is CM (Credit Memo)</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Credit_Classification</code> - Classification status (filtered for non-Pass/Loss)</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Next_CCM_Approval_Date</code> - When the CCM review is due</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Next_CCM_Month_End</code> - Month end date for the CCM</li>
                                    <li><code class="bg-gray-100 px-1 rounded">CCM_Status</code> - Calculated status (Past Due, Coming Due, Open)</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Client_Name</code> - Client name</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Classification</code> - Credit classification</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Frequency</code> - Review frequency</li>
                                    <li><code class="bg-gray-100 px-1 rounded">Underwriter</code> - Assigned underwriter</li>
                                </ul>
                            </div>
                            
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">ETL Filters Applied:</h5>
                                </div>
                                <ul class="list-disc list-inside space-y-1 text-gray-600">
                                    <li><strong>Credit_Classification:</strong> Excludes "Pass" and "Loss" classifications</li>
                                    <li><strong>DM/CM_Flag:</strong> Includes only "CM" (Credit Memo) records</li>
                                    <li><strong>Data Consolidation:</strong> Multiple regional source files merged into single standardized dataset</li>
                                    <li><strong>Field Standardization:</strong> Column names and formats normalized across regions</li>
                                </ul>
                            </div>
                            
                            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-3 rounded">
                                <div class="flex items-start gap-2">
                                    <svg class="w-5 h-5 text-yellow-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                    </svg>
                                    <div>
                                        <p class="font-semibold text-yellow-900 text-sm">Management Focus:</p>
                                        <p class="text-yellow-800 text-sm">Monitor CCM completion rates by region. Past Due CCMs indicate delayed credit reviews for criticized/classified relationships. Coming Due shows upcoming review requirements. Open status represents future scheduled reviews to ensure timely monitoring of at-risk exposures.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `,
                },
                ccmStats: {
                    title: "Criticized/Classified Memos & Reviews - Methodology",
                    content: `
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <h5 class="font-semibold text-gray-900">What This Chart Shows:</h5>
                                </div>
                                <p class="text-gray-600">Regional distribution of Credit Committee Memos (CCMs) by status: Past Due, Coming Due, and Open. Same data as the stacked bar chart above, providing an alternative view of CCM status across regions.</p>
                            </div>
                            
                            <div class="bg-indigo-50 border-l-4 border-indigo-500 p-3 rounded">
                                <div class="flex items-start gap-2">
                                    <svg class="w-5 h-5 text-indigo-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                                    </svg>
                                    <div>
                                        <p class="font-semibold text-indigo-900 text-sm">ETL Process:</p>
                                        <p class="text-indigo-800 text-sm">Before loading the data, we have an ETL Process that standardizes the regional files into one unified dataset. The ETL filters out records where <code class="bg-indigo-100 px-1 rounded">Credit_Classification</code> equals "Pass" or "Loss", and keeps only records where <code class="bg-indigo-100 px-1 rounded">DM/CM_Flag</code> equals "CM". The process then standardizes the data and creates one consolidated file for this dashboard to consume.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <p class="text-gray-600 text-sm italic">For detailed methodology, calculation logic, and column descriptions, please refer to the "Criticized/Classified Memos & Reviews" chart methodology above.</p>
                        </div>
                    `,
                },
            };

            // Get methodology content for the chart type
            const methodology = methodologies[chartType] || {
                title: "Chart Methodology",
                content:
                    '<p class="text-gray-600">Methodology information not available.</p>',
            };

            // Update modal content
            modalTitle.textContent = methodology.title;
            modalContent.innerHTML = methodology.content;

            // Show modal
            const modalEl = document.getElementById("methodologyModal");
            if (modalEl) {
                modalEl.classList.remove("hidden");
                modalEl.classList.add("flex");
                document.body.style.overflow = "hidden";
            }
        }

        // Close methodology modal
        function closeMethodologyModal() {
            const modalEl = document.getElementById("methodologyModal");
            if (modalEl) {
                modalEl.classList.add("hidden");
                modalEl.classList.remove("flex");
                document.body.style.overflow = "auto";
            }
        }

        // Export data from the modal (when modal is open)
        function exportModalData() {
            if (
                !window.currentChartData ||
                !window.currentChartData.data ||
                window.currentChartData.data.length === 0
            ) {
                showNotification("Export Failed", "No data available to export", "error");
                return;
            }

            // Check if XLSX library is loaded
            if (typeof XLSX === "undefined") {
                showNotification(
                    "Export Failed",
                    "Export library not loaded. Please refresh the page and try again.",
                    "error"
                );
                return;
            }

            const data = window.currentChartData.data;
            const chartName = window.currentChartData.chartName;

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, "Data");

            // Generate filename with chart name and date
            const dateStr = new Date().toISOString().split("T")[0];
            const filename = `${chartName}_${dateStr}.xlsx`;

            // Download file
            XLSX.writeFile(wb, filename);
        }

        // Export chart data to XLSX
        function exportChartData(chartType) {
            // Check if data is loaded
            if (!portfolioData || portfolioData.length === 0) {
                showNotification("Export Failed", "No data available. Please ensure the data is loaded first.", "error");
                return;
            }

            // Check if XLSX library is loaded
            if (typeof XLSX === "undefined") {
                showNotification(
                    "Export Failed",
                    "Export library not loaded. Please refresh the page and try again.",
                    "error"
                );
                return;
            }

            // Get data based on chart type
            let data = [];
            let chartName = "";

            switch (chartType) {
                case "expiring":
                    chartName = "CAs_Facilities_Expiring";
                    data = getExpiringData();
                    break;
                case "newFacilities":
                    chartName = "New_Facilities_by_Product_Program";
                    data = getNewFacilitiesData();
                    break;
                case "topRelationships":
                    chartName =
                        "Top_Relationships_by_" + selectedAmountType.toUpperCase();
                    data = getTopRelationshipsData();
                    break;
                case "rotce":
                    chartName = "ROTCE_Performance";
                    data = getROTCEData();
                    break;
                case "newDealsYTD":
                    chartName = "New_Deals_Closed_YTD";
                    data = getNewDealsYTDData();
                    break;
                case "newDealsMTD":
                    chartName = "New_Deals_Closed_MTD";
                    data = getNewDealsMTDData();
                    break;
                case "covenantsByProgram":
                    chartName = "Covenants_by_Product_Program";
                    data = getCovenantsByProgramData();
                    break;
                case "covenantMonitoring":
                    chartName = currentCovenantViewType === 'pastDue' ? "Covenants_Past_Due" : "Covenants_Coming_Due";
                    data = getCovenantMonitoringData();
                    break;
                case "covenantRegional":
                    chartName = currentCovenantViewType === 'pastDue' ? "Covenants_Past_Due_by_Region" : "Covenants_Coming_Due_by_Region";
                    data = getCovenantRegionalData();
                    break;
                case "ccmRegionalChart":
                    chartName = "CCM_by_Region";
                    data = getCCMFilteredData();
                    break;
                case "ccmStats":
                    chartName = "Credit_Committee_Memos";
                    data = getCCMFilteredData();
                    break;
            }

            console.log(
                "Export chart data:",
                chartType,
                "Records found:",
                data ? data.length : 0
            );

            if (!data || data.length === 0) {
                showNotification(
                    "Export Failed",
                    "No data to export for this chart. Please check your filters or ensure data matches the chart criteria.",
                    "warning"
                );
                return;
            }

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, "Data");

            // Generate filename with chart name and date
            const dateStr = new Date().toISOString().split("T")[0];
            const filename = `${chartName}_${dateStr}.xlsx`;

            // Download file
            XLSX.writeFile(wb, filename);
        }
    </script>
</body>

</html>
