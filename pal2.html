<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portfolio Analytics Lending</title>
    <!-- Alpine.js for reactive components -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        success: {
                            50: '#f0fdf4',
                            500: '#10b981',
                            600: '#059669',
                            700: '#047857'
                        },
                        danger: '#dc2626',
                        warning: '#f59e0b'
                    },
                    boxShadow: {
                        'theme-lg': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    </script>
    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- jsvectormap for regional distribution maps -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsvectormap@1.5.3/dist/css/jsvectormap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsvectormap@1.5.3/dist/js/jsvectormap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsvectormap@1.5.3/dist/maps/world.js"></script>
    <!-- SheetJS for Excel/CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- html2canvas for PNG export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* DataTable Custom Styles */
        .text-theme-xs {
            font-size: 0.75rem;
            line-height: 1rem;
        }
        .text-theme-sm {
            font-size: 0.875rem;
            line-height: 1.25rem;
        }
        .shadow-theme-xs {
            box-shadow: 0 1px 2px 0 rgba(16, 24, 40, 0.05);
        }
        .text-brand-500 {
            color: #3b82f6;
        }
        .focus\:border-brand-300:focus {
            border-color: #93c5fd;
        }
        .focus\:ring-brand-500\/10:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        /* Minimum table body height to prevent popover from overlapping footer */
        .table-body-wrapper {
            min-height: 400px;
        }
        [x-cloak] {
            display: none !important;
        }
        
        /* Custom scrollbar styles */
        .custom-scrollbar::-webkit-scrollbar {
            height: 6px;
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* TailAdmin custom theme sizes */
        .text-theme-sm {
            font-size: 0.875rem;
            /* 14px */
            line-height: 1.25rem;
            /* 20px */
        }

        /* Chart dark style for consistent sizing */
        .chartDarkStyle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 280px;
            height: 280px;
        }
        
        @media (max-width: 640px) {
            .chartDarkStyle {
                width: 280px;
                height: 280px;
            }
        }
        
        @media (min-width: 2600px) {
            .chartDarkStyle {
                width: 240px;
                height: 240px;
            }
        }

        /* Consistent Tooltip Styling for All Charts */
        .apexcharts-tooltip {
            background: #ffffff !important;
            border: 1px solid #e5e7eb !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
            color: #1f2937 !important;
            border-radius: 8px !important;
            z-index: 99999 !important;
            pointer-events: none !important;
        }
        
        /* Ensure chart containers allow tooltip overflow */
        #relationshipChart,
        #rotceChart,
        #covenantMonitoringChart,
        #ccmRegionalChart {
            position: relative !important;
            overflow: visible !important;
        }
        
        #relationshipChart .apexcharts-canvas,
        #rotceChart .apexcharts-canvas,
        #covenantMonitoringChart .apexcharts-canvas,
        #ccmRegionalChart .apexcharts-canvas {
            overflow: visible !important;
        }
        
        /* Ensure parent containers don't clip tooltips */
        #relationshipChart > div,
        #rotceChart > div,
        #covenantMonitoringChart > div,
        #ccmRegionalChart > div,
        #relationshipChart .apexcharts-inner,
        #rotceChart .apexcharts-inner,
        #covenantMonitoringChart .apexcharts-inner,
        #ccmRegionalChart .apexcharts-inner {
            overflow: visible !important;
        }
        
        /* ApexCharts specific tooltip container */
        .apexcharts-tooltip.apexcharts-theme-light {
            overflow: visible !important;
        }
        
        /* Rounded legend markers */
        .apexcharts-legend-marker {
            border-radius: 3px !important;
        }
        
        .apexcharts-tooltip-custom {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .apexcharts-tooltip * {
            color: inherit !important;
        }
        
        .apexcharts-tooltip .apexcharts-tooltip-title {
            background: #f9fafb !important;
            border-bottom: 1px solid #e5e7eb !important;
            color: #1f2937 !important;
        }

        /* Notification animations */
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Z-index utilities */
        .z-9999 {
            z-index: 9999;
        }

        /* Loading Overlay Styles - Optimized for independent, uninterrupted animations */
        @keyframes bit {
            from { opacity: 0.3; }
            to { opacity: 1; }
        }
        
        @keyframes spinner {
            0% { opacity: 1; }
            100% { opacity: 0.3; }
        }
        
        /* Text animation - completely isolated from state changes */
        .animate-bit {
            animation: bit 0.6s alternate infinite;
            will-change: opacity;
            /* GPU acceleration for smooth animation */
            transform: translateZ(0);
            backface-visibility: hidden;
            /* Prevent text updates from interrupting animation */
            pointer-events: none;
        }
        
        /* Spinner container - isolated animation layer */
        .loader-container {
            /* Create separate compositing layer for optimal performance */
            transform: translateZ(0);
            will-change: transform;
            /* Ensure animations run on GPU */
            -webkit-transform: translate3d(0, 0, 0);
        }
        
        /* Spinner items - independent rotation animations */
        .loader-item {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-origin: 40px 40px;
            animation: spinner 1.2s linear infinite;
            /* Force GPU acceleration */
            will-change: opacity;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        
        .loader-item:after {
            content: " ";
            display: block;
            position: absolute;
            top: 3px;
            left: 37px;
            width: 6px;
            height: 18px;
            border-radius: 20%;
            /* GPU acceleration for pseudo-elements */
            transform: translateZ(0);
        }
        
        /* Color gradient for spinner bars */
        .loader-item:nth-child(1):after { background: #1e40af; }
        .loader-item:nth-child(2):after { background: #2563eb; }
        .loader-item:nth-child(3):after { background: #3b82f6; }
        .loader-item:nth-child(4):after { background: #60a5fa; }
        .loader-item:nth-child(5):after { background: #93c5fd; }
        .loader-item:nth-child(6):after { background: #bfdbfe; }
        .loader-item:nth-child(7):after { background: #93c5fd; }
        .loader-item:nth-child(8):after { background: #60a5fa; }
        .loader-item:nth-child(9):after { background: #3b82f6; }
        .loader-item:nth-child(10):after { background: #2563eb; }
        .loader-item:nth-child(11):after { background: #1e40af; }
        .loader-item:nth-child(12):after { background: #1e3a8a; }
        
        /* Rotation and animation delays for each bar */
        .loader-item:nth-child(1) {
            transform: rotate(0deg);
            animation-delay: -1.1s;
        }
        
        .loader-item:nth-child(2) {
            transform: rotate(30deg);
            animation-delay: -1s;
        }
        
        .loader-item:nth-child(3) {
            transform: rotate(60deg);
            animation-delay: -0.9s;
        }
        
        .loader-item:nth-child(4) {
            transform: rotate(90deg);
            animation-delay: -0.8s;
        }
        
        .loader-item:nth-child(5) {
            transform: rotate(120deg);
            animation-delay: -0.7s;
        }
        
        .loader-item:nth-child(6) {
            transform: rotate(150deg);
            animation-delay: -0.6s;
        }
        
        .loader-item:nth-child(7) {
            transform: rotate(180deg);
            animation-delay: -0.5s;
        }
        
        .loader-item:nth-child(8) {
            transform: rotate(210deg);
            animation-delay: -0.4s;
        }
        
        .loader-item:nth-child(9) {
            transform: rotate(240deg);
            animation-delay: -0.3s;
        }
        
        .loader-item:nth-child(10) {
            transform: rotate(270deg);
            animation-delay: -0.2s;
        }
        
        .loader-item:nth-child(11) {
            transform: rotate(300deg);
            animation-delay: -0.1s;
        }
        
        .loader-item:nth-child(12) {
            transform: rotate(330deg);
            animation-delay: 0s;
        }
        
        /* Critical: Ensure animations NEVER pause regardless of state */
        #loadingOverlay,
        #loadingOverlay *,
        .loader-item,
        .loader-item:after,
        .animate-bit {
            animation-play-state: running !important;
            -webkit-animation-play-state: running !important;
        }
        
        /* Isolate loading overlay on separate layer */
        #loadingOverlay {
            /* Create independent stacking context */
            transform: translateZ(0);
            will-change: contents;
            /* Prevent parent operations from affecting animations */
            isolation: isolate;
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Loading Overlay -->
    <div id="loadingOverlay"
        class="fixed inset-0 bg-gray-100 z-[10000] flex items-center justify-center hidden">
        <div class="w-[450px] h-[250px] rounded-[10px] bg-white flex flex-col items-center justify-evenly p-[30px] shadow-[2px_2px_10px_-5px_lightgrey] aspect-square">
            <!-- Text animation layer - isolated from state changes -->
            <label id="loadingMessage" class="text-gray-900 text-lg font-semibold animate-bit">Please wait...</label>
            
            <!-- Spinner animation layer - runs independently on GPU -->
            <div class="loader-container inline-block relative w-20 h-20">
                <div class="loader-item"></div>
                <div class="loader-item"></div>
                <div class="loader-item"></div>
                <div class="loader-item"></div>
                <div class="loader-item"></div>
                <div class="loader-item"></div>
                <div class="loader-item"></div>
                <div class="loader-item"></div>
                <div class="loader-item"></div>
                <div class="loader-item"></div>
                <div class="loader-item"></div>
                <div class="loader-item"></div>
            </div>
        </div>
    </div>

    <div class="p-4 md:p-6">
        <!-- Portfolio Overview Content -->
        <!-- Page Header -->
        <div class="mb-6 rounded-2xl border border-gray-200 bg-white p-5">
            <!-- First Row: Search Bar, Action Buttons, and Last Updated -->
            <div class="flex items-center justify-between gap-4 mb-5">
                <!-- Left: Search Input -->
                <div class="relative flex-1 max-w-2xl">
                    <span class="pointer-events-none absolute top-1/2 left-4 -translate-y-1/2">
                        <svg class="fill-gray-500" width="20" height="20" viewBox="0 0 20 20" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd"
                                d="M3.04199 9.37381C3.04199 5.87712 5.87735 3.04218 9.37533 3.04218C12.8733 3.04218 15.7087 5.87712 15.7087 9.37381C15.7087 12.8705 12.8733 15.7055 9.37533 15.7055C5.87735 15.7055 3.04199 12.8705 3.04199 9.37381ZM9.37533 1.54218C5.04926 1.54218 1.54199 5.04835 1.54199 9.37381C1.54199 13.6993 5.04926 17.2055 9.37533 17.2055C11.2676 17.2055 13.0032 16.5346 14.3572 15.4178L17.1773 18.2381C17.4702 18.531 17.945 18.5311 18.2379 18.2382C18.5308 17.9453 18.5309 17.4704 18.238 17.1775L15.4182 14.3575C16.5367 13.0035 17.2087 11.2671 17.2087 9.37381C17.2087 5.04835 13.7014 1.54218 9.37533 1.54218Z"
                                fill=""></path>
                        </svg>
                    </span>
                    <input type="text" id="searchInput" placeholder="Search facilities, relationships, or any data..." 
                        class="h-11 w-full rounded-lg border border-gray-300 bg-white py-3 pr-4 pl-12 text-sm text-gray-800 placeholder:text-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 focus:outline-none shadow-sm" />
                </div>
                    
                <!-- Right: Last Updated -->
                <div class="text-right shrink-0">
                    <p class="text-xs text-gray-400 font-medium">Last Updated</p>
                    <p class="text-sm font-semibold text-gray-600" id="reportDate">
                        --
                    </p>
                </div>
            </div>
            
            <!-- Second Row: All Filter Tabs -->
            <div class="flex flex-wrap items-center gap-4">
                <!-- Region Tabs -->
                <div class="flex items-center gap-2">
                    <span class="text-xs font-medium text-gray-500 tracking-wider">Region:</span>
                    <div class="inline-flex items-center gap-0.5 rounded-lg bg-gray-100 p-0.5">
                        <button id="btnRegionAll" onclick="selectRegionFilter('all')" 
                            class="min-w-[50px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white">
                            All
                        </button>
                        <button id="btnRegionAPAC" onclick="selectRegionFilter('APAC')" 
                            class="min-w-[50px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            APAC
                        </button>
                        <button id="btnRegionEMEA" onclick="selectRegionFilter('EMEA')" 
                            class="min-w-[50px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            EMEA
                        </button>
                        <button id="btnRegionLATAM" onclick="selectRegionFilter('LATAM')" 
                            class="min-w-[60px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            LATAM
                        </button>
                        <button id="btnRegionNAM" onclick="selectRegionFilter('NAM')" 
                            class="min-w-[50px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            NAM
                        </button>
                    </div>
                    </div>
                    
                <!-- Divider -->
                <div class="h-8 w-px bg-gray-300"></div>

                <!-- Status Filter -->
                <div class="flex items-center gap-2">
                    <span class="text-xs font-medium text-gray-500 tracking-wider">Status:</span>
                    <div class="inline-flex items-center gap-0.5 rounded-lg bg-gray-100 p-0.5">
                        <button id="btnStatusAll" onclick="selectStatusFilter('all')" 
                            class="min-w-[45px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white">
                            All
                        </button>
                        <button id="btnStatusCM" onclick="selectStatusFilter('CM')" 
                            class="min-w-[45px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            CM
                        </button>
                        <button id="btnStatusDM" onclick="selectStatusFilter('DM')" 
                            class="min-w-[45px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            DM
                        </button>
                    </div>
                </div>

                <!-- Divider -->
                <div class="h-8 w-px bg-gray-300"></div>

                <!-- PSE Filter -->
                <div class="flex items-center gap-2">
                    <span class="text-xs font-medium text-gray-500 tracking-wider">PSE:</span>
                    <div class="inline-flex items-center gap-0.5 rounded-lg bg-gray-100 p-0.5">
                        <button id="btnPSEAll" onclick="selectPSEFilter('all')" 
                            class="min-w-[50px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white">
                            All
                        </button>
                        <button id="btnPSEPSE" onclick="selectPSEFilter('PSE')" 
                            class="min-w-[50px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            PSE
                        </button>
                        <button id="btnPSENonPSE" onclick="selectPSEFilter('non-PSE')" 
                            class="min-w-[75px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                            non-PSE
                        </button>
                    </div>
                </div>

                <!-- Divider -->
                <div class="h-8 w-px bg-gray-300"></div>

                <!-- Action Buttons -->
                <div class="flex items-center gap-2">
                    <button onclick="toggleFilterPopover()" id="filterButtonInline"
                        class="relative flex items-center gap-1.5 rounded-lg border border-gray-300 bg-white px-3 py-2 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z">
                            </path>
                        </svg>
                        <span>More Filters</span>
                        <span id="filterCountInline"
                            class="hidden absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-blue-500 text-[10px] font-bold text-white"></span>
                    </button>

                    <button onclick="resetAllFilters()" 
                        class="flex items-center gap-1.5 rounded-lg border border-gray-300 bg-white px-3 py-2 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                            </path>
                        </svg>
                        <span>Reset Filters</span>
                    </button>

                    <!-- Export Dropdown -->
                    <div x-data="{ exportOpen: false }" class="relative">
                        <button @click="exportOpen = !exportOpen" @click.away="exportOpen = false"
                            class="flex items-center gap-1.5 rounded-lg bg-blue-600 hover:bg-blue-700 px-3 py-2 text-xs font-medium text-white transition-colors">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                </path>
                            </svg>
                            <span>Export Report</span>
                            <svg class="w-3 h-3 transition-transform" :class="exportOpen ? 'rotate-180' : ''"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        
                        <!-- Dropdown Menu -->
                        <div x-show="exportOpen" x-transition:enter="transition ease-out duration-100"
                            x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
                            x-transition:leave="transition ease-in duration-75"
                            x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
                            class="absolute right-0 mt-2 w-44 rounded-lg border border-gray-200 bg-white shadow-xl z-10"
                            style="display: none">
                            <div class="py-1">
                                <button onclick="exportToExcel()"
                                    class="flex w-full items-center gap-2.5 px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 transition-colors">
                                    <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                        </path>
                                    </svg>
                                    <span class="font-medium">Excel (.xlsx)</span>
                                </button>
                                <button onclick="exportToPDF()"
                                    class="flex w-full items-center gap-2.5 px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 transition-colors">
                                    <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z">
                                        </path>
                                    </svg>
                                    <span class="font-medium">PDF (.pdf)</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Active Filters Badges -->
            <div id="activeFiltersBadges" class="flex flex-wrap gap-2 mt-4 pt-4 border-t border-gray-200"
                style="display: none">
                <!-- Badges will be dynamically added here -->
            </div>
            
            <!-- Footnote -->
            <p class="text-sm text-gray-400 mt-4 pt-3 border-t border-gray-100">
                <span class="italic">Note:</span> OSUC and Outstanding balances are from regional credit platforms.
            </p>
        </div>

        <!-- Advanced Filters Modal -->
        <div id="filterPopover"
            class="hidden fixed inset-0 flex items-center justify-center p-5 overflow-y-auto z-[9999]">
            <!-- Backdrop -->
            <div class="fixed inset-0 h-full w-full bg-gray-400/50 backdrop-blur-[32px]"
                onclick="toggleFilterPopover()"></div>
            
            <!-- Modal Content -->
            <div class="relative w-full max-w-[900px] rounded-3xl bg-white p-6 shadow-xl lg:p-10">
                <!-- Close Button -->
                <button onclick="toggleFilterPopover()" type="button"
                    class="absolute right-3 top-3 z-[9999] flex h-9.5 w-9.5 items-center justify-center rounded-full bg-gray-100 text-gray-400 transition-colors hover:bg-gray-200 hover:text-gray-700 sm:right-6 sm:top-6 sm:h-11 sm:w-11 cursor-pointer">
                    <svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M6.04289 16.5413C5.65237 16.9318 5.65237 17.565 6.04289 17.9555C6.43342 18.346 7.06658 18.346 7.45711 17.9555L11.9987 13.4139L16.5408 17.956C16.9313 18.3466 17.5645 18.3466 17.955 17.956C18.3455 17.5655 18.3455 16.9323 17.955 16.5418L13.4129 11.9997L17.955 7.4576C18.3455 7.06707 18.3455 6.43391 17.955 6.04338C17.5645 5.65286 16.9313 5.65286 16.5408 6.04338L11.9987 10.5855L7.45711 6.0439C7.06658 5.65338 6.43342 5.65338 6.04289 6.0439C5.65237 6.43442 5.65237 7.06759 6.04289 7.45811L10.5845 11.9997L6.04289 16.5413Z"
                            fill="" />
                            </svg>
                        </button>

                            <div>
                    <!-- Header -->
                    <h4 class="font-semibold text-gray-800 mb-2 text-title-sm">
                        Advanced Filters
                    </h4>
                    <p class="text-sm leading-6 text-gray-500 mb-7">
                        Refine your portfolio view with detailed filter criteria
                    </p>

                    <!-- Filter Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <!-- Product Program Filter -->
                        <div x-data="{ open: false, selected: 'All Programs', options: [] }" x-init="options = Array.from(document.getElementById('filterProductProgram')?.options || []).map(o => ({value: o.value, text: o.text}))">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Product Program
                            </label>
                            <div class="relative">
                                <button @click="open = !open" type="button"
                                    class="inline-flex items-center justify-between w-full gap-2 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                    <span x-text="selected"></span>
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                                <div x-show="open" @click.outside="open = false" x-cloak
                                    class="absolute left-0 right-0 top-full z-[9999] max-h-60 overflow-auto space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                    <template x-for="option in options" :key="option.value">
                                        <button type="button"
                                            @click="selected = option.text; open = false; document.getElementById('filterProductProgram').value = option.value; applyFilters();"
                                            :class="selected === option.text ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                            class="flex w-full rounded-lg px-3 py-1.5 text-left text-sm font-medium transition-colors"
                                            x-text="option.text">
                                        </button>
                                    </template>
                                </div>
                                <select id="filterProductProgram" class="hidden">
                                    <option value="">All Programs</option>
                                </select>
                            </div>
                        </div>

                        <!-- Extending Unit Filter -->
                        <div x-data="{ open: false, selected: 'All Units', options: [] }" x-init="options = Array.from(document.getElementById('filterExtendingUnit')?.options || []).map(o => ({value: o.value, text: o.text}))">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Extending Unit
                            </label>
                            <div class="relative">
                                <button @click="open = !open" type="button"
                                    class="inline-flex items-center justify-between w-full gap-2 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                    <span x-text="selected"></span>
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                                <div x-show="open" @click.outside="open = false" x-cloak
                                    class="absolute left-0 right-0 top-full z-[9999] max-h-60 overflow-auto space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                    <template x-for="option in options" :key="option.value">
                                        <button type="button"
                                            @click="selected = option.text; open = false; document.getElementById('filterExtendingUnit').value = option.value; applyFilters();"
                                            :class="selected === option.text ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                            class="flex w-full rounded-lg px-3 py-1.5 text-left text-sm font-medium transition-colors"
                                            x-text="option.text">
                                        </button>
                                    </template>
                                </div>
                                <select id="filterExtendingUnit" class="hidden">
                                    <option value="">All Units</option>
                                </select>
                            </div>
                        </div>

                        <!-- Facility Type Filter -->
                        <div x-data="{ open: false, selected: 'All Types', options: [] }" x-init="options = Array.from(document.getElementById('filterFacilityType')?.options || []).map(o => ({value: o.value, text: o.text}))">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Facility Type
                            </label>
                            <div class="relative">
                                <button @click="open = !open" type="button"
                                    class="inline-flex items-center justify-between w-full gap-2 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                    <span x-text="selected"></span>
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                                <div x-show="open" @click.outside="open = false" x-cloak
                                    class="absolute left-0 right-0 top-full z-[9999] max-h-60 overflow-auto space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                    <template x-for="option in options" :key="option.value">
                                        <button type="button"
                                            @click="selected = option.text; open = false; document.getElementById('filterFacilityType').value = option.value; applyFilters();"
                                            :class="selected === option.text ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                            class="flex w-full rounded-lg px-3 py-1.5 text-left text-sm font-medium transition-colors"
                                            x-text="option.text">
                                        </button>
                                    </template>
                                </div>
                                <select id="filterFacilityType" class="hidden">
                                    <option value="">All Types</option>
                                </select>
                            </div>
                        </div>

                        <!-- Commitment Status Filter -->
                        <div x-data="{ open: false, selected: 'All', options: [] }" x-init="options = Array.from(document.getElementById('filterCommitment')?.options || []).map(o => ({value: o.value, text: o.text}))">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Commitment Status
                            </label>
                            <div class="relative">
                                <button @click="open = !open" type="button"
                                    class="inline-flex items-center justify-between w-full gap-2 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                    <span x-text="selected"></span>
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                                <div x-show="open" @click.outside="open = false" x-cloak
                                    class="absolute left-0 right-0 top-full z-[9999] max-h-60 overflow-auto space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                    <template x-for="option in options" :key="option.value">
                                        <button type="button"
                                            @click="selected = option.text; open = false; document.getElementById('filterCommitment').value = option.value; applyFilters();"
                                            :class="selected === option.text ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                            class="flex w-full rounded-lg px-3 py-1.5 text-left text-sm font-medium transition-colors"
                                            x-text="option.text">
                                        </button>
                                    </template>
                                </div>
                                <select id="filterCommitment" class="hidden">
                                    <option value="">All</option>
                                </select>
                            </div>
                        </div>

                        <!-- Team Lead Filter -->
                        <div x-data="{ open: false, selected: 'All Team Leads', options: [] }" x-init="options = Array.from(document.getElementById('filterTeamLead')?.options || []).map(o => ({value: o.value, text: o.text}))">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Team Lead
                            </label>
                            <div class="relative">
                                <button @click="open = !open" type="button"
                                    class="inline-flex items-center justify-between w-full gap-2 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                    <span x-text="selected"></span>
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                                <div x-show="open" @click.outside="open = false" x-cloak
                                    class="absolute left-0 right-0 top-full z-[9999] max-h-60 overflow-auto space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                    <template x-for="option in options" :key="option.value">
                                        <button type="button"
                                            @click="selected = option.text; open = false; document.getElementById('filterTeamLead').value = option.value; applyFilters();"
                                            :class="selected === option.text ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                            class="flex w-full rounded-lg px-3 py-1.5 text-left text-sm font-medium transition-colors"
                                            x-text="option.text">
                                        </button>
                                    </template>
                                </div>
                                <select id="filterTeamLead" class="hidden">
                                    <option value="">All Team Leads</option>
                                </select>
                            </div>
                        </div>

                        <!-- Underwriter Filter -->
                        <div x-data="{ open: false, selected: 'All Underwriters', options: [] }" x-init="options = Array.from(document.getElementById('filterUnderwriter')?.options || []).map(o => ({value: o.value, text: o.text}))">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Underwriter
                            </label>
                            <div class="relative">
                                <button @click="open = !open" type="button"
                                    class="inline-flex items-center justify-between w-full gap-2 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                    <span x-text="selected"></span>
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                                <div x-show="open" @click.outside="open = false" x-cloak
                                    class="absolute left-0 right-0 top-full z-[9999] max-h-60 overflow-auto space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                    <template x-for="option in options" :key="option.value">
                                        <button type="button"
                                            @click="selected = option.text; open = false; document.getElementById('filterUnderwriter').value = option.value; applyFilters();"
                                            :class="selected === option.text ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                            class="flex w-full rounded-lg px-3 py-1.5 text-left text-sm font-medium transition-colors"
                                            x-text="option.text">
                                        </button>
                                    </template>
                                </div>
                                <select id="filterUnderwriter" class="hidden">
                                    <option value="">All Underwriters</option>
                                </select>
                            </div>
                        </div>

                        <!-- CA Maturity Filter -->
                        <div x-data="{ open: false, selected: 'All Dates', options: [
                            {value: '', text: 'All Dates'},
                            {value: '30', text: 'Next 30 Days'},
                            {value: '60', text: 'Next 60 Days'},
                            {value: '90', text: 'Next 90 Days'},
                            {value: '180', text: 'Next 6 Months'},
                            {value: '365', text: 'Next Year'}
                        ] }">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                CAs Maturing
                            </label>
                            <div class="relative">
                                <button @click="open = !open" type="button"
                                    class="inline-flex items-center justify-between w-full gap-2 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                    <span x-text="selected"></span>
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                                <div x-show="open" @click.outside="open = false" x-cloak
                                    class="absolute left-0 right-0 top-full z-[9999] max-h-60 overflow-auto space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                    <template x-for="option in options" :key="option.value">
                                        <button type="button"
                                            @click="selected = option.text; open = false; document.getElementById('filterCAMaturity').value = option.value; applyFilters();"
                                            :class="selected === option.text ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                            class="flex w-full rounded-lg px-3 py-1.5 text-left text-sm font-medium transition-colors"
                                            x-text="option.text">
                                        </button>
                                    </template>
                                </div>
                                <select id="filterCAMaturity" class="hidden">
                                    <option value="">All Dates</option>
                                    <option value="30">Next 30 Days</option>
                                    <option value="60">Next 60 Days</option>
                                    <option value="90">Next 90 Days</option>
                                    <option value="180">Next 6 Months</option>
                                    <option value="365">Next Year</option>
                                </select>
                            </div>
                        </div>

                        <!-- Facility Maturity Filter -->
                        <div x-data="{ open: false, selected: 'All Dates', options: [
                            {value: '', text: 'All Dates'},
                            {value: '30', text: 'Next 30 Days'},
                            {value: '60', text: 'Next 60 Days'},
                            {value: '90', text: 'Next 90 Days'},
                            {value: '180', text: 'Next 6 Months'},
                            {value: '365', text: 'Next Year'}
                        ] }">
                            <label class="mb-1.5 block text-sm font-medium text-gray-700">
                                Facilities Maturing
                            </label>
                            <div class="relative">
                                <button @click="open = !open" type="button"
                                    class="inline-flex items-center justify-between w-full gap-2 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                    <span x-text="selected"></span>
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                                <div x-show="open" @click.outside="open = false" x-cloak
                                    class="absolute left-0 right-0 top-full z-[9999] max-h-60 overflow-auto space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                    <template x-for="option in options" :key="option.value">
                                        <button type="button"
                                            @click="selected = option.text; open = false; document.getElementById('filterFacilityMaturity').value = option.value; applyFilters();"
                                            :class="selected === option.text ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                            class="flex w-full rounded-lg px-3 py-1.5 text-left text-sm font-medium transition-colors"
                                            x-text="option.text">
                                        </button>
                                    </template>
                                </div>
                                <select id="filterFacilityMaturity" class="hidden">
                                    <option value="">All Dates</option>
                                    <option value="30">Next 30 Days</option>
                                    <option value="60">Next 60 Days</option>
                                    <option value="90">Next 90 Days</option>
                                    <option value="180">Next 6 Months</option>
                                    <option value="365">Next Year</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex items-center justify-between w-full gap-3">
                        <button onclick="clearAllFilters()" type="button"
                            class="text-sm font-medium text-gray-600 hover:text-gray-800 transition-colors">
                            Clear All Filters
                        </button>
                        <div class="flex gap-3">
                            <button onclick="toggleFilterPopover()" type="button"
                                class="flex w-full justify-center rounded-lg border border-gray-300 bg-white px-4 py-3 text-sm font-medium text-gray-700 shadow-theme-xs hover:bg-gray-50 hover:text-gray-800 sm:w-auto">
                                Cancel
                            </button>
                            <button onclick="applyFiltersAndClose()" type="button"
                                class="flex justify-center w-full px-4 py-3 text-sm font-medium text-white rounded-lg bg-blue-600 shadow-theme-xs hover:bg-blue-700 sm:w-auto">
                                Apply Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Metric Cards -->
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 md:gap-6 mb-6">
            <!-- Card 1: Total $ of Facility Amount (TFA) -->
            <div class="rounded-2xl border border-gray-200 bg-white p-5 flex flex-col relative">
                <!-- Action Buttons - Absolute Top Right -->
                <div class="absolute top-2 right-2 flex items-center gap-0.5">
                    <button onclick="openExpandModal('tfa')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                        <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                            <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                        </svg>
                    </button>
                </div>
                <div class="flex items-start gap-3 pr-14 flex-1">
                    <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-red-100">
                        <svg class="h-5 w-5 shrink-0 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">TFA</h3>
                        <p class="text-xs text-gray-400">(Total Facilities Approved)</p>
                    </div>
                </div>
                <p class="text-2xl font-bold text-gray-900 text-center mt-3" id="totalFacAmount">$0.00</p>
            </div>

            <!-- Card 2: Total $ of OSUC -->
            <div class="rounded-2xl border border-gray-200 bg-white p-5 flex flex-col relative">
                <!-- Action Buttons - Absolute Top Right -->
                <div class="absolute top-2 right-2 flex items-center gap-0.5">
                    <button onclick="openExpandModal('osuc')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                        <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                            <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                        </svg>
                    </button>
                </div>
                <div class="flex items-start gap-3 pr-14 flex-1">
                    <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-orange-100">
                        <svg class="h-5 w-5 shrink-0 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">OSUC<sup class="text-blue-600">*</sup></h3>
                        <p class="text-xs text-gray-400">(OS + Unused Commitment)</p>
                    </div>
                </div>
                <p class="text-2xl font-bold text-gray-900 text-center mt-3" id="totalOSUC">$0.00</p>
            </div>

            <!-- Card 3: Total Outstanding -->
            <div class="rounded-2xl border border-gray-200 bg-white p-5 flex flex-col relative">
                <!-- Action Buttons - Absolute Top Right -->
                <div class="absolute top-2 right-2 flex items-center gap-0.5">
                    <button onclick="openExpandModal('outstanding')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                        <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                            <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                        </svg>
                    </button>
                </div>
                <div class="flex items-start gap-3 pr-14 flex-1">
                    <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-purple-100">
                        <svg class="h-5 w-5 shrink-0 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Outstanding</h3>
                        <p class="text-xs text-gray-400">(Direct + Contingent + PSE)</p>
                    </div>
                </div>
                <p class="text-2xl font-bold text-gray-900 text-center mt-3" id="totalOutstanding">$0.00</p>
            </div>

            <!-- Card 4: Total # of Facilities -->
            <div class="rounded-2xl border border-gray-200 bg-white p-5 flex flex-col relative">
                <!-- Action Buttons - Absolute Top Right -->
                <div class="absolute top-2 right-2 flex items-center gap-0.5">
                    <button onclick="openExpandModal('facilities')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                        <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                            <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                        </svg>
                    </button>
                </div>
                <div class="flex items-start gap-3 pr-14 flex-1">
                    <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-green-100">
                        <svg class="h-5 w-5 shrink-0 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Facilities</h3>
                        <p class="text-xs text-gray-400">(Total Count)</p>
                    </div>
                </div>
                <p class="text-2xl font-bold text-gray-900 text-center mt-3" id="totalFacilities">0</p>
            </div>

            <!-- Card 5: Total # of Relationships -->
            <div class="rounded-2xl border border-gray-200 bg-white p-5 flex flex-col relative">
                <!-- Action Buttons - Absolute Top Right -->
                <div class="absolute top-2 right-2 flex items-center gap-0.5">
                    <button onclick="openExpandModal('relationships')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                        <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                            <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                        </svg>
                    </button>
                </div>
                <div class="flex items-start gap-3 pr-14 flex-1">
                    <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-blue-100">
                        <svg class="h-5 w-5 shrink-0 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Relationships</h3>
                        <p class="text-xs text-gray-400">(Total Count)</p>
                    </div>
                </div>
                <p class="text-2xl font-bold text-gray-900 text-center mt-3" id="totalRelationships">0</p>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-12 gap-4 md:gap-6 mb-6">
            <!-- Bar Chart: CAs Coming Due & Facilities Expiring -->
            <div class="col-span-12 xl:col-span-4">
                <div class="rounded-2xl border border-gray-200 bg-white p-5 sm:p-6 h-full flex flex-col relative">
                    <!-- Action Buttons - Absolute Top Right -->
                    <div class="absolute top-3 right-3 flex items-center gap-0.5">
                        <button onclick="openExpandModal('expiring')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                            <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                                <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                                    </svg>
                        </button>
                        </div>
                    <div class="mb-5 pr-16">
                                <h3 class="text-lg font-semibold text-gray-800">
                                    CAs & Facilities Expiring
                                </h3>
                            <!-- Expired Metrics (Inline) -->
                            <div class="flex items-center gap-4 mt-2">
                                <div class="flex items-center gap-1.5">
                                    <svg class="h-2 w-2 text-blue-500" fill="currentColor" viewBox="0 0 8 8">
                                        <circle cx="4" cy="4" r="4" />
                                    </svg>
                                    <span class="text-xs text-gray-600">CAs Expired:</span>
                                    <span class="text-xs font-semibold text-gray-900" id="casExpiredCount">0</span>
                                </div>
                                <div class="flex items-center gap-1.5">
                                    <svg class="h-2 w-2 text-orange-500" fill="currentColor" viewBox="0 0 8 8">
                                        <circle cx="4" cy="4" r="4" />
                                    </svg>
                                    <span class="text-xs text-gray-600">Facilities Expired:</span>
                                <span class="text-xs font-semibold text-gray-900" id="facilitiesExpiredCount">0</span>
                                </div>
                            </div>
                                <p class="mt-1 text-sm text-gray-500">
                                    Upcoming expirations for the next 3 months
                                </p>
                        </div>
                        <div class="flex-1 flex items-stretch">
                            <div id="facilityTrendChart" class="-ml-5 w-full h-full"></div>
                    </div>
                </div>
            </div>

            <!-- Donut Chart: New Facilities Approved  -->
            <div class="col-span-12 xl:col-span-4">
                <div class="rounded-2xl border border-gray-200 bg-white p-5 sm:p-6 h-full flex flex-col relative">
                    <!-- Action Buttons - Absolute Top Right -->
                    <div class="absolute top-2 right-2 flex items-center gap-0.5 z-10">
                        <button onclick="openExpandModal('newFacilities')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                            <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                                <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                            </svg>
                        </button>
                        </div>
                    <div class="flex flex-col gap-3 mb-5 sm:flex-row sm:items-start sm:justify-between">
                        <div class="pr-8">
                            <h3 class="text-lg font-semibold text-gray-800">
                                New Facilities Approved*
                            </h3>
                            <p class="mt-1 text-sm text-gray-500" id="newFacilitiesSubtitle">
                                Facilities approved in reporting month
                            </p>
                            <p class="mt-1 text-xs text-gray-400 italic">
                                *APAC data will be available from Dec ME
                            </p>
                        </div>
                        <div class="flex items-end justify-end pt-6">
                        <div class="inline-flex w-fit items-center gap-0.5 rounded-lg bg-gray-100 p-0.5">
                            <button id="currentMonthBtn" onclick="filterNewFacilitiesByPeriod('current')" 
                                class="px-2 py-1 font-medium transition-colors rounded text-xs shadow-xs text-gray-900 bg-white hover:text-gray-900">
                                Current
                            </button>
                            <button id="previousMonthBtn" onclick="filterNewFacilitiesByPeriod('previous')" 
                                class="px-2 py-1 font-medium transition-colors rounded text-sm font-medium text-gray-500 hover:text-gray-900">
                                Previous
                            </button>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col items-center justify-center gap-8 xl:flex-row flex-1">
                        <!-- New Facilities Approved Chart (legacy ID: creditClassificationChart) -->
                        <div id="creditClassificationChart" class="chartDarkStyle" style="min-height: 280px; min-width: 280px;"></div>
                        <!-- New Facilities Approved Legend (legacy ID: creditClassificationLegend) -->
                        <div id="creditClassificationLegend"
                            class="flex flex-col items-start gap-6 sm:flex-row xl:flex-col">
                            <!-- Legend items will be dynamically generated -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- New Deals Section -->
            <div class="col-span-12 xl:col-span-4 flex flex-col h-full">
                <!-- Metric Group One -->
                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 md:gap-6 mb-6">
                    <!-- Metric Item Start -->
                    <div class="rounded-2xl border border-gray-200 bg-white p-5 md:p-6 relative">
                        <!-- Action Buttons - Absolute Top Right -->
                        <div class="absolute top-2 right-2 flex items-center gap-0.5">
                            <button onclick="openExpandModal('newDealsYTD')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                                <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                                    <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                            </svg>
                            </button>
                        </div>
                        <div class="flex items-start gap-3 flex-1">
                            <div>
                                <span class="text-sm font-medium text-gray-500">New Deals</span>
                                <p class="text-xs text-gray-400">Closed YTD (excl. PSE)</p>
                            </div>
                        </div>
                        <div class="flex items-end justify-between">
                            <div>
                                <h4 id="newDealsYTD" class="text-title-sm font-bold text-gray-800">0</h4>
                                <p class="text-sm font-medium text-gray-500 mt-1">
                                    <span id="newDealsYTDAmount">$0</span>
                                </p>
                            </div>
                            <span id="newDealsYTDVariance"
                                class="flex items-center gap-1 rounded-full bg-gray-100 py-0.5 pl-2 pr-2.5 text-sm font-medium text-gray-600">
                                0%
                            </span>
                        </div>
                    </div>
                    <!-- Metric Item End -->

                    <!-- Metric Item Start -->
                    <div class="rounded-2xl border border-gray-200 bg-white p-5 md:p-6 relative">
                        <!-- Action Buttons - Absolute Top Right -->
                        <div class="absolute top-2 right-2 flex items-center gap-0.5">
                            <button onclick="openExpandModal('newDealsMTD')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                                <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                                    <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                            </svg>
                            </button>
                        </div>
                        <div class="flex items-start gap-3 flex-1">
                            <div>
                                <span class="text-sm font-medium text-gray-500">New Deals</span>
                                <p class="text-xs text-gray-400">Closed MTD (excl. PSE)</p>
                            </div>
                        </div>
                        <div class="flex items-end justify-between">
                            <div>
                                <h4 id="newDealsMTD" class="text-title-sm font-bold text-gray-800">0</h4>
                                <p class="text-sm font-medium text-gray-500 mt-1">
                                    <span id="newDealsMTDAmount">$0</span>
                                </p>
                            </div>
                            <span id="newDealsMTDVariance"
                                class="flex items-center gap-1 rounded-full bg-gray-100 py-0.5 pl-2 pr-2.5 text-sm font-medium text-gray-600">
                                0%
                            </span>
                        </div>
                    </div>
                    <!-- Metric Item End -->
                </div>
                <!-- Metric Group One -->

                <!-- ====== Pipeline Table Start -->
                <div class="overflow-hidden rounded-2xl border border-gray-200 bg-white flex-1 flex flex-col relative">
                    <!-- Action Buttons - Absolute Top Right -->
                    <div class="absolute top-3 right-3 flex items-center gap-0.5 z-10">
                        <button onclick="openExpandModal('pipeline')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                            <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                                <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                            </svg>
                        </button>
                    </div>
                    <div class="px-5 pt-5 sm:px-6 sm:pt-6 pb-4 pr-16">
                        <h3 class="text-lg font-semibold text-gray-800">
                            Deals Pending Closure
                        </h3>
                        <p class="mt-1 text-sm text-gray-500">
                            NAM and LATAM only
                        </p>
                    </div>
                    <div class="max-w-full overflow-x-auto flex-1">
                        <table class="w-full table-auto h-full">
                            <thead>
                                <tr class="bg-gray-50 text-left">
                                    <th class="px-5 py-3 text-xs font-semibold text-gray-700 tracking-wider">
                                        Aging Bucket</th>
                                    <th
                                        class="px-5 py-3 text-xs font-semibold text-gray-700 tracking-wider text-right">
                                        Count</th>
                                    <th
                                        class="px-5 py-3 text-xs font-semibold text-gray-700 tracking-wider text-right">
                                        Total TFA</th>
                                </tr>
                            </thead>
                            <tbody id="pipelineTableBody" class="divide-y divide-gray-200">
                                <tr>
                                    <td colspan="3" class="px-5 py-4 text-center text-sm text-gray-500">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- ====== Pipeline Table End -->
            </div>
        </div>

        <!-- Bar Chart and Donut Chart Side by Side -->
        <div class="mb-6 grid grid-cols-12 gap-4 md:gap-6">
        <!-- Bar Chart: Top Relationships by Total Facility Amount / Direct OS -->
            <div class="col-span-12 xl:col-span-6">
                <div
                    class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6 sm:pt-5 h-full flex flex-col">
                    <div class="mb-6 relative pr-48">
                    <div class="pr-0">
                            <h3 class="text-lg font-semibold text-gray-800" id="topRelationshipsTitle">
                                Top Relationships
                            </h3>
                            <p class="mt-1 text-gray-500 text-sm" id="topRelationshipsSubtitle">
                                Top relationships by exposure type - OSUC
                            </p>
                    </div>
                        <!-- Filters - Fixed Position at Top Right -->
                        <div class="absolute right-0 top-0 flex items-center gap-2">
                            <!-- Exposure Type Dropdown -->
                            <div x-data="{openExposure: false, exposureType: 'osuc', exposureLabels: {direct: 'Direct', contingent: 'Contingent', pse: 'PSE', osuc: 'OSUC', unused: 'Undrawn', tfa: 'TFA'}}" class="relative">
                                <button @click="openExposure = !openExposure"
                                    class="inline-flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                    <span x-text="exposureLabels[exposureType]">OSUC</span>
                                    <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                                <div x-show="openExposure" @click.outside="openExposure = false"
                                    class="absolute right-0 top-full z-40 w-32 space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                    <button
                                        @click="exposureType = 'direct'; openExposure = false; selectAmountTypeFilter('direct');"
                                        :class="exposureType === 'direct' ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                        class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                        Direct
                                    </button>
                                    <button
                                        @click="exposureType = 'contingent'; openExposure = false; selectAmountTypeFilter('contingent');"
                                        :class="exposureType === 'contingent' ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                        class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                        Contingent
                                    </button>
                                    <button
                                        @click="exposureType = 'pse'; openExposure = false; selectAmountTypeFilter('pse');"
                                        :class="exposureType === 'pse' ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                        class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                        PSE
                                    </button>
                                    <button
                                        @click="exposureType = 'osuc'; openExposure = false; selectAmountTypeFilter('osuc');"
                                        :class="exposureType === 'osuc' ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                        class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                        OSUC
                                    </button>
                                    <button
                                        @click="exposureType = 'unused'; openExposure = false; selectAmountTypeFilter('unused');"
                                        :class="exposureType === 'unused' ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                        class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                        Undrawn
                                    </button>
                                    <button
                                        @click="exposureType = 'tfa'; openExposure = false; selectAmountTypeFilter('tfa');"
                                        :class="exposureType === 'tfa' ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                        class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                        TFA
                                    </button>
                                </div>
                            </div>
                            <!-- Top N Filter -->
                            <div x-data="{openTopN: false, topNRelationships: 10}" class="relative">
                                <button @click="openTopN = !openTopN"
                                    class="inline-flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                    <span>Top <span x-text="topNRelationships"></span></span>
                                    <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                                <div x-show="openTopN" @click.outside="openTopN = false"
                                    class="absolute right-0 top-full z-40 w-28 space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                    <button
                                        @click="topNRelationships = 10; openTopN = false; document.getElementById('topNFilter').value = 10; updateBarChart();"
                                        :class="topNRelationships === 10 ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                        class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                        Top 10
                                    </button>
                                    <button
                                        @click="topNRelationships = 20; openTopN = false; document.getElementById('topNFilter').value = 20; updateBarChart();"
                                        :class="topNRelationships === 20 ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                        class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                        Top 20
                                    </button>
                                    <button
                                        @click="topNRelationships = 30; openTopN = false; document.getElementById('topNFilter').value = 30; updateBarChart();"
                                        :class="topNRelationships === 30 ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                        class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                        Top 30
                                    </button>
                                    <button
                                        @click="topNRelationships = 40; openTopN = false; document.getElementById('topNFilter').value = 40; updateBarChart();"
                                        :class="topNRelationships === 40 ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                        class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                        Top 40
                                    </button>
                                    <button
                                        @click="topNRelationships = 50; openTopN = false; document.getElementById('topNFilter').value = 50; updateBarChart();"
                                        :class="topNRelationships === 50 ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                        class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                        Top 50
                                    </button>
                                    <button
                                        @click="topNRelationships = 100; openTopN = false; document.getElementById('topNFilter').value = 100; updateBarChart();"
                                        :class="topNRelationships === 100 ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                        class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                        Top 100
                                    </button>
                    </div>
                            </div>
                            <!-- Expand Button -->
                            <button onclick="openExpandModal('topRelationships')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                                <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                                    <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                                </svg>
                            </button>
                            <!-- Three Dots Menu -->
                        </div>
                        <!-- Hidden elements for backward compatibility with existing JavaScript -->
                        <select id="topNFilter" style="display: none;">
                            <option value="10" selected>Top 10</option>
                            <option value="20">Top 20</option>
                            <option value="30">Top 30</option>
                            <option value="40">Top 40</option>
                            <option value="50">Top 50</option>
                            <option value="100">Top 100</option>
                        </select>
                        <button id="btnAmountDirect" style="display: none;"></button>
                        <button id="btnAmountContingent" style="display: none;"></button>
                        <button id="btnAmountPSE" style="display: none;"></button>
                        <button id="btnAmountOSUC" style="display: none;"></button>
                        <button id="btnAmountUnused" style="display: none;"></button>
                        <button id="btnAmountTFA" style="display: none;"></button>
                    </div>
                    <div class="flex-1 w-full" style="overflow: visible;">
                        <div id="relationshipChart"></div>
                    </div>
                </div>
            </div>

            <!-- ROTCE Performance -->
            <div class="col-span-12 xl:col-span-6">
                <div
                    class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6 sm:pt-5 h-full flex flex-col">
                    <div class="mb-5 flex items-start justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">
                                ROTCE Performance
                            </h3>
                            <p class="mt-1 text-gray-500 text-sm" id="rotceSubtitle">
                                Top N relationships ROTCE performance
                            </p>
                        </div>
                        <div class="flex items-center gap-0.5">
                            <!-- Expand Button -->
                            <button onclick="openExpandModal('rotce')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                                <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                                    <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                                </svg>
                            </button>
                            <!-- Three Dots Menu -->
                        </div>
                    </div>

                    <!-- ROTCE Chart -->
                    <div class="flex-1 w-full" style="overflow: visible;">
                        <div id="rotceChart" style="min-height: 280px;">
                            <!-- Chart will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Covenants and Reviews Section -->
        <div class="grid grid-cols-12 gap-4 md:gap-6 mb-6">
            <!-- Covenant Monitoring Dashboard (Past Due Covenants) -->
            <div class="col-span-12 xl:col-span-6">
                <div class="rounded-2xl border border-gray-200 bg-white h-full flex flex-col relative" style="overflow: visible;" x-data="{ covenantView: 'pastDue' }">
                    <!-- Action Buttons - Absolute Top Right -->
                    <div class="absolute top-2 right-2 flex items-center gap-0.5 z-10">
                        <button onclick="openExpandModal('covenantMonitoring')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                            <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                                <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                            </svg>
                        </button>
                    </div>
                    <div class="flex items-center justify-between px-5 pt-5 sm:px-6 sm:pt-6 pb-4">
                        <div class="pr-14">
                            <h3 class="text-lg font-semibold text-gray-800" x-text="covenantView === 'pastDue' ? 'Past Due Covenants' : 'Coming Due Covenants (Next 30 Days)'">
                                Past Due Covenants
                    </h3>
                            <p class="mt-1 text-sm text-gray-500" x-text="covenantView === 'pastDue' ? 'Covenants past their due date' : 'Covenants due in the next 30 days'">
                                Covenants past their due date
                    </p>
                </div>
                        <div class="flex items-center gap-2">
                            <!-- Toggle Filter (Smaller) -->
                            <div class="flex items-center gap-1 bg-gray-100 rounded-lg p-0.5">
                                <button @click="covenantView = 'pastDue'; updateCovenantChart('pastDue')"
                                    :class="covenantView === 'pastDue' ? 'bg-white shadow-sm text-gray-900 font-medium' : 'text-gray-600'"
                                    class="px-2 py-1 text-xs rounded-md transition-all duration-200">
                                    Past Due
                                </button>
                                <button @click="covenantView = 'comingDue'; updateCovenantChart('comingDue')"
                                    :class="covenantView === 'comingDue' ? 'bg-white shadow-sm text-gray-900 font-medium' : 'text-gray-600'"
                                    class="px-2 py-1 text-xs rounded-md transition-all duration-200">
                                    Coming Due
                                </button>
                </div>
            </div>
            </div>

                    <!-- Donut Chart and Legends -->
                    <div class="flex flex-col items-center px-5 py-6 flex-1" style="overflow: visible;">
                        <div id="covenantMonitoringChart" class="chartDarkStyle"></div>
                        <div id="covenantMonitoringLegend" class="flex flex-row items-center justify-center gap-4 sm:gap-6 mt-6 flex-wrap">
                            <!-- Legend items will be dynamically generated -->
                                </div>
            </div>
                </div>
            </div>

            <!-- CCM Regional Distribution Chart (Stacked Bar) -->
            <div class="col-span-12 xl:col-span-6">
                <div class="rounded-2xl border border-gray-200 bg-white p-5 sm:p-6 h-full flex flex-col pb-0 relative" style="overflow: visible;">
                    <!-- Action Buttons - Absolute Top Right -->
                    <div class="absolute top-2 right-2 flex items-center gap-0.5 z-10">
                        <button onclick="openExpandModal('ccmRegionalChart')" class="text-gray-600 hover:text-gray-900 transition-colors p-1" title="Expand">
                            <svg class="fill-current" width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="0.5" stroke="currentColor">
                                <path d="M4,7.5 C4,7.77614237 3.77614237,8 3.5,8 C3.22385763,8 3,7.77614237 3,7.5 L3,5.5 C3,4.11928813 4.11928813,3 5.5,3 L7.5,3 C7.77614237,3 8,3.22385763 8,3.5 C8,3.77614237 7.77614237,4 7.5,4 L5.5,4 C4.67157288,4 4,4.67157288 4,5.5 L4,7.5 Z M16.5,4 C16.2238576,4 16,3.77614237 16,3.5 C16,3.22385763 16.2238576,3 16.5,3 L18.5,3 C19.8807119,3 21,4.11928813 21,5.5 L21,7.5 C21,7.77614237 20.7761424,8 20.5,8 C20.2238576,8 20,7.77614237 20,7.5 L20,5.5 C20,4.67157288 19.3284271,4 18.5,4 L16.5,4 Z M20,16.5 C20,16.2238576 20.2238576,16 20.5,16 C20.7761424,16 21,16.2238576 21,16.5 L21,18.5 C21,19.8807119 19.8807119,21 18.5,21 L16.5,21 C16.2238576,21 16,20.7761424 16,20.5 C16,20.2238576 16.2238576,20 16.5,20 L18.5,20 C19.3284271,20 20,19.3284271 20,18.5 L20,16.5 Z M7.5,20 C7.77614237,20 8,20.2238576 8,20.5 C8,20.7761424 7.77614237,21 7.5,21 L5.5,21 C4.11928813,21 3,19.8807119 3,18.5 L3,16.5 C3,16.2238576 3.22385763,16 3.5,16 C3.77614237,16 4,16.2238576 4,16.5 L4,18.5 C4,19.3284271 4.67157288,20 5.5,20 L7.5,20 Z" fill=""/>
                            </svg>
                        </button>
                    </div>
                    <div class="mb-6 flex justify-between">
                        <div class="pr-14">
                            <h3 class="text-lg font-semibold text-gray-800">
                                Criticized/Classified Memos & Reviews
                            </h3>
                            <p class="mt-1 text-sm text-gray-500">
                                Regional distribution of credit committee memo status
                            </p>
                        </div>
                    </div>
                    <div class="flex-1 flex items-center" style="overflow: visible;">
                        <div id="ccmRegionalChart" class="w-full"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Important Notes -->
        <div class="overflow-hidden rounded-xl border border-gray-200 bg-white">
            <div class="flex items-center gap-3 px-5 py-4">
                <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-blue-100 shrink-0">
                    <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="flex-1">
                    <h4 class="text-sm font-semibold text-gray-800 mb-1">
                        Important Notes
                    </h4>
                    <div class="text-xs text-gray-600 space-y-2.5">
                        <div class="flex items-start gap-2">
                            <span class="font-semibold text-gray-700 mt-0.5">*</span>
                            <p>
                                <span class="font-semibold text-gray-700">Unused Commitment (UC):</span>
                                Undrawn portion of committed facility.
                            </p>
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="font-semibold text-gray-700 mt-0.5">*</span>
                            <p>
                                <span class="font-semibold text-gray-700">Outstanding (OS):</span>
                                Drawn amount or calculated exposure.
                            </p>
                        </div>
                        <div class="flex items-start gap-2">
                            <span class="font-semibold text-gray-700 mt-0.5">*</span>
                            <p>
                                <span class="font-semibold text-gray-700">OSUC (Outstanding and Unused Commitment):</span>
                                For committed facilities, OSUC = Outstanding + Unused Commitment. For uncommitted facilities, OSUC = Outstanding.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Chart Data Viewer Modal -->
        <div id="chartDataModal" class="fixed inset-0 z-[9999] hidden overflow-y-auto" aria-labelledby="modal-title"
            role="dialog" aria-modal="true">
            <!-- Background overlay -->
            <div class="fixed inset-0 bg-gray-400/50 backdrop-blur-[32px] transition-opacity" onclick="closeChartDataModal()">
            </div>

            <!-- Modal panel -->
            <div class="flex min-h-full items-center justify-center p-4">
                <div
                    class="relative w-full max-w-7xl transform overflow-hidden rounded-2xl bg-white shadow-2xl transition-all">
                    <!-- Modal header -->
                    <div class="border-b border-gray-200 bg-white px-6 py-4">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-900" id="chartDataModalTitle">
                                    Chart Data
                                </h3>
                                <p class="mt-1 text-sm text-gray-500" id="chartDataModalSubtitle">
                                    Viewing underlying data
                                </p>
                            </div>
                            <div class="flex items-center gap-3">
                                <!-- Clear All Filters Button -->
                                <button id="clearFiltersBtn" onclick="clearAllTableFilters()" 
                                    class="hidden items-center gap-2 rounded-lg border border-red-300 bg-red-50 px-4 py-2 text-sm font-medium text-red-700 hover:bg-red-100 transition-colors">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                    Clear All Filters
                                </button>
                                <button onclick="exportModalData()"
                                    class="flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                        </path>
                                    </svg>
                                    Export XLSX
                                </button>
                                <button onclick="closeChartDataModal()" type="button"
                                    class="flex h-9.5 w-9.5 items-center justify-center rounded-full bg-gray-100 text-gray-400 transition-colors hover:bg-gray-200 hover:text-gray-700 sm:h-11 sm:w-11 cursor-pointer">
                                    <svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" clip-rule="evenodd"
                                            d="M6.04289 16.5413C5.65237 16.9318 5.65237 17.565 6.04289 17.9555C6.43342 18.346 7.06658 18.346 7.45711 17.9555L11.9987 13.4139L16.5408 17.956C16.9313 18.3466 17.5645 18.3466 17.955 17.956C18.3455 17.5655 18.3455 16.9323 17.955 16.5418L13.4129 11.9997L17.955 7.4576C18.3455 7.06707 18.3455 6.43391 17.955 6.04338C17.5645 5.65286 16.9313 5.65286 16.5408 6.04338L11.9987 10.5855L7.45711 6.0439C7.06658 5.65338 6.43342 5.65338 6.04289 6.0439C5.65237 6.43442 5.65237 7.06759 6.04289 7.45811L10.5845 11.9997L6.04289 16.5413Z"
                                            fill="" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Modal body with scrollable table -->
                    <div class="max-h-[70vh] overflow-auto bg-white">
                        <table class="min-w-full">
                            <thead class="sticky top-0 z-40 bg-gray-50 border-b-2 border-gray-300">
                                <tr id="chartDataTableHeader">
                                    <!-- Dynamic headers will be inserted here -->
                                </tr>
                                <tr id="chartDataTableFilters">
                                    <!-- Dynamic filter inputs will be inserted here -->
                                </tr>
                            </thead>
                            <tbody id="chartDataTableBody" class="divide-y divide-gray-200 bg-white">
                                <!-- Dynamic rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Modal footer with pagination -->
                    <div class="border-t border-gray-200 bg-gray-50 px-6 py-4" x-data="{openPageSize: false, pageSize: 100}">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                            <p class="text-sm text-gray-500">
                                    Showing <span id="dataRowsStart">0</span> to <span id="dataRowsEnd">0</span> of <span id="dataTotalRows">0</span> records
                                </p>
                                <!-- Page Size Dropdown -->
                                <div class="relative">
                                    <button @click="openPageSize = !openPageSize"
                                        class="inline-flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                        <span x-text="pageSize + ' per page'"></span>
                                        <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>
                                    <div x-show="openPageSize" @click.outside="openPageSize = false"
                                        class="absolute left-0 bottom-full z-40 w-32 space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mb-2">
                                        <button
                                            @click="pageSize = 50; openPageSize = false; document.getElementById('dataPageSize').value = 50; document.getElementById('dataPageSize').dispatchEvent(new Event('change'));"
                                            :class="pageSize === 50 ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                            class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                            50 per page
                                        </button>
                                        <button
                                            @click="pageSize = 100; openPageSize = false; document.getElementById('dataPageSize').value = 100; document.getElementById('dataPageSize').dispatchEvent(new Event('change'));"
                                            :class="pageSize === 100 ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                            class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                            100 per page
                                        </button>
                                        <button
                                            @click="pageSize = 250; openPageSize = false; document.getElementById('dataPageSize').value = 250; document.getElementById('dataPageSize').dispatchEvent(new Event('change'));"
                                            :class="pageSize === 250 ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                            class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                            250 per page
                                        </button>
                                        <button
                                            @click="pageSize = 500; openPageSize = false; document.getElementById('dataPageSize').value = 500; document.getElementById('dataPageSize').dispatchEvent(new Event('change'));"
                                            :class="pageSize === 500 ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                            class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                            500 per page
                            </button>
                        </div>
                    </div>
                                <!-- Hidden select for backward compatibility -->
                                <select id="dataPageSize" style="display: none;">
                                    <option value="50">50 per page</option>
                                    <option value="100" selected>100 per page</option>
                                    <option value="250">250 per page</option>
                                    <option value="500">500 per page</option>
                                </select>
                </div>
                            <div class="flex items-center gap-2">
                                <button id="dataPrevBtn" class="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                    Previous
                                </button>
                                <span class="text-sm text-gray-600">
                                    Page <span id="dataCurrentPage">1</span> of <span id="dataTotalPages">1</span>
                                </span>
                                <button id="dataNextBtn" class="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                    Next
                                </button>
            </div>
        </div>
        </div>
            </div>
        </div>
        </div>
        </div>

        <!-- Expand/Details Modal -->
        <div id="expandModal" class="fixed inset-0 z-[9999] hidden overflow-y-auto" aria-labelledby="expand-modal-title" role="dialog" aria-modal="true">
            <!-- Background overlay -->
            <div class="fixed inset-0 bg-gray-400/50 backdrop-blur-[32px] transition-opacity" onclick="closeExpandModal()"></div>

            <!-- Modal panel -->
            <div class="flex min-h-full items-center justify-center p-4">
                <div class="relative w-full max-w-[1400px] h-[90vh] transform overflow-hidden rounded-2xl bg-white shadow-2xl transition-all flex flex-col">
                    <!-- Modal header -->
                    <div class="border-b border-gray-200 bg-white px-6 py-4 flex-shrink-0">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <!-- Title and subtitle -->
                                <div id="modalTitleSection">
                                    <h3 class="text-lg font-semibold text-gray-900" id="expandModalTitle">
                                        Details
                                    </h3>
                                    <p class="mt-1 text-sm text-gray-500" id="expandModalSubtitle">
                                        Expanded view with additional details
                                    </p>
                                </div>
                            </div>
                            <button onclick="closeExpandModal()" type="button"
                                class="flex h-9.5 w-9.5 items-center justify-center rounded-full bg-gray-100 text-gray-400 transition-colors hover:bg-gray-200 hover:text-gray-700 sm:h-11 sm:w-11 cursor-pointer ml-4">
                                <svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M6.04289 16.5413C5.65237 16.9318 5.65237 17.565 6.04289 17.9555C6.43342 18.346 7.06658 18.346 7.45711 17.9555L11.9987 13.4139L16.5408 17.956C16.9313 18.3466 17.5645 18.3466 17.955 17.956C18.3455 17.5655 18.3455 16.9323 17.955 16.5418L13.4129 11.9997L17.955 7.4576C18.3455 7.06707 18.3455 6.43391 17.955 6.04338C17.5645 5.65286 16.9313 5.65286 16.5408 6.04338L11.9987 10.5855L7.45711 6.0439C7.06658 5.65338 6.43342 5.65338 6.04289 6.0439C5.65237 6.43442 5.65237 7.06759 6.04289 7.45811L10.5845 11.9997L6.04289 16.5413Z" fill="" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Tabs Navigation -->
                    <div class="border-b border-gray-200 px-6 flex-shrink-0">
                        <nav class="-mb-px flex space-x-2 overflow-x-auto">
                            <button
                                id="insightsTab"
                                onclick="switchExpandTab('insights')"
                                class="inline-flex items-center gap-2 border-b-2 px-2.5 py-3 text-sm font-medium transition-colors duration-200 ease-in-out text-blue-600 border-blue-600">
                                <svg class="size-5" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M9.85954 4.0835C9.5834 4.0835 9.35954 4.30735 9.35954 4.5835V15.4161C9.35954 15.6922 9.5834 15.9161 9.85954 15.9161H10.1373C10.4135 15.9161 10.6373 15.6922 10.6373 15.4161V4.5835C10.6373 4.30735 10.4135 4.0835 10.1373 4.0835H9.85954ZM7.85954 4.5835C7.85954 3.47893 8.75497 2.5835 9.85954 2.5835H10.1373C11.2419 2.5835 12.1373 3.47893 12.1373 4.5835V15.4161C12.1373 16.5206 11.2419 17.4161 10.1373 17.4161H9.85954C8.75497 17.4161 7.85954 16.5206 7.85954 15.4161V4.5835ZM4.58203 8.9598C4.30589 8.9598 4.08203 9.18366 4.08203 9.4598V15.4168C4.08203 15.693 4.30589 15.9168 4.58203 15.9168H4.85981C5.13595 15.9168 5.35981 15.693 5.35981 15.4168V9.4598C5.35981 9.18366 5.13595 8.9598 4.85981 8.9598H4.58203ZM2.58203 9.4598C2.58203 8.35523 3.47746 7.4598 4.58203 7.4598H4.85981C5.96438 7.4598 6.85981 8.35523 6.85981 9.4598V15.4168C6.85981 16.5214 5.96438 17.4168 4.85981 17.4168H4.58203C3.47746 17.4168 2.58203 16.5214 2.58203 15.4168V9.4598ZM14.637 12.435C14.637 12.1589 14.8609 11.935 15.137 11.935H15.4148C15.691 11.935 15.9148 12.1589 15.9148 12.435V15.4168C15.9148 15.693 15.691 15.9168 15.4148 15.9168H15.137C14.8609 15.9168 14.637 15.693 14.637 15.4168V12.435ZM15.137 10.435C14.0325 10.435 13.137 11.3304 13.137 12.435V15.4168C13.137 16.5214 14.0325 17.4168 15.137 17.4168H15.4148C16.5194 17.4168 17.4148 16.5214 17.4148 15.4168V12.435C17.4148 11.3304 16.5194 10.435 15.4148 10.435H15.137Z" fill="currentColor"/>
                                </svg>
                                Insights
                            </button>
                        </nav>
                    </div>

                    <!-- Modal content -->
                    <div class="flex-1 overflow-auto">
                        <!-- Insights Tab Content -->
                        <div id="insightsContent" class="p-6 bg-white">
                            <!-- Dynamic insights content will be inserted here -->
                            <div class="flex items-center justify-center py-12 text-gray-400">
                                <svg class="animate-spin h-8 w-8 mr-3" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Loading insights...
                            </div>
                        </div>
                    </div>

                    <!-- Modal footer -->
                    <div id="expandModalFooter" class="border-t border-gray-200 bg-gray-50 px-6 py-3 flex-shrink-0">
                        <div class="flex items-center justify-between">
                            <p id="expandModalFooterText" class="text-sm text-gray-500">
                                Click outside or press ESC to close
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Balances Section (Hidden) -->
        <div style="display: none;">
            <!-- Logistics-Style Layout: 3 Horizontal Metric Cards + Large Chart + Side Panel -->
            
            <!-- Row 1: 3 Horizontal Metric Cards (Logistics Style) -->
            <div class="mb-6 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3 md:gap-6">
                <!-- Total Notional Balance - Horizontal Card -->
                <article class="flex items-center gap-5 rounded-2xl border border-gray-200 bg-white p-4">
                    <div class="inline-flex h-16 w-16 shrink-0 items-center justify-center rounded-xl bg-blue-100 text-blue-600">
                        <svg class="h-7 w-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                </div>
                    <div>
                        <h3 class="text-2xl font-semibold text-gray-800">$--</h3>
                        <p class="flex items-center gap-3 text-gray-500">
                            Total Notional Balance
                            <span class="inline-flex items-center justify-center gap-1 rounded-full bg-green-100 px-2.5 py-0.5 text-sm font-medium text-green-600">+--</span>
                        </p>
                    </div>
                </article>
                
                <!-- Total Committed Balance - Horizontal Card -->
                <article class="flex items-center gap-5 rounded-2xl border border-gray-200 bg-white p-4">
                    <div class="inline-flex h-16 w-16 shrink-0 items-center justify-center rounded-xl bg-green-100 text-green-600">
                        <svg class="h-7 w-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-2xl font-semibold text-gray-800">$--</h3>
                        <p class="flex items-center gap-3 text-gray-500">
                            Total Committed
                            <span class="inline-flex items-center justify-center gap-1 rounded-full bg-green-100 px-2.5 py-0.5 text-sm font-medium text-green-600">+--</span>
                        </p>
                    </div>
                </article>

                <!-- Total Outstanding - Horizontal Card -->
                <article class="flex items-center gap-5 rounded-2xl border border-gray-200 bg-white p-4">
                    <div class="inline-flex h-16 w-16 shrink-0 items-center justify-center rounded-xl bg-purple-100 text-purple-600">
                        <svg class="h-7 w-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-2xl font-semibold text-gray-800">$--</h3>
                        <p class="flex items-center gap-3 text-gray-500">
                            Total Outstanding
                            <span class="inline-flex items-center justify-center gap-1 rounded-full bg-amber-100 px-2.5 py-0.5 text-sm font-medium text-amber-600">--% util</span>
                        </p>
                    </div>
                </article>
            </div>

            <!-- Row 2: Large Chart (8) + Side Panel (4) -->
            <div class="mb-6 grid grid-cols-12 gap-4 md:gap-6">
                <!-- Balance Trend Chart - Large -->
                <div class="col-span-12 xl:col-span-8">
                    <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6 h-full">
                        <div class="mb-5 flex items-start justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">Balance Trend Over Time</h3>
                                <p class="mt-1 text-gray-500 text-sm">Historical trend of portfolio balances across reporting periods</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="rounded-lg px-3 py-1.5 text-sm font-medium text-gray-500 hover:bg-gray-100">1M</button>
                                <button class="rounded-lg px-3 py-1.5 text-sm font-medium bg-blue-100 text-blue-600">3M</button>
                                <button class="rounded-lg px-3 py-1.5 text-sm font-medium text-gray-500 hover:bg-gray-100">YTD</button>
                            </div>
                        </div>
                        <div class="flex items-center justify-center h-80 bg-gray-50 rounded-lg">
                            <div class="text-center text-gray-400">
                                <svg class="h-12 w-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                            </svg>
                                <p class="text-sm font-medium">Area Chart Placeholder</p>
                                <p class="text-xs mt-1">Balance trend with Notional, Committed, Outstanding lines</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Regional Distribution - Side Panel -->
                <div class="col-span-12 xl:col-span-4">
                    <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6 h-full">
                        <div class="mb-5">
                            <h3 class="text-lg font-semibold text-gray-800">Regional Distribution</h3>
                            <p class="mt-1 text-gray-500 text-sm">Balance breakdown by region</p>
                        </div>
                        <div class="space-y-4">
                            <!-- APAC -->
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="h-3 w-3 rounded-full bg-blue-500"></div>
                                    <span class="text-sm text-gray-600">APAC</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-24 h-2 bg-gray-100 rounded-full overflow-hidden">
                                        <div class="h-full bg-blue-500 rounded-full" style="width: 35%"></div>
                                    </div>
                                    <span class="text-sm font-medium text-gray-800 w-12 text-right">35%</span>
                                </div>
                            </div>
                            <!-- EMEA -->
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="h-3 w-3 rounded-full bg-green-500"></div>
                                    <span class="text-sm text-gray-600">EMEA</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-24 h-2 bg-gray-100 rounded-full overflow-hidden">
                                        <div class="h-full bg-green-500 rounded-full" style="width: 28%"></div>
                                    </div>
                                    <span class="text-sm font-medium text-gray-800 w-12 text-right">28%</span>
                                </div>
                            </div>
                            <!-- NAM -->
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="h-3 w-3 rounded-full bg-purple-500"></div>
                                    <span class="text-sm text-gray-600">NAM</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-24 h-2 bg-gray-100 rounded-full overflow-hidden">
                                        <div class="h-full bg-purple-500 rounded-full" style="width: 25%"></div>
                                    </div>
                                    <span class="text-sm font-medium text-gray-800 w-12 text-right">25%</span>
                                </div>
                            </div>
                            <!-- LATAM -->
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="h-3 w-3 rounded-full bg-amber-500"></div>
                                    <span class="text-sm text-gray-600">LATAM</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-24 h-2 bg-gray-100 rounded-full overflow-hidden">
                                        <div class="h-full bg-amber-500 rounded-full" style="width: 12%"></div>
                                    </div>
                                    <span class="text-sm font-medium text-gray-800 w-12 text-right">12%</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6 pt-4 border-t border-gray-100">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-500">Total Portfolio</span>
                                <span class="font-semibold text-gray-800">$-- B</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Row 3: Full Width Table -->
            <div class="mb-6">
                <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6">
                    <div class="mb-5 flex items-start justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Balance Breakdown by Product Program</h3>
                            <p class="mt-1 text-gray-500 text-sm">Detailed breakdown with notional, committed, outstanding balances and utilization</p>
                        </div>
                        <button class="flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-1.5 text-sm font-medium text-gray-600 hover:bg-gray-50">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                    </svg>
                            Export
                                </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-gray-500">
                            <thead class="text-sm text-gray-700 bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left whitespace-nowrap">Product Program</th>
                                    <th class="px-4 py-3 text-right whitespace-nowrap">Notional</th>
                                    <th class="px-4 py-3 text-right whitespace-nowrap">Committed</th>
                                    <th class="px-4 py-3 text-right whitespace-nowrap">Outstanding</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">Utilization</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b hover:bg-gray-50">
                                    <td colspan="6" class="px-4 py-8 text-center text-gray-400">
                                        <div class="flex flex-col items-center gap-2">
                                            <svg class="h-8 w-8 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                            <p class="text-sm">Placeholder for balance breakdown by Product_Program_Name</p>
                            </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>
        </div>
        <!-- Team View Section (Hidden) -->
        <div style="display: none;">
            <!-- Row 1: Metrics (7) + Donut Chart (5) - eCommerce style -->
            <div class="mb-6 grid grid-cols-12 gap-4 md:gap-6">
                <!-- Left Column: Stacked Metrics + Bar Chart -->
                <div class="col-span-12 xl:col-span-7 space-y-6">
                    <!-- 2x2 Metric Cards Grid -->
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Total Team Leads -->
                        <div class="rounded-2xl border border-gray-200 bg-white p-5">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">Team Leads</p>
                                    <h3 class="text-2xl font-bold text-gray-900 mt-1">--</h3>
                </div>
                                <div class="flex h-12 w-12 items-center justify-center rounded-full bg-blue-100">
                                    <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">Unique Underwriting_Team_Lead</p>
            </div>
            
                        <!-- Total Underwriters -->
                        <div class="rounded-2xl border border-gray-200 bg-white p-5">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">Underwriters</p>
                                    <h3 class="text-2xl font-bold text-gray-900 mt-1">--</h3>
                    </div>
                                <div class="flex h-12 w-12 items-center justify-center rounded-full bg-green-100">
                                    <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">Unique Lead_Underwriter</p>
                    </div>
                    
                        <!-- Avg Portfolio -->
                        <div class="rounded-2xl border border-gray-200 bg-white p-5">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">Avg Portfolio</p>
                                    <h3 class="text-2xl font-bold text-gray-900 mt-1">$--</h3>
                                </div>
                                <div class="flex h-12 w-12 items-center justify-center rounded-full bg-purple-100">
                                    <svg class="h-6 w-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">Average TFA per team lead</p>
                        </div>
                        
                        <!-- Total TFA -->
                        <div class="rounded-2xl border border-gray-200 bg-white p-5">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500">Total TFA</p>
                                    <h3 class="text-2xl font-bold text-gray-900 mt-1">$--</h3>
                                </div>
                                <div class="flex h-12 w-12 items-center justify-center rounded-full bg-amber-100">
                                    <svg class="h-6 w-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">Sum of all team portfolios</p>
                    </div>
                </div>

                    <!-- Team Performance Bar Chart -->
                    <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6">
                        <div class="mb-5 flex items-start justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">Top Team Leads by TFA</h3>
                                <p class="mt-1 text-gray-500 text-sm">Portfolio size comparison across team leads</p>
                        </div>
                        </div>
                        <div class="flex items-center justify-center h-64 bg-gray-50 rounded-lg">
                            <div class="text-center text-gray-400">
                                <svg class="h-12 w-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                <p class="text-sm font-medium">Horizontal Bar Chart Placeholder</p>
                                <p class="text-xs mt-1">Top 10 team leads by total facility amount</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: ROTCE Donut Chart -->
                <div class="col-span-12 xl:col-span-5">
                    <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6 h-full">
                        <div class="mb-5 flex items-start justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">ROTCE Distribution</h3>
                                <p class="mt-1 text-gray-500 text-sm">Team performance against 12% target</p>
                            </div>
                            <span class="inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-700">
                                Target: 12%
                            </span>
                        </div>
                        <div class="flex items-center justify-center h-64 bg-gray-50 rounded-lg mb-5">
                            <div class="text-center text-gray-400">
                                <svg class="h-16 w-16 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                                </svg>
                                <p class="text-sm font-medium">Donut Chart Placeholder</p>
                                <p class="text-xs mt-1">Above/Below target distribution</p>
                            </div>
                        </div>
                        <!-- Legend -->
                        <div class="flex items-center justify-center gap-6">
                <div class="flex items-center gap-2">
                                <div class="h-3 w-3 rounded-full bg-green-500"></div>
                                <span class="text-sm text-gray-600">Above Target</span>
                                <span class="text-sm font-semibold text-gray-800">--%</span>
                    </div>
                            <div class="flex items-center gap-2">
                                <div class="h-3 w-3 rounded-full bg-red-500"></div>
                                <span class="text-sm text-gray-600">Below Target</span>
                                <span class="text-sm font-semibold text-gray-800">--%</span>
                </div>
            </div>
                    </div>
            </div>
        </div>
        
            <!-- Row 2: Full Width Team Table -->
            <div class="mb-6">
                <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6">
                    <div class="mb-5 flex items-start justify-between">
                    <div>
                            <h3 class="text-lg font-semibold text-gray-800">Portfolio by Team Lead</h3>
                            <p class="mt-1 text-gray-500 text-sm">Detailed breakdown by Underwriting_Team_Lead with performance metrics</p>
                    </div>
                        <div class="flex items-center gap-2">
                            <input type="text" placeholder="Search team lead..." class="rounded-lg border border-gray-200 px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button class="flex items-center gap-2 rounded-lg border border-gray-200 px-3 py-1.5 text-sm font-medium text-gray-600 hover:bg-gray-50">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                    </svg>
                                Export
                                    </button>
                    </div>
                            </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-gray-500">
                            <thead class="text-sm text-gray-700 bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left whitespace-nowrap">Team Lead</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">Relationships</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">Facilities</th>
                                    <th class="px-4 py-3 text-right whitespace-nowrap">Total TFA</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">Avg ROTCE</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b hover:bg-gray-50">
                                    <td colspan="6" class="px-4 py-8 text-center text-gray-400">
                                        <div class="flex flex-col items-center gap-2">
                                            <svg class="h-8 w-8 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                            <p class="text-sm">Placeholder for team portfolio breakdown</p>
                </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                        </div>
                    </div>
        </div>

        <!-- Top Names Section (Hidden) -->
        <div style="display: none;">
            <!-- Row 1: Full Width Metrics (like Marketing) -->
            <div class="mb-6 grid grid-cols-2 gap-4 sm:grid-cols-4 md:gap-6">
                <!-- Total Relationships -->
                <div class="rounded-2xl border border-gray-200 bg-white p-5">
                    <div class="flex items-center gap-3">
                        <span class="flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-blue-100">
                            <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                        </span>
                        <div>
                            <p class="text-sm text-gray-500">Relationships</p>
                            <h3 class="text-xl font-bold text-gray-800">--</h3>
                    </div>
                </div>
            </div>

                <!-- Top 10 Concentration -->
                <div class="rounded-2xl border border-gray-200 bg-white p-5">
                    <div class="flex items-center gap-3">
                        <span class="flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-amber-100">
                            <svg class="h-5 w-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                            </svg>
                        </span>
                        <div>
                            <p class="text-sm text-gray-500">Top 10 Concentration</p>
                            <h3 class="text-xl font-bold text-gray-800">--%</h3>
                        </div>
                    </div>
                </div>
                
                <!-- Total TFA -->
                <div class="rounded-2xl border border-gray-200 bg-white p-5">
                    <div class="flex items-center gap-3">
                        <span class="flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-green-100">
                            <svg class="h-5 w-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                        </span>
                        <div>
                            <p class="text-sm text-gray-500">Total TFA</p>
                            <h3 class="text-xl font-bold text-gray-800">$--</h3>
                                </div>
                        </div>
                    </div>

                <!-- Avg Size -->
                <div class="rounded-2xl border border-gray-200 bg-white p-5">
                    <div class="flex items-center gap-3">
                        <span class="flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-purple-100">
                            <svg class="h-5 w-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                        </span>
                        <div>
                            <p class="text-sm text-gray-500">Avg Size</p>
                            <h3 class="text-xl font-bold text-gray-800">$--</h3>
                    </div>
                </div>
            </div>
        </div>

            <!-- Row 2: Main Content (8) + Side Panel (4) - Marketing Style -->
            <div class="mb-6 grid grid-cols-12 gap-4 md:gap-6">
                <!-- Left: Chart + Table Stacked -->
                <div class="col-span-12 xl:col-span-8 space-y-6">
                    <!-- Concentration Area Chart -->
            <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6">
                <div class="mb-5 flex items-start justify-between">
                    <div>
                                <h3 class="text-lg font-semibold text-gray-800">Portfolio Concentration Trend</h3>
                                <p class="mt-1 text-gray-500 text-sm">Top 10 relationships share over time</p>
                    </div>
                            <div class="flex items-center gap-2">
                                <button class="rounded-lg px-3 py-1.5 text-sm font-medium text-gray-500 hover:bg-gray-100">Weekly</button>
                                <button class="rounded-lg px-3 py-1.5 text-sm font-medium bg-blue-100 text-blue-600">Monthly</button>
                                <button class="rounded-lg px-3 py-1.5 text-sm font-medium text-gray-500 hover:bg-gray-100">Quarterly</button>
                            </div>
                        </div>
                        <div class="flex items-center justify-center h-64 bg-gray-50 rounded-lg">
                            <div class="text-center text-gray-400">
                                <svg class="h-12 w-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                            </svg>
                                <p class="text-sm font-medium">Area Chart Placeholder</p>
                                <p class="text-xs mt-1">Concentration trend over time</p>
                        </div>
                    </div>
                </div>

                    <!-- Top Relationships Table -->
                    <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6">
                        <div class="mb-5 flex items-start justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">Top Relationships</h3>
                                <p class="mt-1 text-gray-500 text-sm">Ranked by total facility amount</p>
                            </div>
                            <select class="rounded-lg border border-gray-200 px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option>Top 10</option>
                                <option>Top 25</option>
                                <option>Top 50</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto">
                    <table class="w-full text-sm text-gray-500">
                        <thead class="text-sm text-gray-700 bg-gray-50">
                            <tr>
                                        <th class="px-4 py-3 text-left whitespace-nowrap">#</th>
                                        <th class="px-4 py-3 text-left whitespace-nowrap">Relationship</th>
                                        <th class="px-4 py-3 text-right whitespace-nowrap">TFA</th>
                                        <th class="px-4 py-3 text-center whitespace-nowrap">ROTCE</th>
                                        <th class="px-4 py-3 text-center whitespace-nowrap">Share</th>
                            </tr>
                        </thead>
                                <tbody>
                            <tr class="border-b hover:bg-gray-50">
                                        <td colspan="5" class="px-4 py-8 text-center text-gray-400">
                                            <div class="flex flex-col items-center gap-2">
                                                <svg class="h-8 w-8 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                                </svg>
                                                <p class="text-sm">Placeholder for top relationships</p>
                                    </div>
                                </td>
                            </tr>
                                </tbody>
                            </table>
                                    </div>
                                    </div>
                </div>
                
                <!-- Right: Stacked Side Panels (Traffic Source Style) -->
                <div class="col-span-12 xl:col-span-4 space-y-6">
                    <!-- Concentration Donut -->
                    <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6">
                        <div class="mb-5">
                            <h3 class="text-lg font-semibold text-gray-800">Portfolio Breakdown</h3>
                            <p class="mt-1 text-gray-500 text-sm">Concentration distribution</p>
                                    </div>
                        <div class="flex items-center justify-center h-48 bg-gray-50 rounded-lg mb-4">
                            <div class="text-center text-gray-400">
                                <svg class="h-12 w-12 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                                </svg>
                                <p class="text-xs">Donut Chart</p>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between text-sm">
                                <div class="flex items-center gap-2">
                                    <div class="h-3 w-3 rounded-full bg-blue-500"></div>
                                    <span class="text-gray-600">Top 10</span>
                                </div>
                                <span class="font-medium text-gray-800">--%</span>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <div class="flex items-center gap-2">
                                    <div class="h-3 w-3 rounded-full bg-gray-300"></div>
                                    <span class="text-gray-600">Others</span>
                                </div>
                                <span class="font-medium text-gray-800">--%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Size Distribution -->
                    <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6">
                        <div class="mb-5">
                            <h3 class="text-lg font-semibold text-gray-800">Size Distribution</h3>
                            <p class="mt-1 text-gray-500 text-sm">Relationships by size bucket</p>
                                    </div>
                        <div class="space-y-3">
                            <!-- >$100M -->
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-600">&gt;$100M</span>
                                    <span class="font-medium text-gray-800">-- names</span>
                                </div>
                                <div class="h-2 w-full bg-gray-100 rounded-full overflow-hidden">
                                    <div class="h-full bg-blue-500 rounded-full" style="width: 15%"></div>
                                </div>
                            </div>
                            <!-- $50-100M -->
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-600">$50-100M</span>
                                    <span class="font-medium text-gray-800">-- names</span>
                                </div>
                                <div class="h-2 w-full bg-gray-100 rounded-full overflow-hidden">
                                    <div class="h-full bg-green-500 rounded-full" style="width: 25%"></div>
                                </div>
                            </div>
                            <!-- $10-50M -->
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-600">$10-50M</span>
                                    <span class="font-medium text-gray-800">-- names</span>
                                </div>
                                <div class="h-2 w-full bg-gray-100 rounded-full overflow-hidden">
                                    <div class="h-full bg-purple-500 rounded-full" style="width: 40%"></div>
                                </div>
                            </div>
                            <!-- <$10M -->
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-600">&lt;$10M</span>
                                    <span class="font-medium text-gray-800">-- names</span>
                                </div>
                                <div class="h-2 w-full bg-gray-100 rounded-full overflow-hidden">
                                    <div class="h-full bg-amber-500 rounded-full" style="width: 55%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Covenants Section (Hidden) -->
        <div style="display: none;">
            <!-- Row 1: Full Width Metrics -->
            <div class="mb-6 grid grid-cols-2 gap-4 sm:grid-cols-4 md:gap-6">
                <!-- Total Covenants -->
                <div class="rounded-2xl border border-gray-200 bg-white p-5">
                    <div class="flex flex-col">
                        <span class="text-sm text-gray-500">Total Covenants</span>
                        <div class="flex items-baseline gap-2 mt-1">
                            <h3 class="text-2xl font-bold text-gray-800">--</h3>
                            <span class="text-xs text-gray-400">unique</span>
                                    </div>
                    </div>
                </div>
                <!-- Past Due -->
                <div class="rounded-2xl border border-red-200 bg-red-50 p-5">
                    <div class="flex flex-col">
                        <span class="text-sm text-red-600">Past Due</span>
                        <div class="flex items-baseline gap-2 mt-1">
                            <h3 class="text-2xl font-bold text-red-700">--</h3>
                            <span class="inline-flex items-center gap-1 text-xs text-red-600">
                                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                needs attention
                            </span>
                        </div>
                    </div>
                </div>
                <!-- Coming Due -->
                <div class="rounded-2xl border border-amber-200 bg-amber-50 p-5">
                    <div class="flex flex-col">
                        <span class="text-sm text-amber-600">Coming Due (30d)</span>
                        <div class="flex items-baseline gap-2 mt-1">
                            <h3 class="text-2xl font-bold text-amber-700">--</h3>
                            <span class="inline-flex items-center gap-1 text-xs text-amber-600">
                                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                upcoming
                            </span>
                        </div>
                    </div>
                </div>
                <!-- Compliance Rate -->
                <div class="rounded-2xl border border-green-200 bg-green-50 p-5">
                    <div class="flex flex-col">
                        <span class="text-sm text-green-600">Compliance Rate</span>
                        <div class="flex items-baseline gap-2 mt-1">
                            <h3 class="text-2xl font-bold text-green-700">--%</h3>
                            <span class="inline-flex items-center gap-1 text-xs text-green-600">
                                <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                on-time
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Row 2: Large Chart (8) + Side Donut (4) - CRM Style -->
            <div class="mb-6 grid grid-cols-12 gap-4 md:gap-6">
                <!-- Covenant Aging Timeline -->
                <div class="col-span-12 xl:col-span-8">
                    <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6 h-full">
                        <div class="mb-5 flex items-start justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">Covenant Aging Timeline</h3>
                                <p class="mt-1 text-gray-500 text-sm">Past due and coming due covenants by aging bucket</p>
                                    </div>
                            <div x-data="{ selected: 'all' }" class="flex items-center gap-0.5 rounded-lg bg-gray-100 p-0.5">
                                <button @click="selected = 'all'" :class="selected === 'all' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500'" class="rounded-md px-3 py-1.5 text-sm font-medium">All</button>
                                <button @click="selected = 'pastdue'" :class="selected === 'pastdue' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500'" class="rounded-md px-3 py-1.5 text-sm font-medium">Past Due</button>
                                <button @click="selected = 'coming'" :class="selected === 'coming' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500'" class="rounded-md px-3 py-1.5 text-sm font-medium">Coming</button>
                            </div>
                        </div>
                        <div class="flex items-center justify-center h-72 bg-gray-50 rounded-lg">
                            <div class="text-center text-gray-400">
                                <svg class="h-12 w-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                <p class="text-sm font-medium">Stacked Bar Chart Placeholder</p>
                                <p class="text-xs mt-1">Aging buckets: 1-45, 46-90, >90 days</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Status Distribution Donut -->
                <div class="col-span-12 xl:col-span-4">
                    <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6 h-full">
                        <div class="mb-5">
                            <h3 class="text-lg font-semibold text-gray-800">Status Distribution</h3>
                            <p class="mt-1 text-gray-500 text-sm">Current covenant status breakdown</p>
                                    </div>
                        <div class="flex items-center justify-center h-48 bg-gray-50 rounded-lg mb-4">
                            <div class="text-center text-gray-400">
                                <svg class="h-12 w-12 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                                </svg>
                                <p class="text-xs">Donut Chart</p>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between text-sm">
                                <div class="flex items-center gap-2"><div class="h-3 w-3 rounded-full bg-red-500"></div><span class="text-gray-600">Past Due</span></div>
                                <span class="font-medium text-gray-800">-- (--%)</span>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <div class="flex items-center gap-2"><div class="h-3 w-3 rounded-full bg-amber-500"></div><span class="text-gray-600">Coming Due</span></div>
                                <span class="font-medium text-gray-800">-- (--%)</span>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <div class="flex items-center gap-2"><div class="h-3 w-3 rounded-full bg-green-500"></div><span class="text-gray-600">On Track</span></div>
                                <span class="font-medium text-gray-800">-- (--%)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Row 3: Regional Summary (6) + Upcoming Schedule (6) - CRM Style -->
            <div class="mb-6 grid grid-cols-12 gap-4 md:gap-6">
                <!-- Regional Summary -->
                <div class="col-span-12 xl:col-span-6">
                    <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6 h-full">
                        <div class="mb-5">
                            <h3 class="text-lg font-semibold text-gray-800">Regional Summary</h3>
                            <p class="mt-1 text-gray-500 text-sm">Covenant status by region</p>
                                    </div>
                        <div class="space-y-4">
                            <!-- Region rows with progress bars -->
                            <div class="flex items-center gap-4">
                                <span class="w-16 text-sm font-medium text-gray-600">APAC</span>
                                <div class="flex-1 flex h-4 rounded-full overflow-hidden bg-gray-100">
                                    <div class="bg-red-500" style="width: 15%"></div>
                                    <div class="bg-amber-500" style="width: 25%"></div>
                                    <div class="bg-green-500" style="width: 60%"></div>
                                </div>
                                <span class="w-12 text-right text-sm text-gray-600">--</span>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="w-16 text-sm font-medium text-gray-600">EMEA</span>
                                <div class="flex-1 flex h-4 rounded-full overflow-hidden bg-gray-100">
                                    <div class="bg-red-500" style="width: 10%"></div>
                                    <div class="bg-amber-500" style="width: 20%"></div>
                                    <div class="bg-green-500" style="width: 70%"></div>
                                </div>
                                <span class="w-12 text-right text-sm text-gray-600">--</span>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="w-16 text-sm font-medium text-gray-600">NAM</span>
                                <div class="flex-1 flex h-4 rounded-full overflow-hidden bg-gray-100">
                                    <div class="bg-red-500" style="width: 20%"></div>
                                    <div class="bg-amber-500" style="width: 15%"></div>
                                    <div class="bg-green-500" style="width: 65%"></div>
                                </div>
                                <span class="w-12 text-right text-sm text-gray-600">--</span>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="w-16 text-sm font-medium text-gray-600">LATAM</span>
                                <div class="flex-1 flex h-4 rounded-full overflow-hidden bg-gray-100">
                                    <div class="bg-red-500" style="width: 5%"></div>
                                    <div class="bg-amber-500" style="width: 30%"></div>
                                    <div class="bg-green-500" style="width: 65%"></div>
                                </div>
                                <span class="w-12 text-right text-sm text-gray-600">--</span>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-100 flex items-center justify-center gap-6 text-xs">
                            <div class="flex items-center gap-1"><div class="h-2 w-2 rounded-full bg-red-500"></div>Past Due</div>
                            <div class="flex items-center gap-1"><div class="h-2 w-2 rounded-full bg-amber-500"></div>Coming Due</div>
                            <div class="flex items-center gap-1"><div class="h-2 w-2 rounded-full bg-green-500"></div>On Track</div>
                        </div>
                    </div>
                </div>
                
                <!-- Upcoming Covenants Schedule -->
                <div class="col-span-12 xl:col-span-6">
                    <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6 h-full">
                        <div class="mb-5">
                            <h3 class="text-lg font-semibold text-gray-800">Upcoming Schedule</h3>
                            <p class="mt-1 text-gray-500 text-sm">Covenants due in next 30 days</p>
                                    </div>
                        <div class="space-y-3">
                            <div class="flex items-center justify-center h-40 bg-gray-50 rounded-lg">
                                <div class="text-center text-gray-400">
                                    <svg class="h-8 w-8 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <p class="text-sm">Calendar View Placeholder</p>
                                    <p class="text-xs mt-1">Upcoming covenant due dates</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Row 4: Full Width Details Table -->
            <div class="mb-6">
                <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6">
                    <div class="mb-5 flex items-start justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Covenant Details</h3>
                            <p class="mt-1 text-gray-500 text-sm">Complete list of all covenants</p>
                                    </div>
                        <div class="flex items-center gap-2">
                            <input type="text" placeholder="Search covenants..." class="rounded-lg border border-gray-200 px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <select class="rounded-lg border border-gray-200 px-3 py-1.5 text-sm focus:outline-none">
                                <option>All Status</option>
                                <option>Past Due</option>
                                <option>Coming Due</option>
                                <option>On Track</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-gray-500">
                            <thead class="text-sm text-gray-700 bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left whitespace-nowrap">Covenant #</th>
                                    <th class="px-4 py-3 text-left whitespace-nowrap">Relationship</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">Region</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">Due Date</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">Status</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">Days</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr class="border-b hover:bg-gray-50">
                                    <td colspan="6" class="px-4 py-8 text-center text-gray-400">
                                        <div class="flex flex-col items-center gap-2">
                                            <svg class="h-8 w-8 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                            <p class="text-sm">Placeholder for covenant details</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                    </div>
            </div>
        </div>

        <!-- Credit Reviews (CCM) Section (Hidden) -->
        <div style="display: none;">
            <!-- Row 1: Metrics with sparklines (SaaS Style) -->
            <div class="mb-6 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4 md:gap-6">
                <!-- Total CCMs -->
                <div class="rounded-2xl border border-gray-200 bg-white p-5">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Total Reviews</p>
                            <h3 class="text-3xl font-bold text-gray-800 mt-2">--</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">Active CCM records</p>
                        </div>
                        <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-blue-100">
                            <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                        </div>
                </div>
                
                <!-- Past Due -->
                <div class="rounded-2xl border border-gray-200 bg-white p-5">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Past Due</p>
                            <h3 class="text-3xl font-bold text-red-600 mt-2">--</h3>
                            <p class="text-xs text-red-500 mt-1 flex items-center gap-1">
                                <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg>
                                Needs attention
                            </p>
                        </div>
                        <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-red-100">
                            <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                    </div>
                </div>
            </div>
                
                <!-- Coming Due -->
                <div class="rounded-2xl border border-gray-200 bg-white p-5">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Coming Due</p>
                            <h3 class="text-3xl font-bold text-amber-600 mt-2">--</h3>
                            <p class="text-xs text-amber-500 mt-1">Within current month</p>
                        </div>
                        <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-amber-100">
                            <svg class="h-6 w-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
        </div>
        </div>

                <!-- Open -->
                <div class="rounded-2xl border border-gray-200 bg-white p-5">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Open</p>
                            <h3 class="text-3xl font-bold text-green-600 mt-2">--</h3>
                            <p class="text-xs text-green-500 mt-1">Future due dates</p>
                        </div>
                        <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-green-100">
                            <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
            </div>
        </div>

            <!-- Row 2: Main Content (7/8) + Side Panel (5/4) - SaaS Style -->
            <div class="mb-6 gap-5 space-y-5 sm:gap-6 sm:space-y-6 xl:grid xl:grid-cols-12 xl:space-y-0">
                <!-- Left: Stacked Charts -->
                <div class="xl:col-span-7 2xl:col-span-8">
                    <div class="space-y-5 sm:space-y-6">
                        <!-- Two charts side by side -->
                        <div class="grid gap-5 sm:gap-6 lg:grid-cols-2">
                            <!-- Status Breakdown Donut -->
                            <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6">
                                <div class="mb-4">
                                    <h3 class="text-lg font-semibold text-gray-800">Status Breakdown</h3>
                                    <p class="text-sm text-gray-500">Current distribution</p>
                                </div>
                                <div class="flex items-center justify-center h-48 bg-gray-50 rounded-lg">
                                    <div class="text-center text-gray-400">
                                        <svg class="h-10 w-10 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                                        </svg>
                                        <p class="text-xs">Donut Chart</p>
            </div>
        </div>
                            </div>
                            
                            <!-- Risk Rating Distribution -->
                            <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6">
                                <div class="mb-4">
                                    <h3 class="text-lg font-semibold text-gray-800">Risk Rating Dist.</h3>
                                    <p class="text-sm text-gray-500">By classification</p>
                                </div>
                                <div class="flex items-center justify-center h-48 bg-gray-50 rounded-lg">
                                    <div class="text-center text-gray-400">
                                        <svg class="h-10 w-10 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                        <p class="text-xs">Bar Chart</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Regional Stacked Chart -->
                        <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6">
                            <div class="mb-5 flex items-start justify-between">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800">Regional Overview</h3>
                                    <p class="text-gray-500 text-sm">Status distribution by region</p>
                                </div>
                                <select class="rounded-lg border border-gray-200 px-3 py-1.5 text-sm focus:outline-none">
                                    <option>All Regions</option>
                                    <option>APAC</option>
                                    <option>EMEA</option>
                                    <option>NAM</option>
                                    <option>LATAM</option>
                                </select>
                            </div>
                            <div class="flex items-center justify-center h-56 bg-gray-50 rounded-lg">
                                <div class="text-center text-gray-400">
                                    <svg class="h-12 w-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <p class="text-sm font-medium">Grouped Bar Chart Placeholder</p>
                                    <p class="text-xs mt-1">Past Due / Coming Due / Open by region</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right: Performance Panel (SaaS Style) -->
                <div class="space-y-6 xl:col-span-5 2xl:col-span-4">
                    <!-- Performance Card with Tabs -->
                    <div class="rounded-2xl border border-gray-200 bg-white p-6">
                        <div class="mb-6 flex justify-between">
                            <h3 class="text-lg font-semibold text-gray-800">Performance</h3>
                        </div>
                        <div x-data="{selected: 'region'}">
                            <div class="flex w-full items-center gap-0.5 rounded-lg bg-gray-100 p-0.5 mb-4">
                                <button @click="selected = 'region'" :class="selected === 'region' ? 'shadow-sm text-gray-900 bg-white' : 'text-gray-500'" class="text-sm w-full rounded-md px-3 py-2 font-medium">By Region</button>
                                <button @click="selected = 'approver'" :class="selected === 'approver' ? 'shadow-sm text-gray-900 bg-white' : 'text-gray-500'" class="text-sm w-full rounded-md px-3 py-2 font-medium">By Approver</button>
                            </div>
                            
                            <!-- Region View -->
                            <div x-show="selected === 'region'" class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">APAC</span>
                                    <div class="flex items-center gap-2">
                                        <div class="w-32 h-2 bg-gray-100 rounded-full overflow-hidden">
                                            <div class="h-full bg-blue-500 rounded-full" style="width: 35%"></div>
                                        </div>
                                        <span class="text-sm font-medium text-gray-800 w-8 text-right">--</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">EMEA</span>
                                    <div class="flex items-center gap-2">
                                        <div class="w-32 h-2 bg-gray-100 rounded-full overflow-hidden">
                                            <div class="h-full bg-green-500 rounded-full" style="width: 28%"></div>
                                        </div>
                                        <span class="text-sm font-medium text-gray-800 w-8 text-right">--</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">NAM</span>
                                    <div class="flex items-center gap-2">
                                        <div class="w-32 h-2 bg-gray-100 rounded-full overflow-hidden">
                                            <div class="h-full bg-purple-500 rounded-full" style="width: 25%"></div>
                                        </div>
                                        <span class="text-sm font-medium text-gray-800 w-8 text-right">--</span>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">LATAM</span>
                                    <div class="flex items-center gap-2">
                                        <div class="w-32 h-2 bg-gray-100 rounded-full overflow-hidden">
                                            <div class="h-full bg-amber-500 rounded-full" style="width: 12%"></div>
                                        </div>
                                        <span class="text-sm font-medium text-gray-800 w-8 text-right">--</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Approver View -->
                            <div x-show="selected === 'approver'" class="space-y-3">
                                <div class="flex items-center justify-center h-32 bg-gray-50 rounded-lg">
                                    <p class="text-sm text-gray-400">Approver breakdown placeholder</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions Card -->
                    <div class="rounded-2xl border border-gray-200 bg-white p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Quick Summary</h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                <span class="text-sm text-gray-600">Oldest Past Due</span>
                                <span class="text-sm font-medium text-red-600">-- days</span>
                            </div>
                            <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                <span class="text-sm text-gray-600">Due This Week</span>
                                <span class="text-sm font-medium text-amber-600">--</span>
                            </div>
                            <div class="flex items-center justify-between py-2">
                                <span class="text-sm text-gray-600">Avg Days to Due</span>
                                <span class="text-sm font-medium text-gray-800">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Row 3: Full Width Details Table -->
            <div class="mb-6">
                <div class="rounded-2xl border border-gray-200 bg-white px-5 pb-5 pt-5 sm:px-6">
                    <div class="mb-5 flex items-start justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Credit Review Details</h3>
                            <p class="mt-1 text-gray-500 text-sm">Complete list of all credit committee memos</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="text" placeholder="Search..." class="rounded-lg border border-gray-200 px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-40">
                            <select class="rounded-lg border border-gray-200 px-3 py-1.5 text-sm focus:outline-none">
                                <option>All Status</option>
                                <option>Past Due</option>
                                <option>Coming Due</option>
                                <option>Open</option>
                            </select>
                            <button class="flex items-center gap-1 rounded-lg bg-blue-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-blue-700">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                                Export
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-gray-500">
                            <thead class="text-sm text-gray-700 bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left whitespace-nowrap">Relationship</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">Region</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">Risk Rating</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">Due Date</th>
                                    <th class="px-4 py-3 text-center whitespace-nowrap">Status</th>
                                    <th class="px-4 py-3 text-left whitespace-nowrap">Approver</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-b hover:bg-gray-50">
                                    <td colspan="6" class="px-4 py-8 text-center text-gray-400">
                                        <div class="flex flex-col items-center gap-2">
                                            <svg class="h-8 w-8 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                            <p class="text-sm">Placeholder for CCM details</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ETL Process Note -->
            <div class="overflow-hidden rounded-xl border border-blue-100 bg-blue-50">
                <div class="flex items-start gap-3 px-5 py-4">
                    <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-blue-100">
                        <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h4 class="text-sm font-semibold text-blue-800 mb-1">Data ETL Process</h4>
                        <p class="text-xs text-blue-700">Before loading, the ETL process standardizes regional files into one, filters out Credit_Classification = Pass and Loss, keeps only CM in DM/CM_Flag, then creates a standardized file for this dashboard.</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Credit Reviews Tab -->
    </div>

    <script>
        // ===== PORTFOLIO ANALYTICS CONFIGURATION =====
        // This dashboard loads data from Confluence in READ-ONLY mode
        // Similar to cmps.html, data is fetched from an attachment but never modified
        // All filters and options are dynamically populated from the loaded data
        
        // Update these values to match your Confluence page and attachment
        const CONFLUENCE_PAGE_ID = "3229979875"; // Your Confluence page ID
        const CONFLUENCE_FILE_NAME = "Portfolio_tw.xlsx"; // Your attachment filename (can be .csv, .xlsx, or .xls)
        const CONFLUENCE_COVENANTS_FILE = "Covenants_tw.xlsx"; // Covenants data file (this week)
        const CONFLUENCE_COVENANTS_LW_FILE = "Covenants_lw.xlsx"; // Covenants data file (last week)
        const CONFLUENCE_CCM_FILE = "CCM_current.xlsx"; // CCM (Credit Committee Memos) data file - current month
        const CONFLUENCE_CCM_PREVIOUS_FILE = "CCM_previous.xlsx"; // CCM data file - previous month
        const CONFLUENCE_BASE_URL = "https://cedt-confluence.nam.nsroot.net/confluence";
        // ==========================================
        
        // ===== PERFORMANCE OPTIMIZATIONS FOR 40K+ ROWS =====
        // 1. INDEX CACHING: Pre-parse dates and build indexes for fast filtering
        // 2. SMART FILTERING: Early exit loops, minimal object access, use for-loops not .filter()
        // 3. RESULT CACHING: Cache filtered results to avoid re-filtering same queries
        // 4. SINGLE-PASS METRICS: Calculate all metrics in one loop instead of multiple passes
        // 5. OPTIMIZED CHARTS: Use Map() instead of objects, limit data points
        // 6. DEBOUNCED SEARCH: 300ms delay to prevent filtering on every keystroke
        // 7. LAZY LOADING: 20 rows per page by default (only render visible data)
        // 8. ASYNC RENDERING: Use requestAnimationFrame to prevent UI blocking
        // 9. MEMOIZATION: Cache filtered/sorted results to avoid recomputation
        // 
        // Expected Performance: 40K rows should filter in 50-200ms (was 2-5 seconds)
        // =====================================================

        // Global variables
        let portfolioData = [];
        let covenantsData = []; // Separate covenant data from Covenants_tw.xlsx
        let covenantsDataLW = []; // Last week covenant data from Covenants_lw.xlsx
        let ccmData = []; // CCM (Credit Committee Memos) data from CCM_current.xlsx
        let ccmDataPrevious = []; // Previous month CCM data from CCM_previous.xlsx
        let filteredData = [];
        
        // Global constant for excluded facility types (used across multiple charts)
        const EXCLUDED_FACILITY_TYPES = [
            'Cash Management-DOL',
            'Cash Management-ACH',
            'Settlement',
            'Overdraft Line',
            'Collateral Monitoring Line',
            'Outgoing TPC',
            'Credit Card',
            'Guaranty',
            'Cash Management-Other',
            'B&I Margin Loan',
            'Cash Management-BACS',
            'SAFE - Prime Finance',
            'Clearing',
            'Agency Clearing',
            'SAFE - Financing',
            'B&I Short Market Values',
            'Residential First Mortgage-Standard',
            'B&I Non-Purpose Loan',
            'Unallocated'
        ];

        // ===== DUMMY DATA FOR TESTING =====
        // Uncomment this section to test with dummy data without loading from Confluence
        const ENABLE_DUMMY_DATA = true; // Set to false to use real data from Confluence
        
        if (ENABLE_DUMMY_DATA) {
            // Generate comprehensive dummy data for testing
            const regions = ['NAM', 'EMEA', 'APAC', 'LATAM'];
            const productPrograms = ['Corporate Lending', 'Trade Finance', 'Working Capital', 'Project Finance', 'Real Estate', 'Asset Based Lending', 'Equipment Finance', 'Supply Chain Finance'];
            const facilityTypes = ['Revolver', 'Term Loan', 'Overdraft', 'Bridge Loan', 'Construction Loan', 'LOC', 'Guarantee', 'SBLC'];
            const creditClass = ['PASS', 'SPECIAL MENTION', 'SUBSTANDARD', 'DOUBTFUL'];
            const underwriters = ['John Smith', 'Sarah Johnson', 'David Lee', 'Carlos Rodriguez', 'Robert Brown', 'Lisa Anderson', 'Mike Wilson', 'Emily Chen', 'Tom Harris', 'Anna Martinez'];
            const orginationUnits = ['Commercial Banking', 'Investment Banking', 'SME Banking', 'Structured Finance', 'Real Estate Finance', 'Trade Services'];
            
            portfolioData = [];
            
            // Generate 50 portfolio records
            for (let i = 1; i <= 50; i++) {
                const region = regions[i % regions.length];
                const productProgram = productPrograms[i % productPrograms.length];
                const facilityType = facilityTypes[i % facilityTypes.length];
                const underwriter = underwriters[i % underwriters.length];
                const baseAmount = (i * 1000000) + (Math.random() * 5000000);
                
                // Create some expiring items (20% of records) within next 3 months from Nov 30, 2024
                // Create some expired items (15% of records) before Nov 30, 2024
                const isExpiring = i % 5 === 0;
                const isExpired = i % 7 === 0;
                let expiryDate;
                let caExpiryDate;
                
                if (isExpired && !isExpiring) {
                    // Expired: Aug-Oct 2024 (before Nov 30, 2024)
                    const randomMonth = Math.floor(Math.random() * 3); // 0, 1, or 2
                    const month = 7 + randomMonth; // 7 (Aug), 8 (Sep), 9 (Oct)
                    expiryDate = new Date(2024, month, Math.floor(Math.random() * 28) + 1).toISOString().split('T')[0];
                    caExpiryDate = new Date(2024, month, Math.floor(Math.random() * 28) + 1).toISOString().split('T')[0];
                } else if (isExpiring) {
                    // Expiring: Next 3 months: Dec 2024, Jan 2025, Feb 2025
                    const randomMonth = Math.floor(Math.random() * 3); // 0, 1, or 2
                    const month = 11 + randomMonth; // 11 (Dec), 12 (Jan), 13 (Feb)
                    const year = month > 11 ? 2025 : 2024;
                    const actualMonth = month > 11 ? month - 12 : month;
                    expiryDate = new Date(year, actualMonth, Math.floor(Math.random() * 28) + 1).toISOString().split('T')[0];
                    caExpiryDate = new Date(year, actualMonth, Math.floor(Math.random() * 28) + 1).toISOString().split('T')[0];
                } else {
                    expiryDate = new Date(2026, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1).toISOString().split('T')[0];
                    caExpiryDate = new Date(2026, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1).toISOString().split('T')[0];
                }
                
                // Create new deals (30% are from current month, 20% from last month)
                let originationDate;
                let facilityFirstApprovalDate = null;
                
                if (i % 10 < 3) {
                    originationDate = '2024-11-' + (Math.floor(Math.random() * 20) + 1).toString().padStart(2, '0');
                    // For NAM, LATAM, EMEA: set Facility_First_Approval_Date to current month
                    if (region === 'NAM' || region === 'LATAM' || region === 'EMEA') {
                        facilityFirstApprovalDate = '2024-11-' + (Math.floor(Math.random() * 20) + 1).toString().padStart(2, '0');
                    }
                } else if (i % 10 < 5) {
                    originationDate = '2024-10-' + (Math.floor(Math.random() * 20) + 1).toString().padStart(2, '0');
                    // For NAM, LATAM, EMEA: set Facility_First_Approval_Date to previous month
                    if (region === 'NAM' || region === 'LATAM' || region === 'EMEA') {
                        facilityFirstApprovalDate = '2024-10-' + (Math.floor(Math.random() * 20) + 1).toString().padStart(2, '0');
                    }
                } else {
                    originationDate = '2024-' + (Math.floor(Math.random() * 9) + 1).toString().padStart(2, '0') + '-15';
                    // Older facilities - no recent approval date
                    facilityFirstApprovalDate = null;
                }
                
                // APAC doesn't have Facility_First_Approval_Date (different logic)
                if (region === 'APAC') {
                    facilityFirstApprovalDate = null;
                }
                
                portfolioData.push({
                    Report_Date: '2024-11-30',
                    Region: region,
                    Origination_Unit: orginationUnits[i % orginationUnits.length],
                    Underwriting_Team_Lead: underwriter,
                    Lead_Underwriter: underwriter,
                    Product_Underwriter: underwriters[(i + 1) % underwriters.length],
                    Relationship_ID: 'REL' + i.toString().padStart(3, '0'),
                    Relationship_Name: `${region} Company ${i}`,
                    Borrowers_Name: `Borrower ${i}`,
                    CA_Number: 'CA2024' + i.toString().padStart(3, '0'),
                    Facility_ID: 'FAC2024' + i.toString().padStart(3, '0'),
                    Facility_Number: 'F' + i.toString().padStart(3, '0'),
                    Product_Program: productProgram,
                    Product_Program_Name: productProgram,
                    Facility_Type: facilityType,
                    Fac_Amount: baseAmount,
                    Facility_Amount: baseAmount,
                    OSUC: baseAmount * (0.7 + Math.random() * 0.2),
                    Total_OS: baseAmount * (0.5 + Math.random() * 0.3),
                    Unused_Commitment: baseAmount * (0.1 + Math.random() * 0.2),
                    Credit_Classification: creditClass[i % creditClass.length],
                    Management_Status: i % 3 === 0 ? 'DM' : 'CM',
                    CA_Review: (region === 'EMEA' && i % 2 === 0) ? 'Yes' : (region === 'EMEA' ? 'No' : ''),
                    'PSE_non-PSE': i % 4 === 0 ? 'PSE' : 'non-PSE',
                    PSE_non_PSE: i % 4 === 0 ? 'PSE' : 'non-PSE',
                    Commitment_Type: i % 3 === 0 ? 'Uncommitted' : 'Committed',
                    Committed_Uncommitted: i % 3 === 0 ? 'UNCOMMITTED' : 'COMMITTED',
                    Maturity_Date: expiryDate,
                    Origination_Date: originationDate,
                    Facility_First_Approval_Date: facilityFirstApprovalDate,
                    CA_Expiry_Date: caExpiryDate,
                    CA_Expiration_Date: caExpiryDate,
                    ROTCE: 8 + Math.random() * 15
                });
            }
            
            console.log(' Generating dummy data for Pipeline (Deals Pending Closure)...');
            
            // Add specific dummy data for Pipeline (Deals Pending Closure)
            // Criteria: No Origination_Date, Has Facility_First_Approval_Date (current year), NAM/LATAM only, non-PSE
            const pipelineProducts = ['Corporate Lending', 'Trade Finance', 'Working Capital', 'Project Finance', 'Asset Based Lending', 'Equipment Finance'];
            const pipelineFacilityTypes = ['Revolver', 'Term Loan', 'Bridge Loan', 'LOC', 'Guarantee', 'SBLC'];
            const pipelineUnderwriters = ['John Smith', 'Sarah Johnson', 'David Lee', 'Carlos Rodriguez', 'Robert Brown', 'Maria Garcia', 'Michael Chen', 'Jennifer Martinez', 'James Wilson', 'Patricia Anderson'];
            const pipelineRegions = ['NAM', 'LATAM'];
            const pipelineRelationships = ['TechCorp Industries', 'Global Manufacturing', 'Energy Solutions Inc', 'Retail Holdings LLC', 'Healthcare Systems', 'Financial Services Co', 'Transportation Group', 'Construction Partners', 'Telecom Networks', 'Food & Beverage Corp'];
            
            // Create 45 pending deals for better pagination testing
            for (let i = 1; i <= 45; i++) {
                const region = pipelineRegions[i % pipelineRegions.length];
                const productProgram = pipelineProducts[i % pipelineProducts.length];
                const facilityType = pipelineFacilityTypes[i % pipelineFacilityTypes.length];
                const underwriter = pipelineUnderwriters[i % pipelineUnderwriters.length];
                const relationship = pipelineRelationships[i % pipelineRelationships.length];
                const baseAmount = (i * 1500000) + (Math.random() * 10000000); // Vary amounts more
                
                // Create approval dates throughout current year with different aging buckets
                // Distribute across: 1-30 days (25%), 31-60 days (25%), 61-90 days (25%), >90 days (25%)
                let daysOld;
                if (i % 4 === 0) {
                    daysOld = Math.floor(Math.random() * 30) + 1; // 1-30 days
                } else if (i % 4 === 1) {
                    daysOld = Math.floor(Math.random() * 30) + 31; // 31-60 days
                } else if (i % 4 === 2) {
                    daysOld = Math.floor(Math.random() * 30) + 61; // 61-90 days
                } else {
                    daysOld = Math.floor(Math.random() * 90) + 91; // 91-180 days
                }
                
                // Calculate approval date based on daysOld (using current year)
                const today = new Date(); // Use actual current date
                today.setHours(0, 0, 0, 0);
                const approvalDate = new Date(today);
                approvalDate.setDate(approvalDate.getDate() - daysOld);
                const facilityFirstApprovalDate = approvalDate.toISOString().split('T')[0];
                
                // Future maturity dates (not expiring/expired)
                const futureYear = 2026 + (i % 2);
                const futureMonth = Math.floor(Math.random() * 12);
                const expiryDate = new Date(futureYear, futureMonth, Math.floor(Math.random() * 28) + 1).toISOString().split('T')[0];
                const caExpiryDate = new Date(futureYear, futureMonth, Math.floor(Math.random() * 28) + 1).toISOString().split('T')[0];
                
                // Alternate Management_Status: ~50% DM, ~50% CM
                const managementStatus = i % 2 === 0 ? 'DM' : 'CM';
                
                portfolioData.push({
                    Report_Date: new Date().toISOString().split('T')[0], // Use current date
                    Region: region,
                    Origination_Unit: orginationUnits[i % orginationUnits.length],
                    Underwriting_Team_Lead: underwriter,
                    Lead_Underwriter: underwriter,
                    Product_Underwriter: pipelineUnderwriters[(i + 1) % pipelineUnderwriters.length],
                    Relationship_ID: 'PIPELINE_REL' + i.toString().padStart(3, '0'),
                    Relationship_Name: `${relationship} - ${region}`,
                    Borrowers_Name: relationship,
                    CA_Number: 'PIPELINECA' + new Date().getFullYear() + i.toString().padStart(3, '0'),
                    Facility_ID: 'PIPELINEFAC' + new Date().getFullYear() + i.toString().padStart(3, '0'),
                    Facility_Number: 'PF' + i.toString().padStart(3, '0'),
                    Product_Program: productProgram,
                    Product_Program_Name: productProgram,
                    Facility_Type: facilityType,
                    Fac_Amount: baseAmount,
                    Facility_Amount: baseAmount,
                    OSUC: baseAmount * 0.05, // Very low OSUC (deal is pending)
                    Total_OS: baseAmount * 0.02, // Very low outstanding (deal is pending)
                    Unused_Commitment: baseAmount * 0.98,
                    Credit_Classification: creditClass[i % creditClass.length],
                    Management_Status: managementStatus, // 50% DM, 50% CM for testing filter
                    'DM/CM': managementStatus, // Also add alternative field name
                    CA_Review: region === 'EMEA' ? 'No' : '',
                    'PSE_non-PSE': 'non-PSE', // Must be non-PSE for pipeline
                    PSE_non_PSE: 'non-PSE',
                    Commitment_Type: 'Committed',
                    Committed_Uncommitted: 'COMMITTED',
                    Maturity_Date: expiryDate,
                    Origination_Date: '', // EMPTY - this is the key criteria for pending closure
                    Facility_First_Approval_Date: facilityFirstApprovalDate, // Has approval date in current year
                    CA_Expiry_Date: caExpiryDate,
                    CA_Expiration_Date: caExpiryDate,
                    ROTCE: 12 + Math.random() * 8
                });
            }
            
            console.log(' Generated 45 Pipeline (Deals Pending Closure) dummy records with DM/CM distribution');
            const samplePipelineDeal = portfolioData.filter(d => d.Facility_ID && d.Facility_ID.startsWith('PIPELINEFAC'))[0];
            console.log(' Sample pipeline deal:', {
                Facility_ID: samplePipelineDeal?.Facility_ID,
                Management_Status: samplePipelineDeal?.Management_Status,
                'DM/CM': samplePipelineDeal?.['DM/CM'],
                Origination_Date: samplePipelineDeal?.Origination_Date,
                Facility_First_Approval_Date: samplePipelineDeal?.Facility_First_Approval_Date,
                Region: samplePipelineDeal?.Region,
                Report_Date: samplePipelineDeal?.Report_Date
            });
            const pipelineDeals = portfolioData.filter(d => d.Facility_ID && d.Facility_ID.startsWith('PIPELINEFAC'));
            const dmCount = pipelineDeals.filter(d => d.Management_Status === 'DM').length;
            const cmCount = pipelineDeals.filter(d => d.Management_Status === 'CM').length;
            console.log(` Pipeline DM/CM Distribution: DM=${dmCount}, CM=${cmCount}`);
            console.log(` Current Year: ${new Date().getFullYear()}, Sample Approval Year: ${new Date(samplePipelineDeal?.Facility_First_Approval_Date).getFullYear()}`);
            
            // Add covenants data (100 covenant records with better distribution)
            covenantsData = [];
            for (let i = 1; i <= 100; i++) {
                const region = regions[i % regions.length];
                // Better distribution: 40% Past Due, 60% Coming Due
                const isPastDue = i % 5 < 2;
                const daysOverdue = isPastDue ? Math.floor(Math.random() * 120) + 1 : 0;
                
                let category = '';
                if (isPastDue) {
                    if (daysOverdue <= 45) category = '1-45 Days';
                    else if (daysOverdue <= 60) category = '46-60 Days';
                    else if (daysOverdue <= 90) category = '61-90 Days';
                    else category = '90+ Days';
                } else {
                    category = 'Coming Due';
                }
                
                const dueDate = isPastDue 
                    ? new Date(2024, 10, 30 - daysOverdue)
                    : new Date(2024, 11, 15 + (i % 30));
                
                // Periodic frequencies that match your data
                const periodicFrequencies = ['One-Time', 'Monthly', 'Quarterly', 'Semi-Annual', 'Annual'];
                const periodicFreq = periodicFrequencies[i % periodicFrequencies.length];
                
                // Calculate 45 days past due date
                const days45PastDue = isPastDue && daysOverdue > 45 
                    ? new Date(2024, 10, 30 - (daysOverdue - 45)).toISOString().split('T')[0]
                    : null;
                
                covenantsData.push({
                    Report_Date: '2024-11-30',
                    Region: region,
                    Origination_Unit: orginationUnits[i % orginationUnits.length],
                    Underwriting_Team_Lead: underwriters[i % underwriters.length],
                    Lead_Underwriter: underwriters[i % underwriters.length],
                    Product_Underwriter: underwriters[(i + 1) % underwriters.length],
                    OU_Expense_Code: 'OU' + (i % 10 + 1).toString().padStart(3, '0'),
                    CU_Expense_Code: 'CU' + (i % 10 + 1).toString().padStart(3, '0'),
                    Relationship_ID: 'REL' + (i % 50 + 1).toString().padStart(3, '0'),
                    Relationship_Name: `${region} Company ${i % 50 + 1}`,
                    Borrowers_Name: `Borrower ${i}`,
                    CA_Number: 'CA2024' + (i % 50 + 1).toString().padStart(3, '0'),
                    Facility_Number: 'F' + (i % 50 + 1).toString().padStart(3, '0'),
                    Product_Program_Name: productPrograms[i % productPrograms.length],
                    Facility_Type: facilityTypes[i % facilityTypes.length],
                    Covenant_Number: 'COV2024' + i.toString().padStart(3, '0'),
                    Periodic_Frequency: periodicFreq,
                    Covenant_Due_Date: dueDate.toISOString().split('T')[0],
                    Covenant_Deferred_Date: i % 10 === 0 ? new Date(2024, 11, 30).toISOString().split('T')[0] : null,
                    Days_Past_Due: daysOverdue,
                    Coming_Due_Past_Due: isPastDue ? 'Past Due' : 'Coming Due',
                    Past_Due_Category: category,
                    Covenant_Description: `Financial covenant ${i} - ${i % 3 === 0 ? 'Debt Service Coverage' : i % 3 === 1 ? 'Leverage Ratio' : 'Current Ratio'}`,
                    Covenant_Remarks: isPastDue ? 'Follow up required' : 'On track',
                    '45_Days_Past_Due_Date': days45PastDue,
                    Control_Unit: orginationUnits[i % orginationUnits.length]
                });
            }
            window.covenantsData = covenantsData; // Ensure global access
            console.log(' Generated', covenantsData.length, 'covenant records with new fields');
            
            // Add covenants data for LAST WEEK (for variance comparison) - 95 records (5 were resolved)
            covenantsDataLW = [];
            for (let i = 1; i <= 95; i++) {
                const region = regions[i % regions.length];
                // Last week distribution: 38% Past Due, 62% Coming Due (slightly different)
                const isPastDue = i % 5 < 2;
                const daysOverdue = isPastDue ? Math.floor(Math.random() * 110) + 1 : 0;
                
                let category = '';
                if (isPastDue) {
                    if (daysOverdue <= 45) category = '1-45 Days';
                    else if (daysOverdue <= 60) category = '46-60 Days';
                    else if (daysOverdue <= 90) category = '61-90 Days';
                    else category = '90+ Days';
                } else {
                    category = 'Coming Due';
                }
                
                const dueDate = isPastDue 
                    ? new Date(2024, 10, 23 - daysOverdue)
                    : new Date(2024, 11, 8 + (i % 30));
                
                const periodicFrequencies = ['One-Time', 'Monthly', 'Quarterly', 'Semi-Annual', 'Annual'];
                const periodicFreq = periodicFrequencies[i % periodicFrequencies.length];
                
                const days45PastDue = isPastDue && daysOverdue > 45 
                    ? new Date(2024, 10, 23 - (daysOverdue - 45)).toISOString().split('T')[0]
                    : null;
                
                covenantsDataLW.push({
                    Report_Date: '2024-11-23', // Last week
                    Region: region,
                    Origination_Unit: orginationUnits[i % orginationUnits.length],
                    Underwriting_Team_Lead: underwriters[i % underwriters.length],
                    Lead_Underwriter: underwriters[i % underwriters.length],
                    Product_Underwriter: underwriters[(i + 1) % underwriters.length],
                    OU_Expense_Code: 'OU' + (i % 10 + 1).toString().padStart(3, '0'),
                    CU_Expense_Code: 'CU' + (i % 10 + 1).toString().padStart(3, '0'),
                    Relationship_ID: 'REL' + (i % 50 + 1).toString().padStart(3, '0'),
                    Relationship_Name: `${region} Company ${i % 50 + 1}`,
                    Borrowers_Name: `Borrower ${i}`,
                    CA_Number: 'CA2024' + (i % 50 + 1).toString().padStart(3, '0'),
                    Facility_Number: 'F' + (i % 50 + 1).toString().padStart(3, '0'),
                    Product_Program_Name: productPrograms[i % productPrograms.length],
                    Facility_Type: facilityTypes[i % facilityTypes.length],
                    Covenant_Number: 'COV2024' + i.toString().padStart(3, '0'),
                    Periodic_Frequency: periodicFreq,
                    Covenant_Due_Date: dueDate.toISOString().split('T')[0],
                    Covenant_Deferred_Date: i % 10 === 0 ? new Date(2024, 11, 23).toISOString().split('T')[0] : null,
                    Days_Past_Due: daysOverdue,
                    Coming_Due_Past_Due: isPastDue ? 'Past Due' : 'Coming Due',
                    Past_Due_Category: category,
                    Covenant_Description: `Financial covenant ${i} - ${i % 3 === 0 ? 'Debt Service Coverage' : i % 3 === 1 ? 'Leverage Ratio' : 'Current Ratio'}`,
                    Covenant_Remarks: isPastDue ? 'Follow up required' : 'On track',
                    '45_Days_Past_Due_Date': days45PastDue,
                    Control_Unit: orginationUnits[i % orginationUnits.length]
                });
            }
            window.covenantsDataLW = covenantsDataLW;
            console.log(' Generated', covenantsDataLW.length, 'last week covenant records');
            
            // Add CCM data - Current Month (80 records with proper structure)
            ccmData = [];
            const classifications = ['PASS', 'SPECIAL MENTION', 'SUBSTANDARD', 'DOUBTFUL'];
            const frequencies = ['Annual', 'Semi-Annual', 'Quarterly'];
            const ccmStatuses = ['Completed', 'In Progress', 'Overdue', 'Pending'];
            
            for (let i = 1; i <= 80; i++) {
                const region = regions[i % regions.length];
                const statusIndex = i % 20;
                const classification = classifications[i % classifications.length];
                
                // Distribute statuses: 30% Past Due, 35% Coming Due, 35% Open
                let ccmStatus;
                if (statusIndex < 6) {
                    ccmStatus = 'Past Due';
                } else if (statusIndex < 13) {
                    ccmStatus = 'Coming Due';
                } else {
                    ccmStatus = 'Open';
                }
                
                // Next CCM dates based on status
                let nextMonthEnd, nextApproval;
                if (ccmStatus === 'Past Due') {
                    // Past due: dates in the past (Oct 2024 or earlier)
                    nextMonthEnd = new Date(2024, 8 + (i % 3), 0); // Aug-Oct 2024
                    nextApproval = new Date(2024, 8 + (i % 3), 15);
                } else if (ccmStatus === 'Coming Due') {
                    // Coming due: dates in Dec 2024
                    nextMonthEnd = new Date(2024, 11, 31); // Dec 31, 2024
                    nextApproval = new Date(2024, 11, 5 + (i % 20)); // Dec 5-25, 2024
                } else {
                    // Open: dates in future (Jan 2025 onwards)
                    nextMonthEnd = new Date(2025, (i % 12), 0);
                    nextApproval = new Date(2025, (i % 12), 15);
                }
                
                ccmData.push({
                    Report_Date: '2024-11-30',
                    Region: region,
                    Relationship_ID: 'REL' + (i % 50 + 1).toString().padStart(3, '0'),
                    Client_Name: `${region} Client ${i}`,
                    Classification: classification,
                    Frequency: frequencies[i % frequencies.length],
                    Underwriter: underwriters[i % underwriters.length],
                    Next_CCM_Month_End: nextMonthEnd.toISOString().split('T')[0],
                    Next_CCM_Approval_Date: nextApproval.toISOString().split('T')[0],
                    CCM_Status: ccmStatus
                });
            }
            window.ccmData = ccmData;
            
            // Add CCM data - Previous Month (75 records for variance comparison)
            ccmDataPrevious = [];
            for (let i = 1; i <= 75; i++) {
                const region = regions[i % regions.length];
                const statusIndex = i % 20;
                const classification = classifications[i % classifications.length];
                
                // Distribute statuses similarly but with slight variations
                let ccmStatus;
                if (statusIndex < 5) {
                    ccmStatus = 'Past Due';
                } else if (statusIndex < 12) {
                    ccmStatus = 'Coming Due';
                } else {
                    ccmStatus = 'Open';
                }
                
                let nextMonthEnd, nextApproval;
                if (ccmStatus === 'Past Due') {
                    nextMonthEnd = new Date(2024, 7 + (i % 3), 0); // Jul-Sep 2024
                    nextApproval = new Date(2024, 7 + (i % 3), 15);
                } else if (ccmStatus === 'Coming Due') {
                    nextMonthEnd = new Date(2024, 10, 30); // Nov 30, 2024
                    nextApproval = new Date(2024, 10, 5 + (i % 20));
                } else {
                    nextMonthEnd = new Date(2024, 11 + (i % 12), 0);
                    nextApproval = new Date(2024, 11 + (i % 12), 15);
                }
                
                ccmDataPrevious.push({
                    Report_Date: '2024-10-31',
                    Region: region,
                    Relationship_ID: 'REL' + (i % 50 + 1).toString().padStart(3, '0'),
                    Client_Name: `${region} Client ${i}`,
                    Classification: classifications[(i + 1) % classifications.length], // Slight variation
                    Frequency: frequencies[i % frequencies.length],
                    Underwriter: underwriters[i % underwriters.length],
                    Next_CCM_Month_End: nextMonthEnd.toISOString().split('T')[0],
                    Next_CCM_Approval_Date: nextApproval.toISOString().split('T')[0],
                    CCM_Status: ccmStatus
                });
            }
            window.ccmDataPrevious = ccmDataPrevious;
            
            console.log(' Generated comprehensive dummy data:');
            console.log(`   - ${portfolioData.length} portfolio records`);
            console.log(`   - ${covenantsData.length} covenant records (this week)`);
            console.log(`   - ${covenantsDataLW.length} covenant records (last week)`);
            console.log(`   - ${ccmData.length} CCM records (current month)`);
            console.log(`   - ${ccmDataPrevious.length} CCM records (previous month)`);
            
            // Log sample of Facility_First_Approval_Date by region
            const facilityApprovalSample = portfolioData.slice(0, 4).map(row => ({
                region: row.Region,
                facilityId: row.Facility_ID,
                approvalDate: row.Facility_First_Approval_Date
            }));
            console.log(' Facility_First_Approval_Date sample:', facilityApprovalSample);
        }
        // ===== END DUMMY DATA =====

        let expirationChartInstance = null;
        let searchDebounceTimer = null;
        let relationshipChartInstance = null;
        let facilityTrendChartInstance = null; // Store facility trend chart instance
        let facilityMaturityChartInstance = null; // Store facility maturity chart instance
        let newFacilitiesApprovedChartInstance = null; // Store New Facilities Approved chart instance
        let rotceChartInstance = null; // Store ROTCE chart instance
        let updateBarChartTimer = null; // Debounce timer for bar chart updates
        let activeFilters = {};
        let selectedMetricType = "facilityAmount"; // Default to Facility Amount
        
        // Smart Filter States
        let selectedRegion = "all"; // all, APAC, EMEA, LATAM, NAM
        let selectedPSE = "all"; // all, PSE, non-PSE
        let selectedStatus = "all"; // all, CM, DM
        let selectedCommitmentStatus = "all"; // all, Committed, Uncommitted
        let selectedAmountType = "osuc"; // direct, contingent, pse, osuc, tfa (for metrics)
        let selectedPeriod = "current"; // current, previous (for New Facilities Approved  chart)
        let selectedSearchTerm = ""; // Global search filter
        
        // Chart View States
        let currentCovenantViewType = "pastDue"; // pastDue, comingDue
        window.currentCovenantViewType = currentCovenantViewType; // Make it globally accessible
        let currentCCMViewType = "pastDue"; // pastDue, comingDue, open
        
        // Reporting Month (derived from max Report_Date in data)
        let reportingMonth = null; // Will be set after data loads
        
        // Get the reporting month from portfolio data (max Report_Date)
        function getReportingMonth() {
            if (reportingMonth) return reportingMonth;
            
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
            if (!dataSource || dataSource.length === 0) {
                // Fallback to current date if no data
                return new Date();
            }
            
            // Get max Report_Date from data
            const reportDates = dataSource
                .map(row => parseDate(row.Report_Date))
                .filter(d => d !== null);
            
            if (reportDates.length === 0) {
                return new Date();
            }
            
            reportingMonth = new Date(Math.max(...reportDates));
            console.log(' Reporting Month set to:', reportingMonth.toLocaleDateString());
            return reportingMonth;
        }
        
        // Get reporting month start and end dates
        function getReportingMonthRange() {
            const repMonth = getReportingMonth();
            const monthStart = new Date(repMonth.getFullYear(), repMonth.getMonth(), 1);
            monthStart.setHours(0, 0, 0, 0);
            const monthEnd = new Date(repMonth.getFullYear(), repMonth.getMonth() + 1, 0);
            monthEnd.setHours(23, 59, 59, 999);
            return { monthStart, monthEnd, reportingMonth: repMonth };
        }

        // Cross-filtering state management
        let chartFilter = {
            active: false,
            type: null, // 'relationship', 'region', 'product', 'facilityType', etc.
            value: null, // The clicked value (e.g., relationship name, region name, etc.)
            label: null, // Display label for UI
        };
        
        // Performance optimization: Cache for expensive calculations
        let metricsCache = {
            full: null,
            filtered: null,
            filterHash: "",
        };
        let indexCache = {
            byRegion: null,
            byProduct: null,
            byRelationship: null,
            dates: null,
        };

        // ============================================

        // Initialize on page load
        document.addEventListener("DOMContentLoaded", function () {
            console.log("=== Portfolio Analytics Dashboard ===");
            
            // Initialize search functionality
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                // Handle Enter key press
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleMainSearch(this.value);
                    }
                });
                
                // Handle input changes (detect when text is cleared/changed)
                let searchDebounceTimer = null;
                searchInput.addEventListener('input', function(e) {
                    // Clear previous timer
                    if (searchDebounceTimer) {
                        clearTimeout(searchDebounceTimer);
                    }
                    
                    // Debounce to avoid too many updates while typing
                    searchDebounceTimer = setTimeout(() => {
                        const currentValue = this.value.trim();
                        // If search box is cleared or value changed significantly
                        if (currentValue === '' && selectedSearchTerm !== '') {
                            // Search was cleared
                            handleMainSearch('');
                        }
                    }, 300); // 300ms debounce
                });
            }
            
            // Check if dummy data is enabled
            if (ENABLE_DUMMY_DATA && portfolioData.length > 0) {
                console.log(" DUMMY DATA MODE - Using test data");
                console.log("Records loaded:", portfolioData.length);
                console.log("=====================================");
                
                // Initialize with dummy data immediately
                setTimeout(() => {
                    // Build indexes for dummy data
                    buildIndexes();
                    
                    // Populate filter options
                    populateFilterOptions();
                    
                    // Calculate metrics and create charts
                    calculateMetrics();
                    createFacilityTrendChart();
                    createRelationshipChart();
                    createNewFacilitiesApprovedChart();
                    createROTCEChart();
                    
                    // Initialize covenant and CCM charts
                    populateCovenantMonitoringData();
                    createCovenantMonitoringChart('pastDue');
                    updateCovenantRegionalTable('pastDue');
                    calculateCCMStats();
                    createCCMRegionalChart();
                    
                    // Initial filter
                    filterData();
                    
                    showNotification(
                        "Success",
                        `Loaded ${portfolioData.length} dummy records for testing`,
                        "success"
                    );
                }, 100);
            } else {
                console.log("READ-ONLY mode - Loading data from Confluence");
                console.log("Page ID:", CONFLUENCE_PAGE_ID);
                console.log("File:", CONFLUENCE_FILE_NAME);
                console.log("=====================================");
                
                // Show loading overlay immediately
                showLoadingOverlay("Loading Portfolio Data...");
                
                // Load actual data from Confluence
                loadDataFromCSV();
            }
            
            // Verify all required libraries are loaded
            if (typeof ApexCharts === "undefined") {
                console.error(
                    " ApexCharts library not loaded! Charts will not work."
                );
                showNotification(
                    "Error",
                    "ApexCharts library failed to load. Please refresh the page.",
                    "error"
                );
            } else {
                console.log(" ApexCharts library loaded successfully");
            }

            if (typeof XLSX === "undefined") {
                console.warn(
                    "  XLSX library not loaded. Excel file parsing may not work."
                );
            } else {
                console.log(" XLSX library loaded successfully");
            }
            
            // Setup search functionality with debouncing (increased for large datasets)
            document
                .getElementById("searchInput")
                .addEventListener("input", function () {
                // Clear previous timer
                if (searchDebounceTimer) {
                    clearTimeout(searchDebounceTimer);
                }
                
                // Set new timer - wait 500ms after user stops typing (longer for 40K rows)
                searchDebounceTimer = setTimeout(() => {
                    filterData();
                }, 500);
            });
        });

        // Refresh data from Confluence (read-only, no write operations)
        async function refreshData() {
            try {
                console.log("Refreshing data from Confluence...");
                const data = await fetchDataFromConfluence();
                
                if (data && data.length > 0) {
                    portfolioData = data;
                    
                    // Clear all caches
                    metricsCache = { full: null, filtered: null, filterHash: "" };
                    indexCache = {
                        byRegion: null,
                        byProduct: null,
                        byRelationship: null,
                        dates: null,
                    };
                    
                    // Rebuild indexes
                    buildIndexes();
                    
                    // Repopulate filter options with fresh data
                    populateFilterOptions();
                    
                    // Recalculate all metrics and charts
                    calculateMetrics();
                    createFacilityTrendChart();
                    createRelationshipChart();
                    createNewFacilitiesApprovedChart();
                    createROTCEChart();
                    
                    // Reset filters and reload data
                    activeFilters = {};
                    displayFilterBadges();
                    updateFilterCount();
                    filterData();
                    
                    showNotification(
                        "Success",
                        `Refreshed ${data.length.toLocaleString()} records successfully`,
                        "success"
                    );
                } else {
                    console.error("No data received from Confluence");
                    showNotification(
                        "Error",
                        "Failed to refresh data from Confluence",
                        "error"
                    );
                }
            } catch (error) {
                console.error("Error refreshing data:", error);
                showNotification(
                    "Error",
                    "Failed to refresh data: " + error.message,
                    "error"
                );
            }
        }

        // Load data from Confluence attachment (read-only)
        async function loadDataFromCSV() {
            console.log(' ========== loadDataFromCSV STARTED ==========');
            const loadStartTime = performance.now();
            
            console.log(' Confluence Configuration:', {
                BASE_URL: CONFLUENCE_BASE_URL,
                PAGE_ID: CONFLUENCE_PAGE_ID,
                FILE_NAME: CONFLUENCE_FILE_NAME,
                COVENANTS_FILE: CONFLUENCE_COVENANTS_FILE,
                CCM_FILE: CONFLUENCE_CCM_FILE
            });
            
            showLoadingOverlay("Loading Portfolio Data...");
            
            try {
                console.log(' Inside try block, starting data load...');
                // Start loading covenant and CCM data in parallel (they're smaller files)
                showLoadingOverlay("Fetching portfolio records...");
                
                const covenantDataPromise = fetchCovenantsFromConfluence();
                const covenantDataLWPromise = fetchCovenantsLWFromConfluence();
                const ccmDataPromise = fetchCCMFromConfluence();
                const ccmDataPreviousPromise = fetchCCMPreviousFromConfluence();
                
                // Load portfolio data (largest file)
                showLoadingOverlay(
                    "Loading Portfolio Data",
                    "Processing portfolio records..."
                );
                
                const data = await fetchDataFromConfluence();
                
                if (data && data.length > 0) {
                    portfolioData = data;
                    console.log(` Loaded ${data.length} portfolio records`);
                    
                    // Reset reporting month to recalculate from new data
                    reportingMonth = null;
                    const repMonth = getReportingMonth();
                    console.log(` Reporting Month: ${repMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`);
                    
                    showLoadingOverlay(`Loading ${data.length.toLocaleString()} portfolio records...`);
                    
                    // Wait for covenant data
                    showLoadingOverlay("Fetching covenant records...");
                    
                    const covenantResult = await covenantDataPromise;
                    if (covenantResult && covenantResult.length > 0) {
                        covenantsData = covenantResult;
                        window.covenantsData = covenantResult; // Ensure global access for expanded modals
                        console.log(` Loaded ${covenantResult.length} covenant records`);
                    } else {
                        console.warn(` No covenant data loaded from ${CONFLUENCE_COVENANTS_FILE}`);
                        covenantsData = [];
                        window.covenantsData = [];
                    }
                    
                    // Load last week covenants
                    const covenantResultLW = await covenantDataLWPromise;
                    if (covenantResultLW && covenantResultLW.length > 0) {
                        covenantsDataLW = covenantResultLW;
                        window.covenantsDataLW = covenantResultLW;
                        console.log(` Loaded ${covenantResultLW.length} last week covenant records`);
                    } else {
                        console.warn(` No last week covenant data loaded from ${CONFLUENCE_COVENANTS_LW_FILE}`);
                        covenantsDataLW = [];
                        window.covenantsDataLW = [];
                    }
                    
                    showLoadingOverlay(`Loading ${covenantsData.length.toLocaleString()} covenants...`);
                    
                    // Wait for CCM data
                    showLoadingOverlay("Fetching CCM records...");
                    
                    const ccmResult = await ccmDataPromise;
                    if (ccmResult && ccmResult.length > 0) {
                        ccmData = ccmResult;
                        window.ccmData = ccmResult; // Ensure global access for expanded modals
                        console.log(` Loaded ${ccmResult.length} CCM records`);
                    } else {
                        console.warn(` No CCM data loaded from ${CONFLUENCE_CCM_FILE}`);
                        ccmData = [];
                        window.ccmData = [];
                    }
                    
                    // Load previous month CCM
                    const ccmResultPrevious = await ccmDataPreviousPromise;
                    if (ccmResultPrevious && ccmResultPrevious.length > 0) {
                        ccmDataPrevious = ccmResultPrevious;
                        window.ccmDataPrevious = ccmResultPrevious;
                        console.log(` Loaded ${ccmResultPrevious.length} previous month CCM records`);
                    } else {
                        console.warn(` No previous month CCM data loaded from ${CONFLUENCE_CCM_PREVIOUS_FILE}`);
                        ccmDataPrevious = [];
                        window.ccmDataPrevious = [];
                    }
                    
                    showLoadingOverlay(`Loading ${ccmData.length.toLocaleString()} CCM records...`);
                    
                    showLoadingOverlay("Building charts and metrics...");
                    
                    // Use setTimeout to allow UI to update before heavy processing
                    setTimeout(() => {
                        showLoadingOverlay("Calculating metrics...");
                        
                        setTimeout(() => {
                            showLoadingOverlay("Almost ready...");
                            
                            // Initialize dashboard with data
                            buildIndexes();
                            populateFilterOptions();
                            
                            // Initialize filteredData with all data (no filters applied initially)
                            filterData();
                            
                            calculateMetrics();
                            updateReportDate(); // Update "Last Updated" display
                            
                            // Create all main charts
                            createFacilityTrendChart();
                            createRelationshipChart();
                            createNewFacilitiesApprovedChart();
                            createROTCEChart();
                            
                            // Initialize covenant and CCM charts
                            populateCovenantMonitoringData();
                            createCovenantMonitoringChart('pastDue');
                            updateCovenantRegionalTable('pastDue');
                            calculateCCMStats();
                            createCCMRegionalChart();
                            updateCCMStats('pastDue');
                            
                            const loadTime = ((performance.now() - loadStartTime) / 1000).toFixed(1);
                            
                            showLoadingOverlay("Dashboard Ready!");
                            
                            setTimeout(() => {
                        hideLoadingOverlay();
                                
                        showNotification(
                            "Success",
                                    `Loaded ${data.length.toLocaleString()} records in ${loadTime}s`,
                            "success"
                        );
                                
                                console.log(` Dashboard loaded in ${loadTime}s`);
                            }, 300);
                        }, 50);
                    }, 100);
                } else {
                    console.error("No data from Confluence");
                    hideLoadingOverlay();
                    showNotification(
                        "Error",
                        "No data found in Confluence attachment",
                        "error"
                    );
                }
            } catch (error) {
                console.error(" ========== ERROR LOADING DATA ==========");
                console.error(" Error loading data from Confluence:", error);
                console.error(" Error message:", error.message);
                console.error(" Error stack:", error.stack);
                console.error(" Error name:", error.name);
                console.error(" ==========================================");
                
                hideLoadingOverlay();
                showNotification(
                    "Error",
                    "Failed to load data from Confluence: " + error.message,
                    "error"
                );
            }
        }

        // Fetch data from Confluence attachment (read-only, no updates)
        async function fetchDataFromConfluence() {
            try {
                console.log(' Starting fetchDataFromConfluence...');
                // Construct Confluence API URL
                const url = `${CONFLUENCE_BASE_URL}/download/attachments/${CONFLUENCE_PAGE_ID}/${CONFLUENCE_FILE_NAME}?api=v2`;
                
                console.log(" Fetching portfolio data from Confluence:", url);
                console.log(" File name:", CONFLUENCE_FILE_NAME);
                console.log(" Page ID:", CONFLUENCE_PAGE_ID);
                
                const response = await fetch(url, {
                    headers: {
                        "X-Atlassian-Token": "no-check",
                    },
                });
                
                console.log(' Response received. Status:', response.status, response.statusText);

                if (!response.ok) {
                    const errorMsg = `Failed to fetch ${CONFLUENCE_FILE_NAME}: ${response.status} ${response.statusText}`;
                    console.error('', errorMsg);
                    throw new Error(errorMsg);
                }

                console.log(" Successfully fetched file from Confluence");
                const blob = await response.blob();
                console.log(" Blob size:", blob.size, "bytes");
                
                // Parse based on file type with progress updates (10-40% range)
                let portfolioProgressStart = 10;
                let portfolioProgressEnd = 40;
                const progressCallback = (msg, percent = null) => {
                    let finalPercent = null;
                    if (percent !== null) {
                        // Map the percent to the portfolio loading range (15-40%)
                        finalPercent = Math.round(portfolioProgressStart + (percent / 100) * (portfolioProgressEnd - portfolioProgressStart));
                    }
                    showLoadingOverlay(msg);
                };
                
                if (CONFLUENCE_FILE_NAME.endsWith(".csv")) {
                    console.log("Parsing CSV file...");
                    return await parseCSVBlob(blob);
                } else if (
                    CONFLUENCE_FILE_NAME.endsWith(".xlsx") ||
                    CONFLUENCE_FILE_NAME.endsWith(".xls")
                ) {
                    console.log("Parsing Excel file (this may take a moment for large files)...");
                    progressCallback("Preparing to parse Excel...");
                    return await parseExcelBlob(blob, progressCallback);
                }
                
                throw new Error(
                    "Unsupported file format. Please use .csv, .xlsx, or .xls files."
                );
            } catch (error) {
                console.error(" Error fetching portfolio data from Confluence:", error.message);
                console.error(" Full error:", error);
                return null;
            }
        }

        // Fetch covenant data from Confluence attachment (separate file)
        async function fetchCovenantsFromConfluence() {
            try {
                // Construct Confluence API URL for covenants file
                const url = `${CONFLUENCE_BASE_URL}/download/attachments/${CONFLUENCE_PAGE_ID}/${CONFLUENCE_COVENANTS_FILE}?api=v2`;
                
                console.log("Fetching covenant data from Confluence:", url);
                console.log("Covenants file name:", CONFLUENCE_COVENANTS_FILE);
                
                const response = await fetch(url, {
                    headers: {
                        "X-Atlassian-Token": "no-check",
                    },
                });

                if (!response.ok) {
                    console.warn(
                        `Failed to fetch ${CONFLUENCE_COVENANTS_FILE}: ${response.status} ${response.statusText}. Covenants will not be available.`
                    );
                    return null;
                }

                console.log("Successfully fetched covenant file from Confluence");
                const blob = await response.blob();
                console.log("Covenant blob size:", blob.size, "bytes");
                
                // Parse Excel file (covenants are in .xlsx format)
                if (CONFLUENCE_COVENANTS_FILE.endsWith(".xlsx") || CONFLUENCE_COVENANTS_FILE.endsWith(".xls")) {
                    console.log("Parsing covenant Excel file...");
                    return await parseCovenantExcelBlob(blob);
                }
                
                throw new Error("Covenant file must be .xlsx or .xls format");
            } catch (error) {
                console.error("Error fetching covenant data from Confluence:", error.message);
                return null;
            }
        }

        // Parse Covenant Excel blob (separate parser for covenant files)
        async function parseCovenantExcelBlob(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        
                        const workbook = XLSX.read(data, { 
                            type: "array",
                            cellDates: true,
                            cellNF: false,
                            cellText: false,
                        });
                        
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        
                        console.log(" Covenant Excel Sheet Name:", workbook.SheetNames[0]);
                        
                        // Convert sheet to JSON
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
                            raw: false,
                            dateNF: "yyyy-mm-dd",
                        });
                        
                        console.log(` Total covenant rows in Excel: ${jsonData.length}`);
                        
                        // Don't filter by Facility_ID - covenants might use different key fields
                        // Filter out completely empty rows
                        const filteredData = jsonData.filter((row) => {
                            // Keep row if it has any non-empty values
                            return Object.values(row).some(val => val !== null && val !== undefined && val !== '');
                        });
                        
                        console.log(` Parsed ${filteredData.length} valid covenant records from Excel`);
                        
                        // Log data structure for debugging
                        if (filteredData.length > 0) {
                            console.log(" Covenant record fields:", Object.keys(filteredData[0]));
                            console.log(" Sample covenant record:", filteredData[0]);
                        }
                        
                        resolve(filteredData);
                    } catch (error) {
                        console.error("Error parsing covenant Excel:", error);
                        reject(error);
                    }
                };
                reader.onerror = function (error) {
                    console.error("FileReader error:", error);
                    reject(error);
                };
                reader.readAsArrayBuffer(blob);
            });
        }

        // Fetch CCM data from Confluence
        async function fetchCCMFromConfluence() {
            try {
                // Construct Confluence API URL for CCM file
                const url = `${CONFLUENCE_BASE_URL}/download/attachments/${CONFLUENCE_PAGE_ID}/${CONFLUENCE_CCM_FILE}?api=v2`;
                
                console.log("Fetching CCM data from Confluence:", url);
                console.log("CCM file name:", CONFLUENCE_CCM_FILE);
                
                const response = await fetch(url, {
                    headers: {
                        "X-Atlassian-Token": "no-check",
                    },
                });

                if (!response.ok) {
                    console.warn(
                        `Failed to fetch ${CONFLUENCE_CCM_FILE}: ${response.status} ${response.statusText}. CCM data will not be available.`
                    );
                    return null;
                }

                console.log("Successfully fetched CCM file from Confluence");
                const blob = await response.blob();
                console.log("CCM blob size:", blob.size, "bytes");
                
                // Parse Excel file (CCM is in .xlsx format)
                if (CONFLUENCE_CCM_FILE.endsWith(".xlsx") || CONFLUENCE_CCM_FILE.endsWith(".xls")) {
                    console.log("Parsing CCM Excel file...");
                    return await parseCCMExcelBlob(blob);
                }
                
                throw new Error("CCM file must be .xlsx or .xls format");
            } catch (error) {
                console.error("Error fetching CCM data from Confluence:", error.message);
                return null;
            }
        }

        // Fetch last week covenants from Confluence
        async function fetchCovenantsLWFromConfluence() {
            try {
                const url = `${CONFLUENCE_BASE_URL}/download/attachments/${CONFLUENCE_PAGE_ID}/${CONFLUENCE_COVENANTS_LW_FILE}?api=v2`;
                
                console.log("Fetching last week covenants data from Confluence:", url);
                
                const response = await fetch(url, {
                    headers: {
                        "X-Atlassian-Token": "no-check",
                    },
                });

                if (!response.ok) {
                    console.warn(
                        `Failed to fetch ${CONFLUENCE_COVENANTS_LW_FILE}: ${response.status} ${response.statusText}. Last week covenants data will not be available.`
                    );
                    return null;
                }

                console.log("Successfully fetched last week covenants file from Confluence");
                const blob = await response.blob();
                
                if (CONFLUENCE_COVENANTS_LW_FILE.endsWith(".xlsx") || CONFLUENCE_COVENANTS_LW_FILE.endsWith(".xls")) {
                    console.log("Parsing last week covenants Excel file...");
                    return await parseCovenantExcelBlob(blob);
                }
                
                throw new Error("Covenants file must be .xlsx or .xls format");
            } catch (error) {
                console.error("Error fetching last week covenants data from Confluence:", error.message);
                return null;
            }
        }

        // Fetch previous month CCM from Confluence
        async function fetchCCMPreviousFromConfluence() {
            try {
                const url = `${CONFLUENCE_BASE_URL}/download/attachments/${CONFLUENCE_PAGE_ID}/${CONFLUENCE_CCM_PREVIOUS_FILE}?api=v2`;
                
                console.log("Fetching previous month CCM data from Confluence:", url);
                
                const response = await fetch(url, {
                    headers: {
                        "X-Atlassian-Token": "no-check",
                    },
                });

                if (!response.ok) {
                    console.warn(
                        `Failed to fetch ${CONFLUENCE_CCM_PREVIOUS_FILE}: ${response.status} ${response.statusText}. Previous month CCM data will not be available.`
                    );
                    return null;
                }

                console.log("Successfully fetched previous month CCM file from Confluence");
                const blob = await response.blob();
                
                if (CONFLUENCE_CCM_PREVIOUS_FILE.endsWith(".xlsx") || CONFLUENCE_CCM_PREVIOUS_FILE.endsWith(".xls")) {
                    console.log("Parsing previous month CCM Excel file...");
                    return await parseCCMExcelBlob(blob);
                }
                
                throw new Error("CCM file must be .xlsx or .xls format");
            } catch (error) {
                console.error("Error fetching previous month CCM data from Confluence:", error.message);
                return null;
            }
        }

        // Parse CCM Excel blob
        async function parseCCMExcelBlob(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        
                        const workbook = XLSX.read(data, { 
                            type: "array",
                            cellDates: true,
                            cellNF: false,
                            cellText: false,
                        });
                        
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        
                        console.log(" CCM Excel Sheet Name:", workbook.SheetNames[0]);
                        
                        // Convert sheet to JSON
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
                            raw: false,
                            dateNF: "yyyy-mm-dd",
                        });
                        
                        console.log(` Total CCM rows in Excel: ${jsonData.length}`);
                        
                        // Filter out completely empty rows
                        const filteredData = jsonData.filter((row) => {
                            // Keep row if it has any non-empty values
                            return Object.values(row).some(val => val !== null && val !== undefined && val !== '');
                        });
                        
                        console.log(` Parsed ${filteredData.length} valid CCM records from Excel`);
                        
                        // Log data structure for debugging
                        if (filteredData.length > 0) {
                            console.log(" CCM record fields:", Object.keys(filteredData[0]));
                            console.log(" Sample CCM record:", filteredData[0]);
                        }
                        
                        resolve(filteredData);
                    } catch (error) {
                        console.error("Error parsing CCM Excel:", error);
                        reject(error);
                    }
                };
                reader.onerror = function (error) {
                    console.error("FileReader error:", error);
                    reject(error);
                };
                reader.readAsArrayBuffer(blob);
            });
        }

        // Parse CSV blob (read-only)
        async function parseCSVBlob(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const text = e.target.result;
                        const lines = text.split("\n");
                        const headers = lines[0].split(",").map((h) => h.trim());
                        
                        console.log("CSV Headers:", headers);
                        
                        const data = [];
                        for (let i = 1; i < lines.length; i++) {
                            if (lines[i].trim()) {
                                const values = lines[i].split(",");
                                const row = {};
                                headers.forEach((header, index) => {
                                    row[header] = values[index] ? values[index].trim() : "";
                                });
                                // Only add rows with Facility_ID
                                if (row.Facility_ID) {
                                    data.push(row);
                                }
                            }
                        }
                        
                        console.log(`Parsed ${data.length} records from CSV`);
                        resolve(data);
                    } catch (error) {
                        console.error("Error parsing CSV:", error);
                        reject(error);
                    }
                };
                reader.onerror = () => {
                    console.error("FileReader error while reading CSV");
                    reject(new Error("Failed to read CSV file"));
                };
                reader.readAsText(blob);
            });
        }

        // Parse Excel blob (read-only) - OPTIMIZED for large files
        async function parseExcelBlob(blob, progressCallback = null) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onprogress = function(e) {
                    if (e.lengthComputable && progressCallback) {
                        const percent = Math.round((e.loaded / e.total) * 30);
                        progressCallback(`Reading file...`, percent);
                    }
                };
                
                reader.onload = function (e) {
                    try {
                        if (progressCallback) progressCallback("Processing data structure...", 35);
                        
                        const data = new Uint8Array(e.target.result);
                        const startTime = performance.now();
                        
                        // OPTIMIZED: Use minimal parsing options for speed
                        const workbook = XLSX.read(data, { 
                            type: "array",
                            cellDates: true,
                            cellNF: false,
                            cellText: false,
                            cellStyles: false,
                            sheetStubs: false,
                        });
                        
                        const parseTime = performance.now() - startTime;
                        console.log(`Excel parsed in ${(parseTime/1000).toFixed(2)}s`);
                        
                        if (progressCallback) progressCallback("Converting to data rows...", 60);
                        
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        console.log("Excel Sheet Name:", workbook.SheetNames[0]);
                        
                        // OPTIMIZED: Convert sheet to JSON
                        const convertStart = performance.now();
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
                            raw: false,
                            dateNF: "yyyy-mm-dd",
                            defval: "",
                        });
                        const convertTime = performance.now() - convertStart;
                        console.log(`Converted ${jsonData.length} rows in ${(convertTime/1000).toFixed(2)}s`);
                        
                        if (progressCallback) progressCallback(`Filtering ${jsonData.length.toLocaleString()} rows...`, 90);
                        
                        // Filter for rows with Facility_ID
                        const filteredData = jsonData.filter((row) => row.Facility_ID);
                        
                        console.log(`Parsed ${filteredData.length} valid records from Excel`);
                        
                        // Log sample data for debugging
                        if (filteredData.length > 0) {
                            console.log("Sample record fields:", Object.keys(filteredData[0]));
                        }
                        
                        if (progressCallback) progressCallback(`Portfolio data ready (${filteredData.length.toLocaleString()} records)`, 100);
                        
                        resolve(filteredData);
                    } catch (error) {
                        console.error("Error parsing Excel:", error);
                        reject(error);
                    }
                };
                reader.onerror = () => {
                    console.error("FileReader error while reading Excel file");
                    reject(new Error("Failed to read Excel file"));
                };
                reader.readAsArrayBuffer(blob);
            });
        }

        // Show loading overlay with title - completely non-blocking
        function showLoadingOverlay(
            title = "Please wait...",
            progress = null,
            percent = null
        ) {
            // Schedule all DOM operations on next animation frame to prevent blocking
            requestAnimationFrame(() => {
                const overlay = document.getElementById("loadingOverlay");
                const messageEl = document.getElementById("loadingMessage");
                
                if (!overlay) {
                    console.error(' Loading overlay element not found!');
                    return;
                }
                
                // Show overlay if hidden
                if (overlay.classList.contains("hidden")) {
                    overlay.classList.remove("hidden");
                    console.log(' Loading overlay displayed');
                }
                
                // Update text only if changed - use separate animation frame to isolate from overlay show
                if (messageEl && messageEl.textContent !== title) {
                    requestAnimationFrame(() => {
                        // Double-buffer text update to completely isolate from animations
                        messageEl.textContent = title;
                        console.log(' Message updated:', title);
                    });
                }
            });
        }
        
        // Update just the loading percentage (legacy support - no longer needed with new loader)
        function updateLoadingPercent(percent) {
            // No-op for new loader design
        }

        // Hide loading overlay - non-blocking
        function hideLoadingOverlay() {
            // Schedule hiding on next animation frame
            requestAnimationFrame(() => {
                const overlay = document.getElementById("loadingOverlay");
                
                if (!overlay) {
                    console.error(' Loading overlay element not found when trying to hide!');
                    return;
                }
                
                console.log(' Hiding loading overlay');
                overlay.classList.add("hidden");
            });
        }
        
        // Animation Protection System - ensures animations never pause regardless of file operations
        (function() {
            if (typeof window === 'undefined') return;
            
            // Monitor and protect animations every 100ms
            const protectAnimations = () => {
                const overlay = document.getElementById("loadingOverlay");
                if (!overlay || overlay.classList.contains("hidden")) return;
                
                // Ensure all animation elements maintain running state
                const animatedElements = overlay.querySelectorAll('.animate-bit, .loader-item');
                animatedElements.forEach(el => {
                    const style = window.getComputedStyle(el);
                    // Force animation to run if somehow paused
                    if (style.animationPlayState === 'paused') {
                        el.style.animationPlayState = 'running';
                    }
                });
            };
            
            // Run protection check on animation frame loop for optimal timing
            const animationLoop = () => {
                protectAnimations();
                requestAnimationFrame(animationLoop);
            };
            
            // Start protection system when page loads
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    requestAnimationFrame(animationLoop);
                });
            } else {
                requestAnimationFrame(animationLoop);
            }
        })();

        // Show notification (TailAdmin style - matching alerts.html)
        function showNotification(title, message, type = "success") {
            const configs = {
                success: {
                    bgColor: "bg-success-50",
                    borderColor: "border-success-500",
                    textColor: "text-success-500",
                    icon: `<svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M3.70186 12.0001C3.70186 7.41711 7.41711 3.70186 12.0001 3.70186C16.5831 3.70186 20.2984 7.41711 20.2984 12.0001C20.2984 16.5831 16.5831 20.2984 12.0001 20.2984C7.41711 20.2984 3.70186 16.5831 3.70186 12.0001ZM12.0001 1.90186C6.423 1.90186 1.90186 6.423 1.90186 12.0001C1.90186 17.5772 6.423 22.0984 12.0001 22.0984C17.5772 22.0984 22.0984 17.5772 22.0984 12.0001C22.0984 6.423 17.5772 1.90186 12.0001 1.90186ZM15.6197 10.7395C15.9712 10.388 15.9712 9.81819 15.6197 9.46672C15.2683 9.11525 14.6984 9.11525 14.347 9.46672L11.1894 12.6243L9.6533 11.0883C9.30183 10.7368 8.73198 10.7368 8.38051 11.0883C8.02904 11.4397 8.02904 12.0096 8.38051 12.3611L10.553 14.5335C10.7217 14.7023 10.9507 14.7971 11.1894 14.7971C11.428 14.7971 11.657 14.7023 11.8257 14.5335L15.6197 10.7395Z" fill=""/>
                    </svg>`
                },
                error: {
                    bgColor: "bg-error-50",
                    borderColor: "border-error-500",
                    textColor: "text-error-500",
                    icon: `<svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M20.3499 12.0004C20.3499 16.612 16.6115 20.3504 11.9999 20.3504C7.38832 20.3504 3.6499 16.612 3.6499 12.0004C3.6499 7.38881 7.38833 3.65039 11.9999 3.65039C16.6115 3.65039 20.3499 7.38881 20.3499 12.0004ZM11.9999 22.1504C17.6056 22.1504 22.1499 17.6061 22.1499 12.0004C22.1499 6.3947 17.6056 1.85039 11.9999 1.85039C6.39421 1.85039 1.8499 6.3947 1.8499 12.0004C1.8499 17.6061 6.39421 22.1504 11.9999 22.1504ZM13.0008 16.4753C13.0008 15.923 12.5531 15.4753 12.0008 15.4753L11.9998 15.4753C11.4475 15.4753 10.9998 15.923 10.9998 16.4753C10.9998 17.0276 11.4475 17.4753 11.9998 17.4753L12.0008 17.4753C12.5531 17.4753 13.0008 17.0276 13.0008 16.4753ZM11.9998 6.62898C12.414 6.62898 12.7498 6.96476 12.7498 7.37898L12.7498 13.0555C12.7498 13.4697 12.414 13.8055 11.9998 13.8055C11.5856 13.8055 11.2498 13.4697 11.2498 13.0555L11.2498 7.37898C11.2498 6.96476 11.5856 6.62898 11.9998 6.62898Z" fill="#F04438"/>
                    </svg>`
                },
                warning: {
                    bgColor: "bg-warning-50",
                    borderColor: "border-warning-500",
                    textColor: "text-warning-500",
                    icon: `<svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M3.6501 12.0001C3.6501 7.38852 7.38852 3.6501 12.0001 3.6501C16.6117 3.6501 20.3501 7.38852 20.3501 12.0001C20.3501 16.6117 16.6117 20.3501 12.0001 20.3501C7.38852 20.3501 3.6501 16.6117 3.6501 12.0001ZM12.0001 1.8501C6.39441 1.8501 1.8501 6.39441 1.8501 12.0001C1.8501 17.6058 6.39441 22.1501 12.0001 22.1501C17.6058 22.1501 22.1501 17.6058 22.1501 12.0001C22.1501 6.39441 17.6058 1.8501 12.0001 1.8501ZM10.9992 7.52517C10.9992 8.07746 11.4469 8.52517 11.9992 8.52517H12.0002C12.5525 8.52517 13.0002 8.07746 13.0002 7.52517C13.0002 6.97289 12.5525 6.52517 12.0002 6.52517H11.9992C11.4469 6.52517 10.9992 6.97289 10.9992 7.52517ZM12.0002 17.3715C11.586 17.3715 11.2502 17.0357 11.2502 16.6215V10.945C11.2502 10.5308 11.586 10.195 12.0002 10.195C12.4144 10.195 12.7502 10.5308 12.7502 10.945V16.6215C12.7502 17.0357 12.4144 17.3715 12.0002 17.3715Z" fill=""/>
                    </svg>`
                },
                info: {
                    bgColor: "bg-blue-light-50",
                    borderColor: "border-blue-light-500",
                    textColor: "text-blue-light-500",
                    icon: `<svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M3.6501 11.9996C3.6501 7.38803 7.38852 3.64961 12.0001 3.64961C16.6117 3.64961 20.3501 7.38803 20.3501 11.9996C20.3501 16.6112 16.6117 20.3496 12.0001 20.3496C7.38852 20.3496 3.6501 16.6112 3.6501 11.9996ZM12.0001 1.84961C6.39441 1.84961 1.8501 6.39392 1.8501 11.9996C1.8501 17.6053 6.39441 22.1496 12.0001 22.1496C17.6058 22.1496 22.1501 17.6053 22.1501 11.9996C22.1501 6.39392 17.6058 1.84961 12.0001 1.84961ZM10.9992 7.52468C10.9992 8.07697 11.4469 8.52468 11.9992 8.52468H12.0002C12.5525 8.52468 13.0002 8.07697 13.0002 7.52468C13.0002 6.9724 12.5525 6.52468 12.0002 6.52468H11.9992C11.4469 6.52468 10.9992 6.9724 10.9992 7.52468ZM12.0002 17.371C11.586 17.371 11.2502 17.0352 11.2502 16.621V10.9445C11.2502 10.5303 11.586 10.1945 12.0002 10.1945C12.4144 10.1945 12.7502 10.5303 12.7502 10.9445V16.621C12.7502 17.0352 12.4144 17.371 12.0002 17.371Z" fill=""/>
                    </svg>`
                },
            };

            const config = configs[type] || configs.success;
            const notification = document.createElement("div");

            // Create notification with TailAdmin alert styling with solid background
            notification.className = `fixed top-6 right-6 z-9999 max-w-md rounded-xl border ${config.borderColor} bg-white p-4 shadow-lg transform transition-all duration-300 ease-out`;
            notification.style.animation = 'slideInRight 0.3s ease-out';
            
            // Add background color overlay as inline style for solid appearance
            notification.style.position = 'fixed';
            notification.style.backgroundColor = 'white';

            notification.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="-mt-0.5 ${config.textColor}">
                        ${config.icon}
                    </div>
                    <div class="flex-1">
                        <h4 class="mb-1 text-sm font-semibold text-gray-800">
                            ${title}
                        </h4>
                        <p class="text-sm text-gray-500">
                            ${message}
                        </p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600 transition-colors -mt-0.5">
                        <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M4.29289 4.29289C4.68342 3.90237 5.31658 3.90237 5.70711 4.29289L10 8.58579L14.2929 4.29289C14.6834 3.90237 15.3166 3.90237 15.7071 4.29289C16.0976 4.68342 16.0976 5.31658 15.7071 5.70711L11.4142 10L15.7071 14.2929C16.0976 14.6834 16.0976 15.3166 15.7071 15.7071C15.3166 16.0976 14.6834 16.0976 14.2929 15.7071L10 11.4142L5.70711 15.7071C5.31658 16.0976 4.68342 16.0976 4.29289 15.7071C3.90237 15.3166 3.90237 14.6834 4.29289 14.2929L8.58579 10L4.29289 5.70711C3.90237 5.31658 3.90237 4.68342 4.29289 4.29289Z" fill=""/>
                        </svg>
                    </button>
                </div>
            `;

            document.body.appendChild(notification);
            
            // Auto-dismiss after 5 seconds with fade out animation
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
                }, 300);
            }, 5000);
        }


        // Build indexes for fast filtering (one-time operation)
        function buildIndexes() {
            console.log("Building indexes for fast filtering...");
            const startTime = performance.now();
            
            indexCache.byRegion = new Map();
            indexCache.byProduct = new Map();
            indexCache.byRelationship = new Map();
            indexCache.dates = [];
            
            portfolioData.forEach((row, idx) => {
                // Region index
                const region = row.Region;
                if (region) {
                    if (!indexCache.byRegion.has(region)) {
                        indexCache.byRegion.set(region, []);
                    }
                    indexCache.byRegion.get(region).push(idx);
                }
                
                // Product index
                const product = row.Product_Program;
                if (product) {
                    if (!indexCache.byProduct.has(product)) {
                        indexCache.byProduct.set(product, []);
                    }
                    indexCache.byProduct.get(product).push(idx);
                }
                
                // Relationship index
                const relationship = row.Relationship_Name || row.Relationship_ID;
                if (relationship) {
                    if (!indexCache.byRelationship.has(relationship)) {
                        indexCache.byRelationship.set(relationship, []);
                    }
                    indexCache.byRelationship.get(relationship).push(idx);
                }
                
                // Pre-parse dates for faster filtering
                const maturityDate = parseDate(row.Maturity_Date);
                const caDate = parseDate(row.CA_Expiration_Date);
                indexCache.dates.push({
                    maturityDate,
                    caDate,
                });
            });
            
            const endTime = performance.now();
            console.log(
                `Indexes built in ${((endTime - startTime) / 1000).toFixed(
                    2
                )} seconds`
            );
        }
        
        // Generate hash of active filters for cache validation
        function getFilterHash() {
            return (
                JSON.stringify(activeFilters) +
                "_" +
                document.getElementById("searchInput").value
            );
        }

        // Initialize dashboard with data (optimized for large datasets)
        function initializeDashboard() {
            const startTime = performance.now();
            console.log(
                "Initializing dashboard with",
                portfolioData.length,
                "records..."
            );
            
            // Initialize global covenant view type
            window.currentCovenantViewType = currentCovenantViewType || 'pastDue';
            console.log('Initialized covenant view type:', window.currentCovenantViewType);
            
            // Safety check
            if (!portfolioData || portfolioData.length === 0) {
                console.error("No portfolio data loaded!");
                showNotification("Error", "No portfolio data available", "error");
                return;
            }
            
            // Log data structure for debugging
            console.log("Data row example:", portfolioData[0]);
            console.log("Available fields:", Object.keys(portfolioData[0]));
            
            // Step 1: Build indexes (one-time, makes filtering much faster)
            console.time("Build Indexes");
            buildIndexes();
            console.timeEnd("Build Indexes");
            
            // Step 2: Populate filters
            console.time("Populate Filters");
            populateFilterOptions();
            console.timeEnd("Populate Filters");
            
            // Step 3: Update report date
            console.time("Update Report Date");
            updateReportDate();
            console.timeEnd("Update Report Date");
            
            // Step 4: Calculate metrics (with caching)
            console.time("Calculate Metrics");
            calculateMetrics();
            console.timeEnd("Calculate Metrics");
            
            // Step 5: Create charts with sampled data (faster)
            console.time("Create Charts");
            createFacilityTrendChart();
            createRelationshipChart();
            createNewFacilitiesApprovedChart();
            createROTCEChart();
            console.timeEnd("Create Charts");
            
            // Ensure no charts are left blank - show no-data message as fallback
            setTimeout(() => {
                const chartChecks = [
                    { id: '#facilityTrendChart', name: 'CAs & Facilities Expiring' },
                    { id: '#creditClassificationChart', name: 'New Facilities Approved' }, // Legacy ID, actually New Facilities chart
                    { id: '#relationshipChart', name: 'Top Relationships' },
                    { id: '#rotceChart', name: 'ROTCE Performance' }
                ];
                
                chartChecks.forEach(({ id, name }) => {
                    const el = document.querySelector(id);
                    if (el) {
                        const hasChart = el.querySelector('.apexcharts-canvas');
                        const hasNoDataMsg = el.innerHTML.includes('No data available');
                        
                        // If no chart and no existing no-data message, show no-data message
                        if (!hasChart && !hasNoDataMsg) {
                            console.log(` Chart ${name} is blank, showing no-data message`);
                            el.innerHTML = generateNoDataMessage(name);
                        }
                    }
                });
            }, 200);
            
            // Step 6: Filter and render table (only first page)
            console.time("Filter and Render Table");
            filterData();
            console.timeEnd("Filter and Render Table");
            
            const endTime = performance.now();
            console.log(
                `Dashboard initialized in ${((endTime - startTime) / 1000).toFixed(
                    2
                )} seconds`
            );
        }

        // Populate filter dropdowns with unique values from Confluence data (read-only)
        function populateFilterOptions() {
            if (!portfolioData || portfolioData.length === 0) {
                console.warn("No portfolio data available to populate filters");
                return;
            }

            console.log(
                "Populating filter options from",
                portfolioData.length,
                "records"
            );
            
            // Product Program
            const products = [
                ...new Set(
                    portfolioData.map((row) => row.Product_Program).filter(Boolean)
                ),
            ].sort();
            populateSelect("filterProductProgram", products);
            console.log("Product Programs:", products.length, "options");
            
            // Extending Unit (Control_Unit)
            const units = [
                ...new Set(
                    portfolioData.map((row) => row.Control_Unit).filter(Boolean)
                ),
            ].sort();
            populateSelect("filterExtendingUnit", units);
            console.log("Extending Units:", units.length, "options");
            
            // Facility Type
            const facilityTypes = [
                ...new Set(
                    portfolioData.map((row) => row.Facility_Type).filter(Boolean)
                ),
            ].sort();
            populateSelect("filterFacilityType", facilityTypes);
            console.log("Facility Types:", facilityTypes.length, "options");
            
            // Committed/Uncommitted
            const commitments = [
                ...new Set(
                    portfolioData
                        .map((row) => row["Committed/Uncommitted"])
                        .filter(Boolean)
                ),
            ].sort();
            populateSelect("filterCommitment", commitments);
            console.log("Commitment Status:", commitments.length, "options");
            
            // Team Lead (Underwriter_Team_Lead)
            const teamLeads = [
                ...new Set(
                    portfolioData
                        .map((row) => row.Underwriting_Team_Lead)
                        .filter(Boolean)
                ),
            ].sort();
            populateSelect("filterTeamLead", teamLeads);
            console.log("Team Leads:", teamLeads.length, "options");
            
            // Underwriter (Lead_Underwriter)
            const underwriters = [
                ...new Set(
                    portfolioData.map((row) => row.Lead_Underwriter).filter(Boolean)
                ),
            ].sort();
            populateSelect("filterUnderwriter", underwriters);
            console.log("Underwriters:", underwriters.length, "options");
        }

        // Helper to populate a select element
        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) {
                console.warn(`Select element with id '${selectId}' not found`);
                return;
            }
            const currentValue = select.value;
            
            // Keep the first option (All...)
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            options.forEach((option) => {
                const opt = document.createElement("option");
                opt.value = option;
                opt.textContent = option;
                select.appendChild(opt);
            });
            
            // Restore previous value if it still exists
            if (currentValue && options.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // Apply all filters (OPTIMIZED for 40K+ rows)
        function applyFilters() {
            const startTime = performance.now();
            
            console.log('applyFilters called');
            
            // Get advanced filter values (excluding Region, Status, and Commitment Status which are in smart filters)
            // Add safety checks for each element
            const filters = {
                productProgram: document.getElementById("filterProductProgram")?.value || "",
                extendingUnit: document.getElementById("filterExtendingUnit")?.value || "",
                facilityType: document.getElementById("filterFacilityType")?.value || "",
                teamLead: document.getElementById("filterTeamLead")?.value || "",
                underwriter: document.getElementById("filterUnderwriter")?.value || "",
                caMaturity: document.getElementById("filterCAMaturity")?.value || "",
                facilityMaturity: document.getElementById("filterFacilityMaturity")?.value || "",
            };

            // Update active filters object (including Region, Status, and Commitment Status smart filters)
            activeFilters = {};
            
            // Add smart filters to activeFilters
            if (selectedRegion !== 'all')
                activeFilters["Region"] = selectedRegion;
            if (selectedStatus !== 'all')
                activeFilters["Status"] = selectedStatus;
            if (selectedCommitmentStatus !== 'all')
                activeFilters["Commitment Status"] = selectedCommitmentStatus;
            if (selectedPSE !== 'all')
                activeFilters["PSE"] = selectedPSE;
            
            if (filters.productProgram)
                activeFilters["Product Program"] = filters.productProgram;
            if (filters.extendingUnit)
                activeFilters["Extending Unit"] = filters.extendingUnit;
            if (filters.facilityType)
                activeFilters["Facility Type"] = filters.facilityType;
            if (filters.teamLead) activeFilters["Team Lead"] = filters.teamLead;
            if (filters.underwriter)
                activeFilters["Underwriter"] = filters.underwriter;
            if (filters.caMaturity) {
                const days = filters.caMaturity;
                activeFilters["CAs Maturing"] =
                    days === "30"
                        ? "Next 30 Days"
                        : days === "60"
                            ? "Next 60 Days"
                            : days === "90"
                                ? "Next 90 Days"
                                : days === "180"
                                    ? "Next 6 Months"
                                    : "Next Year";
            }
            if (filters.facilityMaturity) {
                const days = filters.facilityMaturity;
                activeFilters["Facilities Maturing"] =
                    days === "30"
                        ? "Next 30 Days"
                        : days === "60"
                            ? "Next 60 Days"
                            : days === "90"
                                ? "Next 90 Days"
                                : days === "180"
                                    ? "Next 6 Months"
                                    : "Next Year";
            }
            
            // Display filter badges and update count
            displayFilterBadges();
            updateFilterCount();
            
            // Check if we can use cache
            const currentHash = getFilterHash();
            if (metricsCache.filterHash === currentHash && metricsCache.filtered) {
                console.log("Using cached filter results");
                filteredData = metricsCache.filtered.data;
                
                // Still need to update charts even when using cache
                requestAnimationFrame(() => {
                    calculateMetricsFromFiltered();
                    createExpirationChartFromFiltered();
                    createFacilityTrendChartFromFiltered();
                    createRelationshipChartFromFiltered();
                    createNewFacilitiesApprovedChartFromFiltered();
                    createROTCEChartFromFiltered();
                });
                
                return;
            }
            
            // Pre-calculate date ranges for date filters (avoid recalculating in loop)
            let caDateRange = null;
            let facilityDateRange = null;
            if (filters.caMaturity) {
                const today = new Date();
                const futureDate = new Date(
                    today.getTime() + parseInt(filters.caMaturity) * 24 * 60 * 60 * 1000
                );
                caDateRange = { today, futureDate };
            }
            if (filters.facilityMaturity) {
                const today = new Date();
                const futureDate = new Date(
                    today.getTime() +
                    parseInt(filters.facilityMaturity) * 24 * 60 * 60 * 1000
                );
                facilityDateRange = { today, futureDate };
            }
            
            const searchTerm = (document.getElementById("searchInput")?.value || "").toLowerCase();
            
            // OPTIMIZED filtering: Use early exits and minimal object access
            filteredData = [];
            for (let i = 0; i < portfolioData.length; i++) {
                const row = portfolioData[i];
                
                // Smart Filters (apply first for performance)
                // Region filter (case-insensitive comparison)
                if (selectedRegion !== "all") {
                    const rowRegion = (row.Region || "").toUpperCase();
                    if (rowRegion !== selectedRegion.toUpperCase()) continue;
                }
                
                // PSE filter
                if (selectedPSE !== "all") {
                    const pseColumn = row["PSE_non-PSE"] || row.PSE_non_PSE || "";
                    const pseValue = String(pseColumn).trim().toUpperCase();
                    if (pseValue !== selectedPSE.toUpperCase()) continue;
                }
                
                // Management Status filter (CM/DM) - case-insensitive comparison
                if (selectedStatus !== "all") {
                    const rowStatus = (row.Management_Status || "").toUpperCase();
                    if (rowStatus !== selectedStatus.toUpperCase()) continue;
                }
                
                // Commitment Status filter (Committed/Uncommitted)
                if (selectedCommitmentStatus !== "all") {
                    const rowCommitment = row["Committed/Uncommitted"] || "";
                    if (rowCommitment !== selectedCommitmentStatus) continue;
                }
                
                // Fast path: Check advanced filter string filters (fastest to fail)
                if (
                    filters.productProgram &&
                    row.Product_Program !== filters.productProgram
                )
                    continue;
                if (
                    filters.extendingUnit &&
                    row.Control_Unit !== filters.extendingUnit
                )
                    continue;
                if (
                    filters.facilityType &&
                    row.Facility_Type !== filters.facilityType
                )
                    continue;
                if (
                    filters.teamLead &&
                    row.Underwriting_Team_Lead !== filters.teamLead
                )
                    continue;
                if (
                    filters.underwriter &&
                    row.Lead_Underwriter !== filters.underwriter
                )
                    continue;
                
                // Date filters (use pre-parsed dates from index)
                if (caDateRange) {
                    const caDate = indexCache.dates[i].caDate;
                    if (
                        !caDate ||
                        caDate < caDateRange.today ||
                        caDate > caDateRange.futureDate
                    )
                        continue;
                }
                
                if (facilityDateRange) {
                    const maturityDate = indexCache.dates[i].maturityDate;
                    if (
                        !maturityDate ||
                        maturityDate < facilityDateRange.today ||
                        maturityDate > facilityDateRange.futureDate
                    )
                        continue;
                }
                
                // Search filter (most expensive, do last)
            if (searchTerm) {
                    let found = false;
                    for (const value of Object.values(row)) {
                        if (String(value).toLowerCase().includes(searchTerm)) {
                            found = true;
                            break;
                        }
                    }
                    if (!found) continue;
                }
                
                // All filters passed
                filteredData.push(row);
            }
            
            // Cache the results
            metricsCache.filterHash = currentHash;
            metricsCache.filtered = { data: filteredData };
            
            console.log(
                `Filtered ${portfolioData.length} to ${filteredData.length
                } rows in ${(performance.now() - startTime).toFixed(2)}ms`
            );
            
            // Recalculate metrics and charts with filtered data (async to prevent blocking)
            requestAnimationFrame(() => {
            calculateMetricsFromFiltered();
                createExpirationChartFromFiltered();
                createFacilityTrendChartFromFiltered();
            createRelationshipChartFromFiltered();
            createNewFacilitiesApprovedChartFromFiltered();
                createROTCEChartFromFiltered();
                
                // Update covenant and CCM charts with region filter
                populateCovenantMonitoringData();
                createCovenantMonitoringChart('pastDue');
                updateCovenantRegionalTable('pastDue');
                calculateCCMStats();
                createCCMRegionalChart();
            });
        }

        // Apply chart-based filter (cross-filtering)
        function applyChartFilter(filterType, filterValue, displayLabel) {
            console.log(` Chart filter applied: ${filterType} = ${filterValue}`);

            // Set chart filter state
            chartFilter.active = true;
            chartFilter.type = filterType;
            chartFilter.value = filterValue;
            chartFilter.label = displayLabel || filterValue;

            // Apply the filter (which will also update badges via displayFilterBadges)
            applyFiltersWithChartFilter();
        }

        // Clear chart filter
        function clearChartFilter() {
            console.log(" Chart filter cleared");

            chartFilter.active = false;
            chartFilter.type = null;
            chartFilter.value = null;
            chartFilter.label = null;

            // Reapply normal filters (which will update badges)
            applyFilters();
        }

        // Display chart filter badge
        function displayChartFilterBadge() {
            // Note: This function is now integrated into displayFilterBadges()
            // Kept for backwards compatibility but does nothing
            return;
        }

        // Apply filters with chart filter included
        function applyFiltersWithChartFilter() {
            const startTime = performance.now();

            // Get advanced filter values (excluding Region, Status, and Commitment Status which are in smart filters)
            const filters = {
                productProgram: document.getElementById("filterProductProgram").value,
                extendingUnit: document.getElementById("filterExtendingUnit").value,
                facilityType: document.getElementById("filterFacilityType").value,
                teamLead: document.getElementById("filterTeamLead").value,
                underwriter: document.getElementById("filterUnderwriter").value,
                caMaturity: document.getElementById("filterCAMaturity").value,
                facilityMaturity: document.getElementById("filterFacilityMaturity")
                    .value,
            };

            // Update active filters object (including Region, Status, and Commitment Status smart filters)
            activeFilters = {};
            
            // Add smart filters to activeFilters
            if (selectedRegion !== 'all')
                activeFilters["Region"] = selectedRegion;
            if (selectedStatus !== 'all')
                activeFilters["Status"] = selectedStatus;
            if (selectedCommitmentStatus !== 'all')
                activeFilters["Commitment Status"] = selectedCommitmentStatus;
            if (selectedPSE !== 'all')
                activeFilters["PSE"] = selectedPSE;
            
            if (filters.productProgram)
                activeFilters["Product Program"] = filters.productProgram;
            if (filters.extendingUnit)
                activeFilters["Extending Unit"] = filters.extendingUnit;
            if (filters.facilityType)
                activeFilters["Facility Type"] = filters.facilityType;
            if (filters.teamLead) activeFilters["Team Lead"] = filters.teamLead;
            if (filters.underwriter)
                activeFilters["Underwriter"] = filters.underwriter;
            if (filters.caMaturity) {
                const days = filters.caMaturity;
                activeFilters["CAs Maturing"] =
                    days === "30"
                        ? "Next 30 Days"
                        : days === "60"
                            ? "Next 60 Days"
                            : days === "90"
                                ? "Next 90 Days"
                                : days === "180"
                                    ? "Next 6 Months"
                                    : "Next Year";
            }
            if (filters.facilityMaturity) {
                const days = filters.facilityMaturity;
                activeFilters["Facilities Maturing"] =
                    days === "30"
                        ? "Next 30 Days"
                        : days === "60"
                            ? "Next 60 Days"
                            : days === "90"
                                ? "Next 90 Days"
                                : days === "180"
                                    ? "Next 6 Months"
                                    : "Next Year";
            }

            // Display filter badges and update count
            displayFilterBadges();
            updateFilterCount();

            // Pre-calculate date ranges for date filters (avoid recalculating in loop)
            let caDateRange = null;
            let facilityDateRange = null;
            if (filters.caMaturity) {
                const today = new Date();
                const futureDate = new Date(
                    today.getTime() + parseInt(filters.caMaturity) * 24 * 60 * 60 * 1000
                );
                caDateRange = { today, futureDate };
            }
            if (filters.facilityMaturity) {
                const today = new Date();
                const futureDate = new Date(
                    today.getTime() +
                    parseInt(filters.facilityMaturity) * 24 * 60 * 60 * 1000
                );
                facilityDateRange = { today, futureDate };
            }

            const searchTerm = document
                .getElementById("searchInput")
                .value.toLowerCase();

            // OPTIMIZED filtering: Use early exits and minimal object access
            filteredData = [];
            for (let i = 0; i < portfolioData.length; i++) {
                const row = portfolioData[i];

                // Apply chart filter first
                if (chartFilter.active) {
                    let passChartFilter = false;

                    switch (chartFilter.type) {
                        case "relationship":
                            const relName = row.Relationship_Name || row.Relationship_ID;
                            // Remove index number (e.g., "1. ABC Bank" -> "ABC Bank")
                            const cleanValue = chartFilter.value.replace(/^\d+\.\s*/, "");
                            passChartFilter = relName === cleanValue;
                            break;
                        case "product":
                            passChartFilter = row.Product_Program === chartFilter.value;
                            break;
                        case "facilityType":
                            passChartFilter = row.Facility_Type === chartFilter.value;
                            break;
                        case "expiryMonth":
                            // Filter by expiry month (CAs Coming Due or Facilities Expiring)
                            const selectedSeries = window.selectedExpirySeries;
                            const selectedMonth = chartFilter.value; // Format: "YYYY-MM"
                            
                            if (selectedSeries === "CAs Coming Due") {
                                // Check CA_Expiration_Date
                                const caDate = parseDate(row.CA_Expiration_Date);
                                const managementStatus = (row.Management_Status || "").toUpperCase();
                                const region = (row.Region || "").toUpperCase();
                                const caReview = (row.CA_Review || "").trim();
                                
                                if (caDate && managementStatus === "CM" && caDate >= window.currentReportDate) {
                                    const year = caDate.getFullYear();
                                    const month = String(caDate.getMonth() + 1).padStart(2, "0");
                                    const rowMonth = `${year}-${month}`;
                                    
                                    // Apply EMEA CA_Review filter if needed
                                    if (region === "EMEA") {
                                        passChartFilter = (rowMonth === selectedMonth && caReview === "Yes");
                                    } else {
                                        passChartFilter = (rowMonth === selectedMonth);
                                    }
                                }
                            } else if (selectedSeries === "Facilities Expiring") {
                                // Check Maturity_Date
                                const maturityDate = parseDate(row.Maturity_Date);
                                
                                if (maturityDate && maturityDate >= window.currentReportDate) {
                                    const year = maturityDate.getFullYear();
                                    const month = String(maturityDate.getMonth() + 1).padStart(2, "0");
                                    const rowMonth = `${year}-${month}`;
                                    passChartFilter = (rowMonth === selectedMonth);
                                }
                            }
                            break;
                    }

                    if (!passChartFilter) continue;
                }

                // Smart Filters (apply after chart filter for performance)
                // Region filter (case-insensitive comparison)
                if (selectedRegion !== "all") {
                    const rowRegion = (row.Region || "").toUpperCase();
                    if (rowRegion !== selectedRegion.toUpperCase()) continue;
                }

                // PSE filter
                if (selectedPSE !== "all") {
                    const pseColumn = row["PSE_non-PSE"] || row.PSE_non_PSE || "";
                    const pseValue = String(pseColumn).trim().toUpperCase();
                    if (pseValue !== selectedPSE.toUpperCase()) continue;
                }

                // Management Status filter (CM/DM) - case-insensitive comparison
                if (selectedStatus !== "all") {
                    const rowStatus = (row.Management_Status || "").toUpperCase();
                    if (rowStatus !== selectedStatus.toUpperCase()) continue;
                }

                // Commitment Status filter (Committed/Uncommitted)
                if (selectedCommitmentStatus !== "all") {
                    const rowCommitment = row["Committed/Uncommitted"] || "";
                    if (rowCommitment !== selectedCommitmentStatus) continue;
                }

                // Fast path: Check advanced filter string filters (fastest to fail)
                if (
                    filters.productProgram &&
                    row.Product_Program !== filters.productProgram
                )
                    continue;
                if (
                    filters.extendingUnit &&
                    row.Control_Unit !== filters.extendingUnit
                )
                    continue;
                if (
                    filters.facilityType &&
                    row.Facility_Type !== filters.facilityType
                )
                    continue;
                if (
                    filters.teamLead &&
                    row.Underwriting_Team_Lead !== filters.teamLead
                )
                    continue;
                if (
                    filters.underwriter &&
                    row.Lead_Underwriter !== filters.underwriter
                )
                    continue;

                // Date filters (use pre-parsed dates from index)
                if (caDateRange) {
                    const caDate = indexCache.dates[i].caDate;
                    if (
                        !caDate ||
                        caDate < caDateRange.today ||
                        caDate > caDateRange.futureDate
                    )
                        continue;
                }

                if (facilityDateRange) {
                    const maturityDate = indexCache.dates[i].maturityDate;
                    if (
                        !maturityDate ||
                        maturityDate < facilityDateRange.today ||
                        maturityDate > facilityDateRange.futureDate
                    )
                        continue;
                }

                // Search filter (most expensive, do last)
                if (searchTerm) {
                    let found = false;
                    for (const value of Object.values(row)) {
                        if (String(value).toLowerCase().includes(searchTerm)) {
                            found = true;
                            break;
                        }
                    }
                    if (!found) continue;
                }

                // All filters passed
                filteredData.push(row);
            }

            console.log(
                `Filtered ${portfolioData.length} to ${filteredData.length
                } rows (with chart filter) in ${(
                    performance.now() - startTime
                ).toFixed(2)}ms`
            );

            // Recalculate metrics and charts with filtered data (async to prevent blocking)
            requestAnimationFrame(() => {
                calculateMetricsFromFiltered();
                createExpirationChartFromFiltered();
                createFacilityTrendChartFromFiltered();
                createRelationshipChartFromFiltered();
                createNewFacilitiesApprovedChartFromFiltered();
                createROTCEChartFromFiltered();
                
                // Update covenant and CCM charts with region filter
                populateCovenantMonitoringData();
                createCovenantMonitoringChart('pastDue');
                updateCovenantRegionalTable('pastDue');
                calculateCCMStats();
                createCCMRegionalChart();
            });
        }

        // Display filter badges
        function displayFilterBadges() {
            const badgesContainer = document.getElementById("activeFiltersBadges");
            
            if (badgesContainer) badgesContainer.innerHTML = "";
            
            // Check if there are any filters (including search and chart filter)
            const hasFilters = Object.keys(activeFilters).length > 0 || selectedSearchTerm !== "" || chartFilter.active;
            
            if (!hasFilters) {
                if (badgesContainer) badgesContainer.style.display = "none";
                return;
            }
            
            if (badgesContainer) badgesContainer.style.display = "flex";
            
            // Add chart filter badge first (if active)
            if (chartFilter.active) {
                const chartBadge = document.createElement("span");
                chartBadge.id = "chartFilterBadge";
                chartBadge.className =
                    "inline-flex items-center bg-white text-sm text-gray-600 border border-gray-300 rounded-lg gap-x-2 py-1.5 pl-3 pr-1";
                
                // Get proper label for the filter type
                let filterTypeLabel = chartFilter.type.charAt(0).toUpperCase() + chartFilter.type.slice(1);
                if (chartFilter.type === 'relationship') filterTypeLabel = 'Relationship';
                if (chartFilter.type === 'product') filterTypeLabel = 'Product';
                if (chartFilter.type === 'facilityType') filterTypeLabel = 'Facility Type';
                if (chartFilter.type === 'region') filterTypeLabel = 'Region';
                if (chartFilter.type === 'expiryMonth') filterTypeLabel = 'Expiry Month';
                if (chartFilter.type === 'pipelineType') filterTypeLabel = 'Pipeline Type';
                if (chartFilter.type === 'pipelineWeek') filterTypeLabel = 'Pipeline Week';
                
                chartBadge.innerHTML = `
                    <span class="text-gray-600">${filterTypeLabel}</span>
                    <span class="h-4 w-px bg-gray-300"></span>
                    <span class="font-medium text-gray-800">${chartFilter.label}</span>
                    <button type="button" onclick="clearChartFilter()" 
                        class="flex h-5 w-5 items-center justify-center rounded text-gray-500 hover:bg-gray-100 hover:text-gray-700"
                        aria-label="Remove">
                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                `;
                badgesContainer.appendChild(chartBadge);
            }
            
            // Add search badge if search is active
            if (selectedSearchTerm !== "") {
                const searchBadge = document.createElement("span");
                searchBadge.className =
                    "inline-flex items-center bg-white text-sm text-gray-600 border border-gray-300 rounded-lg gap-x-2 py-1.5 pl-3 pr-1";
                searchBadge.innerHTML = `
                    <span class="text-gray-600">Search</span>
                    <span class="h-4 w-px bg-gray-300"></span>
                    <span class="font-medium text-gray-800">"${selectedSearchTerm}"</span>
                    <button type="button" onclick="clearSearchFilter()" 
                        class="flex h-5 w-5 items-center justify-center rounded text-gray-500 hover:bg-gray-100 hover:text-gray-700"
                        aria-label="Remove">
                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                `;
                badgesContainer.appendChild(searchBadge);
            }
            
            // Add other filter badges
            Object.entries(activeFilters).forEach(([label, value]) => {
                // Create badge for Portfolio Overview
                if (badgesContainer) {
                    const badge = document.createElement("span");
                    badge.className =
                        "inline-flex items-center bg-white text-sm text-gray-600 border border-gray-300 rounded-lg gap-x-2 py-1.5 pl-3 pr-1";
                    badge.innerHTML = `
                        <span class="text-gray-600">${label}</span>
                        <span class="h-4 w-px bg-gray-300"></span>
                        <span class="font-medium text-gray-800">${value}</span>
                        <button type="button" onclick="removeFilter('${label}')" 
                            class="flex h-5 w-5 items-center justify-center rounded text-gray-500 hover:bg-gray-100 hover:text-gray-700"
                            aria-label="Remove">
                            <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    `;
                    badgesContainer.appendChild(badge);
                }
            });
        }

        // Remove a specific filter
        function removeFilter(label) {
            // Handle smart filters first
            if (label === "Region") {
                selectRegionFilter('all');
                return;
            }
            
            if (label === "Status") {
                selectStatusFilter('all');
                return;
            }
            
            if (label === "Commitment Status") {
                selectCommitmentFilter('all');
                return;
            }
            
            if (label === "PSE") {
                selectPSEFilter('all');
                return;
            }
            
            // Handle advanced filters
            const filterMap = {
                "Product Program": "filterProductProgram",
                "Extending Unit": "filterExtendingUnit",
                "Facility Type": "filterFacilityType",
                "Team Lead": "filterTeamLead",
                Underwriter: "filterUnderwriter",
                "CAs Maturing": "filterCAMaturity",
                "Facilities Maturing": "filterFacilityMaturity",
            };
            
            const selectId = filterMap[label];
            if (selectId) {
                const element = document.getElementById(selectId);
                if (element) {
                    element.value = "";
                }
                applyFilters();
            }
        }

        // Clear all filters
        function clearAllFilters() {
            // Clear only advanced filter fields (Region and Status are managed by smart filters)
            document.getElementById("filterProductProgram").value = "";
            document.getElementById("filterExtendingUnit").value = "";
            document.getElementById("filterFacilityType").value = "";
            document.getElementById("filterCommitment").value = "";
            document.getElementById("filterTeamLead").value = "";
            document.getElementById("filterUnderwriter").value = "";
            document.getElementById("filterCAMaturity").value = "";
            document.getElementById("filterFacilityMaturity").value = "";
            
            // Reset PSE to default (All)
            selectPSEFilter('all');
            
            activeFilters = {};
            applyFilters();
            updateFilterCount();
        }

        // Store temporary filter state when opening popover
        let tempFilterState = {};

        // Toggle filter popover
        function toggleFilterPopover() {
            const popover = document.getElementById("filterPopover");
            if (popover.classList.contains("hidden")) {
                // Opening popover - save current filter state (excluding smart filters)
                tempFilterState = {
                    productProgram: document.getElementById("filterProductProgram")
                        .value,
                    extendingUnit: document.getElementById("filterExtendingUnit").value,
                    facilityType: document.getElementById("filterFacilityType").value,
                    commitment: document.getElementById("filterCommitment").value,
                    teamLead: document.getElementById("filterTeamLead").value,
                    underwriter: document.getElementById("filterUnderwriter").value,
                    caMaturity: document.getElementById("filterCAMaturity").value,
                    facilityMaturity: document.getElementById("filterFacilityMaturity")
                        .value,
                };

                popover.classList.remove("hidden");
                document.body.style.overflow = "hidden"; // Prevent background scrolling
            } else {
                // Closing popover - restore previous filter state (cancel changes)
                document.getElementById("filterProductProgram").value =
                    tempFilterState.productProgram || "";
                document.getElementById("filterExtendingUnit").value =
                    tempFilterState.extendingUnit || "";
                document.getElementById("filterFacilityType").value =
                    tempFilterState.facilityType || "";
                document.getElementById("filterCommitment").value =
                    tempFilterState.commitment || "";
                document.getElementById("filterTeamLead").value =
                    tempFilterState.teamLead || "";
                document.getElementById("filterUnderwriter").value =
                    tempFilterState.underwriter || "";
                document.getElementById("filterCAMaturity").value =
                    tempFilterState.caMaturity || "";
                document.getElementById("filterFacilityMaturity").value =
                    tempFilterState.facilityMaturity || "";

                popover.classList.add("hidden");
                document.body.style.overflow = ""; // Restore scrolling
            }
        }

        // Apply filters and close popover
        function applyFiltersAndClose() {
            applyFilters();
            // Close popover without restoring state (we're applying changes)
            const popover = document.getElementById("filterPopover");
            popover.classList.add("hidden");
            document.body.style.overflow = "";
        }

        // Update filter count badge
        function updateFilterCount() {
            // Count all filters (smart filters are already included in activeFilters) + search
            let count = Object.keys(activeFilters).length;
            
            // Add 1 if search is active
            if (selectedSearchTerm !== "") {
                count++;
            }
            
            const badge = document.getElementById("filterCount");
            const badgeInline = document.getElementById("filterCountInline");
            
            if (count > 0) {
                if (badge) {
                    badge.textContent = count;
                    badge.classList.remove("hidden");
                }
                if (badgeInline) {
                    badgeInline.textContent = count;
                    badgeInline.classList.remove("hidden");
                }
            } else {
                if (badge) badge.classList.add("hidden");
                if (badgeInline) badgeInline.classList.add("hidden");
            }
        }

        // Calculate metrics from filtered data (OPTIMIZED)
        function calculateMetricsFromFiltered() {
            const startTime = performance.now();
            
            let totalFacAmount = 0;
            let totalOSUC = 0;
            let totalOutstanding = 0;
            const relationships = new Set();
            const facilities = new Set();
            
            // Single pass through filtered data
            for (let i = 0; i < filteredData.length; i++) {
                const row = filteredData[i];
                
                totalFacAmount += parseNumber(row.Fac_Amount);
                totalOSUC += parseNumber(row.OSUC);
                
                // Total Outstanding from Total_OS column
                totalOutstanding += parseNumber(row.Total_OS);
                
                // Use Relationship_ID for unique count (not Relationship_Name which may have duplicates)
                if (row.Relationship_ID) relationships.add(row.Relationship_ID);
                
                if (row.Facility_ID) facilities.add(row.Facility_ID);
            }
            
            document.getElementById("totalRelationships").textContent =
                relationships.size.toLocaleString();
            document.getElementById("totalFacilities").textContent =
                facilities.size.toLocaleString();
            document.getElementById("totalOSUC").textContent =
                formatCurrency(totalOSUC);
            document.getElementById("totalFacAmount").textContent =
                formatCurrency(totalFacAmount);
            document.getElementById("totalOutstanding").textContent =
                formatCurrency(totalOutstanding);

            console.log(
                `Filtered metrics calculated in ${(
                    performance.now() - startTime
                ).toFixed(2)}ms`
            );
            
            // Calculate expired metrics from filtered data
            calculateExpiredMetricsFromFiltered();
            
            // Calculate new deals YTD/MTD metrics from filtered data
            calculateNewDealsMetricsFromFiltered();

            // Populate pipeline deals table from filtered data
            populatePipelineTable();

            // Populate Covenant Monitoring data and chart
            populateCovenantMonitoringData();
            createCovenantMonitoringChart('pastDue');
            updateCovenantRegionalTable('pastDue');
            
            // Calculate and display CCM stats
            calculateCCMStats();
            createCCMRegionalChart();
            updateCCMStats('pastDue');
        }

        // Calculate Facilities Expired and CAs Expired metrics from filtered data
        function calculateExpiredMetricsFromFiltered() {
            // Get the current report date
            const reportDates = filteredData
                .map((row) => parseDate(row.Report_Date))
                .filter((d) => d);
            if (reportDates.length === 0) return;
            
            const maxReportDate = new Date(Math.max(...reportDates));
            maxReportDate.setHours(0, 0, 0, 0);
            
            // Count expired facilities and CAs (everything before report date)
            const expiredFacilities = new Set(); // Track unique Facility IDs
            let facilitiesExpiredAmount = 0;
            const expiredCAsAllRegions = new Set(); // Track unique Relationship_IDs for all regions
            const expiredCAsEMEA = new Set(); // Track unique Relationship_IDs for EMEA with CA_Review filter
            let casExpiredAmount = 0;
            
            for (let i = 0; i < filteredData.length; i++) {
                const row = filteredData[i];
                const managementStatus = (row.Management_Status || "").toUpperCase();
                
                // Check Facilities Expired (count unique Facility IDs, NO DM exclusion)
                const maturityDate = parseDate(row.Maturity_Date);
                if (
                    maturityDate &&
                    maturityDate < maxReportDate &&
                    row.Facility_ID
                ) {
                    expiredFacilities.add(row.Facility_ID);
                    facilitiesExpiredAmount += parseNumber(
                        row.Fac_Amount || row.Facility_Amount
                    );
                }
                
                // Check CAs Expired (count unique Relationship_IDs for all regions, CM only)
                // For EMEA: also requires CA_Review = "Yes"
                const caExpirationDate = parseDate(row.CA_Expiration_Date);
                const region = (row.Region || "").toUpperCase();
                const caReview = (row.CA_Review || "").trim();
                
                if (
                    caExpirationDate &&
                    caExpirationDate < maxReportDate &&
                    managementStatus === "CM" &&
                    row.Relationship_ID
                ) {
                    if (region === "EMEA") {
                        // For EMEA: require CA_Review = "Yes"
                        if (caReview === "Yes") {
                            expiredCAsEMEA.add(row.Relationship_ID);
                            casExpiredAmount += parseNumber(
                                row.Fac_Amount || row.Facility_Amount
                            );
                        }
                    } else {
                        // For non-EMEA: count all Relationship_IDs
                        expiredCAsAllRegions.add(row.Relationship_ID);
                        casExpiredAmount += parseNumber(
                            row.Fac_Amount || row.Facility_Amount
                        );
                    }
                }
            }
            
            // Combine counts: all non-EMEA Relationship_IDs + EMEA Relationship_IDs (with CA_Review filter)
            const casExpiredCount = expiredCAsAllRegions.size + expiredCAsEMEA.size;
            const facilitiesExpiredCount = expiredFacilities.size;
            
            // Update DOM
            document.getElementById("facilitiesExpiredCount").textContent =
                facilitiesExpiredCount.toLocaleString();
            document.getElementById("casExpiredCount").textContent =
                casExpiredCount.toLocaleString();
        }

        // Create expiration chart from filtered data
        function createExpirationChartFromFiltered() {
            console.log(
                " Creating filtered facilities expired & expiring bar chart"
            );
            
            // Get the current reporting month from the data
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Generate next 3 months starting from current month
            const next3Months = [];
            for (let i = 0; i < 3; i++) {
                const date = new Date(today);
                date.setMonth(date.getMonth() + i);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, "0");
                next3Months.push(`${year}-${month}`);
            }
            
            // Group by month-year and categorize as expired or expiring
            const monthlyData = {};
            
            // Initialize all 3 months
            next3Months.forEach((monthYear) => {
                monthlyData[monthYear] = {
                    expired: [],
                    expiring: [],
                };
            });
            
            filteredData.forEach((row) => {
                const maturityDate = row.Maturity_Date;
                const facilityId = row.Facility_ID;
                
                if (maturityDate && facilityId) {
                    const dateObj = parseDate(maturityDate);
                    if (dateObj) {
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthYear = `${year}-${month}`;
                        
                        // Only include if it's in our next 3 months
                        if (next3Months.includes(monthYear)) {
                            // Categorize based on whether date is past or future
                            if (dateObj < today) {
                                monthlyData[monthYear].expired.push(facilityId);
                            } else {
                                monthlyData[monthYear].expiring.push(facilityId);
                            }
                        }
                    }
                }
            });
            
            // Prepare data for the next 3 months
            const categories = next3Months.map((m) => {
                const date = new Date(m + "-01");
                return date.toLocaleDateString("en-US", { month: "short" });
            });

            const expiredData = next3Months.map(
                (month) => monthlyData[month].expired.length
            );
            const expiringData = next3Months.map(
                (month) => monthlyData[month].expiring.length
            );
            
            const options = {
                series: [
                    {
                        name: "Expired",
                        data: expiredData,
                    },
                    {
                        name: "Expiring",
                        data: expiringData,
                    },
                ],
                colors: ["#93a8ff", "#465fff"],
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "bar",
                    stacked: false,
                    height: "100%",
                    toolbar: {
                        show: false,
                    },
                    zoom: {
                        enabled: false,
                    },
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: "55%",
                        borderRadius: 8,
                        borderRadiusApplication: "end",
                        dataLabels: {
                            position: 'top',
                        },
                    },
                },
                dataLabels: {
                    enabled: true,
                    offsetY: -30,
                    style: {
                        fontSize: '11px',
                        fontWeight: 500,
                        colors: ['#374151']
                    },
                    background: {
                        enabled: true,
                        foreColor: '#374151',
                        backgroundColor: '#F3F4F6',
                        borderRadius: 12,
                        padding: 8,
                        opacity: 1,
                        borderWidth: 0
                    },
                    formatter: function(val, opts) {
                        return val;
                    }
                },
                xaxis: {
                    categories: categories,
                    axisBorder: {
                        show: false,
                    },
                    axisTicks: {
                        show: false,
                    },
                    labels: {
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                },
                legend: {
                    show: true,
                    position: "top",
                    horizontalAlign: "center",
                    fontFamily: "Outfit, sans-serif",
                    fontSize: "12px",
                    markers: {
                        width: 12,
                        height: 12,
                        radius: 3,
                    },
                    itemMargin: {
                        horizontal: 10,
                        vertical: 0,
                    },
                },
                yaxis: {
                    title: false,
                    labels: {
                        align: 'left',
                        offsetX: -10,
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                },
                grid: {
                    borderColor: '#E5E7EB',
                    strokeDashArray: 4,
                    xaxis: {
                        lines: {
                            show: true,
                        },
                    },
                    yaxis: {
                        lines: {
                            show: false,
                        },
                    },
                },
                fill: {
                    opacity: 1,
                },
                tooltip: {
                    theme: "light",
                    style: {
                        fontSize: "12px",
                        fontFamily: "Outfit, sans-serif",
                    },
                    x: {
                        show: false,
                    },
                    y: {
                        formatter: function (val) {
                            return val + " facilities";
                        },
                    },
                },
            };

            const chartElement = document.querySelector("#facilityMaturityChart");
            if (!chartElement) {
                console.error("Facility maturity chart element not found");
                return;
            }
            
            if (typeof ApexCharts === "undefined") {
                console.error("ApexCharts library not loaded");
                return;
            }
            
            try {
                if (facilityMaturityChartInstance) {
                    facilityMaturityChartInstance.destroy();
                    facilityMaturityChartInstance = null;
                }
                
                chartElement.innerHTML = "";
                
                facilityMaturityChartInstance = new ApexCharts(chartElement, options);
                facilityMaturityChartInstance.render();
                console.log(
                    " Filtered facility maturity chart rendered successfully"
                );
            } catch (error) {
                console.error(
                    " Error rendering filtered facility maturity chart:",
                    error
                );
            }
        }

        // Create relationship chart from filtered data (OPTIMIZED)
        function createRelationshipChartFromFiltered() {
            const startTime = performance.now();
            const topN = parseInt(document.getElementById("topNFilter").value);
            
            // Use amount type based on filter selection
            let fieldName, seriesName;
            switch (selectedAmountType) {
                case "direct":
                    fieldName = "Direct_OS";
                    seriesName = "Direct OS";
                    break;
                case "contingent":
                    fieldName = "Contingent_OS";
                    seriesName = "Contingent OS";
                    break;
                case "pse":
                    fieldName = "PSE_OS";
                    seriesName = "PSE OS";
                    break;
                case "osuc":
                    fieldName = "OSUC";
                    seriesName = "OSUC";
                    break;
                case "unused":
                    fieldName = "Unused_Committed";
                    seriesName = "Undrawn Commitment";
                    break;
                case "tfa":
                    fieldName = "Fac_Amount";
                    seriesName = "Total Facility Amount";
                    break;
                default:
                    fieldName = "Direct_OS";
                    seriesName = "Direct OS";
            }

            console.log(
                "Creating filtered relationship chart, field:",
                fieldName,
                "dataLength:",
                filteredData.length
            );
            
            // Use Map for better performance - store all exposure types
            const relationshipData = new Map();

            // Debug: Sample a few rows to see what we're working with
            if (filteredData.length > 0 && selectedAmountType === "tfa") {
                console.log("DEBUG - Sample first 3 rows of filteredData:");
                for (let i = 0; i < Math.min(3, filteredData.length); i++) {
                    console.log(`Row ${i}:`, {
                        Relationship_Name: filteredData[i].Relationship_Name,
                        Fac_Amount: filteredData[i].Fac_Amount,
                        Facility_Amount: filteredData[i].Facility_Amount,
                        TFA_field_used: filteredData[i].Fac_Amount || filteredData[i].Facility_Amount,
                        TFA_parsed: parseNumber(filteredData[i].Fac_Amount || filteredData[i].Facility_Amount),
                        Direct_OS: filteredData[i].Direct_OS,
                        Direct_OS_parsed: parseNumber(filteredData[i].Direct_OS)
                    });
                }

                // Count how many rows have non-zero TFA
                let nonZeroCount = 0;
                let totalFacilityAmount = 0;
                for (let i = 0; i < filteredData.length; i++) {
                    const val = parseNumber(filteredData[i].Fac_Amount || filteredData[i].Facility_Amount);
                    if (val > 0) {
                        nonZeroCount++;
                        totalFacilityAmount += val;
                    }
                }
                console.log(`DEBUG - ${nonZeroCount} out of ${filteredData.length} rows have non-zero TFA`);
                console.log(`DEBUG - Total TFA across all rows: ${formatCurrency(totalFacilityAmount)}`);
            }
            
            for (let i = 0; i < filteredData.length; i++) {
                const row = filteredData[i];
                const relId = row.Relationship_Name || row.Relationship_ID;
                
                if (relId) {
                    if (!relationshipData.has(relId)) {
                        relationshipData.set(relId, {
                            tfa: 0,
                            direct: 0,
                            contingent: 0,
                            pse: 0,
                            osuc: 0,
                            unused: 0,
                            facilityCount: 0,
                        });
                    }
                    
                    const data = relationshipData.get(relId);
                    data.tfa += parseNumber(row.Fac_Amount || row.Facility_Amount);
                    data.direct += parseNumber(row.Direct_OS);
                    data.contingent += parseNumber(row.Contingent_OS);
                    data.pse += parseNumber(row.PSE_OS);
                    data.osuc += parseNumber(row.OSUC);
                    data.unused += parseNumber(row.Unused_Committed);
                    if (row.Facility_ID) data.facilityCount++;
                }
            }
            
            console.log(
                "Total unique filtered relationships:",
                relationshipData.size
            );
            
            // Get the selected field value for sorting
            const relationshipTotals = new Map();
            for (const [relId, data] of relationshipData.entries()) {
                let sortValue = 0;
                switch (selectedAmountType) {
                    case "tfa":
                        sortValue = data.tfa;
                        break;
                    case "direct":
                        sortValue = data.direct;
                        break;
                    case "contingent":
                        sortValue = data.contingent;
                        break;
                    case "pse":
                        sortValue = data.pse;
                        break;
                    case "osuc":
                        sortValue = data.osuc;
                        break;
                    case "unused":
                        sortValue = data.unused;
                        break;
                    default:
                        sortValue = data.direct;
                }
                relationshipTotals.set(relId, sortValue);
            }
            
            // Convert to array and sort
            const sorted = Array.from(relationshipTotals.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, topN);
            
            console.log(
                `Filtered chart aggregated ${filteredData.length} rows, found ${relationshipData.size
                } relationships in ${(performance.now() - startTime).toFixed(2)}ms`
            );
            
            // Add index numbers (1, 2, 3, ...) before relationship names
            const relationships = sorted.map(
                (item, index) => `${index + 1}. ${item[0]}`
            );
            const amounts = sorted.map((item) => item[1]);

            // Debug logging for TFA
            console.log("DEBUG - selectedAmountType:", selectedAmountType);
            console.log("DEBUG - seriesName:", seriesName);
            console.log("DEBUG - relationships:", relationships);
            console.log("DEBUG - amounts:", amounts);
            console.log("DEBUG - sorted array:", sorted);
            
            // Handle empty data
            if (relationships.length === 0) {
                console.warn("No filtered relationship data for chart");
                const chartElement = document.querySelector("#relationshipChart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('Top Relationships');
                }
                return;
            }

            // Check if all amounts are zero
            const totalAmount = amounts.reduce((sum, val) => sum + val, 0);
            if (totalAmount === 0) {
                console.warn(" All amounts are zero for selectedAmountType:", selectedAmountType);
                const chartElement = document.querySelector("#relationshipChart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('Top Relationships');
                }
                return;
            }

            // Calculate dynamic height based on number of relationships (35px per bar, min 350px)
            const calculatedHeight = Math.max(350, relationships.length * 35);
            
            const options = {
                series: [
                    {
                    name: seriesName,
                        data: amounts,
                    },
                ],
                colors: ["#465fff"],
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "bar",
                    height: calculatedHeight,
                    toolbar: {
                        show: false,
                    },
                    events: {
                        // Chart click filtering disabled
                    },
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        borderRadius: 5,
                        borderRadiusApplication: "end",
                        dataLabels: {
                            position: 'top',
                        },
                    },
                },
                dataLabels: {
                    enabled: true,
                    textAnchor: 'start',
                    offsetX: 30,
                    style: {
                        fontSize: '11px',
                        fontWeight: 500,
                        colors: ['#374151']
                    },
                    background: {
                        enabled: true,
                        foreColor: '#374151',
                        backgroundColor: '#F3F4F6',
                        borderRadius: 12,
                        padding: 8,
                        opacity: 1,
                        borderWidth: 0
                    },
                    formatter: function(val) {
                        return formatCurrency(val);
                    }
                },
                stroke: {
                    show: true,
                    width: 4,
                    colors: ["transparent"],
                },
                xaxis: {
                    categories: relationships,
                    labels: {
                        formatter: function (val) {
                            return formatCurrency(val);
                        },
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                    axisBorder: {
                        show: false,
                    },
                    axisTicks: {
                        show: false,
                    },
                },
                yaxis: {
                    title: false,
                    labels: {
                        align: 'left',
                        offsetX: -10,
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                },
                legend: {
                    show: true,
                    position: "top",
                    horizontalAlign: "left",
                    fontFamily: "Outfit, sans-serif",
                    fontSize: "12px",
                    markers: {
                        radius: 12,
                    },
                },
                grid: {
                    borderColor: '#E5E7EB',
                    strokeDashArray: 4,
                    xaxis: {
                        lines: {
                            show: true,
                        },
                    },
                    yaxis: {
                        lines: {
                            show: false,
                        },
                    },
                },
                fill: {
                    opacity: 1,
                },
                tooltip: {
                    theme: "light",
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        const relName = sorted[dataPointIndex][0]; // Get original name without index
                        const data = relationshipData.get(relName);
                        
                        if (!data) return "";
                        
                        let html = `<div class="apexcharts-tooltip-custom" style="padding: 12px; min-width: 220px; background: #ffffff; color: #1f2937; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border: 1px solid #e5e7eb;">`;
                        html += `<div style="font-weight: 600; margin-bottom: 8px; font-size: 13px; color: #1f2937;">${relName}</div>`;
                        html += `<div style="font-size: 11px; color: #666;">`;
                        html += `<div style="margin-bottom: 4px;"><strong>${data.facilityCount}</strong> Facilities</div>`;
                        html += `<div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #e5e7eb;">`;
                        html += `<div>TFA: ${formatCurrency(data.tfa)}</div>`;
                        html += `<div>Direct: ${formatCurrency(data.direct)}</div>`;
                        if (data.contingent > 0) {
                            html += `<div>Contingent: ${formatCurrency(
                                data.contingent
                            )}</div>`;
                        }
                        if (data.pse > 0) {
                            html += `<div>Presettlement Exposure: ${formatCurrency(
                                data.pse
                            )}</div>`;
                        }
                        html += `</div></div></div>`;
                        return html;
                    },
                },
            };

            // Get the chart element and verify it exists
                const chartElement = document.querySelector("#relationshipChart");
                if (!chartElement) {
                console.error(
                    "Filtered relationship chart element #relationshipChart not found in DOM"
                );
                    return;
                }
                
            // Verify ApexCharts is loaded
            if (typeof ApexCharts === "undefined") {
                console.error("ApexCharts library not loaded");
                return;
            }
            
            try {
                // Destroy previous instance
                if (relationshipChartInstance) {
                    relationshipChartInstance.destroy();
                    relationshipChartInstance = null;
                }
                
                // Clear any previous content to avoid ApexCharts errors
                chartElement.innerHTML = "";

                // Log chart options for debugging
                console.log("DEBUG - Chart options series:", options.series);
                console.log("DEBUG - Chart options xaxis categories:", options.xaxis.categories);
                
                // Create and render new chart
                relationshipChartInstance = new ApexCharts(chartElement, options);
                relationshipChartInstance.render();
                console.log(
                    " Filtered relationship chart rendered successfully with",
                    relationships.length,
                    "relationships"
                );
            } catch (error) {
                console.error(
                    " Error creating filtered relationship chart:",
                    error
                );
                console.error("Error details:", error.message, error.stack);
            }
        }

        // Smart Filter Functions
        
        // Flag to prevent multiple filter applications during batch operations
        let isResettingFilters = false;
        
        // Select Region Filter (optimized)
        function selectRegionFilter(region) {
            selectedRegion = region;
            
            // Update button styles using helper
            updateRegionButtonsUI(region);
            
            // Only apply filters if not in batch reset mode
            if (!isResettingFilters) {
            updateFilterCount();
            applyFilters();
            }
        }
        
        // Handle Main Search (Enter key or search button)
        function handleMainSearch(searchTerm) {
            const trimmedSearch = searchTerm ? searchTerm.trim() : '';
            console.log(' Main search triggered:', trimmedSearch);
            
            selectedSearchTerm = trimmedSearch;
            
            // Update active filters badges
            updateFilterCount();
            
            // Apply filters
            applyFilters();
        }
        
        // Clear search filter
        function clearSearchFilter() {
            selectedSearchTerm = '';
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
            }
            updateFilterCount();
            applyFilters();
        }
        
        // Select PSE Filter (optimized)
        function selectPSEFilter(pse) {
            selectedPSE = pse;
            
            // Update button styles using helper
            updatePSEButtonsUI(pse);
            
            // Only apply filters if not in batch reset mode
            if (!isResettingFilters) {
            updateFilterCount();
            applyFilters();
            }
        }
        
        // Select Status Filter (CM/DM) - optimized
        function selectStatusFilter(status) {
            selectedStatus = status;
            
            // Update button styles using helper
            updateStatusButtonsUI(status);
            
            // Only apply filters if not in batch reset mode
            if (!isResettingFilters) {
            updateFilterCount();
            applyFilters();
            }
        }
        
        // Select Commitment Status Filter (Committed/Uncommitted) - optimized
        function selectCommitmentFilter(commitment) {
            selectedCommitmentStatus = commitment;
            
            // Update button styles using helper
            updateCommitmentButtonsUI(commitment);
            
            // Only apply filters if not in batch reset mode
            if (!isResettingFilters) {
            updateFilterCount();
            applyFilters();
            }
        }
        
        // Select Amount Type Filter (Direct/Contingent/PSE/OSUC/Unused/TFA) - optimized
        function selectAmountTypeFilter(type) {
            selectedAmountType = type;
            
            // Update button styles using helper
            updateAmountTypeButtonsUI(type);
            
            // Update chart titles
            updateAmountTypeTitles(type);
            
            // Update Alpine.js dropdown state if it exists
            const exposureDropdown = document.querySelector('[x-data*="openExposure"]');
            if (exposureDropdown && exposureDropdown.__x) {
                exposureDropdown.__x.$data.exposureType = type;
            }

            console.log("Amount Type filter:", type);
            
            // Only refresh charts if not in batch reset mode
            if (!isResettingFilters) {
                // Refresh the Top Relationships chart and ROTCE chart (both tabs should sync)
            if (areFiltersActive()) {
                createRelationshipChartFromFiltered();
                createROTCEChartFromFiltered();
            } else {
                createRelationshipChart();
                createROTCEChart();
            }
        }
        }
        
        // Helper: Update amount type chart titles
        function updateAmountTypeTitles(type) {
            const titleElement = document.getElementById("topRelationshipsTitle");
            const subtitleElement = document.getElementById("topRelationshipsSubtitle");
            
            const exposureNames = {
                direct: "Direct OS",
                contingent: "Contingent OS",
                pse: "Presettlement Exposure",
                osuc: "OSUC",
                unused: "Undrawn Commitment",
                tfa: "Total Facility Amount"
            };
            
            const exposureName = exposureNames[type] || exposureNames.direct;
            
            if (titleElement) titleElement.textContent = "Top Relationships";
            if (subtitleElement) subtitleElement.textContent = `Top relationships by exposure type - ${exposureName}`;
        }
        
        // Reset All Filters (OPTIMIZED - batch UI updates, single filter application)
        function resetAllFilters() {
            console.log(' Resetting all filters...');
            const startTime = performance.now();
            
            // Set flag to prevent intermediate filter applications
            isResettingFilters = true;
            
            // Reset smart filters to default values (no UI updates yet)
            selectedRegion = "all";
            selectedPSE = "all";
            selectedStatus = "all";
            selectedCommitmentStatus = "all";
            selectedAmountType = "osuc";
            selectedSearchTerm = ""; // Reset search
            
            // Clear search input
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
            }
            
            // Batch UI updates using requestAnimationFrame for smooth rendering
            requestAnimationFrame(() => {
                // Reset region buttons UI (both tabs) - UI only, no filter application
                updateRegionButtonsUI("all");
            
                // Reset PSE buttons UI - UI only
                updatePSEButtonsUI("all");
            
                // Reset status buttons UI (both tabs) - UI only
                updateStatusButtonsUI("all");
            
                // Reset commitment status buttons UI - UI only
                updateCommitmentButtonsUI("all");
            
                // Reset amount type buttons UI - UI only
                updateAmountTypeButtonsUI("osuc");
            
                // Update Alpine.js dropdown state for exposure type
                const exposureDropdown = document.querySelector('[x-data*="openExposure"]');
                if (exposureDropdown && exposureDropdown.__x) {
                    exposureDropdown.__x.$data.exposureType = 'osuc';
                }
            
            // Reset search
            const searchInput = document.getElementById("searchInput");
            if (searchInput) {
                searchInput.value = "";
            }
            
                // Reset advanced filter dropdowns in single loop
            const filterIds = [
                    "filterProductProgram", "filterExtendingUnit", "filterFacilityType",
                    "filterCommitment", "filterTeamLead", "filterUnderwriter",
                    "filterCAMaturity", "filterFacilityMaturity"
            ];
            filterIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = "";
            });
            
            // Clear active filters object
            activeFilters = {};
            displayFilterBadges();
            updateFilterCount();
            
                // Clear flag and apply filters ONCE
                isResettingFilters = false;
                
                // Use setTimeout to allow UI to update before heavy processing
                setTimeout(() => {
                    applyFilters();
                    const elapsed = (performance.now() - startTime).toFixed(0);
                    console.log(` All filters reset in ${elapsed}ms`);
            showNotification("Success", "All filters have been reset", "success");
                }, 10);
            });
        }
        
        // Helper: Update region buttons UI only (no filter application) - Portfolio Overview only
        function updateRegionButtonsUI(region) {
            const regions = ["All", "APAC", "EMEA", "LATAM", "NAM"];
            regions.forEach((r) => {
                const minWidth = r === "LATAM" ? "min-w-[60px]" : "min-w-[50px]";
                const activeClass = `${minWidth} px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white`;
                const inactiveClass = `${minWidth} px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900`;
                const isActive = r.toLowerCase() === region.toLowerCase();
                
                const btn = document.getElementById(`btnRegion${r}`);
                if (btn) btn.className = isActive ? activeClass : inactiveClass;
            });
        }
        
        // Helper: Update PSE buttons UI only (no filter application)
        function updatePSEButtonsUI(pse) {
            const pseOptions = ["All", "PSE", "NonPSE"];
            pseOptions.forEach((p) => {
                const minWidth = p === "NonPSE" ? "min-w-[75px]" : "min-w-[50px]";
                const activeClass = `${minWidth} px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white`;
                const inactiveClass = `${minWidth} px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900`;
                
                // Map the comparison value
                let compareValue = p.toLowerCase();
                if (p === "NonPSE") compareValue = "non-pse";
                
                const isActive = compareValue === pse.toLowerCase();
                
                const btn = document.getElementById(`btnPSE${p}`);
                if (btn) btn.className = isActive ? activeClass : inactiveClass;
            });
        }
        
        // Helper: Update status buttons UI only (no filter application) - Portfolio Overview only
        function updateStatusButtonsUI(status) {
            const statuses = ["All", "CM", "DM"];
            statuses.forEach((s) => {
                const activeClass = "min-w-[45px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white";
                const inactiveClass = "min-w-[45px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900";
                const isActive = s.toLowerCase() === status.toLowerCase();
                
                const btn = document.getElementById(`btnStatus${s}`);
                if (btn) btn.className = isActive ? activeClass : inactiveClass;
            });
        }
        
        // Helper: Update commitment status buttons UI only (no filter application)
        function updateCommitmentButtonsUI(commitment) {
            const commitments = { All: "all", Committed: "Committed", Uncommitted: "Uncommitted" };
            Object.keys(commitments).forEach((key) => {
                const value = commitments[key];
                const minWidth = key === "All" ? "45px" : key === "Committed" ? "85px" : "100px";
                const activeClass = `min-w-[${minWidth}] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white`;
                const inactiveClass = `min-w-[${minWidth}] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900`;
                const isActive = value.toLowerCase() === commitment.toLowerCase();
                
                const btn = document.getElementById(`btnCommitment${key}`);
                if (btn) btn.className = isActive ? activeClass : inactiveClass;
            });
        }
        
        // Helper: Update amount type buttons UI only (no filter application) - Portfolio Overview only
        function updateAmountTypeButtonsUI(type) {
            const types = { 
                Direct: { id: "direct", minWidth: "65px" },
                Contingent: { id: "contingent", minWidth: "80px" },
                PSE: { id: "pse", minWidth: "50px" },
                OSUC: { id: "osuc", minWidth: "60px" },
                Unused: { id: "unused", minWidth: "90px" },
                TFA: { id: "tfa", minWidth: "50px" },
            };
            
            Object.keys(types).forEach((t) => {
                const minWidth = types[t].minWidth;
                const activeClass = `min-w-[${minWidth}] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white`;
                const inactiveClass = `min-w-[${minWidth}] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900`;
                const isActive = types[t].id === type;
                
                const btn = document.getElementById(`btnAmount${t}`);
                if (btn) btn.className = isActive ? activeClass : inactiveClass;
            });
        }
        
        
        // Export Functions
        
        function exportToExcel() {
            try {
                // Prepare data for export
                const exportData = filteredData.map((row) => ({
                    "Report Date": formatDate(row.Report_Date),
                    Region: row.Region || "",
                    "Facility ID": row.Facility_ID || "",
                    "Relationship Name": row.Relationship_Name || "",
                    "Product Program": row.Product_Program || "",
                    "Facility Amount": parseNumber(row.Fac_Amount),
                    "Direct OS": parseNumber(row.Direct_OS),
                    "Maturity Date": formatDate(row.Maturity_Date),
                    "CA Expiration Date": formatDate(row.CA_Expiration_Date),
                    "Control Unit": row.Control_Unit || "",
                    "Facility Type": row.Facility_Type || "",
                    "Commitment Status": row["Committed/Uncommitted"] || "",
                    "Management Status": row.Management_Status || "",
                    "Team Lead": row.Underwriting_Team_Lead || "",
                    Underwriter: row.Lead_Underwriter || "",
                }));
                
                // Create worksheet
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Portfolio Data");
                
                // Generate filename with timestamp
                const timestamp = new Date().toISOString().split("T")[0];
                const filename = `portfolio_export_${timestamp}.xlsx`;
                
                // Save file
                XLSX.writeFile(wb, filename);
                
                showNotification(
                    "Success",
                    `Data exported to ${filename}`,
                    "success"
                );
            } catch (error) {
                console.error("Export error:", error);
                showNotification("Error", "Failed to export to Excel", "error");
            }
        }
        
        function exportToPDF() {
            showNotification(
                "Info",
                "PDF export functionality coming soon",
                "info"
            );
            // TODO: Implement PDF export using jsPDF
        }
        
        function exportToPPT() {
            showNotification(
                "Info",
                "PowerPoint export functionality coming soon",
                "info"
            );
            // TODO: Implement PPT export using PptxGenJS
        }
        
        function exportToPNG() {
            try {
                const dashboard = document.querySelector(".p-4.md\\:p-6");
                html2canvas(dashboard, {
                    scale: 2,
                    backgroundColor: "#f9fafb",
                    logging: false,
                }).then((canvas) => {
                    const link = document.createElement("a");
                    const timestamp = new Date().toISOString().split("T")[0];
                    link.download = `portfolio_dashboard_${timestamp}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                    showNotification("Success", "Dashboard exported as PNG", "success");
                });
            } catch (error) {
                console.error("PNG export error:", error);
                showNotification("Error", "Failed to export as PNG", "error");
            }
        }
        
        // Update Report Date
        function updateReportDate() {
            if (portfolioData && portfolioData.length > 0) {
                // Get the most recent Report_Date from the data
                let maxDate = null;
                for (let i = 0; i < portfolioData.length; i++) {
                    const dateStr = portfolioData[i].Report_Date;
                    if (dateStr) {
                        // Parse DD/MM/YYYY format from text
                        const date = parseDate(dateStr);
                        if (date && (!maxDate || date > maxDate)) {
                            maxDate = date;
                        }
                    }
                }
                
                if (maxDate) {
                    const formatted = formatDate(maxDate);
                    document.getElementById("reportDate").textContent = formatted;
                } else {
                    // No valid Report_Date found in data
                    document.getElementById("reportDate").textContent = "N/A";
                }
            } else {
                // No data loaded yet
                document.getElementById("reportDate").textContent = "--";
            }
        }

        // Calculate top metrics (OPTIMIZED with caching)
        function calculateMetrics() {
            // Check cache
            if (metricsCache.full) {
                const cached = metricsCache.full;
                document.getElementById("totalRelationships").textContent =
                    cached.relationships.toLocaleString();
                document.getElementById("totalFacilities").textContent =
                    cached.facilities.toLocaleString();
                document.getElementById("totalOSUC").textContent = formatCurrency(
                    cached.osuc
                );
                document.getElementById("totalFacAmount").textContent =
                    formatCurrency(cached.facAmount);
                document.getElementById("totalOutstanding").textContent =
                    formatCurrency(cached.outstanding);
                return;
            }
            
            const startTime = performance.now();
            
            let totalFacAmount = 0;
            let totalOSUC = 0;
            let totalOutstanding = 0;
            const relationships = new Set();
            const facilities = new Set();
            
            // Single pass through data (much faster than multiple passes)
            for (let i = 0; i < portfolioData.length; i++) {
                const row = portfolioData[i];
                
                totalFacAmount += parseNumber(row.Fac_Amount);
                totalOSUC += parseNumber(row.OSUC);
                
                // Total Outstanding from Total_OS column
                totalOutstanding += parseNumber(row.Total_OS);
                
                // Use Relationship_ID for unique count (not Relationship_Name which may have duplicates)
                if (row.Relationship_ID) relationships.add(row.Relationship_ID);
                
                if (row.Facility_ID) facilities.add(row.Facility_ID);
            }
            
            const metrics = {
                relationships: relationships.size,
                facilities: facilities.size,
                osuc: totalOSUC,
                facAmount: totalFacAmount,
                outstanding: totalOutstanding,
            };
            
            // Cache the results
            metricsCache.full = metrics;
            
            document.getElementById("totalRelationships").textContent =
                metrics.relationships.toLocaleString();
            document.getElementById("totalFacilities").textContent =
                metrics.facilities.toLocaleString();
            document.getElementById("totalOSUC").textContent = formatCurrency(
                metrics.osuc
            );
            document.getElementById("totalFacAmount").textContent = formatCurrency(
                metrics.facAmount
            );
            document.getElementById("totalOutstanding").textContent =
                formatCurrency(metrics.outstanding);

            console.log(
                `Metrics calculated in ${(performance.now() - startTime).toFixed(
                    2
                )}ms:`,
                metrics
            );
            
            // Calculate expired metrics
            calculateExpiredMetrics();
            
            // Calculate new deals YTD/MTD metrics
            calculateNewDealsMetrics();

            // Populate pipeline deals table
            populatePipelineTable();

            // Populate Covenant Monitoring data and chart
            populateCovenantMonitoringData();
            createCovenantMonitoringChart('pastDue');
            updateCovenantRegionalTable('pastDue');
            
            // Calculate and display CCM stats
            calculateCCMStats();
            createCCMRegionalChart ();
            updateCCMStats('pastDue');
        }

        // Calculate Facilities Expired and CAs Expired metrics
        function calculateExpiredMetrics() {
            // Get the current report date
            const reportDates = portfolioData
                .map((row) => parseDate(row.Report_Date))
                .filter((d) => d);
            if (reportDates.length === 0) return;
            
            const maxReportDate = new Date(Math.max(...reportDates));
            maxReportDate.setHours(0, 0, 0, 0);
            
            // Count expired facilities and CAs (everything before report date)
            const expiredFacilities = new Set(); // Track unique Facility IDs
            let facilitiesExpiredAmount = 0;
            const expiredCAsAllRegions = new Set(); // Track unique Relationship_IDs for all regions
            const expiredCAsEMEA = new Set(); // Track unique Relationship_IDs for EMEA with CA_Review filter
            let casExpiredAmount = 0;
            
            for (let i = 0; i < portfolioData.length; i++) {
                const row = portfolioData[i];
                const managementStatus = (row.Management_Status || "").toUpperCase();
                
                // Check Facilities Expired (count unique Facility IDs, NO DM exclusion)
                const maturityDate = parseDate(row.Maturity_Date);
                if (
                    maturityDate &&
                    maturityDate < maxReportDate &&
                    row.Facility_ID
                ) {
                    expiredFacilities.add(row.Facility_ID);
                    facilitiesExpiredAmount += parseNumber(
                        row.Fac_Amount || row.Facility_Amount
                    );
                }
                
                // Check CAs Expired (count unique Relationship_IDs for all regions, CM only)
                // For EMEA: also requires CA_Review = "Yes"
                const caExpirationDate = parseDate(row.CA_Expiration_Date);
                const region = (row.Region || "").toUpperCase();
                const caReview = (row.CA_Review || "").trim();
                
                if (
                    caExpirationDate &&
                    caExpirationDate < maxReportDate &&
                    managementStatus === "CM" &&
                    row.Relationship_ID
                ) {
                    if (region === "EMEA") {
                        // For EMEA: require CA_Review = "Yes"
                        if (caReview === "Yes") {
                            expiredCAsEMEA.add(row.Relationship_ID);
                            casExpiredAmount += parseNumber(
                                row.Fac_Amount || row.Facility_Amount
                            );
                        }
                    } else {
                        // For non-EMEA: count all Relationship_IDs
                        expiredCAsAllRegions.add(row.Relationship_ID);
                        casExpiredAmount += parseNumber(
                            row.Fac_Amount || row.Facility_Amount
                        );
                    }
                }
            }
            
            // Combine counts: all non-EMEA Relationship_IDs + EMEA Relationship_IDs (with CA_Review filter)
            const casExpiredCount = expiredCAsAllRegions.size + expiredCAsEMEA.size;
            const facilitiesExpiredCount = expiredFacilities.size;
            
            // Update DOM
            document.getElementById("facilitiesExpiredCount").textContent =
                facilitiesExpiredCount.toLocaleString();
            document.getElementById("casExpiredCount").textContent =
                casExpiredCount.toLocaleString();

            console.log("Expired Metrics:", {
                facilitiesExpired: facilitiesExpiredCount,
                facilitiesExpiredAmount: facilitiesExpiredAmount,
                casExpired: casExpiredCount,
                casExpiredAmount: casExpiredAmount,
            });
        }

        // Calculate New Deals Closed YTD and MTD metrics
        function calculateNewDealsMetrics() {
            // Use reporting month instead of actual current date
            const { monthStart, monthEnd, reportingMonth: repMonth } = getReportingMonthRange();
            const currentYear = repMonth.getFullYear();
            const currentMonth = repMonth.getMonth();
            const reportDay = repMonth.getDate();
            
            // Calculate date ranges based on reporting month
            const ytdStart = new Date(currentYear, 0, 1); // Jan 1 of reporting year
            ytdStart.setHours(0, 0, 0, 0);
            
            const mtdStart = new Date(currentYear, currentMonth, 1); // 1st of reporting month
            mtdStart.setHours(0, 0, 0, 0);
            
            const priorYtdStart = new Date(currentYear - 1, 0, 1); // Jan 1 of prior year
            priorYtdStart.setHours(0, 0, 0, 0);
            const priorYtdEnd = new Date(currentYear - 1, currentMonth, reportDay); // Same date last year
            priorYtdEnd.setHours(23, 59, 59, 999);
            
            const priorMtdStart = new Date(currentYear, currentMonth - 1, 1); // 1st of prior month
            priorMtdStart.setHours(0, 0, 0, 0);
            const priorMtdEnd = new Date(currentYear, currentMonth - 1, reportDay); // Same date prior month
            priorMtdEnd.setHours(23, 59, 59, 999);
            
            // Track unique facilities
            const ytdFacilities = new Set();
            const mtdFacilities = new Set();
            const priorYtdFacilities = new Set();
            const priorMtdFacilities = new Set();
            
            let ytdAmount = 0;
            let mtdAmount = 0;
            let priorYtdAmount = 0;
            let priorMtdAmount = 0;
            
            // Iterate through portfolio data
            for (let i = 0; i < portfolioData.length; i++) {
                const row = portfolioData[i];

                // Always exclude PSE for New Deals metrics
                const pseColumn = row["PSE_non-PSE"] || row.PSE_non_PSE || "";
                const pseValue = String(pseColumn).trim().toUpperCase();
                if (pseValue === "PSE") continue;

                const approvalDate = parseDate(row.Origination_Date);
                const facilityId = row.Facility_ID;
                const facAmount = parseNumber(row.Fac_Amount || row.Facility_Amount);
                
                if (!approvalDate || !facilityId) continue;
                
                // Check YTD (reporting year)
                if (approvalDate >= ytdStart && approvalDate <= repMonth) {
                    if (!ytdFacilities.has(facilityId)) {
                        ytdFacilities.add(facilityId);
                        ytdAmount += facAmount;
                    }
                }
                
                // Check MTD (reporting month)
                if (approvalDate >= mtdStart && approvalDate <= repMonth) {
                    if (!mtdFacilities.has(facilityId)) {
                        mtdFacilities.add(facilityId);
                        mtdAmount += facAmount;
                    }
                }
                
                // Check prior YTD (same period last year)
                if (approvalDate >= priorYtdStart && approvalDate <= priorYtdEnd) {
                    if (!priorYtdFacilities.has(facilityId)) {
                        priorYtdFacilities.add(facilityId);
                        priorYtdAmount += facAmount;
                    }
                }
                
                // Check prior MTD (same period last month)
                if (approvalDate >= priorMtdStart && approvalDate <= priorMtdEnd) {
                    if (!priorMtdFacilities.has(facilityId)) {
                        priorMtdFacilities.add(facilityId);
                        priorMtdAmount += facAmount;
                    }
                }
            }
            
            // Calculate variances
            const ytdVariance = priorYtdFacilities.size > 0 
                ? ((ytdFacilities.size - priorYtdFacilities.size) / priorYtdFacilities.size) * 100 
                : 0;
            const mtdVariance = priorMtdFacilities.size > 0 
                ? ((mtdFacilities.size - priorMtdFacilities.size) / priorMtdFacilities.size) * 100 
                : 0;
            
            // Update UI - YTD
            document.getElementById('newDealsYTD').textContent = ytdFacilities.size.toLocaleString();
            document.getElementById('newDealsYTDAmount').textContent = formatCurrency(ytdAmount);
            
            const ytdVarianceEl = document.getElementById('newDealsYTDVariance');
            updateVarianceDisplay(ytdVarianceEl, ytdVariance);
            
            // Update UI - MTD
            document.getElementById('newDealsMTD').textContent = mtdFacilities.size.toLocaleString();
            document.getElementById('newDealsMTDAmount').textContent = formatCurrency(mtdAmount);
            
            const mtdVarianceEl = document.getElementById('newDealsMTDVariance');
            updateVarianceDisplay(mtdVarianceEl, mtdVariance);
            
            console.log('New Deals Metrics:', {
                ytd: { count: ytdFacilities.size, amount: ytdAmount, variance: ytdVariance.toFixed(1) + '%' },
                mtd: { count: mtdFacilities.size, amount: mtdAmount, variance: mtdVariance.toFixed(1) + '%' },
                priorYtd: { count: priorYtdFacilities.size, amount: priorYtdAmount },
                priorMtd: { count: priorMtdFacilities.size, amount: priorMtdAmount }
            });
        }
        
        // Helper function to update variance display with colors and icons
        function updateVarianceDisplay(element, variance) {
            const absVariance = Math.abs(variance);
            const displayText = absVariance.toFixed(1) + '%';
            
            if (variance > 0) {
                // Positive variance - green
                element.className = 'flex items-center gap-1 rounded-full bg-green-100 py-0.5 pl-2 pr-2.5 text-sm font-medium text-green-600';
                element.innerHTML = `
                    <svg class="fill-current" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M5.56462 1.62393C5.70193 1.47072 5.90135 1.37432 6.12329 1.37432C6.1236 1.37432 6.12391 1.37432 6.12422 1.37432C6.31631 1.37415 6.50845 1.44731 6.65505 1.59381L9.65514 4.5918C9.94814 4.88459 9.94831 5.35947 9.65552 5.65246C9.36273 5.94546 8.88785 5.94562 8.59486 5.65283L6.87329 3.93247L6.87329 10.125C6.87329 10.5392 6.53751 10.875 6.12329 10.875C5.70908 10.875 5.37329 10.5392 5.37329 10.125L5.37329 3.93578L3.65516 5.65282C3.36218 5.94562 2.8873 5.94547 2.5945 5.65248C2.3017 5.35949 2.30185 4.88462 2.59484 4.59182L5.56462 1.62393Z" fill=""></path>
                    </svg>
                    ${displayText}
                `;
            } else if (variance < 0) {
                // Negative variance - red
                element.className = 'flex items-center gap-1 rounded-full bg-red-100 py-0.5 pl-2 pr-2.5 text-sm font-medium text-red-600';
                element.innerHTML = `
                    <svg class="fill-current" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M5.31462 10.3761C5.45194 10.5293 5.65136 10.6257 5.87329 10.6257C5.8736 10.6257 5.8739 10.6257 5.87421 10.6257C6.0663 10.6259 6.25845 10.5527 6.40505 10.4062L9.40514 7.4082C9.69814 7.11541 9.69831 6.64054 9.40552 6.34754C9.11273 6.05454 8.63785 6.05438 8.34486 6.34717L6.62329 8.06753L6.62329 1.875C6.62329 1.46079 6.28751 1.125 5.87329 1.125C5.45908 1.125 5.12329 1.46079 5.12329 1.875L5.12329 8.06422L3.40516 6.34719C3.11218 6.05439 2.6373 6.05454 2.3445 6.34752C2.0517 6.64051 2.05185 7.11538 2.34484 7.40818L5.31462 10.3761Z" fill=""></path>
                    </svg>
                    ${displayText}
                `;
            } else {
                // No change - gray
                element.className = 'flex items-center gap-1 rounded-full bg-gray-100 py-0.5 pl-2 pr-2.5 text-sm font-medium text-gray-600';
                element.textContent = displayText;
            }
        }

        // Calculate New Deals Closed YTD and MTD metrics from filtered data
        function calculateNewDealsMetricsFromFiltered() {
            // Use reporting month instead of actual current date
            const { monthStart, monthEnd, reportingMonth: repMonth } = getReportingMonthRange();
            const currentYear = repMonth.getFullYear();
            const currentMonth = repMonth.getMonth();
            const reportDay = repMonth.getDate();
            
            // Calculate date ranges based on reporting month
            const ytdStart = new Date(currentYear, 0, 1);
            ytdStart.setHours(0, 0, 0, 0);
            
            const mtdStart = new Date(currentYear, currentMonth, 1);
            mtdStart.setHours(0, 0, 0, 0);
            
            const priorYtdStart = new Date(currentYear - 1, 0, 1);
            priorYtdStart.setHours(0, 0, 0, 0);
            const priorYtdEnd = new Date(currentYear - 1, currentMonth, reportDay);
            priorYtdEnd.setHours(23, 59, 59, 999);
            
            const priorMtdStart = new Date(currentYear, currentMonth - 1, 1);
            priorMtdStart.setHours(0, 0, 0, 0);
            const priorMtdEnd = new Date(currentYear, currentMonth - 1, reportDay);
            priorMtdEnd.setHours(23, 59, 59, 999);
            
            // Track unique facilities
            const ytdFacilities = new Set();
            const mtdFacilities = new Set();
            const priorYtdFacilities = new Set();
            const priorMtdFacilities = new Set();
            
            let ytdAmount = 0;
            let mtdAmount = 0;
            let priorYtdAmount = 0;
            let priorMtdAmount = 0;
            
            // Use filtered data if available, otherwise use portfolio data
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
            
            // Iterate through data
            for (let i = 0; i < dataSource.length; i++) {
                const row = dataSource[i];

                // Always exclude PSE for New Deals metrics
                const pseColumn = row["PSE_non-PSE"] || row.PSE_non_PSE || "";
                const pseValue = String(pseColumn).trim().toUpperCase();
                if (pseValue === "PSE") continue;

                const approvalDate = parseDate(row.Origination_Date);
                const facilityId = row.Facility_ID;
                const facAmount = parseNumber(row.Fac_Amount);
                
                if (!approvalDate || !facilityId) continue;
                
                // Check YTD (reporting year)
                if (approvalDate >= ytdStart && approvalDate <= repMonth) {
                    if (!ytdFacilities.has(facilityId)) {
                        ytdFacilities.add(facilityId);
                        ytdAmount += facAmount;
                    }
                }
                
                // Check MTD (reporting month)
                if (approvalDate >= mtdStart && approvalDate <= repMonth) {
                    if (!mtdFacilities.has(facilityId)) {
                        mtdFacilities.add(facilityId);
                        mtdAmount += facAmount;
                    }
                }
                
                // Check prior YTD (same period last year)
                if (approvalDate >= priorYtdStart && approvalDate <= priorYtdEnd) {
                    if (!priorYtdFacilities.has(facilityId)) {
                        priorYtdFacilities.add(facilityId);
                        priorYtdAmount += facAmount;
                    }
                }
                
                // Check prior MTD (same period last month)
                if (approvalDate >= priorMtdStart && approvalDate <= priorMtdEnd) {
                    if (!priorMtdFacilities.has(facilityId)) {
                        priorMtdFacilities.add(facilityId);
                        priorMtdAmount += facAmount;
                    }
                }
            }
            
            // Calculate variances
            const ytdVariance = priorYtdFacilities.size > 0 
                ? ((ytdFacilities.size - priorYtdFacilities.size) / priorYtdFacilities.size) * 100 
                : 0;
            const mtdVariance = priorMtdFacilities.size > 0 
                ? ((mtdFacilities.size - priorMtdFacilities.size) / priorMtdFacilities.size) * 100 
                : 0;
            
            // Update UI - YTD
            document.getElementById('newDealsYTD').textContent = ytdFacilities.size.toLocaleString();
            document.getElementById('newDealsYTDAmount').textContent = formatCurrency(ytdAmount);
            
            const ytdVarianceEl = document.getElementById('newDealsYTDVariance');
            updateVarianceDisplay(ytdVarianceEl, ytdVariance);
            
            // Update UI - MTD
            document.getElementById('newDealsMTD').textContent = mtdFacilities.size.toLocaleString();
            document.getElementById('newDealsMTDAmount').textContent = formatCurrency(mtdAmount);
            
            const mtdVarianceEl = document.getElementById('newDealsMTDVariance');
            updateVarianceDisplay(mtdVarianceEl, mtdVariance);
        }

        function populatePipelineTable() {
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Get the current year for filtering
            const currentYear = today.getFullYear();
            console.log('Pipeline Table - Current Year:', currentYear);

            // Use global excluded facility types constant
            const excludedFacilityTypes = EXCLUDED_FACILITY_TYPES;

            // Define aging buckets (in days) - Always show these 4 rows
            const buckets = [
                { label: '1-30 Days', min: 1, max: 30, count: 0, facilities: new Set(), tfa: 0 },
                { label: '31-60 Days', min: 31, max: 60, count: 0, facilities: new Set(), tfa: 0 },
                { label: '61-90 Days', min: 61, max: 90, count: 0, facilities: new Set(), tfa: 0 },
                { label: '>90 Days', min: 91, max: Infinity, count: 0, facilities: new Set(), tfa: 0 }
            ];

            // Filter and categorize deals
            dataSource.forEach(row => {
                // Always exclude PSE for Deals Pending Closure
                const pseColumn = row["PSE_non-PSE"] || row.PSE_non_PSE || "";
                const pseValue = String(pseColumn).trim().toUpperCase();
                if (pseValue === "PSE") return;

                // Only include NAM and LATAM regions
                const region = String(row.Region || "").trim().toUpperCase();
                if (region !== "NAM" && region !== "LATAM") return;

                // Exclude specific facility types
                const facilityType = String(row.Facility_Type || "").trim();
                if (excludedFacilityTypes.includes(facilityType)) return;

                const originationDate = row.Origination_Date;
                const firstApprovalDate = parseDate(row.Facility_First_Approval_Date);
                const facilityId = row.Facility_ID;
                const tfaAmount = parseNumber(row.Fac_Amount || row.Facility_Amount);

                // Only include deals where:
                // 1. Origination_Date is empty or null
                // 2. Has first approval date
                // 3. Facility_First_Approval_Date is in the current year
                // 4. PSE is excluded (checked above)
                // 5. Only NAM and LATAM regions (checked above)
                // 6. Excluded facility types are filtered out (checked above)
                if ((!originationDate || originationDate.trim() === '') &&
                    firstApprovalDate &&
                    facilityId &&
                    firstApprovalDate.getFullYear() === currentYear) {

                    // Calculate days since approval
                    const daysSinceApproval = Math.floor((today - firstApprovalDate) / (1000 * 60 * 60 * 24));

                    // Find appropriate bucket
                    for (const bucket of buckets) {
                        if (daysSinceApproval >= bucket.min && daysSinceApproval <= bucket.max) {
                            bucket.facilities.add(facilityId);
                            bucket.tfa += tfaAmount;
                            break;
                        }
                    }
                }
            });

            // Update bucket counts from unique facilities
            buckets.forEach(bucket => {
                bucket.count = bucket.facilities.size;
            });

            // Populate table
            const tableBody = document.getElementById('pipelineTableBody');
            if (!tableBody) return;

            // Calculate totals
            const totalCount = buckets.reduce((sum, b) => sum + b.count, 0);
            const totalTFA = buckets.reduce((sum, b) => sum + b.tfa, 0);

            // Build table rows - always show all 4 buckets
            let html = '';
            buckets.forEach(bucket => {
                html += `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-5 py-3 text-sm text-gray-700">${bucket.label}</td>
                        <td class="px-5 py-3 text-sm text-gray-900 font-semibold text-right">${bucket.count.toLocaleString()}</td>
                        <td class="px-5 py-3 text-sm text-gray-900 font-semibold text-right">${formatCurrency(bucket.tfa)}</td>
                    </tr>
                `;
            });

            // Add total row
            html += `
                <tr class="bg-gray-50 font-semibold border-t-2 border-gray-300">
                    <td class="px-5 py-3 text-sm text-gray-900 rounded-bl-xl">Total</td>
                    <td class="px-5 py-3 text-sm text-gray-900 text-right">${totalCount.toLocaleString()}</td>
                    <td class="px-5 py-3 text-sm text-gray-900 text-right rounded-br-xl">${formatCurrency(totalTFA)}</td>
                </tr>
            `;

            tableBody.innerHTML = html;

            console.log('Pipeline Table populated:', {
                currentYear: currentYear,
                totalFacilities: totalCount,
                totalTFA: formatCurrency(totalTFA),
                buckets: buckets.map(b => ({ label: b.label, count: b.count, tfa: formatCurrency(b.tfa) }))
            });
        }
        
        // Pipeline Details Table - Status Filter (DM/CM)
        let pipelineStatusFilter = 'all'; // Global variable to track selected status filter
        let pipelineTableSearchTerm = ''; // Global variable for search term
        let pipelineTableCurrentPage = 1;
        let pipelineTablePerPage = 10;
        let pipelineTableData = []; // Store filtered data
        
        function selectPipelineStatusFilter(status) {
            console.log(' selectPipelineStatusFilter called with:', status);
            console.log(' Before update - pipelineStatusFilter was:', pipelineStatusFilter);
            pipelineStatusFilter = status;
            console.log(' After update - pipelineStatusFilter is now:', pipelineStatusFilter);
            
            // Update button styles
            const buttons = {
                'all': document.getElementById('btnPipelineStatusAll'),
                'CM': document.getElementById('btnPipelineStatusCM'),
                'DM': document.getElementById('btnPipelineStatusDM')
            };
            
            console.log(' Button elements found:', {
                all: !!buttons.all,
                CM: !!buttons.CM,
                DM: !!buttons.DM
            });
            
            Object.keys(buttons).forEach(key => {
                const btn = buttons[key];
                if (btn) {
                    if (key === status) {
                        btn.className = 'min-w-[45px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white';
                        console.log(` Activated button: ${key}`);
                    } else {
                        btn.className = 'min-w-[45px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900';
                    }
                }
            });
            
            // Reset to page 1 and re-render
            window.pipelineTableState.currentPage = 1;
            console.log(' Calling renderPipelineDetailsTable with filter:', pipelineStatusFilter);
            renderPipelineDetailsTable();
        }
        
        function updatePipelineTableSearch(searchValue) {
            window.pipelineTableState.searchQuery = searchValue.toLowerCase();
            window.pipelineTableState.currentPage = 1;
            renderPipelineDetailsTable();
        }
        
        function updatePipelineTablePerPage(perPage) {
            window.pipelineTableState.perPage = perPage;
            window.pipelineTableState.currentPage = 1;
            renderPipelineDetailsTable();
        }
        
        function changePipelineTablePage(direction) {
            const state = window.pipelineTableState;
            if (direction === 'next') {
                const totalPages = Math.ceil(state.allData.length / state.perPage);
                if (state.currentPage < totalPages) {
                    state.currentPage++;
                }
            } else if (direction === 'prev' && state.currentPage > 1) {
                state.currentPage--;
            }
            renderPipelineDetailsTable();
        }
        
        function sortPipelineTable(column) {
            const state = window.pipelineTableState;
            if (state.sortColumn === column) {
                state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                state.sortColumn = column;
                state.sortDirection = 'asc';
            }
            renderPipelineDetailsTable();
        }
        
        function togglePipelineFilterDropdown(column, event) {
            event.stopPropagation();
            const state = window.pipelineTableState;
            if (state.openFilterColumn === column) {
                state.openFilterColumn = null;
            } else {
                state.openFilterColumn = column;
            }
            renderPipelineDetailsTable();
        }
        
        function applyPipelineColumnFilter(column) {
            const state = window.pipelineTableState;
            const container = document.getElementById(`pipelineFilterValues_${column}`);
            if (!container) return;
            
            // Collect all checked values
            const checkboxes = container.querySelectorAll('.pipeline-filter-checkbox[data-column="' + column + '"]');
            const selectedValues = [];
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const rawValue = checkbox.dataset.value;
                    // Parse value to correct type - numbers for tfa/days, strings for others
                    let parsedValue;
                    if (column === 'tfa' || column === 'days') {
                        parsedValue = parseFloat(rawValue);
                    } else {
                        parsedValue = rawValue;
                    }
                    selectedValues.push(parsedValue);
                }
            });
            
            // Update state
            if (selectedValues.length > 0) {
                state.columnFilters[column] = selectedValues;
            } else {
                delete state.columnFilters[column];
            }
            
            state.currentPage = 1;
            state.openFilterColumn = null;
            renderPipelineDetailsTable();
        }
        
        function togglePipelineColumnFilter(column, value) {
            const state = window.pipelineTableState;
            if (!state.columnFilters[column]) {
                state.columnFilters[column] = [];
            }
            const index = state.columnFilters[column].indexOf(value);
            if (index > -1) {
                state.columnFilters[column].splice(index, 1);
                if (state.columnFilters[column].length === 0) {
                    delete state.columnFilters[column];
                }
            } else {
                state.columnFilters[column].push(value);
            }
            state.currentPage = 1;
            state.openFilterColumn = null;
            renderPipelineDetailsTable();
        }
        
        function clearPipelineColumnFilter(column) {
            const state = window.pipelineTableState;
            delete state.columnFilters[column];
            state.currentPage = 1;
            state.openFilterColumn = null;
            renderPipelineDetailsTable();
        }
        
        function filterPipelineDropdownValues(column) {
            const searchInput = document.getElementById(`pipelineFilterSearch_${column}`);
            if (!searchInput) return;
            
            const searchValue = searchInput.value.toLowerCase();
            const container = document.getElementById(`pipelineFilterValues_${column}`);
            if (!container) return;
            
            const items = container.querySelectorAll('.pipeline-filter-value-item');
            items.forEach(item => {
                const value = item.dataset.value || '';
                if (value.includes(searchValue)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function clearAllPipelineFilters() {
            pipelineStatusFilter = 'all';
            const state = window.pipelineTableState;
            state.searchQuery = '';
            state.columnFilters = {};
            state.sortColumn = 'tfa';
            state.sortDirection = 'desc';
            state.currentPage = 1;
            
            // Reset button styles
            selectPipelineStatusFilter('all');
            
            // Clear search input
            const searchInput = document.getElementById('pipelineTableSearch');
            if (searchInput) searchInput.value = '';
            
            renderPipelineDetailsTable();
        }
        
        function renderPipelineDetailsTable() {
            console.log(' renderPipelineDetailsTable called');
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
            const tbody = document.getElementById('pipelineDetailsTableBody');
            const thead = document.getElementById('pipelineDetailsTableHeader');
            
            if (!tbody || !thead) return;
            
            const state = window.pipelineTableState;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const currentYear = today.getFullYear();
            const excludedFacilityTypes = EXCLUDED_FACILITY_TYPES;
            
            // Collect all pending deals
            const pendingDeals = [];
            
            dataSource.forEach(row => {
                // Apply pipeline filters
                const pseColumn = row["PSE_non-PSE"] || row.PSE_non_PSE || "";
                const pseValue = String(pseColumn).trim().toUpperCase();
                if (pseValue === "PSE") return;
                
                const region = String(row.Region || "").trim().toUpperCase();
                if (region !== "NAM" && region !== "LATAM") return;
                
                const facilityType = String(row.Facility_Type || "").trim();
                if (excludedFacilityTypes.includes(facilityType)) return;
                
                const originationDate = row.Origination_Date;
                const firstApprovalDate = parseDate(row.Facility_First_Approval_Date);
                const facilityId = row.Facility_ID;
                
                if ((!originationDate || originationDate.trim() === '') &&
                    firstApprovalDate &&
                    facilityId &&
                    firstApprovalDate.getFullYear() === currentYear) {
                    
                    const daysSinceApproval = Math.floor((today - firstApprovalDate) / (1000 * 60 * 60 * 24));
                    
                    // Determine aging bucket
                    let agingBucket = '';
                    if (daysSinceApproval >= 1 && daysSinceApproval <= 30) agingBucket = '1-30 Days';
                    else if (daysSinceApproval >= 31 && daysSinceApproval <= 60) agingBucket = '31-60 Days';
                    else if (daysSinceApproval >= 61 && daysSinceApproval <= 90) agingBucket = '61-90 Days';
                    else if (daysSinceApproval > 90) agingBucket = '>90 Days';
                    
                    // Get management status from various possible field names
                    const managementStatus = row.Management_Status || row['DM/CM'] || row.DM_CM || row['Management Status'] || 'N/A';
                    
                    pendingDeals.push({
                        facilityId: facilityId,
                        relationship: row.Relationship_Name || 'Unknown',
                        underwriter: row.Lead_Underwriter || 'Unknown',
                        aging: agingBucket,
                        days: daysSinceApproval,
                        tfa: parseNumber(row.Fac_Amount || row.Facility_Amount),
                        region: region,
                        managementStatus: managementStatus.trim()
                    });
                }
            });
            
            console.log(' Pipeline Details Table - Total pending deals:', pendingDeals.length);
            
            // Store items before filtering for header unique values
            const itemsBeforeFilters = pendingDeals;
            
            // Apply DM/CM filter (from buttons)
            let filteredDeals = pendingDeals;
            if (pipelineStatusFilter !== 'all') {
                filteredDeals = pendingDeals.filter(deal => {
                    const status = String(deal.managementStatus || '').trim().toUpperCase();
                    return status.includes(pipelineStatusFilter.toUpperCase());
                });
                console.log(` DM/CM filter applied: ${pipelineStatusFilter}, filtered from ${pendingDeals.length} to ${filteredDeals.length} deals`);
            }
            
            // Apply search filter
            if (state.searchQuery) {
                filteredDeals = filteredDeals.filter(deal => {
                    const searchStr = `${deal.facilityId} ${deal.relationship} ${deal.underwriter} ${deal.region}`.toLowerCase();
                    return searchStr.includes(state.searchQuery);
                });
            }
            
            // Apply column filters
            if (state.columnFilters && Object.keys(state.columnFilters).length > 0) {
                filteredDeals = filteredDeals.filter(deal => {
                    for (const [column, filters] of Object.entries(state.columnFilters)) {
                        if (filters && filters.length > 0) {
                            let itemValue = deal[column];
                            if (!filters.includes(itemValue)) {
                                return false;
                            }
                        }
                    }
                    return true;
                });
            }
            
            // Apply sorting
            if (state.sortColumn) {
                filteredDeals.sort((a, b) => {
                    const modifier = state.sortDirection === 'asc' ? 1 : -1;
                    const aVal = a[state.sortColumn];
                    const bVal = b[state.sortColumn];
                    
                    // Handle numeric comparison for TFA and days
                    if (state.sortColumn === 'tfa' || state.sortColumn === 'days') {
                        return (aVal - bVal) * modifier;
                    }
                    
                    // String comparison
                    if (aVal < bVal) return -1 * modifier;
                    if (aVal > bVal) return 1 * modifier;
                    return 0;
                });
            } else {
                // Default sort by TFA descending
                filteredDeals.sort((a, b) => b.tfa - a.tfa);
            }
            
            // Store all filtered data
            state.allData = filteredDeals;
            
            // Pagination
            const totalRecords = filteredDeals.length;
            const totalPages = Math.ceil(totalRecords / state.perPage);
            const startIndex = (state.currentPage - 1) * state.perPage;
            const endIndex = Math.min(startIndex + state.perPage, totalRecords);
            const paginatedDeals = filteredDeals.slice(startIndex, endIndex);
            
            // Update pagination info
            document.getElementById('pipelineTableStart').textContent = totalRecords > 0 ? startIndex + 1 : 0;
            document.getElementById('pipelineTableEnd').textContent = endIndex;
            document.getElementById('pipelineTableTotal').textContent = totalRecords;
            document.getElementById('pipelineTableCurrentPage').textContent = state.currentPage;
            document.getElementById('pipelineTableTotalPages').textContent = Math.max(1, totalPages);
            
            // Update pagination buttons
            const prevBtn = document.getElementById('pipelineTablePrevBtn');
            const nextBtn = document.getElementById('pipelineTableNextBtn');
            if (prevBtn) prevBtn.disabled = state.currentPage === 1;
            if (nextBtn) nextBtn.disabled = state.currentPage >= totalPages;
            
            // Update Clear All Filters button visibility and count
            const clearAllBtn = document.getElementById('btnClearAllPipelineFilters');
            const activeFiltersCount = Object.values(state.columnFilters).filter(f => f && f.length > 0).length;
            const hasSorting = state.sortColumn !== '';
            const hasDMCMFilter = pipelineStatusFilter !== 'all';
            const hasActiveFilters = activeFiltersCount > 0 || hasSorting || hasDMCMFilter;
            
            if (clearAllBtn) {
                if (hasActiveFilters) {
                    clearAllBtn.style.display = 'flex';
                    const badge = activeFiltersCount > 0 ? ` (${activeFiltersCount})` : '';
                    clearAllBtn.innerHTML = `
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        Clear Filters${badge}
                    `;
                } else {
                    clearAllBtn.style.display = 'none';
                }
            }
            
            // Helper function to create header cell with filter and sort
            function createHeaderCell(label, columnKey, columnIndex, totalColumns) {
                const hasFilter = state.columnFilters[columnKey] && state.columnFilters[columnKey].length > 0;
                const isSorted = state.sortColumn === columnKey;
                const isFilterOpen = state.openFilterColumn === columnKey;
                
                // Smart positioning: last 2 columns align right, others align left
                const alignRight = columnIndex >= totalColumns - 2;
                
                // Get unique values for this column from items before column filters
                const uniqueValues = new Set();
                itemsBeforeFilters.forEach(item => {
                    if (item[columnKey] !== undefined && item[columnKey] !== null) {
                        uniqueValues.add(item[columnKey]);
                    }
                });
                const sortedValues = Array.from(uniqueValues).sort((a, b) => {
                    if (typeof a === 'string') return a.localeCompare(b);
                    return a - b;
                });
                
                // For TFA column, format display values
                const displayValues = sortedValues.map(val => {
                    if (columnKey === 'tfa') {
                        return { raw: val, display: formatCurrency(val) };
                    }
                    return { raw: val, display: val };
                });
                
                // Generate unique ID for search input
                const searchId = `pipelineFilterSearch_${columnKey}`;
                
                return `
                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">
                        <div class="flex items-center justify-center gap-2">
                            <span>${label}</span>
                            <div class="flex items-center gap-1">
                                <!-- Filter Icon -->
                                <div class="relative pipeline-filter-dropdown">
                                    <button onclick="togglePipelineFilterDropdown('${columnKey}', event)" 
                                        class="p-1 hover:bg-gray-100 rounded relative">
                                        <svg class="h-4 w-4 ${hasFilter ? 'text-blue-500' : 'text-gray-400'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                                        </svg>
                                        ${hasFilter ? '<span class="absolute -top-1 -right-1 h-2 w-2 rounded-full bg-blue-500"></span>' : ''}
                                    </button>
                                    ${isFilterOpen ? `
                                        <div class="absolute top-full ${alignRight ? 'right-0' : 'left-0'} z-[9999] w-72 mt-2 rounded-2xl border border-gray-200 bg-white p-4 shadow-2xl">
                                            <p class="text-sm font-semibold text-gray-800 mb-3">Filter by ${label}</p>
                                            <div class="mb-3">
                                                <input type="text" 
                                                    id="${searchId}"
                                                    oninput="filterPipelineDropdownValues('${columnKey}')"
                                                    placeholder="Search values..." 
                                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none" />
                                            </div>
                                            <div id="pipelineFilterValues_${columnKey}" class="space-y-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-2 bg-gray-50">
                                                ${displayValues.map(valObj => {
                                                    const valStr = String(valObj.display).toLowerCase();
                                                    const valueForDataAttr = typeof valObj.raw === 'string' 
                                                        ? valObj.raw.replace(/"/g, '&quot;').replace(/'/g, "&#39;")
                                                        : valObj.raw;
                                                    return `
                                                    <label class="flex items-center gap-2 py-1.5 hover:bg-white rounded-lg px-2 cursor-pointer transition-colors pipeline-filter-value-item" data-value="${valStr}">
                                                        <input type="checkbox" 
                                                            ${state.columnFilters[columnKey] && state.columnFilters[columnKey].includes(valObj.raw) ? 'checked' : ''}
                                                            data-column="${columnKey}"
                                                            data-value="${valueForDataAttr}"
                                                            class="pipeline-filter-checkbox rounded border-gray-300 text-blue-500 focus:ring-blue-500" />
                                                        <span class="text-sm text-gray-700">${valObj.display}</span>
                                                    </label>
                                                `}).join('')}
                                            </div>
                                            <div class="mt-3 flex gap-2">
                                                <button onclick="applyPipelineColumnFilter('${columnKey}')" 
                                                    class="flex-1 py-2 text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">
                                                    Apply Filter
                                                </button>
                                                ${hasFilter ? `
                                                    <button onclick="clearPipelineColumnFilter('${columnKey}')" 
                                                        class="flex-1 py-2 text-xs font-medium text-red-600 hover:text-red-700 hover:bg-red-50 rounded-lg transition-colors">
                                                        Clear
                                                    </button>
                                                ` : ''}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                                <!-- Sort Icon -->
                                <button onclick="sortPipelineTable('${columnKey}')" 
                                    class="p-1 hover:bg-gray-100 rounded">
                                    <svg class="h-4 w-4 ${isSorted ? 'text-blue-500' : 'text-gray-400'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        ${isSorted && state.sortDirection === 'asc' 
                                            ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>' 
                                            : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>'}
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </th>
                `;
            }
            
            // Render header with filters and sorting
            const columns = [
                { label: 'Facility ID', key: 'facilityId' },
                { label: 'Relationship', key: 'relationship' },
                { label: 'Underwriter', key: 'underwriter' },
                { label: 'Region', key: 'region' },
                { label: 'Status', key: 'managementStatus' },
                { label: 'Aging', key: 'aging' },
                { label: 'Days', key: 'days' },
                { label: 'TFA', key: 'tfa' }
            ];
            
            thead.innerHTML = columns.map((col, idx) => 
                createHeaderCell(col.label, col.key, idx, columns.length)
            ).join('');
            
            // Render body
            if (paginatedDeals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-8 text-center text-sm text-gray-500">No deals found</td></tr>';
            } else {
                const html = paginatedDeals.map(deal => {
                    // Color coding for regions
                    const regionColor = {
                        'NAM': 'bg-blue-100 text-blue-800',
                        'LATAM': 'bg-green-100 text-green-800',
                        'EMEA': 'bg-purple-100 text-purple-800',
                        'APAC': 'bg-yellow-100 text-yellow-800'
                    }[deal.region] || 'bg-gray-100 text-gray-800';
                    
                    // Color coding for aging
                    const agingBadgeClass = {
                        '1-30 Days': 'bg-green-100 text-green-800',
                        '31-60 Days': 'bg-yellow-100 text-yellow-800',
                        '61-90 Days': 'bg-orange-100 text-orange-800',
                        '>90 Days': 'bg-red-100 text-red-800'
                    }[deal.aging] || 'bg-gray-100 text-gray-800';
                    
                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 text-center text-sm font-medium text-gray-900">${deal.facilityId}</td>
                            <td class="px-6 py-4 text-center text-sm text-gray-700">${deal.relationship}</td>
                            <td class="px-6 py-4 text-center text-sm text-gray-700">${deal.underwriter}</td>
                            <td class="px-6 py-4 text-center">
                                <span class="${regionColor} rounded-full px-2 py-0.5 text-xs font-medium">
                                    ${deal.region}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-center text-sm text-gray-700">${deal.managementStatus}</td>
                            <td class="px-6 py-4 text-center">
                                <span class="${agingBadgeClass} rounded-full px-2 py-0.5 text-xs font-semibold min-w-[60px] inline-block">
                                    ${deal.aging}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-center text-sm font-semibold text-gray-900">${deal.days}</td>
                            <td class="px-6 py-4 text-center text-sm font-semibold text-gray-900">${formatCurrency(deal.tfa)}</td>
                        </tr>
                    `;
                }).join('');
                
                tbody.innerHTML = html;
            }
        }
        
        function exportPipelineTableToCSV() {
            console.log(' Exporting pipeline table to CSV...');
            const state = window.pipelineTableState;
            const data = state.allData; // Use filtered/sorted data
            
            if (!data || data.length === 0) {
                alert('No data to export');
                return;
            }
            
            // Headers match table order
            const headers = ['Facility ID', 'Relationship', 'Underwriter', 'Region', 'Status', 'Aging', 'Days', 'TFA'];
            const rows = data.map(deal => [
                deal.facilityId,
                deal.relationship,
                deal.underwriter,
                deal.region,
                deal.managementStatus,
                deal.aging,
                deal.days,
                deal.tfa
            ]);
            
            let csvContent = headers.join(',') + '\n';
            rows.forEach(row => {
                csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pipeline_deals_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            console.log(' CSV exported successfully');
        }
        
        // Create Covenant Monitoring Chart (Radial Gauge Style)
        let covenantMonitoringChartInstance = null;
        let currentCovenantData = {
            pastDue: {
                count: 0,
                categories: []
            },
            comingDue: {
                count: 0,
                categories: []
            }
        };

        // Function to populate covenant monitoring data from live data
        function populateCovenantMonitoringData() {
            console.log(' Populating Covenant Monitoring Data from Covenants file');
            
            // Use covenant data if available, otherwise fallback to portfolio data
            const dataSource = covenantsData.length > 0 ? covenantsData : (filteredData.length > 0 ? filteredData : portfolioData);
            
            console.log('Using data source with', dataSource.length, 'records');
            console.log('Covenant data available:', covenantsData.length > 0 ? 'Yes' : 'No');
            
            // Initialize category buckets - Breakdown shows ALL categories
            const pastDueBuckets = {
                '1-45 Days': { count: 0, regionalBreakdown: { NAM: 0, LATAM: 0, EMEA: 0, APAC: 0 } },
                '46-90 Days': { count: 0, regionalBreakdown: { NAM: 0, LATAM: 0, EMEA: 0, APAC: 0 } },
                '>90 Days': { count: 0, regionalBreakdown: { NAM: 0, LATAM: 0, EMEA: 0, APAC: 0 } }
            };
            
            // For gauge - only track 46-90 and >90
            const pastDueGaugeBuckets = {
                '46-90 Days': { count: 0, regionalBreakdown: { NAM: 0, LATAM: 0, EMEA: 0, APAC: 0 } },
                '>90 Days': { count: 0, regionalBreakdown: { NAM: 0, LATAM: 0, EMEA: 0, APAC: 0 } }
            };
            
            // Coming Due only shows next 30 days
            const comingDueBuckets = {
                'Next 30 Days': { count: 0, regionalBreakdown: { NAM: 0, LATAM: 0, EMEA: 0, APAC: 0 } }
            };
            
            let pastDueTotalAll = 0;  // Total including 1-45 days (for breakdown)
            let pastDueTotalGauge = 0; // Total for gauge (46-90 + >90 only)
            let comingDueTotal = 0;
            
            dataSource.forEach(row => {
                // Use exact field names from dataLoader export
                const status = String(row.Coming_Due_Past_Due || "").trim().toLowerCase();
                const pastDueCategory = String(row.Past_Due_Category || "").trim();
                const region = String(row.Region || "").trim().toUpperCase();
                
                // Apply region filter if active
                if (selectedRegion !== 'all' && region !== selectedRegion.toUpperCase()) return;
                
                // Process Past Due covenants using Coming_Due_Past_Due and Past_Due_Category from dataLoader
                if (status === 'past due') {
                    pastDueTotalAll++;
                    
                    // Debug: Log first few past due records to see actual category values
                    if (pastDueTotalAll <= 3) {
                        console.log(`DEBUG Past Due Record ${pastDueTotalAll}:`, {
                            status: row.Coming_Due_Past_Due,
                            category: row.Past_Due_Category,
                            categoryTrimmed: pastDueCategory,
                            region: region
                        });
                    }
                    
                    // Use Past_Due_Category from dataLoader (normalized categories: "0-30 Days", "31-45 Days", "46-60 Days", "61-90 Days", ">90 Days")
                    if (pastDueCategory === '>90 Days') {
                        pastDueBuckets['>90 Days'].count++;
                        pastDueGaugeBuckets['>90 Days'].count++;
                        if (region && pastDueBuckets['>90 Days'].regionalBreakdown[region] !== undefined) {
                            pastDueBuckets['>90 Days'].regionalBreakdown[region]++;
                            pastDueGaugeBuckets['>90 Days'].regionalBreakdown[region]++;
                        }
                        pastDueTotalGauge++;
                    } else if (pastDueCategory === '61-90 Days' || pastDueCategory === '46-60 Days') {
                        pastDueBuckets['46-90 Days'].count++;
                        pastDueGaugeBuckets['46-90 Days'].count++;
                        if (region && pastDueBuckets['46-90 Days'].regionalBreakdown[region] !== undefined) {
                            pastDueBuckets['46-90 Days'].regionalBreakdown[region]++;
                            pastDueGaugeBuckets['46-90 Days'].regionalBreakdown[region]++;
                        }
                        pastDueTotalGauge++;
                    } else if (pastDueCategory === '0-30 Days' || pastDueCategory === '31-45 Days') {
                        // 1-45 days - only in breakdown, not in gauge
                        pastDueBuckets['1-45 Days'].count++;
                        if (region && pastDueBuckets['1-45 Days'].regionalBreakdown[region] !== undefined) {
                            pastDueBuckets['1-45 Days'].regionalBreakdown[region]++;
                        }
                    } else {
                        // Catch any unmatched categories
                        if (pastDueTotalAll <= 5) {
                            console.warn(` Unmatched Past_Due_Category: "${pastDueCategory}"`, row);
                        }
                    }
                }
                
                // Process Coming Due covenants (only next 30 days)
                if (status === 'coming due' && isWithinNext30Days(row.Covenant_Due_Date)) {
                    comingDueBuckets['Next 30 Days'].count++;
                    if (region && comingDueBuckets['Next 30 Days'].regionalBreakdown[region] !== undefined) {
                        comingDueBuckets['Next 30 Days'].regionalBreakdown[region]++;
                    }
                    comingDueTotal++;
                }
            });
            
            // Convert buckets to categories with percentages (for breakdown display)
            const pastDueCategories = Object.entries(pastDueBuckets).map(([label, data]) => ({
                label: label,
                count: data.count,
                percentage: pastDueTotalAll > 0 ? parseFloat(((data.count / pastDueTotalAll) * 100).toFixed(1)) : 0,
                regionalBreakdown: data.regionalBreakdown
            }));
            
            // Gauge data for donut chart (only 46-90 and >90)
            const pastDueGaugeCategories = Object.entries(pastDueGaugeBuckets).map(([label, data]) => ({
                label: label,
                count: data.count,
                percentage: pastDueTotalGauge > 0 ? parseFloat(((data.count / pastDueTotalGauge) * 100).toFixed(1)) : 0,
                regionalBreakdown: data.regionalBreakdown
            }));
            
            const comingDueCategories = Object.entries(comingDueBuckets).map(([label, data]) => ({
                label: label,
                count: data.count,
                percentage: comingDueTotal > 0 ? parseFloat(((data.count / comingDueTotal) * 100).toFixed(1)) : 0,
                regionalBreakdown: data.regionalBreakdown
            }));
            
            // Update global covenant data
            currentCovenantData.pastDue = {
                count: pastDueTotalGauge,  // Gauge shows only 46-90 + >90
                totalAll: pastDueTotalAll,  // Total including 1-45 days
                categories: pastDueCategories,  // All categories for breakdown
                gaugeCategories: pastDueGaugeCategories  // Only 46-90 and >90 for donut chart
            };
            
            currentCovenantData.comingDue = {
                count: comingDueTotal,
                categories: comingDueCategories
            };
            
            console.log(` Covenant Monitoring: ${pastDueTotalGauge} Past Due in gauge (46+ days), ${pastDueTotalAll} total past due, ${comingDueTotal} Coming Due (next 30 days)`);
        }

        function createCovenantMonitoringChart(viewType = 'pastDue') {
            console.log('Creating Covenant Monitoring Chart:', viewType);
            
            const chartElement = document.getElementById("covenantMonitoringChart");
            if (!chartElement) {
                console.error('Chart element "covenantMonitoringChart" not found');
                return;
            }

            const data = currentCovenantData[viewType];
            const isPastDue = viewType === 'pastDue';

            let series, labels, colors, totalCount;

            if (isPastDue) {
                // For Past Due: Show ALL categories (1-45, 46-90, >90) with matching colors
                const categories = data.categories || [];
                // Color mapping for each category
                const colorMap = {
                    '1-45 Days': "#dde9ff",
                    '46-90 Days': "#7592ff",
                    '>90 Days': "#3641f5"
                };
                // Filter out categories with zero count
                const filteredCategories = categories.filter(cat => cat.count > 0);
                series = filteredCategories.map(cat => cat.count);
                labels = filteredCategories.map(cat => cat.label);
                colors = filteredCategories.map(cat => colorMap[cat.label] || "#7592ff");
                totalCount = data.totalAll || data.count;
            } else {
                // For Coming Due: Show next 30 days (only if count > 0)
                if (data.count > 0) {
                    series = [data.count];
                    labels = ["Next 30 Days"];
                    colors = ["#10B981"]; // Keep green for Coming Due
                } else {
                    series = [];
                    labels = [];
                    colors = [];
                }
                totalCount = data.count;
            }

            // Handle empty data - show no data message
            if (series.length === 0 || totalCount === 0) {
                console.log(" No covenant data available for", viewType);
                // Destroy existing chart if it exists
                if (covenantMonitoringChartInstance) {
                    covenantMonitoringChartInstance.destroy();
                    covenantMonitoringChartInstance = null;
                }
                chartElement.innerHTML = generateNoDataMessage(isPastDue ? 'Past Due Covenants' : 'Coming Due Covenants');
                // Clear the legend
                const legendElement = document.getElementById("covenantMonitoringLegend");
                if (legendElement) {
                    legendElement.innerHTML = '';
                }
                return;
            }

            const options = {
                series: series,
                colors: colors,
                labels: labels,
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "donut",
                    width: 280,
                    height: 280,
                },
                stroke: {
                    show: false,
                    width: 4,
                    colors: "transparent",
                },
                plotOptions: {
                    pie: {
                        donut: {
                            size: "65%",
                            background: "transparent",
                            labels: {
                                show: true,
                                name: {
                                    show: true,
                                    offsetY: 0,
                                    color: "#1D2939",
                                    fontSize: "12px",
                                    fontWeight: "normal",
                                },
                                value: {
                                    show: true,
                                    offsetY: 10,
                                    color: "#667085",
                                    fontSize: "14px",
                                    formatter: (val) => val.toLocaleString(),
                                },
                                total: {
                                    show: true,
                                    label: isPastDue ? "Past Due" : "Coming Due",
                                    color: "#000000",
                                    fontSize: "20px",
                                    fontWeight: "bold",
                                    formatter: () => totalCount.toLocaleString(),
                                },
                            },
                        },
                    },
                        },
                        dataLabels: {
                    enabled: false,
                            },
                tooltip: {
                    enabled: true,
                    theme: "light",
                    followCursor: false,
                    fixed: {
                        enabled: false
                    },
                    offsetX: 0,
                    offsetY: 0,
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        const label = labels[seriesIndex];
                        const count = series[seriesIndex];
                        const percentage = totalCount > 0 ? ((count / totalCount) * 100).toFixed(1) : 0;
                        
                        // Get category data with regional breakdown
                        const categoryData = (isPastDue ? data.categories : data.categories).find(cat => cat.label === label);
                        const regionalBreakdown = categoryData?.regionalBreakdown || { NAM: 0, LATAM: 0, EMEA: 0, APAC: 0 };
                        
                        // Build regional table rows
                        let regionalRows = '';
                        ['NAM', 'LATAM', 'EMEA', 'APAC'].forEach(region => {
                            const regionCount = regionalBreakdown[region];
                            if (regionCount > 0) {
                                regionalRows += `
                                    <tr>
                                        <td style="padding: 6px 8px; text-align: left; font-size: 11px; color: #6B7280; font-weight: 500;">${region}</td>
                                        <td style="padding: 6px 8px; text-align: right; font-size: 11px; color: #111827; font-weight: 600;">${regionCount}</td>
                                    </tr>
                                `;
                            }
                        });
                        
                        return `
                            <div style="
                                background: #ffffff; 
                                border-radius: 12px; 
                                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
                                min-width: 280px;
                                max-width: 320px;
                                overflow: hidden;
                                font-family: Outfit, sans-serif;
                            ">
                                <!-- Header with border -->
                                <div style="
                                    border-bottom: 1px solid #E5E7EB;
                                    padding: 16px 16px 12px 16px;
                                    margin-bottom: 14px;
                                ">
                                    <div style="
                                        font-weight: 600; 
                                        font-size: 15px; 
                                        color: #111827;
                                        margin-bottom: 4px;
                                    ">${label}</div>
                                    <div style="
                                        font-size: 12px; 
                                        font-weight: 500;
                                        color: #6B7280;
                                    ">${isPastDue ? 'Past Due' : 'Coming Due'} Covenants</div>
                                </div>
                                
                                <!-- Content wrapper -->
                                <div style="padding: 0 16px 16px 16px;">
                                    <!-- Widget Grid (2 columns) -->
                                    <div style="
                                        display: grid;
                                        grid-template-columns: 1fr 1fr;
                                        gap: 10px;
                                        margin-bottom: 16px;
                                    ">
                                        <!-- Widget 1: Count -->
                                        <div style="
                                            background: #F9FAFB;
                                            border-radius: 8px;
                                            padding: 12px;
                                            border: 1px solid #E5E7EB;
                                        ">
                                            <div style="
                                                display: flex;
                                                align-items: center;
                                                gap: 6px;
                                                font-size: 11px;
                                                color: #6B7280;
                                                font-weight: 500;
                                                margin-bottom: 6px;
                                            ">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M9 11l3 3L22 4"></path>
                                                    <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                                                </svg>
                                                Count
                                            </div>
                                            <div style="
                                                font-size: 20px;
                                                font-weight: 700;
                                                color: #111827;
                                            ">${count}</div>
                                        </div>
                                        
                                        <!-- Widget 2: % of Total -->
                                        <div style="
                                            background: #F9FAFB;
                                            border-radius: 8px;
                                            padding: 12px;
                                            border: 1px solid #E5E7EB;
                                        ">
                                            <div style="
                                                display: flex;
                                                align-items: center;
                                                gap: 6px;
                                                font-size: 11px;
                                                color: #6B7280;
                                                font-weight: 500;
                                                margin-bottom: 6px;
                                            ">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <circle cx="12" cy="12" r="10"></circle>
                                                    <path d="M12 6v6l4 2"></path>
                                                </svg>
                                                % of Total
                                            </div>
                                            <div style="
                                                font-size: 14px;
                                                font-weight: 700;
                                                color: #111827;
                                            ">${percentage}%</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Regional Distribution Table -->
                                    <div style="margin-top: 12px;">
                                        <div style="
                                            display: flex;
                                            align-items: center;
                                            gap: 6px;
                                            margin-bottom: 8px;
                                        ">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                            </svg>
                                            <span style="
                                                font-size: 12px;
                                                font-weight: 600;
                                                color: #374151;
                                            ">Regional Distribution</span>
                                        </div>
                                        <table style="width: 100%; border-collapse: collapse;">
                                            <thead>
                                                <tr style="border-bottom: 1px solid #E5E7EB;">
                                                    <th style="padding: 6px 8px; text-align: left; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Region</th>
                                                    <th style="padding: 6px 8px; text-align: right; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Count</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${regionalRows || '<tr><td colspan="2" style="padding: 8px; text-align: center; font-size: 11px; color: #9CA3AF;">No data</td></tr>'}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                },
                legend: {
                    show: false,
                            },
                responsive: [
                    {
                        breakpoint: 2600,
                        options: {
                            chart: {
                                width: 240,
                                height: 240,
                        },
                    },
                },
                    {
                        breakpoint: 640,
                        options: {
                            chart: {
                                width: 280,
                                height: 280,
                },
                        },
                },
                ],
            };

            // Destroy existing chart if it exists
            if (covenantMonitoringChartInstance) {
                covenantMonitoringChartInstance.destroy();
            }

            chartElement.innerHTML = "";
            covenantMonitoringChartInstance = new ApexCharts(chartElement, options);
            covenantMonitoringChartInstance.render();
            console.log('Covenant Monitoring chart rendered successfully');

            // Update custom legend
            updateCovenantMonitoringLegend(labels, series, totalCount, colors);
        }

        // Update the legend for covenant monitoring chart
        function updateCovenantMonitoringLegend(labels, series, totalCount, colors) {
            const legendElement = document.getElementById("covenantMonitoringLegend");
            if (!legendElement) return;

            let legendHTML = "";
            for (let i = 0; i < labels.length; i++) {
                const color = colors[i] || "#3641f5";
                const count = series[i] || 0;
            
                legendHTML += `
                    <div class="flex flex-col items-center gap-2">
                            <div class="flex items-center gap-2">
                            <div class="h-2.5 w-2.5 rounded-full flex-shrink-0" style="background-color: ${color};"></div>
                            <span class="text-xs font-medium text-gray-700">${labels[i]}</span>
                    </div>
                        <div class="text-lg font-bold text-gray-900">${count}</div>
                </div>
            `;
            }

            legendElement.innerHTML = legendHTML;
        }
        
        // Update region distribution for covenant monitoring
        // Removed updateCovenantRegionDistribution - region data now integrated in legends

        function updateCovenantChart(viewType) {
            console.log('Updating covenant chart to:', viewType);
            currentCovenantViewType = viewType; // Update local variable
            window.currentCovenantViewType = viewType; // Update global state
            createCovenantMonitoringChart(viewType);
            updateCovenantRegionalTable(viewType);
        }

        // Update the regional distribution table based on view type
        function updateCovenantRegionalTable(viewType = 'pastDue') {
            console.log('Updating regional table for:', viewType);
            
            const titleEl = document.getElementById('covenantRegionalTableTitle');
            const subtitleEl = document.getElementById('covenantRegionalTableSubtitle');
            const headerEl = document.getElementById('covenantRegionalTableHeader');
            const tableBody = document.getElementById('covenantRegionalTableBody');
            
            if (!tableBody) return;
            
            const isPastDue = viewType === 'pastDue';
            
            // Update title and subtitle
            if (titleEl) {
                titleEl.textContent = isPastDue ? 'Past Due Covenants by Region' : 'Coming Due Covenants by Region (Next 30 Days)';
            }
            if (subtitleEl) {
                subtitleEl.textContent = isPastDue ? 'Regional breakdown of past due covenants' : 'Regional breakdown of covenants due in the next 30 days';
            }
            
            // Update table headers
            if (headerEl) {
                if (isPastDue) {
                    headerEl.innerHTML = `
                        <th class="px-3 py-3 text-xs font-semibold text-gray-700 tracking-wider whitespace-nowrap">Region</th>
                        <th class="px-2 py-3 text-xs font-semibold text-gray-700 tracking-wider text-center"><span class="whitespace-nowrap">1-45</span><br><span class="whitespace-nowrap">Days</span></th>
                        <th class="px-2 py-3 text-xs font-semibold text-gray-700 tracking-wider text-center"><span class="whitespace-nowrap">46-90</span><br><span class="whitespace-nowrap">Days</span></th>
                        <th class="px-2 py-3 text-xs font-semibold text-gray-700 tracking-wider text-center"><span class="whitespace-nowrap">&gt;90</span><br><span class="whitespace-nowrap">Days</span></th>
                        <th class="px-2 py-3 text-xs font-semibold text-gray-700 tracking-wider text-center"><span class="whitespace-nowrap">Total</span><br><span class="whitespace-nowrap">Past Dues</span></th>
                        <th class="px-2 py-3 text-xs font-semibold text-gray-700 tracking-wider text-center"><span class="whitespace-nowrap">Total</span><br><span class="whitespace-nowrap">Covenants</span></th>
                        <th class="px-2 py-3 text-xs font-semibold text-gray-700 tracking-wider text-center"><span class="whitespace-nowrap">% of</span><br><span class="whitespace-nowrap">Total</span></th>
                    `;
                } else {
                    headerEl.innerHTML = `
                        <th class="px-3 py-3 text-xs font-semibold text-gray-700 tracking-wider whitespace-nowrap">Region</th>
                        <th class="px-2 py-3 text-xs font-semibold text-gray-700 tracking-wider text-center"><span class="whitespace-nowrap">Coming</span><br><span class="whitespace-nowrap">Due</span></th>
                        <th class="px-2 py-3 text-xs font-semibold text-gray-700 tracking-wider text-center"><span class="whitespace-nowrap">Total</span><br><span class="whitespace-nowrap">Covenants</span></th>
                        <th class="px-2 py-3 text-xs font-semibold text-gray-700 tracking-wider text-center"><span class="whitespace-nowrap">% of</span><br><span class="whitespace-nowrap">Total</span></th>
                    `;
                }
            }
            
            // Calculate regional distribution
            const dataSource = covenantsData.length > 0 ? covenantsData : portfolioData;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const regions = ['APAC', 'EMEA', 'NAM', 'LATAM'];
            const regionalData = {};
            const regionPopulation = {}; // Total covenants per region (no status filter)
            
            regions.forEach(region => {
                regionalData[region] = {
                    '1-30': 0,
                    '31-45': 0,
                    '46-60': 0,
                    '61-90': 0,
                    '>90': 0,
                    'comingDue': 0
                };
                regionPopulation[region] = 0;
            });
            
            // FIRST PASS: Count total covenants per region (Population - no status filter)
            let totalPopulation = 0;
            
            dataSource.forEach(row => {
                const region = String(row.Region || "").trim().toUpperCase();
                
                if (!regions.includes(region)) return;
                
                // Apply region filter if active
                if (selectedRegion !== 'all' && region !== selectedRegion.toUpperCase()) return;
                
                regionPopulation[region]++;
                totalPopulation++;
            });
            
            // SECOND PASS: Count by status categories using dataLoader fields
            let regionalDebugCount = 0;
            dataSource.forEach(row => {
                // Use exact field names from dataLoader export
                const status = String(row.Coming_Due_Past_Due || "").trim().toLowerCase();
                const region = String(row.Region || "").trim().toUpperCase();
                const pastDueCategory = String(row.Past_Due_Category || "").trim();
                
                if (!regions.includes(region)) return;
                
                // Apply region filter if active
                if (selectedRegion !== 'all' && region !== selectedRegion.toUpperCase()) return;
                
                // For Past Due covenants - use Past_Due_Category from dataLoader (normalized categories)
                if (status === 'past due') {
                    regionalDebugCount++;
                    
                    // Debug: Log first few regional past due records
                    if (regionalDebugCount <= 3) {
                        console.log(`DEBUG Regional Past Due Record ${regionalDebugCount}:`, {
                            status: row.Coming_Due_Past_Due,
                            category: row.Past_Due_Category,
                            categoryTrimmed: pastDueCategory,
                            region: region
                        });
                    }
                    
                    if (pastDueCategory === '>90 Days') {
                        regionalData[region]['>90']++;
                    } else if (pastDueCategory === '61-90 Days') {
                        regionalData[region]['61-90']++;
                    } else if (pastDueCategory === '46-60 Days') {
                        regionalData[region]['46-60']++;
                    } else if (pastDueCategory === '31-45 Days') {
                        regionalData[region]['31-45']++;
                    } else if (pastDueCategory === '0-30 Days') {
                        regionalData[region]['1-30']++;
                    } else {
                        // Catch any unmatched categories
                        if (regionalDebugCount <= 5) {
                            console.warn(` Regional: Unmatched Past_Due_Category: "${pastDueCategory}"`, row);
                        }
                    }
                }
                
                // For Coming Due covenants - Coming_Due_Past_Due = "Coming Due" means it's coming due (next 30 days only)
                if (status === 'coming due' && isWithinNext30Days(row.Covenant_Due_Date)) {
                    regionalData[region]['comingDue']++;
                }
            });
            
            // Calculate totals for percentage calculation
            let grandTotalPastDue = 0;
            let grandTotalComingDue = 0;
            
            regions.forEach(region => {
                const pastDueCount = regionalData[region]['1-30'] + regionalData[region]['31-45'] + 
                                     regionalData[region]['46-60'] + regionalData[region]['61-90'] + 
                                     regionalData[region]['>90'];
                grandTotalPastDue += pastDueCount;
                grandTotalComingDue += regionalData[region]['comingDue'];
            });
            
            const grandTotal = grandTotalPastDue + grandTotalComingDue;
            
            // Build table rows - only for regions that have data
            let html = '';
            let total145 = 0;
            let total4690 = 0;
            let totalOver90 = 0;
            let totalComingDue = 0;
            
            // Filter regions to only include those with population > 0
            const regionsWithData = regions.filter(region => regionPopulation[region] > 0);
            
            regionsWithData.forEach(region => {
                // Calculate combined columns
                const count145 = regionalData[region]['1-30'] + regionalData[region]['31-45'];
                const count4690 = regionalData[region]['46-60'] + regionalData[region]['61-90'];
                const countOver90 = regionalData[region]['>90'];
                const countComingDue = regionalData[region]['comingDue'];
                
                total145 += count145;
                total4690 += count4690;
                totalOver90 += countOver90;
                totalComingDue += countComingDue;
                
                // Calculate region totals
                const regionPastDueTotal = count145 + count4690 + countOver90;
                // Population is the total unique covenants for this region (calculated in first pass, no status filter)
                const regPopulation = regionPopulation[region];
                
                if (isPastDue) {
                    // % of Total = Past Due Total for this region / Region's Total Covenants (region-specific)
                    const percentOfTotal = regPopulation > 0 ? ((regionPastDueTotal / regPopulation) * 100).toFixed(1) : 0;
                    
                html += `
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            <td class="px-3 py-3 text-xs font-medium text-gray-700">${region}</td>
                            <td class="px-2 py-3 text-xs text-gray-700 text-center font-semibold">${count145}</td>
                            <td class="px-2 py-3 text-xs text-gray-700 text-center font-semibold">${count4690}</td>
                            <td class="px-2 py-3 text-xs text-gray-700 text-center font-semibold">${countOver90}</td>
                            <td class="px-2 py-3 text-xs text-gray-900 text-center font-bold">${regionPastDueTotal}</td>
                            <td class="px-2 py-3 text-xs text-gray-900 text-center font-bold">${regPopulation}</td>
                            <td class="px-2 py-3 text-xs text-gray-900 text-center font-semibold">${percentOfTotal}%</td>
                        </tr>
                    `;
                } else {
                    // % of Total = Coming Due for this region / Total Coming Due (across all regions)
                    const percentOfTotal = totalComingDue > 0 ? ((countComingDue / totalComingDue) * 100).toFixed(1) : 0;
                    
                    html += `
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            <td class="px-3 py-3 text-xs font-medium text-gray-700">${region}</td>
                            <td class="px-2 py-3 text-xs text-gray-900 text-center font-bold">${countComingDue}</td>
                            <td class="px-2 py-3 text-xs text-gray-900 text-center font-bold">${regPopulation}</td>
                            <td class="px-2 py-3 text-xs text-gray-900 text-center font-semibold">${percentOfTotal}%</td>
                        </tr>
                    `;
                }
            });
            
            // Add total row
            const totalPastDue = total145 + total4690 + totalOver90;
            
            if (isPastDue) {
                const totalPercentOfTotal = totalPopulation > 0 ? ((totalPastDue / totalPopulation) * 100).toFixed(1) : 0;
                html += `
                    <tr class="bg-gray-50 font-bold border-t-2 border-gray-200">
                        <td class="px-3 py-3 text-xs text-gray-900">Total</td>
                        <td class="px-2 py-3 text-xs text-gray-900 text-center">${total145}</td>
                        <td class="px-2 py-3 text-xs text-gray-900 text-center">${total4690}</td>
                        <td class="px-2 py-3 text-xs text-gray-900 text-center">${totalOver90}</td>
                        <td class="px-2 py-3 text-xs text-gray-900 text-center">${totalPastDue}</td>
                        <td class="px-2 py-3 text-xs text-gray-900 text-center">${totalPopulation}</td>
                        <td class="px-2 py-3 text-xs text-gray-900 text-center font-bold">${totalPercentOfTotal}%</td>
                    </tr>
                `;
            } else {
                html += `
                    <tr class="bg-gray-50 font-bold border-t-2 border-gray-200">
                        <td class="px-3 py-3 text-xs text-gray-900">Total</td>
                        <td class="px-2 py-3 text-xs text-gray-900 text-center">${totalComingDue}</td>
                        <td class="px-2 py-3 text-xs text-gray-900 text-center">${totalPopulation}</td>
                        <td class="px-2 py-3 text-xs text-gray-900 text-center font-bold">100%</td>
                    </tr>
                `;
            }
            
            tableBody.innerHTML = html;
            
            // Store regional data globally for potential use elsewhere
            window.covenantRegionalData = regionalData;
        }

        // Create the CCM regional stacked bar chart
        let ccmRegionalChartInstance = null;
        
        function createCCMRegionalChart() {
            console.log('Creating CCM regional stacked bar chart');
            
            const chartElement = document.getElementById("ccmRegionalChart");
            if (!chartElement) {
                console.error('Chart element "ccmRegionalChart" not found');
                return;
            }
            
            const allRegions = ['APAC', 'EMEA', 'NAM', 'LATAM'];
            
            // Filter out regions that have no data (all zeros)
            const regions = allRegions.filter(region => {
                const regionKey = region.toLowerCase();
                const total = (currentCCMData.pastDue[regionKey] || 0) + 
                              (currentCCMData.comingDue[regionKey] || 0) + 
                              (currentCCMData.open[regionKey] || 0);
                return total > 0;
            });
            
            // If no regions have data, show no data message
            if (regions.length === 0) {
                console.log('No CCM data available for any region');
                // Destroy existing chart if it exists
                if (ccmRegionalChartInstance) {
                    ccmRegionalChartInstance.destroy();
                    ccmRegionalChartInstance = null;
                }
                const ccmChartEl = document.querySelector("#ccmRegionalChart");
                if (ccmChartEl) {
                    ccmChartEl.innerHTML = generateNoDataMessage('Criticized/Classified Memos & Reviews');
                }
                return;
            }
            
            // Prepare series data from currentCCMData (only for regions with data)
            const series = [
                {
                    name: "Past Due",
                    data: regions.map(region => currentCCMData.pastDue[region.toLowerCase()] || 0)
                },
                {
                    name: "Coming Due",
                    data: regions.map(region => currentCCMData.comingDue[region.toLowerCase()] || 0)
                },
                {
                    name: "Open",
                    data: regions.map(region => currentCCMData.open[region.toLowerCase()] || 0)
                }
            ];
            
            const options = {
                series: series,
                colors: ["#2a31d8", "#465fff", "#7592ff"],
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "bar",
                    stacked: true,
                    height: "100%",
                    toolbar: {
                        show: false,
                    },
                    zoom: {
                        enabled: false,
                    },
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: "39%",
                        borderRadius: 10,
                        borderRadiusApplication: "end",
                        borderRadiusWhenStacked: "last",
                    },
                },
                dataLabels: {
                    enabled: true,
                    formatter: function (val) {
                        return val > 0 ? val : '';
                    },
                    style: {
                        fontSize: '12px',
                        fontWeight: 600,
                        colors: ['#fff']
                    },
                    dropShadow: {
                        enabled: false
                    }
                },
                xaxis: {
                    categories: regions,
                    axisBorder: {
                        show: false,
                    },
                    axisTicks: {
                        show: false,
                    },
                    labels: {
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                },
                legend: {
                    show: true,
                    position: "top",
                    horizontalAlign: "center",
                    fontFamily: "Outfit, sans-serif",
                    fontSize: "12px",
                    markers: {
                        width: 12,
                        height: 12,
                        radius: 3,
                    },
                    itemMargin: {
                        horizontal: 10,
                        vertical: 0,
                    },
                },
                yaxis: {
                    title: false,
                    labels: {
                        align: 'left',
                        offsetX: -10,
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                },
                grid: {
                    borderColor: '#E5E7EB',
                    strokeDashArray: 4,
                    yaxis: {
                        lines: {
                            show: true,
                        },
                    },
                },
                fill: {
                    opacity: 1,
                },
                tooltip: {
                    enabled: true,
                    theme: "light",
                    followCursor: false,
                    fixed: {
                        enabled: false
                    },
                    offsetX: 0,
                    offsetY: 0,
                    shared: true,
                    intersect: false,
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        const region = regions[dataPointIndex];
                        const pastDue = series[0][dataPointIndex];
                        const comingDue = series[1][dataPointIndex];
                        const open = series[2][dataPointIndex];
                        const total = pastDue + comingDue + open;
                        
                        // Region badge colors
                        const regionColors = {
                            'APAC': '#3B82F6',
                            'EMEA': '#10B981',
                            'NAM': '#F97316',
                            'LATAM': '#A855F7'
                        };
                        const regionColor = regionColors[region] || '#6B7280';
                        
                        // Calculate percentages
                        const pastDuePct = total > 0 ? ((pastDue / total) * 100).toFixed(1) : 0;
                        const comingDuePct = total > 0 ? ((comingDue / total) * 100).toFixed(1) : 0;
                        const openPct = total > 0 ? ((open / total) * 100).toFixed(1) : 0;
                        
                        return `
                            <div style="
                                background: #ffffff; 
                                border-radius: 12px; 
                                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
                                min-width: 300px;
                                max-width: 340px;
                                overflow: hidden;
                                font-family: Outfit, sans-serif;
                            ">
                                <!-- Header with border -->
                                <div style="
                                    border-bottom: 1px solid #E5E7EB;
                                    padding: 16px 16px 12px 16px;
                                    margin-bottom: 14px;
                                ">
                                    <div style="
                                        display: flex;
                                        align-items: center;
                                        gap: 8px;
                                        margin-bottom: 6px;
                                    ">
                                        <div style="
                                            font-weight: 600; 
                                            font-size: 15px; 
                                            color: #111827;
                                            flex: 1;
                                        ">${region}</div>
                                        <span style="
                                            background: ${regionColor};
                                            color: white;
                                            font-size: 10px;
                                            font-weight: 600;
                                            padding: 3px 8px;
                                            border-radius: 12px;
                                        ">${region}</span>
                                    </div>
                                    <div style="
                                        font-size: 12px; 
                                        font-weight: 500;
                                        color: #6B7280;
                                    ">CCM Status Distribution</div>
                                </div>
                                
                                <!-- Content wrapper -->
                                <div style="padding: 0 16px 16px 16px;">
                                    <!-- Total CCMs Widget -->
                                    <div style="
                                        background: #F9FAFB;
                                        border-radius: 8px;
                                        padding: 12px;
                                        border: 1px solid #E5E7EB;
                                        margin-bottom: 16px;
                                        text-align: center;
                                    ">
                                        <div style="
                                            font-size: 11px;
                                            color: #6B7280;
                                            font-weight: 500;
                                            margin-bottom: 6px;
                                        ">Total CCMs</div>
                                        <div style="
                                            font-size: 24px;
                                            font-weight: 700;
                                            color: #111827;
                                        ">${total}</div>
                                    </div>
                                    
                                    <!-- Status Breakdown Table -->
                                    <div style="margin-top: 12px;">
                                        <div style="
                                            display: flex;
                                            align-items: center;
                                            gap: 6px;
                                            margin-bottom: 8px;
                                        ">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2">
                                                <rect x="3" y="3" width="7" height="7"></rect>
                                                <rect x="14" y="3" width="7" height="7"></rect>
                                                <rect x="14" y="14" width="7" height="7"></rect>
                                                <rect x="3" y="14" width="7" height="7"></rect>
                                            </svg>
                                            <span style="
                                                font-size: 12px;
                                                font-weight: 600;
                                                color: #374151;
                                            ">Status Breakdown</span>
                                        </div>
                                        <table style="width: 100%; border-collapse: collapse;">
                                            <thead>
                                                <tr style="border-bottom: 1px solid #E5E7EB;">
                                                    <th style="padding: 6px 8px; text-align: left; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Status</th>
                                                    <th style="padding: 6px 8px; text-align: center; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Count</th>
                                                    <th style="padding: 6px 8px; text-align: right; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">%</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${pastDue > 0 ? `
                                                    <tr>
                                                        <td style="padding: 6px 8px; text-align: left; font-size: 11px; color: #6B7280; font-weight: 500;">
                                                            <span style="display: inline-block; width: 8px; height: 8px; background: #2a31d8; border-radius: 2px; margin-right: 6px;"></span>
                                                            Past Due
                                                        </td>
                                                        <td style="padding: 6px 8px; text-align: center; font-size: 11px; color: #111827; font-weight: 600;">${pastDue}</td>
                                                        <td style="padding: 6px 8px; text-align: right; font-size: 11px; color: #111827; font-weight: 600;">${pastDuePct}%</td>
                                                    </tr>
                                                ` : ''}
                                                ${comingDue > 0 ? `
                                                    <tr>
                                                        <td style="padding: 6px 8px; text-align: left; font-size: 11px; color: #6B7280; font-weight: 500;">
                                                            <span style="display: inline-block; width: 8px; height: 8px; background: #465fff; border-radius: 2px; margin-right: 6px;"></span>
                                                            Coming Due
                                                        </td>
                                                        <td style="padding: 6px 8px; text-align: center; font-size: 11px; color: #111827; font-weight: 600;">${comingDue}</td>
                                                        <td style="padding: 6px 8px; text-align: right; font-size: 11px; color: #111827; font-weight: 600;">${comingDuePct}%</td>
                                                    </tr>
                                                ` : ''}
                                                ${open > 0 ? `
                                                    <tr>
                                                        <td style="padding: 6px 8px; text-align: left; font-size: 11px; color: #6B7280; font-weight: 500;">
                                                            <span style="display: inline-block; width: 8px; height: 8px; background: #7592ff; border-radius: 2px; margin-right: 6px;"></span>
                                                            Open
                                                        </td>
                                                        <td style="padding: 6px 8px; text-align: center; font-size: 11px; color: #111827; font-weight: 600;">${open}</td>
                                                        <td style="padding: 6px 8px; text-align: right; font-size: 11px; color: #111827; font-weight: 600;">${openPct}%</td>
                                                    </tr>
                                                ` : ''}
                                            </tbody>
                                        </table>
                                        ${pastDue > 0 ? `
                                            <div style="
                                                margin-top: 12px;
                                                padding: 10px;
                                                background: #FEF2F2;
                                                border: 1px solid #FEE2E2;
                                                border-radius: 6px;
                                            ">
                                                <div style="font-size: 10px; color: #991B1B; font-weight: 600; margin-bottom: 4px;"> ATTENTION REQUIRED</div>
                                                <div style="font-size: 10px; color: #7F1D1D;">${pastDue} CCM${pastDue > 1 ? 's are' : ' is'} past due and require${pastDue === 1 ? 's' : ''} immediate action.</div>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                },
            };
            
            // Destroy existing chart if it exists
            if (ccmRegionalChartInstance) {
                ccmRegionalChartInstance.destroy();
            }
            
            chartElement.innerHTML = "";
            ccmRegionalChartInstance = new ApexCharts(chartElement, options);
            ccmRegionalChartInstance.render();
            console.log('CCM regional stacked chart rendered successfully');
        }

        // Make it globally accessible for Alpine.js
        window.updateCovenantChart = updateCovenantChart;

        // CCM (Credit Committee Memos) Functions
        let currentCCMData = {
            pastDue: { apac: 0, emea: 0, nam: 0, latam: 0 },
            comingDue: { apac: 0, emea: 0, nam: 0, latam: 0 },
            open: { apac: 0, emea: 0, nam: 0, latam: 0 }
        };

        // Calculate CCM stats by region and status
        function calculateCCMStats() {
            console.log(' Calculating CCM Stats');
            
            if (!ccmData || ccmData.length === 0) {
                console.warn('No CCM data available');
                return;
            }

            // Use reporting month instead of actual current date
            const { monthStart: reportingMonthStart, monthEnd: reportingMonthEnd, reportingMonth: repMonth } = getReportingMonthRange();
            
            // For CCM, use reporting month as the reference point
            const referenceDate = new Date(repMonth);
            referenceDate.setHours(0, 0, 0, 0);

            // Initialize counters
            const stats = {
                pastDue: { APAC: 0, EMEA: 0, NAM: 0, LATAM: 0 },
                comingDue: { APAC: 0, EMEA: 0, NAM: 0, LATAM: 0 },
                open: { APAC: 0, EMEA: 0, NAM: 0, LATAM: 0 }
            };

            ccmData.forEach(row => {
                const region = String(row.Region || "").trim().toUpperCase();
                // Use CCM_Status from dataLoader export if available
                const ccmStatus = String(row.CCM_Status || "").trim().toLowerCase();
                
                if (!region) return;
                
                // Ensure region is valid
                if (!['APAC', 'EMEA', 'NAM', 'LATAM'].includes(region)) return;
                
                // Apply region filter if active
                if (selectedRegion !== 'all' && region !== selectedRegion.toUpperCase()) return;

                // Use CCM_Status from dataLoader (already calculated based on Next_CCM_Approval_Date)
                if (ccmStatus === 'past due') {
                    stats.pastDue[region]++;
                } else if (ccmStatus === 'coming due') {
                    stats.comingDue[region]++;
                } else if (ccmStatus === 'open') {
                    stats.open[region]++;
                }
            });

            // Convert to lowercase for consistency
            currentCCMData = {
                pastDue: {
                    apac: stats.pastDue.APAC,
                    emea: stats.pastDue.EMEA,
                    nam: stats.pastDue.NAM,
                    latam: stats.pastDue.LATAM
                },
                comingDue: {
                    apac: stats.comingDue.APAC,
                    emea: stats.comingDue.EMEA,
                    nam: stats.comingDue.NAM,
                    latam: stats.comingDue.LATAM
                },
                open: {
                    apac: stats.open.APAC,
                    emea: stats.open.EMEA,
                    nam: stats.open.NAM,
                    latam: stats.open.LATAM
                }
            };

            console.log('CCM Stats calculated:', currentCCMData);
        }

        // Update CCM display based on selected filter
        function updateCCMStats(filter) {
            console.log('Updating CCM stats for filter:', filter);
            
            // Update the CCM chart
            createCCMRegionalChart();
        }

        // Make updateCCMStats globally accessible
        window.updateCCMStats = updateCCMStats;

        // Parse number that might be formatted (e.g., "5.5M", "1.2K", "1,000,000")
        function parseNumber(value) {
            if (!value) return 0;
            
            // If already a number, return it
            if (typeof value === "number") return value;
            
            // Convert to string and clean
            let str = String(value).trim().toUpperCase();
            
            // Remove currency symbols and commas
            str = str.replace(/[$,]/g, "");
            
            // Handle K (thousands)
            if (str.endsWith("K")) {
                return parseFloat(str.replace("K", "")) * 1000;
            }
            
            // Handle M (millions)
            if (str.endsWith("M")) {
                return parseFloat(str.replace("M", "")) * 1000000;
            }
            
            // Handle B (billions)
            if (str.endsWith("B")) {
                return parseFloat(str.replace("B", "")) * 1000000000;
            }
            
            // Regular number
            return parseFloat(str) || 0;
        }

        // Parse percentage values (handles "0.1%", "12.5%", or decimal 0.001)
        function parsePercentage(value) {
            if (!value && value !== 0) return 0;

            // If already a number
            if (typeof value === "number") {
                // If it's a small decimal (< 1), assume it's already in decimal form (0.001 = 0.1%)
                // and convert to percentage
                if (value < 1 && value > -1) {
                    return value * 100;
                }
                return value;
            }

            // Convert to string and clean
            let str = String(value).trim();

            // Remove commas
            str = str.replace(/,/g, "");

            // Handle percentage sign
            if (str.includes("%")) {
                // Remove % and parse - "0.1%" becomes 0.1
                return parseFloat(str.replace("%", "")) || 0;
            }

            // If no % sign, check if it's a small decimal
            const numValue = parseFloat(str);
            if (!isNaN(numValue)) {
                // If it's a small decimal (< 1), assume it's in decimal form and convert
                if (numValue < 1 && numValue > -1) {
                    return numValue * 100;
                }
                return numValue;
            }

            return 0;
        }
        
        // Get active filters text for display in no-data messages
        function getActiveFiltersText() {
            const filters = [];
            const addedFilters = new Set(); // Track to avoid duplicates
            
            // Smart filters
            if (selectedRegion !== 'all') {
                const key = `Region: ${selectedRegion}`;
                filters.push(key);
                addedFilters.add(key.toLowerCase());
            }
            if (selectedPSE !== 'all') {
                filters.push(`PSE: ${selectedPSE}`);
            }
            if (selectedStatus !== 'all') {
                filters.push(`Status: ${selectedStatus}`);
            }
            if (selectedCommitmentStatus !== 'all') {
                filters.push(`Commitment: ${selectedCommitmentStatus}`);
            }
            
            // Advanced filters
            Object.entries(activeFilters).forEach(([label, value]) => {
                const key = `${label}: ${value}`;
                if (!addedFilters.has(key.toLowerCase())) {
                    filters.push(key);
                    addedFilters.add(key.toLowerCase());
                }
            });
            
            // Search term
            const searchTerm = document.getElementById('searchInput')?.value?.trim();
            if (searchTerm && searchTerm.length > 0) {
                filters.push(`Search: "${searchTerm}"`);
            }
            
            // Chart filter (avoid duplicates)
            if (chartFilter.active) {
                const chartFilterKey = `${chartFilter.type}: ${chartFilter.value}`;
                if (!addedFilters.has(chartFilterKey.toLowerCase())) {
                    filters.push(chartFilterKey);
                }
            }
            
            return filters;
        }
        
        // Generate consistent "no data" HTML message with active filters
        function generateNoDataMessage(chartTitle = '') {
            const filters = getActiveFiltersText();
            
            let html = '<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; min-width: 200px; min-height: 280px; height: 100%; text-align: center; padding: 1.5rem; box-sizing: border-box;">';
            html += '<svg style="width: 48px; height: 48px; margin-bottom: 12px;" fill="none" stroke="#d1d5db" viewBox="0 0 24 24">';
            html += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>';
            html += '</svg>';
            html += '<p style="font-size: 14px; font-weight: 500; color: #4b5563; margin: 0 0 4px 0;">No data available' + (chartTitle ? ' for ' + chartTitle : '') + '</p>';
            
            if (filters.length > 0) {
                html += '<p style="font-size: 12px; color: #9ca3af; max-width: 280px; margin: 0;">Applied filters: ' + filters.join(', ') + '</p>';
            } else {
                html += '<p style="font-size: 12px; color: #9ca3af; margin: 0;">No filters applied</p>';
            }
            
            html += '</div>';
            return html;
        }
        
        // Format currency with M/B notation
        function formatCurrency(value) {
            if (!value || value === 0) return "$0";
            
            const absValue = Math.abs(value);
            
            // Billions
            if (absValue >= 1000000000) {
                return "$" + (value / 1000000000).toFixed(2) + "B";
            }
            
            // Millions
            if (absValue >= 1000000) {
                return "$" + (value / 1000000).toFixed(2) + "M";
            }
            
            // Thousands
            if (absValue >= 1000) {
                return "$" + (value / 1000).toFixed(2) + "K";
            }
            
            // Less than 1000
            return "$" + value.toFixed(2);
        }
        
        // Format currency for detailed display (with commas)
        function formatCurrencyDetailed(value) {
            return new Intl.NumberFormat("en-US", {
                style: "currency",
                currency: "USD",
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            }).format(value);
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return "N/A";
            const date = parseDate(dateString);
            if (!date) return "N/A";
            return date.toLocaleDateString("en-US", {
                year: "numeric",
                month: "short",
                day: "numeric",
            });
        }
        
        // Check if covenant is due within next 30 days
        function isWithinNext30Days(covenantDueDate) {
            if (!covenantDueDate) return false;
            
            const dueDate = parseDate(covenantDueDate);
            if (!dueDate) return false;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const thirtyDaysFromNow = new Date(today);
            thirtyDaysFromNow.setDate(today.getDate() + 30);
            
            return dueDate >= today && dueDate <= thirtyDaysFromNow;
        }

        // Create expiration timeline chart (Area chart for Facilities only)
        function createExpirationChart() {
            console.log(" Creating facilities expired & expiring bar chart");
            
            // Get the current reporting month from the data
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Generate next 3 months starting from current month
            const next3Months = [];
            for (let i = 0; i < 3; i++) {
                const date = new Date(today);
                date.setMonth(date.getMonth() + i);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, "0");
                next3Months.push(`${year}-${month}`);
            }
            
            console.log("Next 3 months starting from current:", next3Months);
            
            // Group by month-year and categorize as expired or expiring
            const monthlyData = {};
            
            // Initialize all 3 months
            next3Months.forEach((monthYear) => {
                monthlyData[monthYear] = {
                    expired: [],
                    expiring: [],
                };
            });
            
            portfolioData.forEach((row) => {
                const maturityDate = row.Maturity_Date;
                const facilityId = row.Facility_ID;
                
                if (maturityDate && facilityId) {
                    const dateObj = parseDate(maturityDate);
                    if (dateObj) {
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthYear = `${year}-${month}`;
                        
                        // Only include if it's in our next 3 months
                        if (next3Months.includes(monthYear)) {
                            // Categorize based on whether date is past or future
                            if (dateObj < today) {
                                monthlyData[monthYear].expired.push(facilityId);
                            } else {
                                monthlyData[monthYear].expiring.push(facilityId);
                            }
                        }
                    }
                }
            });
            
            // Prepare data for the next 3 months
            const categories = next3Months.map((m) => {
                const date = new Date(m + "-01");
                return date.toLocaleDateString("en-US", { month: "short" });
            });

            const expiredData = next3Months.map(
                (month) => monthlyData[month].expired.length
            );
            const expiringData = next3Months.map(
                (month) => monthlyData[month].expiring.length
            );

            console.log("Expired:", expiredData);
            console.log("Expiring:", expiringData);
            
            const options = {
                series: [
                    {
                        name: "Expired",
                        data: expiredData,
                    },
                    {
                        name: "Expiring",
                        data: expiringData,
                    },
                ],
                colors: ["#93a8ff", "#465fff"],
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "bar",
                    stacked: false,
                    height: "100%",
                    toolbar: {
                        show: false,
                    },
                    zoom: {
                        enabled: false,
                    },
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: "55%",
                        borderRadius: 8,
                        borderRadiusApplication: "end",
                        dataLabels: {
                            position: 'top',
                        },
                    },
                },
                dataLabels: {
                    enabled: true,
                    offsetY: -30,
                    style: {
                        fontSize: '11px',
                        fontWeight: 500,
                        colors: ['#374151']
                    },
                    background: {
                        enabled: true,
                        foreColor: '#374151',
                        backgroundColor: '#F3F4F6',
                        borderRadius: 12,
                        padding: 8,
                        opacity: 1,
                        borderWidth: 0
                    },
                    formatter: function(val, opts) {
                        return val;
                    }
                },
                xaxis: {
                    categories: categories,
                    axisBorder: {
                        show: false,
                    },
                    axisTicks: {
                        show: false,
                    },
                    labels: {
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                },
                legend: {
                    show: true,
                    position: "top",
                    horizontalAlign: "center",
                    fontFamily: "Outfit, sans-serif",
                    fontSize: "12px",
                    markers: {
                        width: 12,
                        height: 12,
                        radius: 3,
                    },
                    itemMargin: {
                        horizontal: 10,
                        vertical: 0,
                    },
                },
                yaxis: {
                    title: false,
                    labels: {
                        align: 'left',
                        offsetX: -10,
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                },
                grid: {
                    borderColor: '#E5E7EB',
                    strokeDashArray: 4,
                    xaxis: {
                        lines: {
                            show: true,
                        },
                    },
                    yaxis: {
                        lines: {
                            show: false,
                        },
                    },
                },
                fill: {
                    opacity: 1,
                },
                tooltip: {
                    theme: "light",
                    style: {
                        fontSize: "12px",
                        fontFamily: "Outfit, sans-serif",
                    },
                    x: {
                        show: false,
                    },
                    y: {
                        formatter: function (val) {
                            return val + " facilities";
                        },
                    },
                },
            };

            // Get the chart element and verify it exists
            const chartElement = document.querySelector("#facilityMaturityChart");
            if (!chartElement) {
                console.error(
                    "Facility maturity chart element #facilityMaturityChart not found in DOM"
                );
                return;
            }
            
            // Check if ApexCharts is loaded
            if (typeof ApexCharts === "undefined") {
                console.error("ApexCharts library not loaded yet. Retrying...");
                setTimeout(createExpirationChart, 500);
                return;
            }
            
            try {
                // Destroy existing chart if it exists
                if (facilityMaturityChartInstance) {
                    facilityMaturityChartInstance.destroy();
                    facilityMaturityChartInstance = null;
                }
                
                // Clear the element
                chartElement.innerHTML = "";
                
                // Create and render new chart
                facilityMaturityChartInstance = new ApexCharts(chartElement, options);
                facilityMaturityChartInstance.render();
                console.log(" Facility maturity chart rendered successfully");
            } catch (error) {
                console.error(" Error rendering facility maturity chart:", error);
            }
        }

        // Create combined chart for CAs Coming Due & Facilities Expiring
        function createFacilityTrendChart() {
            console.log(" Creating CAs Coming Due & Facilities Expiring chart");
            
            // Check if we have data
            if (!portfolioData || portfolioData.length === 0) {
                console.log(" No portfolio data available for CAs & Facilities Expiring chart");
                const chartElement = document.querySelector("#facilityTrendChart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('CAs & Facilities Expiring');
                }
                return;
            }
            
            // Get the current reporting month from the data
            const reportDates = portfolioData
                .map((row) => parseDate(row.Report_Date))
                .filter((d) => d);
            if (reportDates.length === 0) {
                console.log(" No valid report dates found");
                return;
            }
            const maxReportDate = new Date(Math.max(...reportDates));
            maxReportDate.setHours(0, 0, 0, 0);
            
            // Store report date for filtering
            window.currentReportDate = maxReportDate;
            
            // Generate next 3 months starting from current month
            const next3Months = [];
            for (let i = 0; i < 3; i++) {
                const date = new Date(maxReportDate);
                date.setMonth(date.getMonth() + i);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, "0");
                next3Months.push(`${year}-${month}`);
            }
            
            console.log("Next 3 months starting from report date:", next3Months, "Report Date:", maxReportDate);
            
            // Group by month-year for both CAs and Facilities
            const monthlyData = {};
            
            // Initialize all 3 months
            next3Months.forEach((monthYear) => {
                monthlyData[monthYear] = {
                    casComingDueByRelationship: new Set(), // Unique Relationship_IDs for all regions
                    facilitiesExpiring: new Set(), // Unique Facility IDs
                    caAmounts: { tfa: 0, direct: 0, contingent: 0, pse: 0 },
                    facilityAmounts: { tfa: 0, direct: 0, contingent: 0, pse: 0 },
                };
            });
            
            // Collect CAs Coming Due (only future dates from report date, CM only)
            // Use unique Relationship_IDs for all regions (EMEA requires CA_Review = "Yes")
            portfolioData.forEach((row) => {
                const caExpirationDate = row.CA_Expiration_Date;
                const managementStatus = (row.Management_Status || "").toUpperCase();
                const region = (row.Region || "").toUpperCase();
                const caReview = (row.CA_Review || "").trim();
                
                if (caExpirationDate && managementStatus === "CM") {
                    const dateObj = parseDate(caExpirationDate);
                    if (dateObj && dateObj >= maxReportDate) {
                        // Only future dates (coming due from report date)
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthYear = `${year}-${month}`;
                        
                        // Only include if it's in our next 3 months
                        if (next3Months.includes(monthYear)) {
                            // For EMEA: require CA_Review = "Yes"
                            // For all other regions: count all CAs
                            // All regions use unique Relationship_IDs
                            if (region === "EMEA") {
                                if (caReview === "Yes" && row.Relationship_ID) {
                                    monthlyData[monthYear].casComingDueByRelationship.add(row.Relationship_ID);
                                    // Accumulate amounts for EMEA CAs (sum ALL lines)
                                    monthlyData[monthYear].caAmounts.tfa += parseNumber(
                                        row.Fac_Amount || row.Facility_Amount
                                    );
                                    monthlyData[monthYear].caAmounts.direct += parseNumber(
                                        row.Direct_OS
                                    );
                                    monthlyData[monthYear].caAmounts.contingent += parseNumber(
                                        row.Contingent_OS
                                    );
                                    monthlyData[monthYear].caAmounts.pse += parseNumber(row.PSE_OS);
                                }
                            } else {
                                // For non-EMEA: count unique Relationship_IDs
                                if (row.Relationship_ID) {
                                    monthlyData[monthYear].casComingDueByRelationship.add(row.Relationship_ID);
                                    // Accumulate amounts for non-EMEA CAs (sum ALL lines)
                                    monthlyData[monthYear].caAmounts.tfa += parseNumber(
                                        row.Fac_Amount || row.Facility_Amount
                                    );
                                    monthlyData[monthYear].caAmounts.direct += parseNumber(
                                        row.Direct_OS
                                    );
                                    monthlyData[monthYear].caAmounts.contingent += parseNumber(
                                        row.Contingent_OS
                                    );
                                    monthlyData[monthYear].caAmounts.pse += parseNumber(row.PSE_OS);
                                }
                            }
                        }
                    }
                }
            });
            
            // Collect Facilities Expiring (only future dates from report date, NO DM exclusion)
            portfolioData.forEach((row) => {
                const maturityDate = row.Maturity_Date;
                const facilityId = row.Facility_ID;
                
                if (maturityDate && facilityId) {
                    const dateObj = parseDate(maturityDate);
                    if (dateObj && dateObj >= maxReportDate) {
                        // Only future dates (expiring from report date)
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthYear = `${year}-${month}`;
                        
                        // Only include if it's in our next 3 months
                        if (next3Months.includes(monthYear)) {
                            monthlyData[monthYear].facilitiesExpiring.add(facilityId); // Use add for Set
                            // Accumulate amounts for Facilities (sum ALL lines)
                            monthlyData[monthYear].facilityAmounts.tfa += parseNumber(
                                row.Fac_Amount || row.Facility_Amount
                            );
                            monthlyData[monthYear].facilityAmounts.direct += parseNumber(
                                row.Direct_OS
                            );
                            monthlyData[monthYear].facilityAmounts.contingent +=
                                parseNumber(row.Contingent_OS);
                            monthlyData[monthYear].facilityAmounts.pse += parseNumber(
                                row.PSE_OS
                            );
                        }
                    }
                }
            });
            
            // Prepare data for the next 3 months
            const categories = next3Months.map((m) => {
                const date = new Date(m + "-01");
                return date.toLocaleDateString("en-US", { month: "short" });
            });

            const casComingDueData = next3Months.map(
                (month) => monthlyData[month].casComingDueByRelationship.size
            );
            const facilitiesExpiringData = next3Months.map(
                (month) => monthlyData[month].facilitiesExpiring.size // Changed from .length to .size
            );

            console.log("CAs Coming Due:", casComingDueData);
            console.log("Facilities Expiring:", facilitiesExpiringData);

            // Check if all data is empty
            const totalCAs = casComingDueData.reduce((sum, val) => sum + val, 0);
            const totalFacilities = facilitiesExpiringData.reduce((sum, val) => sum + val, 0);

            if (totalCAs === 0 && totalFacilities === 0) {
                console.log(" No expiration data available");
                const chartElement = document.querySelector("#facilityTrendChart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('CAs & Facilities Expiring');
                }
                return;
            }
            
            const options = {
                series: [
                    {
                        name: "CAs Coming Due",
                        data: casComingDueData,
                    },
                    {
                        name: "Facilities Expiring",
                        data: facilitiesExpiringData,
                    },
                ],
                colors: ["#C2D6FF", "#465FFF"],
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "bar",
                    stacked: false,
                    height: "100%",
                    toolbar: {
                        show: false,
                    },
                    zoom: {
                        enabled: false,
                    },
                    offsetY: 0,
                    offsetX: 0,
                    events: {
                        // Chart click filtering disabled
                    },
                    events_disabled: {
                        // Expiry chart click functionality removed
                        dataPointSelection: function (event, chartContext, config) {
                            const selectedMonth = next3Months[config.dataPointIndex];
                            const monthName = categories[config.dataPointIndex];
                            const seriesName = config.w.config.series[config.seriesIndex].name;
                            console.log("Month clicked:", monthName, "Series:", seriesName, "Month Key:", selectedMonth);
                        },
                    },
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: "50%",
                        borderRadius: 4,
                        borderRadiusApplication: "end",
                        dataLabels: {
                            position: 'top',
                        },
                    },
                },
                stroke: {
                    show: true,
                    width: 4,
                    colors: ["transparent"]
                },
                states: {
                    active: {
                        allowMultipleDataPointsSelection: false,
                        filter: {
                            type: 'darken',
                            value: 0.7,
                        }
                    }
                },
                dataLabels: {
                    enabled: true,
                    offsetY: -30,
                    style: {
                        fontSize: '11px',
                        fontWeight: 500,
                        colors: ['#374151']
                    },
                    background: {
                        enabled: true,
                        foreColor: '#374151',
                        backgroundColor: '#F3F4F6',
                        borderRadius: 12,
                        padding: 8,
                        opacity: 1,
                        borderWidth: 0
                    },
                    formatter: function(val, opts) {
                        return val;
                    }
                },
                xaxis: {
                    categories: categories,
                    axisBorder: {
                        show: false,
                    },
                    axisTicks: {
                        show: false,
                    },
                },
                legend: {
                    show: true,
                    position: "top",
                    horizontalAlign: "center",
                    fontFamily: "Outfit, sans-serif",
                    fontSize: "12px",
                    markers: {
                        width: 12,
                        height: 12,
                        radius: 3,
                    },
                    itemMargin: {
                        horizontal: 10,
                        vertical: 0,
                    },
                },
                yaxis: {
                    title: false,
                    labels: {
                        align: 'left',
                        offsetX: -10,
                    },
                },
                grid: {
                    borderColor: '#E5E7EB',
                    strokeDashArray: 4,
                    yaxis: {
                        lines: {
                            show: true,
                        },
                    },
                },
                fill: {
                    opacity: 1,
                },
                tooltip: {
                    theme: "light",
                    shared: false,
                    intersect: true,
                    followCursor: false,
                    fixed: {
                        enabled: false,
                    },
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        const monthKey = next3Months[dataPointIndex];
                        const monthData = monthlyData[monthKey];
                        const monthName = categories[dataPointIndex];
                        const seriesName = w.config.series[seriesIndex].name;
                        
                        // Calculate regional distribution
                        const regionalData = { NAM: { count: 0, tfa: 0 }, LATAM: { count: 0, tfa: 0 }, EMEA: { count: 0, tfa: 0 }, APAC: { count: 0, tfa: 0 } };
                        
                        if (seriesName === "CAs Coming Due") {
                            // For CAs, iterate through data and match with relationships in this month
                            portfolioData.forEach(row => {
                                if (monthData.casComingDueByRelationship.has(row.Relationship_ID)) {
                                    const caExpirationDate = row.CA_Expiration_Date;
                                    const dateObj = parseDate(caExpirationDate);
                                    if (dateObj) {
                                        const year = dateObj.getFullYear();
                                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                                        const rowMonthKey = `${year}-${month}`;
                                        if (rowMonthKey === monthKey) {
                                            const region = (row.Region || "").toUpperCase();
                                            if (regionalData[region]) {
                                                regionalData[region].tfa += parseNumber(row.Fac_Amount || row.Facility_Amount);
                                            }
                                        }
                                    }
                                }
                            });
                            // Count unique relationships per region
                            portfolioData.forEach(row => {
                                if (monthData.casComingDueByRelationship.has(row.Relationship_ID)) {
                                    const region = (row.Region || "").toUpperCase();
                                    if (regionalData[region]) {
                                        regionalData[region].count++;
                                    }
                                }
                            });
                        } else {
                            // For Facilities, iterate through data and match with facility IDs in this month
                            const countedFacilities = new Set();
                            portfolioData.forEach(row => {
                                if (monthData.facilitiesExpiring.has(row.Facility_ID)) {
                                    const maturityDate = row.Maturity_Date;
                                    const dateObj = parseDate(maturityDate);
                                    if (dateObj) {
                                        const year = dateObj.getFullYear();
                                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                                        const rowMonthKey = `${year}-${month}`;
                                        if (rowMonthKey === monthKey) {
                                            const region = (row.Region || "").toUpperCase();
                                            if (regionalData[region]) {
                                                regionalData[region].tfa += parseNumber(row.Fac_Amount || row.Facility_Amount);
                                                if (!countedFacilities.has(row.Facility_ID)) {
                                                    regionalData[region].count++;
                                                    countedFacilities.add(row.Facility_ID);
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        }
                        
                        let html = `
                            <div style="
                                background: #ffffff; 
                                border-radius: 12px; 
                                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
                                min-width: 420px;
                                max-width: 460px;
                                overflow: hidden;
                                font-family: Outfit, sans-serif;
                            ">
                                <!-- Header with border -->
                                <div style="
                                    border-bottom: 1px solid #E5E7EB;
                                    padding: 16px 16px 12px 16px;
                                    margin-bottom: 14px;
                                ">
                                    <div style="
                                        font-weight: 600; 
                                        font-size: 15px; 
                                        color: #111827;
                                        margin-bottom: 4px;
                                    ">${monthName}</div>
                                    <div style="
                                        font-size: 12px; 
                                        font-weight: 500;
                                        color: #6B7280;
                                    ">${seriesName}</div>
                                </div>
                                
                                <!-- Content wrapper -->
                                <div style="padding: 0 16px 16px 16px;">`;
                        
                        if (seriesName === "CAs Coming Due") {
                            const casCount = monthData.casComingDueByRelationship.size;
                            html += `
                                <!-- Widget Grid (2 columns) -->
                                <div style="
                                    display: grid;
                                    grid-template-columns: 1fr 1fr;
                                    gap: 10px;
                                    margin-bottom: 12px;
                                ">
                                    <!-- Widget 1: Total Relationships -->
                                    <div style="
                                        background: #F9FAFB;
                                        border-radius: 8px;
                                        padding: 12px;
                                        border: 1px solid #E5E7EB;
                                    ">
                                        <div style="
                                            display: flex;
                                            align-items: center;
                                            gap: 6px;
                                            font-size: 11px;
                                            color: #6B7280;
                                            font-weight: 500;
                                            margin-bottom: 6px;
                                        ">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                                <circle cx="9" cy="7" r="4"></circle>
                                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                            </svg>
                                            Relationships
                                        </div>
                                        <div style="
                                            font-size: 20px;
                                            font-weight: 700;
                                            color: #111827;
                                        ">${casCount}</div>
                                    </div>
                                    
                                    <!-- Widget 2: Total TFA -->
                                    <div style="
                                        background: #F9FAFB;
                                        border-radius: 8px;
                                        padding: 12px;
                                        border: 1px solid #E5E7EB;
                                    ">
                                        <div style="
                                            display: flex;
                                            align-items: center;
                                            gap: 6px;
                                            font-size: 11px;
                                            color: #6B7280;
                                            font-weight: 500;
                                            margin-bottom: 6px;
                                        ">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                            </svg>
                                            Total TFA
                                        </div>
                                        <div style="
                                            font-size: 15px;
                                            font-weight: 700;
                                            color: #111827;
                                        ">${formatCurrency(monthData.caAmounts.tfa)}</div>
                                    </div>
                                </div>
                                
                                <!-- Regional Distribution Table (Full Width) -->
                                <div style="
                                    background: #F9FAFB;
                                    border-radius: 8px;
                                    padding: 12px;
                                    border: 1px solid #E5E7EB;
                                ">
                                    <div style="
                                        display: flex;
                                        align-items: center;
                                        gap: 6px;
                                        font-size: 11px;
                                        color: #6B7280;
                                        font-weight: 600;
                                        margin-bottom: 10px;
                                        text-transform: uppercase;
                                        letter-spacing: 0.5px;
                                    ">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <line x1="2" y1="12" x2="22" y2="12"></line>
                                            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                        </svg>
                                        Regional Distribution
                                    </div>
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="border-bottom: 1px solid #E5E7EB;">
                                                <th style="
                                                    padding: 6px 0;
                                                    text-align: left;
                                                    font-size: 10px;
                                                    font-weight: 600;
                                                    color: #9CA3AF;
                                                    text-transform: uppercase;
                                                ">Region</th>
                                                <th style="
                                                    padding: 6px 0;
                                                    text-align: right;
                                                    font-size: 10px;
                                                    font-weight: 600;
                                                    color: #9CA3AF;
                                                    text-transform: uppercase;
                                                ">Count</th>
                                                <th style="
                                                    padding: 6px 0;
                                                    text-align: right;
                                                    font-size: 10px;
                                                    font-weight: 600;
                                                    color: #9CA3AF;
                                                    text-transform: uppercase;
                                                ">TFA</th>
                                            </tr>
                                        </thead>
                                        <tbody>`;
                            
                            ['NAM', 'LATAM', 'EMEA', 'APAC'].forEach(region => {
                                if (regionalData[region].count > 0 || regionalData[region].tfa > 0) {
                                    html += `
                                            <tr style="border-bottom: 1px solid #F3F4F6;">
                                                <td style="
                                                    padding: 8px 0;
                                                    font-size: 12px;
                                                    color: #374151;
                                                    font-weight: 500;
                                                ">${region}</td>
                                                <td style="
                                                    padding: 8px 0;
                                                    text-align: right;
                                                    font-size: 12px;
                                                    color: #111827;
                                                    font-weight: 600;
                                                ">${regionalData[region].count}</td>
                                                <td style="
                                                    padding: 8px 0;
                                                    text-align: right;
                                                    font-size: 12px;
                                                    color: #111827;
                                                    font-weight: 600;
                                                ">${formatCurrency(regionalData[region].tfa)}</td>
                                            </tr>`;
                                }
                            });
                            
                            html += `
                                        </tbody>
                                    </table>
                                </div>`;
                        } else if (seriesName === "Facilities Expiring") {
                            const facilitiesCount = monthData.facilitiesExpiring.size;
                            html += `
                                <!-- Widget Grid (2 columns) -->
                                <div style="
                                    display: grid;
                                    grid-template-columns: 1fr 1fr;
                                    gap: 10px;
                                    margin-bottom: 12px;
                                ">
                                    <!-- Widget 1: Total Facilities -->
                                    <div style="
                                        background: #F9FAFB;
                                        border-radius: 8px;
                                        padding: 12px;
                                        border: 1px solid #E5E7EB;
                                    ">
                                        <div style="
                                            display: flex;
                                            align-items: center;
                                            gap: 6px;
                                            font-size: 11px;
                                            color: #6B7280;
                                            font-weight: 500;
                                            margin-bottom: 6px;
                                        ">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                                <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                            </svg>
                                            Facilities
                                        </div>
                                        <div style="
                                            font-size: 20px;
                                            font-weight: 700;
                                            color: #111827;
                                        ">${facilitiesCount}</div>
                                    </div>
                                    
                                    <!-- Widget 2: Total TFA -->
                                    <div style="
                                        background: #F9FAFB;
                                        border-radius: 8px;
                                        padding: 12px;
                                        border: 1px solid #E5E7EB;
                                    ">
                                        <div style="
                                            display: flex;
                                            align-items: center;
                                            gap: 6px;
                                            font-size: 11px;
                                            color: #6B7280;
                                            font-weight: 500;
                                            margin-bottom: 6px;
                                        ">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                            </svg>
                                            Total TFA
                                        </div>
                                        <div style="
                                            font-size: 15px;
                                            font-weight: 700;
                                            color: #111827;
                                        ">${formatCurrency(monthData.facilityAmounts.tfa)}</div>
                                    </div>
                                </div>
                                
                                <!-- Regional Distribution Table (Full Width) -->
                                <div style="
                                    background: #F9FAFB;
                                    border-radius: 8px;
                                    padding: 12px;
                                    border: 1px solid #E5E7EB;
                                ">
                                    <div style="
                                        display: flex;
                                        align-items: center;
                                        gap: 6px;
                                        font-size: 11px;
                                        color: #6B7280;
                                        font-weight: 600;
                                        margin-bottom: 10px;
                                        text-transform: uppercase;
                                        letter-spacing: 0.5px;
                                    ">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <line x1="2" y1="12" x2="22" y2="12"></line>
                                            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                        </svg>
                                        Regional Distribution
                                    </div>
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="border-bottom: 1px solid #E5E7EB;">
                                                <th style="
                                                    padding: 6px 0;
                                                    text-align: left;
                                                    font-size: 10px;
                                                    font-weight: 600;
                                                    color: #9CA3AF;
                                                    text-transform: uppercase;
                                                ">Region</th>
                                                <th style="
                                                    padding: 6px 0;
                                                    text-align: right;
                                                    font-size: 10px;
                                                    font-weight: 600;
                                                    color: #9CA3AF;
                                                    text-transform: uppercase;
                                                ">Count</th>
                                                <th style="
                                                    padding: 6px 0;
                                                    text-align: right;
                                                    font-size: 10px;
                                                    font-weight: 600;
                                                    color: #9CA3AF;
                                                    text-transform: uppercase;
                                                ">TFA</th>
                                            </tr>
                                        </thead>
                                        <tbody>`;
                            
                            ['NAM', 'LATAM', 'EMEA', 'APAC'].forEach(region => {
                                if (regionalData[region].count > 0 || regionalData[region].tfa > 0) {
                                    html += `
                                            <tr style="border-bottom: 1px solid #F3F4F6;">
                                                <td style="
                                                    padding: 8px 0;
                                                    font-size: 12px;
                                                    color: #374151;
                                                    font-weight: 500;
                                                ">${region}</td>
                                                <td style="
                                                    padding: 8px 0;
                                                    text-align: right;
                                                    font-size: 12px;
                                                    color: #111827;
                                                    font-weight: 600;
                                                ">${regionalData[region].count}</td>
                                                <td style="
                                                    padding: 8px 0;
                                                    text-align: right;
                                                    font-size: 12px;
                                                    color: #111827;
                                                    font-weight: 600;
                                                ">${formatCurrency(regionalData[region].tfa)}</td>
                                            </tr>`;
                                }
                            });
                            
                            html += `
                                        </tbody>
                                    </table>
                                </div>`;
                        }
                        
                        html += `
                                </div>
                            </div>`;
                        
                        return html;
                    },
                    x: {
                        show: false
                    },
                    y: {
                        formatter: function(val) {
                            return val;
                        }
                    }
                },
            };

            // Get the chart element and verify it exists
            const chartElement = document.querySelector("#facilityTrendChart");
            if (!chartElement) {
                console.error(
                    "Facility trend chart element #facilityTrendChart not found in DOM"
                );
                return;
            }
            
            // Verify ApexCharts is loaded
            if (typeof ApexCharts === "undefined") {
                console.error("ApexCharts library not loaded");
                chartElement.innerHTML = generateNoDataMessage('CAs & Facilities Expiring');
                return;
            }
            
            try {
                // Destroy previous instance
                if (facilityTrendChartInstance) {
                    facilityTrendChartInstance.destroy();
                    facilityTrendChartInstance = null;
                }
                
                // Clear any previous content
                chartElement.innerHTML = "";
                
                // Create and render new chart
                facilityTrendChartInstance = new ApexCharts(chartElement, options);
                facilityTrendChartInstance.render();
                
                // Make bars clickable by adding cursor pointer
                setTimeout(() => {
                    const bars = chartElement.querySelectorAll('.apexcharts-bar-area');
                    bars.forEach(bar => {
                        bar.style.cursor = 'pointer';
                    });
                }, 100);
                
                // Add tooltip positioning fix with mutation observer to prevent flickering
                setTimeout(() => {
                    const tooltipObserver = new MutationObserver(() => {
                        const tooltip = chartElement.querySelector('.apexcharts-tooltip.apexcharts-active');
                        if (tooltip && !tooltip.hasAttribute('data-positioned')) {
                            const tooltipRect = tooltip.getBoundingClientRect();
                            const windowWidth = window.innerWidth;
                            const windowHeight = window.innerHeight;
                            const margin = 10;
                            
                            let needsReposition = false;
                            
                            // Check and adjust horizontal position
                            if (tooltipRect.left < margin) {
                                tooltip.style.left = margin + 'px';
                                tooltip.style.transform = 'none';
                                needsReposition = true;
                            } else if (tooltipRect.right > windowWidth - margin) {
                                tooltip.style.left = (windowWidth - tooltipRect.width - margin) + 'px';
                                tooltip.style.transform = 'none';
                                needsReposition = true;
                            }
                            
                            // Check and adjust vertical position
                            if (tooltipRect.top < margin) {
                                tooltip.style.top = margin + 'px';
                                needsReposition = true;
                            } else if (tooltipRect.bottom > windowHeight - margin) {
                                tooltip.style.top = (windowHeight - tooltipRect.height - margin) + 'px';
                                needsReposition = true;
                            }
                            
                            if (needsReposition) {
                                tooltip.setAttribute('data-positioned', 'true');
                            }
                        }
                        
                        // Remove marker when tooltip is hidden
                        const hiddenTooltip = chartElement.querySelector('.apexcharts-tooltip:not(.apexcharts-active)[data-positioned]');
                        if (hiddenTooltip) {
                            hiddenTooltip.removeAttribute('data-positioned');
                        }
                    });
                    
                    tooltipObserver.observe(chartElement, {
                        attributes: true,
                        attributeFilter: ['class'],
                        subtree: true
                    });
                }, 200);
                
                console.log(" Facility trend chart rendered successfully");
            } catch (error) {
                console.error(" Error rendering facility trend chart:", error);
                chartElement.innerHTML = generateNoDataMessage('CAs & Facilities Expiring');
            }
        }

        // Create combined chart for CAs Coming Due & Facilities Expiring from filtered data
        function createFacilityTrendChartFromFiltered() {
            console.log(
                " Creating filtered CAs Coming Due & Facilities Expiring chart"
            );
            
            // Check if we have filtered data
            if (!filteredData || filteredData.length === 0) {
                console.log(" No filtered data available for CAs & Facilities Expiring chart");
                const chartElement = document.querySelector("#facilityTrendChart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('CAs & Facilities Expiring');
                }
                return;
            }
            
            // Get the current reporting month from the data
            const reportDates = filteredData
                .map((row) => parseDate(row.Report_Date))
                .filter((d) => d);
            if (reportDates.length === 0) {
                console.log(" No valid report dates found in filtered data");
                return;
            }
            const maxReportDate = new Date(Math.max(...reportDates));
            maxReportDate.setHours(0, 0, 0, 0);
            
            // Store report date for filtering
            window.currentReportDate = maxReportDate;
            
            // Generate next 3 months starting from current month
            const next3Months = [];
            for (let i = 0; i < 3; i++) {
                const date = new Date(maxReportDate);
                date.setMonth(date.getMonth() + i);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, "0");
                next3Months.push(`${year}-${month}`);
            }
            
            // Group by month-year for both CAs and Facilities
            const monthlyData = {};
            
            // Initialize all 3 months
            next3Months.forEach((monthYear) => {
                monthlyData[monthYear] = {
                    casComingDueByRelationship: new Set(), // Unique Relationship_IDs for all regions
                    facilitiesExpiring: new Set(), // Unique Facility IDs
                    caAmounts: { tfa: 0, direct: 0, contingent: 0, pse: 0 },
                    facilityAmounts: { tfa: 0, direct: 0, contingent: 0, pse: 0 },
                };
            });
            
            // Collect CAs Coming Due (only future dates from report date, CM only)
            // Use unique Relationship_IDs for all regions (EMEA requires CA_Review = "Yes")
            filteredData.forEach((row) => {
                const caExpirationDate = row.CA_Expiration_Date;
                const managementStatus = (row.Management_Status || "").toUpperCase();
                const region = (row.Region || "").toUpperCase();
                const caReview = (row.CA_Review || "").trim();
                
                if (caExpirationDate && managementStatus === "CM") {
                    const dateObj = parseDate(caExpirationDate);
                    if (dateObj && dateObj >= maxReportDate) {
                        // Only future dates (coming due from report date)
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthYear = `${year}-${month}`;
                        
                        // Only include if it's in our next 3 months
                        if (next3Months.includes(monthYear)) {
                            // For EMEA: require CA_Review = "Yes"
                            // For all other regions: count all CAs
                            // All regions use unique Relationship_IDs
                            if (region === "EMEA") {
                                if (caReview === "Yes" && row.Relationship_ID) {
                                    monthlyData[monthYear].casComingDueByRelationship.add(row.Relationship_ID);
                                    // Accumulate amounts for EMEA CAs (sum ALL lines)
                                    monthlyData[monthYear].caAmounts.tfa += parseNumber(
                                        row.Fac_Amount || row.Facility_Amount
                                    );
                                    monthlyData[monthYear].caAmounts.direct += parseNumber(
                                        row.Direct_OS
                                    );
                                    monthlyData[monthYear].caAmounts.contingent += parseNumber(
                                        row.Contingent_OS
                                    );
                                    monthlyData[monthYear].caAmounts.pse += parseNumber(row.PSE_OS);
                                }
                            } else {
                                // For non-EMEA: count unique Relationship_IDs
                                if (row.Relationship_ID) {
                                    monthlyData[monthYear].casComingDueByRelationship.add(row.Relationship_ID);
                                    // Accumulate amounts for non-EMEA CAs (sum ALL lines)
                                    monthlyData[monthYear].caAmounts.tfa += parseNumber(
                                        row.Fac_Amount || row.Facility_Amount
                                    );
                                    monthlyData[monthYear].caAmounts.direct += parseNumber(
                                        row.Direct_OS
                                    );
                                    monthlyData[monthYear].caAmounts.contingent += parseNumber(
                                        row.Contingent_OS
                                    );
                                    monthlyData[monthYear].caAmounts.pse += parseNumber(row.PSE_OS);
                                }
                            }
                        }
                    }
                }
            });
            
            // Collect Facilities Expiring (only future dates from report date, NO DM exclusion)
            filteredData.forEach((row) => {
                const maturityDate = row.Maturity_Date;
                const facilityId = row.Facility_ID;
                
                if (maturityDate && facilityId) {
                    const dateObj = parseDate(maturityDate);
                    if (dateObj && dateObj >= maxReportDate) {
                        // Only future dates (expiring from report date)
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthYear = `${year}-${month}`;
                        
                        // Only include if it's in our next 3 months
                        if (next3Months.includes(monthYear)) {
                            monthlyData[monthYear].facilitiesExpiring.add(facilityId); // Use add for Set
                            // Accumulate amounts for Facilities (sum ALL lines)
                            monthlyData[monthYear].facilityAmounts.tfa += parseNumber(
                                row.Fac_Amount || row.Facility_Amount
                            );
                            monthlyData[monthYear].facilityAmounts.direct += parseNumber(
                                row.Direct_OS
                            );
                            monthlyData[monthYear].facilityAmounts.contingent +=
                                parseNumber(row.Contingent_OS);
                            monthlyData[monthYear].facilityAmounts.pse += parseNumber(
                                row.PSE_OS
                            );
                        }
                    }
                }
            });
            
            // Prepare data for the next 3 months
            const categories = next3Months.map((m) => {
                const date = new Date(m + "-01");
                return date.toLocaleDateString("en-US", { month: "short" });
            });

            const casComingDueData = next3Months.map(
                (month) => monthlyData[month].casComingDueByRelationship.size
            );
            const facilitiesExpiringData = next3Months.map(
                (month) => monthlyData[month].facilitiesExpiring.size // Changed from .length to .size
            );

            // Check if all data is empty
            const totalCAs = casComingDueData.reduce((sum, val) => sum + val, 0);
            const totalFacilities = facilitiesExpiringData.reduce((sum, val) => sum + val, 0);

            if (totalCAs === 0 && totalFacilities === 0) {
                console.log(" No expiration data available for filtered results");
                const chartElement = document.querySelector("#facilityTrendChart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('CAs & Facilities Expiring');
                }
                return;
            }
            
            const options = {
                series: [
                    {
                        name: "CAs Coming Due",
                        data: casComingDueData,
                    },
                    {
                        name: "Facilities Expiring",
                        data: facilitiesExpiringData,
                    },
                ],
                colors: ["#C2D6FF", "#465FFF"],
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "bar",
                    stacked: false,
                    height: "100%",
                    toolbar: {
                        show: false,
                    },
                    zoom: {
                        enabled: false,
                    },
                    events: {
                        // Chart click filtering disabled
                    },
                    events_disabled: {
                        // Expiry chart click functionality removed
                        dataPointSelection: function (event, chartContext, config) {
                            const selectedMonth = next3Months[config.dataPointIndex];
                            const monthName = categories[config.dataPointIndex];
                            const seriesName = config.w.config.series[config.seriesIndex].name;
                            console.log("Month clicked:", monthName, "Series:", seriesName, "Month Key:", selectedMonth);
                        },
                    },
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: "50%",
                        borderRadius: 4,
                        borderRadiusApplication: "end",
                        dataLabels: {
                            position: 'top',
                        },
                    },
                },
                stroke: {
                    show: true,
                    width: 4,
                    colors: ["transparent"]
                },
                states: {
                    active: {
                        allowMultipleDataPointsSelection: false,
                        filter: {
                            type: 'darken',
                            value: 0.7,
                        }
                    }
                },
                dataLabels: {
                    enabled: true,
                    offsetY: -30,
                    style: {
                        fontSize: '11px',
                        fontWeight: 500,
                        colors: ['#374151']
                    },
                    background: {
                        enabled: true,
                        foreColor: '#374151',
                        backgroundColor: '#F3F4F6',
                        borderRadius: 12,
                        padding: 8,
                        opacity: 1,
                        borderWidth: 0
                    },
                    formatter: function(val, opts) {
                        return val;
                    }
                },
                xaxis: {
                    categories: categories,
                    axisBorder: {
                        show: false,
                    },
                    axisTicks: {
                        show: false,
                    },
                },
                legend: {
                    show: true,
                    position: "top",
                    horizontalAlign: "center",
                    fontFamily: "Outfit, sans-serif",
                    fontSize: "12px",
                    markers: {
                        width: 12,
                        height: 12,
                        radius: 3,
                    },
                    itemMargin: {
                        horizontal: 10,
                        vertical: 0,
                    },
                },
                yaxis: {
                    title: false,
                    labels: {
                        align: 'left',
                        offsetX: -10,
                    },
                },
                grid: {
                    borderColor: '#E5E7EB',
                    strokeDashArray: 4,
                    yaxis: {
                        lines: {
                            show: true,
                        },
                    },
                },
                fill: {
                    opacity: 1,
                },
                tooltip: {
                    theme: "light",
                    shared: false,
                    intersect: true,
                    followCursor: false,
                    fixed: {
                        enabled: false,
                    },
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        const monthKey = next3Months[dataPointIndex];
                        const monthData = monthlyData[monthKey];
                        const monthName = categories[dataPointIndex];
                        const seriesName = w.config.series[seriesIndex].name;
                        
                        // Calculate regional distribution
                        const regionalData = { NAM: { count: 0, tfa: 0 }, LATAM: { count: 0, tfa: 0 }, EMEA: { count: 0, tfa: 0 }, APAC: { count: 0, tfa: 0 } };
                        
                        if (seriesName === "CAs Coming Due") {
                            // For CAs, iterate through data and match with relationships in this month
                            portfolioData.forEach(row => {
                                if (monthData.casComingDueByRelationship.has(row.Relationship_ID)) {
                                    const caExpirationDate = row.CA_Expiration_Date;
                                    const dateObj = parseDate(caExpirationDate);
                                    if (dateObj) {
                                        const year = dateObj.getFullYear();
                                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                                        const rowMonthKey = `${year}-${month}`;
                                        if (rowMonthKey === monthKey) {
                                            const region = (row.Region || "").toUpperCase();
                                            if (regionalData[region]) {
                                                regionalData[region].tfa += parseNumber(row.Fac_Amount || row.Facility_Amount);
                                            }
                                        }
                                    }
                                }
                            });
                            // Count unique relationships per region
                            portfolioData.forEach(row => {
                                if (monthData.casComingDueByRelationship.has(row.Relationship_ID)) {
                                    const region = (row.Region || "").toUpperCase();
                                    if (regionalData[region]) {
                                        regionalData[region].count++;
                                    }
                                }
                            });
                        } else {
                            // For Facilities, iterate through data and match with facility IDs in this month
                            const countedFacilities = new Set();
                            portfolioData.forEach(row => {
                                if (monthData.facilitiesExpiring.has(row.Facility_ID)) {
                                    const maturityDate = row.Maturity_Date;
                                    const dateObj = parseDate(maturityDate);
                                    if (dateObj) {
                                        const year = dateObj.getFullYear();
                                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                                        const rowMonthKey = `${year}-${month}`;
                                        if (rowMonthKey === monthKey) {
                                            const region = (row.Region || "").toUpperCase();
                                            if (regionalData[region]) {
                                                regionalData[region].tfa += parseNumber(row.Fac_Amount || row.Facility_Amount);
                                                if (!countedFacilities.has(row.Facility_ID)) {
                                                    regionalData[region].count++;
                                                    countedFacilities.add(row.Facility_ID);
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        }
                        
                        let html = `
                            <div style="
                                background: #ffffff; 
                                border-radius: 12px; 
                                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
                                min-width: 420px;
                                max-width: 460px;
                                overflow: hidden;
                                font-family: Outfit, sans-serif;
                            ">
                                <!-- Header with border -->
                                <div style="
                                    border-bottom: 1px solid #E5E7EB;
                                    padding: 16px 16px 12px 16px;
                                    margin-bottom: 14px;
                                ">
                                    <div style="
                                        font-weight: 600; 
                                        font-size: 15px; 
                                        color: #111827;
                                        margin-bottom: 4px;
                                    ">${monthName}</div>
                                    <div style="
                                        font-size: 12px; 
                                        font-weight: 500;
                                        color: #6B7280;
                                    ">${seriesName}</div>
                                </div>
                                
                                <!-- Content wrapper -->
                                <div style="padding: 0 16px 16px 16px;">`;
                        
                        if (seriesName === "CAs Coming Due") {
                            const casCount = monthData.casComingDueByRelationship.size;
                            html += `
                                <!-- Widget Grid (2 columns) -->
                                <div style="
                                    display: grid;
                                    grid-template-columns: 1fr 1fr;
                                    gap: 10px;
                                    margin-bottom: 12px;
                                ">
                                    <!-- Widget 1: Total Relationships -->
                                    <div style="
                                        background: #F9FAFB;
                                        border-radius: 8px;
                                        padding: 12px;
                                        border: 1px solid #E5E7EB;
                                    ">
                                        <div style="
                                            display: flex;
                                            align-items: center;
                                            gap: 6px;
                                            font-size: 11px;
                                            color: #6B7280;
                                            font-weight: 500;
                                            margin-bottom: 6px;
                                        ">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                                <circle cx="9" cy="7" r="4"></circle>
                                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                            </svg>
                                            Relationships
                                        </div>
                                        <div style="
                                            font-size: 20px;
                                            font-weight: 700;
                                            color: #111827;
                                        ">${casCount}</div>
                                    </div>
                                    
                                    <!-- Widget 2: Total TFA -->
                                    <div style="
                                        background: #F9FAFB;
                                        border-radius: 8px;
                                        padding: 12px;
                                        border: 1px solid #E5E7EB;
                                    ">
                                        <div style="
                                            display: flex;
                                            align-items: center;
                                            gap: 6px;
                                            font-size: 11px;
                                            color: #6B7280;
                                            font-weight: 500;
                                            margin-bottom: 6px;
                                        ">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                            </svg>
                                            Total TFA
                                        </div>
                                        <div style="
                                            font-size: 15px;
                                            font-weight: 700;
                                            color: #111827;
                                        ">${formatCurrency(monthData.caAmounts.tfa)}</div>
                                    </div>
                                </div>
                                
                                <!-- Regional Distribution Table (Full Width) -->
                                <div style="
                                    background: #F9FAFB;
                                    border-radius: 8px;
                                    padding: 12px;
                                    border: 1px solid #E5E7EB;
                                ">
                                    <div style="
                                        display: flex;
                                        align-items: center;
                                        gap: 6px;
                                        font-size: 11px;
                                        color: #6B7280;
                                        font-weight: 600;
                                        margin-bottom: 10px;
                                        text-transform: uppercase;
                                        letter-spacing: 0.5px;
                                    ">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <line x1="2" y1="12" x2="22" y2="12"></line>
                                            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                        </svg>
                                        Regional Distribution
                                    </div>
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="border-bottom: 1px solid #E5E7EB;">
                                                <th style="
                                                    padding: 6px 0;
                                                    text-align: left;
                                                    font-size: 10px;
                                                    font-weight: 600;
                                                    color: #9CA3AF;
                                                    text-transform: uppercase;
                                                ">Region</th>
                                                <th style="
                                                    padding: 6px 0;
                                                    text-align: right;
                                                    font-size: 10px;
                                                    font-weight: 600;
                                                    color: #9CA3AF;
                                                    text-transform: uppercase;
                                                ">Count</th>
                                                <th style="
                                                    padding: 6px 0;
                                                    text-align: right;
                                                    font-size: 10px;
                                                    font-weight: 600;
                                                    color: #9CA3AF;
                                                    text-transform: uppercase;
                                                ">TFA</th>
                                            </tr>
                                        </thead>
                                        <tbody>`;
                            
                            ['NAM', 'LATAM', 'EMEA', 'APAC'].forEach(region => {
                                if (regionalData[region].count > 0 || regionalData[region].tfa > 0) {
                                    html += `
                                            <tr style="border-bottom: 1px solid #F3F4F6;">
                                                <td style="
                                                    padding: 8px 0;
                                                    font-size: 12px;
                                                    color: #374151;
                                                    font-weight: 500;
                                                ">${region}</td>
                                                <td style="
                                                    padding: 8px 0;
                                                    text-align: right;
                                                    font-size: 12px;
                                                    color: #111827;
                                                    font-weight: 600;
                                                ">${regionalData[region].count}</td>
                                                <td style="
                                                    padding: 8px 0;
                                                    text-align: right;
                                                    font-size: 12px;
                                                    color: #111827;
                                                    font-weight: 600;
                                                ">${formatCurrency(regionalData[region].tfa)}</td>
                                            </tr>`;
                                }
                            });
                            
                            html += `
                                        </tbody>
                                    </table>
                                </div>`;
                        } else if (seriesName === "Facilities Expiring") {
                            const facilitiesCount = monthData.facilitiesExpiring.size;
                            html += `
                                <!-- Widget Grid (2 columns) -->
                                <div style="
                                    display: grid;
                                    grid-template-columns: 1fr 1fr;
                                    gap: 10px;
                                    margin-bottom: 12px;
                                ">
                                    <!-- Widget 1: Total Facilities -->
                                    <div style="
                                        background: #F9FAFB;
                                        border-radius: 8px;
                                        padding: 12px;
                                        border: 1px solid #E5E7EB;
                                    ">
                                        <div style="
                                            display: flex;
                                            align-items: center;
                                            gap: 6px;
                                            font-size: 11px;
                                            color: #6B7280;
                                            font-weight: 500;
                                            margin-bottom: 6px;
                                        ">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                                <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                            </svg>
                                            Facilities
                                        </div>
                                        <div style="
                                            font-size: 20px;
                                            font-weight: 700;
                                            color: #111827;
                                        ">${facilitiesCount}</div>
                                    </div>
                                    
                                    <!-- Widget 2: Total TFA -->
                                    <div style="
                                        background: #F9FAFB;
                                        border-radius: 8px;
                                        padding: 12px;
                                        border: 1px solid #E5E7EB;
                                    ">
                                        <div style="
                                            display: flex;
                                            align-items: center;
                                            gap: 6px;
                                            font-size: 11px;
                                            color: #6B7280;
                                            font-weight: 500;
                                            margin-bottom: 6px;
                                        ">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                            </svg>
                                            Total TFA
                                        </div>
                                        <div style="
                                            font-size: 15px;
                                            font-weight: 700;
                                            color: #111827;
                                        ">${formatCurrency(monthData.facilityAmounts.tfa)}</div>
                                    </div>
                                </div>
                                
                                <!-- Regional Distribution Table (Full Width) -->
                                <div style="
                                    background: #F9FAFB;
                                    border-radius: 8px;
                                    padding: 12px;
                                    border: 1px solid #E5E7EB;
                                ">
                                    <div style="
                                        display: flex;
                                        align-items: center;
                                        gap: 6px;
                                        font-size: 11px;
                                        color: #6B7280;
                                        font-weight: 600;
                                        margin-bottom: 10px;
                                        text-transform: uppercase;
                                        letter-spacing: 0.5px;
                                    ">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <line x1="2" y1="12" x2="22" y2="12"></line>
                                            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                        </svg>
                                        Regional Distribution
                                    </div>
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="border-bottom: 1px solid #E5E7EB;">
                                                <th style="
                                                    padding: 6px 0;
                                                    text-align: left;
                                                    font-size: 10px;
                                                    font-weight: 600;
                                                    color: #9CA3AF;
                                                    text-transform: uppercase;
                                                ">Region</th>
                                                <th style="
                                                    padding: 6px 0;
                                                    text-align: right;
                                                    font-size: 10px;
                                                    font-weight: 600;
                                                    color: #9CA3AF;
                                                    text-transform: uppercase;
                                                ">Count</th>
                                                <th style="
                                                    padding: 6px 0;
                                                    text-align: right;
                                                    font-size: 10px;
                                                    font-weight: 600;
                                                    color: #9CA3AF;
                                                    text-transform: uppercase;
                                                ">TFA</th>
                                            </tr>
                                        </thead>
                                        <tbody>`;
                            
                            ['NAM', 'LATAM', 'EMEA', 'APAC'].forEach(region => {
                                if (regionalData[region].count > 0 || regionalData[region].tfa > 0) {
                                    html += `
                                            <tr style="border-bottom: 1px solid #F3F4F6;">
                                                <td style="
                                                    padding: 8px 0;
                                                    font-size: 12px;
                                                    color: #374151;
                                                    font-weight: 500;
                                                ">${region}</td>
                                                <td style="
                                                    padding: 8px 0;
                                                    text-align: right;
                                                    font-size: 12px;
                                                    color: #111827;
                                                    font-weight: 600;
                                                ">${regionalData[region].count}</td>
                                                <td style="
                                                    padding: 8px 0;
                                                    text-align: right;
                                                    font-size: 12px;
                                                    color: #111827;
                                                    font-weight: 600;
                                                ">${formatCurrency(regionalData[region].tfa)}</td>
                                            </tr>`;
                                }
                            });
                            
                            html += `
                                        </tbody>
                                    </table>
                                </div>`;
                        }
                        
                        html += `
                                </div>
                            </div>`;
                        
                        return html;
                    },
                    x: {
                        show: false
                    },
                    y: {
                        formatter: function(val) {
                            return val;
                        }
                    }
                },
            };

            const chartElement = document.querySelector("#facilityTrendChart");
            if (!chartElement) {
                console.error("Facility trend chart element not found");
                return;
            }
            
            if (typeof ApexCharts === "undefined") {
                console.error("ApexCharts library not loaded");
                chartElement.innerHTML = generateNoDataMessage('CAs & Facilities Expiring');
                return;
            }
            
            try {
                if (facilityTrendChartInstance) {
                    facilityTrendChartInstance.destroy();
                    facilityTrendChartInstance = null;
                }
                
                chartElement.innerHTML = "";
                
                facilityTrendChartInstance = new ApexCharts(chartElement, options);
                facilityTrendChartInstance.render();
                
                // Make bars clickable by adding cursor pointer
                setTimeout(() => {
                    const bars = chartElement.querySelectorAll('.apexcharts-bar-area');
                    bars.forEach(bar => {
                        bar.style.cursor = 'pointer';
                    });
                }, 100);
                
                console.log(" Filtered facility trend chart rendered successfully");
            } catch (error) {
                console.error(
                    " Error rendering filtered facility trend chart:",
                    error
                );
                chartElement.innerHTML = generateNoDataMessage('CAs & Facilities Expiring');
            }
        }

        // Parse date in multiple formats (YYYY-MM-DD, DD/MM/YYYY, etc.)
        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            // If it's already a Date object (from Excel parsing), return it
            if (dateStr instanceof Date) {
                return !isNaN(dateStr.getTime()) ? dateStr : null;
            }
            
            // Convert to string for parsing
            const str = String(dateStr).trim();
            if (!str) return null;
            
            try {
                // Handle YYYY-MM-DD format (most common in CSV)
                if (str.includes("-")) {
                    const parts = str.split("-");
                    if (parts.length === 3) {
                        // Check if it's YYYY-MM-DD
                        if (parts[0].length === 4) {
                            const year = parseInt(parts[0]);
                            const month = parseInt(parts[1]) - 1; // JavaScript months are 0-indexed
                            const day = parseInt(parts[2]);
                            const date = new Date(year, month, day);
                            if (!isNaN(date.getTime())) {
                                return date;
                            }
                        }
                    }
                }
                
                // Handle DD/MM/YYYY format
                if (str.includes("/")) {
                    const parts = str.split("/");
                    if (parts.length === 3) {
                        const day = parseInt(parts[0]);
                        const month = parseInt(parts[1]) - 1; // JavaScript months are 0-indexed
                        const year = parseInt(parts[2]);
                        const date = new Date(year, month, day);
                        if (!isNaN(date.getTime())) {
                            return date;
                        }
                    }
                }
                
                // Handle "MMM DD, YYYY" format (e.g., "Jan 15, 2024" or "Dec 1, 2023")
                // This also handles "MMMM DD, YYYY" (e.g., "January 15, 2024")
                const monthDayYearPattern = /^([A-Za-z]+)\s+(\d{1,2}),?\s+(\d{4})$/;
                const match = str.match(monthDayYearPattern);
                if (match) {
                    const monthStr = match[1];
                    const day = parseInt(match[2]);
                    const year = parseInt(match[3]);
                    
                    // Parse month name to number
                    const date = new Date(`${monthStr} ${day}, ${year}`);
                    if (!isNaN(date.getTime())) {
                        return date;
                    }
                }
                
                // Try standard date parsing as fallback (handles many formats)
                const date = new Date(str);
                if (!isNaN(date.getTime())) {
                    return date;
                }
            } catch (e) {
                // Only log occasionally to avoid console spam
                if (Math.random() < 0.01) {
                    console.warn("Invalid date:", str);
                }
            }
            return null;
        }

        // Aggregate expiration data for the next 3 months (counts unique Facilities only, excludes DM)
        function aggregateExpirationData(data) {
            console.log(
                ` Aggregating maturity data for ${data.length} rows (Expired vs Expiring)`
            );
            
            // Get report date from data
            const reportDates = data
                .map((row) => parseDate(row.Report_Date))
                .filter((d) => d);
            if (reportDates.length === 0) {
                console.log(" No valid report dates found");
                return { categories: [], expiredData: [], expiringData: [] };
            }
            const maxReportDate = new Date(Math.max(...reportDates));
            maxReportDate.setHours(0, 0, 0, 0);
            
            // Group by month-year with Sets to track unique Facility IDs
            const expiredByMonth = {}; // { 'YYYY-MM': Set<Facility_ID> }
            const expiringByMonth = {}; // { 'YYYY-MM': Set<Facility_ID> }
            
            let expiredCount = 0;
            let expiringCount = 0;
            let validMaturityDates = 0;
            
            data.forEach((row, index) => {
                const maturityDate = row.Maturity_Date;
                const managementStatus = (row.Management_Status || "").toUpperCase();
                
                if (maturityDate && managementStatus !== "DM") {
                    const dateObj = parseDate(maturityDate);
                    if (dateObj && row.Facility_ID) {
                        validMaturityDates++;
                        
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthYear = `${year}-${month}`;
                        
                        // Determine if expired or expiring (based on report date)
                        if (dateObj < maxReportDate) {
                            // Expired (before report date)
                            expiredCount++;
                            if (!expiredByMonth[monthYear]) {
                                expiredByMonth[monthYear] = new Set();
                            }
                            expiredByMonth[monthYear].add(row.Facility_ID);
                        } else {
                            // Expiring (on or after report date)
                            expiringCount++;
                            if (!expiringByMonth[monthYear]) {
                                expiringByMonth[monthYear] = new Set();
                            }
                            expiringByMonth[monthYear].add(row.Facility_ID);
                        }
                        
                        // Log first few for debugging
                        if (index < 3) {
                            const status = dateObj < maxReportDate ? "Expired" : "Expiring";
                            console.log(
                                `  Row ${index}: Maturity=${maturityDate}  ${monthYear}, Status=${status}, Facility=${row.Facility_ID}, Report Date=${maxReportDate}`
                            );
                        }
                    }
                }
            });
            
            console.log(`  Valid maturity dates: ${validMaturityDates}`);
            console.log(`  Expired facilities: ${expiredCount}`);
            console.log(`  Expiring facilities: ${expiringCount}`);
            
            // Get all unique months and sort (last 12 months)
            const allMonths = [
                ...new Set([
                    ...Object.keys(expiredByMonth),
                    ...Object.keys(expiringByMonth),
                ]),
            ].sort();
            const last12Months = allMonths.slice(-12); // Get last 12 months
            
            // Convert Sets to counts for each month
            const expiredData = last12Months.map((month) =>
                expiredByMonth[month] ? expiredByMonth[month].size : 0
            );
            const expiringData = last12Months.map((month) =>
                expiringByMonth[month] ? expiringByMonth[month].size : 0
            );
            
            return {
                expired: expiredData,
                expiring: expiringData,
                allMonths: last12Months,
            };
        }

        // Aggregate data by month and year
        function aggregateByMonthYear(data, dateField) {
            console.log(`Aggregating ${data.length} rows by ${dateField}`);
            const grouped = {};
            let validDates = 0;
            let invalidDates = 0;
            
            data.forEach((row, index) => {
                const dateValue = row[dateField];
                if (dateValue) {
                    const dateObj = parseDate(dateValue);
                    if (dateObj) {
                        validDates++;
                        // Format as YYYY-MM
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthYear = `${year}-${month}`;
                        grouped[monthYear] = (grouped[monthYear] || 0) + 1;
                        
                        // Log first few dates for debugging
                        if (index < 3) {
                            console.log(
                                `  Row ${index}: ${dateField}="${dateValue}"  ${monthYear}`
                            );
                        }
                    } else {
                        invalidDates++;
                        if (index < 3) {
                            console.log(
                                `  Row ${index}: ${dateField}="${dateValue}"  INVALID`
                            );
                        }
                    }
                } else {
                    invalidDates++;
                }
            });
            
            console.log(
                `Valid dates: ${validDates}, Invalid/Empty: ${invalidDates}`
            );
            console.log(`Unique months: ${Object.keys(grouped).length}`);
            
            return Object.entries(grouped)
                .map(([month, count]) => ({ month, count }))
                .sort((a, b) => a.month.localeCompare(b.month));
        }

        // Aggregate data by date
        function aggregateByDate(data, dateField) {
            const grouped = {};
            data.forEach((row) => {
                const date = row[dateField];
                if (date) {
                    const monthYear = date.substring(0, 7); // YYYY-MM
                    grouped[monthYear] = (grouped[monthYear] || 0) + 1;
                }
            });
            
            return Object.entries(grouped)
                .map(([date, count]) => ({ date: date + "-01", count }))
                .sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        // Create relationship bar chart (OPTIMIZED)
        function createRelationshipChart() {
            const startTime = performance.now();
            const topN = parseInt(document.getElementById("topNFilter").value);
            
            // Use amount type based on filter selection
            let fieldName, seriesName;
            switch (selectedAmountType) {
                case "direct":
                    fieldName = "Direct_OS";
                    seriesName = "Direct OS";
                    break;
                case "contingent":
                    fieldName = "Contingent_OS";
                    seriesName = "Contingent OS";
                    break;
                case "pse":
                    fieldName = "PSE_OS";
                    seriesName = "PSE OS";
                    break;
                case "osuc":
                    fieldName = "OSUC";
                    seriesName = "OSUC";
                    break;
                case "unused":
                    fieldName = "Unused_Committed";
                    seriesName = "Undrawn Commitment";
                    break;
                case "tfa":
                    fieldName = "Fac_Amount";
                    seriesName = "Total Facility Amount";
                    break;
                default:
                    fieldName = "Direct_OS";
                    seriesName = "Direct OS";
            }

            console.log(
                "Creating relationship chart, field:",
                fieldName,
                "dataLength:",
                portfolioData.length
            );
            
            // Use Map for better performance - store all exposure types with regional breakdown
            const relationshipData = new Map();
            let totalExposure = 0;
            
            for (let i = 0; i < portfolioData.length; i++) {
                const row = portfolioData[i];
                const relId = row.Relationship_Name || row.Relationship_ID;
                const region = (row.Region || "Unknown").toUpperCase();
                
                if (relId) {
                    if (!relationshipData.has(relId)) {
                        relationshipData.set(relId, {
                            tfa: 0,
                            direct: 0,
                            contingent: 0,
                            pse: 0,
                            osuc: 0,
                            unused: 0,
                            facilityCount: 0,
                            region: region,
                            regionalBreakdown: { 
                                NAM: { count: 0, tfa: 0, direct: 0, contingent: 0, pse: 0, osuc: 0, unused: 0 }, 
                                LATAM: { count: 0, tfa: 0, direct: 0, contingent: 0, pse: 0, osuc: 0, unused: 0 }, 
                                EMEA: { count: 0, tfa: 0, direct: 0, contingent: 0, pse: 0, osuc: 0, unused: 0 }, 
                                APAC: { count: 0, tfa: 0, direct: 0, contingent: 0, pse: 0, osuc: 0, unused: 0 } 
                            }
                        });
                    }
                    
                    const data = relationshipData.get(relId);
                    const tfaAmount = parseNumber(row.Fac_Amount || row.Facility_Amount);
                    const directAmount = parseNumber(row.Direct_OS);
                    const contingentAmount = parseNumber(row.Contingent_OS);
                    const pseAmount = parseNumber(row.PSE_OS);
                    const osucAmount = parseNumber(row.OSUC);
                    const unusedAmount = parseNumber(row.Unused_Committed);
                    
                    data.tfa += tfaAmount;
                    data.direct += directAmount;
                    data.contingent += contingentAmount;
                    data.pse += pseAmount;
                    data.osuc += osucAmount;
                    data.unused += unusedAmount;
                    if (row.Facility_ID) data.facilityCount++;
                    
                    // Regional breakdown
                    if (data.regionalBreakdown[region]) {
                        data.regionalBreakdown[region].count++;
                        data.regionalBreakdown[region].tfa += tfaAmount;
                        data.regionalBreakdown[region].direct += directAmount;
                        data.regionalBreakdown[region].contingent += contingentAmount;
                        data.regionalBreakdown[region].pse += pseAmount;
                        data.regionalBreakdown[region].osuc += osucAmount;
                        data.regionalBreakdown[region].unused += unusedAmount;
                    }
                }
            }
            
            // Calculate total exposure for percentage
            for (const [relId, data] of relationshipData.entries()) {
                let exposureValue = 0;
                switch (selectedAmountType) {
                    case "tfa": exposureValue = data.tfa; break;
                    case "direct": exposureValue = data.direct; break;
                    case "contingent": exposureValue = data.contingent; break;
                    case "pse": exposureValue = data.pse; break;
                    case "osuc": exposureValue = data.osuc; break;
                    case "unused": exposureValue = data.unused; break;
                    default: exposureValue = data.direct;
                }
                totalExposure += exposureValue;
            }
            
            console.log("Total unique relationships:", relationshipData.size);
            
            // Get the selected field value for sorting
            const relationshipTotals = new Map();
            for (const [relId, data] of relationshipData.entries()) {
                let sortValue = 0;
                switch (selectedAmountType) {
                    case "tfa":
                        sortValue = data.tfa;
                        break;
                    case "direct":
                        sortValue = data.direct;
                        break;
                    case "contingent":
                        sortValue = data.contingent;
                        break;
                    case "pse":
                        sortValue = data.pse;
                        break;
                    case "osuc":
                        sortValue = data.osuc;
                        break;
                    case "unused":
                        sortValue = data.unused;
                        break;
                    default:
                        sortValue = data.direct;
                }
                relationshipTotals.set(relId, sortValue);
            }
            
            // Convert to array and sort (only what we need)
            const sorted = Array.from(relationshipTotals.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, topN);
            
            console.log(
                `Chart aggregated ${portfolioData.length} rows, found ${relationshipTotals.size
                } relationships in ${(performance.now() - startTime).toFixed(2)}ms`
            );
            
            // Add index numbers (1, 2, 3, ...) before relationship names
            const relationships = sorted.map(
                (item, index) => `${index + 1}. ${item[0]}`
            );
            const amounts = sorted.map((item) => item[1]);
            
            // Store seriesName for tooltip
            window.topRelationshipsSeriesName = seriesName;

            // Debug logging for TFA
            console.log("DEBUG (non-filtered) - selectedAmountType:", selectedAmountType);
            console.log("DEBUG (non-filtered) - seriesName:", seriesName);
            console.log("DEBUG (non-filtered) - relationships:", relationships);
            console.log("DEBUG (non-filtered) - amounts:", amounts);
            console.log("DEBUG (non-filtered) - sorted array:", sorted);
            
            // Handle empty data
            if (relationships.length === 0) {
                console.warn("No relationship data for chart");
                return;
            }

            // Check if all amounts are zero
            const totalAmount = amounts.reduce((sum, val) => sum + val, 0);
            if (totalAmount === 0) {
                console.warn(" All amounts are zero for selectedAmountType:", selectedAmountType);
                const chartElement = document.querySelector("#relationshipChart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('Top Relationships');
                }
                return;
            }

            // Calculate dynamic height based on number of relationships (35px per bar, min 350px)
            const calculatedHeight = Math.max(350, relationships.length * 35);
            
            const options = {
                series: [
                    {
                    name: seriesName,
                        data: amounts,
                    },
                ],
                colors: ["#465fff"],
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "bar",
                    height: calculatedHeight,
                    toolbar: {
                        show: false,
                    },
                    events: {
                        // Chart click filtering disabled
                    },
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        borderRadius: 5,
                        borderRadiusApplication: "end",
                        dataLabels: {
                            position: 'top',
                        },
                    },
                },
                dataLabels: {
                    enabled: true,
                    textAnchor: 'start',
                    offsetX: 30,
                    style: {
                        fontSize: '11px',
                        fontWeight: 500,
                        colors: ['#374151']
                    },
                    background: {
                        enabled: true,
                        foreColor: '#374151',
                        backgroundColor: '#F3F4F6',
                        borderRadius: 12,
                        padding: 8,
                        opacity: 1,
                        borderWidth: 0
                    },
                    formatter: function(val) {
                        return formatCurrency(val);
                    }
                },
                stroke: {
                    show: true,
                    width: 4,
                    colors: ["transparent"],
                },
                xaxis: {
                    categories: relationships,
                    labels: {
                        formatter: function (val) {
                            return formatCurrency(val);
                        },
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                    axisBorder: {
                        show: false,
                    },
                    axisTicks: {
                        show: false,
                    },
                },
                yaxis: {
                    title: false,
                    labels: {
                        align: 'left',
                        offsetX: -10,
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                },
                legend: {
                    show: true,
                    position: "top",
                    horizontalAlign: "left",
                    fontFamily: "Outfit, sans-serif",
                    fontSize: "12px",
                    markers: {
                        radius: 12,
                    },
                },
                grid: {
                    borderColor: '#E5E7EB',
                    strokeDashArray: 4,
                    xaxis: {
                        lines: {
                            show: true,
                        },
                    },
                    yaxis: {
                        lines: {
                            show: false,
                        },
                    },
                },
                fill: {
                    opacity: 1,
                },
                tooltip: {
                    enabled: true,
                    theme: "light",
                    followCursor: false,
                    fixed: {
                        enabled: false
                    },
                    offsetX: 0,
                    offsetY: 0,
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        const relName = sorted[dataPointIndex][0]; // Get original name without index
                        const data = relationshipData.get(relName);
                        
                        if (!data) return "";
                        
                        // Get current selected exposure value for % calculation
                        let exposureValue = 0;
                        switch (selectedAmountType) {
                            case "tfa": exposureValue = data.tfa; break;
                            case "direct": exposureValue = data.direct; break;
                            case "contingent": exposureValue = data.contingent; break;
                            case "pse": exposureValue = data.pse; break;
                            case "osuc": exposureValue = data.osuc; break;
                            case "unused": exposureValue = data.unused; break;
                            default: exposureValue = data.direct;
                        }
                        
                        const percentage = totalExposure > 0 ? ((exposureValue / totalExposure) * 100).toFixed(1) : 0;
                        const regionalBreakdown = data.regionalBreakdown || { NAM: { count: 0 }, LATAM: { count: 0 }, EMEA: { count: 0 }, APAC: { count: 0 } };
                        
                        // Get regional exposure based on selected amount type
                        const getRegionalExposure = (regionData) => {
                            switch (selectedAmountType) {
                                case "tfa": return regionData.tfa;
                                case "contingent": return regionData.contingent;
                                case "pse": return regionData.pse;
                                case "osuc": return regionData.osuc;
                                case "unused": return regionData.unused;
                                case "direct":
                                default: return regionData.direct;
                            }
                        };
                        
                        // Build regional table rows
                        let regionalRows = '';
                        ['NAM', 'LATAM', 'EMEA', 'APAC'].forEach(region => {
                            const regionData = regionalBreakdown[region];
                            if (regionData && regionData.count > 0) {
                                const regionExposure = getRegionalExposure(regionData);
                                regionalRows += `
                                    <tr>
                                        <td style="padding: 6px 8px; text-align: left; font-size: 11px; color: #6B7280; font-weight: 500;">${region}</td>
                                        <td style="padding: 6px 8px; text-align: center; font-size: 11px; color: #111827; font-weight: 600;">${regionData.count}</td>
                                        <td style="padding: 6px 8px; text-align: right; font-size: 11px; color: #111827; font-weight: 600;">${formatCurrency(regionExposure)}</td>
                                    </tr>
                                `;
                            }
                        });
                        
                        return `
                            <div style="
                                background: #ffffff; 
                                border-radius: 12px; 
                                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
                                min-width: 360px;
                                max-width: 400px;
                                overflow: hidden;
                                font-family: Outfit, sans-serif;
                                position: relative;
                                z-index: 99999;
                            ">
                                <!-- Header with border -->
                                <div style="
                                    border-bottom: 1px solid #E5E7EB;
                                    padding: 16px 16px 12px 16px;
                                    margin-bottom: 14px;
                                ">
                                    <div style="
                                        font-weight: 600; 
                                        font-size: 15px; 
                                        color: #111827;
                                        margin-bottom: 4px;
                                    ">${relName}</div>
                                    <div style="
                                        font-size: 12px; 
                                        font-weight: 500;
                                        color: #6B7280;
                                    ">Relationship</div>
                                </div>
                                
                                <!-- Content wrapper -->
                                <div style="padding: 0 16px 16px 16px;">
                                    <!-- Widget Grid (3 columns for main metrics) -->
                                    <div style="
                                        display: grid;
                                        grid-template-columns: 1fr 1fr 1fr;
                                        gap: 8px;
                                        margin-bottom: 16px;
                                    ">
                                        <!-- Widget 1: Facility Count -->
                                        <div style="
                                            background: #F9FAFB;
                                            border-radius: 8px;
                                            padding: 10px;
                                            border: 1px solid #E5E7EB;
                                        ">
                                            <div style="
                                                display: flex;
                                                align-items: center;
                                                gap: 4px;
                                                font-size: 10px;
                                                color: #6B7280;
                                                font-weight: 500;
                                                margin-bottom: 4px;
                                            ">
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                                </svg>
                                                Count
                                            </div>
                                            <div style="
                                                font-size: 18px;
                                                font-weight: 700;
                                                color: #111827;
                                            ">${data.facilityCount}</div>
                                        </div>
                                        
                                        <!-- Widget 2: Selected Exposure -->
                                        <div style="
                                            background: #F9FAFB;
                                            border-radius: 8px;
                                            padding: 10px;
                                            border: 1px solid #E5E7EB;
                                        ">
                                            <div style="
                                                display: flex;
                                                align-items: center;
                                                gap: 4px;
                                                font-size: 10px;
                                                color: #6B7280;
                                                font-weight: 500;
                                                margin-bottom: 4px;
                                            ">
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <line x1="12" y1="1" x2="12" y2="23"></line>
                                                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                                </svg>
                                                ${seriesName}
                                            </div>
                                            <div style="
                                                font-size: 14px;
                                                font-weight: 700;
                                                color: #111827;
                                            ">${formatCurrency(exposureValue)}</div>
                                        </div>
                                        
                                        <!-- Widget 3: % of Total -->
                                        <div style="
                                            background: #F9FAFB;
                                            border-radius: 8px;
                                            padding: 10px;
                                            border: 1px solid #E5E7EB;
                                        ">
                                            <div style="
                                                display: flex;
                                                align-items: center;
                                                gap: 4px;
                                                font-size: 10px;
                                                color: #6B7280;
                                                font-weight: 500;
                                                margin-bottom: 4px;
                                            ">
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <circle cx="12" cy="12" r="10"></circle>
                                                    <polyline points="12 6 12 12 16 14"></polyline>
                                                </svg>
                                                % Total
                                            </div>
                                            <div style="
                                                font-size: 18px;
                                                font-weight: 700;
                                                color: #111827;
                                            ">${percentage}%</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Exposure Breakdown Row -->
                                    <div style="
                                        display: flex;
                                        gap: 8px;
                                        margin-bottom: 16px;
                                        padding: 10px 12px;
                                        background: #F9FAFB;
                                        border-radius: 6px;
                                        border: 1px solid #E5E7EB;
                                    ">
                                        <div style="flex: 1;">
                                            <div style="font-size: 10px; color: #6B7280; font-weight: 500; margin-bottom: 2px;">TFA</div>
                                            <div style="font-size: 13px; font-weight: 600; color: #111827;">${formatCurrency(data.tfa)}</div>
                                        </div>
                                        <div style="width: 1px; background: #E5E7EB;"></div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 10px; color: #6B7280; font-weight: 500; margin-bottom: 2px;">Direct</div>
                                            <div style="font-size: 13px; font-weight: 600; color: #111827;">${formatCurrency(data.direct)}</div>
                                        </div>
                                        ${data.osuc > 0 ? `
                                        <div style="width: 1px; background: #E5E7EB;"></div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 10px; color: #6B7280; font-weight: 500; margin-bottom: 2px;">OSUC</div>
                                            <div style="font-size: 13px; font-weight: 600; color: #111827;">${formatCurrency(data.osuc)}</div>
                                        </div>
                                        ` : ''}
                                    </div>
                                    
                                    <!-- Regional Distribution Table -->
                                    <div style="margin-top: 12px;">
                                        <div style="
                                            display: flex;
                                            align-items: center;
                                            gap: 6px;
                                            margin-bottom: 8px;
                                        ">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                            </svg>
                                            <span style="
                                                font-size: 12px;
                                                font-weight: 600;
                                                color: #374151;
                                            ">Regional Distribution</span>
                                        </div>
                                        <table style="width: 100%; border-collapse: collapse;">
                                            <thead>
                                                <tr style="border-bottom: 1px solid #E5E7EB;">
                                                    <th style="padding: 6px 8px; text-align: left; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Region</th>
                                                    <th style="padding: 6px 8px; text-align: center; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Count</th>
                                                    <th style="padding: 6px 8px; text-align: right; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">${seriesName}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${regionalRows || '<tr><td colspan="3" style="padding: 8px; text-align: center; font-size: 11px; color: #9CA3AF;">No data</td></tr>'}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                    },
                },
            };

            // Get the chart element and verify it exists
                const chartElement = document.querySelector("#relationshipChart");
                if (!chartElement) {
                console.error(
                    "Relationship chart element #relationshipChart not found in DOM"
                );
                    return;
                }
                
            // Verify ApexCharts is loaded
            if (typeof ApexCharts === "undefined") {
                console.error("ApexCharts library not loaded");
                return;
            }
            
            try {
                // Destroy previous instance
                if (relationshipChartInstance) {
                    relationshipChartInstance.destroy();
                    relationshipChartInstance = null;
                }
                
                // Clear any previous content to avoid ApexCharts errors
                chartElement.innerHTML = "";
                
                // Create and render new chart
                relationshipChartInstance = new ApexCharts(chartElement, options);
                relationshipChartInstance.render();
                
                console.log(
                    " Relationship chart rendered successfully with",
                    relationships.length,
                    "relationships"
                );
            } catch (error) {
                console.error(" Error creating relationship chart:", error);
                console.error("Error details:", error.message, error.stack);
            }
        }

        // Helper function to check if any filters are active
        function areFiltersActive() {
            // Check if advanced filters are active
            if (Object.keys(activeFilters).length > 0) return true;
            
            // Check if smart filters are active
            if (selectedRegion !== 'all') return true;
            if (selectedPSE !== 'all') return true;
            if (selectedStatus !== 'all') return true;
            if (selectedCommitmentStatus !== 'all') return true;
            
            // Check if search is active
            const searchTerm = document.getElementById('searchInput')?.value?.trim();
            if (searchTerm && searchTerm.length > 0) return true;
            
            // Check if chart filter is active
            if (chartFilter.active) return true;
            
            return false;
        }

        // Update bar chart
        function updateBarChart() {
            // Debounce to prevent rapid successive calls when switching between Top N values
            if (updateBarChartTimer) {
                clearTimeout(updateBarChartTimer);
            }
            
            updateBarChartTimer = setTimeout(() => {
                console.log(" Updating bar charts (debounced)");
                if (areFiltersActive()) {
                createRelationshipChartFromFiltered();
                createROTCEChartFromFiltered();
            } else {
                createRelationshipChart();
                createROTCEChart();
            }
            }, 100); // 100ms debounce to prevent glitching
        }

        // Filter New Facilities by Period (Current Month or Previous Month)
        function filterNewFacilitiesByPeriod(period) {
            selectedPeriod = period;
            
            // Update button styles to match TailAdmin toggle design
            const currentBtn = document.getElementById("currentMonthBtn");
            const previousBtn = document.getElementById("previousMonthBtn");

            if (period === "current") {
                currentBtn.className =
                    "px-2 py-1 font-medium transition-colors rounded text-xs shadow-xs text-gray-900 bg-white hover:text-gray-900";
                previousBtn.className =
                    "px-2 py-1 font-medium transition-colors rounded text-sm font-medium text-gray-500 hover:text-gray-900";
            } else {
                currentBtn.className =
                    "px-2 py-1 font-medium transition-colors rounded text-sm font-medium text-gray-500 hover:text-gray-900";
                previousBtn.className =
                    "px-2 py-1 font-medium transition-colors rounded text-xs shadow-xs text-gray-900 bg-white hover:text-gray-900";
            }
            
            // Recreate chart with new period
            if (
                Object.keys(activeFilters).length > 0 ||
                (filteredData.length > 0 &&
                    filteredData.length < portfolioData.length)
            ) {
                createNewFacilitiesApprovedChartFromFiltered();
            } else {
                createNewFacilitiesApprovedChart();
            }
        }

        // Create New Facilities Approved Donut Chart from all data
        function createNewFacilitiesApprovedChart() {
            const startTime = performance.now();
            
            console.log(
                "Creating New Facilities Approved  chart, dataLength:",
                portfolioData.length
            );
            
            // Check if we have data
            if (!portfolioData || portfolioData.length === 0) {
                console.log(" No portfolio data available for New Facilities Approved chart");
                const chartElement = document.querySelector("#creditClassificationChart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('New Facilities Approved');
                }
                
                // Clear the legend when there's no data
                const legendElement = document.getElementById("creditClassificationLegend");
                if (legendElement) {
                    legendElement.innerHTML = "";
                }
                return;
            }
            
            // Find the most recent Report_Date to determine "last month"
            let mostRecentReportDate = null;
            for (let i = 0; i < portfolioData.length; i++) {
                const reportDate = parseDate(portfolioData[i].Report_Date);
                if (
                    reportDate &&
                    (!mostRecentReportDate || reportDate > mostRecentReportDate)
                ) {
                    mostRecentReportDate = reportDate;
                }
            }
            
            if (!mostRecentReportDate) {
                console.warn("No valid Report_Date found");
                const chartElement = document.querySelector("#creditClassificationChart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('New Facilities Approved');
                }
                
                // Clear the legend when there's no data
                const legendElement = document.getElementById("creditClassificationLegend");
                if (legendElement) {
                    legendElement.innerHTML = "";
                }
                return;
            }
            
            // Calculate date ranges based on selected period
            let targetStartDate, targetEndDate, periodLabel;
            if (selectedPeriod === "current") {
                // Current month: use the most recent report date's month
                targetStartDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth(),
                    1
                );
                targetStartDate.setHours(0, 0, 0, 0);
                targetEndDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth() + 1,
                    0
                );
                targetEndDate.setHours(23, 59, 59, 999);
                periodLabel = targetStartDate.toLocaleDateString("en-US", {
                    month: "long",
                    year: "numeric",
                });
            } else {
                // Previous month: one month before the most recent report date
                targetStartDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth() - 1,
                    1
                );
                targetStartDate.setHours(0, 0, 0, 0);
                targetEndDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth(),
                    0
                );
                targetEndDate.setHours(23, 59, 59, 999);
                periodLabel = targetStartDate.toLocaleDateString("en-US", {
                    month: "long",
                    year: "numeric",
                });
            }

            console.log("Most recent report date:", mostRecentReportDate);
            console.log("Target period:", periodLabel);
            console.log(
                "Target date range:",
                targetStartDate.toISOString(),
                "to",
                targetEndDate.toISOString()
            );
            console.log("Selected period:", selectedPeriod);
            
            // Track new facilities per product program with amounts and regional breakdown
            const productNewFacilities = new Map();
            const productTotalFacilities = new Map();
            const productAmounts = new Map();
            let totalNewCount = 0;
            let totalNewTFA = 0;
            
            for (let i = 0; i < portfolioData.length; i++) {
                const row = portfolioData[i];
                const productProgram = row.Product_Program || "Unknown";
                const facilityId = row.Facility_ID;
                const region = (row.Region || "").toUpperCase();
                
                // NAM, LATAM, EMEA use Facility_First_Approval_Date
                // APAC has different logic (not included in new facilities count)
                let approvalDate = null;
                if (region === "NAM" || region === "LATAM" || region === "EMEA") {
                    approvalDate = parseDate(row.Facility_First_Approval_Date);
                }
                // APAC is excluded (empty/different logic)
                
                if (!facilityId) continue;
                
                // Initialize product program tracking
                if (!productNewFacilities.has(productProgram)) {
                    productNewFacilities.set(productProgram, new Set());
                    productTotalFacilities.set(productProgram, new Set());
                    productAmounts.set(productProgram, {
                        tfa: 0,
                        direct: 0,
                        contingent: 0,
                        pse: 0,
                        regionalBreakdown: { 
                            NAM: { count: 0, tfa: 0 }, 
                            LATAM: { count: 0, tfa: 0 }, 
                            EMEA: { count: 0, tfa: 0 }, 
                            APAC: { count: 0, tfa: 0 } 
                        }
                    });
                }
                
                productTotalFacilities.get(productProgram).add(facilityId);
                
                // Check if facility is "new" (approved within the selected period)
                if (
                    approvalDate &&
                    approvalDate >= targetStartDate &&
                    approvalDate <= targetEndDate
                ) {
                    productNewFacilities.get(productProgram).add(facilityId);
                    totalNewCount++;
                    const tfaAmount = parseNumber(row.Facility_Amount);
                    totalNewTFA += tfaAmount;
                    
                    // Accumulate amounts for new facilities
                    const amounts = productAmounts.get(productProgram);
                    amounts.tfa += tfaAmount;
                    amounts.direct += parseNumber(row.Direct_OS);
                    amounts.contingent += parseNumber(row.Contingent_OS);
                    amounts.pse += parseNumber(row.PSE_OS);
                    
                    // Regional breakdown
                    if (amounts.regionalBreakdown[region]) {
                        amounts.regionalBreakdown[region].count++;
                        amounts.regionalBreakdown[region].tfa += tfaAmount;
                    }
                }
            }
            
            console.log("Product program new facilities:", productNewFacilities);
            console.log(`Found ${totalNewCount} new facilities in ${periodLabel}`);
            
            // Convert to arrays for ApexCharts (only showing new facilities)
            const labels = [];
            const series = [];
            const counts = [];
            
            for (const [
                productProgram,
                newFacilitiesSet,
            ] of productNewFacilities.entries()) {
                const newCount = newFacilitiesSet.size;
                if (newCount > 0) {
                    // Only include product programs with new facilities
                    labels.push(productProgram);
                    series.push(newCount);
                    counts.push(newCount);
                }
            }
            
            // Handle empty data
            if (labels.length === 0) {
                console.warn("No new facilities data available");

                // Destroy existing chart instance first
                if (newFacilitiesApprovedChartInstance) {
                    newFacilitiesApprovedChartInstance.destroy();
                    newFacilitiesApprovedChartInstance = null;
                }

                const chartElement = document.querySelector(
                    "#creditClassificationChart"
                );
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage(`New Facilities (${periodLabel})`);
                }
                
                // Clear the legend when there's no data
                const legendElement = document.getElementById("creditClassificationLegend");
                if (legendElement) {
                    legendElement.innerHTML = "";
                }
                
                // Update chart subtitle even when no data
                const subtitleElement = document.getElementById(
                    "newFacilitiesSubtitle"
                );
                if (subtitleElement) {
                    subtitleElement.textContent = `Facilities approved in ${periodLabel}`;
                }
                return;
            }
            
            // Calculate total new facilities
            const totalNewFacilities = counts.reduce((a, b) => a + b, 0);
            
            // Define colors matching the TailAdmin style
            const colors = [
                "#3641f5",
                "#7592ff",
                "#dde9ff",
                "#ff6b6b",
                "#ffd93d",
                "#6bcf7f",
                "#c084fc",
            ];
            
            const options = {
                series: series,
                colors: colors.slice(0, labels.length),
                labels: labels,
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "donut",
                    width: 280,
                    height: 280,
                    events: {
                        // Chart click filtering disabled
                    },
                },
                stroke: {
                    show: false,
                    width: 4,
                    colors: "transparent",
                },
                plotOptions: {
                    pie: {
                        donut: {
                            size: "65%",
                            background: "transparent",
                            labels: {
                                show: true,
                                name: {
                                    show: true,
                                    offsetY: 0,
                                    color: "#1D2939",
                                    fontSize: "12px",
                                    fontWeight: "normal",
                                },
                                value: {
                                    show: true,
                                    offsetY: 10,
                                    color: "#667085",
                                    fontSize: "14px",
                                    formatter: (val) => val.toLocaleString(),
                                },
                                total: {
                                    show: true,
                                    label: "Total New",
                                    color: "#000000",
                                    fontSize: "20px",
                                    fontWeight: "bold",
                                    formatter: () => totalNewFacilities.toLocaleString(),
                                },
                            },
                        },
                    },
                },
                dataLabels: {
                    enabled: false,
                },
                tooltip: {
                    enabled: true,
                    theme: "light",
                    followCursor: false,
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        const productProgram = labels[seriesIndex];
                        const count = series[seriesIndex];
                        const amounts = productAmounts.get(productProgram);
                        
                        if (!amounts) return "";
                        
                        const percentage = totalNewFacilities > 0 ? ((count / totalNewFacilities) * 100).toFixed(1) : 0;
                        const tfaPercentage = totalNewTFA > 0 ? ((amounts.tfa / totalNewTFA) * 100).toFixed(1) : 0;
                        const regionalBreakdown = amounts.regionalBreakdown || { NAM: { count: 0, tfa: 0 }, LATAM: { count: 0, tfa: 0 }, EMEA: { count: 0, tfa: 0 }, APAC: { count: 0, tfa: 0 } };
                        
                        // Build regional table rows
                        let regionalRows = '';
                        ['NAM', 'LATAM', 'EMEA', 'APAC'].forEach(region => {
                            const regionData = regionalBreakdown[region];
                            if (regionData && regionData.count > 0) {
                                regionalRows += `
                                    <tr>
                                        <td style="padding: 6px 8px; text-align: left; font-size: 11px; color: #6B7280; font-weight: 500;">${region}</td>
                                        <td style="padding: 6px 8px; text-align: center; font-size: 11px; color: #111827; font-weight: 600;">${regionData.count}</td>
                                        <td style="padding: 6px 8px; text-align: right; font-size: 11px; color: #111827; font-weight: 600;">${formatCurrency(regionData.tfa)}</td>
                                    </tr>
                                `;
                            }
                        });
                        
                        return `
                            <div style="
                                background: #ffffff; 
                                border-radius: 12px; 
                                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
                                min-width: 360px;
                                max-width: 400px;
                                overflow: hidden;
                                font-family: Outfit, sans-serif;
                            ">
                                <!-- Header with border -->
                                <div style="
                                    border-bottom: 1px solid #E5E7EB;
                                    padding: 16px 16px 12px 16px;
                                    margin-bottom: 14px;
                                ">
                                    <div style="
                                        font-weight: 600; 
                                        font-size: 15px; 
                                        color: #111827;
                                        margin-bottom: 4px;
                                    ">${productProgram}</div>
                                    <div style="
                                        font-size: 12px; 
                                        font-weight: 500;
                                        color: #6B7280;
                                    ">Product Program</div>
                                </div>
                                
                                <!-- Content wrapper -->
                                <div style="padding: 0 16px 16px 16px;">
                                    <!-- Widget Grid (3 columns for main metrics) -->
                                    <div style="
                                        display: grid;
                                        grid-template-columns: 1fr 1fr 1fr;
                                        gap: 8px;
                                        margin-bottom: 16px;
                                    ">
                                        <!-- Widget 1: Facility Count -->
                                        <div style="
                                            background: #F9FAFB;
                                            border-radius: 8px;
                                            padding: 10px;
                                            border: 1px solid #E5E7EB;
                                        ">
                                            <div style="
                                                display: flex;
                                                align-items: center;
                                                gap: 4px;
                                                font-size: 10px;
                                                color: #6B7280;
                                                font-weight: 500;
                                                margin-bottom: 4px;
                                            ">
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                                </svg>
                                                Count
                                            </div>
                                            <div style="
                                                font-size: 18px;
                                                font-weight: 700;
                                                color: #111827;
                                            ">${count}</div>
                                        </div>
                                        
                                        <!-- Widget 2: TFA -->
                                        <div style="
                                            background: #F9FAFB;
                                            border-radius: 8px;
                                            padding: 10px;
                                            border: 1px solid #E5E7EB;
                                        ">
                                            <div style="
                                                display: flex;
                                                align-items: center;
                                                gap: 4px;
                                                font-size: 10px;
                                                color: #6B7280;
                                                font-weight: 500;
                                                margin-bottom: 4px;
                                            ">
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <line x1="12" y1="1" x2="12" y2="23"></line>
                                                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                                </svg>
                                                TFA
                                            </div>
                                            <div style="
                                                font-size: 14px;
                                                font-weight: 700;
                                                color: #111827;
                                            ">${formatCurrency(amounts.tfa)}</div>
                                        </div>
                                        
                                        <!-- Widget 3: % of Total -->
                                        <div style="
                                            background: #F9FAFB;
                                            border-radius: 8px;
                                            padding: 10px;
                                            border: 1px solid #E5E7EB;
                                        ">
                                            <div style="
                                                display: flex;
                                                align-items: center;
                                                gap: 4px;
                                                font-size: 10px;
                                                color: #6B7280;
                                                font-weight: 500;
                                                margin-bottom: 4px;
                                            ">
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <circle cx="12" cy="12" r="10"></circle>
                                                    <polyline points="12 6 12 12 16 14"></polyline>
                                                </svg>
                                                % Total
                                            </div>
                                            <div style="
                                                font-size: 18px;
                                                font-weight: 700;
                                                color: #111827;
                                            ">${percentage}%</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Exposure Breakdown Row -->
                                    <div style="
                                        display: flex;
                                        gap: 8px;
                                        margin-bottom: 16px;
                                        padding: 10px 12px;
                                        background: #F9FAFB;
                                        border-radius: 6px;
                                        border: 1px solid #E5E7EB;
                                    ">
                                        <div style="flex: 1;">
                                            <div style="font-size: 10px; color: #6B7280; font-weight: 500; margin-bottom: 2px;">Direct OS</div>
                                            <div style="font-size: 13px; font-weight: 600; color: #111827;">${formatCurrency(amounts.direct)}</div>
                                        </div>
                                        ${amounts.contingent > 0 ? `
                                        <div style="width: 1px; background: #E5E7EB;"></div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 10px; color: #6B7280; font-weight: 500; margin-bottom: 2px;">Contingent</div>
                                            <div style="font-size: 13px; font-weight: 600; color: #111827;">${formatCurrency(amounts.contingent)}</div>
                                        </div>
                                        ` : ''}
                                        ${amounts.pse > 0 ? `
                                        <div style="width: 1px; background: #E5E7EB;"></div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 10px; color: #6B7280; font-weight: 500; margin-bottom: 2px;">PSE</div>
                                            <div style="font-size: 13px; font-weight: 600; color: #111827;">${formatCurrency(amounts.pse)}</div>
                                        </div>
                                        ` : ''}
                                    </div>
                                    
                                    <!-- Regional Distribution Table -->
                                    <div style="margin-top: 12px;">
                                        <div style="
                                            display: flex;
                                            align-items: center;
                                            gap: 6px;
                                            margin-bottom: 8px;
                                        ">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                            </svg>
                                            <span style="
                                                font-size: 12px;
                                                font-weight: 600;
                                                color: #374151;
                                            ">Regional Distribution</span>
                                        </div>
                                        <table style="width: 100%; border-collapse: collapse;">
                                            <thead>
                                                <tr style="border-bottom: 1px solid #E5E7EB;">
                                                    <th style="padding: 6px 8px; text-align: left; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Region</th>
                                                    <th style="padding: 6px 8px; text-align: center; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Count</th>
                                                    <th style="padding: 6px 8px; text-align: right; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">TFA</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${regionalRows || '<tr><td colspan="3" style="padding: 8px; text-align: center; font-size: 11px; color: #9CA3AF;">No data</td></tr>'}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                    },
                },
                legend: {
                    show: false,
                },
                responsive: [
                    {
                        breakpoint: 2600,
                        options: {
                            chart: {
                                width: 240,
                                height: 240,
                            },
                        },
                    },
                    {
                        breakpoint: 640,
                        options: {
                            chart: {
                                width: 280,
                                height: 280,
                            },
                        },
                    },
                ],
            };
            
            // Get the chart element and verify it exists
            const chartElement = document.querySelector(
                "#creditClassificationChart"
            );
            if (!chartElement) {
                console.error("Credit classification chart element not found in DOM");
                return;
            }
            
            // Verify ApexCharts is loaded
            if (typeof ApexCharts === "undefined") {
                console.error("ApexCharts library not loaded");
                chartElement.innerHTML = generateNoDataMessage('New Facilities Approved');
                
                // Clear the legend when there's no data
                const legendElement = document.getElementById("creditClassificationLegend");
                if (legendElement) {
                    legendElement.innerHTML = "";
                }
                return;
            }
            
            try {
                // Destroy previous instance
                if (newFacilitiesApprovedChartInstance) {
                    newFacilitiesApprovedChartInstance.destroy();
                    newFacilitiesApprovedChartInstance = null;
                }
                
                // Clear any previous content
                chartElement.innerHTML = "";
                
                // Create and render new chart
                newFacilitiesApprovedChartInstance = new ApexCharts(
                    chartElement,
                    options
                );
                newFacilitiesApprovedChartInstance.render();
                
                // Add tooltip positioning fix
                setTimeout(() => {
                    const tooltipObserver = new MutationObserver(() => {
                        const tooltip = chartElement.querySelector('.apexcharts-tooltip.apexcharts-active');
                        if (tooltip && !tooltip.hasAttribute('data-positioned')) {
                            const tooltipRect = tooltip.getBoundingClientRect();
                            const windowWidth = window.innerWidth;
                            const windowHeight = window.innerHeight;
                            const margin = 10;
                            
                            let needsReposition = false;
                            
                            if (tooltipRect.left < margin) {
                                tooltip.style.left = margin + 'px';
                                tooltip.style.transform = 'none';
                                needsReposition = true;
                            } else if (tooltipRect.right > windowWidth - margin) {
                                tooltip.style.left = (windowWidth - tooltipRect.width - margin) + 'px';
                                tooltip.style.transform = 'none';
                                needsReposition = true;
                            }
                            
                            if (tooltipRect.top < margin) {
                                tooltip.style.top = margin + 'px';
                                needsReposition = true;
                            } else if (tooltipRect.bottom > windowHeight - margin) {
                                tooltip.style.top = (windowHeight - tooltipRect.height - margin) + 'px';
                                needsReposition = true;
                            }
                            
                            if (needsReposition) {
                                tooltip.setAttribute('data-positioned', 'true');
                            }
                        }
                        
                        const hiddenTooltip = chartElement.querySelector('.apexcharts-tooltip:not(.apexcharts-active)[data-positioned]');
                        if (hiddenTooltip) {
                            hiddenTooltip.removeAttribute('data-positioned');
                        }
                    });
                    
                    tooltipObserver.observe(chartElement, {
                        attributes: true,
                        attributeFilter: ['class'],
                        subtree: true
                    });
                }, 200);
                
                // Update legend
                updateNewFacilitiesApprovedLegend(
                    labels,
                    series,
                    counts,
                    totalNewFacilities,
                    colors
                );

                // Update chart subtitle with period
                const subtitleElement = document.getElementById(
                    "newFacilitiesSubtitle"
                );
                if (subtitleElement) {
                    subtitleElement.textContent = `Facilities approved in ${periodLabel}`;
                }
                
                console.log(
                    " New facilities by region chart rendered successfully"
                );
            } catch (error) {
                console.error(
                    " Error creating credit classification chart:",
                    error
                );
                chartElement.innerHTML = generateNoDataMessage('New Facilities Approved');
                
                // Clear the legend when there's an error
                const legendElement = document.getElementById("creditClassificationLegend");
                if (legendElement) {
                    legendElement.innerHTML = "";
                }
            }
        }

        // Create New Facilities Approved Donut Chart from filtered data
        function createNewFacilitiesApprovedChartFromFiltered() {
            const startTime = performance.now();
            
            console.log(
                "Creating filtered New Facilities Approved  chart, dataLength:",
                filteredData.length
            );
            
            // Check if we have filtered data
            if (!filteredData || filteredData.length === 0) {
                console.log(" No filtered data available for New Facilities Approved chart");
                const chartElement = document.querySelector("#creditClassificationChart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('New Facilities Approved');
                }
                
                // Clear the legend when there's no data
                const legendElement = document.getElementById("creditClassificationLegend");
                if (legendElement) {
                    legendElement.innerHTML = "";
                }
                return;
            }
            
            // Find the most recent Report_Date to determine "last month"
            let mostRecentReportDate = null;
            for (let i = 0; i < filteredData.length; i++) {
                const reportDate = parseDate(filteredData[i].Report_Date);
                if (
                    reportDate &&
                    (!mostRecentReportDate || reportDate > mostRecentReportDate)
                ) {
                    mostRecentReportDate = reportDate;
                }
            }
            
            if (!mostRecentReportDate) {
                console.warn("No valid Report_Date found in filtered data");
                const chartElement = document.querySelector(
                    "#creditClassificationChart"
                );
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('New Facilities Approved');
                }
                
                // Clear the legend when there's no data
                const legendElement = document.getElementById("creditClassificationLegend");
                if (legendElement) {
                    legendElement.innerHTML = "";
                }
                return;
            }
            
            // Calculate date ranges based on selected period
            let targetStartDate, targetEndDate, periodLabel;
            if (selectedPeriod === "current") {
                // Current month: use the most recent report date's month
                targetStartDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth(),
                    1
                );
                targetStartDate.setHours(0, 0, 0, 0);
                targetEndDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth() + 1,
                    0
                );
                targetEndDate.setHours(23, 59, 59, 999);
                periodLabel = targetStartDate.toLocaleDateString("en-US", {
                    month: "long",
                    year: "numeric",
                });
            } else {
                // Previous month: one month before the most recent report date
                targetStartDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth() - 1,
                    1
                );
                targetStartDate.setHours(0, 0, 0, 0);
                targetEndDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth(),
                    0
                );
                targetEndDate.setHours(23, 59, 59, 999);
                periodLabel = targetStartDate.toLocaleDateString("en-US", {
                    month: "long",
                    year: "numeric",
                });
            }

            console.log(
                "Most recent report date (filtered):",
                mostRecentReportDate
            );
            console.log("Target period (filtered):", periodLabel);
            console.log(
                "Target date range (filtered):",
                targetStartDate.toISOString(),
                "to",
                targetEndDate.toISOString()
            );
            console.log("Selected period:", selectedPeriod);
            
            // Track new facilities per product program with amounts
            const productNewFacilities = new Map();
            const productTotalFacilities = new Map();
            const productAmounts = new Map();
            let totalNewCount = 0;
            
            for (let i = 0; i < filteredData.length; i++) {
                const row = filteredData[i];
                const productProgram = row.Product_Program || "Unknown";
                const facilityId = row.Facility_ID;
                const region = (row.Region || "").toUpperCase();
                
                // NAM, LATAM, EMEA use Facility_First_Approval_Date
                // APAC has different logic (not included in new facilities count)
                let approvalDate = null;
                if (region === "NAM" || region === "LATAM" || region === "EMEA") {
                    approvalDate = parseDate(row.Facility_First_Approval_Date);
                }
                // APAC is excluded (empty/different logic)
                
                if (!facilityId) continue;
                
                // Initialize product program tracking
                if (!productNewFacilities.has(productProgram)) {
                    productNewFacilities.set(productProgram, new Set());
                    productTotalFacilities.set(productProgram, new Set());
                    productAmounts.set(productProgram, {
                        tfa: 0,
                        direct: 0,
                        contingent: 0,
                        pse: 0,
                    });
                }
                
                productTotalFacilities.get(productProgram).add(facilityId);
                
                // Check if facility is "new" (approved within the selected period)
                if (
                    approvalDate &&
                    approvalDate >= targetStartDate &&
                    approvalDate <= targetEndDate
                ) {
                    productNewFacilities.get(productProgram).add(facilityId);
                    totalNewCount++;
                    // Accumulate amounts for new facilities
                    const amounts = productAmounts.get(productProgram);
                    amounts.tfa += parseNumber(row.Facility_Amount);
                    amounts.direct += parseNumber(row.Direct_OS);
                    amounts.contingent += parseNumber(row.Contingent_OS);
                    amounts.pse += parseNumber(row.PSE_OS);
                }
            }

            console.log(
                "Product program new facilities (filtered):",
                productNewFacilities
            );
            console.log(
                `Found ${totalNewCount} new facilities in ${periodLabel} (from filtered data)`
            );
            
            // Convert to arrays for ApexCharts (only showing new facilities)
            const labels = [];
            const series = [];
            const counts = [];
            
            for (const [
                productProgram,
                newFacilitiesSet,
            ] of productNewFacilities.entries()) {
                const newCount = newFacilitiesSet.size;
                if (newCount > 0) {
                    // Only include product programs with new facilities
                    labels.push(productProgram);
                    series.push(newCount);
                    counts.push(newCount);
                }
            }
            
            // Handle empty data
            if (labels.length === 0) {
                console.warn("No new facilities data available in filtered dataset");

                // Destroy existing chart instance first
                if (newFacilitiesApprovedChartInstance) {
                    newFacilitiesApprovedChartInstance.destroy();
                    newFacilitiesApprovedChartInstance = null;
                }

                const chartElement = document.querySelector(
                    "#creditClassificationChart"
                );
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage(`New Facilities (${periodLabel})`);
                }
                
                // Clear the legend when there's no data
                const legendElement = document.getElementById("creditClassificationLegend");
                if (legendElement) {
                    legendElement.innerHTML = "";
                }
                
                // Update chart subtitle even when no data
                const subtitleElement = document.getElementById(
                    "newFacilitiesSubtitle"
                );
                if (subtitleElement) {
                    subtitleElement.textContent = `Facilities approved in ${periodLabel}`;
                }
                return;
            }
            
            // Calculate total new facilities
            const totalNewFacilities = counts.reduce((a, b) => a + b, 0);
            
            // Define colors
            const colors = [
                "#3641f5",
                "#7592ff",
                "#dde9ff",
                "#ff6b6b",
                "#ffd93d",
                "#6bcf7f",
                "#c084fc",
            ];
            
            const options = {
                series: series,
                colors: colors.slice(0, labels.length),
                labels: labels,
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "donut",
                    width: 280,
                    height: 280,
                    events: {
                        // Chart click filtering disabled
                    },
                },
                stroke: {
                    show: false,
                    width: 4,
                    colors: "transparent",
                },
                plotOptions: {
                    pie: {
                        donut: {
                            size: "65%",
                            background: "transparent",
                            labels: {
                                show: true,
                                name: {
                                    show: true,
                                    offsetY: 0,
                                    color: "#1D2939",
                                    fontSize: "12px",
                                    fontWeight: "normal",
                                },
                                value: {
                                    show: true,
                                    offsetY: 10,
                                    color: "#667085",
                                    fontSize: "14px",
                                    formatter: (val) => val.toLocaleString(),
                                },
                                total: {
                                    show: true,
                                    label: "Total New",
                                    color: "#000000",
                                    fontSize: "20px",
                                    fontWeight: "bold",
                                    formatter: () => totalNewFacilities.toLocaleString(),
                                },
                            },
                        },
                    },
                },
                dataLabels: {
                    enabled: false,
                },
                tooltip: {
                    enabled: true,
                    theme: "light",
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        const productProgram = labels[seriesIndex];
                        const count = series[seriesIndex];
                        const amounts = productAmounts.get(productProgram);
                        
                        if (!amounts) return "";
                        
                        let html = `<div class="apexcharts-tooltip-custom" style="padding: 12px; min-width: 200px; background: #ffffff; color: #1f2937; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border: 1px solid #e5e7eb;">`;
                        html += `<div style="font-weight: 600; margin-bottom: 8px; font-size: 13px; color: #1f2937;">${productProgram}</div>`;
                        html += `<div style="font-size: 11px; color: #666;">`;
                        html += `<div style="margin-bottom: 4px;"><strong>${count}</strong> New Facilities</div>`;
                        html += `<div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #e5e7eb;">`;
                        html += `<div>TFA: ${formatCurrency(amounts.tfa)}</div>`;
                        html += `<div>Direct: ${formatCurrency(amounts.direct)}</div>`;
                        if (amounts.contingent > 0) {
                            html += `<div>Contingent: ${formatCurrency(
                                amounts.contingent
                            )}</div>`;
                        }
                        if (amounts.pse > 0) {
                            html += `<div>Presettlement Exposure: ${formatCurrency(
                                amounts.pse
                            )}</div>`;
                        }
                        html += `</div></div></div>`;
                        return html;
                    },
                },
                legend: {
                    show: false,
                },
                responsive: [
                    {
                        breakpoint: 2600,
                        options: {
                            chart: {
                                width: 240,
                                height: 240,
                            },
                        },
                    },
                    {
                        breakpoint: 640,
                        options: {
                            chart: {
                                width: 280,
                                height: 280,
                            },
                        },
                    },
                ],
            };
            
            const chartElement = document.querySelector(
                "#creditClassificationChart"
            );
            if (!chartElement) {
                console.error("Credit classification chart element not found in DOM");
                return;
            }
            
            if (typeof ApexCharts === "undefined") {
                console.error("ApexCharts library not loaded");
                chartElement.innerHTML = generateNoDataMessage('New Facilities Approved');
                
                // Clear the legend when there's no data
                const legendElement = document.getElementById("creditClassificationLegend");
                if (legendElement) {
                    legendElement.innerHTML = "";
                }
                return;
            }
            
            try {
                if (newFacilitiesApprovedChartInstance) {
                    newFacilitiesApprovedChartInstance.destroy();
                    newFacilitiesApprovedChartInstance = null;
                }
                
                chartElement.innerHTML = "";
                
                newFacilitiesApprovedChartInstance = new ApexCharts(
                    chartElement,
                    options
                );
                newFacilitiesApprovedChartInstance.render();
                
                // Update legend
                updateNewFacilitiesApprovedLegend(
                    labels,
                    series,
                    counts,
                    totalNewFacilities,
                    colors
                );

                // Update chart subtitle with period
                const subtitleElement = document.getElementById(
                    "newFacilitiesSubtitle"
                );
                if (subtitleElement) {
                    subtitleElement.textContent = `Facilities first approved in ${periodLabel}`;
                }
                
                console.log(
                    " New facilities by region chart (filtered) rendered successfully"
                );
            } catch (error) {
                console.error(
                    " Error creating credit classification chart (filtered):",
                    error
                );
                chartElement.innerHTML = generateNoDataMessage('New Facilities Approved');
                
                // Clear the legend when there's an error
                const legendElement = document.getElementById("creditClassificationLegend");
                if (legendElement) {
                    legendElement.innerHTML = "";
                }
            }
        }

        // Update the legend for New Facilities Approved chart
        function updateNewFacilitiesApprovedLegend(
            labels,
            series,
            counts,
            totalAmount,
            colors
        ) {
            const legendElement = document.getElementById(
                "creditClassificationLegend"
            );
            if (!legendElement) return;
            
            let legendHTML = "";
            for (let i = 0; i < labels.length; i++) {
                const percentage = ((series[i] / totalAmount) * 100).toFixed(0);
                const color = colors[i] || "#3641f5";
                
                legendHTML += `
                    <div class="flex items-start gap-2.5">
                        <div class="mt-1.5 h-2 w-2 rounded-full" style="background-color: ${color};"></div>
                        <div>
                            <h5 class="mb-1 font-medium text-gray-800 text-theme-sm">
                                ${labels[i]}
                            </h5>
                            <div class="flex items-center gap-2">
                                <p class="font-medium text-gray-700 text-theme-sm">
                                    ${percentage}%
                                </p>
                                <div class="w-1 h-1 bg-gray-400 rounded-full"></div>
                                <p class="text-gray-500 text-theme-sm">
                                    ${counts[i]}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            legendElement.innerHTML = legendHTML;
        }

        // ============================================
        // ROTCE CHART FUNCTIONS
        // ============================================

        // Create ROTCE chart (initial load)
        function createROTCEChart() {
            console.log(" Creating ROTCE Performance chart");
            
            const chartElement = document.querySelector("#rotceChart");
            
            // Check if we have portfolio data
            if (!portfolioData || portfolioData.length === 0) {
                console.log(" No portfolio data available for ROTCE chart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('ROTCE Performance');
                }
                return;
            }
            
            // Get Top N from Top Relationships filter
            const topNRelationships = parseInt(
                document.getElementById("topNFilter").value
            );
            
            // Group ROTCE by relationship with additional metrics
            const rotceByRelationship = new Map();
            const rotceValues = [];
            
            portfolioData.forEach((row) => {
                const relName = row.Relationship_Name || row.Relationship_ID;
                const rotce = parsePercentage(row.ROTCE);
                const region = (row.Region || "Unknown").toUpperCase();
                
                if (relName && !isNaN(rotce)) {
                    if (!rotceByRelationship.has(relName)) {
                        rotceByRelationship.set(relName, {
                            rotceValues: [],
                            region: region,
                            facilities: new Set(),
                            tfa: 0,
                            direct: 0,
                            regionalBreakdown: { 
                                NAM: { count: 0, tfa: 0, direct: 0 }, 
                                LATAM: { count: 0, tfa: 0, direct: 0 }, 
                                EMEA: { count: 0, tfa: 0, direct: 0 }, 
                                APAC: { count: 0, tfa: 0, direct: 0 } 
                            }
                        });
                    }
                    const data = rotceByRelationship.get(relName);
                    data.rotceValues.push(rotce);
                    rotceValues.push(rotce);
                    
                    if (row.Facility_ID) {
                        data.facilities.add(row.Facility_ID);
                    }
                    
                    const tfaAmount = parseNumber(row.Fac_Amount || row.Facility_Amount);
                    const directAmount = parseNumber(row.Direct_OS);
                    data.tfa += tfaAmount;
                    data.direct += directAmount;
                    
                    // Regional breakdown
                    if (data.regionalBreakdown[region]) {
                        data.regionalBreakdown[region].count++;
                        data.regionalBreakdown[region].tfa += tfaAmount;
                        data.regionalBreakdown[region].direct += directAmount;
                    }
                }
            });
            
            // Calculate average ROTCE per relationship
            const relationshipROTCE = [];
            rotceByRelationship.forEach((data, relName) => {
                const average = data.rotceValues.reduce((sum, val) => sum + val, 0) / data.rotceValues.length;
                const minROTCE = Math.min(...data.rotceValues);
                const maxROTCE = Math.max(...data.rotceValues);
                relationshipROTCE.push({ 
                    name: relName, 
                    rotce: average,
                    minROTCE: minROTCE,
                    maxROTCE: maxROTCE,
                    facilities: data.facilities.size,
                    tfa: data.tfa,
                    direct: data.direct,
                    region: data.region,
                    regionalBreakdown: data.regionalBreakdown
                });
            });
            
            // Sort by selected amount type from Top Relationships chart to get same top N
            // Get Top Relationships to match their order
            const relationshipData = new Map();
            for (const row of portfolioData) {
                const relId = row.Relationship_Name || row.Relationship_ID;
                if (!relId) continue;
                
                if (!relationshipData.has(relId)) {
                    relationshipData.set(relId, {
                        tfa: 0,
                        direct: 0,
                        contingent: 0,
                        pse: 0,
                        osuc: 0,
                        unused: 0,
                    });
                }
                const data = relationshipData.get(relId);
                data.tfa += parseNumber(row.Fac_Amount || row.Facility_Amount);
                data.direct += parseNumber(row.Direct_OS);
                data.contingent += parseNumber(row.Contingent_OS);
                data.pse += parseNumber(row.PSE_OS);
                data.osuc += parseNumber(row.OSUC);
                data.unused += parseNumber(row.Unused_Committed);
            }

            // Get the selected field value for sorting (sync with Top Relationships chart)
            const relationshipTotals = new Map();
            for (const [relId, data] of relationshipData.entries()) {
                let sortValue = 0;
                switch (selectedAmountType) {
                    case "tfa":
                        sortValue = data.tfa;
                        break;
                    case "direct":
                        sortValue = data.direct;
                        break;
                    case "contingent":
                        sortValue = data.contingent;
                        break;
                    case "pse":
                        sortValue = data.pse;
                        break;
                    case "osuc":
                        sortValue = data.osuc;
                        break;
                    case "unused":
                        sortValue = data.unused;
                        break;
                    default:
                        sortValue = data.direct;
                }
                relationshipTotals.set(relId, sortValue);
            }

            // Get top N relationships by selected exposure type (matching Top Relationships chart)
            const topRelationships = Array.from(relationshipTotals.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, topNRelationships)
                .map((entry) => entry[0]);
            
            // Check if we have any relationships with non-zero values
            const hasValidRelationships = Array.from(relationshipTotals.entries())
                .some(([relId, value]) => value > 0);

            console.log("DEBUG ROTCE (non-filtered) - relationshipTotals size:", relationshipTotals.size);
            console.log("DEBUG ROTCE (non-filtered) - hasValidRelationships:", hasValidRelationships);
            console.log("DEBUG ROTCE (non-filtered) - topRelationships length:", topRelationships.length);

            // Update subtitle
            const subtitleEl = document.getElementById("rotceSubtitle");
            if (subtitleEl) {
                subtitleEl.textContent = `Top ${topNRelationships} relationships ROTCE performance`;
            }

            // If no valid relationships in Top Relationships chart, don't show ROTCE
            if (!hasValidRelationships || topRelationships.length === 0 || relationshipTotals.size === 0) {
                console.log(" No relationships data available - skipping ROTCE chart (non-filtered)");
                const chartElement = document.querySelector("#rotceChart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('ROTCE Performance');
                }
                return;
            }
            
            // Filter and order ROTCE data to match top relationships
            const filteredROTCE = topRelationships
                .map((relName) => relationshipROTCE.find((r) => r.name === relName))
                .filter((r) => r !== undefined);

            // Add index numbers (1, 2, 3, ...) to match Top Relationships chart
            const relationships = filteredROTCE.map(
                (r, index) => `${index + 1}. ${r.name}`
            );
            const avgROTCE = filteredROTCE.map((r) => r.rotce);
            
            // Debug logging for ROTCE
            console.log("DEBUG ROTCE (non-filtered) - selectedAmountType:", selectedAmountType);
            console.log("DEBUG ROTCE (non-filtered) - topRelationships:", topRelationships);
            console.log("DEBUG ROTCE (non-filtered) - relationships:", relationships);
            console.log("DEBUG ROTCE (non-filtered) - avgROTCE:", avgROTCE);
            console.log("DEBUG ROTCE (non-filtered) - filteredROTCE:", filteredROTCE);

            // Check if all ROTCE values are zero or NaN
            const validROTCE = avgROTCE.filter(v => !isNaN(v) && v !== 0);
            if (validROTCE.length === 0) {
                console.warn(" No valid ROTCE data for the selected relationships");
                const chartElement = document.querySelector("#rotceChart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('ROTCE Performance');
                }
                return;
            }
            
            // Conditional colors: red if < 12%, green if >= 12%
            const barColors = avgROTCE.map((rotce) =>
                rotce < 12 ? "#ef4444" : "#10b981"
            );
            
            // Calculate dynamic height
            const calculatedHeight = Math.max(350, relationships.length * 35);
            
            // Create horizontal bar chart
            const chartOptions = {
                series: [
                    {
                        name: "Average ROTCE",
                        data: avgROTCE,
                    },
                ],
                chart: {
                    type: "bar",
                    height: calculatedHeight,
                    toolbar: { show: false },
                    fontFamily: "Outfit, sans-serif",
                },
                colors: barColors,
                plotOptions: {
                    bar: {
                        horizontal: true,
                        columnWidth: "70%",
                        borderRadius: 4,
                        distributed: true, // Enable individual bar colors
                        dataLabels: {
                            position: "center",
                        },
                    },
                },
                dataLabels: {
                    enabled: true,
                    formatter: function (val) {
                        return val.toFixed(1) + "%";
                    },
                    style: {
                        fontSize: "12px",
                        fontFamily: "Outfit, sans-serif",
                        colors: ["#fff"],
                        fontWeight: "bold",
                    },
                },
                annotations: {
                    xaxis: [
                        {
                        x: 12,
                            borderColor: "#f59e0b",
                        strokeDashArray: 8,
                        label: {
                                borderColor: "#f59e0b",
                            style: {
                                    color: "#fff",
                                    background: "#f59e0b",
                                    fontSize: "12px",
                                    fontFamily: "Outfit, sans-serif",
                                    fontWeight: "bold",
                                },
                                text: "Target: 12%",
                            },
                        },
                    ],
                },
                xaxis: {
                    categories: relationships,
                    title: {
                        style: {
                            color: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                    labels: {
                        formatter: function (val) {
                            return val.toFixed(0) + "%";
                        },
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                },
                yaxis: {
                    labels: {
                        align: 'left',
                        offsetX: -10,
                        style: {
                            colors: relationships.map(() => "#6B7280"),
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                        maxWidth: 200,
                    },
                },
                grid: {
                    borderColor: "#E5E7EB",
                    strokeDashArray: 4,
                    xaxis: { lines: { show: true } },
                    yaxis: { lines: { show: false } },
                },
                legend: {
                    show: false,
                },
                tooltip: {
                    enabled: true,
                    theme: "light",
                    followCursor: false,
                    fixed: {
                        enabled: false
                    },
                    offsetX: 0,
                    offsetY: 0,
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        const relData = filteredROTCE[dataPointIndex];
                        if (!relData) return "";
                        
                        const relName = relData.name;
                        const rotce = relData.rotce;
                        const minROTCE = relData.minROTCE;
                        const maxROTCE = relData.maxROTCE;
                        const facilities = relData.facilities;
                        const region = relData.region;
                        const regionalBreakdown = relData.regionalBreakdown || { NAM: { count: 0, tfa: 0 }, LATAM: { count: 0, tfa: 0 }, EMEA: { count: 0, tfa: 0 }, APAC: { count: 0, tfa: 0 } };
                        
                        // ROTCE status and colors
                        const rotceStatus = rotce >= 12 ? "Above Target" : rotce >= 8 ? "Acceptable" : "Below Target";
                        const rotceColor = rotce >= 12 ? "#10B981" : rotce >= 8 ? "#F59E0B" : "#EF4444";
                        const rotceBgColor = rotce >= 12 ? "#F0FDF4" : rotce >= 8 ? "#FFFBEB" : "#FEF2F2";
                        const rotceBorderColor = rotce >= 12 ? "#D1FAE5" : rotce >= 8 ? "#FEF3C7" : "#FEE2E2";
                        
                        // Region badge colors
                        const regionColors = {
                            'APAC': '#3B82F6',
                            'EMEA': '#10B981',
                            'NAM': '#F97316',
                            'LATAM': '#A855F7'
                        };
                        const regionColor = regionColors[region] || '#6B7280';
                        
                        // Build regional table rows
                        let regionalRows = '';
                        ['NAM', 'LATAM', 'EMEA', 'APAC'].forEach(regionKey => {
                            const regionData = regionalBreakdown[regionKey];
                            if (regionData && regionData.count > 0) {
                                regionalRows += `
                                    <tr>
                                        <td style="padding: 6px 8px; text-align: left; font-size: 11px; color: #6B7280; font-weight: 500;">${regionKey}</td>
                                        <td style="padding: 6px 8px; text-align: center; font-size: 11px; color: #111827; font-weight: 600;">${regionData.count}</td>
                                        <td style="padding: 6px 8px; text-align: right; font-size: 11px; color: #111827; font-weight: 600;">${formatCurrency(regionData.tfa)}</td>
                                    </tr>
                                `;
                            }
                        });
                        
                        return `
                            <div style="
                                background: #ffffff; 
                                border-radius: 12px; 
                                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
                                min-width: 320px;
                                max-width: 360px;
                                overflow: hidden;
                                font-family: Outfit, sans-serif;
                            ">
                                <!-- Header with border -->
                                <div style="
                                    border-bottom: 1px solid #E5E7EB;
                                    padding: 16px 16px 12px 16px;
                                    margin-bottom: 14px;
                                ">
                                    <div style="
                                        display: flex;
                                        align-items: center;
                                        gap: 8px;
                                        margin-bottom: 6px;
                                    ">
                                        <div style="
                                            font-weight: 600; 
                                            font-size: 15px; 
                                            color: #111827;
                                            flex: 1;
                                        ">${relName}</div>
                                        <span style="
                                            background: ${regionColor};
                                            color: white;
                                            font-size: 10px;
                                            font-weight: 600;
                                            padding: 3px 8px;
                                            border-radius: 12px;
                                        ">${region}</span>
                                    </div>
                                    <div style="
                                        font-size: 12px; 
                                        font-weight: 500;
                                        color: #6B7280;
                                    ">Relationship Performance</div>
                                </div>
                                
                                <!-- Content wrapper -->
                                <div style="padding: 0 16px 16px 16px;">
                                    <!-- Widget Grid (3 columns for main metrics) -->
                                    <div style="
                                        display: grid;
                                        grid-template-columns: 1fr 1fr 1fr;
                                        gap: 8px;
                                        margin-bottom: 16px;
                                    ">
                                        <!-- Widget 1: Avg ROTCE -->
                                        <div style="
                                            background: ${rotceBgColor};
                                            border-radius: 8px;
                                            padding: 10px;
                                            border: 1px solid ${rotceBorderColor};
                                        ">
                                            <div style="
                                                display: flex;
                                                align-items: center;
                                                gap: 4px;
                                                font-size: 10px;
                                                color: ${rotceColor};
                                                font-weight: 500;
                                                margin-bottom: 4px;
                                            ">
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                                                </svg>
                                                ROTCE
                                            </div>
                                            <div style="
                                                font-size: 18px;
                                                font-weight: 700;
                                                color: ${rotceColor};
                                            ">${rotce.toFixed(1)}%</div>
                                        </div>
                                        
                                        <!-- Widget 2: Facilities -->
                                        <div style="
                                            background: #F9FAFB;
                                            border-radius: 8px;
                                            padding: 10px;
                                            border: 1px solid #E5E7EB;
                                        ">
                                            <div style="
                                                display: flex;
                                                align-items: center;
                                                gap: 4px;
                                                font-size: 10px;
                                                color: #6B7280;
                                                font-weight: 500;
                                                margin-bottom: 4px;
                                            ">
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                                </svg>
                                                Count
                                            </div>
                                            <div style="
                                                font-size: 18px;
                                                font-weight: 700;
                                                color: #111827;
                                            ">${facilities}</div>
                                        </div>
                                        
                                        <!-- Widget 3: TFA -->
                                        <div style="
                                            background: #F9FAFB;
                                            border-radius: 8px;
                                            padding: 10px;
                                            border: 1px solid #E5E7EB;
                                        ">
                                            <div style="
                                                display: flex;
                                                align-items: center;
                                                gap: 4px;
                                                font-size: 10px;
                                                color: #6B7280;
                                                font-weight: 500;
                                                margin-bottom: 4px;
                                            ">
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <line x1="12" y1="1" x2="12" y2="23"></line>
                                                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                                </svg>
                                                TFA
                                            </div>
                                            <div style="
                                                font-size: 14px;
                                                font-weight: 700;
                                                color: #111827;
                                            ">${formatCurrency(relData.tfa)}</div>
                                        </div>
                                    </div>
                                    
                                    <!-- ROTCE Range Metrics -->
                                    <div style="
                                        display: flex;
                                        gap: 8px;
                                        margin-bottom: 16px;
                                        padding: 10px 12px;
                                        background: #F9FAFB;
                                        border-radius: 6px;
                                        border: 1px solid #E5E7EB;
                                    ">
                                        <div style="flex: 1;">
                                            <div style="font-size: 10px; color: #6B7280; font-weight: 500; margin-bottom: 2px;">Status</div>
                                            <div style="font-size: 13px; font-weight: 600; color: ${rotceColor};">${rotceStatus}</div>
                                        </div>
                                        <div style="width: 1px; background: #E5E7EB;"></div>
                                        <div style="flex: 1; text-align: center;">
                                            <div style="font-size: 10px; color: #6B7280; font-weight: 500; margin-bottom: 2px;">Min ROTCE</div>
                                            <div style="font-size: 13px; font-weight: 600; color: ${minROTCE >= 12 ? '#10B981' : '#EF4444'};">${minROTCE.toFixed(1)}%</div>
                                        </div>
                                        <div style="width: 1px; background: #E5E7EB;"></div>
                                        <div style="flex: 1; text-align: right;">
                                            <div style="font-size: 10px; color: #6B7280; font-weight: 500; margin-bottom: 2px;">Max ROTCE</div>
                                            <div style="font-size: 13px; font-weight: 600; color: ${maxROTCE >= 12 ? '#10B981' : '#EF4444'};">${maxROTCE.toFixed(1)}%</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Regional Distribution Table -->
                                    <div style="margin-top: 12px;">
                                        <div style="
                                            display: flex;
                                            align-items: center;
                                            gap: 6px;
                                            margin-bottom: 8px;
                                        ">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                            </svg>
                                            <span style="
                                                font-size: 12px;
                                                font-weight: 600;
                                                color: #374151;
                                            ">Regional Distribution</span>
                                        </div>
                                        <table style="width: 100%; border-collapse: collapse;">
                                            <thead>
                                                <tr style="border-bottom: 1px solid #E5E7EB;">
                                                    <th style="padding: 6px 8px; text-align: left; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Region</th>
                                                    <th style="padding: 6px 8px; text-align: center; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Count</th>
                                                    <th style="padding: 6px 8px; text-align: right; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">TFA</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${regionalRows || '<tr><td colspan="3" style="padding: 8px; text-align: center; font-size: 11px; color: #9CA3AF;">No data</td></tr>'}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                    },
                },
            };

            // Destroy existing chart instance properly
            if (rotceChartInstance) {
                try {
                    rotceChartInstance.destroy();
                } catch (e) {
                    console.log("Error destroying ROTCE chart:", e);
                }
                rotceChartInstance = null;
            }
            
            // Use the chartElement from the top of the function
            if (chartElement) {
                chartElement.innerHTML = "";
            }

            if (relationships.length === 0) {
                chartElement.innerHTML = generateNoDataMessage('ROTCE Performance');
                return;
            }

            // Create and store the chart instance
            try {
            rotceChartInstance = new ApexCharts(chartElement, chartOptions);
            rotceChartInstance.render();
                console.log(" ROTCE chart rendered successfully");
            } catch (error) {
                console.error(" Error rendering ROTCE chart:", error);
                chartElement.innerHTML = generateNoDataMessage('ROTCE Performance');
            }
        }

        // Create ROTCE chart from filtered data
        function createROTCEChartFromFiltered() {
            console.log(" Creating filtered ROTCE Performance chart");

            const chartElement = document.querySelector("#rotceChart");
            
            // Check if we have data
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
            if (!dataSource || dataSource.length === 0) {
                console.log(" No data available for filtered ROTCE chart");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('ROTCE Performance');
                }
                return;
            }

            // Get Top N from Top Relationships filter (synced)
            const topN = parseInt(document.getElementById("topNFilter").value);
            
            // Group ROTCE by relationship from filtered data
            const rotceByRelationship = new Map();
            const rotceValues = [];
            
            dataSource.forEach((row) => {
                const relName = row.Relationship_Name || row.Relationship_ID;
                const rotce = parsePercentage(row.ROTCE);
                
                if (relName && !isNaN(rotce)) {
                    if (!rotceByRelationship.has(relName)) {
                        rotceByRelationship.set(relName, []);
                    }
                    rotceByRelationship.get(relName).push(rotce);
                    rotceValues.push(rotce);
                }
            });
            
            // Calculate average ROTCE per relationship
            const relationshipROTCE = [];
            rotceByRelationship.forEach((values, relName) => {
                const average =
                    values.reduce((sum, val) => sum + val, 0) / values.length;
                relationshipROTCE.push({ name: relName, rotce: average });
            });
            
            // Get Top Relationships to match their order
            const relationshipData = new Map();
            for (const row of dataSource) {
                const relId = row.Relationship_Name || row.Relationship_ID;
                if (!relId) continue;
                
                if (!relationshipData.has(relId)) {
                    relationshipData.set(relId, {
                        tfa: 0,
                        direct: 0,
                        contingent: 0,
                        pse: 0,
                        osuc: 0,
                        unused: 0,
                    });
                }
                const data = relationshipData.get(relId);
                data.tfa += parseNumber(row.Fac_Amount || row.Facility_Amount);
                data.direct += parseNumber(row.Direct_OS);
                data.contingent += parseNumber(row.Contingent_OS);
                data.pse += parseNumber(row.PSE_OS);
                data.osuc += parseNumber(row.OSUC);
                data.unused += parseNumber(row.Unused_Committed);
            }

            // Get the selected field value for sorting (sync with Top Relationships chart)
            const relationshipTotals = new Map();
            for (const [relId, data] of relationshipData.entries()) {
                let sortValue = 0;
                switch (selectedAmountType) {
                    case "tfa":
                        sortValue = data.tfa;
                        break;
                    case "direct":
                        sortValue = data.direct;
                        break;
                    case "contingent":
                        sortValue = data.contingent;
                        break;
                    case "pse":
                        sortValue = data.pse;
                        break;
                    case "osuc":
                        sortValue = data.osuc;
                        break;
                    case "unused":
                        sortValue = data.unused;
                        break;
                    default:
                        sortValue = data.direct;
                }
                relationshipTotals.set(relId, sortValue);
            }

            // Get top N relationships by selected exposure type (matching Top Relationships chart)
            const topRelationships = Array.from(relationshipTotals.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, topN)
                .map((entry) => entry[0]);
            
            // Check if we have any relationships with non-zero values
            const hasValidRelationships = Array.from(relationshipTotals.entries())
                .some(([relId, value]) => value > 0);

            console.log("DEBUG ROTCE - relationshipTotals size:", relationshipTotals.size);
            console.log("DEBUG ROTCE - hasValidRelationships:", hasValidRelationships);
            console.log("DEBUG ROTCE - topRelationships length:", topRelationships.length);
            
            // Destroy existing chart instance properly
            if (rotceChartInstance) {
                try {
                    rotceChartInstance.destroy();
                } catch (e) {
                    console.log("Error destroying ROTCE chart:", e);
                }
                rotceChartInstance = null;
            }
            
            // Use the chartElement from the top of the function
            if (chartElement) {
                chartElement.innerHTML = "";
            }

            // Update subtitle
            const subtitleEl = document.getElementById("rotceSubtitle");
            if (subtitleEl) {
                subtitleEl.textContent = `Top ${topN} relationships ROTCE performance`;
            }

            // If no valid relationships in Top Relationships chart, don't show ROTCE
            if (!hasValidRelationships || topRelationships.length === 0 || relationshipTotals.size === 0) {
                console.log(" No relationships data available - skipping ROTCE chart (filtered)");
                if (chartElement) {
                    chartElement.innerHTML = generateNoDataMessage('ROTCE Performance');
                }
                return;
            }

            // Filter and order ROTCE data to match top relationships
            const filteredROTCE = topRelationships
                .map((relName) => relationshipROTCE.find((r) => r.name === relName))
                .filter((r) => r !== undefined);

            // Add index numbers (1, 2, 3, ...) to match Top Relationships chart
            const relationships = filteredROTCE.map(
                (r, index) => `${index + 1}. ${r.name}`
            );
            const avgROTCE = filteredROTCE.map((r) => r.rotce);

            // Debug logging for ROTCE
            console.log("DEBUG ROTCE (filtered) - selectedAmountType:", selectedAmountType);
            console.log("DEBUG ROTCE (filtered) - topRelationships:", topRelationships);
            console.log("DEBUG ROTCE (filtered) - relationships:", relationships);
            console.log("DEBUG ROTCE (filtered) - avgROTCE:", avgROTCE);
            console.log("DEBUG ROTCE (filtered) - filteredROTCE:", filteredROTCE);
            
            if (relationships.length === 0) {
                chartElement.innerHTML = generateNoDataMessage('ROTCE Performance');
                return;
            }

            // Check if all ROTCE values are zero or NaN
            const validROTCE = avgROTCE.filter(v => !isNaN(v) && v !== 0);
            if (validROTCE.length === 0) {
                console.warn(" No valid ROTCE data for the selected relationships");
                chartElement.innerHTML = generateNoDataMessage('ROTCE Performance');
                return;
            }
            
            // Conditional colors: red if < 12%, green if >= 12%
            const barColors = avgROTCE.map((rotce) =>
                rotce < 12 ? "#ef4444" : "#10b981"
            );
            
            // Calculate dynamic height
            const calculatedHeight = Math.max(350, relationships.length * 35);
            
            // Create horizontal bar chart
            const chartOptions = {
                series: [
                    {
                        name: "Average ROTCE",
                        data: avgROTCE,
                    },
                ],
                chart: {
                    type: "bar",
                    height: calculatedHeight,
                    toolbar: { show: false },
                    fontFamily: "Outfit, sans-serif",
                },
                colors: barColors,
                plotOptions: {
                    bar: {
                        horizontal: true,
                        columnWidth: "70%",
                        borderRadius: 4,
                        distributed: true, // Enable individual bar colors
                        dataLabels: {
                            position: "center",
                        },
                    },
                },
                dataLabels: {
                    enabled: true,
                    formatter: function (val) {
                        return val.toFixed(1) + "%";
                    },
                    style: {
                        fontSize: "12px",
                        fontFamily: "Outfit, sans-serif",
                        colors: ["#fff"],
                        fontWeight: "bold",
                    },
                },
                annotations: {
                    xaxis: [
                        {
                        x: 12,
                            borderColor: "#f59e0b",
                        strokeDashArray: 8,
                        label: {
                                borderColor: "#f59e0b",
                            style: {
                                    color: "#fff",
                                    background: "#f59e0b",
                                    fontSize: "12px",
                                    fontFamily: "Outfit, sans-serif",
                                    fontWeight: "bold",
                                },
                                text: "Target: 12%",
                            },
                        },
                    ],
                },
                xaxis: {
                    categories: relationships,
                    title: {
                        style: {
                            color: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                    labels: {
                        formatter: function (val) {
                            return val.toFixed(0) + "%";
                        },
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                    },
                },
                yaxis: {
                    labels: {
                        align: 'left',
                        offsetX: -10,
                        style: {
                            colors: relationships.map(() => "#6B7280"),
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif",
                        },
                        maxWidth: 200,
                    },
                },
                grid: {
                    borderColor: "#E5E7EB",
                    strokeDashArray: 4,
                    xaxis: { lines: { show: true } },
                    yaxis: { lines: { show: false } },
                },
                legend: {
                    show: false,
                },
                tooltip: {
                    theme: "light",
                    style: {
                        fontSize: "12px",
                        fontFamily: "Outfit, sans-serif",
                    },
                    y: {
                        formatter: function (val) {
                            const color = val < 12 ? "Below target" : "Above target";
                            return val.toFixed(2) + "% - " + color;
                        },
                    },
                },
            };
            
            // Create and store the chart instance
            try {
            rotceChartInstance = new ApexCharts(chartElement, chartOptions);
            rotceChartInstance.render();
                console.log(" Filtered ROTCE chart rendered successfully");
            } catch (error) {
                console.error(" Error rendering filtered ROTCE chart:", error);
                chartElement.innerHTML = generateNoDataMessage('ROTCE Performance');
            }
        }

        // Filter data based on search (works with existing filters)
        function filterData() {
            const startTime = performance.now();
            
            // Check if any smart filters are active
            const smartFiltersActive =
                selectedRegion !== "all" || selectedPSE !== "all" || selectedStatus !== "all";
            
            // If no filters are active (neither advanced nor smart filters), just apply search to all data
            if (Object.keys(activeFilters).length === 0 && !smartFiltersActive) {
                const searchTerm = selectedSearchTerm.toLowerCase();
                
                if (searchTerm === "") {
                    filteredData = [...portfolioData];
                    
                    // No search term, show all data - update charts to show full data
                    requestAnimationFrame(() => {
                        createFacilityTrendChart();
                        createRelationshipChart();
                        createNewFacilitiesApprovedChart();
                        createROTCEChart();
                    });
                } else {
                    // Optimized search
                    filteredData = [];
                    for (let i = 0; i < portfolioData.length; i++) {
                        const row = portfolioData[i];
                        let found = false;
                        for (const value of Object.values(row)) {
                            if (String(value).toLowerCase().includes(searchTerm)) {
                                found = true;
                                break;
                            }
                        }
                        if (found) filteredData.push(row);
                    }
                    
                    // Search term is active, update charts with filtered data
                    requestAnimationFrame(() => {
                        calculateMetricsFromFiltered();
                        createFacilityTrendChartFromFiltered();
                        createRelationshipChartFromFiltered();
                        createNewFacilitiesApprovedChartFromFiltered();
                        createROTCEChartFromFiltered();
                    });
                }
                
            } else {
                // If filters are active, reapply them (which will include search)
                applyFilters();
            }
        }

        // ========================================
        // EXPAND/DETAILS MODAL FUNCTIONS
        // ========================================

        let currentExpandType = null;

        // Define details content for each chart/card type
        const expandModalDetails = {
            // Top 5 Metric Cards
            tfa: {
                title: "Total Facilities Approved (TFA)",
                subtitle: "Complete breakdown of all approved facility amounts",
                content: `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-red-50 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-red-600" id="expandTfaTotal">$0.00</p>
                                <p class="text-sm text-gray-600 mt-1">Total TFA</p>
                            </div>
                            <div class="bg-gray-50 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-gray-800" id="expandTfaFacilities">0</p>
                                <p class="text-sm text-gray-600 mt-1">Total Facilities</p>
                            </div>
                            <div class="bg-blue-50 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-blue-600" id="expandTfaAvg">$0.00</p>
                                <p class="text-sm text-gray-600 mt-1">Avg per Facility</p>
                            </div>
                        </div>
                    </div>
                `
            },
            osuc: {
                title: "OSUC",
                subtitle: "OSUC Breakdown",
                content: `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-orange-50 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-orange-600" id="expandOsucTotal">$0.00</p>
                                <p class="text-sm text-gray-600 mt-1">Total OSUC</p>
                            </div>
                            <div class="bg-blue-50 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-blue-600" id="expandOsucOS">$0.00</p>
                                <p class="text-sm text-gray-600 mt-1">Outstanding Balance</p>
                            </div>
                            <div class="bg-green-50 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-green-600" id="expandOsucUnused">$0.00</p>
                                <p class="text-sm text-gray-600 mt-1">Unused Commitment</p>
                            </div>
                        </div>
                    </div>
                `
            },
            outstanding: {
                title: "Total Outstanding",
                subtitle: "Combined direct, contingent, and PSE exposures (drawn amount)",
                content: `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="bg-purple-50 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-purple-600" id="expandOsTotal">$0.00</p>
                                <p class="text-sm text-gray-600 mt-1">Total Outstanding</p>
                            </div>
                            <div class="bg-blue-50 rounded-xl p-4 text-center">
                                <p class="text-xl font-bold text-blue-600" id="expandOsDirect">$0.00</p>
                                <p class="text-sm text-gray-600 mt-1">Direct OS</p>
                            </div>
                            <div class="bg-amber-50 rounded-xl p-4 text-center">
                                <p class="text-xl font-bold text-amber-600" id="expandOsContingent">$0.00</p>
                                <p class="text-sm text-gray-600 mt-1">Contingent OS</p>
                            </div>
                            <div class="bg-teal-50 rounded-xl p-4 text-center">
                                <p class="text-xl font-bold text-teal-600" id="expandOsPse">$0.00</p>
                                <p class="text-sm text-gray-600 mt-1">PSE OS</p>
                            </div>
                        </div>
                    </div>
                `
            },
            facilities: {
                title: "Total Facilities",
                subtitle: "Count of all facilities in the portfolio",
                content: `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-green-50 rounded-xl p-4 text-center">
                                <p class="text-3xl font-bold text-green-600" id="expandFacTotal">0</p>
                                <p class="text-sm text-gray-600 mt-1">Total Facilities</p>
                            </div>
                            <div class="bg-gray-50 rounded-xl p-4 text-center">
                                <p class="text-3xl font-bold text-gray-800" id="expandFacRelationships">0</p>
                                <p class="text-sm text-gray-600 mt-1">Unique Relationships</p>
                            </div>
                        </div>
                    </div>
                `
            },
            relationships: {
                title: "Total Relationships",
                subtitle: "Count of unique client relationships",
                content: `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-blue-50 rounded-xl p-4 text-center">
                                <p class="text-3xl font-bold text-blue-600" id="expandRelTotal">0</p>
                                <p class="text-sm text-gray-600 mt-1">Total Relationships</p>
                            </div>
                            <div class="bg-gray-50 rounded-xl p-4 text-center">
                                <p class="text-3xl font-bold text-gray-800" id="expandRelAvgFac">0</p>
                                <p class="text-sm text-gray-600 mt-1">Avg Facilities per Relationship</p>
                            </div>
                        </div>
                    </div>
                `
            },
            // Chart cards - generic details for now
            expiring: {
                title: "CAs & Facilities Expiring",
                subtitle: "Credit agreements and facilities approaching maturity",
                content: `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-blue-50 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-blue-600" id="expandExpCAs">0</p>
                                <p class="text-sm text-gray-600 mt-1">CAs Expiring (3 months)</p>
                            </div>
                            <div class="bg-orange-50 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-orange-600" id="expandExpFac">0</p>
                                <p class="text-sm text-gray-600 mt-1">Facilities Expiring (3 months)</p>
                            </div>
                        </div>
                    </div>
                `
            },
            covenantMonitoring: {
                title: "Covenant Monitoring",
                subtitle: "Past due and coming due covenant tracking",
                content: `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-red-50 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-red-600" id="expandCovenantPastDue">0</p>
                                <p class="text-sm text-gray-600 mt-1">Past Due Covenants</p>
                            </div>
                            <div class="bg-orange-50 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-orange-600" id="expandCovenantComingDue">0</p>
                                <p class="text-sm text-gray-600 mt-1">Coming Due Covenants</p>
                            </div>
                            <div class="bg-blue-50 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-blue-600" id="expandCovenantTotal">0</p>
                                <p class="text-sm text-gray-600 mt-1">Total Covenants</p>
                            </div>
                        </div>
                    </div>
                `
            },
            covenantRegional: {
                title: "Covenants by Region",
                subtitle: "Regional breakdown of covenant status",
                content: `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-red-50 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-red-600" id="expandCovenantRegPastDue">0</p>
                                <p class="text-sm text-gray-600 mt-1">Past Due</p>
                            </div>
                            <div class="bg-orange-50 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-orange-600" id="expandCovenantRegComingDue">0</p>
                                <p class="text-sm text-gray-600 mt-1">Coming Due</p>
                            </div>
                        </div>
                    </div>
                `
            },
            ccmRegionalChart: {
                title: "Criticized/Classified Memos & Reviews",
                subtitle: "CCM status tracking across regions",
                content: `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-red-50 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-red-600" id="expandCCMPastDue">0</p>
                                <p class="text-sm text-gray-600 mt-1">Past Due</p>
                            </div>
                            <div class="bg-orange-50 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-orange-600" id="expandCCMComingDue">0</p>
                                <p class="text-sm text-gray-600 mt-1">Coming Due</p>
                            </div>
                            <div class="bg-blue-50 rounded-xl p-4 text-center">
                                <p class="text-2xl font-bold text-blue-600" id="expandCCMOpen">0</p>
                                <p class="text-sm text-gray-600 mt-1">Open</p>
                            </div>
                        </div>
                    </div>
                `
            }
        };

        // Open expand modal with specific content
        function openExpandModal(chartType) {
            console.log('Opening expand modal for:', chartType, 'Current covenant view:', window.currentCovenantViewType);
            currentExpandType = chartType;
            const modal = document.getElementById("expandModal");
            const modalTitle = document.getElementById("expandModalTitle");
            const modalSubtitle = document.getElementById("expandModalSubtitle");

            if (!modal) {
                console.error('Expand modal element not found!');
                return;
            }

            // Get details for this chart type or use default
            let details = expandModalDetails[chartType] || {
                title: chartType.charAt(0).toUpperCase() + chartType.slice(1).replace(/([A-Z])/g, ' $1'),
                subtitle: "Expanded view with additional details",
                content: ``
            };
            
            // For covenant charts, update title/subtitle based on current view type
            if (chartType === 'covenantMonitoring' || chartType === 'covenantRegional') {
                const isPastDue = window.currentCovenantViewType === 'pastDue';
                if (chartType === 'covenantMonitoring') {
                    details.title = isPastDue ? 'Past Due Covenants' : 'Coming Due Covenants (Next 30 Days)';
                    details.subtitle = isPastDue ? 'Covenants past their due date' : 'Covenants due in the next 30 days';
                } else if (chartType === 'covenantRegional') {
                    details.title = isPastDue ? 'Past Due Covenants by Region' : 'Coming Due Covenants by Region (Next 30 Days)';
                    details.subtitle = isPastDue ? 'Regional breakdown of past due covenants' : 'Regional breakdown of covenants due in the next 30 days';
                }
            }

            modalTitle.textContent = details.title;
            modalSubtitle.textContent = details.subtitle;
            
            // Show insights tab
            switchExpandTab('insights');

            // Populate dynamic values based on chart type
            populateExpandModalValues(chartType);

            // Show modal
            console.log('Showing modal...');
            modal.classList.remove("hidden");
            document.body.style.overflow = "hidden";
            console.log('Modal should be visible now');
        }

        // Populate values in the expand modal with tabs
        function populateExpandModalValues(chartType) {
            // All charts should respect user filters by using filtered data
            let dataSource;
            if (chartType === 'covenantMonitoring' || chartType === 'covenantRegional') {
                // Apply covenant-specific filters (Region, Underwriter, Product Program only)
                const rawCovenantData = window.covenantsData || [];
                dataSource = applyCovenantFilters(rawCovenantData);
                console.log(' Using filtered covenant data source:', dataSource.length, 'of', rawCovenantData.length, 'records');
            } else if (chartType === 'ccmRegionalChart') {
                // CCM data should also use covenant-specific filters (similar structure)
                const rawCCMData = window.ccmData || [];
                dataSource = applyCovenantFilters(rawCCMData);
                console.log(' Using filtered CCM data source:', dataSource.length, 'of', rawCCMData.length, 'records');
            } else {
                // Use filteredData if it exists and has records, otherwise use portfolioData
                // This handles the case when page loads or filters are cleared
                dataSource = (filteredData && filteredData.length > 0) ? filteredData : portfolioData;
                console.log(' Using filtered portfolio data:', dataSource.length, 'records');
            }
            
            const insightsContent = document.getElementById('insightsContent');
            
            console.log(' populateExpandModalValues:', {
                chartType,
                portfolioDataLength: portfolioData.length,
                filteredDataLength: filteredData.length,
                dataSourceLength: dataSource.length,
                willShowNoData: dataSource.length === 0
            });
            
            // Show loading state for insights
            insightsContent.innerHTML = `
                <div class="flex items-center justify-center py-12 text-gray-400">
                    <svg class="animate-spin h-8 w-8 mr-3" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Loading insights...
                </div>
            `;
            
            // Defer rendering for performance
            setTimeout(() => {
                try {
                // Generate insights content  
                const htmlContent = generateExpandedView(chartType, dataSource);
                insightsContent.innerHTML = htmlContent;
                
                // Extract and execute any embedded scripts (for charts not yet refactored)
                const scriptRegex = /<script>([\s\S]*?)<\\?\/script>/gi;
                let match;
                while ((match = scriptRegex.exec(htmlContent)) !== null) {
                    try {
                        eval(match[1]);
                    } catch (e) {
                        console.error(`Error executing embedded script for ${chartType}:`, e);
                    }
                }
                
                // Initialize any charts if needed
                initializeExpandCharts(chartType, dataSource);
                
                // Initialize pipeline details table if this is the pipeline modal
                if (chartType === 'pipeline' && typeof renderPipelineDetailsTable === 'function') {
                    console.log('Initializing Pipeline Details Table');
                    setTimeout(() => {
                        renderPipelineDetailsTable();
                    }, 100);
                }
                } catch (error) {
                    console.error(' Error generating expanded view for', chartType, error);
                    insightsContent.innerHTML = `
                        <div class="flex items-center justify-center h-full min-h-[400px]">
                            <div class="text-center">
                                <svg class="mx-auto h-12 w-12 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                                <h3 class="mt-2 text-sm font-medium text-gray-900">Error loading expanded view</h3>
                                <p class="mt-1 text-sm text-gray-500">${error.message}</p>
                            </div>
                        </div>
                    `;
                }
            }, 50);
        }
        
        // Switch to insights tab - simplified
        function switchExpandTab(tabName) {
            console.log(' switchExpandTab called with:', tabName);
            
            // Only insights tab is available now
            const insightsTab = document.getElementById('insightsTab');
            const insightsContent = document.getElementById('insightsContent');
            
            const activeClass = 'inline-flex items-center gap-2 border-b-2 px-2.5 py-3 text-sm font-medium transition-colors duration-200 ease-in-out text-blue-600 border-blue-600';
            
            if (tabName === 'insights' && insightsTab && insightsContent) {
                // Active insights tab
                insightsTab.className = activeClass;
                insightsContent.classList.remove('hidden');
                console.log(' Switched to Insights tab');
            }
        }
        
        // Helper function to apply all active filters to data
        function applyAllFilters(dataSource) {
            let filtered = dataSource;
            
            // Apply region filter
            if (selectedRegion && selectedRegion !== 'all') {
                filtered = filtered.filter(row => {
                    const region = (row.Region || "").toUpperCase();
                    return region === selectedRegion.toUpperCase();
                });
            }
            
            // Apply PSE filter
            if (selectedPSE && selectedPSE !== 'all') {
                filtered = filtered.filter(row => {
                    const isPSE = (row.PSE_Risk_Indicator || "").toUpperCase() === 'PSE';
                    return selectedPSE === 'PSE' ? isPSE : !isPSE;
                });
            }
            
            // Apply Management Status filter
            if (selectedStatus && selectedStatus !== 'all') {
                filtered = filtered.filter(row => {
                    const status = (row.Management_Status || "").toUpperCase();
                    return status === selectedStatus.toUpperCase();
                });
            }
            
            // Apply Commitment Status filter
            if (selectedCommitmentStatus && selectedCommitmentStatus !== 'all') {
                filtered = filtered.filter(row => {
                    const isCommitted = (row.Commitment_Status || "Committed").toUpperCase() === 'COMMITTED';
                    return selectedCommitmentStatus === 'Committed' ? isCommitted : !isCommitted;
                });
            }
            
            // Apply search filter
            if (selectedSearchTerm && selectedSearchTerm.trim() !== '') {
                const searchLower = selectedSearchTerm.toLowerCase();
                filtered = filtered.filter(row => {
                    return Object.values(row).some(val => 
                        String(val).toLowerCase().includes(searchLower)
                    );
                });
            }
            
            return filtered;
        }
        
        // Helper function to apply covenant-specific filters (only Region, Underwriter, Product Program)
        function applyCovenantFilters(dataSource) {
            if (!dataSource || dataSource.length === 0) {
                console.log(' applyCovenantFilters - No data source provided');
                return [];
            }
            
            let filtered = [...dataSource]; // Clone array
            
            console.log(' applyCovenantFilters - Starting with:', filtered.length, 'records');
            
            // Apply region filter (Covenant data has Region field)
            if (selectedRegion && selectedRegion !== 'all') {
                const beforeFilter = filtered.length;
                filtered = filtered.filter(row => {
                    const region = (row.Region || "").toUpperCase();
                    return region === selectedRegion.toUpperCase();
                });
                console.log(' Region filter applied:', selectedRegion, '- Reduced from', beforeFilter, 'to', filtered.length);
            }
            
            // Get advanced filter values from activeFilters (if set)
            const underwriterFilter = activeFilters?.underwriter || "";
            const productProgramFilter = activeFilters?.productProgram || "";
            
            // Apply Underwriter filter (Covenant data has Lead_Underwriter field)
            if (underwriterFilter && underwriterFilter.trim() !== '') {
                const beforeFilter = filtered.length;
                filtered = filtered.filter(row => {
                    const underwriter = (row.Lead_Underwriter || "").toLowerCase();
                    return underwriter.includes(underwriterFilter.toLowerCase());
                });
                console.log(' Underwriter filter applied:', underwriterFilter, '- Reduced from', beforeFilter, 'to', filtered.length);
            }
            
            // Apply Product Program filter (Covenant data has Product_Program field)
            if (productProgramFilter && productProgramFilter.trim() !== '') {
                const beforeFilter = filtered.length;
                filtered = filtered.filter(row => {
                    const productProgram = (row.Product_Program || "").toLowerCase();
                    return productProgram.includes(productProgramFilter.toLowerCase());
                });
                console.log(' Product Program filter applied:', productProgramFilter, '- Reduced from', beforeFilter, 'to', filtered.length);
            }
            
            // Apply search filter
            if (selectedSearchTerm && selectedSearchTerm.trim() !== '') {
                const beforeFilter = filtered.length;
                const searchLower = selectedSearchTerm.toLowerCase();
                filtered = filtered.filter(row => {
                    return Object.values(row).some(val => 
                        String(val).toLowerCase().includes(searchLower)
                    );
                });
                console.log(' Search filter applied:', selectedSearchTerm, '- Reduced from', beforeFilter, 'to', filtered.length);
            }
            
            console.log(' applyCovenantFilters - Final count:', filtered.length, 'records');
            return filtered;
        }
        
        // Generate expanded view HTML based on chart type
        function generateExpandedView(chartType, dataSource) {
            // If no data, show consistent no-data message with filters
            if (!dataSource || dataSource.length === 0) {
                const chartTitles = {
                    'tfa': 'Total Facilities Approved (TFA)',
                    'osuc': 'Total O/S Utilized & Committed (OSUC)',
                    'outstanding': 'Total Outstanding',
                    'facilities': 'Total # of Facilities',
                    'relationships': 'Total # of Relationships',
                    'expiring': 'CAs & Facilities Expiring',
                    'newFacilities': 'New Facilities Approved',
                    'newDealsYTD': 'New Deals YTD',
                    'newDealsMTD': 'New Deals MTD',
                    'pipeline': 'Pipeline',
                    'topRelationships': 'Top Relationships',
                    'rotce': 'ROTCE Performance',
                    'covenantMonitoring': 'Covenant Monitoring',
                    'covenantRegional': 'Covenant Regional Distribution',
                    'ccmRegionalChart': 'CCM Regional Distribution'
                };
                
                const chartTitle = chartTitles[chartType] || 'Chart';
                return `<div class="flex items-center justify-center h-full min-h-[400px]">
                    ${generateNoDataMessage(chartTitle)}
                </div>`;
            }
            
            switch(chartType) {
                case 'tfa':
                    return generateTFAExpandedView(dataSource);
                case 'osuc':
                    return generateOSUCExpandedView(dataSource);
                case 'outstanding':
                    return generateOutstandingExpandedView(dataSource);
                case 'facilities':
                    return generateFacilitiesExpandedView(dataSource);
                case 'relationships':
                    return generateRelationshipsExpandedView(dataSource);
                case 'expiring':
                    return generateExpiringExpandedView(dataSource);
                case 'newFacilities':
                    return generateNewFacilitiesExpandedView(dataSource);
                case 'newDealsYTD':
                    return generateNewDealsYTDExpandedView(dataSource);
                case 'newDealsMTD':
                    return generateNewDealsMTDExpandedView(dataSource);
                case 'pipeline':
                    return generatePipelineExpandedView(dataSource);
                case 'topRelationships':
                    return generateTopRelationshipsExpandedView(dataSource);
                case 'rotce':
                    return generateROTCEExpandedView(dataSource);
                case 'covenantMonitoring':
                    return generateCovenantExpandedView(dataSource);
                case 'covenantRegional':
                    return generateCovenantRegionalExpandedView(dataSource);
                case 'ccmRegionalChart':
                    return generateCCMExpandedView(dataSource);
                default:
                    return '<p class="text-gray-500">No detailed view available for this chart.</p>';
            }
        }
        
        // Generate data table for chart type
        
        // Build data table (from old working version)
        function buildDataTable(data, tableHeader, tableBody) {
            console.log(' buildDataTable called with:', data?.length, 'records');
            
            if (!data || data.length === 0) {
                console.warn(' No data to build table');
                tableHeader.innerHTML = "";
                document.getElementById("chartDataTableFilters").innerHTML = "";
                tableBody.innerHTML = '<tr><td colspan="100" class="text-center py-8 text-gray-500">No data available</td></tr>';
                updatePaginationControls(0, 0, 0);
                return;
            }

            console.log(' Building table with columns:', Object.keys(data[0]));
            
            // Update table state
            window.tableState.data = data;
            window.tableState.columns = Object.keys(data[0]);
            window.tableState.currentPage = 1;
            window.tableState.columnFilters = {};
            
            // Apply filters
            applyTableFilters();
            console.log(' After applyTableFilters, filteredData length:', window.tableState.filteredData.length);

            // Build header
            buildTableHeader(tableHeader);
            console.log(' After buildTableHeader');
            
            // Build filter row
            buildFilterRow();
            console.log(' After buildFilterRow');

            // Render current page
            renderTablePage(tableBody);
            console.log(' After renderTablePage');
            
            // Setup pagination
            setupPaginationControls();
            console.log(' After setupPaginationControls');
        }

        function buildTableHeader(tableHeader) {
            console.log(' buildTableHeader called, columns:', window.tableState?.columns?.length);
            if (!window.tableState) {
                console.error(' window.tableState is null in buildTableHeader');
                return;
            }
            const html = window.tableState.columns
                .map(col => `<th class="py-3 pr-5 font-normal whitespace-nowrap sm:pr-6">
                    <div class="flex items-center">
                        <p class="text-sm text-gray-500">${col.replace(/_/g, ' ')}</p>
                    </div>
                </th>`)
                .join("");
            tableHeader.innerHTML = html;
            console.log(' buildTableHeader completed, HTML length:', html.length);
        }
        
        // Global search handler
        window.handleGlobalSearch = function(searchTerm) {
            if (!window.tableState) return;
            
            window.tableState.searchTerm = searchTerm.toLowerCase().trim();
            applyTableFilters();
            renderTablePage(document.getElementById('chartDataTableBody'));
            setupPaginationControls();
        };
        
        // Change page size handler
        window.changePageSize = function(newSize) {
            if (!window.tableState) return;
            
            window.tableState.pageSize = newSize;
            window.tableState.currentPage = 1;
            renderTablePage(document.getElementById('chartDataTableBody'));
            setupPaginationControls();
        };

        function buildFilterRow() {
            if (!window.tableState) return;
            
            const filterRow = document.getElementById("chartDataTableFilters");
            if (!filterRow) return;
            
            const { columns, data } = window.tableState;
            
            // Get unique values for each column
            const columnInfo = {};
            columns.forEach(col => {
                const uniqueValues = [...new Set(data.map(row => row[col]))];
                const cleanValues = uniqueValues.filter(v => v !== null && v !== undefined && v !== '');
                
                // Detect column type
                const colLower = col.toLowerCase();
                const isAmountColumn = colLower.includes('amount') || colLower.includes('_os') || colLower.includes('osuc') || 
                colLower.includes('tfa') || colLower.includes('balance') || colLower.includes('exposure');
                const isNumericColumn = isAmountColumn || colLower.includes('rate') || colLower.includes('rotce');
                
                columnInfo[col] = {
                    values: cleanValues.sort().slice(0, 100),
                    isCategorical: cleanValues.length <= 50 && !isNumericColumn
                };
            });
            
            filterRow.innerHTML = columns.map((col, idx) => {
                const info = columnInfo[col];
                
                if (info.isCategorical && info.values.length > 0) {
                    // Dropdown filter for categorical columns
                    return `<th class="px-4 py-2 bg-gray-50">
                        <select onchange="applyColumnFilter('${col}', this.value)" 
                            class="w-full rounded border border-gray-300 px-2 py-1 text-xs focus:border-blue-500">
                            <option value="">All</option>
                            ${info.values.map(v => `<option value="${v}">${v}</option>`).join('')}
                        </select>
                    </th>`;
                } else {
                    // Text search for other columns
                    return `<th class="px-4 py-2 bg-gray-50">
                        <input type="text" placeholder="Filter..." 
                            oninput="applyColumnFilter('${col}', this.value)"
                            class="w-full rounded border border-gray-300 px-2 py-1 text-xs focus:border-blue-500">
                    </th>`;
                }
            }).join("");
        }

        function applyColumnFilter(column, value) {
            if (!window.tableState) return;
            
            if (value === "" || value === null) {
                delete window.tableState.columnFilters[column];
            } else {
                window.tableState.columnFilters[column] = value.toLowerCase();
            }
            
            window.tableState.currentPage = 1;
            applyTableFilters();
            renderTablePage(document.getElementById('chartDataTableBody'));
            setupPaginationControls();
        }

        function applyTableFilters() {
            if (!window.tableState) return;
            
            const { data, columnFilters, searchTerm } = window.tableState;
            
            window.tableState.filteredData = data.filter(row => {
                // Apply global search first
                if (searchTerm && searchTerm.length > 0) {
                    const rowText = Object.values(row).join(' ').toLowerCase();
                    if (!rowText.includes(searchTerm)) {
                        return false;
                    }
                }
                
                // Apply column filters
                for (const [col, filterValue] of Object.entries(columnFilters)) {
                    const cellValue = String(row[col] || '').toLowerCase();
                    if (!cellValue.includes(filterValue)) {
                        return false;
                    }
                }
                return true;
            });
        }
        
        // Generate TFA Expanded View
        function generateTFAExpandedView(dataSource) {
            // Apply all active filters
            const filteredDataSource = applyAllFilters(dataSource);
            
            const totalTfa = filteredDataSource.reduce((sum, row) => sum + parseNumber(row.Fac_Amount || row.Facility_Amount), 0);
            const totalRelationships = new Set(filteredDataSource.map(r => r.Relationship_Name || r.Relationship_ID).filter(Boolean)).size;
            const totalFacilities = new Set(filteredDataSource.map(r => r.Facility_ID).filter(Boolean)).size;
            const avgTfaPerRelationship = totalRelationships > 0 ? totalTfa / totalRelationships : 0;
            
            // Find largest single facility
            let largestFacility = 0;
            dataSource.forEach(row => {
                const amount = parseNumber(row.Fac_Amount || row.Facility_Amount);
                if (amount > largestFacility) largestFacility = amount;
            });
            
            // Calculate concentration (top 10 relationships as % of total)
            const byRelationship = {};
            dataSource.forEach(row => {
                const rel = row.Relationship_Name || row.Relationship_ID || 'Unknown';
                if (!byRelationship[rel]) byRelationship[rel] = 0;
                byRelationship[rel] += parseNumber(row.Fac_Amount || row.Facility_Amount);
            });
            const top10Total = Object.values(byRelationship)
                .sort((a, b) => b - a)
                .slice(0, 10)
                .reduce((sum, val) => sum + val, 0);
            const concentrationPct = totalTfa > 0 ? (top10Total / totalTfa * 100) : 0;
            
            // Group by Client (Relationship)
            const byClient = {};
            dataSource.forEach(row => {
                const client = row.Relationship_Name || row.Relationship_ID || 'Unknown';
                if (!byClient[client]) byClient[client] = 0;
                byClient[client] += parseNumber(row.Fac_Amount || row.Facility_Amount);
            });
            
            // Group by Product Program
            const byProgram = {};
            dataSource.forEach(row => {
                const program = row.Product_Program || 'Unknown';
                if (!byProgram[program]) byProgram[program] = 0;
                byProgram[program] += parseNumber(row.Fac_Amount || row.Facility_Amount);
            });
            
            // Get Top 10 clients
            const topClients = Object.entries(byClient)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            // Get all programs sorted
            const sortedPrograms = Object.entries(byProgram)
                .sort((a, b) => b[1] - a[1]);
            
            // Group by Underwriter for detailed table
            const detailedData = {};
            dataSource.forEach(row => {
                const underwriter = row.Lead_Underwriter || 'Unknown';
                const region = row.Region || 'Unknown';
                
                if (!detailedData[underwriter]) {
                    detailedData[underwriter] = {
                        underwriter,
                        region,
                        tfa: 0,
                        facilities: new Set(),
                        relationships: new Set()
                    };
                }
                
                detailedData[underwriter].tfa += parseNumber(row.Fac_Amount || row.Facility_Amount);
                if (row.Facility_ID) detailedData[underwriter].facilities.add(row.Facility_ID);
                if (row.Relationship_Name || row.Relationship_ID) {
                    detailedData[underwriter].relationships.add(row.Relationship_Name || row.Relationship_ID);
                }
            });
            
            const tableRows = Object.values(detailedData)
                .sort((a, b) => b.tfa - a.tfa)
                .slice(0, 10); // Top 10 underwriters
            
            return `
                <!-- Key Metrics Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="rounded-xl border border-gray-200 bg-white p-5 flex flex-col">
                        <div class="flex items-start gap-3 flex-1">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-blue-100">
                                <svg class="h-5 w-5 shrink-0 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Total TFA</p>
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 text-center mt-3">${formatCurrency(totalTfa)}</h3>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5 flex flex-col">
                        <div class="flex items-start gap-3 flex-1">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-green-100">
                                <svg class="h-5 w-5 shrink-0 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Avg TFA / Relationship</p>
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 text-center mt-3">${formatCurrency(avgTfaPerRelationship)}</h3>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5 flex flex-col">
                        <div class="flex items-start gap-3 flex-1">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-orange-100">
                                <svg class="h-5 w-5 shrink-0 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Largest Facility TFA</p>
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 text-center mt-3">${formatCurrency(largestFacility)}</h3>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5 flex flex-col">
                        <div class="flex items-start gap-3 flex-1">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-purple-100">
                                <svg class="h-5 w-5 shrink-0 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Top 10 Concentration by TFA</p>
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 text-center mt-3">${concentrationPct.toFixed(1)}%</h3>
                    </div>
                </div>
                
                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Regional Distribution Map -->
                    <div class="rounded-xl border border-gray-200 bg-white">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">Regional Distribution</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">TFA distribution by region</p>
                        </div>
                        <div class="p-5">
                            <div class="border-gray-200 my-6 overflow-hidden rounded-2xl border bg-gray-50 px-4 py-6">
                                <div id="tfaRegionalMap" class="map-btn h-[150px] w-full"></div>
                            </div>
                            <div id="tfaRegionalList" class="space-y-5">
                                <!-- Regional items will be dynamically generated -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- TFA by Product Program - Donut Chart with Legends -->
                    <div class="rounded-xl border border-gray-200 bg-white">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">TFA by Product Program</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">Distribution across product programs</p>
                        </div>
                        <div class="p-6 flex items-center justify-center" style="min-height: 400px;">
                            <div class="flex flex-row items-center justify-center gap-8">
                                <!-- Donut Chart -->
                                <div class="flex-shrink-0">
                                    <div id="tfaProgramDonutChart"></div>
                                </div>
                                
                                <!-- Legend / Details List - Right Side -->
                                <div class="flex-1 max-w-md">
                                    <div id="tfaProgramList" class="space-y-3">
                                        ${sortedPrograms.map(([program, amount], index) => {
                                            const colors = ["#3641f5", "#7592ff", "#dde9ff", "#ff6b6b", "#ffd93d", "#6bcf7f", "#c084fc"];
                                            const color = colors[index % colors.length];
                                            // Format amount in billions or millions
                                            const formattedAmount = amount >= 1000000000 
                                                ? `$${(amount / 1000000000).toFixed(2)}B`
                                                : `$${(amount / 1000000).toFixed(1)}M`;
                                            // Calculate percentage
                                            const percentage = ((amount / totalTfa) * 100).toFixed(1);
                                            return `
                                                <div class="flex items-center gap-3 py-2">
                                                    <div class="w-4 h-4 rounded-sm flex-shrink-0" style="background-color: ${color};"></div>
                                                    <p class="text-sm font-medium text-gray-800 flex-1">${program}</p>
                                                    <p class="text-sm font-semibold text-gray-900">${formattedAmount} <span class="text-gray-500 font-normal"> ${percentage}%</span></p>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Table -->
                <div class="rounded-2xl border border-gray-200 bg-white mt-6">
                    <div class="px-6 py-4">
                        <h3 class="text-lg font-semibold text-gray-800">TFA by Underwriter (Top 10)</h3>
                        <p class="text-sm font-medium text-gray-500 mt-1">Underwriter portfolio breakdown</p>
                    </div>
                    <div class="custom-scrollbar overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Underwriter</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Region</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">TFA</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Share %</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Facilities</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Relationships</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${tableRows.map(row => {
                                    const sharePct = totalTfa > 0 ? (row.tfa / totalTfa * 100) : 0;
                                    const regionColors = {
                                        'APAC': 'bg-blue-50 text-blue-600',
                                        'EMEA': 'bg-green-50 text-green-600',
                                        'NAM': 'bg-orange-50 text-orange-600',
                                        'LATAM': 'bg-purple-50 text-purple-600'
                                    };
                                    const regionColor = regionColors[row.region] || 'bg-gray-50 text-gray-600';
                                    
                                    return `
                                        <tr>
                                            <td class="px-6 py-4 text-center text-sm font-medium text-gray-900">${row.underwriter}</td>
                                            <td class="px-6 py-4 text-center">
                                                <span class="${regionColor} rounded-full px-2 py-0.5 text-xs font-medium">
                                                    ${row.region}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 text-center text-sm whitespace-nowrap text-gray-700">${formatCurrency(row.tfa)}</td>
                                            <td class="px-6 py-4 text-center">
                                                <div class="flex items-center justify-center gap-2">
                                                    <div class="flex-1 min-w-[80px] max-w-[120px]">
                                                        <div class="relative w-full h-2 bg-gray-100 rounded-full overflow-hidden">
                                                            <div class="absolute top-0 left-0 h-full bg-blue-500 rounded-full transition-all duration-300" style="width: ${Math.min(sharePct, 100)}%"></div>
                                                        </div>
                                                    </div>
                                                    <span class="text-xs font-semibold text-gray-700 min-w-[40px]">${sharePct.toFixed(1)}%</span>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                <span class="bg-gray-100 text-gray-700 rounded-full px-2 py-0.5 text-xs font-medium">
                                                    ${row.facilities.size}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                <span class="bg-blue-100 text-blue-700 rounded-full px-2 py-0.5 text-xs font-medium">
                                                    ${row.relationships.size}
                                                </span>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        // Initialize charts in expanded views
        function initializeExpandCharts(chartType, dataSource) {
            if (chartType === 'tfa') {
                initializeTFAChart(dataSource);
            } else if (chartType === 'osuc') {
                initializeOSUCChart(dataSource);
            } else if (chartType === 'outstanding') {
                initializeOutstandingChart(dataSource);
            } else if (chartType === 'facilities') {
                initializeFacilitiesChart(dataSource);
            } else if (chartType === 'relationships') {
                initializeRelationshipsChart(dataSource);
            } else if (chartType === 'expiring') {
                initializeExpiringChart(dataSource);
            } else if (chartType === 'newFacilities') {
                initializeNewFacilitiesChart(dataSource);
            } else if (chartType === 'newDealsYTD') {
                initializeNewDealsYTDChart(dataSource);
            } else if (chartType === 'newDealsMTD') {
                initializeNewDealsMTDChart(dataSource);
            } else if (chartType === 'pipeline') {
                initializePipelineChart(dataSource);
            } else if (chartType === 'topRelationships') {
                initializeTopRelationshipsChart(dataSource);
            } else if (chartType === 'rotce') {
                initializeROTCEChart(dataSource);
            } else if (chartType === 'covenantMonitoring' || chartType === 'covenantRegional') {
                initializeCovenantChart(dataSource);
            } else if (chartType === 'ccmRegionalChart') {
                initializeCCMChart(dataSource);
            }
        }
        
        // Initialize TFA Charts
        function initializeTFAChart(dataSource) {
            // 1. Regional Distribution Map
            initializeRegionalMap('tfaRegionalMap', 'tfaRegionalList', dataSource, 'Fac_Amount');
            
            
            // 2. TFA by Product Program - Donut Chart
            const byProgram = {};
            dataSource.forEach(row => {
                const program = row.Product_Program || 'Unknown';
                if (!byProgram[program]) byProgram[program] = 0;
                byProgram[program] += parseNumber(row.Fac_Amount || row.Facility_Amount);
            });
            
            const sortedPrograms = Object.entries(byProgram)
                .sort((a, b) => b[1] - a[1]);
            
            const programLabels = sortedPrograms.map(([name]) => name);
            const programValues = sortedPrograms.map(([, amount]) => amount);
            const totalTfa = programValues.reduce((a, b) => a + b, 0);
            
            // Donut chart colors (matching New Facilities Approved style)
            const donutColors = [
                "#3641f5",  // Primary blue
                "#7592ff",  // Light blue
                "#dde9ff",  // Lighter blue
                "#ff6b6b",  // Red
                "#ffd93d",  // Yellow
                "#6bcf7f",  // Green
                "#c084fc",  // Purple
            ];
            
            // Program Donut Chart Options (matching TailAdmin pie chart style)
            const programChartOptions = {
                series: programValues,
                colors: donutColors.slice(0, programLabels.length),
                labels: programLabels,
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "donut",
                    width: 300,
                    height: 300,
                },
                stroke: {
                    show: false,
                },
                plotOptions: {
                    pie: {
                        donut: {
                            size: "65%",
                            background: "transparent",
                            labels: {
                                show: true,
                                name: {
                                    show: true,
                                    offsetY: -10,
                                    color: "#1D2939",
                                    fontSize: "14px",
                                    fontWeight: "600",
                                },
                                value: {
                                    show: true,
                                    offsetY: 10,
                                    color: "#667085",
                                    fontSize: "16px",
                                    fontWeight: "700",
                                    formatter: (val) => formatCurrency(val),
                                },
                                total: {
                                    show: true,
                                    label: "Total TFA",
                                    color: "#111827",
                                    fontSize: "16px",
                                    fontWeight: "700",
                                    formatter: () => formatCurrency(totalTfa),
                                },
                            },
                        },
                    },
                },
                dataLabels: {
                    enabled: false,
                },
                legend: {
                    show: false, // Hide built-in legend, using custom HTML legend
                },
                tooltip: {
                    enabled: true,
                    theme: "light",
                    followCursor: false,
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        const productName = programLabels[seriesIndex];
                        const tfaAmount = series[seriesIndex];
                        
                        // Calculate facilities count and regional data for this product
                        const regionalDistribution = { NAM: { count: 0, tfa: 0 }, LATAM: { count: 0, tfa: 0 }, EMEA: { count: 0, tfa: 0 }, APAC: { count: 0, tfa: 0 } };
                        let facilitiesCount = 0;
                        const facilityIds = new Set();
                        
                        dataSource.forEach(row => {
                            if ((row.Product_Program || 'Unknown') === productName) {
                                const facilityId = row.Facility_ID;
                                if (facilityId && !facilityIds.has(facilityId)) {
                                    facilityIds.add(facilityId);
                                    facilitiesCount++;
                                }
                                
                                const region = (row.Region || 'Unknown').toUpperCase();
                                const amount = parseNumber(row.Fac_Amount || row.Facility_Amount);
                                
                                if (regionalDistribution[region]) {
                                    regionalDistribution[region].tfa += amount;
                                    if (facilityId && !facilityIds.has(facilityId + '_counted_' + region)) {
                                        regionalDistribution[region].count++;
                                        facilityIds.add(facilityId + '_counted_' + region);
                                    }
                                }
                            }
                        });
                        
                        // Recalculate facility counts per region properly
                        const regionFacilities = { NAM: new Set(), LATAM: new Set(), EMEA: new Set(), APAC: new Set() };
                        dataSource.forEach(row => {
                            if ((row.Product_Program || 'Unknown') === productName) {
                                const region = (row.Region || 'Unknown').toUpperCase();
                                const facilityId = row.Facility_ID;
                                if (facilityId && regionFacilities[region]) {
                                    regionFacilities[region].add(facilityId);
                                }
                            }
                        });
                        
                        // Build regional table rows
                        let regionalRows = '';
                        ['NAM', 'LATAM', 'EMEA', 'APAC'].forEach(region => {
                            const regionData = regionalDistribution[region];
                            const count = regionFacilities[region] ? regionFacilities[region].size : 0;
                            if (count > 0 || regionData.tfa > 0) {
                                regionalRows += `
                                    <tr>
                                        <td style="padding: 6px 8px; text-align: left; font-size: 11px; color: #6B7280; font-weight: 500;">${region}</td>
                                        <td style="padding: 6px 8px; text-align: center; font-size: 11px; color: #111827; font-weight: 600;">${count}</td>
                                        <td style="padding: 6px 8px; text-align: right; font-size: 11px; color: #111827; font-weight: 600;">${formatCurrency(regionData.tfa)}</td>
                                    </tr>
                                `;
                            }
                        });
                        
                        return `
                            <div style="
                                background: #ffffff; 
                                border-radius: 12px; 
                                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
                                min-width: 320px;
                                max-width: 360px;
                                overflow: hidden;
                                font-family: Outfit, sans-serif;
                            ">
                                <!-- Header with border -->
                                <div style="
                                    border-bottom: 1px solid #E5E7EB;
                                    padding: 16px 16px 12px 16px;
                                    margin-bottom: 14px;
                                ">
                                    <div style="
                                        font-weight: 600; 
                                        font-size: 15px; 
                                        color: #111827;
                                        margin-bottom: 4px;
                                    ">${productName}</div>
                                    <div style="
                                        font-size: 12px; 
                                        font-weight: 500;
                                        color: #6B7280;
                                    ">Product Program</div>
                                </div>
                                
                                <!-- Content wrapper -->
                                <div style="padding: 0 16px 16px 16px;">
                                    <!-- Widget Grid (2 columns) -->
                                    <div style="
                                        display: grid;
                                        grid-template-columns: 1fr 1fr;
                                        gap: 10px;
                                        margin-bottom: 16px;
                                    ">
                                        <!-- Widget 1: Facilities Count -->
                                        <div style="
                                            background: #F9FAFB;
                                            border-radius: 8px;
                                            padding: 12px;
                                            border: 1px solid #E5E7EB;
                                        ">
                                            <div style="
                                                display: flex;
                                                align-items: center;
                                                gap: 6px;
                                                font-size: 11px;
                                                color: #6B7280;
                                                font-weight: 500;
                                                margin-bottom: 6px;
                                            ">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                                </svg>
                                                Facilities
                                            </div>
                                            <div style="
                                                font-size: 20px;
                                                font-weight: 700;
                                                color: #111827;
                                            ">${facilitiesCount}</div>
                                        </div>
                                        
                                        <!-- Widget 2: TFA -->
                                        <div style="
                                            background: #F9FAFB;
                                            border-radius: 8px;
                                            padding: 12px;
                                            border: 1px solid #E5E7EB;
                                        ">
                                            <div style="
                                                display: flex;
                                                align-items: center;
                                                gap: 6px;
                                                font-size: 11px;
                                                color: #6B7280;
                                                font-weight: 500;
                                                margin-bottom: 6px;
                                            ">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <line x1="12" y1="1" x2="12" y2="23"></line>
                                                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                                </svg>
                                                TFA
                                            </div>
                                            <div style="
                                                font-size: 14px;
                                                font-weight: 700;
                                                color: #111827;
                                            ">${formatCurrency(tfaAmount)}</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Regional Distribution Table -->
                                    <div style="margin-top: 12px;">
                                        <div style="
                                            display: flex;
                                            align-items: center;
                                            gap: 6px;
                                            margin-bottom: 8px;
                                        ">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                            </svg>
                                            <span style="
                                                font-size: 12px;
                                                font-weight: 600;
                                                color: #374151;
                                            ">Regional Distribution</span>
                                        </div>
                                        <table style="width: 100%; border-collapse: collapse;">
                                            <thead>
                                                <tr style="border-bottom: 1px solid #E5E7EB;">
                                                    <th style="padding: 6px 8px; text-align: left; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Region</th>
                                                    <th style="padding: 6px 8px; text-align: center; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Count</th>
                                                    <th style="padding: 6px 8px; text-align: right; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">TFA</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${regionalRows || '<tr><td colspan="3" style="padding: 8px; text-align: center; font-size: 11px; color: #9CA3AF;">No data</td></tr>'}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                },
            };
            
            // Render donut chart
            const programDonutChartEl = document.getElementById('tfaProgramDonutChart');
            
            if (programDonutChartEl && typeof ApexCharts !== 'undefined') {
                const programDonutChart = new ApexCharts(programDonutChartEl, programChartOptions);
                programDonutChart.render();
                
                // Add tooltip positioning fix
                setTimeout(() => {
                    const tooltipObserver = new MutationObserver(() => {
                        const tooltip = programDonutChartEl.querySelector('.apexcharts-tooltip.apexcharts-active');
                        if (tooltip && !tooltip.hasAttribute('data-positioned')) {
                            const tooltipRect = tooltip.getBoundingClientRect();
                            const windowWidth = window.innerWidth;
                            const windowHeight = window.innerHeight;
                            const margin = 10;
                            
                            let needsReposition = false;
                            
                            if (tooltipRect.left < margin) {
                                tooltip.style.left = margin + 'px';
                                tooltip.style.transform = 'none';
                                needsReposition = true;
                            } else if (tooltipRect.right > windowWidth - margin) {
                                tooltip.style.left = (windowWidth - tooltipRect.width - margin) + 'px';
                                tooltip.style.transform = 'none';
                                needsReposition = true;
                            }
                            
                            if (tooltipRect.top < margin) {
                                tooltip.style.top = margin + 'px';
                                needsReposition = true;
                            } else if (tooltipRect.bottom > windowHeight - margin) {
                                tooltip.style.top = (windowHeight - tooltipRect.height - margin) + 'px';
                                needsReposition = true;
                            }
                            
                            if (needsReposition) {
                                tooltip.setAttribute('data-positioned', 'true');
                            }
                        }
                        
                        const hiddenTooltip = programDonutChartEl.querySelector('.apexcharts-tooltip:not(.apexcharts-active)[data-positioned]');
                        if (hiddenTooltip) {
                            hiddenTooltip.removeAttribute('data-positioned');
                        }
                    });
                    
                    tooltipObserver.observe(programDonutChartEl, {
                        attributes: true,
                        attributeFilter: ['class'],
                        subtree: true
                    });
                }, 200);
            }
        }
        
        // Initialize OSUC Charts
        function initializeOSUCChart(dataSource) {
            // 1. Regional Distribution Map
            initializeRegionalMap('osucRegionalMap', 'osucRegionalList', dataSource, 'OSUC');
            
            // 2. OSUC by Product Program - Donut Chart
            const osucByProgram = {};
            dataSource.forEach(row => {
                const program = row.Product_Program || 'Unknown';
                if (!osucByProgram[program]) osucByProgram[program] = 0;
                osucByProgram[program] += parseNumber(row.OSUC);
            });
            
            const osucSortedPrograms = Object.entries(osucByProgram)
                .sort((a, b) => b[1] - a[1]);
            
            const osucProgramLabels = osucSortedPrograms.map(([name]) => name);
            const osucProgramValues = osucSortedPrograms.map(([, amount]) => amount);
            const osucTotal = osucProgramValues.reduce((a, b) => a + b, 0);
            
            // Donut chart colors (matching TFA style)
            const donutColors = [
                "#3641f5",  // Primary blue
                "#7592ff",  // Light blue
                "#dde9ff",  // Lighter blue
                "#ff6b6b",  // Red
                "#ffd93d",  // Yellow
                "#6bcf7f",  // Green
                "#c084fc",  // Purple
            ];
            
            // Program Donut Chart Options (matching TFA style)
            const programChartOptions = {
                series: osucProgramValues,
                colors: donutColors.slice(0, osucProgramLabels.length),
                labels: osucProgramLabels,
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "donut",
                    width: 300,
                    height: 300,
                },
                stroke: {
                    show: false,
                },
                plotOptions: {
                    pie: {
                        donut: {
                            size: "65%",
                            background: "transparent",
                            labels: {
                                show: true,
                                name: {
                                    show: true,
                                    offsetY: -10,
                                    color: "#1D2939",
                                    fontSize: "14px",
                                    fontWeight: "600",
                                },
                                value: {
                                    show: true,
                                    offsetY: 10,
                                    color: "#667085",
                                    fontSize: "16px",
                                    fontWeight: "700",
                                    formatter: (val) => formatCurrency(val),
                                },
                                total: {
                                    show: true,
                                    label: "Total OSUC",
                                    color: "#1D2939",
                                    fontSize: "14px",
                                    fontWeight: "600",
                                    formatter: () => formatCurrency(osucTotal),
                                },
                            },
                        },
                    },
                },
                dataLabels: {
                    enabled: false,
                },
                legend: {
                    show: false, // We use custom legend in HTML
                },
                tooltip: {
                    theme: "light",
                    followCursor: false,
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        const productName = osucProgramLabels[seriesIndex];
                        const osucAmount = series[seriesIndex];
                        
                        // Calculate facilities count and regional data for this product
                        const regionalDistribution = { NAM: { count: 0, osuc: 0 }, LATAM: { count: 0, osuc: 0 }, EMEA: { count: 0, osuc: 0 }, APAC: { count: 0, osuc: 0 } };
                        let facilitiesCount = 0;
                        const facilityIds = new Set();
                        const regionFacilities = { NAM: new Set(), LATAM: new Set(), EMEA: new Set(), APAC: new Set() };
                        
                        dataSource.forEach(row => {
                            if ((row.Product_Program || 'Unknown') === productName) {
                                const facilityId = row.Facility_ID;
                                if (facilityId && !facilityIds.has(facilityId)) {
                                    facilityIds.add(facilityId);
                                    facilitiesCount++;
                                }
                                
                                const region = (row.Region || 'Unknown').toUpperCase();
                                const amount = parseNumber(row.OSUC);
                                
                                if (regionalDistribution[region]) {
                                    regionalDistribution[region].osuc += amount;
                                    if (facilityId && regionFacilities[region]) {
                                        regionFacilities[region].add(facilityId);
                                    }
                                }
                            }
                        });
                        
                        // Build regional table rows
                        let regionalRows = '';
                        ['NAM', 'LATAM', 'EMEA', 'APAC'].forEach(region => {
                            const regionData = regionalDistribution[region];
                            const count = regionFacilities[region] ? regionFacilities[region].size : 0;
                            if (count > 0 || regionData.osuc > 0) {
                                regionalRows += `
                                    <tr>
                                        <td style="padding: 6px 8px; text-align: left; font-size: 11px; color: #6B7280; font-weight: 500;">${region}</td>
                                        <td style="padding: 6px 8px; text-align: center; font-size: 11px; color: #111827; font-weight: 600;">${count}</td>
                                        <td style="padding: 6px 8px; text-align: right; font-size: 11px; color: #111827; font-weight: 600;">${formatCurrency(regionData.osuc)}</td>
                                    </tr>
                                `;
                            }
                        });
                        
                        return `
                            <div style="
                                background: #ffffff; 
                                border-radius: 12px; 
                                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
                                min-width: 320px;
                                max-width: 360px;
                                overflow: hidden;
                                font-family: Outfit, sans-serif;
                            ">
                                <!-- Header with border -->
                                <div style="
                                    border-bottom: 1px solid #E5E7EB;
                                    padding: 16px 16px 12px 16px;
                                    margin-bottom: 14px;
                                ">
                                    <div style="
                                        font-weight: 600; 
                                        font-size: 15px; 
                                        color: #111827;
                                        margin-bottom: 4px;
                                    ">${productName}</div>
                                    <div style="
                                        font-size: 12px; 
                                        font-weight: 500;
                                        color: #6B7280;
                                    ">Product Program</div>
                                </div>
                                
                                <!-- Content wrapper -->
                                <div style="padding: 0 16px 16px 16px;">
                                    <!-- Widget Grid (2 columns) -->
                                    <div style="
                                        display: grid;
                                        grid-template-columns: 1fr 1fr;
                                        gap: 10px;
                                        margin-bottom: 16px;
                                    ">
                                        <!-- Widget 1: Facilities Count -->
                                        <div style="
                                            background: #F9FAFB;
                                            border-radius: 8px;
                                            padding: 12px;
                                            border: 1px solid #E5E7EB;
                                        ">
                                            <div style="
                                                display: flex;
                                                align-items: center;
                                                gap: 6px;
                                                font-size: 11px;
                                                color: #6B7280;
                                                font-weight: 500;
                                                margin-bottom: 6px;
                                            ">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                                </svg>
                                                Facilities
                                            </div>
                                            <div style="
                                                font-size: 20px;
                                                font-weight: 700;
                                                color: #111827;
                                            ">${facilitiesCount}</div>
                                        </div>
                                        
                                        <!-- Widget 2: OSUC -->
                                        <div style="
                                            background: #F9FAFB;
                                            border-radius: 8px;
                                            padding: 12px;
                                            border: 1px solid #E5E7EB;
                                        ">
                                            <div style="
                                                display: flex;
                                                align-items: center;
                                                gap: 6px;
                                                font-size: 11px;
                                                color: #6B7280;
                                                font-weight: 500;
                                                margin-bottom: 6px;
                                            ">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <line x1="12" y1="1" x2="12" y2="23"></line>
                                                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                                </svg>
                                                OSUC
                                            </div>
                                            <div style="
                                                font-size: 14px;
                                                font-weight: 700;
                                                color: #111827;
                                            ">${formatCurrency(osucAmount)}</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Regional Distribution Table -->
                                    <div style="margin-top: 12px;">
                                        <div style="
                                            display: flex;
                                            align-items: center;
                                            gap: 6px;
                                            margin-bottom: 8px;
                                        ">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                            </svg>
                                            <span style="
                                                font-size: 12px;
                                                font-weight: 600;
                                                color: #374151;
                                            ">Regional Distribution</span>
                                        </div>
                                        <table style="width: 100%; border-collapse: collapse;">
                                            <thead>
                                                <tr style="border-bottom: 1px solid #E5E7EB;">
                                                    <th style="padding: 6px 8px; text-align: left; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Region</th>
                                                    <th style="padding: 6px 8px; text-align: center; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Count</th>
                                                    <th style="padding: 6px 8px; text-align: right; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">OSUC</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${regionalRows || '<tr><td colspan="3" style="padding: 8px; text-align: center; font-size: 11px; color: #9CA3AF;">No data</td></tr>'}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                },
            };
            
            // Render donut chart
            const programChartEl = document.getElementById('osucProgramDonutChart');
            
            if (programChartEl && typeof ApexCharts !== 'undefined') {
                const programChart = new ApexCharts(programChartEl, programChartOptions);
                programChart.render();
                
                // Add tooltip positioning fix
                setTimeout(() => {
                    const tooltipObserver = new MutationObserver(() => {
                        const tooltip = programChartEl.querySelector('.apexcharts-tooltip.apexcharts-active');
                        if (tooltip && !tooltip.hasAttribute('data-positioned')) {
                            const tooltipRect = tooltip.getBoundingClientRect();
                            const windowWidth = window.innerWidth;
                            const windowHeight = window.innerHeight;
                            const margin = 10;
                            
                            let needsReposition = false;
                            
                            if (tooltipRect.left < margin) {
                                tooltip.style.left = margin + 'px';
                                tooltip.style.transform = 'none';
                                needsReposition = true;
                            } else if (tooltipRect.right > windowWidth - margin) {
                                tooltip.style.left = (windowWidth - tooltipRect.width - margin) + 'px';
                                tooltip.style.transform = 'none';
                                needsReposition = true;
                            }
                            
                            if (tooltipRect.top < margin) {
                                tooltip.style.top = margin + 'px';
                                needsReposition = true;
                            } else if (tooltipRect.bottom > windowHeight - margin) {
                                tooltip.style.top = (windowHeight - tooltipRect.height - margin) + 'px';
                                needsReposition = true;
                            }
                            
                            if (needsReposition) {
                                tooltip.setAttribute('data-positioned', 'true');
                            }
                        }
                        
                        const hiddenTooltip = programChartEl.querySelector('.apexcharts-tooltip:not(.apexcharts-active)[data-positioned]');
                        if (hiddenTooltip) {
                            hiddenTooltip.removeAttribute('data-positioned');
                        }
                    });
                    
                    tooltipObserver.observe(programChartEl, {
                        attributes: true,
                        attributeFilter: ['class'],
                        subtree: true
                    });
                }, 200);
            }
        }
        
        // Initialize Outstanding Charts
        function initializeOutstandingChart(dataSource) {
            // 1. Regional Distribution Map
            initializeRegionalMap('outstandingRegionalMap', 'outstandingRegionalList', dataSource, 'Total_OS');
            
            // 2. Outstanding by Product Program - Donut Chart (matching TFA style)
            const byProgram = {};
            dataSource.forEach(row => {
                const program = row.Product_Program || 'Unknown';
                if (!byProgram[program]) byProgram[program] = 0;
                byProgram[program] += parseNumber(row.Total_OS);
            });
            
            const sortedPrograms = Object.entries(byProgram)
                .sort((a, b) => b[1] - a[1]);
            
            const programLabels = sortedPrograms.map(([name]) => name);
            const programValues = sortedPrograms.map(([, amount]) => amount);
            const totalOS = programValues.reduce((a, b) => a + b, 0);
            
            // Donut chart colors (matching TFA style)
            const donutColors = [
                "#3641f5",  // Primary blue
                "#7592ff",  // Light blue
                "#dde9ff",  // Lighter blue
                "#ff6b6b",  // Red
                "#ffd93d",  // Yellow
                "#6bcf7f",  // Green
                "#c084fc",  // Purple
            ];
            
            // Program Donut Chart Options (matching TFA style)
            const programChartOptions = {
                series: programValues,
                colors: donutColors.slice(0, programLabels.length),
                labels: programLabels,
                chart: {
                    fontFamily: "Outfit, sans-serif",
                    type: "donut",
                    width: 300,
                    height: 300,
                },
                stroke: {
                    show: false,
                },
                plotOptions: {
                    pie: {
                        donut: {
                            size: "65%",
                            background: "transparent",
                            labels: {
                                show: true,
                                name: {
                                    show: true,
                                    offsetY: -10,
                                    color: "#1D2939",
                                    fontSize: "14px",
                                    fontWeight: "600",
                                },
                                value: {
                                    show: true,
                                    offsetY: 10,
                                    color: "#667085",
                                    fontSize: "16px",
                                    fontWeight: "700",
                                    formatter: (val) => formatCurrency(val),
                                },
                                total: {
                                    show: true,
                                    label: "Total Outstanding",
                                    color: "#1D2939",
                                    fontSize: "14px",
                                    fontWeight: "600",
                                    formatter: () => formatCurrency(totalOS),
                                },
                            },
                        },
                    },
                },
                dataLabels: {
                    enabled: false,
                },
                legend: {
                    show: false, // We use custom legend in HTML
                },
                tooltip: {
                    theme: "light",
                    followCursor: false,
                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                        const productName = programLabels[seriesIndex];
                        const outstandingAmount = series[seriesIndex];
                        
                        // Calculate facilities count and regional data for this product
                        const regionalDistribution = { NAM: { count: 0, outstanding: 0 }, LATAM: { count: 0, outstanding: 0 }, EMEA: { count: 0, outstanding: 0 }, APAC: { count: 0, outstanding: 0 } };
                        let facilitiesCount = 0;
                        const facilityIds = new Set();
                        const regionFacilities = { NAM: new Set(), LATAM: new Set(), EMEA: new Set(), APAC: new Set() };
                        
                        dataSource.forEach(row => {
                            if ((row.Product_Program || 'Unknown') === productName) {
                                const facilityId = row.Facility_ID;
                                if (facilityId && !facilityIds.has(facilityId)) {
                                    facilityIds.add(facilityId);
                                    facilitiesCount++;
                                }
                                
                                const region = (row.Region || 'Unknown').toUpperCase();
                                const amount = parseNumber(row.Total_OS);
                                
                                if (regionalDistribution[region]) {
                                    regionalDistribution[region].outstanding += amount;
                                    if (facilityId && regionFacilities[region]) {
                                        regionFacilities[region].add(facilityId);
                                    }
                                }
                            }
                        });
                        
                        // Build regional table rows
                        let regionalRows = '';
                        ['NAM', 'LATAM', 'EMEA', 'APAC'].forEach(region => {
                            const regionData = regionalDistribution[region];
                            const count = regionFacilities[region] ? regionFacilities[region].size : 0;
                            if (count > 0 || regionData.outstanding > 0) {
                                regionalRows += `
                                    <tr>
                                        <td style="padding: 6px 8px; text-align: left; font-size: 11px; color: #6B7280; font-weight: 500;">${region}</td>
                                        <td style="padding: 6px 8px; text-align: center; font-size: 11px; color: #111827; font-weight: 600;">${count}</td>
                                        <td style="padding: 6px 8px; text-align: right; font-size: 11px; color: #111827; font-weight: 600;">${formatCurrency(regionData.outstanding)}</td>
                                    </tr>
                                `;
                            }
                        });
                        
                        return `
                            <div style="
                                background: #ffffff; 
                                border-radius: 12px; 
                                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
                                min-width: 320px;
                                max-width: 360px;
                                overflow: hidden;
                                font-family: Outfit, sans-serif;
                            ">
                                <!-- Header with border -->
                                <div style="
                                    border-bottom: 1px solid #E5E7EB;
                                    padding: 16px 16px 12px 16px;
                                    margin-bottom: 14px;
                                ">
                                    <div style="
                                        font-weight: 600; 
                                        font-size: 15px; 
                                        color: #111827;
                                        margin-bottom: 4px;
                                    ">${productName}</div>
                                    <div style="
                                        font-size: 12px; 
                                        font-weight: 500;
                                        color: #6B7280;
                                    ">Product Program</div>
                                </div>
                                
                                <!-- Content wrapper -->
                                <div style="padding: 0 16px 16px 16px;">
                                    <!-- Widget Grid (2 columns) -->
                                    <div style="
                                        display: grid;
                                        grid-template-columns: 1fr 1fr;
                                        gap: 10px;
                                        margin-bottom: 16px;
                                    ">
                                        <!-- Widget 1: Facilities Count -->
                                        <div style="
                                            background: #F9FAFB;
                                            border-radius: 8px;
                                            padding: 12px;
                                            border: 1px solid #E5E7EB;
                                        ">
                                            <div style="
                                                display: flex;
                                                align-items: center;
                                                gap: 6px;
                                                font-size: 11px;
                                                color: #6B7280;
                                                font-weight: 500;
                                                margin-bottom: 6px;
                                            ">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                                </svg>
                                                Facilities
                                            </div>
                                            <div style="
                                                font-size: 20px;
                                                font-weight: 700;
                                                color: #111827;
                                            ">${facilitiesCount}</div>
                                        </div>
                                        
                                        <!-- Widget 2: Outstanding -->
                                        <div style="
                                            background: #F9FAFB;
                                            border-radius: 8px;
                                            padding: 12px;
                                            border: 1px solid #E5E7EB;
                                        ">
                                            <div style="
                                                display: flex;
                                                align-items: center;
                                                gap: 6px;
                                                font-size: 11px;
                                                color: #6B7280;
                                                font-weight: 500;
                                                margin-bottom: 6px;
                                            ">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <line x1="12" y1="1" x2="12" y2="23"></line>
                                                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                                </svg>
                                                Outstanding
                                            </div>
                                            <div style="
                                                font-size: 14px;
                                                font-weight: 700;
                                                color: #111827;
                                            ">${formatCurrency(outstandingAmount)}</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Regional Distribution Table -->
                                    <div style="margin-top: 12px;">
                                        <div style="
                                            display: flex;
                                            align-items: center;
                                            gap: 6px;
                                            margin-bottom: 8px;
                                        ">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                            </svg>
                                            <span style="
                                                font-size: 12px;
                                                font-weight: 600;
                                                color: #374151;
                                            ">Regional Distribution</span>
                                        </div>
                                        <table style="width: 100%; border-collapse: collapse;">
                                            <thead>
                                                <tr style="border-bottom: 1px solid #E5E7EB;">
                                                    <th style="padding: 6px 8px; text-align: left; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Region</th>
                                                    <th style="padding: 6px 8px; text-align: center; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Count</th>
                                                    <th style="padding: 6px 8px; text-align: right; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Outstanding</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${regionalRows || '<tr><td colspan="3" style="padding: 8px; text-align: center; font-size: 11px; color: #9CA3AF;">No data</td></tr>'}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                },
            };
            
            // Render donut chart
            const programChartEl = document.getElementById('outstandingProgramDonutChart');
            
            if (programChartEl && typeof ApexCharts !== 'undefined') {
                const programChart = new ApexCharts(programChartEl, programChartOptions);
                programChart.render();
                
                // Add tooltip positioning fix
                setTimeout(() => {
                    const tooltipObserver = new MutationObserver(() => {
                        const tooltip = programChartEl.querySelector('.apexcharts-tooltip.apexcharts-active');
                        if (tooltip && !tooltip.hasAttribute('data-positioned')) {
                            const tooltipRect = tooltip.getBoundingClientRect();
                            const windowWidth = window.innerWidth;
                            const windowHeight = window.innerHeight;
                            const margin = 10;
                            
                            let needsReposition = false;
                            
                            if (tooltipRect.left < margin) {
                                tooltip.style.left = margin + 'px';
                                tooltip.style.transform = 'none';
                                needsReposition = true;
                            } else if (tooltipRect.right > windowWidth - margin) {
                                tooltip.style.left = (windowWidth - tooltipRect.width - margin) + 'px';
                                tooltip.style.transform = 'none';
                                needsReposition = true;
                            }
                            
                            if (tooltipRect.top < margin) {
                                tooltip.style.top = margin + 'px';
                                needsReposition = true;
                            } else if (tooltipRect.bottom > windowHeight - margin) {
                                tooltip.style.top = (windowHeight - tooltipRect.height - margin) + 'px';
                                needsReposition = true;
                            }
                            
                            if (needsReposition) {
                                tooltip.setAttribute('data-positioned', 'true');
                            }
                        }
                        
                        const hiddenTooltip = programChartEl.querySelector('.apexcharts-tooltip:not(.apexcharts-active)[data-positioned]');
                        if (hiddenTooltip) {
                            hiddenTooltip.removeAttribute('data-positioned');
                        }
                    });
                    
                    tooltipObserver.observe(programChartEl, {
                        attributes: true,
                        attributeFilter: ['class'],
                        subtree: true
                    });
                }, 200);
            }
        }
        
        // Initialize Facilities Charts
        function initializeFacilitiesChart(dataSource) {
            // 1. Facilities by Region - Stacked Bar (Committed vs Uncommitted)
            const regions = ['APAC', 'EMEA', 'NAM', 'LATAM'];
            const committedData = [];
            const uncommittedData = [];
            
            regions.forEach(region => {
                const regionData = dataSource.filter(row => (row.Region || '').toUpperCase() === region);
                const committed = regionData.filter(row => 
                    (row.Committed_Uncommitted || '').toUpperCase() === 'COMMITTED'
                ).length;
                const uncommitted = regionData.filter(row => 
                    (row.Committed_Uncommitted || '').toUpperCase() === 'UNCOMMITTED'
                ).length;
                
                committedData.push(committed);
                uncommittedData.push(uncommitted);
            });
            
            const regionChartOptions = {
                series: [{
                    name: 'Committed',
                    data: committedData
                }, {
                    name: 'Uncommitted',
                    data: uncommittedData
                }],
                chart: {
                    type: 'bar',
                    height: 300,
                    stacked: true,
                    toolbar: {
                        show: false
                    },
                    fontFamily: "Outfit, sans-serif"
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        borderRadius: 8,
                        borderRadiusApplication: 'end',
                        columnWidth: '60%'
                    }
                },
                colors: ['#22c55e', '#f59e0b'],
                xaxis: {
                    categories: regions,
                    labels: {
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif"
                        }
                    }
                },
                yaxis: {
                    labels: {
                        formatter: function (val) {
                            return Math.round(val);
                        },
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif"
                        }
                    }
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'left',
                    fontFamily: "Outfit, sans-serif",
                    fontSize: "12px",
                    markers: {
                        radius: 12,
                    },
                },
                dataLabels: {
                    enabled: false
                },
                grid: {
                    borderColor: "#E5E7EB",
                    strokeDashArray: 4,
                    xaxis: {
                        lines: {
                            show: false
                        }
                    },
                    yaxis: {
                        lines: {
                            show: true
                        }
                    }
                },
                tooltip: {
                    theme: "light",
                    y: {
                        formatter: function (val) {
                            return val + ' facilities';
                        }
                    }
                }
            };
            
            // 2. Top Facility Types - Horizontal Bar Chart
            const byType = {};
            dataSource.forEach(row => {
                const type = row.Facility_Type || 'Unknown';
                if (!byType[type]) {
                    byType[type] = 0;
                }
                byType[type]++;
            });
            
            const topTypes = Object.entries(byType)
                .map(([type, count]) => ({ type, count }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);
            
            const typeChartOptions = {
                series: [{
                    name: 'Facilities',
                    data: topTypes.map(item => item.count)
                }],
                chart: {
                    type: 'bar',
                    height: 300,
                    toolbar: {
                        show: false
                    },
                    fontFamily: "Outfit, sans-serif"
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        borderRadius: 4,
                        dataLabels: {
                            position: "top"
                        }
                    }
                },
                colors: ['#3b82f6'],
                dataLabels: {
                    enabled: true,
                    offsetX: 30,
                    style: {
                        fontSize: "11px",
                        fontWeight: 500,
                        colors: ['#374151'],
                        fontFamily: "Outfit, sans-serif"
                    },
                    background: {
                        enabled: true,
                        foreColor: '#374151',
                        backgroundColor: '#F3F4F6',
                        borderRadius: 12,
                        padding: 8,
                        opacity: 1,
                        borderWidth: 0
                    },
                    formatter: function(val) {
                        return val;
                    }
                },
                xaxis: {
                    categories: topTypes.map(item => item.type),
                    labels: {
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif"
                        }
                    }
                },
                yaxis: {
                    labels: {
                        align: 'left',
                        style: {
                            colors: "#6B7280",
                            fontSize: "11px",
                            fontFamily: "Outfit, sans-serif"
                        },
                        formatter: function(val, opts) {
                            // opts.dataPointIndex gives us the index for ranking
                            const index = opts && opts.dataPointIndex !== undefined ? opts.dataPointIndex : 0;
                            return (index + 1) + '. ' + val;
                        }
                    }
                },
                grid: {
                    borderColor: "#E5E7EB",
                    strokeDashArray: 4,
                    xaxis: {
                        lines: {
                            show: true  // Show vertical grid lines
                        }
                    },
                    yaxis: {
                        lines: {
                            show: false  // Hide horizontal grid lines
                        }
                    }
                },
                tooltip: {
                    theme: "light",
                    y: {
                        formatter: function (val) {
                            return val + ' facilities';
                        }
                    }
                }
            };
            
            // Render both charts
            const regionChartEl = document.getElementById('facilitiesRegionChart');
            const typeChartEl = document.getElementById('facilitiesTypeChart');
            
            if (regionChartEl && typeof ApexCharts !== 'undefined') {
                const regionChart = new ApexCharts(regionChartEl, regionChartOptions);
                regionChart.render();
            }
            
            if (typeChartEl && typeof ApexCharts !== 'undefined') {
                const typeChart = new ApexCharts(typeChartEl, typeChartOptions);
                typeChart.render();
            }
        }
        
        // Initialize Relationships Charts
        function initializeRelationshipsChart(dataSource) {
            // Count unique relationships by region
            const regions = ['APAC', 'EMEA', 'NAM', 'LATAM'];
            const byRegion = {};
            
            regions.forEach(region => {
                byRegion[region] = new Set();
            });
            
            dataSource.forEach(row => {
                const region = (row.Region || '').toUpperCase();
                const relId = row.Relationship_ID;
                if (regions.includes(region) && relId) {
                    byRegion[region].add(relId);
                }
            });
            
            const regionData = regions.map(region => byRegion[region].size);
            
            const regionChartOptions = {
                series: [{
                    name: 'Relationships',
                    data: regionData
                }],
                chart: {
                    type: 'bar',
                    height: 300,
                    toolbar: {
                        show: false
                    },
                    fontFamily: "Outfit, sans-serif"
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        borderRadius: 8,
                        borderRadiusApplication: 'end',
                        columnWidth: '60%',
                        dataLabels: {
                            position: "top"
                        }
                    }
                },
                colors: ['#3b82f6'],
                dataLabels: {
                    enabled: true,
                    offsetY: -30,
                    style: {
                        fontSize: "11px",
                        fontWeight: 500,
                        colors: ['#374151'],
                        fontFamily: "Outfit, sans-serif"
                    },
                    background: {
                        enabled: true,
                        foreColor: '#374151',
                        backgroundColor: '#F3F4F6',
                        borderRadius: 12,
                        padding: 8,
                        opacity: 1,
                        borderWidth: 0
                    },
                    formatter: function(val) {
                        return val;
                    }
                },
                xaxis: {
                    categories: regions,
                    labels: {
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif"
                        }
                    }
                },
                yaxis: {
                    labels: {
                        formatter: function (val) {
                            return Math.round(val);
                        },
                        style: {
                            colors: "#6B7280",
                            fontSize: "12px",
                            fontFamily: "Outfit, sans-serif"
                        }
                    }
                },
                grid: {
                    borderColor: "#E5E7EB",
                    strokeDashArray: 4
                },
                tooltip: {
                    theme: "light",
                    y: {
                        formatter: function (val) {
                            return val + ' relationships';
                        }
                    }
                }
            };
            
            // Render chart
            const regionChartEl = document.getElementById('relationshipsRegionChart');
            
            if (regionChartEl && typeof ApexCharts !== 'undefined') {
                const regionChart = new ApexCharts(regionChartEl, regionChartOptions);
                regionChart.render();
            }
        }
        
        // Initialize New Facilities Chart
        function initializeNewFacilitiesChart(dataSource) {
            console.log(' initializeNewFacilitiesChart called with', dataSource.length, 'rows');
            const period = selectedPeriod || 'current';
            console.log(' Period:', period);
            
            // Initialize empty data structures
            const regionalData = { APAC: {count: 0, tfa: 0}, EMEA: {count: 0, tfa: 0}, NAM: {count: 0, tfa: 0}, LATAM: {count: 0, tfa: 0} };
            const topProducts = [];
            const topFacilities = [];
            const underwriterDeals = {};
            
            // Find the most recent Report_Date
            let mostRecentReportDate = null;
            for (let i = 0; i < dataSource.length; i++) {
                const reportDate = parseDate(dataSource[i].Report_Date);
                if (reportDate && (!mostRecentReportDate || reportDate > mostRecentReportDate)) {
                    mostRecentReportDate = reportDate;
                }
            }
            console.log(' Most recent report date:', mostRecentReportDate);
            
            // Only process data if we have a report date
            if (mostRecentReportDate) {
                // Calculate date range based on period
                let targetStartDate, targetEndDate;
                if (period === "current") {
                    targetStartDate = new Date(mostRecentReportDate.getFullYear(), mostRecentReportDate.getMonth(), 1);
                    targetStartDate.setHours(0, 0, 0, 0);
                    targetEndDate = new Date(mostRecentReportDate.getFullYear(), mostRecentReportDate.getMonth() + 1, 0);
                    targetEndDate.setHours(23, 59, 59, 999);
                } else {
                    targetStartDate = new Date(mostRecentReportDate.getFullYear(), mostRecentReportDate.getMonth() - 1, 1);
                    targetStartDate.setHours(0, 0, 0, 0);
                    targetEndDate = new Date(mostRecentReportDate.getFullYear(), mostRecentReportDate.getMonth(), 0);
                    targetEndDate.setHours(23, 59, 59, 999);
                }
                
                console.log(' Date range:', {
                    start: targetStartDate.toLocaleDateString(),
                    end: targetEndDate.toLocaleDateString()
                });
                
                // Collect data
                const productData = {};
                const facilitiesData = [];
                const newFacilities = new Set();
                
                let facilitiesWithApprovalDate = 0;
                let facilitiesInDateRange = 0;
                
                dataSource.forEach(row => {
                    const region = (row.Region || "Unknown").toUpperCase();
                    const product = row.Product_Program || "Unknown";
                    const underwriter = row.Lead_Underwriter || "Unknown";
                    const facilityId = row.Facility_ID;
                    const relationship = row.Relationship_Name || row.Relationship_ID || "Unknown";
                    
                    // NAM, LATAM, EMEA use Facility_First_Approval_Date
                    // APAC has different logic (not included in new facilities count)
                    let approvalDate = null;
                    if (region === "NAM" || region === "LATAM" || region === "EMEA") {
                        approvalDate = parseDate(row.Facility_First_Approval_Date);
                    }
                    // APAC is excluded (empty/different logic)
                    
                    // Debug: count facilities with approval dates
                    if (approvalDate) {
                        facilitiesWithApprovalDate++;
                    }
                    
                    if (!facilityId) return;
                    
                    if (approvalDate && approvalDate >= targetStartDate && approvalDate <= targetEndDate) {
                        facilitiesInDateRange++;
                        if (!newFacilities.has(facilityId)) {
                            newFacilities.add(facilityId);
                            const amount = parseNumber(row.Fac_Amount || row.Facility_Amount);
                            
                            // Regional data
                            if (!regionalData[region]) regionalData[region] = {count: 0, tfa: 0};
                            regionalData[region].count++;
                            regionalData[region].tfa += amount;
                            
                            // Product data
                            if (!productData[product]) productData[product] = { count: 0, tfa: 0 };
                            productData[product].count++;
                            productData[product].tfa += amount;
                            
                            // Underwriter deals count with regional distribution
                            if (!underwriterDeals[underwriter]) {
                                underwriterDeals[underwriter] = { 
                                    name: underwriter, 
                                    deals: 0, 
                                    region: region,
                                    regionalBreakdown: { NAM: { count: 0, tfa: 0 }, LATAM: { count: 0, tfa: 0 }, EMEA: { count: 0, tfa: 0 }, APAC: { count: 0, tfa: 0 } }
                                };
                            }
                            underwriterDeals[underwriter].deals++;
                            if (underwriterDeals[underwriter].regionalBreakdown[region]) {
                                underwriterDeals[underwriter].regionalBreakdown[region].count++;
                                underwriterDeals[underwriter].regionalBreakdown[region].tfa += amount;
                            }
                            
                            // Facility details for top 10
                            facilitiesData.push({
                                facilityId: facilityId,
                                relationship: relationship,
                                underwriter: underwriter,
                                product: product,
                                region: region,
                                approvalDate: approvalDate.toLocaleDateString(),
                                tfa: amount
                            });
                        }
                    }
                });
                
                console.log(' Data processing summary:', {
                    totalRows: dataSource.length,
                    facilitiesWithApprovalDate: facilitiesWithApprovalDate,
                    facilitiesInDateRange: facilitiesInDateRange,
                    uniqueNewFacilities: newFacilities.size
                });
                
                // Convert to arrays and sort
                topProducts.push(...Object.entries(productData)
                    .map(([name, data]) => ({name, ...data}))
                    .sort((a, b) => b.tfa - a.tfa)
                    .slice(0, 10));
                
                // Sort facilities by TFA and get top 10
                topFacilities.push(...facilitiesData
                    .sort((a, b) => b.tfa - a.tfa)
                    .slice(0, 10));
                
                console.log(' Found', newFacilities.size, 'new facilities');
                console.log(' Regional data:', regionalData);
                console.log(' Products:', topProducts.length);
                console.log(' Facilities:', topFacilities.length);
            } else {
                console.warn(' No mostRecentReportDate found');
            }
            
            // Convert underwriter deals to array and sort by deals count
            const topUnderwritersByDeals = Object.values(underwriterDeals)
                .sort((a, b) => b.deals - a.deals)
                .slice(0, 10);
            
            console.log(' Calling renderNewFacilitiesExpandedViews with:', {
                regional: regionalData,
                products: topProducts.length,
                facilities: topFacilities.length,
                underwriters: topUnderwritersByDeals.length
            });
            
            // Always render the views, even with empty data - delay to ensure DOM is ready
            setTimeout(() => {
                renderNewFacilitiesExpandedViews(regionalData, topProducts, topFacilities, topUnderwritersByDeals);
            }, 100);
        }
        
        // Initialize Expiring Chart - processes data and renders
        function initializeExpiringChart(dataSource) {
            const filterState = window.expiringFilterState || 'facilities';
            
            // Get report date
            const reportDates = dataSource.map(row => parseDate(row.Report_Date)).filter(d => d);
            const maxReportDate = reportDates.length > 0 ? new Date(Math.max(...reportDates)) : new Date();
            maxReportDate.setHours(0, 0, 0, 0);
            
            // Calculate date ranges for next 3 months
            const next3Months = [];
            for (let i = 0; i < 3; i++) {
                const date = new Date(maxReportDate);
                date.setMonth(date.getMonth() + i);
                next3Months.push({
                    year: date.getFullYear(),
                    month: date.getMonth(),
                    label: date.toLocaleDateString("en-US", { month: "short", year: "numeric" })
                });
            }
            
            // Collect CA and Facility data
            const caData = {
                expiring: { relationships: new Set(), tfa: 0, count: 0 },
                expired: { relationships: new Set(), tfa: 0, count: 0 },
                byMonth: {}
            };
            
            const facilityData = {
                expiring: { facilities: new Set(), tfa: 0, count: 0 },
                expired: { facilities: new Set(), tfa: 0, count: 0 },
                byMonth: {}
            };
            
            // Initialize month data
            next3Months.forEach(m => {
                const key = `${m.year}-${String(m.month + 1).padStart(2, '0')}`;
                caData.byMonth[key] = { relationships: new Set(), tfa: 0 };
                facilityData.byMonth[key] = { facilities: new Set(), tfa: 0 };
            });
            
            // Process CA data (CM only)
            dataSource.forEach(row => {
                const caExpirationDate = row.CA_Expiration_Date;
                const managementStatus = (row.Management_Status || "").toUpperCase();
                const region = (row.Region || "").toUpperCase();
                const caReview = (row.CA_Review || "").trim();
                
                if (caExpirationDate && managementStatus === "CM" && row.Relationship_ID) {
                    const dateObj = parseDate(caExpirationDate);
                    if (!dateObj) return;
                    
                    const amount = parseNumber(row.Fac_Amount || row.Facility_Amount);
                    
                    // Check EMEA CA_Review requirement
                    if (region === "EMEA" && caReview !== "Yes") return;
                    
                    // Expired (everything before report date)
                    if (dateObj < maxReportDate) {
                        caData.expired.relationships.add(row.Relationship_ID);
                        caData.expired.tfa += amount;
                        caData.expired.count++;
                    }
                    // Expiring (from report date onwards)
                    else if (dateObj >= maxReportDate) {
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthKey = `${year}-${month}`;
                        
                        if (caData.byMonth[monthKey]) {
                            caData.byMonth[monthKey].relationships.add(row.Relationship_ID);
                            caData.byMonth[monthKey].tfa += amount;
                            caData.expiring.relationships.add(row.Relationship_ID);
                            caData.expiring.tfa += amount;
                            caData.expiring.count++;
                        }
                    }
                }
            });
            
            // Process Facility data (NO DM exclusion)
            dataSource.forEach(row => {
                const maturityDate = row.Maturity_Date;
                const facilityId = row.Facility_ID;
                
                if (maturityDate && facilityId) {
                    const dateObj = parseDate(maturityDate);
                    if (!dateObj) return;
                    
                    const amount = parseNumber(row.Fac_Amount || row.Facility_Amount);
                    
                    // Expired (everything before report date)
                    if (dateObj < maxReportDate) {
                        facilityData.expired.facilities.add(facilityId);
                        facilityData.expired.tfa += amount;
                        facilityData.expired.count++;
                    }
                    // Expiring (from report date onwards)
                    else if (dateObj >= maxReportDate) {
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthKey = `${year}-${month}`;
                        
                        if (facilityData.byMonth[monthKey]) {
                            facilityData.byMonth[monthKey].facilities.add(facilityId);
                            facilityData.byMonth[monthKey].tfa += amount;
                            facilityData.expiring.facilities.add(facilityId);
                            facilityData.expiring.tfa += amount;
                            facilityData.expiring.count++;
                        }
                    }
                }
            });
            
            // Collect regional, product, and underwriter data for expiring items
            const regionalData = { NAM: {cas: 0, facilities: 0, tfa: 0}, LATAM: {cas: 0, facilities: 0, tfa: 0}, EMEA: {cas: 0, facilities: 0, tfa: 0}, APAC: {cas: 0, facilities: 0, tfa: 0} };
            const productData = {};
            const underwriterData = {};
            
            // Data for expired FACILITIES ONLY (with region, product, TFA details)
            const expiredRegionalData = { NAM: 0, LATAM: 0, EMEA: 0, APAC: 0 };
            const expiredProductData = {};
            const expiredDetailedData = []; // For backward compatibility
            const expiredFacilityDetails = []; // New: detailed facility data for table
            const expiredAgingData = { '0-30': 0, '31-60': 0, '61-90': 0, '>90': 0 }; // Aging buckets
            
            dataSource.forEach(row => {
                const region = (row.Region || "Unknown").toUpperCase();
                const product = row.Product_Program || "Unknown";
                const underwriter = row.Lead_Underwriter || "Unknown";
                const amount = parseNumber(row.Fac_Amount || row.Facility_Amount);
                
                // Check if CA is expiring (CM only, within next 3 months)
                const caExpirationDate = row.CA_Expiration_Date;
                const managementStatus = (row.Management_Status || "").toUpperCase();
                const caReview = (row.CA_Review || "").trim();
                let isCAExpiring = false;
                let isCAExpired = false;
                
                if (caExpirationDate && managementStatus === "CM" && row.Relationship_ID) {
                    const dateObj = parseDate(caExpirationDate);
                    if (dateObj) {
                        // Check EMEA CA_Review requirement
                        const meetsRequirement = region !== "EMEA" || caReview === "Yes";
                        
                        if (meetsRequirement && dateObj < maxReportDate) {
                            // Expired CA
                            isCAExpired = true;
                        } else if (meetsRequirement && dateObj >= maxReportDate) {
                            const year = dateObj.getFullYear();
                            const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                            const monthKey = `${year}-${month}`;
                            if (caData.byMonth[monthKey]) {
                                isCAExpiring = true;
                            }
                        }
                    }
                }
                
                // Check if Facility is expiring or expired (within next 3 months, no DM exclusion)
                const maturityDate = row.Maturity_Date;
                const facilityId = row.Facility_ID;
                let isFacilityExpiring = false;
                let isFacilityExpired = false;
                
                if (maturityDate && facilityId) {
                    const dateObj = parseDate(maturityDate);
                    if (dateObj) {
                        if (dateObj < maxReportDate) {
                            // Expired Facility
                            isFacilityExpired = true;
                        } else if (dateObj >= maxReportDate) {
                            const year = dateObj.getFullYear();
                            const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                            const monthKey = `${year}-${month}`;
                            if (facilityData.byMonth[monthKey]) {
                                isFacilityExpiring = true;
                            }
                        }
                    }
                }
                
                // Aggregate data for EXPIRING items
                if (isCAExpiring || isFacilityExpiring) {
                    if (!regionalData[region]) regionalData[region] = {cas: 0, facilities: 0, tfa: 0};
                    regionalData[region].tfa += amount;
                    if (isCAExpiring) regionalData[region].cas++;
                    if (isFacilityExpiring) regionalData[region].facilities++;
                    
                    if (!productData[product]) productData[product] = { tfa: 0, cas: 0, facilities: 0 };
                    productData[product].tfa += amount;
                    if (isCAExpiring) productData[product].cas++;
                    if (isFacilityExpiring) productData[product].facilities++;
                    
                    if (!underwriterData[underwriter]) {
                        underwriterData[underwriter] = { tfa: 0, cas: new Set(), facilities: new Set(), region: region };
                    }
                    underwriterData[underwriter].tfa += amount;
                    if (isCAExpiring && row.Relationship_ID) underwriterData[underwriter].cas.add(row.Relationship_ID);
                    if (isFacilityExpiring && facilityId) underwriterData[underwriter].facilities.add(facilityId);
                }
                
                // Aggregate EXPIRED FACILITIES data (only facilities)
                if (isFacilityExpired) {
                    // Store detailed info for table
                    const maturityDateObj = parseDate(maturityDate);
                    const daysPastDue = maturityDateObj ? Math.floor((maxReportDate - maturityDateObj) / (1000 * 60 * 60 * 24)) : 0;
                    
                    expiredFacilityDetails.push({
                        region: region,
                        product: product,
                        tfa: amount,
                        daysPastDue: daysPastDue,
                        facilityId: facilityId
                    });
                    
                    if (expiredRegionalData[region] !== undefined) {
                        expiredRegionalData[region]++;
                    }
                    
                    if (!expiredProductData[product]) {
                        expiredProductData[product] = { facilities: 0, tfa: 0 };
                    }
                    expiredProductData[product].facilities++;
                    expiredProductData[product].tfa += amount;
                    
                    // Categorize by aging bucket
                    if (daysPastDue >= 0 && daysPastDue <= 30) {
                        expiredAgingData['0-30']++;
                    } else if (daysPastDue >= 31 && daysPastDue <= 60) {
                        expiredAgingData['31-60']++;
                    } else if (daysPastDue >= 61 && daysPastDue <= 90) {
                        expiredAgingData['61-90']++;
                    } else if (daysPastDue > 90) {
                        expiredAgingData['>90']++;
                    }
                    
                    // Add to detailed data for backward compatibility
                    expiredDetailedData.push({
                        region: region,
                        product: product,
                        isCA: false,
                        isFacility: true
                    });
                }
            });
            
            const productDataArr = Object.entries(productData)
                .map(([name, v]) => ({ name, ...v }))
                .sort((a, b) => b.tfa - a.tfa)
                .slice(0, 10);
            
            const underwriterArr = Object.entries(underwriterData)
                .map(([name, v]) => ({
                    name,
                    tfa: v.tfa,
                    cas: v.cas.size,
                    facilities: v.facilities.size,
                    region: v.region
                }))
                .sort((a, b) => b.tfa - a.tfa)
                .slice(0, 10);
            
            // Check if there's any data
            const totalCAs = caData.expiring.count + caData.expired.count;
            const totalFacilities = facilityData.expiring.count + facilityData.expired.count;
            const hasData = totalCAs > 0 || totalFacilities > 0;
            
            const expiringData = {
                hasData: hasData,
                filterState,
                caData: {
                    expiring: { count: caData.expiring.count, tfa: caData.expiring.tfa, relationships: Array.from(caData.expiring.relationships) },
                    expired: { count: caData.expired.count, tfa: caData.expired.tfa, relationships: Array.from(caData.expired.relationships) },
                    byMonth: Object.fromEntries(Object.entries(caData.byMonth).map(([k,v]) => [k, {tfa: v.tfa, relationships: Array.from(v.relationships)}]))
                },
                facilityData: {
                    expiring: { count: facilityData.expiring.count, tfa: facilityData.expiring.tfa, facilities: Array.from(facilityData.expiring.facilities) },
                    expired: { count: facilityData.expired.count, tfa: facilityData.expired.tfa, facilities: Array.from(facilityData.expired.facilities) },
                    byMonth: Object.fromEntries(Object.entries(facilityData.byMonth).map(([k,v]) => [k, {tfa: v.tfa, facilities: Array.from(v.facilities)}]))
                },
                regionalData,
                productData: productDataArr,
                underwriterData: underwriterArr,
                expiredRegionalData,
                expiredProductData,
                expiredDetailedData,
                expiredFacilityDetails,
                expiredAgingData,
                next3Months
            };
            
            // Store for filter toggles
            window.expiringData = expiringData;
            
            // Delay rendering to ensure DOM is ready
            setTimeout(() => {
                renderExpiringAnalysis(expiringData);
                renderExpiringTable(dataSource);
            }, 100);
        }
        
        // Initialize New Deals YTD Chart - processes data and renders
        function initializeNewDealsYTDChart(dataSource) {
            // Get reporting month range
            const { monthStart, monthEnd, reportingMonth: repMonth } = getReportingMonthRange();
            const currentYear = repMonth.getFullYear();
            const yearStartDate = new Date(currentYear, 0, 1);
            yearStartDate.setHours(0, 0, 0, 0);
            
            // Calculate previous year same period for variance
            const prevYearStart = new Date(currentYear - 1, 0, 1);
            prevYearStart.setHours(0, 0, 0, 0);
            const prevYearEnd = new Date(currentYear - 1, repMonth.getMonth(), repMonth.getDate());
            prevYearEnd.setHours(23, 59, 59, 999);
            
            // Initialize data structures
            const regionalData = { APAC: {count: 0, tfa: 0}, EMEA: {count: 0, tfa: 0}, NAM: {count: 0, tfa: 0}, LATAM: {count: 0, tfa: 0} };
            const productData = {};
            const underwriterData = {};
            const monthlyData = {};
            const creditClassData = {};
            const currentYearFacilities = new Set();
            let currentYearTFA = 0;
            
            // Collect previous year data for variance
            const prevYearFacilities = new Set();
            let prevYearTFA = 0;
            
            dataSource.forEach(row => {
                // Always exclude PSE for New Deals metrics
                const pseColumn = row["PSE_non-PSE"] || row.PSE_non_PSE || "";
                const pseValue = String(pseColumn).trim().toUpperCase();
                if (pseValue === "PSE") return;
                
                const originationDate = parseDate(row.Origination_Date);
                const facilityId = row.Facility_ID;
                const region = (row.Region || "Unknown").toUpperCase();
                const product = row.Product_Program || "Unknown";
                const underwriter = row.Lead_Underwriter || "Unknown";
                const creditClassification = (row.Credit_Classification || "Unknown").toUpperCase();
                const amount = parseNumber(row.Fac_Amount || row.Facility_Amount);
                
                if (!facilityId || !originationDate) return;
                
                // Current year YTD data
                if (originationDate >= yearStartDate && originationDate <= repMonth) {
                    if (!currentYearFacilities.has(facilityId)) {
                        currentYearFacilities.add(facilityId);
                        currentYearTFA += amount;
                        
                        // Regional data
                        if (!regionalData[region]) regionalData[region] = {count: 0, tfa: 0};
                        regionalData[region].count++;
                        regionalData[region].tfa += amount;
                        
                        // Product data with regional breakdown
                        if (!productData[product]) {
                            productData[product] = { 
                                count: 0, 
                                tfa: 0,
                                regionalBreakdown: { NAM: { count: 0, tfa: 0 }, LATAM: { count: 0, tfa: 0 }, EMEA: { count: 0, tfa: 0 }, APAC: { count: 0, tfa: 0 } }
                            };
                        }
                        productData[product].count++;
                        productData[product].tfa += amount;
                        if (productData[product].regionalBreakdown[region]) {
                            productData[product].regionalBreakdown[region].count++;
                            productData[product].regionalBreakdown[region].tfa += amount;
                        }
                        
                        // Credit Classification data
                        if (!creditClassData[creditClassification]) creditClassData[creditClassification] = { count: 0, tfa: 0 };
                        creditClassData[creditClassification].count++;
                        creditClassData[creditClassification].tfa += amount;
                        
                        // Underwriter data
                        if (!underwriterData[underwriter]) underwriterData[underwriter] = { facilities: new Set(), tfa: 0, region: region };
                        underwriterData[underwriter].facilities.add(facilityId);
                        underwriterData[underwriter].tfa += amount;
                        
                        // Monthly data with regional breakdown
                        const monthKey = originationDate.toLocaleDateString("en-US", { month: "short" });
                        if (!monthlyData[monthKey]) {
                            monthlyData[monthKey] = { 
                                count: 0, 
                                tfa: 0, 
                                month: originationDate.getMonth(),
                                regionalBreakdown: { NAM: { count: 0, tfa: 0 }, LATAM: { count: 0, tfa: 0 }, EMEA: { count: 0, tfa: 0 }, APAC: { count: 0, tfa: 0 } }
                            };
                        }
                        monthlyData[monthKey].count++;
                        monthlyData[monthKey].tfa += amount;
                        if (monthlyData[monthKey].regionalBreakdown[region]) {
                            monthlyData[monthKey].regionalBreakdown[region].count++;
                            monthlyData[monthKey].regionalBreakdown[region].tfa += amount;
                        }
                    }
                }
                
                // Previous year same period data
                if (originationDate >= prevYearStart && originationDate <= prevYearEnd) {
                    if (!prevYearFacilities.has(facilityId)) {
                        prevYearFacilities.add(facilityId);
                        prevYearTFA += amount;
                    }
                }
            });
            
            // Calculate variances
            const countVariance = currentYearFacilities.size - prevYearFacilities.size;
            const countVariancePercent = prevYearFacilities.size > 0 ? (countVariance / prevYearFacilities.size) * 100 : 0;
            const tfaVariance = currentYearTFA - prevYearTFA;
            const tfaVariancePercent = prevYearTFA > 0 ? (tfaVariance / prevYearTFA) * 100 : 0;
            
            // Convert to arrays and sort
            const topProducts = Object.entries(productData)
                .map(([name, data]) => ({name, ...data}))
                .sort((a, b) => b.tfa - a.tfa)
                .slice(0, 10);
            
            const topUnderwriters = Object.entries(underwriterData)
                .map(([name, data]) => ({name, facilities: data.facilities.size, tfa: data.tfa, region: data.region}))
                .sort((a, b) => b.tfa - a.tfa)
                .slice(0, 10);
            
            const monthlyTrend = Object.entries(monthlyData)
                .map(([name, data]) => ({name, ...data}))
                .sort((a, b) => a.month - b.month);
            
            // Convert credit classification to array
            const creditClassification = Object.entries(creditClassData)
                .map(([name, data]) => ({name, count: data.count, tfa: data.tfa}))
                .sort((a, b) => b.count - a.count);
            
            // Store data for rendering
            window.newDealsYTDExpandedData = {
                regionalData,
                topProducts,
                topUnderwriters,
                monthlyTrend,
                creditClassification,
                prevYearFacilities: prevYearFacilities.size,
                prevYearTFA,
                currentCount: currentYearFacilities.size,
                currentTFA: currentYearTFA,
                countVariance,
                countVariancePercent,
                tfaVariance,
                tfaVariancePercent,
                currentYear,
                reportingMonth: repMonth
            };
            
            // Call render with all computed data
            renderNewDealsYTDExpandedViews();
        }
        
        // Initialize New Deals MTD Chart - processes data and renders
        function initializeNewDealsMTDChart(dataSource) {
            // Get reporting month range
            const { monthStart, monthEnd, reportingMonth: repMonth } = getReportingMonthRange();
            const currentYear = repMonth.getFullYear();
            const currentMonth = repMonth.getMonth();
            
            // Calculate previous month for variance
            const prevMonthStart = new Date(currentYear, currentMonth - 1, 1);
            prevMonthStart.setHours(0, 0, 0, 0);
            const prevMonthEnd = new Date(currentYear, currentMonth, 0);
            prevMonthEnd.setHours(23, 59, 59, 999);
            
            // Initialize data structures
            const regionalData = { APAC: {count: 0, tfa: 0}, EMEA: {count: 0, tfa: 0}, NAM: {count: 0, tfa: 0}, LATAM: {count: 0, tfa: 0} };
            const productData = {};
            const underwriterData = {};
            const weeklyData = {};
            const creditClassData = {};
            const currentMonthFacilities = new Set();
            let currentMonthTFA = 0;
            
            // Collect previous month data for variance
            const prevMonthFacilities = new Set();
            let prevMonthTFA = 0;
            
            dataSource.forEach(row => {
                // Always exclude PSE for New Deals metrics
                const pseColumn = row["PSE_non-PSE"] || row.PSE_non_PSE || "";
                const pseValue = String(pseColumn).trim().toUpperCase();
                if (pseValue === "PSE") return;
                
                const originationDate = parseDate(row.Origination_Date);
                const facilityId = row.Facility_ID;
                const region = (row.Region || "Unknown").toUpperCase();
                const product = row.Product_Program || "Unknown";
                const underwriter = row.Lead_Underwriter || "Unknown";
                const creditClassification = (row.Credit_Classification || "Unknown").toUpperCase();
                const amount = parseNumber(row.Fac_Amount || row.Facility_Amount);
                
                if (!facilityId || !originationDate) return;
                
                // Current month data
                if (originationDate >= monthStart && originationDate <= monthEnd) {
                    if (!currentMonthFacilities.has(facilityId)) {
                        currentMonthFacilities.add(facilityId);
                        currentMonthTFA += amount;
                        
                        // Regional data
                        if (!regionalData[region]) regionalData[region] = {count: 0, tfa: 0};
                        regionalData[region].count++;
                        regionalData[region].tfa += amount;
                        
                        // Product data with regional breakdown
                        if (!productData[product]) {
                            productData[product] = { 
                                count: 0, 
                                tfa: 0,
                                regionalBreakdown: { NAM: { count: 0, tfa: 0 }, LATAM: { count: 0, tfa: 0 }, EMEA: { count: 0, tfa: 0 }, APAC: { count: 0, tfa: 0 } }
                            };
                        }
                        productData[product].count++;
                        productData[product].tfa += amount;
                        if (productData[product].regionalBreakdown[region]) {
                            productData[product].regionalBreakdown[region].count++;
                            productData[product].regionalBreakdown[region].tfa += amount;
                        }
                        
                        // Credit Classification data
                        if (!creditClassData[creditClassification]) creditClassData[creditClassification] = { count: 0, tfa: 0 };
                        creditClassData[creditClassification].count++;
                        creditClassData[creditClassification].tfa += amount;
                        
                        // Underwriter data
                        if (!underwriterData[underwriter]) underwriterData[underwriter] = { facilities: new Set(), tfa: 0, region: region };
                        underwriterData[underwriter].facilities.add(facilityId);
                        underwriterData[underwriter].tfa += amount;
                        
                        // Weekly data with regional breakdown
                        const weekNumber = Math.ceil(originationDate.getDate() / 7);
                        const weekKey = `Week ${weekNumber}`;
                        if (!weeklyData[weekKey]) {
                            weeklyData[weekKey] = { 
                                count: 0, 
                                tfa: 0, 
                                week: weekNumber,
                                regionalBreakdown: { NAM: { count: 0, tfa: 0 }, LATAM: { count: 0, tfa: 0 }, EMEA: { count: 0, tfa: 0 }, APAC: { count: 0, tfa: 0 } }
                            };
                        }
                        weeklyData[weekKey].count++;
                        weeklyData[weekKey].tfa += amount;
                        if (weeklyData[weekKey].regionalBreakdown[region]) {
                            weeklyData[weekKey].regionalBreakdown[region].count++;
                            weeklyData[weekKey].regionalBreakdown[region].tfa += amount;
                        }
                    }
                }
                
                // Previous month data
                if (originationDate >= prevMonthStart && originationDate <= prevMonthEnd) {
                    if (!prevMonthFacilities.has(facilityId)) {
                        prevMonthFacilities.add(facilityId);
                        prevMonthTFA += amount;
                    }
                }
            });
            
            // Calculate variances
            const countVariance = currentMonthFacilities.size - prevMonthFacilities.size;
            const countVariancePercent = prevMonthFacilities.size > 0 ? (countVariance / prevMonthFacilities.size) * 100 : 0;
            const tfaVariance = currentMonthTFA - prevMonthTFA;
            const tfaVariancePercent = prevMonthTFA > 0 ? (tfaVariance / prevMonthTFA) * 100 : 0;
            
            // Convert to arrays and sort
            const topProducts = Object.entries(productData)
                .map(([name, data]) => ({name, ...data}))
                .sort((a, b) => b.tfa - a.tfa)
                .slice(0, 10);
            
            const topUnderwriters = Object.entries(underwriterData)
                .map(([name, data]) => ({name, facilities: data.facilities.size, tfa: data.tfa, region: data.region}))
                .sort((a, b) => b.tfa - a.tfa)
                .slice(0, 10);
            
            const weeklyTrend = Object.entries(weeklyData)
                .map(([name, data]) => ({name, ...data}))
                .sort((a, b) => a.week - b.week);
            
            // Convert credit classification to array
            const creditClassification = Object.entries(creditClassData)
                .map(([name, data]) => ({name, count: data.count, tfa: data.tfa}))
                .sort((a, b) => b.count - a.count);
            
            // Store data for rendering
            window.newDealsMTDExpandedData = {
                regionalData,
                topProducts,
                topUnderwriters,
                weeklyTrend,
                creditClassification,
                prevMonthFacilities: prevMonthFacilities.size,
                prevMonthTFA,
                currentCount: currentMonthFacilities.size,
                currentTFA: currentMonthTFA,
                countVariance,
                countVariancePercent,
                tfaVariance,
                tfaVariancePercent,
                currentMonth: repMonth,
                prevMonth: prevMonthStart
            };
            
            // Call render with all computed data
            renderNewDealsMTDExpandedViews();
        }
        
        // Initialize Pipeline Chart - processes data and renders
        function initializePipelineChart(dataSource) {
            console.log(' initializePipelineChart called with', dataSource ? dataSource.length : 0, 'records');
            
            const currentYear = new Date().getFullYear();
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Use global excluded facility types constant
            const excludedFacilityTypes = EXCLUDED_FACILITY_TYPES;
            
            // Initialize regional data for all regions (show all even if 0)
            const regionalData = { 
                APAC: {count: 0, tfa: 0, facilities: 0},
                EMEA: {count: 0, tfa: 0, facilities: 0},
                NAM: {count: 0, tfa: 0, facilities: 0},
                LATAM: {count: 0, tfa: 0, facilities: 0}
            };
            const productData = {};
            const underwriterData = {};
            const allPendingDeals = [];
            let totalTFA = 0;
            
            // Track unique facilities
            const allPendingFacilities = new Set();
            
            // Process data
            dataSource.forEach(row => {
                // Always exclude PSE
                const pseColumn = row["PSE_non-PSE"] || row.PSE_non_PSE || "";
                const pseValue = String(pseColumn).trim().toUpperCase();
                if (pseValue === "PSE") return;
                
                // Only include NAM and LATAM regions
                const region = String(row.Region || "").trim().toUpperCase();
                if (region !== "NAM" && region !== "LATAM") return;
                
                // Exclude specific facility types
                const facilityType = String(row.Facility_Type || "").trim();
                if (excludedFacilityTypes.includes(facilityType)) return;
                
                const originationDate = row.Origination_Date;
                const firstApprovalDate = parseDate(row.Facility_First_Approval_Date);
                const facilityId = row.Facility_ID;
                const tfaAmount = parseNumber(row.Fac_Amount || row.Facility_Amount);
                const product = row.Product_Program || "Unknown";
                const underwriter = row.Lead_Underwriter || "Unknown";
                const relationship = row.Relationship_Name || row.Relationship_ID || "Unknown";
                
                // Pending closure criteria
                if ((!originationDate || originationDate.trim() === '') &&
                    firstApprovalDate &&
                    facilityId &&
                    firstApprovalDate.getFullYear() === currentYear) {
                    
                    allPendingFacilities.add(facilityId);
                    totalTFA += tfaAmount;
                    
                    // Calculate days since approval
                    const daysSinceApproval = Math.floor((today - firstApprovalDate) / (1000 * 60 * 60 * 24));
                    
                    // Store full deal details
                    allPendingDeals.push({
                        facilityId: facilityId,
                        relationship: relationship,
                        region: region,
                        product: product,
                        facilityType: facilityType,
                        underwriter: underwriter,
                        tfa: tfaAmount,
                        daysOld: daysSinceApproval,
                        firstApprovalDate: firstApprovalDate
                    });
                    
                    // Regional data
                    if (regionalData[region]) {
                        regionalData[region].facilities++;
                        regionalData[region].tfa += tfaAmount;
                        regionalData[region].count++;
                    }
                    
                    // Product data with regional breakdown
                    if (!productData[product]) {
                        productData[product] = { 
                            count: 0, 
                            tfa: 0,
                            regionalBreakdown: { NAM: { count: 0, tfa: 0 }, LATAM: { count: 0, tfa: 0 } }
                        };
                    }
                    productData[product].count++;
                    productData[product].tfa += tfaAmount;
                    if (productData[product].regionalBreakdown[region]) {
                        productData[product].regionalBreakdown[region].count++;
                        productData[product].regionalBreakdown[region].tfa += tfaAmount;
                    }
                    
                    // Underwriter data
                    if (!underwriterData[underwriter]) {
                        underwriterData[underwriter] = { facilities: 0, tfa: 0, region: region };
                    }
                    underwriterData[underwriter].facilities++;
                    underwriterData[underwriter].tfa += tfaAmount;
                }
            });
            
            // Convert to arrays and sort
            const topProducts = Object.entries(productData)
                .map(([name, data]) => ({name, count: data.count, tfa: data.tfa}))
                .sort((a, b) => b.tfa - a.tfa);
            
            const topUnderwriters = Object.entries(underwriterData)
                .map(([name, data]) => ({name, facilities: data.facilities, tfa: data.tfa, region: data.region}))
                .sort((a, b) => b.facilities - a.facilities)
                .slice(0, 10);
            
            // Sort deals by days old (oldest first)
            const sortedDeals = allPendingDeals.sort((a, b) => b.daysOld - a.daysOld);
            
            console.log(' Pipeline data processed:', {
                regional: regionalData,
                productsCount: topProducts.length,
                underwritersCount: topUnderwriters.length,
                dealsCount: sortedDeals.length,
                totalFacilities: allPendingFacilities.size,
                totalTFA: totalTFA
            });
            
            // Store data for rendering
            window.pipelineExpandedData = {
                regional: regionalData,
                topProducts: topProducts,
                topUnderwriters: topUnderwriters,
                allDeals: sortedDeals,
                totalFacilities: allPendingFacilities.size,
                totalTFA: totalTFA,
                currentYear: currentYear
            };
            
            console.log(' Data stored in window.pipelineExpandedData');
            
            // Directly render the views
            renderPipelineExpandedViews();
        }
        
        // Initialize Top Relationships Chart - processes data and renders
        function initializeTopRelationshipsChart(dataSource) {
            // Get Top N filter value
            const topN = parseInt(document.getElementById("topNFilter").value) || 10;
            
            // Get selected exposure type (from global variable)
            const exposureType = selectedAmountType; // "direct", "contingent", "pse", "osuc", "tfa", "unused"
            
            console.log(' Top Relationships - Using exposure type:', exposureType, 'Top N:', topN);
            
            // Collect relationship data
            const relationshipData = new Map();
            const productByRelationship = new Map();
            const facilityTypeByRelationship = new Map();
            const underwriterByRelationship = new Map();
            
            dataSource.forEach(row => {
                const relId = row.Relationship_Name || row.Relationship_ID;
                const region = (row.Region || "Unknown").toUpperCase();
                const product = row.Product_Program || "Unknown";
                const facilityType = row.Facility_Type || "Unknown";
                const underwriter = row.Lead_Underwriter || "Unknown";
                
                if (!relId) return;
                
                // Relationship totals
                if (!relationshipData.has(relId)) {
                    relationshipData.set(relId, {
                        name: relId,
                        region: region,
                        tfa: 0,
                        direct: 0,
                        contingent: 0,
                        pse: 0,
                        totalOS: 0,
                        osuc: 0,
                        unused: 0,
                        facilities: new Set(),
                        rotce: []
                    });
                }
                
                const data = relationshipData.get(relId);
                data.tfa += parseNumber(row.Fac_Amount || row.Facility_Amount);
                data.direct += parseNumber(row.Direct_OS);
                data.contingent += parseNumber(row.Contingent_OS);
                data.pse += parseNumber(row.PSE_OS);
                data.totalOS += parseNumber(row.Total_OS);
                data.osuc += parseNumber(row.OSUC);
                data.unused += parseNumber(row.Unused_Committed);
                if (row.Facility_ID) data.facilities.add(row.Facility_ID);
                
                // ROTCE values
                const rotce = parsePercentage(row.ROTCE);
                if (!isNaN(rotce)) {
                    data.rotce.push(rotce);
                }
                
                // Product breakdown by relationship (track all exposure types)
                if (!productByRelationship.has(relId)) {
                    productByRelationship.set(relId, {});
                }
                const prodMap = productByRelationship.get(relId);
                if (!prodMap[product]) {
                    prodMap[product] = { 
                        tfa: 0, 
                        direct: 0, 
                        contingent: 0, 
                        pse: 0, 
                        osuc: 0, 
                        unused: 0, 
                        totalOS: 0, 
                        count: 0 
                    };
                }
                prodMap[product].tfa += parseNumber(row.Fac_Amount || row.Facility_Amount);
                prodMap[product].direct += parseNumber(row.Direct_OS);
                prodMap[product].contingent += parseNumber(row.Contingent_OS);
                prodMap[product].pse += parseNumber(row.PSE_OS);
                prodMap[product].osuc += parseNumber(row.OSUC);
                prodMap[product].unused += parseNumber(row.Unused_Committed);
                prodMap[product].totalOS += parseNumber(row.Total_OS);
                prodMap[product].count++;
                
                // Facility type breakdown
                if (!facilityTypeByRelationship.has(relId)) {
                    facilityTypeByRelationship.set(relId, {});
                }
                const typeMap = facilityTypeByRelationship.get(relId);
                if (!typeMap[facilityType]) {
                    typeMap[facilityType] = { tfa: 0, count: 0 };
                }
                typeMap[facilityType].tfa += parseNumber(row.Fac_Amount || row.Facility_Amount);
                typeMap[facilityType].count++;
                
                // Underwriter
                if (!underwriterByRelationship.has(relId)) {
                    underwriterByRelationship.set(relId, underwriter);
                }
            });
            
            // Calculate averages and prepare data
            relationshipData.forEach((data, relId) => {
                data.facilityCount = data.facilities.size;
                data.avgROTCE = data.rotce.length > 0 
                    ? data.rotce.reduce((sum, val) => sum + val, 0) / data.rotce.length 
                    : 0;
                data.avgDealSize = data.facilityCount > 0 ? data.tfa / data.facilityCount : 0;
            });
            
            // Sort by selected exposure type and get top N
            const topRelationships = Array.from(relationshipData.values())
                .sort((a, b) => {
                    switch(exposureType) {
                        case "tfa": return b.tfa - a.tfa;
                        case "contingent": return b.contingent - a.contingent;
                        case "pse": return b.pse - a.pse;
                        case "osuc": return b.osuc - a.osuc;
                        case "unused": return b.unused - a.unused;
                        case "totalOS": return b.totalOS - a.totalOS;
                        case "direct":
                        default: return b.direct - a.direct;
                    }
                })
                .slice(0, topN);
            
            // Calculate regional distribution (using selected exposure type)
            const regionalData = { 
                APAC: {count: 0, tfa: 0, exposure: 0}, 
                EMEA: {count: 0, tfa: 0, exposure: 0}, 
                NAM: {count: 0, tfa: 0, exposure: 0},
                LATAM: {count: 0, tfa: 0, exposure: 0}
            };
            topRelationships.forEach(rel => {
                const region = rel.region;
                if (!regionalData[region]) {
                    regionalData[region] = {count: 0, tfa: 0, exposure: 0};
                }
                regionalData[region].count++;
                regionalData[region].tfa += rel.tfa;
                
                // Add the selected exposure type value
                switch(exposureType) {
                    case "tfa": regionalData[region].exposure += rel.tfa; break;
                    case "contingent": regionalData[region].exposure += rel.contingent; break;
                    case "pse": regionalData[region].exposure += rel.pse; break;
                    case "osuc": regionalData[region].exposure += rel.osuc; break;
                    case "unused": regionalData[region].exposure += rel.unused; break;
                    case "totalOS": regionalData[region].exposure += rel.totalOS; break;
                    case "direct":
                    default: regionalData[region].exposure += rel.direct; break;
                }
            });
            
            // Get exposure type breakdown for top relationships
            const exposureBreakdown = topRelationships.map(rel => ({
                name: rel.name,
                direct: rel.direct,
                contingent: rel.contingent,
                pse: rel.pse,
                totalOS: rel.totalOS
            })).slice(0, 10); // Top 10 for chart
            
            // Get top products across all top relationships (track all exposure types with regional breakdown)
            const productAggregation = {};
            topRelationships.forEach(rel => {
                const relId = rel.name;
                const relRegion = rel.region;
                const prodMap = productByRelationship.get(relId);
                if (prodMap) {
                    Object.entries(prodMap).forEach(([product, data]) => {
                        if (!productAggregation[product]) {
                            productAggregation[product] = { 
                                tfa: 0, 
                                direct: 0, 
                                contingent: 0, 
                                pse: 0, 
                                osuc: 0, 
                                unused: 0, 
                                totalOS: 0, 
                                count: 0,
                                regionalBreakdown: { 
                                    NAM: { count: 0, tfa: 0, direct: 0, contingent: 0, pse: 0, osuc: 0, unused: 0, totalOS: 0 }, 
                                    LATAM: { count: 0, tfa: 0, direct: 0, contingent: 0, pse: 0, osuc: 0, unused: 0, totalOS: 0 }, 
                                    EMEA: { count: 0, tfa: 0, direct: 0, contingent: 0, pse: 0, osuc: 0, unused: 0, totalOS: 0 }, 
                                    APAC: { count: 0, tfa: 0, direct: 0, contingent: 0, pse: 0, osuc: 0, unused: 0, totalOS: 0 } 
                                }
                            };
                        }
                        productAggregation[product].tfa += data.tfa;
                        productAggregation[product].direct += data.direct;
                        productAggregation[product].contingent += data.contingent;
                        productAggregation[product].pse += data.pse;
                        productAggregation[product].osuc += data.osuc;
                        productAggregation[product].unused += data.unused;
                        productAggregation[product].totalOS += data.totalOS;
                        productAggregation[product].count += data.count;
                        
                        // Add to regional breakdown
                        if (productAggregation[product].regionalBreakdown[relRegion]) {
                            productAggregation[product].regionalBreakdown[relRegion].count += data.count;
                            productAggregation[product].regionalBreakdown[relRegion].tfa += data.tfa;
                            productAggregation[product].regionalBreakdown[relRegion].direct += data.direct;
                            productAggregation[product].regionalBreakdown[relRegion].contingent += data.contingent;
                            productAggregation[product].regionalBreakdown[relRegion].pse += data.pse;
                            productAggregation[product].regionalBreakdown[relRegion].osuc += data.osuc;
                            productAggregation[product].regionalBreakdown[relRegion].unused += data.unused;
                            productAggregation[product].regionalBreakdown[relRegion].totalOS += data.totalOS;
                        }
                    });
                }
            });
            
            // Get the exposure value for each product based on selected type
            const getExposureValue = (data) => {
                switch(exposureType) {
                    case "tfa": return data.tfa;
                    case "contingent": return data.contingent;
                    case "pse": return data.pse;
                    case "osuc": return data.osuc;
                    case "unused": return data.unused;
                    case "totalOS": return data.totalOS;
                    case "direct":
                    default: return data.direct;
                }
            };
            
            const topProducts = Object.entries(productAggregation)
                .map(([name, data]) => ({ 
                    name, 
                    tfa: data.tfa,
                    exposure: getExposureValue(data),
                    count: data.count 
                }))
                .sort((a, b) => b.exposure - a.exposure)
                .slice(0, 10);
            
            // Get product-level data for donut chart (all products, sorted by selected exposure)
            const productChartData = Object.entries(productAggregation)
                .map(([name, data]) => ({ 
                    product: name, 
                    tfa: data.tfa, 
                    exposure: getExposureValue(data),
                    count: data.count,
                    regionalBreakdown: data.regionalBreakdown
                }))
                .sort((a, b) => b.exposure - a.exposure);
            
            // Get top underwriters
            const underwriterAggregation = {};
            dataSource.forEach(row => {
                const relId = row.Relationship_Name || row.Relationship_ID;
                if (!relId) return;
                
                // Check if this relationship is in top N
                const isTopRelationship = topRelationships.some(r => r.name === relId);
                if (!isTopRelationship) return;
                
                const underwriter = row.Lead_Underwriter || "Unknown";
                const region = (row.Region || "Unknown").toUpperCase();
                const facilityId = row.Facility_ID;
                
                if (!underwriterAggregation[underwriter]) {
                    underwriterAggregation[underwriter] = {
                        name: underwriter,
                        region: region,
                        relationships: new Set(),
                        facilities: new Set(),
                        tfa: 0
                    };
                }
                
                underwriterAggregation[underwriter].relationships.add(relId);
                if (facilityId) underwriterAggregation[underwriter].facilities.add(facilityId);
                underwriterAggregation[underwriter].tfa += parseNumber(row.Fac_Amount || row.Facility_Amount);
            });
            
            const topUnderwriters = Object.values(underwriterAggregation)
                .map(u => ({
                    name: u.name,
                    region: u.region,
                    relationships: u.relationships.size,
                    facilities: u.facilities.size,
                    tfa: u.tfa
                }))
                .sort((a, b) => b.tfa - a.tfa)
                .slice(0, 10);
            
            // Get exposure type label for display
            const exposureTypeLabels = {
                "direct": "Direct OS",
                "contingent": "Contingent OS",
                "pse": "PSE OS",
                "osuc": "OSUC",
                "tfa": "TFA",
                "unused": "Unused Commitment",
                "totalOS": "Total OS"
            };
            const exposureLabel = exposureTypeLabels[exposureType] || "Direct OS";
            
            // Check if we have any data
            const hasData = topRelationships.length > 0 && topRelationships.some(r => {
                switch(exposureType) {
                    case "tfa": return r.tfa > 0;
                    case "contingent": return r.contingent > 0;
                    case "pse": return r.pse > 0;
                    case "osuc": return r.osuc > 0;
                    case "unused": return r.unused > 0;
                    case "totalOS": return r.totalOS > 0;
                    case "direct":
                    default: return r.direct > 0;
                }
            });
            
            // Store data for rendering
            window.topRelationshipsExpandedData = {
                hasData: hasData,
                relationships: topRelationships.map(r => ({
                    name: r.name,
                    region: r.region,
                    tfa: r.tfa,
                    direct: r.direct,
                    contingent: r.contingent,
                    pse: r.pse,
                    totalOS: r.totalOS,
                    osuc: r.osuc,
                    unused: r.unused,
                    facilities: r.facilityCount,
                    avgROTCE: r.avgROTCE,
                    avgDealSize: r.avgDealSize,
                    // Store the actual selected exposure value
                    selectedExposure: (() => {
                        switch(exposureType) {
                            case "tfa": return r.tfa;
                            case "contingent": return r.contingent;
                            case "pse": return r.pse;
                            case "osuc": return r.osuc;
                            case "unused": return r.unused;
                            case "totalOS": return r.totalOS;
                            case "direct":
                            default: return r.direct;
                        }
                    })()
                })),
                regional: regionalData,
                exposureBreakdown: exposureBreakdown,
                products: topProducts,
                productChartData: productChartData,
                underwriters: topUnderwriters,
                exposureType: exposureType,
                exposureLabel: exposureLabel,
                topN: topN
            };
            
            // Call render with all computed data
            renderTopRelationshipsExpandedViews();
        }
        
        // Initialize ROTCE Chart - processes data and renders
        function initializeROTCEChart(dataSource) {
            // Get Top N filter value
            const topN = parseInt(document.getElementById("topNFilter").value) || 10;
            
            // Get selected exposure type (from global variable - sync with Top Relationships)
            const exposureType = selectedAmountType;
            
            console.log(' ROTCE Chart - Using exposure type:', exposureType, 'Top N:', topN);
            
            // Collect ROTCE data by relationship
            const rotceByRelationship = new Map();
            const relationshipDetails = new Map();
            
            dataSource.forEach(row => {
                const relName = row.Relationship_Name || row.Relationship_ID;
                const rotce = parsePercentage(row.ROTCE);
                const region = (row.Region || "Unknown").toUpperCase();
                const product = row.Product_Program || "Unknown";
                
                if (!relName) return;
                
                // ROTCE values
                if (!rotceByRelationship.has(relName)) {
                    rotceByRelationship.set(relName, []);
                }
                if (!isNaN(rotce)) {
                    rotceByRelationship.get(relName).push(rotce);
                }
                
                // Relationship details
                if (!relationshipDetails.has(relName)) {
                    relationshipDetails.set(relName, {
                        name: relName,
                        region: region,
                        direct: 0,
                        contingent: 0,
                        pse: 0,
                        osuc: 0,
                        unused: 0,
                        totalOS: 0,
                        tfa: 0,
                        facilities: new Set(),
                        products: new Set(),
                        rotceValues: []
                    });
                }
                
                const details = relationshipDetails.get(relName);
                details.direct += parseNumber(row.Direct_OS);
                details.contingent += parseNumber(row.Contingent_OS);
                details.pse += parseNumber(row.PSE_OS);
                details.osuc += parseNumber(row.OSUC);
                details.unused += parseNumber(row.Unused_Committed);
                details.totalOS += parseNumber(row.Total_OS);
                details.tfa += parseNumber(row.Fac_Amount || row.Facility_Amount);
                if (row.Facility_ID) details.facilities.add(row.Facility_ID);
                details.products.add(product);
                if (!isNaN(rotce)) details.rotceValues.push(rotce);
            });
            
            // Calculate averages and prepare relationship data
            const relationshipROTCE = [];
            relationshipDetails.forEach((details, relName) => {
                const avgROTCE = details.rotceValues.length > 0
                    ? details.rotceValues.reduce((sum, val) => sum + val, 0) / details.rotceValues.length
                    : 0;
                const minROTCE = details.rotceValues.length > 0 ? Math.min(...details.rotceValues) : 0;
                const maxROTCE = details.rotceValues.length > 0 ? Math.max(...details.rotceValues) : 0;
                
                relationshipROTCE.push({
                    name: relName,
                    region: details.region,
                    avgROTCE: avgROTCE,
                    minROTCE: minROTCE,
                    maxROTCE: maxROTCE,
                    direct: details.direct,
                    contingent: details.contingent,
                    pse: details.pse,
                    osuc: details.osuc,
                    unused: details.unused,
                    totalOS: details.totalOS,
                    tfa: details.tfa,
                    facilities: details.facilities.size,
                    products: details.products.size,
                    dataPoints: details.rotceValues.length
                });
            });
            
            // Sort by selected exposure type and get top N
            const topRelationships = relationshipROTCE
                .sort((a, b) => {
                    switch(exposureType) {
                        case "tfa": return b.tfa - a.tfa;
                        case "contingent": return b.contingent - a.contingent;
                        case "pse": return b.pse - a.pse;
                        case "osuc": return b.osuc - a.osuc;
                        case "unused": return b.unused - a.unused;
                        case "totalOS": return b.totalOS - a.totalOS;
                        case "direct":
                        default: return b.direct - a.direct;
                    }
                })
                .slice(0, topN);
            
            // Get relationships below target (ROTCE < 8%) for the bar chart
            const belowTargetRelationships = relationshipROTCE
                .filter(r => r.avgROTCE < 8)
                .sort((a, b) => a.avgROTCE - b.avgROTCE)
                .slice(0, 10);
            
            // Regional data - initialize all regions
            const regionalData = {
                APAC: {count: 0, direct: 0, exposure: 0, avgRotce: []},
                EMEA: {count: 0, direct: 0, exposure: 0, avgRotce: []},
                NAM: {count: 0, direct: 0, exposure: 0, avgRotce: []},
                LATAM: {count: 0, direct: 0, exposure: 0, avgRotce: []}
            };
            
            topRelationships.forEach(rel => {
                const region = rel.region;
                if (regionalData[region]) {
                    regionalData[region].count++;
                    regionalData[region].direct += rel.direct;
                    regionalData[region].avgRotce.push(rel.avgROTCE);
                    
                    // Add selected exposure type value
                    switch(exposureType) {
                        case "tfa": regionalData[region].exposure += rel.tfa; break;
                        case "contingent": regionalData[region].exposure += rel.contingent; break;
                        case "pse": regionalData[region].exposure += rel.pse; break;
                        case "osuc": regionalData[region].exposure += rel.osuc; break;
                        case "unused": regionalData[region].exposure += rel.unused; break;
                        case "totalOS": regionalData[region].exposure += rel.totalOS; break;
                        case "direct":
                        default: regionalData[region].exposure += rel.direct; break;
                    }
                }
            });
            
            // Calculate regional averages
            Object.keys(regionalData).forEach(region => {
                const values = regionalData[region].avgRotce;
                regionalData[region].avgRotce = values.length > 0 
                    ? values.reduce((sum, val) => sum + val, 0) / values.length 
                    : 0;
            });
            
            // Calculate portfolio average
            const portfolioAvg = topRelationships.length > 0
                ? topRelationships.reduce((sum, r) => sum + r.avgROTCE, 0) / topRelationships.length
                : 0;
            
            // Performance categorization
            const excellent = topRelationships.filter(r => r.avgROTCE >= 15).length;
            const good = topRelationships.filter(r => r.avgROTCE >= 12 && r.avgROTCE < 15).length;
            const acceptable = topRelationships.filter(r => r.avgROTCE >= 8 && r.avgROTCE < 12).length;
            const belowTarget = topRelationships.filter(r => r.avgROTCE < 8).length;
            
            // Check if we have any data based on selected exposure type
            const hasData = topRelationships.length > 0 && topRelationships.some(r => {
                switch(exposureType) {
                    case "tfa": return r.tfa > 0;
                    case "contingent": return r.contingent > 0;
                    case "pse": return r.pse > 0;
                    case "osuc": return r.osuc > 0;
                    case "unused": return r.unused > 0;
                    case "totalOS": return r.totalOS > 0;
                    case "direct":
                    default: return r.direct > 0;
                }
            });
            
            // Map exposure type to label
            const exposureTypeLabels = {
                "direct": "Direct OS",
                "contingent": "Contingent OS",
                "pse": "PSE OS",
                "osuc": "OSUC",
                "unused": "Unused Commitment",
                "totalOS": "Total OS",
                "tfa": "TFA"
            };
            const exposureLabel = exposureTypeLabels[exposureType] || "Direct OS";
            
            // Store data for rendering
            window.rotceExpandedData = {
                hasData: hasData,
                relationships: topRelationships,
                belowTargetRelationships: belowTargetRelationships,
                regional: regionalData,
                portfolioAvg: portfolioAvg,
                topN: topN,
                stats: {
                    excellent: excellent,
                    good: good,
                    acceptable: acceptable,
                    belowTarget: belowTarget
                },
                exposureType: exposureType,
                exposureLabel: exposureLabel
            };
            
            // Directly render the views
            renderROTCEExpandedViews();
        }
        
        // Initialize Covenant Chart - processes data and renders directly
        function initializeCovenantChart(dataSource) {
            // Use covenant data if available, otherwise fall back to portfolio data
            const covenantDataSource = window.covenantsData && window.covenantsData.length > 0 ? window.covenantsData : dataSource;
            
            // Get current view type (pastDue or comingDue) from global state
            const viewType = window.currentCovenantViewType || 'pastDue';
            const isPastDue = viewType === 'pastDue';
            
            // Filter covenants by status
            const currentViewData = covenantDataSource.filter(row => {
                const status = String(row.Coming_Due_Past_Due || "").trim().toLowerCase();
                const region = (row.Region || "").toUpperCase();
                
                // Apply region filter if active
                if (window.selectedRegion && window.selectedRegion !== 'all' && region !== window.selectedRegion.toUpperCase()) return false;
                
                const matches = isPastDue ? status === 'past due' : (status === 'coming due' && isWithinNext30Days(row.Covenant_Due_Date));
                return matches;
            });
            
            // Also get the opposite view data for comparison
            const oppositeViewData = covenantDataSource.filter(row => {
                const status = String(row.Coming_Due_Past_Due || "").trim().toLowerCase();
                const region = (row.Region || "").toUpperCase();
                
                // Apply region filter if active
                if (window.selectedRegion && window.selectedRegion !== 'all' && region !== window.selectedRegion.toUpperCase()) return false;
                
                const oppositeMatches = isPastDue ? (status === 'coming due' && isWithinNext30Days(row.Covenant_Due_Date)) : status === 'past due';
                return oppositeMatches;
            });
            
            // Collect comprehensive data for current view
            const regionalData = { NAM: {count: 0, facilities: new Set()}, LATAM: {count: 0, facilities: new Set()}, EMEA: {count: 0, facilities: new Set()}, APAC: {count: 0, facilities: new Set()} };
            const productData = {};
            const categoryData = {};
            const underwritingLevelData = {}; // New structure for underwriting level table
            
            currentViewData.forEach(row => {
                const region = (row.Region || "Unknown").toUpperCase();
                const product = row.Product_Program_Name || row.Product_Program || "Unknown";
                const category = row.Past_Due_Category || "Uncategorized";
                const underwriter = row.Lead_Underwriter || "Unknown";
                const relationship = row.Relationship_Name || "Unknown";
                const facilityType = row.Facility_Type || "Unknown";
                const covenantNumber = row.Covenant_Number || "";
                const caId = row.CA_Number || "";
                const facilityId = row.Facility_Number || row.Facility_ID;
                const daysPastDue = parseNumber(row.Days_Past_Due);
                const status = String(row.Coming_Due_Past_Due || "").trim().toLowerCase();
                
                // Regional data
                if (!regionalData[region]) {
                    regionalData[region] = {count: 0, facilities: new Set()};
                }
                regionalData[region].count++;
                if (facilityId) regionalData[region].facilities.add(facilityId);
                
                // Product data
                if (!productData[product]) {
                    productData[product] = { count: 0, facilities: new Set() };
                }
                productData[product].count++;
                if (facilityId) productData[product].facilities.add(facilityId);
                
                // Category data (for past due)
                if (isPastDue && category) {
                    if (!categoryData[category]) {
                        categoryData[category] = { count: 0, facilities: new Set() };
                    }
                    categoryData[category].count++;
                    if (facilityId) categoryData[category].facilities.add(facilityId);
                }
                
                // Underwriting level data with aging buckets
                const key = `${region}|${underwriter}|${relationship}|${facilityType}|${covenantNumber}|${caId}`;
                if (!underwritingLevelData[key]) {
                    underwritingLevelData[key] = {
                        region: region,
                        underwriter: underwriter,
                        relationshipName: relationship,
                        facilityType: facilityType,
                        covenantNumber: covenantNumber,
                        caId: caId,
                        days_1_45: 0,
                        days_46_60: 0,
                        days_61_90: 0,
                        days_90_plus: 0,
                        comingDue: 0,
                        total: 0
                    };
                }
                
                // Categorize by aging bucket
                if (status === 'coming due' && isWithinNext30Days(row.Covenant_Due_Date)) {
                    underwritingLevelData[key].comingDue++;
                } else if (status === 'past due') {
                    if (daysPastDue >= 1 && daysPastDue <= 45) {
                        underwritingLevelData[key].days_1_45++;
                    } else if (daysPastDue >= 46 && daysPastDue <= 60) {
                        underwritingLevelData[key].days_46_60++;
                    } else if (daysPastDue >= 61 && daysPastDue <= 90) {
                        underwritingLevelData[key].days_61_90++;
                    } else if (daysPastDue > 90) {
                        underwritingLevelData[key].days_90_plus++;
                    }
                }
                underwritingLevelData[key].total++;
            });
            
            // Convert to arrays and sort
            Object.keys(regionalData).forEach(region => {
                regionalData[region].facilityCount = regionalData[region].facilities.size;
            });
            
            const topProducts = Object.entries(productData)
                .map(([name, data]) => ({name, count: data.count, facilities: data.facilities.size}))
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);
            
            const categories = Object.entries(categoryData)
                .map(([name, data]) => ({name, count: data.count, facilities: data.facilities.size}))
                .sort((a, b) => b.count - a.count);
            
            // Convert underwriting level data to array and sort by total, then take top 10
            const topUnderwritingLevel = Object.values(underwritingLevelData)
                .sort((a, b) => b.total - a.total)
                .slice(0, 10);
            
            const totalFacilities = new Set();
            currentViewData.forEach(row => {
                const facilityId = row.Facility_Number || row.Facility_ID;
                if (facilityId) totalFacilities.add(facilityId);
            });
            
            // Count opposite view for comparison
            const oppositeFacilities = new Set();
            oppositeViewData.forEach(row => {
                const facilityId = row.Facility_Number || row.Facility_ID;
                if (facilityId) oppositeFacilities.add(facilityId);
            });
            
            // Store expanded data
            window.covenantExpandedData = {
                regional: regionalData,
                categories: isPastDue ? categories : topProducts,
                underwritingLevel: topUnderwritingLevel,
                isPastDue: isPastDue,
                currentViewData: currentViewData,
                oppositeViewData: oppositeViewData,
                totalFacilities: totalFacilities.size,
                oppositeFacilities: oppositeFacilities.size
            };
            
            // Directly render the views
            renderCovenantExpandedViews();
        }
        
        // Initialize CCM Chart - processes data and renders
        function initializeCCMChart(dataSource) {
            // For now, use the embedded script approach (to be refactored later)
            setTimeout(() => {
                if (window.ccmExpandedData) renderCCMExpandedViews();
            }, 150);
        }
        
        // Placeholder functions for other chart types (to be implemented similarly)
        function generateOSUCExpandedView(dataSource) {
            // Calculate OSUC metrics matching TFA structure
            const totalOSUC = dataSource.reduce((sum, row) => sum + parseNumber(row.OSUC), 0);
            const totalRelationships = new Set(dataSource.map(r => r.Relationship_Name || r.Relationship_ID).filter(Boolean)).size;
            const totalFacilities = new Set(dataSource.map(r => r.Facility_ID).filter(Boolean)).size;
            const avgOSUCPerRelationship = totalRelationships > 0 ? totalOSUC / totalRelationships : 0;
            
            // Find largest single facility
            let largestFacility = 0;
            dataSource.forEach(row => {
                const amount = parseNumber(row.OSUC);
                if (amount > largestFacility) largestFacility = amount;
            });
            
            // Calculate concentration (top 10 relationships as % of total)
            const byRelationship = {};
            dataSource.forEach(row => {
                const rel = row.Relationship_Name || row.Relationship_ID || 'Unknown';
                if (!byRelationship[rel]) byRelationship[rel] = 0;
                byRelationship[rel] += parseNumber(row.OSUC);
            });
            const top10Total = Object.values(byRelationship)
                .sort((a, b) => b - a)
                .slice(0, 10)
                .reduce((sum, val) => sum + val, 0);
            const concentrationPct = totalOSUC > 0 ? (top10Total / totalOSUC * 100) : 0;
            
            // Group by Client (Relationship)
            const byClient = {};
            dataSource.forEach(row => {
                const client = row.Relationship_Name || row.Relationship_ID || 'Unknown';
                if (!byClient[client]) byClient[client] = 0;
                byClient[client] += parseNumber(row.OSUC);
            });
            
            // Group by Product Program
            const byProgram = {};
            dataSource.forEach(row => {
                const program = row.Product_Program || 'Unknown';
                if (!byProgram[program]) byProgram[program] = 0;
                byProgram[program] += parseNumber(row.OSUC);
            });
            
            // Get Top 10 clients
            const topClients = Object.entries(byClient)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            // Get all programs sorted
            const sortedPrograms = Object.entries(byProgram)
                .sort((a, b) => b[1] - a[1]);
            
            // Group by Underwriter for detailed table
            const detailedData = {};
            dataSource.forEach(row => {
                const underwriter = row.Lead_Underwriter || 'Unknown';
                const region = row.Region || 'Unknown';
                
                if (!detailedData[underwriter]) {
                    detailedData[underwriter] = {
                        underwriter,
                        region,
                        osuc: 0,
                        facilities: new Set(),
                        relationships: new Set()
                    };
                }
                
                detailedData[underwriter].osuc += parseNumber(row.OSUC);
                if (row.Facility_ID) detailedData[underwriter].facilities.add(row.Facility_ID);
                if (row.Relationship_Name || row.Relationship_ID) {
                    detailedData[underwriter].relationships.add(row.Relationship_Name || row.Relationship_ID);
                }
            });
            
            const tableRows = Object.values(detailedData)
                .sort((a, b) => b.osuc - a.osuc)
                .slice(0, 10); // Top 10 underwriters
            
            return `
                <!-- Key Metrics Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="rounded-xl border border-gray-200 bg-white p-5 flex flex-col">
                        <div class="flex items-start gap-3 flex-1">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-blue-100">
                                <svg class="h-5 w-5 shrink-0 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Total OSUC</p>
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 text-center mt-3">${formatCurrency(totalOSUC)}</h3>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5 flex flex-col">
                        <div class="flex items-start gap-3 flex-1">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-green-100">
                                <svg class="h-5 w-5 shrink-0 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Avg OSUC / Relationship</p>
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 text-center mt-3">${formatCurrency(avgOSUCPerRelationship)}</h3>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5 flex flex-col">
                        <div class="flex items-start gap-3 flex-1">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-orange-100">
                                <svg class="h-5 w-5 shrink-0 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Largest Facility OSUC</p>
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 text-center mt-3">${formatCurrency(largestFacility)}</h3>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5 flex flex-col">
                        <div class="flex items-start gap-3 flex-1">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-purple-100">
                                <svg class="h-5 w-5 shrink-0 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Top 10 Concentration by OSUC</p>
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 text-center mt-3">${concentrationPct.toFixed(1)}%</h3>
                    </div>
                </div>
                
                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Regional Distribution Map -->
                    <div class="rounded-xl border border-gray-200 bg-white">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">Regional Distribution</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">OSUC distribution by region</p>
                        </div>
                        <div class="p-5">
                            <div class="border-gray-200 my-6 overflow-hidden rounded-2xl border bg-gray-50 px-4 py-6">
                                <div id="osucRegionalMap" class="map-btn h-[150px] w-full"></div>
                            </div>
                            <div id="osucRegionalList" class="space-y-5">
                                <!-- Regional items will be dynamically generated -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- OSUC by Product Program - Donut Chart with Legends -->
                    <div class="rounded-xl border border-gray-200 bg-white">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">OSUC by Product Program</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">Distribution across product programs</p>
                        </div>
                        <div class="p-6 flex items-center justify-center" style="min-height: 400px;">
                            <div class="flex flex-row items-center justify-center gap-8">
                                <!-- Donut Chart -->
                                <div class="flex-shrink-0">
                                    <div id="osucProgramDonutChart"></div>
                                </div>
                                
                                <!-- Legend / Details List - Right Side -->
                                <div class="flex-1 max-w-md">
                                    <div id="osucProgramList" class="space-y-3">
                                        ${sortedPrograms.map(([program, amount], index) => {
                                            const colors = ["#3641f5", "#7592ff", "#dde9ff", "#ff6b6b", "#ffd93d", "#6bcf7f", "#c084fc"];
                                            const color = colors[index % colors.length];
                                            const formattedAmount = amount >= 1000000000 
                                                ? `$${(amount / 1000000000).toFixed(2)}B`
                                                : `$${(amount / 1000000).toFixed(1)}M`;
                                            // Calculate percentage
                                            const percentage = ((amount / totalOSUC) * 100).toFixed(1);
                                            return `
                                                <div class="flex items-center gap-3 py-2">
                                                    <div class="w-4 h-4 rounded-sm flex-shrink-0" style="background-color: ${color};"></div>
                                                    <p class="text-sm font-medium text-gray-800 flex-1">${program}</p>
                                                    <p class="text-sm font-semibold text-gray-900">${formattedAmount} <span class="text-gray-500 font-normal"> ${percentage}%</span></p>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Table -->
                <div class="rounded-2xl border border-gray-200 bg-white mt-6">
                    <div class="px-6 py-4">
                        <h3 class="text-lg font-semibold text-gray-800">OSUC by Underwriter (Top 10)</h3>
                        <p class="text-sm font-medium text-gray-500 mt-1">Underwriter portfolio breakdown</p>
                    </div>
                    <div class="custom-scrollbar overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Underwriter</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Region</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">OSUC</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Share %</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Facilities</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Relationships</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${tableRows.map(row => {
                                    const sharePct = totalOSUC > 0 ? (row.osuc / totalOSUC * 100) : 0;
                                    const regionColors = {
                                        'APAC': 'bg-blue-50 text-blue-600',
                                        'EMEA': 'bg-green-50 text-green-600',
                                        'NAM': 'bg-orange-50 text-orange-600',
                                        'LATAM': 'bg-purple-50 text-purple-600'
                                    };
                                    const regionColor = regionColors[row.region] || 'bg-gray-50 text-gray-600';
                                    
                                    return `
                                        <tr>
                                            <td class="px-6 py-4 text-center text-sm font-medium text-gray-900">${row.underwriter}</td>
                                            <td class="px-6 py-4 text-center">
                                                <span class="${regionColor} rounded-full px-2 py-0.5 text-xs font-medium">
                                                    ${row.region}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 text-center text-sm whitespace-nowrap text-gray-700">${formatCurrency(row.osuc)}</td>
                                            <td class="px-6 py-4 text-center">
                                                <div class="flex items-center justify-center gap-2">
                                                    <div class="flex-1 min-w-[80px] max-w-[120px]">
                                                        <div class="relative w-full h-2 bg-gray-100 rounded-full overflow-hidden">
                                                            <div class="absolute top-0 left-0 h-full bg-blue-500 rounded-full transition-all duration-300" style="width: ${Math.min(sharePct, 100)}%"></div>
                                                        </div>
                                                    </div>
                                                    <span class="text-xs font-semibold text-gray-700 min-w-[40px]">${sharePct.toFixed(1)}%</span>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                <span class="bg-gray-100 text-gray-700 rounded-full px-2 py-0.5 text-xs font-medium">
                                                    ${row.facilities.size}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                <span class="bg-blue-100 text-blue-700 rounded-full px-2 py-0.5 text-xs font-medium">
                                                    ${row.relationships.size}
                                                </span>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        function generateOutstandingExpandedView(dataSource) {
            // Calculate Outstanding metrics matching TFA structure
            const totalOS = dataSource.reduce((sum, row) => sum + parseNumber(row.Total_OS), 0);
            const totalRelationships = new Set(dataSource.map(r => r.Relationship_Name || r.Relationship_ID).filter(Boolean)).size;
            const totalFacilities = new Set(dataSource.map(r => r.Facility_ID).filter(Boolean)).size;
            const avgOSPerRelationship = totalRelationships > 0 ? totalOS / totalRelationships : 0;
            
            // Find largest single facility
            let largestFacility = 0;
            dataSource.forEach(row => {
                const amount = parseNumber(row.Total_OS);
                if (amount > largestFacility) largestFacility = amount;
            });
            
            // Calculate concentration (top 10 relationships as % of total)
            const byRelationship = {};
            dataSource.forEach(row => {
                const rel = row.Relationship_Name || row.Relationship_ID || 'Unknown';
                if (!byRelationship[rel]) byRelationship[rel] = 0;
                byRelationship[rel] += parseNumber(row.Total_OS);
            });
            const top10Total = Object.values(byRelationship)
                .sort((a, b) => b - a)
                .slice(0, 10)
                .reduce((sum, val) => sum + val, 0);
            const concentrationPct = totalOS > 0 ? (top10Total / totalOS * 100) : 0;
            
            // Group by Client (Relationship)
            const byClient = {};
            dataSource.forEach(row => {
                const client = row.Relationship_Name || row.Relationship_ID || 'Unknown';
                if (!byClient[client]) byClient[client] = 0;
                byClient[client] += parseNumber(row.Total_OS);
            });
            
            // Group by Product Program
            const byProgram = {};
            dataSource.forEach(row => {
                const program = row.Product_Program || 'Unknown';
                if (!byProgram[program]) byProgram[program] = 0;
                byProgram[program] += parseNumber(row.Total_OS);
            });
            
            // Get Top 10 clients
            const topClients = Object.entries(byClient)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            // Get all programs sorted
            const sortedPrograms = Object.entries(byProgram)
                .sort((a, b) => b[1] - a[1]);
            
            // Group by Underwriter for detailed table
            const detailedData = {};
            dataSource.forEach(row => {
                const underwriter = row.Lead_Underwriter || 'Unknown';
                const region = row.Region || 'Unknown';
                
                if (!detailedData[underwriter]) {
                    detailedData[underwriter] = {
                        underwriter,
                        region,
                        os: 0,
                        facilities: new Set(),
                        relationships: new Set()
                    };
                }
                
                detailedData[underwriter].os += parseNumber(row.Total_OS);
                if (row.Facility_ID) detailedData[underwriter].facilities.add(row.Facility_ID);
                if (row.Relationship_Name || row.Relationship_ID) {
                    detailedData[underwriter].relationships.add(row.Relationship_Name || row.Relationship_ID);
                }
            });
            
            const tableRows = Object.values(detailedData)
                .sort((a, b) => b.os - a.os)
                .slice(0, 10); // Top 10 underwriters
            
            return `
                <!-- Key Metrics Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="rounded-xl border border-gray-200 bg-white p-5 flex flex-col">
                        <div class="flex items-start gap-3 flex-1">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-blue-100">
                                <svg class="h-5 w-5 shrink-0 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Total Outstanding</p>
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 text-center mt-3">${formatCurrency(totalOS)}</h3>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5 flex flex-col">
                        <div class="flex items-start gap-3 flex-1">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-green-100">
                                <svg class="h-5 w-5 shrink-0 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Avg OS / Relationship</p>
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 text-center mt-3">${formatCurrency(avgOSPerRelationship)}</h3>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5 flex flex-col">
                        <div class="flex items-start gap-3 flex-1">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-orange-100">
                                <svg class="h-5 w-5 shrink-0 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Largest Facility Outstanding</p>
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 text-center mt-3">${formatCurrency(largestFacility)}</h3>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5 flex flex-col">
                        <div class="flex items-start gap-3 flex-1">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-purple-100">
                                <svg class="h-5 w-5 shrink-0 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Top 10 Concentration by Outstanding</p>
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 text-center mt-3">${concentrationPct.toFixed(1)}%</h3>
                    </div>
                </div>
                
                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Regional Distribution Map -->
                    <div class="rounded-xl border border-gray-200 bg-white">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">Regional Distribution</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">Outstanding distribution by region</p>
                        </div>
                        <div class="p-5">
                            <div class="border-gray-200 my-6 overflow-hidden rounded-2xl border bg-gray-50 px-4 py-6">
                                <div id="outstandingRegionalMap" class="map-btn h-[150px] w-full"></div>
                            </div>
                            <div id="outstandingRegionalList" class="space-y-5">
                                <!-- Regional items will be dynamically generated -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Outstanding by Product Program - Donut Chart with Legends -->
                    <div class="rounded-xl border border-gray-200 bg-white">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">Outstanding by Product Program</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">Distribution across product programs</p>
                        </div>
                        <div class="p-6 flex items-center justify-center" style="min-height: 400px;">
                            <div class="flex flex-row items-center justify-center gap-8">
                                <!-- Donut Chart -->
                                <div class="flex-shrink-0">
                                    <div id="outstandingProgramDonutChart"></div>
                                </div>
                                
                                <!-- Legend / Details List - Right Side -->
                                <div class="flex-1 max-w-md">
                                    <div id="outstandingProgramList" class="space-y-3">
                                        ${sortedPrograms.map(([program, amount], index) => {
                                            const colors = ["#3641f5", "#7592ff", "#dde9ff", "#ff6b6b", "#ffd93d", "#6bcf7f", "#c084fc"];
                                            const color = colors[index % colors.length];
                                            const formattedAmount = amount >= 1000000000 
                                                ? `$${(amount / 1000000000).toFixed(2)}B`
                                                : `$${(amount / 1000000).toFixed(1)}M`;
                                            // Calculate percentage
                                            const percentage = ((amount / totalOS) * 100).toFixed(1);
                                            return `
                                                <div class="flex items-center gap-3 py-2">
                                                    <div class="w-4 h-4 rounded-sm flex-shrink-0" style="background-color: ${color};"></div>
                                                    <p class="text-sm font-medium text-gray-800 flex-1">${program}</p>
                                                    <p class="text-sm font-semibold text-gray-900">${formattedAmount} <span class="text-gray-500 font-normal"> ${percentage}%</span></p>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Table -->
                <div class="rounded-2xl border border-gray-200 bg-white mt-6">
                    <div class="px-6 py-4">
                        <h3 class="text-lg font-semibold text-gray-800">Outstanding by Underwriter (Top 10)</h3>
                        <p class="text-sm font-medium text-gray-500 mt-1">Underwriter portfolio breakdown</p>
                    </div>
                    <div class="custom-scrollbar overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Underwriter</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Region</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Outstanding</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Share %</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Facilities</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Relationships</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${tableRows.map(row => {
                                    const sharePct = totalOS > 0 ? (row.os / totalOS * 100) : 0;
                                    const regionColors = {
                                        'APAC': 'bg-blue-50 text-blue-600',
                                        'EMEA': 'bg-green-50 text-green-600',
                                        'NAM': 'bg-orange-50 text-orange-600',
                                        'LATAM': 'bg-purple-50 text-purple-600'
                                    };
                                    const regionColor = regionColors[row.region] || 'bg-gray-50 text-gray-600';
                                    
                                    return `
                                        <tr>
                                            <td class="px-6 py-4 text-center text-sm font-medium text-gray-900">${row.underwriter}</td>
                                            <td class="px-6 py-4 text-center">
                                                <span class="${regionColor} rounded-full px-2 py-0.5 text-xs font-medium">
                                                    ${row.region}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 text-center text-sm whitespace-nowrap text-gray-700">${formatCurrency(row.os)}</td>
                                            <td class="px-6 py-4 text-center">
                                                <div class="flex items-center justify-center gap-2">
                                                    <div class="flex-1 min-w-[80px] max-w-[120px]">
                                                        <div class="relative w-full h-2 bg-gray-100 rounded-full overflow-hidden">
                                                            <div class="absolute top-0 left-0 h-full bg-blue-500 rounded-full transition-all duration-300" style="width: ${Math.min(sharePct, 100)}%"></div>
                                                        </div>
                                                    </div>
                                                    <span class="text-xs font-semibold text-gray-700 min-w-[40px]">${sharePct.toFixed(1)}%</span>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                <span class="bg-gray-100 text-gray-700 rounded-full px-2 py-0.5 text-xs font-medium">
                                                    ${row.facilities.size}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                <span class="bg-blue-100 text-blue-700 rounded-full px-2 py-0.5 text-xs font-medium">
                                                    ${row.relationships.size}
                                                </span>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function generateFacilitiesExpandedView(dataSource) {
            return `
                <div class="flex items-center justify-center min-h-[400px]">
                    <div class="text-center">
                        <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-blue-50 mb-4">
                            <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 mb-2">Coming Soon</h3>
                        <p class="text-gray-500 mb-1">Facilities expanded analytics are under development</p>
                        <p class="text-sm text-gray-400">We're working on bringing you comprehensive insights and detailed charts</p>
                    </div>
                </div>
            `;
        }
        
        function generateFacilitiesExpandedView_ORIGINAL(dataSource) {
            // Calculate facility metrics
            const totalFacilities = new Set(dataSource.map(row => row.Facility_ID)).size;
            const committedFacilities = dataSource.filter(row => 
                (row.Committed_Uncommitted || '').toUpperCase() === 'COMMITTED'
            ).length;
            const uncommittedFacilities = totalFacilities - committedFacilities;
            const avgFacilitySize = dataSource.reduce((sum, row) => sum + parseNumber(row.Fac_Amount), 0) / totalFacilities;
            
            // Calculate expired facilities and CAs
            const today = new Date();
            const expiredFacilities = dataSource.filter(row => {
                const maturityDate = parseDate(row.Maturity_Date);
                return maturityDate && maturityDate < today;
            }).length;
            
            const expiredCAs = dataSource.filter(row => {
                const caDate = parseDate(row.CA_Expiration_Date);
                return caDate && caDate < today;
            }).length;
            
            // Count facilities maturing in next 12 months
            const next12Months = new Date(today);
            next12Months.setMonth(today.getMonth() + 12);
            
            const maturingSoon = dataSource.filter(row => {
                const maturityDate = parseDate(row.Maturity_Date);
                return maturityDate && maturityDate >= today && maturityDate <= next12Months;
            }).length;
            
            // By Facility Type
            const byType = {};
            dataSource.forEach(row => {
                const type = row.Facility_Type || 'Unknown';
                if (!byType[type]) {
                    byType[type] = { count: 0, totalAmount: 0 };
                }
                byType[type].count++;
                byType[type].totalAmount += parseNumber(row.Fac_Amount);
            });
            
            const topTypes = Object.entries(byType)
                .map(([type, data]) => ({ type, ...data }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);
            
            // By Region and Committed/Uncommitted
            const regions = ['APAC', 'EMEA', 'NAM', 'LATAM'];
            const committedByRegion = {};
            const uncommittedByRegion = {};
            
            regions.forEach(region => {
                committedByRegion[region] = 0;
                uncommittedByRegion[region] = 0;
            });
            
            dataSource.forEach(row => {
                const region = (row.Region || '').toUpperCase();
                const isCommitted = (row.Committed_Uncommitted || '').toUpperCase() === 'COMMITTED';
                
                if (regions.includes(region)) {
                    if (isCommitted) {
                        committedByRegion[region]++;
                    } else {
                        uncommittedByRegion[region]++;
                    }
                }
            });
            
            // By Underwriter (Top 10)
            const byUnderwriter = {};
            dataSource.forEach(row => {
                const underwriter = row.Lead_Underwriter || 'Unknown';
                const region = row.Region || 'Unknown';
                
                if (!byUnderwriter[underwriter]) {
                    byUnderwriter[underwriter] = {
                        name: underwriter,
                        region: region,
                        facilities: 0,
                        totalTFA: 0,
                        expired: 0,
                        expiredCAs: 0,
                        maturingSoon: 0
                    };
                }
                
                byUnderwriter[underwriter].facilities++;
                byUnderwriter[underwriter].totalTFA += parseNumber(row.Fac_Amount);
                
                // Check if facility is expired
                const maturityDate = parseDate(row.Maturity_Date);
                if (maturityDate && maturityDate < today) {
                    byUnderwriter[underwriter].expired++;
                }
                
                // Check if CA is expired
                const caDate = parseDate(row.CA_Expiration_Date);
                if (caDate && caDate < today) {
                    byUnderwriter[underwriter].expiredCAs++;
                }
                
                // Check if maturing soon
                if (maturityDate && maturityDate >= today && maturityDate <= next12Months) {
                    byUnderwriter[underwriter].maturingSoon++;
                }
            });
            
            const topUnderwriters = Object.values(byUnderwriter)
                .sort((a, b) => b.facilities - a.facilities)
                .slice(0, 10);
            
            return `
                <!-- Key Metrics Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-green-100">
                                <svg class="h-5 w-5 shrink-0 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Committed</p>
                                <h3 class="text-2xl font-bold text-gray-900">${committedFacilities}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">${totalFacilities > 0 ? ((committedFacilities / totalFacilities * 100).toFixed(1)) : 0}% of Total</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-red-100">
                                <svg class="h-5 w-5 shrink-0 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Expired Facilities</p>
                                <h3 class="text-2xl font-bold text-gray-900">${expiredFacilities}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">Past Maturity</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-orange-100">
                                <svg class="h-5 w-5 shrink-0 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Expired CAs</p>
                                <h3 class="text-2xl font-bold text-gray-900">${expiredCAs}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">Past CA Expiration</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-amber-100">
                                <svg class="h-5 w-5 shrink-0 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Maturing Soon</p>
                                <h3 class="text-2xl font-bold text-gray-900">${maturingSoon}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">Next 12 Months</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Facilities by Region (Committed vs Uncommitted) -->
                    <div class="rounded-2xl border border-gray-200 bg-white px-5 pt-5 sm:px-6 sm:pt-6">
                        <div class="flex flex-wrap items-start justify-between gap-5 mb-6">
                            <div>
                                <h3 class="mb-1 text-lg font-semibold text-gray-800">Facilities by Region</h3>
                                <span class="block text-sm text-gray-500">Committed vs Uncommitted split</span>
                            </div>
                        </div>
                        <div id="facilitiesRegionChart" style="height: 300px;"></div>
                    </div>
                    
                    <!-- Top Facility Types -->
                    <div class="rounded-2xl border border-gray-200 bg-white px-5 pt-5 sm:px-6 sm:pt-6">
                        <div class="flex flex-wrap items-start justify-between gap-5 mb-6">
                            <div>
                                <h3 class="mb-1 text-lg font-semibold text-gray-800">Top Facility Types</h3>
                                <span class="block text-sm text-gray-500">By facility count</span>
                            </div>
                        </div>
                        <div id="facilitiesTypeChart" style="height: 300px;"></div>
                    </div>
                </div>
                
                <!-- Detailed Table by Underwriter -->
                <div class="rounded-2xl border border-gray-200 bg-white mt-6">
                    <div class="px-6 py-4">
                        <h3 class="text-lg font-semibold text-gray-800">Facilities by Underwriter (Top 10)</h3>
                        <p class="text-sm font-medium text-gray-500 mt-1">Facility counts with expired facilities and CAs details</p>
                    </div>
                    <div class="custom-scrollbar overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Underwriter</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Region</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Total Facilities</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Total TFA</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Expired<br><span class="whitespace-nowrap">Facilities</span></th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Expired<br><span class="whitespace-nowrap">CAs</span></th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Maturing<br><span class="whitespace-nowrap">(12m)</span></th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${topUnderwriters.map(uw => {
                                    const regionColor = {
                                        'APAC': 'bg-blue-100 text-blue-700',
                                        'EMEA': 'bg-green-100 text-green-700',
                                        'NAM': 'bg-purple-100 text-purple-700',
                                        'LATAM': 'bg-orange-100 text-orange-700'
                                    }[uw.region] || 'bg-gray-100 text-gray-700';
                                    
                                    return `
                                        <tr>
                                            <td class="px-6 py-4 text-center text-sm font-medium text-gray-900">${uw.name}</td>
                                            <td class="px-6 py-4 text-center">
                                                <span class="inline-flex items-center justify-center rounded-full ${regionColor} px-2.5 py-0.5 text-xs font-medium">
                                                    ${uw.region}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                <span class="inline-flex items-center justify-center rounded-full bg-gray-100 px-3 py-1 text-sm font-medium text-gray-700">
                                                    ${uw.facilities}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 text-center text-sm whitespace-nowrap font-semibold text-gray-900">${formatCurrency(uw.totalTFA)}</td>
                                            <td class="px-6 py-4 text-center">
                                                ${uw.expired > 0 ? 
                                                    `<span class="inline-flex items-center justify-center rounded-full bg-red-100 px-3 py-1 text-sm font-medium text-red-700">${uw.expired}</span>` :
                                                    `<span class="text-sm text-gray-400"></span>`
                                                }
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                ${uw.expiredCAs > 0 ? 
                                                    `<span class="inline-flex items-center justify-center rounded-full bg-orange-100 px-3 py-1 text-sm font-medium text-orange-700">${uw.expiredCAs}</span>` :
                                                    `<span class="text-sm text-gray-400"></span>`
                                                }
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                ${uw.maturingSoon > 0 ? 
                                                    `<span class="inline-flex items-center justify-center rounded-full bg-amber-100 px-3 py-1 text-sm font-medium text-amber-700">${uw.maturingSoon}</span>` :
                                                    `<span class="text-sm text-gray-400"></span>`
                                                }
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function generateRelationshipsExpandedView(dataSource) {
            return `
                <div class="flex items-center justify-center min-h-[400px]">
                    <div class="text-center">
                        <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-blue-50 mb-4">
                            <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 mb-2">Coming Soon</h3>
                        <p class="text-gray-500 mb-1">Relationships expanded analytics are under development</p>
                        <p class="text-sm text-gray-400">We're working on bringing you comprehensive insights and detailed charts</p>
                    </div>
                </div>
            `;
        }
        
        function generateRelationshipsExpandedView_ORIGINAL(dataSource) {
            // Calculate relationship metrics using Relationship_ID for uniqueness
            const relationshipMap = {};
            
            dataSource.forEach(row => {
                const relId = row.Relationship_ID || 'Unknown';
                const relName = row.Relationship_Name || relId;
                
                if (!relationshipMap[relId]) {
                    relationshipMap[relId] = {
                        id: relId,
                        name: relName,
                        facilities: new Set(),
                        totalTFA: 0,
                        totalOS: 0,
                        regions: new Set(),
                        products: new Set()
                    };
                }
                
                relationshipMap[relId].facilities.add(row.Facility_ID);
                relationshipMap[relId].totalTFA += parseNumber(row.Fac_Amount);
                relationshipMap[relId].totalOS += parseNumber(row.Total_OS);
                if (row.Region) relationshipMap[relId].regions.add(row.Region);
                if (row.Product_Program) relationshipMap[relId].products.add(row.Product_Program);
            });
            
            const relationships = Object.values(relationshipMap);
            const totalRelationships = relationships.length;
            
            // Calculate metrics
            const totalFacilities = dataSource.length;
            const avgFacilitiesPerRel = totalFacilities / totalRelationships;
            
            const totalTFA = relationships.reduce((sum, rel) => sum + rel.totalTFA, 0);
            const avgTFAPerRel = totalTFA / totalRelationships;
            
            // Multi-region relationships
            const multiRegionRels = relationships.filter(rel => rel.regions.size > 1).length;
            
            // Multi-product relationships
            const multiProductRels = relationships.filter(rel => rel.products.size > 1).length;
            
            // By Region
            const byRegion = {};
            const regions = ['APAC', 'EMEA', 'NAM', 'LATAM'];
            regions.forEach(region => {
                byRegion[region] = new Set();
            });
            
            dataSource.forEach(row => {
                const region = (row.Region || '').toUpperCase();
                const relId = row.Relationship_ID;
                if (regions.includes(region) && relId) {
                    byRegion[region].add(relId);
                }
            });
            
            const regionData = regions.map(region => byRegion[region].size);
            
            // Relationship concentration - Top 10
            const topRelationships = relationships
                .sort((a, b) => b.totalTFA - a.totalTFA)
                .slice(0, 10);
            
            const top10TFA = topRelationships.reduce((sum, rel) => sum + rel.totalTFA, 0);
            const concentrationPct = totalTFA > 0 ? (top10TFA / totalTFA * 100) : 0;
            
            // By Underwriter (Top 10)
            const byUnderwriter = {};
            dataSource.forEach(row => {
                const underwriter = row.Lead_Underwriter || 'Unknown';
                const region = row.Region || 'Unknown';
                const relId = row.Relationship_ID;
                
                if (!byUnderwriter[underwriter]) {
                    byUnderwriter[underwriter] = {
                        name: underwriter,
                        region: region,
                        relationships: new Set(),
                        facilities: 0,
                        totalTFA: 0,
                        totalOS: 0
                    };
                }
                
                if (relId) {
                    byUnderwriter[underwriter].relationships.add(relId);
                }
                byUnderwriter[underwriter].facilities++;
                byUnderwriter[underwriter].totalTFA += parseNumber(row.Fac_Amount);
                byUnderwriter[underwriter].totalOS += parseNumber(row.Total_OS);
            });
            
            const topUnderwriters = Object.values(byUnderwriter)
                .sort((a, b) => b.relationships.size - a.relationships.size)
                .slice(0, 10);
            
            return `
                <!-- Key Metrics Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-blue-100">
                                <svg class="h-5 w-5 shrink-0 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Avg Facilities</p>
                                <h3 class="text-2xl font-bold text-gray-900">${avgFacilitiesPerRel.toFixed(1)}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">Per Relationship</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-green-100">
                                <svg class="h-5 w-5 shrink-0 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Avg TFA</p>
                                <h3 class="text-2xl font-bold text-gray-900">${formatCurrency(avgTFAPerRel)}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">Per Relationship</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-purple-100">
                                <svg class="h-5 w-5 shrink-0 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Multi-Region</p>
                                <h3 class="text-2xl font-bold text-gray-900">${multiRegionRels}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">${totalRelationships > 0 ? ((multiRegionRels / totalRelationships * 100).toFixed(1)) : 0}% of Total</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-orange-100">
                                <svg class="h-5 w-5 shrink-0 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Multi-Product</p>
                                <h3 class="text-2xl font-bold text-gray-900">${multiProductRels}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">${totalRelationships > 0 ? ((multiProductRels / totalRelationships * 100).toFixed(1)) : 0}% of Total</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Relationships by Region -->
                    <div class="rounded-2xl border border-gray-200 bg-white px-5 pt-5 sm:px-6 sm:pt-6">
                        <div class="flex flex-wrap items-start justify-between gap-5 mb-6">
                            <div>
                                <h3 class="mb-1 text-lg font-semibold text-gray-800">Relationships by Region</h3>
                                <span class="block text-sm text-gray-500">Unique relationship count per region</span>
                            </div>
                        </div>
                        <div id="relationshipsRegionChart" style="height: 300px;"></div>
                    </div>
                    
                    <!-- Top 10 Concentration -->
                    <div class="rounded-2xl border border-gray-200 bg-white px-5 pt-5 sm:px-6 sm:pt-6">
                        <div class="flex flex-wrap items-start justify-between gap-5 mb-6">
                            <div>
                                <h3 class="mb-1 text-lg font-semibold text-gray-800">Top 10 Concentration</h3>
                                <span class="block text-sm text-gray-500">TFA share of top 10 relationships</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-center" style="height: 300px;">
                            <div class="text-center">
                                <div class="relative inline-flex items-center justify-center">
                                    <svg class="w-48 h-48 transform -rotate-90">
                                        <circle cx="96" cy="96" r="80" stroke="#E5E7EB" stroke-width="16" fill="none"/>
                                        <circle cx="96" cy="96" r="80" stroke="#3b82f6" stroke-width="16" fill="none"
                                            stroke-dasharray="${(concentrationPct / 100) * 502.65} 502.65"
                                            stroke-linecap="round"/>
                                    </svg>
                                    <div class="absolute">
                                        <div class="text-4xl font-bold text-gray-900">${concentrationPct.toFixed(1)}%</div>
                                        <div class="text-sm text-gray-500 mt-1">of Total TFA</div>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-600 mt-4">${formatCurrency(top10TFA)} from Top 10</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Table by Underwriter -->
                <div class="rounded-2xl border border-gray-200 bg-white mt-6">
                    <div class="px-6 py-4">
                        <h3 class="text-lg font-semibold text-gray-800">Relationships by Underwriter (Top 10)</h3>
                        <p class="text-sm font-medium text-gray-500 mt-1">Relationship counts with facilities and exposure details</p>
                    </div>
                    <div class="custom-scrollbar overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Underwriter</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Region</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Relationships</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Facilities</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Total TFA</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Total OS</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Utilization</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${topUnderwriters.map(uw => {
                                    const utilization = uw.totalTFA > 0 ? (uw.totalOS / uw.totalTFA * 100) : 0;
                                    const regionColor = {
                                        'APAC': 'bg-blue-100 text-blue-700',
                                        'EMEA': 'bg-green-100 text-green-700',
                                        'NAM': 'bg-purple-100 text-purple-700',
                                        'LATAM': 'bg-orange-100 text-orange-700'
                                    }[uw.region] || 'bg-gray-100 text-gray-700';
                                    
                                    return `
                                        <tr>
                                            <td class="px-6 py-4 text-center text-sm font-medium text-gray-900">${uw.name}</td>
                                            <td class="px-6 py-4 text-center">
                                                <span class="inline-flex items-center justify-center rounded-full ${regionColor} px-2.5 py-0.5 text-xs font-medium">
                                                    ${uw.region}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                <span class="inline-flex items-center justify-center rounded-full bg-blue-100 px-3 py-1 text-sm font-medium text-blue-700">
                                                    ${uw.relationships.size}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                <span class="inline-flex items-center justify-center rounded-full bg-gray-100 px-3 py-1 text-sm font-medium text-gray-700">
                                                    ${uw.facilities}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 text-center text-sm whitespace-nowrap font-semibold text-gray-900">${formatCurrency(uw.totalTFA)}</td>
                                            <td class="px-6 py-4 text-center text-sm whitespace-nowrap text-gray-700">${formatCurrency(uw.totalOS)}</td>
                                            <td class="px-6 py-4 text-center">
                                                <div class="flex items-center gap-2 justify-center">
                                                    <div class="w-20">
                                                        <div class="relative w-full h-2 bg-gray-100 rounded-full overflow-hidden">
                                                            <div class="absolute top-0 left-0 h-full bg-green-500 rounded-full" style="width: ${Math.min(utilization, 100)}%"></div>
                                                        </div>
                                                    </div>
                                                    <span class="text-sm font-semibold text-gray-700 w-12">${utilization.toFixed(1)}%</span>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        function generateExpiringExpandedView(dataSource) {
            // NOTE: This function only generates the HTML structure
            // The actual data processing and chart rendering is done by initializeExpiringChart()
            // which is called after this HTML is inserted into the DOM
            
            // State for filter (default to 'facilities', no 'both' option)
            const filterState = window.expiringFilterState || 'facilities';
            
            // Apply all active filters to dataSource (for KPI calculations only)
            const filteredDataSource = applyAllFilters(dataSource);
            
            // Get report date
            const reportDates = filteredDataSource.map(row => parseDate(row.Report_Date)).filter(d => d);
            const maxReportDate = reportDates.length > 0 ? new Date(Math.max(...reportDates)) : new Date();
            maxReportDate.setHours(0, 0, 0, 0);
            
            // Calculate date ranges for next 3 months
            const next3Months = [];
            for (let i = 0; i < 3; i++) {
                const date = new Date(maxReportDate);
                date.setMonth(date.getMonth() + i);
                next3Months.push({
                    year: date.getFullYear(),
                    month: date.getMonth(),
                    label: date.toLocaleDateString("en-US", { month: "short", year: "numeric" })
                });
            }
            
            // Current month for expired items - but we'll show ALL expired before report date
            const currentYear = maxReportDate.getFullYear();
            const currentMonth = maxReportDate.getMonth();
            
            // Collect CA and Facility data
            const caData = {
                expiring: { relationships: new Set(), tfa: 0, count: 0 },
                expired: { relationships: new Set(), tfa: 0, count: 0 },
                byMonth: {}
            };
            
            const facilityData = {
                expiring: { facilities: new Set(), tfa: 0, count: 0 },
                expired: { facilities: new Set(), tfa: 0, count: 0 },
                byMonth: {}
            };
            
            // Initialize month data
            next3Months.forEach(m => {
                const key = `${m.year}-${String(m.month + 1).padStart(2, '0')}`;
                caData.byMonth[key] = { relationships: new Set(), tfa: 0 };
                facilityData.byMonth[key] = { facilities: new Set(), tfa: 0 };
            });
            
            // Process CA data (CM only)
            filteredDataSource.forEach(row => {
                const caExpirationDate = row.CA_Expiration_Date;
                const managementStatus = (row.Management_Status || "").toUpperCase();
                const region = (row.Region || "").toUpperCase();
                const caReview = (row.CA_Review || "").trim();
                
                if (caExpirationDate && managementStatus === "CM" && row.Relationship_ID) {
                    const dateObj = parseDate(caExpirationDate);
                    if (!dateObj) return;
                    
                    const amount = parseNumber(row.Fac_Amount || row.Facility_Amount);
                    
                    // Check EMEA CA_Review requirement
                    if (region === "EMEA" && caReview !== "Yes") return;
                    
                    // Expired (everything before report date)
                    if (dateObj < maxReportDate) {
                        caData.expired.relationships.add(row.Relationship_ID);
                        caData.expired.tfa += amount;
                        caData.expired.count++;
                    }
                    // Expiring (from report date onwards)
                    else if (dateObj >= maxReportDate) {
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthKey = `${year}-${month}`;
                        
                        if (caData.byMonth[monthKey]) {
                            caData.byMonth[monthKey].relationships.add(row.Relationship_ID);
                            caData.byMonth[monthKey].tfa += amount;
                            caData.expiring.relationships.add(row.Relationship_ID);
                            caData.expiring.tfa += amount;
                            caData.expiring.count++;
                        }
                    }
                }
            });
            
            // Process Facility data (NO DM exclusion)
            filteredDataSource.forEach(row => {
                const maturityDate = row.Maturity_Date;
                const facilityId = row.Facility_ID;
                
                if (maturityDate && facilityId) {
                    const dateObj = parseDate(maturityDate);
                    if (!dateObj) return;
                    
                    const amount = parseNumber(row.Fac_Amount || row.Facility_Amount);
                    
                    // Expired (everything before report date)
                    if (dateObj < maxReportDate) {
                        facilityData.expired.facilities.add(facilityId);
                        facilityData.expired.tfa += amount;
                        facilityData.expired.count++;
                    }
                    // Expiring (from report date onwards)
                    else if (dateObj >= maxReportDate) {
                        const year = dateObj.getFullYear();
                        const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                        const monthKey = `${year}-${month}`;
                        
                        if (facilityData.byMonth[monthKey]) {
                            facilityData.byMonth[monthKey].facilities.add(facilityId);
                            facilityData.byMonth[monthKey].tfa += amount;
                            facilityData.expiring.facilities.add(facilityId);
                            facilityData.expiring.tfa += amount;
                            facilityData.expiring.count++;
                        }
                    }
                }
            });
            
            // Collect regional, product, and underwriter data for expiring items
            const regionalData = { NAM: {cas: 0, facilities: 0, tfa: 0}, LATAM: {cas: 0, facilities: 0, tfa: 0}, EMEA: {cas: 0, facilities: 0, tfa: 0}, APAC: {cas: 0, facilities: 0, tfa: 0} };
            const productData = {};
            const underwriterData = {};
            
            // Data for expired FACILITIES ONLY (with region, product, TFA details)
            const expiredRegionalData = { NAM: 0, LATAM: 0, EMEA: 0, APAC: 0 };
            const expiredProductData = {};
            const expiredFacilityDetails = []; // New: detailed facility data for table
            const expiredAgingData = { '0-30': 0, '31-60': 0, '61-90': 0, '>90': 0 }; // Aging buckets
            
            filteredDataSource.forEach(row => {
                const region = (row.Region || "Unknown").toUpperCase();
                const product = row.Product_Program || "Unknown";
                const underwriter = row.Lead_Underwriter || "Unknown";
                const amount = parseNumber(row.Fac_Amount || row.Facility_Amount);
                
                // Check if CA is expiring (CM only, within next 3 months)
                const caExpirationDate = row.CA_Expiration_Date;
                const managementStatus = (row.Management_Status || "").toUpperCase();
                const caReview = (row.CA_Review || "").trim();
                let isCAExpiring = false;
                let isCAExpired = false;
                
                if (caExpirationDate && managementStatus === "CM" && row.Relationship_ID) {
                    const dateObj = parseDate(caExpirationDate);
                    if (dateObj) {
                        // Check EMEA CA_Review requirement
                        const meetsRequirement = region !== "EMEA" || caReview === "Yes";
                        
                        if (meetsRequirement && dateObj < maxReportDate) {
                            // Expired CA
                            isCAExpired = true;
                        } else if (meetsRequirement && dateObj >= maxReportDate) {
                            const year = dateObj.getFullYear();
                            const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                            const monthKey = `${year}-${month}`;
                            if (caData.byMonth[monthKey]) {
                                isCAExpiring = true;
                            }
                        }
                    }
                }
                
                // Check if Facility is expiring or expired (within next 3 months, no DM exclusion)
                const maturityDate = row.Maturity_Date;
                const facilityId = row.Facility_ID;
                let isFacilityExpiring = false;
                let isFacilityExpired = false;
                
                if (maturityDate && facilityId) {
                    const dateObj = parseDate(maturityDate);
                    if (dateObj) {
                        if (dateObj < maxReportDate) {
                            // Expired Facility
                            isFacilityExpired = true;
                        } else if (dateObj >= maxReportDate) {
                            const year = dateObj.getFullYear();
                            const month = String(dateObj.getMonth() + 1).padStart(2, "0");
                            const monthKey = `${year}-${month}`;
                            if (facilityData.byMonth[monthKey]) {
                                isFacilityExpiring = true;
                            }
                        }
                    }
                }
                
                // Aggregate regional data for EXPIRING items
                if (isCAExpiring || isFacilityExpiring) {
                    if (!regionalData[region]) {
                        regionalData[region] = {cas: 0, facilities: 0, tfa: 0};
                    }
                    regionalData[region].tfa += amount;
                    if (isCAExpiring) regionalData[region].cas++;
                    if (isFacilityExpiring) regionalData[region].facilities++;
                    
                    // Aggregate product data for EXPIRING items
                    if (!productData[product]) {
                        productData[product] = { tfa: 0, cas: 0, facilities: 0 };
                    }
                    productData[product].tfa += amount;
                    if (isCAExpiring) productData[product].cas++;
                    if (isFacilityExpiring) productData[product].facilities++;
                    
                    // Aggregate underwriter data
                    if (!underwriterData[underwriter]) {
                        underwriterData[underwriter] = { tfa: 0, cas: new Set(), facilities: new Set(), region: region };
                    }
                    underwriterData[underwriter].tfa += amount;
                    if (isCAExpiring && row.Relationship_ID) underwriterData[underwriter].cas.add(row.Relationship_ID);
                    if (isFacilityExpiring && facilityId) underwriterData[underwriter].facilities.add(facilityId);
                }
                
                // Aggregate EXPIRED FACILITIES data (only facilities)
                if (isFacilityExpired) {
                    // Store detailed info for table
                    const maturityDateObj = parseDate(maturityDate);
                    const daysPastDue = maturityDateObj ? Math.floor((maxReportDate - maturityDateObj) / (1000 * 60 * 60 * 24)) : 0;
                    
                    expiredFacilityDetails.push({
                        region: region,
                        product: product,
                        tfa: amount,
                        daysPastDue: daysPastDue,
                        facilityId: facilityId
                    });
                    
                    if (expiredRegionalData[region] !== undefined) {
                        expiredRegionalData[region]++;
                    }
                    
                    if (!expiredProductData[product]) {
                        expiredProductData[product] = { facilities: 0, tfa: 0 };
                    }
                    expiredProductData[product].facilities++;
                    expiredProductData[product].tfa += amount;
                    
                    // Categorize by aging bucket
                    if (daysPastDue >= 0 && daysPastDue <= 30) {
                        expiredAgingData['0-30']++;
                    } else if (daysPastDue >= 31 && daysPastDue <= 60) {
                        expiredAgingData['31-60']++;
                    } else if (daysPastDue >= 61 && daysPastDue <= 90) {
                        expiredAgingData['61-90']++;
                    } else if (daysPastDue > 90) {
                        expiredAgingData['>90']++;
                    }
                }
            });
            
            return `
                <!-- Title Section -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">Expiration & Renewal Tracker</h3>
                    <p class="text-sm text-gray-500 mt-1">Monitor credit agreements and facilities approaching expiration</p>
                </div>
                
                <!-- Key Metrics Grid - Always show all 4 KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="expiringMetrics">
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-blue-100">
                                <svg class="h-5 w-5 shrink-0 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">CAs Expiring (3m)</p>
                                <h3 class="text-2xl font-bold text-gray-900">${caData.expiring.relationships.size}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">${formatCurrency(caData.expiring.tfa)}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-red-100">
                                <svg class="h-5 w-5 shrink-0 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">CAs Expired</p>
                                <h3 class="text-2xl font-bold text-gray-900">${caData.expired.relationships.size}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">${formatCurrency(caData.expired.tfa)}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-green-100">
                                <svg class="h-5 w-5 shrink-0 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Facilities Expiring (3m)</p>
                                <h3 class="text-2xl font-bold text-gray-900">${facilityData.expiring.facilities.size}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">${formatCurrency(facilityData.expiring.tfa)}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-orange-100">
                                <svg class="h-5 w-5 shrink-0 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Facilities Expired</p>
                                <h3 class="text-2xl font-bold text-gray-900">${facilityData.expired.facilities.size}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">${formatCurrency(facilityData.expired.tfa)}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Analysis Row - Regional & Categorical Breakdowns -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6" id="expiringAnalysis">
                    <!-- Expired Facilities by Aging -->
                    <div class="rounded-xl border border-gray-200 bg-white">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">Expired Facilities by Aging</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">Count of expired facilities by days past due</p>
                        </div>
                        <div class="p-6 flex items-center justify-center" style="min-height: 400px;">
                            <div id="expiredAgingChart" class="w-full"></div>
                        </div>
                    </div>
                    
                    <!-- Product Category Chart -->
                    <div class="rounded-xl border border-gray-200 bg-white">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">Expired Facilities by Product Program</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">Distribution across product programs</p>
                        </div>
                        <div class="p-6 flex items-center justify-center" style="min-height: 400px;">
                            <div class="flex flex-row items-center justify-center gap-8">
                                <!-- Donut Chart -->
                                <div class="flex-shrink-0">
                                    <div id="productCategoryChart"></div>
                                </div>
                                
                                <!-- Legend / Details List - Right Side -->
                                <div class="flex-1 max-w-md">
                                    <div id="productCategoryList" class="space-y-3">
                                        <!-- Legend will be dynamically populated -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Combined Expiring Table with Filters and Pagination -->
                <div class="rounded-2xl border border-gray-200 bg-white" id="expiringTableContainer">
                    <!-- Header with Filters -->
                    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800" id="expiringTableTitle">CAs & Facilities Details</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">Expiring and expired items</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <!-- Search Input -->
                            <div class="relative">
                                <input 
                                    type="text" 
                                    id="expiringTableSearch" 
                                    placeholder="Search..." 
                                    onkeyup="updateExpiringTableSearch(this.value)"
                                    class="w-48 px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                />
                                <svg class="absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            
                            <!-- View Filter (CAs / Facilities) -->
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-medium text-gray-500 tracking-wider">View:</span>
                                <div class="inline-flex items-center gap-0.5 rounded-lg bg-gray-100 p-0.5">
                                    <button id="btnExpiringCAs" onclick="updateExpiringFilter('cas', 'view')" 
                                        class="min-w-[60px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                                        CAs
                                    </button>
                                    <button id="btnExpiringFacilities" onclick="updateExpiringFilter('facilities', 'view')" 
                                        class="min-w-[90px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white">
                                        Facilities
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Category Filter (Expiring / Expired) -->
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-medium text-gray-500 tracking-wider">Category:</span>
                                <div class="inline-flex items-center gap-0.5 rounded-lg bg-gray-100 p-0.5">
                                    <button id="btnCategoryExpiring" onclick="updateExpiringFilter('expiring', 'category')" 
                                        class="min-w-[70px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                                        Expiring
                                    </button>
                                    <button id="btnCategoryExpired" onclick="updateExpiringFilter('expired', 'category')" 
                                        class="min-w-[70px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white">
                                        Expired
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Clear All Filters Button -->
                            <button 
                                id="btnClearAllExpiringFilters"
                                onclick="clearAllExpiringFilters()"
                                style="display: none;"
                                class="px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-1.5">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                Clear Filters
                            </button>
                            
                            <!-- Export Button -->
                            <button 
                                id="btnExportExpiringTable"
                                onclick="exportExpiringTableToCSV()"
                                class="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 border border-blue-600 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-1.5">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Export
                            </button>
                        </div>
                    </div>
                    
                    <!-- Table -->
                    <div class="custom-scrollbar overflow-x-auto" style="min-height: 500px;">
                        <table class="min-w-full">
                            <thead>
                                <tr class="bg-gray-50" id="expiringTableHeader">
                                    <!-- Headers will be dynamically rendered -->
                                </tr>
                            </thead>
                            <tbody id="expiringTableBody" class="divide-y divide-gray-200">
                                <tr><td colspan="8" class="px-6 py-8 text-center text-sm text-gray-500">Loading data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Footer with Pagination -->
                    <div class="flex items-center justify-between px-6 py-4 border-t border-gray-200 bg-gray-50" style="border-bottom-left-radius: 1rem; border-bottom-right-radius: 1rem;">
                        <div class="flex items-center gap-4">
                            <div class="text-sm text-gray-700" id="expiringTableInfo">
                                Showing <span class="font-medium" id="expiringTableStart">0</span> to <span class="font-medium" id="expiringTableEnd">0</span> of <span class="font-medium" id="expiringTableTotal">0</span> items
                            </div>
                            <select 
                                id="expiringTablePerPage" 
                                onchange="updateExpiringTablePerPage(parseInt(this.value))"
                                class="text-sm border border-gray-300 rounded-lg px-2 py-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="10" selected>10 per page</option>
                                <option value="20">20 per page</option>
                                <option value="50">50 per page</option>
                                <option value="100">100 per page</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2">
                            <button 
                                id="expiringTablePrevBtn"
                                onclick="changeExpiringTablePage('prev')" 
                                disabled
                                class="px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                Previous
                            </button>
                            <div class="text-sm text-gray-700">
                                Page <span class="font-medium" id="expiringTableCurrentPage">1</span> of <span class="font-medium" id="expiringTableTotalPages">1</span>
                            </div>
                            <button 
                                id="expiringTableNextBtn"
                                onclick="changeExpiringTablePage('next')" 
                                disabled
                                class="px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                Next
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Initialize expiring table state
        window.expiringTableState = {
            viewFilter: 'facilities', // 'cas' or 'facilities' - default to facilities
            categoryFilter: 'expired', // 'expiring' or 'expired' - default to expired
            searchQuery: '',
            currentPage: 1,
            perPage: 10,
            allData: [],
            columnFilters: {},
            sortColumn: 'tfa', // Default sort by TFA
            sortDirection: 'desc', // Descending for highest first
            openFilterColumn: null // Track which filter dropdown is open
        };
        
        // Initialize pipeline table state
        window.pipelineTableState = {
            searchQuery: '',
            currentPage: 1,
            perPage: 10,
            allData: [],
            columnFilters: {},
            sortColumn: 'tfa', // Default sort by TFA
            sortDirection: 'desc', // Descending for highest first
            openFilterColumn: null // Track which filter dropdown is open
        };
        
        // Update expiring filter and refresh view
        function updateExpiringFilter(filterValue, filterType) {
            if (filterType === 'view') {
                window.expiringTableState.viewFilter = filterValue;
                
                // Update button states
                const casBtn = document.getElementById('btnExpiringCAs');
                const facilBtn = document.getElementById('btnExpiringFacilities');
                
                if (filterValue === 'cas') {
                    casBtn.className = 'min-w-[60px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white';
                    facilBtn.className = 'min-w-[90px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900';
                } else {
                    casBtn.className = 'min-w-[60px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900';
                    facilBtn.className = 'min-w-[90px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white';
                }
                
                // Reset column filters when changing view
                window.expiringTableState.columnFilters = {};
                window.expiringTableState.sortColumn = '';
            } else if (filterType === 'category') {
                window.expiringTableState.categoryFilter = filterValue;
                
                // Update button states
                const expiringBtn = document.getElementById('btnCategoryExpiring');
                const expiredBtn = document.getElementById('btnCategoryExpired');
                
                if (filterValue === 'expiring') {
                    expiringBtn.className = 'min-w-[70px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white';
                    expiredBtn.className = 'min-w-[70px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900';
                } else {
                    expiringBtn.className = 'min-w-[70px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900';
                    expiredBtn.className = 'min-w-[70px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white';
                }
                
                // Reset column filters when changing category
                window.expiringTableState.columnFilters = {};
                window.expiringTableState.sortColumn = '';
            }
            
            // Reset to page 1
            window.expiringTableState.currentPage = 1;
            
            // Re-render the table
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
            renderExpiringTable(dataSource);
        }
        
        // Update search query
        function updateExpiringTableSearch(query) {
            window.expiringTableState.searchQuery = query.toLowerCase();
            window.expiringTableState.currentPage = 1;
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
            renderExpiringTable(dataSource);
        }
        
        // Update per page
        function updateExpiringTablePerPage(perPage) {
            window.expiringTableState.perPage = perPage;
            window.expiringTableState.currentPage = 1;
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
            renderExpiringTable(dataSource);
        }
        
        // Change page
        function changeExpiringTablePage(direction) {
            if (direction === 'prev' && window.expiringTableState.currentPage > 1) {
                window.expiringTableState.currentPage--;
            } else if (direction === 'next') {
                const totalPages = Math.ceil(window.expiringTableState.allData.length / window.expiringTableState.perPage);
                if (window.expiringTableState.currentPage < totalPages) {
                    window.expiringTableState.currentPage++;
                }
            }
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
            renderExpiringTable(dataSource);
        }
        
        // Sort expiring table by column
        function sortExpiringTable(column) {
            const state = window.expiringTableState;
            if (state.sortColumn === column) {
                state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                state.sortColumn = column;
                state.sortDirection = 'asc';
            }
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
            renderExpiringTable(dataSource);
        }
        
        // Toggle column filter dropdown
        function toggleExpiringFilterDropdown(column, event) {
            event.stopPropagation();
            const state = window.expiringTableState;
            if (state.openFilterColumn === column) {
                state.openFilterColumn = null;
            } else {
                state.openFilterColumn = column;
            }
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
            renderExpiringTable(dataSource);
        }
        
        // Toggle filter value for a column
        function toggleExpiringColumnFilter(column, value) {
            const state = window.expiringTableState;
            if (!state.columnFilters[column]) {
                state.columnFilters[column] = [];
            }
            const index = state.columnFilters[column].indexOf(value);
            if (index > -1) {
                state.columnFilters[column].splice(index, 1);
            } else {
                state.columnFilters[column].push(value);
            }
            state.currentPage = 1;
            state.openFilterColumn = null;
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
            renderExpiringTable(dataSource);
        }
        
        // Clear column filter
        function clearExpiringColumnFilter(column) {
            const state = window.expiringTableState;
            state.columnFilters[column] = [];
            state.currentPage = 1;
            state.openFilterColumn = null;
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
            renderExpiringTable(dataSource);
        }
        
        // Clear all column filters
        function clearAllExpiringFilters() {
            const state = window.expiringTableState;
            state.columnFilters = {};
            state.sortColumn = '';
            state.sortDirection = 'asc';
            state.currentPage = 1;
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
            renderExpiringTable(dataSource);
        }
        
        // Filter dropdown values based on search input
        function filterExpiringDropdownValues(columnKey) {
            const searchInput = document.getElementById(`filterSearch_${columnKey}`);
            if (!searchInput) return;
            
            const searchTerm = searchInput.value.toLowerCase();
            const filterContainer = document.getElementById(`filterValues_${columnKey}`);
            if (!filterContainer) return;
            
            const items = filterContainer.querySelectorAll('.filter-value-item');
            items.forEach(item => {
                const itemValue = item.getAttribute('data-value');
                if (itemValue.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // Export expiring table to CSV
        function exportExpiringTableToCSV() {
            const state = window.expiringTableState;
            const data = state.allData; // Use filtered data
            
            if (!data || data.length === 0) {
                alert('No data to export');
                return;
            }
            
            const viewFilter = state.viewFilter;
            const categoryFilter = state.categoryFilter;
            const agingLabel = categoryFilter === 'expiring' ? 'Coming Due' : 'Past Due';
            
            // Define CSV headers based on view and category
            let headers = [];
            if (viewFilter === 'cas') {
                headers = ['Relationship', 'Region', 'Underwriter', 'Product Program', 
                          categoryFilter === 'expiring' ? 'CA Expiry Date' : 'Expired Date', 
                          agingLabel, 'TFA'];
            } else {
                headers = ['Relationship', 'Region', 'Underwriter', 'Product Program', 
                          'Facility Number', 
                          categoryFilter === 'expiring' ? 'Maturity Date' : 'Matured Date', 
                          agingLabel, 'TFA'];
            }
            
            // Build CSV rows
            const csvRows = [headers.join(',')];
            
            data.forEach(item => {
                const row = [];
                row.push(`"${item.relationship}"`);
                row.push(`"${item.region}"`);
                row.push(`"${item.underwriter}"`);
                row.push(`"${item.product}"`);
                
                if (viewFilter === 'cas') {
                    row.push(`"${item.expiryDate}"`);
                } else {
                    row.push(`"${item.facilityId}"`);
                    row.push(`"${item.maturityDate}"`);
                }
                
                row.push(`"${item.agingCategory}"`);
                row.push(item.tfa); // Number, no quotes
                
                csvRows.push(row.join(','));
            });
            
            // Create and download file
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            // Generate filename with current view/category
            const timestamp = new Date().toISOString().slice(0, 10);
            const viewLabel = viewFilter === 'cas' ? 'CAs' : 'Facilities';
            const categoryLabel = categoryFilter === 'expiring' ? 'Expiring' : 'Expired';
            const filename = `${viewLabel}_${categoryLabel}_${timestamp}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Close filter dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.expiring-filter-dropdown')) {
                const state = window.expiringTableState;
                if (state.openFilterColumn) {
                    state.openFilterColumn = null;
                    const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
                    renderExpiringTable(dataSource);
                }
            }
            
            // Also handle pipeline table filter dropdowns
            if (!e.target.closest('.pipeline-filter-dropdown')) {
                const pipelineState = window.pipelineTableState;
                if (pipelineState && pipelineState.openFilterColumn) {
                    pipelineState.openFilterColumn = null;
                    renderPipelineDetailsTable();
                }
            }
        });
        
        // ===== PIPELINE TABLE HELPER FUNCTIONS (OLD/UNUSED) =====
        
        // OLD/UNUSED: Update search query for pipeline table
        function updatePipelineTableSearch_OLD(query) {
            window.pipelineTableState.searchQuery = query.toLowerCase();
            window.pipelineTableState.currentPage = 1;
            renderPipelineDetailsTable_OLD_UNUSED();
        }
        
        // OLD/UNUSED: Update per page for pipeline table
        function updatePipelineTablePerPage_OLD(perPage) {
            window.pipelineTableState.perPage = perPage;
            window.pipelineTableState.currentPage = 1;
            renderPipelineDetailsTable_OLD_UNUSED();
        }
        
        // OLD/UNUSED: Change page for pipeline table
        function changePipelineTablePage_OLD(direction) {
            if (direction === 'prev' && window.pipelineTableState.currentPage > 1) {
                window.pipelineTableState.currentPage--;
            } else if (direction === 'next') {
                const state = window.pipelineTableState;
                const totalPages = Math.ceil(state.allData.length / state.perPage);
                if (state.currentPage < totalPages) {
                    window.pipelineTableState.currentPage++;
                }
            }
            renderPipelineDetailsTable_OLD_UNUSED();
        }
        
        // OLD/UNUSED: Sort pipeline table by column
        function sortPipelineTable_OLD(column) {
            const state = window.pipelineTableState;
            if (state.sortColumn === column) {
                state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                state.sortColumn = column;
                state.sortDirection = 'asc';
            }
            renderPipelineDetailsTable_OLD_UNUSED();
        }
        
        // OLD/UNUSED: Toggle column filter dropdown for pipeline table
        function togglePipelineFilterDropdown_OLD(column, event) {
            event.stopPropagation();
            const state = window.pipelineTableState;
            if (state.openFilterColumn === column) {
                state.openFilterColumn = null;
            } else {
                state.openFilterColumn = column;
            }
            renderPipelineDetailsTable_OLD_UNUSED();
        }
        
        // OLD/UNUSED: Toggle filter value for a column in pipeline table
        function togglePipelineColumnFilter_OLD(column, value) {
            const state = window.pipelineTableState;
            if (!state.columnFilters[column]) {
                state.columnFilters[column] = [];
            }
            const index = state.columnFilters[column].indexOf(value);
            if (index > -1) {
                state.columnFilters[column].splice(index, 1);
            } else {
                state.columnFilters[column].push(value);
            }
            state.currentPage = 1;
            state.openFilterColumn = null;
            renderPipelineDetailsTable_OLD_UNUSED();
        }
        
        // OLD/UNUSED: Clear column filter for pipeline table
        function clearPipelineColumnFilter_OLD(column) {
            const state = window.pipelineTableState;
            delete state.columnFilters[column];
            state.currentPage = 1;
            state.openFilterColumn = null;
            renderPipelineDetailsTable_OLD_UNUSED();
        }
        
        // OLD/UNUSED: Clear all column filters for pipeline table
        function clearAllPipelineFilters_OLD() {
            const state = window.pipelineTableState;
            state.columnFilters = {};
            state.sortColumn = 'tfa';
            state.sortDirection = 'desc';
            state.currentPage = 1;
            renderPipelineDetailsTable_OLD_UNUSED();
        }
        
        // OLD/UNUSED: Filter dropdown values based on search input for pipeline table
        function filterPipelineDropdownValues_OLD(column) {
            const searchInput = document.getElementById(`pipelineFilterSearch_${column}`);
            if (!searchInput) return;
            
            const searchValue = searchInput.value.toLowerCase();
            const container = document.getElementById(`pipelineFilterValues_${column}`);
            if (!container) return;
            
            const items = container.querySelectorAll('.pipeline-filter-value-item');
            items.forEach(item => {
                const value = item.dataset.value || '';
                if (value.includes(searchValue)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // OLD/UNUSED: Export pipeline table to CSV
        function exportPipelineTableToCSV_OLD_VERSION() {
            const state = window.pipelineTableState;
            const data = state.allData; // Use filtered data
            
            if (!data || data.length === 0) {
                alert('No data to export');
                return;
            }
            
            // Define CSV headers
            const headers = ['Facility ID', 'Relationship', 'Region', 'Product', 'Facility Type', 
                           'Underwriter', 'TFA', 'Days', 'Aging'];
            
            // Build CSV rows
            const csvRows = [headers.join(',')];
            
            data.forEach(item => {
                const row = [];
                row.push(`"${item.facilityId}"`);
                row.push(`"${item.relationship}"`);
                row.push(`"${item.region}"`);
                row.push(`"${item.product}"`);
                row.push(`"${item.facilityType}"`);
                row.push(`"${item.underwriter}"`);
                row.push(item.tfa); // Number, no quotes
                row.push(item.daysOld);
                row.push(`"${item.agingCategory}"`);
                
                csvRows.push(row.join(','));
            });
            
            // Create and download file
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            // Generate filename with current date
            const timestamp = new Date().toISOString().slice(0, 10);
            const filename = `Deals_Pending_Closure_${timestamp}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // ========================================
        // CCM DETAILS TABLE FUNCTIONS
        // ========================================
        
        // Apply user filters (Region, Underwriter, Relationship ID) to CCM data
        function applyCCMUserFilters() {
            if (!window.ccmTableState) return;
            
            let filtered = window.ccmDetailsFullData;
            
            // Apply Region filter
            if (window.selectedRegion && window.selectedRegion !== 'all') {
                filtered = filtered.filter(row => {
                    const region = String(row.Region || '').trim().toUpperCase();
                    return region === window.selectedRegion.toUpperCase();
                });
            }
            
            // Apply Underwriter filter
            if (window.selectedUnderwriter && window.selectedUnderwriter !== 'all') {
                filtered = filtered.filter(row => {
                    const underwriter = String(row.Underwriter || row.Lead_Underwriter || '').trim();
                    return underwriter === window.selectedUnderwriter;
                });
            }
            
            // Apply Relationship filter (if search contains relationship ID)
            if (window.selectedRelationshipId) {
                filtered = filtered.filter(row => {
                    const relId = String(row.Relationship_ID || '').trim();
                    return relId === window.selectedRelationshipId;
                });
            }
            
            window.ccmTableState.data = filtered;
            filterCCMTableByStatus(window.ccmTableState.statusFilter || 'pastDue', false);
        }
        
        // Filter CCM table by status
        function filterCCMTableByStatus(status, resetPage = true) {
            if (!window.ccmTableState) return;
            
            window.ccmTableState.statusFilter = status;
            if (resetPage) {
                window.ccmTableState.currentPage = 1;
            }
            
            // Update button styles
            const buttons = ['btnCCMPastDue', 'btnCCMComingDue', 'btnCCMOpen'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    if ((btnId === 'btnCCMPastDue' && status === 'pastDue') ||
                        (btnId === 'btnCCMComingDue' && status === 'comingDue') ||
                        (btnId === 'btnCCMOpen' && status === 'open')) {
                        btn.className = 'px-2 py-1 text-xs rounded-md transition-all duration-200 bg-white shadow-sm text-gray-900 font-medium';
                    } else {
                        btn.className = 'px-2 py-1 text-xs rounded-md transition-all duration-200 text-gray-600';
                    }
                }
            });
            
            // Filter by status
            let filtered = window.ccmTableState.data.filter(row => {
                const ccmStatus = String(row.CCM_Status || '').trim().toLowerCase();
                if (status === 'pastDue') return ccmStatus === 'past due';
                if (status === 'comingDue') return ccmStatus === 'coming due';
                if (status === 'open') return ccmStatus === 'open';
                return false;
            });
            
            // Apply search filter
            if (window.ccmTableState.searchTerm) {
                const searchLower = window.ccmTableState.searchTerm.toLowerCase();
                filtered = filtered.filter(row => {
                    return String(row.Region || '').toLowerCase().includes(searchLower) ||
                           String(row.Relationship_ID || '').toLowerCase().includes(searchLower) ||
                           String(row.Client_Name || '').toLowerCase().includes(searchLower) ||
                           String(row.Classification || '').toLowerCase().includes(searchLower) ||
                           String(row.Underwriter || row.Lead_Underwriter || '').toLowerCase().includes(searchLower);
                });
            }
            
            window.ccmTableState.filtered = filtered;
            renderCCMDetailsTable();
            updateClearFiltersButton();
        }
        
        // Initialize CCM Details Table
        function initializeCCMDetailsTable() {
            if (!window.ccmTableState) return;
            
            // Set initial status filter to Past Due
            filterCCMTableByStatus('pastDue', false);
        }
        
        // Render CCM Details Table
        function renderCCMDetailsTable() {
            const state = window.ccmTableState;
            if (!state) return;
            
            const data = state.filtered;
            const start = (state.currentPage - 1) * state.perPage;
            const end = Math.min(start + state.perPage, data.length);
            const pageData = data.slice(start, end);
            
            // Headers
            const headerEl = document.getElementById('ccmDetailsTableHeader');
            if (headerEl) {
                headerEl.innerHTML = `
                    <th class="px-6 py-4 text-left text-sm font-medium whitespace-nowrap text-gray-500 cursor-pointer hover:bg-gray-100" onclick="sortCCMTable('Region')">
                        Region
                        <span class="ml-1 text-xs text-gray-400"></span>
                    </th>
                    <th class="px-6 py-4 text-left text-sm font-medium whitespace-nowrap text-gray-500 cursor-pointer hover:bg-gray-100" onclick="sortCCMTable('Relationship_ID')">
                        Relationship ID
                        <span class="ml-1 text-xs text-gray-400"></span>
                    </th>
                    <th class="px-6 py-4 text-left text-sm font-medium whitespace-nowrap text-gray-500 cursor-pointer hover:bg-gray-100" onclick="sortCCMTable('Client_Name')">
                        Client Name
                        <span class="ml-1 text-xs text-gray-400"></span>
                    </th>
                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500 cursor-pointer hover:bg-gray-100" onclick="sortCCMTable('Classification')">
                        Classification
                        <span class="ml-1 text-xs text-gray-400"></span>
                    </th>
                    <th class="px-6 py-4 text-left text-sm font-medium whitespace-nowrap text-gray-500 cursor-pointer hover:bg-gray-100" onclick="sortCCMTable('Underwriter')">
                        Underwriter
                        <span class="ml-1 text-xs text-gray-400"></span>
                    </th>
                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500 cursor-pointer hover:bg-gray-100" onclick="sortCCMTable('Next_CCM_Approval_Date')">
                        CCM Approval Due Date
                        <span class="ml-1 text-xs text-gray-400"></span>
                    </th>
                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500 cursor-pointer hover:bg-gray-100" onclick="sortCCMTable('CCM_Status')">
                        CCM Status
                        <span class="ml-1 text-xs text-gray-400"></span>
                    </th>
                `;
            }
            
            // Body
            const bodyEl = document.getElementById('ccmDetailsTableBody');
            if (bodyEl) {
                if (pageData.length === 0) {
                    bodyEl.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-sm text-gray-500">No data available</td></tr>';
                } else {
                    bodyEl.innerHTML = pageData.map(row => {
                        const classificationColors = {
                            'PASS': 'bg-green-100 text-green-700',
                            'SPECIAL MENTION': 'bg-yellow-100 text-yellow-700',
                            'SUBSTANDARD': 'bg-orange-100 text-orange-700',
                            'DOUBTFUL': 'bg-red-100 text-red-700'
                        };
                        const classification = String(row.Classification || 'Unknown').toUpperCase();
                        const classColor = classificationColors[classification] || 'bg-gray-100 text-gray-700';
                        
                        const statusColors = {
                            'past due': 'bg-red-100 text-red-700',
                            'coming due': 'bg-amber-100 text-amber-700',
                            'open': 'bg-green-100 text-green-700'
                        };
                        const status = String(row.CCM_Status || '').toLowerCase();
                        const statusColor = statusColors[status] || 'bg-gray-100 text-gray-700';
                        
                        return `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4">
                                    <span class="inline-flex items-center rounded-full px-2 py-1 text-xs font-medium bg-blue-100 text-blue-700">
                                        ${row.Region || '-'}
                                    </span>
                                </td>
                                <td class="px-6 py-4 font-medium text-gray-900">${row.Relationship_ID || '-'}</td>
                                <td class="px-6 py-4 text-gray-700">${row.Client_Name || '-'}</td>
                                <td class="px-6 py-4 text-center">
                                    <span class="inline-flex items-center rounded-full px-2 py-1 text-xs font-medium ${classColor}">
                                        ${classification}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-gray-700">${row.Underwriter || row.Lead_Underwriter || '-'}</td>
                                <td class="px-6 py-4 text-center text-gray-700">${row.Next_CCM_Approval_Date || '-'}</td>
                                <td class="px-6 py-4 text-center">
                                    <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ${statusColor}">
                                        ${row.CCM_Status || '-'}
                                    </span>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    
                    // Add totals row
                    bodyEl.innerHTML += `
                        <tr class="bg-gray-50 font-semibold border-t-2 border-gray-300">
                            <td colspan="6" class="px-6 py-4 text-gray-900">Total Records</td>
                            <td class="px-6 py-4 text-center text-gray-900">${data.length}</td>
                        </tr>
                    `;
                }
            }
            
            // Update pagination info
            document.getElementById('ccmTableStart').textContent = data.length > 0 ? start + 1 : 0;
            document.getElementById('ccmTableEnd').textContent = end;
            document.getElementById('ccmTableTotal').textContent = data.length;
            
            const totalPages = Math.ceil(data.length / state.perPage) || 1;
            document.getElementById('ccmTableCurrentPage').textContent = state.currentPage;
            document.getElementById('ccmTableTotalPages').textContent = totalPages;
            
            // Update pagination buttons
            document.getElementById('ccmTablePrevBtn').disabled = state.currentPage === 1;
            document.getElementById('ccmTableNextBtn').disabled = state.currentPage >= totalPages;
        }
        
        // Sort CCM table
        function sortCCMTable(column) {
            const state = window.ccmTableState;
            if (!state) return;
            
            if (state.sortColumn === column) {
                state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                state.sortColumn = column;
                state.sortDirection = 'asc';
            }
            
            state.filtered.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';
                
                // Handle Underwriter column (might be Lead_Underwriter)
                if (column === 'Underwriter') {
                    aVal = a.Underwriter || a.Lead_Underwriter || '';
                    bVal = b.Underwriter || b.Lead_Underwriter || '';
                }
                
                // Convert to string for comparison
                aVal = String(aVal);
                bVal = String(bVal);
                
                if (state.sortDirection === 'asc') {
                    return aVal.localeCompare(bVal);
                } else {
                    return bVal.localeCompare(aVal);
                }
            });
            
            renderCCMDetailsTable();
        }
        
        // Update search
        function updateCCMTableSearch(value) {
            const state = window.ccmTableState;
            if (!state) return;
            
            state.searchTerm = value.trim();
            state.currentPage = 1;
            filterCCMTableByStatus(state.statusFilter, false);
        }
        
        // Update per page
        function updateCCMTablePerPage(value) {
            const state = window.ccmTableState;
            if (!state) return;
            
            state.perPage = value;
            state.currentPage = 1;
            renderCCMDetailsTable();
        }
        
        // Change page
        function changeCCMTablePage(direction) {
            const state = window.ccmTableState;
            if (!state) return;
            
            if (direction === 'prev' && state.currentPage > 1) {
                state.currentPage--;
            } else if (direction === 'next') {
                const totalPages = Math.ceil(state.filtered.length / state.perPage);
                if (state.currentPage < totalPages) {
                    state.currentPage++;
                }
            }
            renderCCMDetailsTable();
        }
        
        // Clear all filters
        function clearAllCCMFilters() {
            const state = window.ccmTableState;
            if (!state) return;
            
            state.searchTerm = '';
            state.currentPage = 1;
            document.getElementById('ccmTableSearch').value = '';
            
            filterCCMTableByStatus('pastDue');
            updateClearFiltersButton();
        }
        
        // Update clear filters button visibility
        function updateClearFiltersButton() {
            const state = window.ccmTableState;
            if (!state) return;
            
            const hasFilters = state.searchTerm !== '';
            const btn = document.getElementById('btnClearAllCCMFilters');
            if (btn) {
                btn.style.display = hasFilters ? 'flex' : 'none';
            }
        }
        
        // Export to CSV
        function exportCCMTableToCSV() {
            const state = window.ccmTableState;
            const data = state.filtered;
            
            if (!data || data.length === 0) {
                alert('No data to export');
                return;
            }
            
            // Define CSV headers
            const headers = ['Region', 'Relationship ID', 'Client Name', 'Classification', 
                           'Underwriter', 'CCM Approval Due Date', 'CCM Status'];
            
            // Build CSV rows
            const csvRows = [headers.join(',')];
            
            data.forEach(item => {
                const row = [];
                row.push(`"${item.Region || ''}"`);
                row.push(`"${item.Relationship_ID || ''}"`);
                row.push(`"${item.Client_Name || ''}"`);
                row.push(`"${item.Classification || ''}"`);
                row.push(`"${item.Underwriter || item.Lead_Underwriter || ''}"`);
                row.push(`"${item.Next_CCM_Approval_Date || ''}"`);
                row.push(`"${item.CCM_Status || ''}"`);
                
                csvRows.push(row.join(','));
            });
            
            // Create and download file
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            // Generate filename with current date and status
            const timestamp = new Date().toISOString().slice(0, 10);
            const statusLabel = state.statusFilter === 'pastDue' ? 'Past_Due' : 
                              state.statusFilter === 'comingDue' ? 'Coming_Due' : 'Open';
            const filename = `CCM_Details_${statusLabel}_${timestamp}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Render expiring analysis views - Regional, Product, and Underwriter breakdowns
        function renderExpiringAnalysis(expiringData) {
            console.log(' renderExpiringAnalysis called', expiringData ? 'with data' : 'without data');
            
            try {
                const data = expiringData || window.expiringData;
                if (!data) {
                    console.error(' No expiring data available');
                    return;
                }
                
                // If no data, replace ENTIRE modal content with no-data message
                if (data.hasData === false) {
                    const insightsContent = document.getElementById('insightsContent');
                    if (insightsContent) {
                        insightsContent.innerHTML = generateNoDataMessage('CAs & Facilities Expiring');
                    }
                    return; // Don't render anything else
                }
                
                if (typeof ApexCharts === 'undefined') {
                    console.error(' ApexCharts is not defined');
                    return;
                }
                
                console.log(' Data and ApexCharts available, rendering...', {
                    hasRegionalData: !!data.regionalData,
                    hasProductData: !!data.productData,
                    hasUnderwriterData: !!data.underwriterData,
                    hasExpiredFacilityDetails: !!data.expiredFacilityDetails
                });
                
                const { regionalData, productData, underwriterData, expiredProductData, expiredAgingData } = data;
            
            console.log(' renderExpiringAnalysis - Data received:', {
                hasRegionalData: !!regionalData,
                hasProductData: !!productData,
                hasExpiredProductData: !!expiredProductData,
                hasExpiredAgingData: !!expiredAgingData,
                expiredProductDataKeys: expiredProductData ? Object.keys(expiredProductData).length : 0,
                expiredAgingData: expiredAgingData
            });
            
            // 1. Expired Facilities by Aging - Bar Chart
            const agingChartEl = document.getElementById('expiredAgingChart');
            if (agingChartEl && expiredAgingData) {
                const agingCategories = ['0-30 Days', '31-60 Days', '61-90 Days', '> 90 Days'];
                const agingValues = [
                    expiredAgingData['0-30'] || 0,
                    expiredAgingData['31-60'] || 0,
                    expiredAgingData['61-90'] || 0,
                    expiredAgingData['>90'] || 0
                ];
                
                const totalExpired = agingValues.reduce((a, b) => a + b, 0);
                
                console.log(' Aging chart data:', { agingValues, totalExpired });
                
                // Only render chart if there's data
                if (totalExpired > 0) {
                    const agingOptions = {
                    series: [{
                        name: 'Facilities',
                        data: agingValues
                    }],
                    chart: {
                        type: 'bar',
                        height: 340,
                        fontFamily: 'Outfit, sans-serif',
                        toolbar: { show: false },
                        parentHeightOffset: 0
                    },
                    colors: ['#465fff'],
                    plotOptions: {
                        bar: {
                            borderRadius: 6,
                            columnWidth: '60%',
                            dataLabels: { position: 'top' }
                        }
                    },
                    dataLabels: {
                        enabled: true,
                        offsetY: -20,
                        formatter: function(val) {
                            return val;
                        },
                        style: {
                            fontSize: '11px',
                            fontWeight: 500,
                            colors: ['#374151']
                        },
                        background: {
                            enabled: true,
                            foreColor: '#374151',
                            backgroundColor: '#F3F4F6',
                            borderRadius: 12,
                            padding: 8,
                            opacity: 1,
                            borderWidth: 0
                        }
                    },
                    xaxis: {
                        categories: agingCategories,
                        labels: {
                            style: {
                                colors: "#6B7280",
                                fontSize: "12px",
                                fontFamily: "Outfit, sans-serif",
                            },
                        },
                        axisBorder: { show: false },
                        axisTicks: { show: false }
                    },
                    yaxis: {
                        labels: {
                            style: {
                                colors: "#6B7280",
                                fontSize: "12px",
                                fontFamily: "Outfit, sans-serif",
                            },
                        },
                    },
                    grid: {
                        borderColor: '#E5E7EB',
                        strokeDashArray: 4,
                        xaxis: { lines: { show: false } },
                        yaxis: { lines: { show: true } },
                        padding: {
                            top: 0,
                            right: 0,
                            bottom: 0,
                            left: 0
                        }
                    },
                    tooltip: {
                        theme: 'light',
                        followCursor: false,
                        custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                            const category = agingCategories[dataPointIndex];
                            const count = series[seriesIndex][dataPointIndex];
                            
                            // Calculate regional data for this aging bucket
                            const agingKey = ['0-30', '31-60', '61-90', '>90'][dataPointIndex];
                            const regionalDistribution = { NAM: { count: 0, tfa: 0 }, LATAM: { count: 0, tfa: 0 }, EMEA: { count: 0, tfa: 0 }, APAC: { count: 0, tfa: 0 } };
                            let totalTFA = 0;
                            
                            if (data.expiredFacilityDetails) {
                                data.expiredFacilityDetails.forEach(facility => {
                                    let inBucket = false;
                                    if (agingKey === '0-30' && facility.daysPastDue >= 0 && facility.daysPastDue <= 30) inBucket = true;
                                    else if (agingKey === '31-60' && facility.daysPastDue >= 31 && facility.daysPastDue <= 60) inBucket = true;
                                    else if (agingKey === '61-90' && facility.daysPastDue >= 61 && facility.daysPastDue <= 90) inBucket = true;
                                    else if (agingKey === '>90' && facility.daysPastDue > 90) inBucket = true;
                                    
                                    if (inBucket) {
                                        const region = facility.region || 'Unknown';
                                        if (regionalDistribution[region]) {
                                            regionalDistribution[region].count++;
                                            regionalDistribution[region].tfa += facility.tfa;
                                            totalTFA += facility.tfa;
                                        }
                                    }
                                });
                            }
                            
                            // Build regional table rows
                            let regionalRows = '';
                            ['NAM', 'LATAM', 'EMEA', 'APAC'].forEach(region => {
                                const regionData = regionalDistribution[region];
                                if (regionData.count > 0 || regionData.tfa > 0) {
                                    regionalRows += `
                                        <tr>
                                            <td style="padding: 6px 8px; text-align: left; font-size: 11px; color: #6B7280; font-weight: 500;">${region}</td>
                                            <td style="padding: 6px 8px; text-align: center; font-size: 11px; color: #111827; font-weight: 600;">${regionData.count}</td>
                                            <td style="padding: 6px 8px; text-align: right; font-size: 11px; color: #111827; font-weight: 600;">${formatCurrency(regionData.tfa)}</td>
                                        </tr>
                                    `;
                                }
                            });
                            
                            return `
                                <div style="
                                    background: #ffffff; 
                                    border-radius: 12px; 
                                    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
                                    min-width: 320px;
                                    max-width: 360px;
                                    overflow: hidden;
                                    font-family: Outfit, sans-serif;
                                ">
                                    <!-- Header with border -->
                                    <div style="
                                        border-bottom: 1px solid #E5E7EB;
                                        padding: 16px 16px 12px 16px;
                                        margin-bottom: 14px;
                                    ">
                                        <div style="
                                            font-weight: 600; 
                                            font-size: 15px; 
                                            color: #111827;
                                            margin-bottom: 4px;
                                        ">${category}</div>
                                        <div style="
                                            font-size: 12px; 
                                            font-weight: 500;
                                            color: #6B7280;
                                        ">Days Past Due</div>
                                    </div>
                                    
                                    <!-- Content wrapper -->
                                    <div style="padding: 0 16px 16px 16px;">
                                        <!-- Widget Grid (2 columns) -->
                                        <div style="
                                            display: grid;
                                            grid-template-columns: 1fr 1fr;
                                            gap: 10px;
                                            margin-bottom: 16px;
                                        ">
                                            <!-- Widget 1: Facilities Count -->
                                            <div style="
                                                background: #F9FAFB;
                                                border-radius: 8px;
                                                padding: 12px;
                                                border: 1px solid #E5E7EB;
                                            ">
                                                <div style="
                                                    display: flex;
                                                    align-items: center;
                                                    gap: 6px;
                                                    font-size: 11px;
                                                    color: #6B7280;
                                                    font-weight: 500;
                                                    margin-bottom: 6px;
                                                ">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                                    </svg>
                                                    Facilities
                                                </div>
                                                <div style="
                                                    font-size: 20px;
                                                    font-weight: 700;
                                                    color: #111827;
                                                ">${count}</div>
                                            </div>
                                            
                                            <!-- Widget 2: TFA -->
                                            <div style="
                                                background: #F9FAFB;
                                                border-radius: 8px;
                                                padding: 12px;
                                                border: 1px solid #E5E7EB;
                                            ">
                                                <div style="
                                                    display: flex;
                                                    align-items: center;
                                                    gap: 6px;
                                                    font-size: 11px;
                                                    color: #6B7280;
                                                    font-weight: 500;
                                                    margin-bottom: 6px;
                                                ">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <line x1="12" y1="1" x2="12" y2="23"></line>
                                                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                                    </svg>
                                                    TFA
                                                </div>
                                                <div style="
                                                    font-size: 14px;
                                                    font-weight: 700;
                                                    color: #111827;
                                                ">${formatCurrency(totalTFA)}</div>
                                            </div>
                                        </div>
                                        
                                        <!-- Regional Distribution Table -->
                                        <div style="margin-top: 12px;">
                                            <div style="
                                                display: flex;
                                                align-items: center;
                                                gap: 6px;
                                                margin-bottom: 8px;
                                            ">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2">
                                                    <circle cx="12" cy="12" r="10"></circle>
                                                    <line x1="2" y1="12" x2="22" y2="12"></line>
                                                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                                </svg>
                                                <span style="
                                                    font-size: 12px;
                                                    font-weight: 600;
                                                    color: #374151;
                                                ">Regional Distribution</span>
                                            </div>
                                            <table style="width: 100%; border-collapse: collapse;">
                                                <thead>
                                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                                        <th style="padding: 6px 8px; text-align: left; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Region</th>
                                                        <th style="padding: 6px 8px; text-align: center; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Count</th>
                                                        <th style="padding: 6px 8px; text-align: right; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">TFA</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${regionalRows || '<tr><td colspan="3" style="padding: 8px; text-align: center; font-size: 11px; color: #9CA3AF;">No data</td></tr>'}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    }
                    };
                    
                    agingChartEl.innerHTML = '';
                    const agingChart = new ApexCharts(agingChartEl, agingOptions);
                    agingChart.render();
                    
                    // Add tooltip positioning fix
                    setTimeout(() => {
                        const tooltipObserver = new MutationObserver(() => {
                            const tooltip = agingChartEl.querySelector('.apexcharts-tooltip.apexcharts-active');
                            if (tooltip && !tooltip.hasAttribute('data-positioned')) {
                                const tooltipRect = tooltip.getBoundingClientRect();
                                const windowWidth = window.innerWidth;
                                const windowHeight = window.innerHeight;
                                const margin = 10;
                                
                                let needsReposition = false;
                                
                                if (tooltipRect.left < margin) {
                                    tooltip.style.left = margin + 'px';
                                    tooltip.style.transform = 'none';
                                    needsReposition = true;
                                } else if (tooltipRect.right > windowWidth - margin) {
                                    tooltip.style.left = (windowWidth - tooltipRect.width - margin) + 'px';
                                    tooltip.style.transform = 'none';
                                    needsReposition = true;
                                }
                                
                                if (tooltipRect.top < margin) {
                                    tooltip.style.top = margin + 'px';
                                    needsReposition = true;
                                } else if (tooltipRect.bottom > windowHeight - margin) {
                                    tooltip.style.top = (windowHeight - tooltipRect.height - margin) + 'px';
                                    needsReposition = true;
                                }
                                
                                if (needsReposition) {
                                    tooltip.setAttribute('data-positioned', 'true');
                                }
                            }
                            
                            const hiddenTooltip = agingChartEl.querySelector('.apexcharts-tooltip:not(.apexcharts-active)[data-positioned]');
                            if (hiddenTooltip) {
                                hiddenTooltip.removeAttribute('data-positioned');
                            }
                        });
                        
                        tooltipObserver.observe(agingChartEl, {
                            attributes: true,
                            attributeFilter: ['class'],
                            subtree: true
                        });
                    }, 200);
                } else {
                    // Show "no data" message for aging chart
                    agingChartEl.innerHTML = '<div class="flex items-center justify-center h-full py-12 text-sm text-gray-500">No expired facilities</div>';
                }
            }
            
            // 2. Product Category Chart - Donut Chart (EXPIRED Facilities Count Only)
            const productChartEl = document.getElementById('productCategoryChart');
            const productListEl = document.getElementById('productCategoryList');
            
            if (productChartEl && expiredProductData && Object.keys(expiredProductData).length > 0) {
                // Convert expired product data to array and sort by facilities count descending
                const sortedProducts = Object.entries(expiredProductData)
                    .map(([name, data]) => ({ name, facilities: data.facilities || 0 }))
                    .filter(p => p.facilities > 0) // Only include products with expired facilities
                    .sort((a, b) => b.facilities - a.facilities);
                
                console.log(' Product chart data:', { sortedProducts });
                
                if (sortedProducts.length > 0) {
                    const productLabels = sortedProducts.map(p => p.name);
                    const productValues = sortedProducts.map(p => p.facilities);
                    const totalFacilities = productValues.reduce((a, b) => a + b, 0);
                    
                    // Donut chart colors (matching TFA by Product Program style)
                    const donutColors = [
                        "#3641f5",  // Primary blue
                        "#7592ff",  // Light blue
                        "#dde9ff",  // Lighter blue
                        "#ff6b6b",  // Red
                        "#ffd93d",  // Yellow
                        "#6bcf7f",  // Green
                        "#c084fc",  // Purple
                    ];
                    
                    // Product Donut Chart Options (matching TailAdmin pie chart style)
                    const productChartOptions = {
                        series: productValues,
                        colors: donutColors.slice(0, productLabels.length),
                        labels: productLabels,
                        chart: {
                            fontFamily: "Outfit, sans-serif",
                            type: "donut",
                            width: 300,
                            height: 300,
                        },
                        stroke: {
                            show: false,
                        },
                        plotOptions: {
                            pie: {
                                donut: {
                                    size: "65%",
                                    background: "transparent",
                                    labels: {
                                        show: true,
                                        name: {
                                            show: true,
                                            offsetY: -10,
                                            color: "#1D2939",
                                            fontSize: "14px",
                                            fontWeight: "600",
                                        },
                                        value: {
                                            show: true,
                                            offsetY: 10,
                                            color: "#667085",
                                            fontSize: "16px",
                                            fontWeight: "700",
                                            formatter: (val) => val,
                                        },
                                        total: {
                                            show: true,
                                            label: "Total",
                                            color: "#111827",
                                            fontSize: "16px",
                                            fontWeight: "700",
                                            formatter: () => totalFacilities,
                                        },
                                    },
                                },
                            },
                        },
                        dataLabels: {
                            enabled: false,
                        },
                        legend: {
                            show: false, // Hide built-in legend, using custom HTML legend
                        },
                        tooltip: {
                            enabled: true,
                            theme: "light",
                            followCursor: false,
                            custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                                const productName = productLabels[seriesIndex];
                                const count = series[seriesIndex];
                                
                                // Calculate regional data for this product
                                const regionalDistribution = { NAM: { count: 0, tfa: 0 }, LATAM: { count: 0, tfa: 0 }, EMEA: { count: 0, tfa: 0 }, APAC: { count: 0, tfa: 0 } };
                                let totalTFA = 0;
                                
                                if (data.expiredFacilityDetails) {
                                    data.expiredFacilityDetails.forEach(facility => {
                                        if (facility.product === productName) {
                                            const region = facility.region || 'Unknown';
                                            if (regionalDistribution[region]) {
                                                regionalDistribution[region].count++;
                                                regionalDistribution[region].tfa += facility.tfa;
                                                totalTFA += facility.tfa;
                                            }
                                        }
                                    });
                                }
                                
                                // Build regional table rows
                                let regionalRows = '';
                                ['NAM', 'LATAM', 'EMEA', 'APAC'].forEach(region => {
                                    const regionData = regionalDistribution[region];
                                    if (regionData.count > 0 || regionData.tfa > 0) {
                                        regionalRows += `
                                            <tr>
                                                <td style="padding: 6px 8px; text-align: left; font-size: 11px; color: #6B7280; font-weight: 500;">${region}</td>
                                                <td style="padding: 6px 8px; text-align: center; font-size: 11px; color: #111827; font-weight: 600;">${regionData.count}</td>
                                                <td style="padding: 6px 8px; text-align: right; font-size: 11px; color: #111827; font-weight: 600;">${formatCurrency(regionData.tfa)}</td>
                                            </tr>
                                        `;
                                    }
                                });
                                
                                return `
                                    <div style="
                                        background: #ffffff; 
                                        border-radius: 12px; 
                                        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
                                        min-width: 320px;
                                        max-width: 360px;
                                        overflow: hidden;
                                        font-family: Outfit, sans-serif;
                                    ">
                                        <!-- Header with border -->
                                        <div style="
                                            border-bottom: 1px solid #E5E7EB;
                                            padding: 16px 16px 12px 16px;
                                            margin-bottom: 14px;
                                        ">
                                            <div style="
                                                font-weight: 600; 
                                                font-size: 15px; 
                                                color: #111827;
                                                margin-bottom: 4px;
                                            ">${productName}</div>
                                            <div style="
                                                font-size: 12px; 
                                                font-weight: 500;
                                                color: #6B7280;
                                            ">Product Program</div>
                                        </div>
                                        
                                        <!-- Content wrapper -->
                                        <div style="padding: 0 16px 16px 16px;">
                                            <!-- Widget Grid (2 columns) -->
                                            <div style="
                                                display: grid;
                                                grid-template-columns: 1fr 1fr;
                                                gap: 10px;
                                                margin-bottom: 16px;
                                            ">
                                                <!-- Widget 1: Facilities Count -->
                                                <div style="
                                                    background: #F9FAFB;
                                                    border-radius: 8px;
                                                    padding: 12px;
                                                    border: 1px solid #E5E7EB;
                                                ">
                                                    <div style="
                                                        display: flex;
                                                        align-items: center;
                                                        gap: 6px;
                                                        font-size: 11px;
                                                        color: #6B7280;
                                                        font-weight: 500;
                                                        margin-bottom: 6px;
                                                    ">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                                        </svg>
                                                        Facilities
                                                    </div>
                                                    <div style="
                                                        font-size: 20px;
                                                        font-weight: 700;
                                                        color: #111827;
                                                    ">${count}</div>
                                                </div>
                                                
                                                <!-- Widget 2: TFA -->
                                                <div style="
                                                    background: #F9FAFB;
                                                    border-radius: 8px;
                                                    padding: 12px;
                                                    border: 1px solid #E5E7EB;
                                                ">
                                                    <div style="
                                                        display: flex;
                                                        align-items: center;
                                                        gap: 6px;
                                                        font-size: 11px;
                                                        color: #6B7280;
                                                        font-weight: 500;
                                                        margin-bottom: 6px;
                                                    ">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <line x1="12" y1="1" x2="12" y2="23"></line>
                                                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                                        </svg>
                                                        TFA
                                                    </div>
                                                    <div style="
                                                        font-size: 14px;
                                                        font-weight: 700;
                                                        color: #111827;
                                                    ">${formatCurrency(totalTFA)}</div>
                                                </div>
                                            </div>
                                            
                                            <!-- Regional Distribution Table -->
                                            <div style="margin-top: 12px;">
                                                <div style="
                                                    display: flex;
                                                    align-items: center;
                                                    gap: 6px;
                                                    margin-bottom: 8px;
                                                ">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2">
                                                        <circle cx="12" cy="12" r="10"></circle>
                                                        <line x1="2" y1="12" x2="22" y2="12"></line>
                                                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                                    </svg>
                                                    <span style="
                                                        font-size: 12px;
                                                        font-weight: 600;
                                                        color: #374151;
                                                    ">Regional Distribution</span>
                                                </div>
                                                <table style="width: 100%; border-collapse: collapse;">
                                                    <thead>
                                                        <tr style="border-bottom: 1px solid #E5E7EB;">
                                                            <th style="padding: 6px 8px; text-align: left; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Region</th>
                                                            <th style="padding: 6px 8px; text-align: center; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Count</th>
                                                            <th style="padding: 6px 8px; text-align: right; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">TFA</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${regionalRows || '<tr><td colspan="3" style="padding: 8px; text-align: center; font-size: 11px; color: #9CA3AF;">No data</td></tr>'}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        },
                    };
                    
                    // Render the donut chart
                    productChartEl.innerHTML = '';
                    const productChart = new ApexCharts(productChartEl, productChartOptions);
                    productChart.render();
                    
                    // Add tooltip positioning fix
                    setTimeout(() => {
                        const tooltipObserver = new MutationObserver(() => {
                            const tooltip = productChartEl.querySelector('.apexcharts-tooltip.apexcharts-active');
                            if (tooltip && !tooltip.hasAttribute('data-positioned')) {
                                const tooltipRect = tooltip.getBoundingClientRect();
                                const windowWidth = window.innerWidth;
                                const windowHeight = window.innerHeight;
                                const margin = 10;
                                
                                let needsReposition = false;
                                
                                if (tooltipRect.left < margin) {
                                    tooltip.style.left = margin + 'px';
                                    tooltip.style.transform = 'none';
                                    needsReposition = true;
                                } else if (tooltipRect.right > windowWidth - margin) {
                                    tooltip.style.left = (windowWidth - tooltipRect.width - margin) + 'px';
                                    tooltip.style.transform = 'none';
                                    needsReposition = true;
                                }
                                
                                if (tooltipRect.top < margin) {
                                    tooltip.style.top = margin + 'px';
                                    needsReposition = true;
                                } else if (tooltipRect.bottom > windowHeight - margin) {
                                    tooltip.style.top = (windowHeight - tooltipRect.height - margin) + 'px';
                                    needsReposition = true;
                                }
                                
                                if (needsReposition) {
                                    tooltip.setAttribute('data-positioned', 'true');
                                }
                            }
                            
                            const hiddenTooltip = productChartEl.querySelector('.apexcharts-tooltip:not(.apexcharts-active)[data-positioned]');
                            if (hiddenTooltip) {
                                hiddenTooltip.removeAttribute('data-positioned');
                            }
                        });
                        
                        tooltipObserver.observe(productChartEl, {
                            attributes: true,
                            attributeFilter: ['class'],
                            subtree: true
                        });
                    }, 200);
                    
                    // Generate custom legend list
                    if (productListEl) {
                        const legendHTML = sortedProducts.map((product, index) => {
                            const color = donutColors[index % donutColors.length];
                            const percentage = ((product.facilities / totalFacilities) * 100).toFixed(1);
                            return `
                                <div class="flex items-center gap-3 py-2">
                                    <div class="w-4 h-4 rounded-sm flex-shrink-0" style="background-color: ${color};"></div>
                                    <p class="text-sm font-medium text-gray-800 flex-1">${product.name}</p>
                                    <p class="text-sm font-semibold text-gray-900">${product.facilities} <span class="text-gray-500 font-normal"> ${percentage}%</span></p>
                                </div>
                            `;
                        }).join('');
                        productListEl.innerHTML = legendHTML;
                    }
                } else {
                    // No expired products with facilities
                    const noDataMsg = '<div class="flex items-center justify-center h-full py-12 text-sm text-gray-500">No expired facilities</div>';
                    if (productChartEl) productChartEl.innerHTML = noDataMsg;
                    if (productListEl) productListEl.innerHTML = '';
                }
            } else {
                // No expired product data at all
                const noDataMsg = '<div class="flex items-center justify-center h-full py-12 text-sm text-gray-500">No expired facilities</div>';
                if (productChartEl) productChartEl.innerHTML = noDataMsg;
                if (productListEl) productListEl.innerHTML = '';
            }
            
            console.log(' renderExpiringAnalysis completed successfully');
            
            } catch (error) {
                console.error(' Error in renderExpiringAnalysis:', error);
                console.error('Error stack:', error.stack);
            }
        }
        
        // Render New Facilities Expanded Analysis Views
        function renderNewFacilitiesExpandedViews(regional, products, facilities, underwriters) {
            console.log(' renderNewFacilitiesExpandedViews called with:', {
                regional: regional,
                products: products ? products.length : 0,
                facilities: facilities ? facilities.length : 0,
                underwriters: underwriters ? underwriters.length : 0
            });
            
            if (typeof ApexCharts === 'undefined') {
                console.error(' ApexCharts is not defined');
                return;
            }
            
            // Use parameters if provided, otherwise fall back to window variable for backward compatibility
            if (!regional && window.newFacilitiesExpandedData) {
                console.log('Using window.newFacilitiesExpandedData fallback');
                regional = window.newFacilitiesExpandedData.regional;
                products = window.newFacilitiesExpandedData.products;
                facilities = window.newFacilitiesExpandedData.facilities || [];
                underwriters = window.newFacilitiesExpandedData.underwriters || [];
            }
            
            if (!regional) {
                console.error(' No regional data provided');
                return;
            }
            
            // Prepare regions - always show all regions, sorted by TFA
            const regionEntries = [
                { name: 'APAC', data: regional.APAC || {count: 0, tfa: 0} },
                { name: 'EMEA', data: regional.EMEA || {count: 0, tfa: 0} },
                { name: 'NAM', data: regional.NAM || {count: 0, tfa: 0} },
                { name: 'LATAM', data: regional.LATAM || {count: 0, tfa: 0} }
            ].sort((a, b) => b.data.tfa - a.data.tfa);
            
            // Update KPI cards
            const totalFacilities = regionEntries.reduce((sum, r) => sum + r.data.count, 0);
            const totalTFA = regionEntries.reduce((sum, r) => sum + r.data.tfa, 0);
            const activeRegions = regionEntries.filter(r => r.data.count > 0).length;
            const totalUnderwriters = underwriters ? underwriters.length : 0;
            
            const facilitiesCountEl = document.getElementById('newFacilitiesCount');
            const facilitiesTotalTFAEl = document.getElementById('newFacilitiesTotalTFA');
            const facilitiesRegionsEl = document.getElementById('newFacilitiesRegions');
            const facilitiesUnderwritersEl = document.getElementById('newFacilitiesUnderwriters');
            
            if (facilitiesCountEl) facilitiesCountEl.textContent = totalFacilities;
            if (facilitiesTotalTFAEl) facilitiesTotalTFAEl.textContent = formatCurrency(totalTFA);
            if (facilitiesRegionsEl) facilitiesRegionsEl.textContent = activeRegions;
            if (facilitiesUnderwritersEl) facilitiesUnderwritersEl.textContent = totalUnderwriters;
            
            // 1. Regional Summary Table - matches Expiring modal style
            const regionalTableEl = document.getElementById('newFacilitiesRegionalTable');
            if (regionalTableEl) {
                let tableHTML = `
                    <table class="w-full h-full">
                        <thead>
                            <tr class="border-b border-gray-200 bg-gray-50">
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700">Region</th>
                                <th class="px-6 py-4 text-right text-xs font-semibold text-gray-700">Facilities</th>
                                <th class="px-6 py-4 text-right text-xs font-semibold text-gray-700">Total TFA</th>
                                <th class="px-6 py-4 text-right text-xs font-semibold text-gray-700">Avg per Facility</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                `;
                
                let totalCount = 0, totalTFA = 0;
                regionEntries.forEach(region => {
                    totalCount += region.data.count;
                    totalTFA += region.data.tfa;
                    const avg = region.data.count > 0 ? region.data.tfa / region.data.count : 0;
                    
                    tableHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 text-sm font-medium text-gray-900">${region.name}</td>
                            <td class="px-6 py-4 text-sm text-right text-gray-700">${region.data.count}</td>
                            <td class="px-6 py-4 text-sm text-right font-medium text-gray-900">${formatCurrency(region.data.tfa)}</td>
                            <td class="px-6 py-4 text-sm text-right text-gray-600">${formatCurrency(avg)}</td>
                        </tr>
                    `;
                });
                
                const avgTotal = totalCount > 0 ? totalTFA / totalCount : 0;
                tableHTML += `
                        <tr class="bg-gray-50 font-semibold border-t-2 border-gray-300">
                            <td class="px-6 py-4 text-sm text-gray-900 rounded-bl-xl">Total</td>
                            <td class="px-6 py-4 text-sm text-right text-gray-900">${totalCount}</td>
                            <td class="px-6 py-4 text-sm text-right text-gray-900">${formatCurrency(totalTFA)}</td>
                            <td class="px-6 py-4 text-sm text-right text-gray-900 rounded-br-xl">${formatCurrency(avgTotal)}</td>
                        </tr>
                    </tbody>
                </table>
                `;
                regionalTableEl.innerHTML = tableHTML;
            }
            
            // 2. Approval Timeline Chart - Top 10 Underwriters by Deal Count (horizontal bar)
            const timelineChartEl = document.getElementById('newFacilitiesSizeChart');
            if (timelineChartEl) {
                if (underwriters && underwriters.length > 0) {
                    const chartHeight = Math.max(280, underwriters.length * 34);
                    const timelineOptions = {
                        series: [{
                            name: 'Deals',
                            data: underwriters.map(u => u.deals)
                        }],
                        chart: {
                            type: 'bar',
                            height: chartHeight,
                            fontFamily: 'Outfit, sans-serif',
                            toolbar: { show: false },
                            parentHeightOffset: 0
                        },
                        colors: ['#465fff'],
                        plotOptions: {
                            bar: {
                                borderRadius: 6,
                                horizontal: true,
                                distributed: false,
                                dataLabels: { position: 'right' },
                                barHeight: '70%'
                            }
                        },
                        dataLabels: {
                            enabled: true,
                            textAnchor: 'start',
                            offsetX: 16,
                            formatter: function(val) {
                                return val + ' deals';
                            },
                            style: {
                                fontSize: '11px',
                                fontWeight: 500,
                                colors: ['#374151']
                            },
                            background: {
                                enabled: true,
                                foreColor: '#374151',
                                backgroundColor: '#F3F4F6',
                                borderRadius: 12,
                                padding: 8,
                                opacity: 1,
                                borderWidth: 0
                            }
                        },
                        xaxis: {
                            categories: underwriters.map((u, idx) => `${idx + 1}. ${u.name}`),
                            labels: {
                                style: {
                                    colors: "#6B7280",
                                    fontSize: "12px",
                                    fontFamily: "Outfit, sans-serif",
                                },
                            },
                            axisBorder: { show: false },
                            axisTicks: { show: false },
                        },
                        yaxis: {
                            labels: {
                                align: 'left',
                                offsetX: -10,
                                style: {
                                    colors: "#6B7280",
                                    fontSize: "12px",
                                    fontFamily: "Outfit, sans-serif",
                                },
                                maxWidth: 200
                            },
                        },
                        grid: {
                            borderColor: '#E5E7EB',
                            strokeDashArray: 4,
                            xaxis: { lines: { show: true } },
                            yaxis: { lines: { show: false } },
                            padding: {
                                top: 4,
                                right: 0,
                                bottom: 0,
                                left: 0
                            }
                        },
                        tooltip: {
                            theme: 'light',
                            followCursor: false,
                            custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                                const underwriterData = underwriters[dataPointIndex];
                                const underwriterName = underwriterData.name;
                                const dealCount = underwriterData.deals;
                                const regionalBreakdown = underwriterData.regionalBreakdown || { NAM: { count: 0, tfa: 0 }, LATAM: { count: 0, tfa: 0 }, EMEA: { count: 0, tfa: 0 }, APAC: { count: 0, tfa: 0 } };
                                
                                // Calculate total TFA across all regions
                                let totalTFA = 0;
                                Object.values(regionalBreakdown).forEach(region => {
                                    totalTFA += region.tfa;
                                });
                                
                                // Build regional table rows
                                let regionalRows = '';
                                ['NAM', 'LATAM', 'EMEA', 'APAC'].forEach(region => {
                                    const regionData = regionalBreakdown[region];
                                    if (regionData && (regionData.count > 0 || regionData.tfa > 0)) {
                                        regionalRows += `
                                            <tr>
                                                <td style="padding: 6px 8px; text-align: left; font-size: 11px; color: #6B7280; font-weight: 500;">${region}</td>
                                                <td style="padding: 6px 8px; text-align: center; font-size: 11px; color: #111827; font-weight: 600;">${regionData.count}</td>
                                                <td style="padding: 6px 8px; text-align: right; font-size: 11px; color: #111827; font-weight: 600;">${formatCurrency(regionData.tfa)}</td>
                                            </tr>
                                        `;
                                    }
                                });
                                
                                return `
                                    <div style="
                                        background: #ffffff; 
                                        border-radius: 12px; 
                                        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
                                        min-width: 320px;
                                        max-width: 360px;
                                        overflow: hidden;
                                        font-family: Outfit, sans-serif;
                                    ">
                                        <!-- Header with border -->
                                        <div style="
                                            border-bottom: 1px solid #E5E7EB;
                                            padding: 16px 16px 12px 16px;
                                            margin-bottom: 14px;
                                        ">
                                            <div style="
                                                font-weight: 600; 
                                                font-size: 15px; 
                                                color: #111827;
                                                margin-bottom: 4px;
                                            ">${underwriterName}</div>
                                            <div style="
                                                font-size: 12px; 
                                                font-weight: 500;
                                                color: #6B7280;
                                            ">Lead Underwriter</div>
                                        </div>
                                        
                                        <!-- Content wrapper -->
                                        <div style="padding: 0 16px 16px 16px;">
                                            <!-- Widget Grid (2 columns) -->
                                            <div style="
                                                display: grid;
                                                grid-template-columns: 1fr 1fr;
                                                gap: 10px;
                                                margin-bottom: 16px;
                                            ">
                                                <!-- Widget 1: Deal Count -->
                                                <div style="
                                                    background: #F9FAFB;
                                                    border-radius: 8px;
                                                    padding: 12px;
                                                    border: 1px solid #E5E7EB;
                                                ">
                                                    <div style="
                                                        display: flex;
                                                        align-items: center;
                                                        gap: 6px;
                                                        font-size: 11px;
                                                        color: #6B7280;
                                                        font-weight: 500;
                                                        margin-bottom: 6px;
                                                    ">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                                        </svg>
                                                        Deals
                                                    </div>
                                                    <div style="
                                                        font-size: 20px;
                                                        font-weight: 700;
                                                        color: #111827;
                                                    ">${dealCount}</div>
                                                </div>
                                                
                                                <!-- Widget 2: TFA -->
                                                <div style="
                                                    background: #F9FAFB;
                                                    border-radius: 8px;
                                                    padding: 12px;
                                                    border: 1px solid #E5E7EB;
                                                ">
                                                    <div style="
                                                        display: flex;
                                                        align-items: center;
                                                        gap: 6px;
                                                        font-size: 11px;
                                                        color: #6B7280;
                                                        font-weight: 500;
                                                        margin-bottom: 6px;
                                                    ">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <line x1="12" y1="1" x2="12" y2="23"></line>
                                                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                                        </svg>
                                                        TFA
                                                    </div>
                                                    <div style="
                                                        font-size: 14px;
                                                        font-weight: 700;
                                                        color: #111827;
                                                    ">${formatCurrency(totalTFA)}</div>
                                                </div>
                                            </div>
                                            
                                            <!-- Regional Distribution Table -->
                                            <div style="margin-top: 12px;">
                                                <div style="
                                                    display: flex;
                                                    align-items: center;
                                                    gap: 6px;
                                                    margin-bottom: 8px;
                                                ">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2">
                                                        <circle cx="12" cy="12" r="10"></circle>
                                                        <line x1="2" y1="12" x2="22" y2="12"></line>
                                                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                                    </svg>
                                                    <span style="
                                                        font-size: 12px;
                                                        font-weight: 600;
                                                        color: #374151;
                                                    ">Regional Distribution</span>
                                                </div>
                                                <table style="width: 100%; border-collapse: collapse;">
                                                    <thead>
                                                        <tr style="border-bottom: 1px solid #E5E7EB;">
                                                            <th style="padding: 6px 8px; text-align: left; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Region</th>
                                                            <th style="padding: 6px 8px; text-align: center; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Deals</th>
                                                            <th style="padding: 6px 8px; text-align: right; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">TFA</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${regionalRows || '<tr><td colspan="3" style="padding: 8px; text-align: center; font-size: 11px; color: #9CA3AF;">No data</td></tr>'}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        }
                    };
                    
                    timelineChartEl.innerHTML = '';
                    const timelineChart = new ApexCharts(timelineChartEl, timelineOptions);
                    timelineChart.render();
                    
                    // Add tooltip positioning fix
                    setTimeout(() => {
                        const tooltipObserver = new MutationObserver(() => {
                            const tooltip = timelineChartEl.querySelector('.apexcharts-tooltip.apexcharts-active');
                            if (tooltip && !tooltip.hasAttribute('data-positioned')) {
                                const tooltipRect = tooltip.getBoundingClientRect();
                                const windowWidth = window.innerWidth;
                                const windowHeight = window.innerHeight;
                                const margin = 10;
                                
                                let needsReposition = false;
                                
                                if (tooltipRect.left < margin) {
                                    tooltip.style.left = margin + 'px';
                                    tooltip.style.transform = 'none';
                                    needsReposition = true;
                                } else if (tooltipRect.right > windowWidth - margin) {
                                    tooltip.style.left = (windowWidth - tooltipRect.width - margin) + 'px';
                                    tooltip.style.transform = 'none';
                                    needsReposition = true;
                                }
                                
                                if (tooltipRect.top < margin) {
                                    tooltip.style.top = margin + 'px';
                                    needsReposition = true;
                                } else if (tooltipRect.bottom > windowHeight - margin) {
                                    tooltip.style.top = (windowHeight - tooltipRect.height - margin) + 'px';
                                    needsReposition = true;
                                }
                                
                                if (needsReposition) {
                                    tooltip.setAttribute('data-positioned', 'true');
                                }
                            }
                            
                            const hiddenTooltip = timelineChartEl.querySelector('.apexcharts-tooltip:not(.apexcharts-active)[data-positioned]');
                            if (hiddenTooltip) {
                                hiddenTooltip.removeAttribute('data-positioned');
                            }
                        });
                        
                        tooltipObserver.observe(timelineChartEl, {
                            attributes: true,
                            attributeFilter: ['class'],
                            subtree: true
                        });
                    }, 200);
                } else {
                    // Show "No data" message if no underwriter data
                    timelineChartEl.innerHTML = '<div class="flex items-center justify-center h-full"><p class="text-sm text-gray-500">No underwriter data available for this period</p></div>';
                }
            }
            
            // 3. Top 10 Facilities Table - showing facilities with highest TFA approved
            const facilitiesTableEl = document.getElementById('newFacilitiesUnderwriterTable');
            if (facilitiesTableEl) {
                let tableHTML = `
                    <table class="min-w-full">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Facility ID</th>
                                <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Relationship</th>
                                <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Region</th>
                                <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Underwriter</th>
                                <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Product</th>
                                <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Approval Date</th>
                                <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">TFA Approved</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                `;
                
                if (facilities && facilities.length > 0) {
                    facilities.forEach((fac, index) => {
                        const regionColor = {
                            'APAC': 'bg-blue-100 text-blue-700',
                            'EMEA': 'bg-green-100 text-green-700',
                            'NAM': 'bg-purple-100 text-purple-700',
                            'LATAM': 'bg-orange-100 text-orange-700'
                        }[fac.region] || 'bg-gray-100 text-gray-700';
                        
                        tableHTML += `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 text-center text-sm font-medium text-gray-900">${fac.facilityId}</td>
                                <td class="px-6 py-4 text-center text-sm text-gray-700">${fac.relationship}</td>
                                <td class="px-6 py-4 text-center">
                                    <span class="inline-flex items-center justify-center rounded-full ${regionColor} px-2.5 py-0.5 text-xs font-medium">
                                        ${fac.region}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-center text-sm text-gray-700">${fac.underwriter}</td>
                                <td class="px-6 py-4 text-center text-sm text-gray-700">${fac.product}</td>
                                <td class="px-6 py-4 text-center text-sm text-gray-700">${fac.approvalDate}</td>
                                <td class="px-6 py-4 text-center text-sm whitespace-nowrap font-semibold text-gray-900">${formatCurrency(fac.tfa)}</td>
                            </tr>
                        `;
                    });
                } else {
                    tableHTML += `
                        <tr>
                            <td colspan="7" class="px-6 py-8 text-center text-sm text-gray-500">No facilities data available</td>
                        </tr>
                    `;
                }
                
                tableHTML += `
                    </tbody>
                </table>
                `;
                facilitiesTableEl.innerHTML = tableHTML;
            }
            
            // 4. Product Distribution Chart
            const productChartEl = document.getElementById('newFacilitiesProductChart');
            if (productChartEl && products && products.length > 0) {
                const productChartHeight = Math.max(280, products.length * 34);
                const productOptions = {
                    series: [{
                        name: 'TFA',
                        data: products.map(p => p.tfa)
                    }],
                    chart: {
                        type: 'bar',
                        height: productChartHeight,
                        fontFamily: 'Outfit, sans-serif',
                        toolbar: { show: false },
                        parentHeightOffset: 0
                    },
                    colors: ['#465fff'],
                    plotOptions: {
                        bar: {
                            borderRadius: 6,
                            horizontal: true,
                            distributed: false,
                            dataLabels: { position: 'right' },
                            barHeight: '70%'
                        }
                    },
                    dataLabels: {
                        enabled: true,
                        textAnchor: 'start',
                        offsetX: 16,
                        formatter: function(val) {
                            return formatCurrency(val);
                        },
                        style: {
                            fontSize: '11px',
                            fontWeight: 500,
                            colors: ['#374151']
                        },
                        background: {
                            enabled: true,
                            foreColor: '#374151',
                            backgroundColor: '#F3F4F6',
                            borderRadius: 12,
                            padding: 8,
                            opacity: 1,
                            borderWidth: 0
                        }
                    },
                    xaxis: {
                        categories: products.map(p => p.name),
                        labels: {
                            formatter: function(val) {
                                return formatCurrency(val);
                            },
                            style: {
                                colors: "#6B7280",
                                fontSize: "12px",
                                fontFamily: "Outfit, sans-serif",
                            },
                        },
                        axisBorder: { show: false },
                        axisTicks: { show: false },
                    },
                    yaxis: {
                        labels: {
                            align: 'left',
                            offsetX: -10,
                            style: {
                                colors: "#6B7280",
                                fontSize: "12px",
                                fontFamily: "Outfit, sans-serif",
                            },
                            maxWidth: 180
                        },
                    },
                    grid: {
                        borderColor: '#E5E7EB',
                        strokeDashArray: 4,
                        xaxis: { lines: { show: true } },
                        yaxis: { lines: { show: false } },
                        padding: {
                            top: 4,
                            right: 0,
                            bottom: 0,
                            left: 0
                        }
                    },
                    tooltip: {
                        theme: 'light',
                        y: {
                            formatter: function(val, opts) {
                                const count = products[opts.dataPointIndex].count;
                                return formatCurrency(val) + ` (${count} facilities)`;
                            }
                        }
                    }
                };
                
                productChartEl.innerHTML = '';
                const productChart = new ApexCharts(productChartEl, productOptions);
                productChart.render();
            }
        }
        
        // Render New Deals YTD Expanded Analysis Views
        function renderNewDealsYTDExpandedViews() {
            if (!window.newDealsYTDExpandedData || typeof ApexCharts === 'undefined') return;
            
            const {
                regionalData,
                topProducts,
                topUnderwriters,
                monthlyTrend,
                creditClassification,
                prevYearFacilities,
                prevYearTFA,
                currentCount,
                currentTFA,
                countVariance,
                countVariancePercent,
                tfaVariance,
                tfaVariancePercent,
                currentYear,
                reportingMonth
            } = window.newDealsYTDExpandedData;
            
            // 1. Update KPI Cards
            const kpisEl = document.getElementById('newDealsYTDKPIs');
            if (kpisEl) {
                const avgDealSize = currentCount > 0 ? currentTFA / currentCount : 0;
                const productCount = topProducts ? topProducts.length : 0;
                
                kpisEl.innerHTML = `
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-blue-100">
                                <svg class="h-5 w-5 shrink-0 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-500">New Deals YTD</p>
                                <h3 class="text-2xl font-bold text-gray-900">${currentCount}</h3>
                                <div class="flex items-center gap-1 mt-1">
                                    <span class="text-xs ${countVariance >= 0 ? 'text-green-600' : 'text-red-600'}">${countVariance >= 0 ? '' : ''} ${Math.abs(countVariancePercent).toFixed(1)}%</span>
                                    <span class="text-sm font-medium text-gray-500">vs PY</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-green-100">
                                <svg class="h-5 w-5 shrink-0 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-500">Total TFA YTD</p>
                                <h3 class="text-2xl font-bold text-gray-900">${formatCurrency(currentTFA)}</h3>
                                <div class="flex items-center gap-1 mt-1">
                                    <span class="text-xs ${tfaVariance >= 0 ? 'text-green-600' : 'text-red-600'}">${tfaVariance >= 0 ? '' : ''} ${Math.abs(tfaVariancePercent).toFixed(1)}%</span>
                                    <span class="text-sm font-medium text-gray-500">vs PY</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-purple-100">
                                <svg class="h-5 w-5 shrink-0 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-500">Avg Deal Size</p>
                                <h3 class="text-2xl font-bold text-gray-900">${formatCurrency(avgDealSize)}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">Per facility</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-amber-100">
                                <svg class="h-5 w-5 shrink-0 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-500">Product Programs</p>
                                <h3 class="text-2xl font-bold text-gray-900">${productCount}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">Categories</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // 2. Update Year-over-Year Comparison
            const yoyEl = document.getElementById('newDealsYTDYoYComparison');
            if (yoyEl) {
                yoyEl.innerHTML = `
                    <h3 class="text-base font-semibold text-gray-900 mb-4">Year-over-Year Performance</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="text-center">
                            <p class="text-sm text-gray-600 mb-2">${currentYear} YTD</p>
                            <p class="text-3xl font-bold text-blue-600">${currentCount}</p>
                            <p class="text-sm text-gray-500 mt-1">${formatCurrency(currentTFA)}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600 mb-2">${currentYear - 1} Same Period</p>
                            <p class="text-3xl font-bold text-gray-600">${prevYearFacilities}</p>
                            <p class="text-sm text-gray-500 mt-1">${formatCurrency(prevYearTFA)}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600 mb-2">Variance</p>
                            <p class="text-3xl font-bold ${countVariance >= 0 ? 'text-green-600' : 'text-red-600'}">${countVariance >= 0 ? '+' : ''}${countVariance}</p>
                            <p class="text-sm ${tfaVariance >= 0 ? 'text-green-600' : 'text-red-600'} mt-1">${tfaVariance >= 0 ? '+' : ''}${formatCurrency(tfaVariance)}</p>
                        </div>
                    </div>
                `;
            }
            
            // 3. Regional Summary Table
            const regionalTableEl = document.getElementById('newDealsYTDRegionalTable');
            if (regionalTableEl && regionalData) {
                const regionEntries = [
                    { name: 'APAC', ...regionalData.APAC || {count: 0, tfa: 0} },
                    { name: 'EMEA', ...regionalData.EMEA || {count: 0, tfa: 0} },
                    { name: 'NAM', ...regionalData.NAM || {count: 0, tfa: 0} },
                    { name: 'LATAM', ...regionalData.LATAM || {count: 0, tfa: 0} }
                ].sort((a, b) => b.tfa - a.tfa);
                
                let tableHTML = `
                    <table class="w-full h-full">
                        <thead>
                            <tr class="border-b border-gray-200 bg-gray-50">
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700">Region</th>
                                <th class="px-6 py-4 text-right text-xs font-semibold text-gray-700">New Deals</th>
                                <th class="px-6 py-4 text-right text-xs font-semibold text-gray-700">Total TFA</th>
                                <th class="px-6 py-4 text-right text-xs font-semibold text-gray-700">Avg per Deal</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                `;
                
                let totalCount = 0, totalTFA = 0;
                regionEntries.forEach(region => {
                    totalCount += region.count;
                    totalTFA += region.tfa;
                    const avg = region.count > 0 ? region.tfa / region.count : 0;
                    
                    tableHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 text-sm font-medium text-gray-900">${region.name}</td>
                            <td class="px-6 py-4 text-sm text-right text-gray-700">${region.count}</td>
                            <td class="px-6 py-4 text-sm text-right font-medium text-gray-900">${formatCurrency(region.tfa)}</td>
                            <td class="px-6 py-4 text-sm text-right text-gray-600">${formatCurrency(avg)}</td>
                        </tr>
                    `;
                });
                
                const avgTotal = totalCount > 0 ? totalTFA / totalCount : 0;
                tableHTML += `
                        <tr class="bg-gray-50 font-semibold border-t-2 border-gray-300">
                            <td class="px-6 py-4 text-sm text-gray-900 rounded-bl-xl">Total</td>
                            <td class="px-6 py-4 text-sm text-right text-gray-900">${totalCount}</td>
                            <td class="px-6 py-4 text-sm text-right text-gray-900">${formatCurrency(totalTFA)}</td>
                            <td class="px-6 py-4 text-sm text-right text-gray-900 rounded-br-xl">${formatCurrency(avgTotal)}</td>
                        </tr>
                    </tbody>
                </table>
                `;
                regionalTableEl.innerHTML = tableHTML;
            }
            
            // 4. Monthly Trend Chart
            const monthlyChartEl = document.getElementById('newDealsYTDMonthlyChart');
            if (monthlyChartEl && monthlyTrend && monthlyTrend.length > 0) {
                const monthlyOptions = {
                    series: [{
                        name: 'Deals',
                        data: monthlyTrend.map(m => m.count)
                    }],
                    chart: {
                        type: 'bar',
                        height: 300,
                        fontFamily: 'Outfit, sans-serif',
                        toolbar: { show: false },
                        parentHeightOffset: 0
                    },
                    colors: ['#465fff'],
                    plotOptions: {
                        bar: {
                            borderRadius: 6,
                            columnWidth: '60%',
                            dataLabels: { position: 'top' }
                        }
                    },
                    dataLabels: {
                        enabled: true,
                        offsetY: -20,
                        formatter: function(val) {
                            return val;
                        },
                        style: {
                            fontSize: '11px',
                            fontWeight: 500,
                            colors: ['#374151']
                        },
                        background: {
                            enabled: true,
                            foreColor: '#374151',
                            backgroundColor: '#F3F4F6',
                            borderRadius: 12,
                            padding: 8,
                            opacity: 1,
                            borderWidth: 0
                        }
                    },
                    xaxis: {
                        categories: monthlyTrend.map((m, idx) => `${idx + 1}. ${m.name}`),
                        labels: {
                            style: {
                                colors: "#6B7280",
                                fontSize: "12px",
                                fontFamily: "Outfit, sans-serif",
                            },
                        },
                        axisBorder: { show: false },
                        axisTicks: { show: false }
                    },
                    yaxis: {
                        labels: {
                            style: {
                                colors: "#6B7280",
                                fontSize: "12px",
                                fontFamily: "Outfit, sans-serif",
                            },
                        },
                    },
                    grid: {
                        borderColor: '#E5E7EB',
                        strokeDashArray: 4,
                        xaxis: { lines: { show: false } },
                        yaxis: { lines: { show: true } },
                        padding: {
                            top: 4,
                            right: 0,
                            bottom: 0,
                            left: 0
                        }
                    },
                    tooltip: {
                        theme: 'light',
                        followCursor: false,
                        custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                            const monthData = monthlyTrend[dataPointIndex];
                            const monthName = monthData.name;
                            const dealCount = monthData.count;
                            const totalTFA = monthData.tfa;
                            const regionalBreakdown = monthData.regionalBreakdown || { NAM: { count: 0, tfa: 0 }, LATAM: { count: 0, tfa: 0 }, EMEA: { count: 0, tfa: 0 }, APAC: { count: 0, tfa: 0 } };
                            
                            // Build regional table rows
                            let regionalRows = '';
                            ['NAM', 'LATAM', 'EMEA', 'APAC'].forEach(region => {
                                const regionData = regionalBreakdown[region];
                                if (regionData && (regionData.count > 0 || regionData.tfa > 0)) {
                                    regionalRows += `
                                        <tr>
                                            <td style="padding: 6px 8px; text-align: left; font-size: 11px; color: #6B7280; font-weight: 500;">${region}</td>
                                            <td style="padding: 6px 8px; text-align: center; font-size: 11px; color: #111827; font-weight: 600;">${regionData.count}</td>
                                            <td style="padding: 6px 8px; text-align: right; font-size: 11px; color: #111827; font-weight: 600;">${formatCurrency(regionData.tfa)}</td>
                                        </tr>
                                    `;
                                }
                            });
                            
                            return `
                                <div style="
                                    background: #ffffff; 
                                    border-radius: 12px; 
                                    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
                                    min-width: 320px;
                                    max-width: 360px;
                                    overflow: hidden;
                                    font-family: Outfit, sans-serif;
                                ">
                                    <!-- Header with border -->
                                    <div style="
                                        border-bottom: 1px solid #E5E7EB;
                                        padding: 16px 16px 12px 16px;
                                        margin-bottom: 14px;
                                    ">
                                        <div style="
                                            font-weight: 600; 
                                            font-size: 15px; 
                                            color: #111827;
                                            margin-bottom: 4px;
                                        ">${monthName}</div>
                                        <div style="
                                            font-size: 12px; 
                                            font-weight: 500;
                                            color: #6B7280;
                                        ">Monthly Trend</div>
                                    </div>
                                    
                                    <!-- Content wrapper -->
                                    <div style="padding: 0 16px 16px 16px;">
                                        <!-- Widget Grid (2 columns) -->
                                        <div style="
                                            display: grid;
                                            grid-template-columns: 1fr 1fr;
                                            gap: 10px;
                                            margin-bottom: 16px;
                                        ">
                                            <!-- Widget 1: Deal Count -->
                                            <div style="
                                                background: #F9FAFB;
                                                border-radius: 8px;
                                                padding: 12px;
                                                border: 1px solid #E5E7EB;
                                            ">
                                                <div style="
                                                    display: flex;
                                                    align-items: center;
                                                    gap: 6px;
                                                    font-size: 11px;
                                                    color: #6B7280;
                                                    font-weight: 500;
                                                    margin-bottom: 6px;
                                                ">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                                    </svg>
                                                    Deals
                                                </div>
                                                <div style="
                                                    font-size: 20px;
                                                    font-weight: 700;
                                                    color: #111827;
                                                ">${dealCount}</div>
                                            </div>
                                            
                                            <!-- Widget 2: TFA -->
                                            <div style="
                                                background: #F9FAFB;
                                                border-radius: 8px;
                                                padding: 12px;
                                                border: 1px solid #E5E7EB;
                                            ">
                                                <div style="
                                                    display: flex;
                                                    align-items: center;
                                                    gap: 6px;
                                                    font-size: 11px;
                                                    color: #6B7280;
                                                    font-weight: 500;
                                                    margin-bottom: 6px;
                                                ">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <line x1="12" y1="1" x2="12" y2="23"></line>
                                                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                                    </svg>
                                                    TFA
                                                </div>
                                                <div style="
                                                    font-size: 14px;
                                                    font-weight: 700;
                                                    color: #111827;
                                                ">${formatCurrency(totalTFA)}</div>
                                            </div>
                                        </div>
                                        
                                        <!-- Regional Distribution Table -->
                                        <div style="margin-top: 12px;">
                                            <div style="
                                                display: flex;
                                                align-items: center;
                                                gap: 6px;
                                                margin-bottom: 8px;
                                            ">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2">
                                                    <circle cx="12" cy="12" r="10"></circle>
                                                    <line x1="2" y1="12" x2="22" y2="12"></line>
                                                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                                </svg>
                                                <span style="
                                                    font-size: 12px;
                                                    font-weight: 600;
                                                    color: #374151;
                                                ">Regional Distribution</span>
                                            </div>
                                            <table style="width: 100%; border-collapse: collapse;">
                                                <thead>
                                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                                        <th style="padding: 6px 8px; text-align: left; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Region</th>
                                                        <th style="padding: 6px 8px; text-align: center; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Deals</th>
                                                        <th style="padding: 6px 8px; text-align: right; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">TFA</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${regionalRows || '<tr><td colspan="3" style="padding: 8px; text-align: center; font-size: 11px; color: #9CA3AF;">No data</td></tr>'}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    }
                };
                
                monthlyChartEl.innerHTML = '';
                const monthlyChart = new ApexCharts(monthlyChartEl, monthlyOptions);
                monthlyChart.render();
                
                // Add tooltip positioning fix
                setTimeout(() => {
                    const tooltipObserver = new MutationObserver(() => {
                        const tooltip = monthlyChartEl.querySelector('.apexcharts-tooltip.apexcharts-active');
                        if (tooltip && !tooltip.hasAttribute('data-positioned')) {
                            const tooltipRect = tooltip.getBoundingClientRect();
                            const windowWidth = window.innerWidth;
                            const windowHeight = window.innerHeight;
                            const margin = 10;
                            
                            let needsReposition = false;
                            
                            if (tooltipRect.left < margin) {
                                tooltip.style.left = margin + 'px';
                                tooltip.style.transform = 'none';
                                needsReposition = true;
                            } else if (tooltipRect.right > windowWidth - margin) {
                                tooltip.style.left = (windowWidth - tooltipRect.width - margin) + 'px';
                                tooltip.style.transform = 'none';
                                needsReposition = true;
                            }
                            
                            if (tooltipRect.top < margin) {
                                tooltip.style.top = margin + 'px';
                                needsReposition = true;
                            } else if (tooltipRect.bottom > windowHeight - margin) {
                                tooltip.style.top = (windowHeight - tooltipRect.height - margin) + 'px';
                                needsReposition = true;
                            }
                            
                            if (needsReposition) {
                                tooltip.setAttribute('data-positioned', 'true');
                            }
                        }
                        
                        const hiddenTooltip = monthlyChartEl.querySelector('.apexcharts-tooltip:not(.apexcharts-active)[data-positioned]');
                        if (hiddenTooltip) {
                            hiddenTooltip.removeAttribute('data-positioned');
                        }
                    });
                    
                    tooltipObserver.observe(monthlyChartEl, {
                        attributes: true,
                        attributeFilter: ['class'],
                        subtree: true
                    });
                }, 200);
            }
            
            // 5. Product Distribution by TFA - Donut Chart (matching Deal Count style)
            const productChartEl = document.getElementById('newDealsYTDProductChart');
            const productListEl = document.getElementById('newDealsYTDProductList');
            if (productChartEl && topProducts && topProducts.length > 0) {
                const totalTFA = topProducts.reduce((sum, p) => sum + p.tfa, 0);
                const colors = [
                    "#3641f5",  // Primary blue
                    "#7592ff",  // Light blue
                    "#dde9ff",  // Lighter blue
                    "#ff6b6b",  // Red
                    "#ffd93d",  // Yellow
                    "#6bcf7f",  // Green
                    "#c084fc",  // Purple
                    "#14b8a6",  // Teal
                    "#f97316",  // Orange
                    "#06b6d4"   // Cyan
                ];
                
                const productDonutOptions = {
                    series: topProducts.map(p => p.tfa),
                    colors: colors.slice(0, topProducts.length),
                    labels: topProducts.map(p => p.name),
                    chart: {
                        fontFamily: "Outfit, sans-serif",
                        type: "donut",
                        width: 300,
                        height: 300,
                    },
                    stroke: {
                        show: false,
                    },
                    plotOptions: {
                        pie: {
                            donut: {
                                size: "65%",
                                background: "transparent",
                                labels: {
                                    show: true,
                                    name: {
                                        show: true,
                                        offsetY: -10,
                                        color: "#1D2939",
                                        fontSize: "14px",
                                        fontWeight: "600",
                                    },
                                    value: {
                                        show: true,
                                        offsetY: 10,
                                        color: "#667085",
                                        fontSize: "16px",
                                        fontWeight: "700",
                                        formatter: (val) => formatCurrency(val),
                                    },
                                    total: {
                                        show: true,
                                        label: "Total TFA",
                                        color: "#111827",
                                        fontSize: "16px",
                                        fontWeight: "700",
                                        formatter: () => formatCurrency(totalTFA),
                                    },
                                },
                            },
                        },
                    },
                    dataLabels: {
                        enabled: false,
                    },
                    legend: {
                        show: false, // Hide built-in legend, using custom HTML legend
                    },
                    tooltip: {
                        enabled: true,
                        theme: "light",
                        followCursor: false,
                        custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                            const product = topProducts[seriesIndex];
                            const productName = product.name;
                            const tfaAmount = product.tfa;
                            const dealCount = product.count;
                            const regionalBreakdown = product.regionalBreakdown || { NAM: { count: 0, tfa: 0 }, LATAM: { count: 0, tfa: 0 }, EMEA: { count: 0, tfa: 0 }, APAC: { count: 0, tfa: 0 } };
                            
                            // Build regional table rows
                            let regionalRows = '';
                            ['NAM', 'LATAM', 'EMEA', 'APAC'].forEach(region => {
                                const regionData = regionalBreakdown[region];
                                if (regionData && (regionData.count > 0 || regionData.tfa > 0)) {
                                    regionalRows += `
                                        <tr>
                                            <td style="padding: 6px 8px; text-align: left; font-size: 11px; color: #6B7280; font-weight: 500;">${region}</td>
                                            <td style="padding: 6px 8px; text-align: center; font-size: 11px; color: #111827; font-weight: 600;">${regionData.count}</td>
                                            <td style="padding: 6px 8px; text-align: right; font-size: 11px; color: #111827; font-weight: 600;">${formatCurrency(regionData.tfa)}</td>
                                        </tr>
                                    `;
                                }
                            });
                            
                            return `
                                <div style="
                                    background: #ffffff; 
                                    border-radius: 12px; 
                                    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
                                    min-width: 320px;
                                    max-width: 360px;
                                    overflow: hidden;
                                    font-family: Outfit, sans-serif;
                                ">
                                    <!-- Header with border -->
                                    <div style="
                                        border-bottom: 1px solid #E5E7EB;
                                        padding: 16px 16px 12px 16px;
                                        margin-bottom: 14px;
                                    ">
                                        <div style="
                                            font-weight: 600; 
                                            font-size: 15px; 
                                            color: #111827;
                                            margin-bottom: 4px;
                                        ">${productName}</div>
                                        <div style="
                                            font-size: 12px; 
                                            font-weight: 500;
                                            color: #6B7280;
                                        ">Product Program</div>
                                    </div>
                                    
                                    <!-- Content wrapper -->
                                    <div style="padding: 0 16px 16px 16px;">
                                        <!-- Widget Grid (2 columns) -->
                                        <div style="
                                            display: grid;
                                            grid-template-columns: 1fr 1fr;
                                            gap: 10px;
                                            margin-bottom: 16px;
                                        ">
                                            <!-- Widget 1: Deal Count -->
                                            <div style="
                                                background: #F9FAFB;
                                                border-radius: 8px;
                                                padding: 12px;
                                                border: 1px solid #E5E7EB;
                                            ">
                                                <div style="
                                                    display: flex;
                                                    align-items: center;
                                                    gap: 6px;
                                                    font-size: 11px;
                                                    color: #6B7280;
                                                    font-weight: 500;
                                                    margin-bottom: 6px;
                                                ">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                                    </svg>
                                                    Deals
                                                </div>
                                                <div style="
                                                    font-size: 20px;
                                                    font-weight: 700;
                                                    color: #111827;
                                                ">${dealCount}</div>
                                            </div>
                                            
                                            <!-- Widget 2: TFA -->
                                            <div style="
                                                background: #F9FAFB;
                                                border-radius: 8px;
                                                padding: 12px;
                                                border: 1px solid #E5E7EB;
                                            ">
                                                <div style="
                                                    display: flex;
                                                    align-items: center;
                                                    gap: 6px;
                                                    font-size: 11px;
                                                    color: #6B7280;
                                                    font-weight: 500;
                                                    margin-bottom: 6px;
                                                ">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <line x1="12" y1="1" x2="12" y2="23"></line>
                                                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                                    </svg>
                                                    TFA
                                                </div>
                                                <div style="
                                                    font-size: 14px;
                                                    font-weight: 700;
                                                    color: #111827;
                                                ">${formatCurrency(tfaAmount)}</div>
                                            </div>
                                        </div>
                                        
                                        <!-- Regional Distribution Table -->
                                        <div style="margin-top: 12px;">
                                            <div style="
                                                display: flex;
                                                align-items: center;
                                                gap: 6px;
                                                margin-bottom: 8px;
                                            ">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2">
                                                    <circle cx="12" cy="12" r="10"></circle>
                                                    <line x1="2" y1="12" x2="22" y2="12"></line>
                                                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                                </svg>
                                                <span style="
                                                    font-size: 12px;
                                                    font-weight: 600;
                                                    color: #374151;
                                                ">Regional Distribution</span>
                                            </div>
                                            <table style="width: 100%; border-collapse: collapse;">
                                                <thead>
                                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                                        <th style="padding: 6px 8px; text-align: left; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Region</th>
                                                        <th style="padding: 6px 8px; text-align: center; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Deals</th>
                                                        <th style="padding: 6px 8px; text-align: right; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">TFA</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${regionalRows || '<tr><td colspan="3" style="padding: 8px; text-align: center; font-size: 11px; color: #9CA3AF;">No data</td></tr>'}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    },
                };
                
                productChartEl.innerHTML = '';
                const productDonutChart = new ApexCharts(productChartEl, productDonutOptions);
                productDonutChart.render();
                
                // Add tooltip positioning fix
                setTimeout(() => {
                    const tooltipObserver = new MutationObserver(() => {
                        const tooltip = productChartEl.querySelector('.apexcharts-tooltip.apexcharts-active');
                        if (tooltip && !tooltip.hasAttribute('data-positioned')) {
                            const tooltipRect = tooltip.getBoundingClientRect();
                            const windowWidth = window.innerWidth;
                            const windowHeight = window.innerHeight;
                            const margin = 10;
                            
                            let needsReposition = false;
                            
                            if (tooltipRect.left < margin) {
                                tooltip.style.left = margin + 'px';
                                tooltip.style.transform = 'none';
                                needsReposition = true;
                            } else if (tooltipRect.right > windowWidth - margin) {
                                tooltip.style.left = (windowWidth - tooltipRect.width - margin) + 'px';
                                tooltip.style.transform = 'none';
                                needsReposition = true;
                            }
                            
                            if (tooltipRect.top < margin) {
                                tooltip.style.top = margin + 'px';
                                needsReposition = true;
                            } else if (tooltipRect.bottom > windowHeight - margin) {
                                tooltip.style.top = (windowHeight - tooltipRect.height - margin) + 'px';
                                needsReposition = true;
                            }
                            
                            if (needsReposition) {
                                tooltip.setAttribute('data-positioned', 'true');
                            }
                        }
                        
                        const hiddenTooltip = productChartEl.querySelector('.apexcharts-tooltip:not(.apexcharts-active)[data-positioned]');
                        if (hiddenTooltip) {
                            hiddenTooltip.removeAttribute('data-positioned');
                        }
                    });
                    
                    tooltipObserver.observe(productChartEl, {
                        attributes: true,
                        attributeFilter: ['class'],
                        subtree: true
                    });
                }, 200);
                
                // Populate legend list
                if (productListEl) {
                    productListEl.innerHTML = topProducts.map((product, index) => {
                        const color = colors[index % colors.length];
                        const formattedAmount = product.tfa >= 1000000000 
                            ? `$${(product.tfa / 1000000000).toFixed(2)}B`
                            : `$${(product.tfa / 1000000).toFixed(1)}M`;
                        return `
                            <div class="flex items-center gap-3 py-2">
                                <div class="w-4 h-4 rounded-sm flex-shrink-0" style="background-color: ${color};"></div>
                                <p class="text-sm font-medium text-gray-800 flex-1">${product.name}</p>
                                <p class="text-sm font-semibold text-gray-900">${formattedAmount}</p>
                            </div>
                        `;
                    }).join('');
                }
            }
            
            // 6. Product Distribution by Deals Count - Donut Chart
            const productCountChartElYTD = document.getElementById('newDealsYTDProductCountChart');
            const productCountListElYTD = document.getElementById('newDealsYTDProductCountList');
            if (productCountChartElYTD && topProducts && topProducts.length > 0) {
                const totalDealsForProductYTD = topProducts.reduce((sum, p) => sum + p.count, 0);
                const colors = [
                    "#3641f5",  // Primary blue
                    "#7592ff",  // Light blue
                    "#dde9ff",  // Lighter blue
                    "#ff6b6b",  // Red
                    "#ffd93d",  // Yellow
                    "#6bcf7f",  // Green
                    "#c084fc",  // Purple
                    "#14b8a6",  // Teal
                    "#f97316",  // Orange
                    "#06b6d4"   // Cyan
                ];
                
                const productCountDonutOptions = {
                    series: topProducts.map(p => p.count),
                    colors: colors,
                    labels: topProducts.map(p => p.name),
                    chart: {
                        fontFamily: "Outfit, sans-serif",
                        type: "donut",
                        width: 300,
                        height: 300,
                    },
                    stroke: {
                        show: false,
                    },
                    plotOptions: {
                        pie: {
                            donut: {
                                size: "65%",
                                background: "transparent",
                                labels: {
                                    show: true,
                                    name: {
                                        show: true,
                                        offsetY: -10,
                                        color: "#1D2939",
                                        fontSize: "14px",
                                        fontWeight: "600",
                                    },
                                    value: {
                                        show: true,
                                        offsetY: 10,
                                        color: "#667085",
                                        fontSize: "16px",
                                        fontWeight: "700",
                                        formatter: (val) => val.toString(),
                                    },
                                    total: {
                                        show: true,
                                        label: "Total Deals",
                                        color: "#111827",
                                        fontSize: "16px",
                                        fontWeight: "700",
                                        formatter: () => totalDealsForProductYTD.toString(),
                                    },
                                },
                            },
                        },
                    },
                    dataLabels: {
                        enabled: false,
                    },
                    legend: {
                        show: false,
                    },
                    tooltip: {
                        enabled: true,
                        theme: "light",
                        y: {
                            formatter: function(val, opts) {
                                const percentage = ((val / totalDealsForProductYTD) * 100).toFixed(1);
                                return val + ' deals (' + percentage + '%)';
                            }
                        }
                    },
                };
                
                productCountChartElYTD.innerHTML = '';
                const productCountChartYTD = new ApexCharts(productCountChartElYTD, productCountDonutOptions);
                productCountChartYTD.render();
                
                // Populate legend list
                if (productCountListElYTD) {
                    productCountListElYTD.innerHTML = topProducts.map((product, index) => {
                        const color = colors[index];
                        const percentage = ((product.count / totalDealsForProductYTD) * 100).toFixed(1);
                        return `
                            <div class="flex items-center gap-3 py-2">
                                <div class="w-4 h-4 rounded-sm flex-shrink-0" style="background-color: ${color};"></div>
                                <p class="text-sm font-medium text-gray-800 flex-1">${product.name}</p>
                                <p class="text-sm font-semibold text-gray-900">${product.count} (${percentage}%)</p>
                            </div>
                        `;
                    }).join('');
                }
            }
            
            // 6. Underwriter Table
            const underwriterTableEl = document.getElementById('newDealsYTDUnderwriterTable');
            if (underwriterTableEl) {
                let tableHTML = `
                    <table class="min-w-full">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Underwriter</th>
                                <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Region</th>
                                <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">New Deals</th>
                                <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Total TFA</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                `;
                
                if (topUnderwriters && topUnderwriters.length > 0) {
                    topUnderwriters.forEach((uw, index) => {
                        const regionColor = {
                            'APAC': 'bg-blue-100 text-blue-700',
                            'EMEA': 'bg-green-100 text-green-700',
                            'NAM': 'bg-purple-100 text-purple-700',
                            'LATAM': 'bg-orange-100 text-orange-700'
                        }[uw.region] || 'bg-gray-100 text-gray-700';
                        
                        tableHTML += `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 text-center text-sm font-medium text-gray-900">${uw.name}</td>
                                <td class="px-6 py-4 text-center">
                                    <span class="inline-flex items-center justify-center rounded-full ${regionColor} px-2.5 py-0.5 text-xs font-medium">
                                        ${uw.region}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <span class="inline-flex items-center justify-center rounded-full bg-blue-100 px-3 py-1 text-sm font-medium text-blue-700">
                                        ${uw.facilities}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-center text-sm whitespace-nowrap font-semibold text-gray-900">${formatCurrency(uw.tfa)}</td>
                            </tr>
                        `;
                    });
                } else {
                    tableHTML += `
                        <tr>
                            <td colspan="4" class="px-6 py-8 text-center text-sm text-gray-500">No data available</td>
                        </tr>
                    `;
                }
                
                tableHTML += `
                    </tbody>
                </table>
                `;
                underwriterTableEl.innerHTML = tableHTML;
            }
        }
        
        // Render New Deals MTD Expanded Analysis Views
        function renderNewDealsMTDExpandedViews() {
            if (!window.newDealsMTDExpandedData || typeof ApexCharts === 'undefined') return;
            
            const {
                regionalData,
                topProducts,
                topUnderwriters,
                weeklyTrend,
                creditClassification,
                prevMonthFacilities,
                prevMonthTFA,
                currentCount,
                currentTFA,
                countVariance,
                countVariancePercent,
                tfaVariance,
                tfaVariancePercent,
                currentMonth,
                prevMonth
            } = window.newDealsMTDExpandedData;
            
            const monthLabel = currentMonth.toLocaleDateString("en-US", { month: "long", year: "numeric" });
            const prevMonthLabel = prevMonth.toLocaleDateString("en-US", { month: "long", year: "numeric" });
            
            // 1. Update KPI Cards
            const kpisEl = document.getElementById('newDealsMTDKPIs');
            if (kpisEl) {
                const avgDealSize = currentCount > 0 ? currentTFA / currentCount : 0;
                const productCount = topProducts ? topProducts.length : 0;
                
                kpisEl.innerHTML = `
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-blue-100">
                                <svg class="h-5 w-5 shrink-0 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-500">New Deals MTD</p>
                                <h3 class="text-2xl font-bold text-gray-900">${currentCount}</h3>
                                <div class="flex items-center gap-1 mt-1">
                                    <span class="text-xs ${countVariance >= 0 ? 'text-green-600' : 'text-red-600'}">${countVariance >= 0 ? '' : ''} ${Math.abs(countVariancePercent).toFixed(1)}%</span>
                                    <span class="text-sm font-medium text-gray-500">vs PM</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-green-100">
                                <svg class="h-5 w-5 shrink-0 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-500">Total TFA MTD</p>
                                <h3 class="text-2xl font-bold text-gray-900">${formatCurrency(currentTFA)}</h3>
                                <div class="flex items-center gap-1 mt-1">
                                    <span class="text-xs ${tfaVariance >= 0 ? 'text-green-600' : 'text-red-600'}">${tfaVariance >= 0 ? '' : ''} ${Math.abs(tfaVariancePercent).toFixed(1)}%</span>
                                    <span class="text-sm font-medium text-gray-500">vs PM</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-purple-100">
                                <svg class="h-5 w-5 shrink-0 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-500">Avg Deal Size</p>
                                <h3 class="text-2xl font-bold text-gray-900">${formatCurrency(avgDealSize)}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">Per facility</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-amber-100">
                                <svg class="h-5 w-5 shrink-0 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-500">Product Programs</p>
                                <h3 class="text-2xl font-bold text-gray-900">${productCount}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">Categories</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // 2. Update Month-over-Month Comparison
            const momEl = document.getElementById('newDealsMTDMoMComparison');
            if (momEl) {
                momEl.innerHTML = `
                    <h3 class="text-base font-semibold text-gray-900 mb-4">Month-over-Month Performance</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="text-center">
                            <p class="text-sm text-gray-600 mb-2">${monthLabel}</p>
                            <p class="text-3xl font-bold text-blue-600">${currentCount}</p>
                            <p class="text-sm text-gray-500 mt-1">${formatCurrency(currentTFA)}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600 mb-2">${prevMonthLabel}</p>
                            <p class="text-3xl font-bold text-gray-600">${prevMonthFacilities}</p>
                            <p class="text-sm text-gray-500 mt-1">${formatCurrency(prevMonthTFA)}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600 mb-2">Variance</p>
                            <p class="text-3xl font-bold ${countVariance >= 0 ? 'text-green-600' : 'text-red-600'}">${countVariance >= 0 ? '+' : ''}${countVariance}</p>
                            <p class="text-sm ${tfaVariance >= 0 ? 'text-green-600' : 'text-red-600'} mt-1">${tfaVariance >= 0 ? '+' : ''}${formatCurrency(tfaVariance)}</p>
                        </div>
                    </div>
                `;
            }
            
            // 3. Regional Summary Table
            const regionalTableEl = document.getElementById('newDealsMTDRegionalTable');
            if (regionalTableEl && regionalData) {
                const regionEntries = [
                    { name: 'APAC', ...regionalData.APAC || {count: 0, tfa: 0} },
                    { name: 'EMEA', ...regionalData.EMEA || {count: 0, tfa: 0} },
                    { name: 'NAM', ...regionalData.NAM || {count: 0, tfa: 0} },
                    { name: 'LATAM', ...regionalData.LATAM || {count: 0, tfa: 0} }
                ].sort((a, b) => b.tfa - a.tfa);
                
                let tableHTML = `
                    <table class="w-full h-full">
                        <thead>
                            <tr class="border-b border-gray-200 bg-gray-50">
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700">Region</th>
                                <th class="px-6 py-4 text-right text-xs font-semibold text-gray-700">New Deals</th>
                                <th class="px-6 py-4 text-right text-xs font-semibold text-gray-700">Total TFA</th>
                                <th class="px-6 py-4 text-right text-xs font-semibold text-gray-700">Avg per Deal</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                `;
                
                let totalCount = 0, totalTFA = 0;
                regionEntries.forEach(region => {
                    totalCount += region.count;
                    totalTFA += region.tfa;
                    const avg = region.count > 0 ? region.tfa / region.count : 0;
                    
                    tableHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 text-sm font-medium text-gray-900">${region.name}</td>
                            <td class="px-6 py-4 text-sm text-right text-gray-700">${region.count}</td>
                            <td class="px-6 py-4 text-sm text-right font-medium text-gray-900">${formatCurrency(region.tfa)}</td>
                            <td class="px-6 py-4 text-sm text-right text-gray-600">${formatCurrency(avg)}</td>
                        </tr>
                    `;
                });
                
                const avgTotal = totalCount > 0 ? totalTFA / totalCount : 0;
                tableHTML += `
                        <tr class="bg-gray-50 font-semibold border-t-2 border-gray-300">
                            <td class="px-6 py-4 text-sm text-gray-900 rounded-bl-xl">Total</td>
                            <td class="px-6 py-4 text-sm text-right text-gray-900">${totalCount}</td>
                            <td class="px-6 py-4 text-sm text-right text-gray-900">${formatCurrency(totalTFA)}</td>
                            <td class="px-6 py-4 text-sm text-right text-gray-900 rounded-br-xl">${formatCurrency(avgTotal)}</td>
                        </tr>
                    </tbody>
                </table>
                `;
                regionalTableEl.innerHTML = tableHTML;
            }
            
            // 4. Weekly Trend Chart
            const weeklyChartEl = document.getElementById('newDealsMTDWeeklyChart');
            if (weeklyChartEl && weeklyTrend && weeklyTrend.length > 0) {
                const weeklyOptions = {
                    series: [{
                        name: 'Deals',
                        data: weeklyTrend.map(w => w.count)
                    }],
                    chart: {
                        type: 'bar',
                        height: 300,
                        fontFamily: 'Outfit, sans-serif',
                        toolbar: { show: false },
                        parentHeightOffset: 0
                    },
                    colors: ['#465fff'],
                    plotOptions: {
                        bar: {
                            borderRadius: 6,
                            columnWidth: '60%',
                            dataLabels: { position: 'top' }
                        }
                    },
                    dataLabels: {
                        enabled: true,
                        offsetY: -20,
                        formatter: function(val) {
                            return val;
                        },
                        style: {
                            fontSize: '11px',
                            fontWeight: 500,
                            colors: ['#374151']
                        },
                        background: {
                            enabled: true,
                            foreColor: '#374151',
                            backgroundColor: '#F3F4F6',
                            borderRadius: 12,
                            padding: 8,
                            opacity: 1,
                            borderWidth: 0
                        }
                    },
                    xaxis: {
                        categories: weeklyTrend.map((w, idx) => `${idx + 1}. ${w.name}`),
                        labels: {
                            style: {
                                colors: "#6B7280",
                                fontSize: "12px",
                                fontFamily: "Outfit, sans-serif",
                            },
                        },
                        axisBorder: { show: false },
                        axisTicks: { show: false }
                    },
                    yaxis: {
                        labels: {
                            style: {
                                colors: "#6B7280",
                                fontSize: "12px",
                                fontFamily: "Outfit, sans-serif",
                            },
                        },
                    },
                    grid: {
                        borderColor: '#E5E7EB',
                        strokeDashArray: 4,
                        xaxis: { lines: { show: false } },
                        yaxis: { lines: { show: true } },
                        padding: {
                            top: 4,
                            right: 0,
                            bottom: 0,
                            left: 0
                        }
                    },
                    tooltip: {
                        theme: 'light'
                    }
                };
                
                weeklyChartEl.innerHTML = '';
                const weeklyChart = new ApexCharts(weeklyChartEl, weeklyOptions);
                weeklyChart.render();
            }
            
            // 5. Product Distribution by TFA - Donut Chart (matching Deal Count style)
            const productChartEl = document.getElementById('newDealsMTDProductChart');
            const productListEl = document.getElementById('newDealsMTDProductList');
            if (productChartEl && topProducts && topProducts.length > 0) {
                const totalTFA = topProducts.reduce((sum, p) => sum + p.tfa, 0);
                const colors = [
                    "#3641f5",  // Primary blue
                    "#7592ff",  // Light blue
                    "#dde9ff",  // Lighter blue
                    "#ff6b6b",  // Red
                    "#ffd93d",  // Yellow
                    "#6bcf7f",  // Green
                    "#c084fc",  // Purple
                    "#14b8a6",  // Teal
                    "#f97316",  // Orange
                    "#06b6d4"   // Cyan
                ];
                
                const productDonutOptions = {
                    series: topProducts.map(p => p.tfa),
                    colors: colors.slice(0, topProducts.length),
                    labels: topProducts.map(p => p.name),
                    chart: {
                        fontFamily: "Outfit, sans-serif",
                        type: "donut",
                        width: 300,
                        height: 300,
                    },
                    stroke: {
                        show: false,
                    },
                    plotOptions: {
                        pie: {
                            donut: {
                                size: "65%",
                                background: "transparent",
                                labels: {
                                    show: true,
                                    name: {
                                        show: true,
                                        offsetY: -10,
                                        color: "#1D2939",
                                        fontSize: "14px",
                                        fontWeight: "600",
                                    },
                                    value: {
                                        show: true,
                                        offsetY: 10,
                                        color: "#667085",
                                        fontSize: "16px",
                                        fontWeight: "700",
                                        formatter: (val) => formatCurrency(val),
                                    },
                                    total: {
                                        show: true,
                                        label: "Total TFA",
                                        color: "#111827",
                                        fontSize: "16px",
                                        fontWeight: "700",
                                        formatter: () => formatCurrency(totalTFA),
                                    },
                                },
                            },
                        },
                    },
                    dataLabels: {
                        enabled: false,
                    },
                    legend: {
                        show: false, // Hide built-in legend, using custom HTML legend
                    },
                    tooltip: {
                        enabled: true,
                        theme: "light",
                        y: {
                            formatter: function(val, opts) {
                                const percentage = ((val / totalTFA) * 100).toFixed(1);
                                return formatCurrency(val) + ' (' + percentage + '%)';
                            }
                        }
                    },
                };
                
                productChartEl.innerHTML = '';
                const productDonutChart = new ApexCharts(productChartEl, productDonutOptions);
                productDonutChart.render();
                
                // Populate legend list
                if (productListEl) {
                    productListEl.innerHTML = topProducts.map((product, index) => {
                        const color = colors[index % colors.length];
                        const formattedAmount = product.tfa >= 1000000000 
                            ? `$${(product.tfa / 1000000000).toFixed(2)}B`
                            : `$${(product.tfa / 1000000).toFixed(1)}M`;
                        return `
                            <div class="flex items-center gap-3 py-2">
                                <div class="w-4 h-4 rounded-sm flex-shrink-0" style="background-color: ${color};"></div>
                                <p class="text-sm font-medium text-gray-800 flex-1">${product.name}</p>
                                <p class="text-sm font-semibold text-gray-900">${formattedAmount}</p>
                            </div>
                        `;
                    }).join('');
                }
            }
            
            // 6. Product Distribution by Deals Count - Donut Chart
            const productCountChartElMTD = document.getElementById('newDealsMTDProductCountChart');
            const productCountListElMTD = document.getElementById('newDealsMTDProductCountList');
            if (productCountChartElMTD && topProducts && topProducts.length > 0) {
                const totalDealsForProductMTD = topProducts.reduce((sum, p) => sum + p.count, 0);
                const colors = [
                    "#3641f5",  // Primary blue
                    "#7592ff",  // Light blue
                    "#dde9ff",  // Lighter blue
                    "#ff6b6b",  // Red
                    "#ffd93d",  // Yellow
                    "#6bcf7f",  // Green
                    "#c084fc",  // Purple
                    "#14b8a6",  // Teal
                    "#f97316",  // Orange
                    "#06b6d4"   // Cyan
                ];
                
                const productCountDonutOptions = {
                    series: topProducts.map(p => p.count),
                    colors: colors,
                    labels: topProducts.map(p => p.name),
                    chart: {
                        fontFamily: "Outfit, sans-serif",
                        type: "donut",
                        width: 300,
                        height: 300,
                    },
                    stroke: {
                        show: false,
                    },
                    plotOptions: {
                        pie: {
                            donut: {
                                size: "65%",
                                background: "transparent",
                                labels: {
                                    show: true,
                                    name: {
                                        show: true,
                                        offsetY: -10,
                                        color: "#1D2939",
                                        fontSize: "14px",
                                        fontWeight: "600",
                                    },
                                    value: {
                                        show: true,
                                        offsetY: 10,
                                        color: "#667085",
                                        fontSize: "16px",
                                        fontWeight: "700",
                                        formatter: (val) => val.toString(),
                                    },
                                    total: {
                                        show: true,
                                        label: "Total Deals",
                                        color: "#111827",
                                        fontSize: "16px",
                                        fontWeight: "700",
                                        formatter: () => totalDealsForProductMTD.toString(),
                                    },
                                },
                            },
                        },
                    },
                    dataLabels: {
                        enabled: false,
                    },
                    legend: {
                        show: false,
                    },
                    tooltip: {
                        enabled: true,
                        theme: "light",
                        y: {
                            formatter: function(val, opts) {
                                const percentage = ((val / totalDealsForProductMTD) * 100).toFixed(1);
                                return val + ' deals (' + percentage + '%)';
                            }
                        }
                    },
                };
                
                productCountChartElMTD.innerHTML = '';
                const productCountChartMTD = new ApexCharts(productCountChartElMTD, productCountDonutOptions);
                productCountChartMTD.render();
                
                // Populate legend list
                if (productCountListElMTD) {
                    productCountListElMTD.innerHTML = topProducts.map((product, index) => {
                        const color = colors[index];
                        const percentage = ((product.count / totalDealsForProductMTD) * 100).toFixed(1);
                        return `
                            <div class="flex items-center gap-3 py-2">
                                <div class="w-4 h-4 rounded-sm flex-shrink-0" style="background-color: ${color};"></div>
                                <p class="text-sm font-medium text-gray-800 flex-1">${product.name}</p>
                                <p class="text-sm font-semibold text-gray-900">${product.count} (${percentage}%)</p>
                            </div>
                        `;
                    }).join('');
                }
            }
            
            // 7. Top Underwriters Table
            const underwriterTableEl = document.getElementById('newDealsMTDUnderwriterTable');
            if (underwriterTableEl) {
                let tableHTML = `
                    <table class="min-w-full">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Underwriter</th>
                                <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Region</th>
                                <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">New Deals</th>
                                <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Total TFA</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                `;
                
                if (topUnderwriters && topUnderwriters.length > 0) {
                    topUnderwriters.forEach((uw, index) => {
                        const regionColor = {
                            'APAC': 'bg-blue-100 text-blue-700',
                            'EMEA': 'bg-green-100 text-green-700',
                            'NAM': 'bg-purple-100 text-purple-700',
                            'LATAM': 'bg-orange-100 text-orange-700'
                        }[uw.region] || 'bg-gray-100 text-gray-700';
                        
                        tableHTML += `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 text-center text-sm font-medium text-gray-900">${uw.name}</td>
                                <td class="px-6 py-4 text-center">
                                    <span class="inline-flex items-center justify-center rounded-full ${regionColor} px-2.5 py-0.5 text-xs font-medium">
                                        ${uw.region}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <span class="inline-flex items-center justify-center rounded-full bg-blue-100 px-3 py-1 text-sm font-medium text-blue-700">
                                        ${uw.facilities}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-center text-sm whitespace-nowrap font-semibold text-gray-900">${formatCurrency(uw.tfa)}</td>
                            </tr>
                        `;
                    });
                } else {
                    tableHTML += `
                        <tr>
                            <td colspan="4" class="px-6 py-8 text-center text-sm text-gray-500">No data available</td>
                        </tr>
                    `;
                }
                
                tableHTML += `
                    </tbody>
                </table>
                `;
                underwriterTableEl.innerHTML = tableHTML;
            }
        }
        
        // Render Pipeline (Deals Pending Closure) Expanded Analysis Views
        function renderPipelineExpandedViews() {
            console.log(' renderPipelineExpandedViews called', {
                hasData: !!window.pipelineExpandedData,
                hasApexCharts: typeof ApexCharts !== 'undefined'
            });
            
            if (!window.pipelineExpandedData || typeof ApexCharts === 'undefined') {
                console.error(' Missing requirements:', {
                    pipelineExpandedData: !!window.pipelineExpandedData,
                    ApexCharts: typeof ApexCharts !== 'undefined'
                });
                return;
            }
            
            const { regional, topProducts, topUnderwriters, allDeals, totalFacilities, totalTFA, currentYear } = window.pipelineExpandedData;
            
            console.log(' Pipeline expanded data:', {
                regional,
                topProducts: topProducts ? topProducts.length : 0,
                topUnderwriters: topUnderwriters ? topUnderwriters.length : 0,
                allDeals: allDeals ? allDeals.length : 0,
                totalFacilities,
                totalTFA
            });
            
            // Update KPIs
            document.getElementById('pipelineTotalFacilities').textContent = totalFacilities;
            document.getElementById('pipelineTotalTFA').textContent = formatCurrency(totalTFA);
            document.getElementById('pipelineNAMCount').textContent = regional.NAM ? regional.NAM.facilities : 0;
            document.getElementById('pipelineNAMTFA').textContent = regional.NAM ? formatCurrency(regional.NAM.tfa) : '$0';
            document.getElementById('pipelineLATAMCount').textContent = regional.LATAM ? regional.LATAM.facilities : 0;
            document.getElementById('pipelineLATAMTFA').textContent = regional.LATAM ? formatCurrency(regional.LATAM.tfa) : '$0';
            const avgDealSize = totalFacilities > 0 ? totalTFA / totalFacilities : 0;
            document.getElementById('pipelineAvgDealSize').textContent = formatCurrency(avgDealSize);
            
            // 1. Product Program Distribution by Count - Donut Chart (matching Product Program Distribution style)
            const productCountChartEl = document.getElementById('pipelineRegionalChart');
            const productCountListEl = document.getElementById('pipelineRegionalList');
            if (productCountChartEl && topProducts && topProducts.length > 0) {
                const totalCount = topProducts.reduce((sum, p) => sum + p.count, 0);
                const colors = [
                    "#3641f5",  // Primary blue
                    "#7592ff",  // Light blue
                    "#dde9ff",  // Lighter blue
                    "#ff6b6b",  // Red
                    "#ffd93d",  // Yellow
                    "#6bcf7f",  // Green
                    "#c084fc",  // Purple
                    "#14b8a6",  // Teal
                    "#f97316",  // Orange
                    "#06b6d4"   // Cyan
                ];
                
                const productCountDonutOptions = {
                    series: topProducts.map(p => p.count),
                    colors: colors.slice(0, topProducts.length),
                    labels: topProducts.map(p => p.name),
                    chart: {
                        fontFamily: "Outfit, sans-serif",
                        type: "donut",
                        width: 300,
                        height: 300,
                    },
                    stroke: {
                        show: false,
                    },
                    plotOptions: {
                        pie: {
                            donut: {
                                size: "65%",
                                background: "transparent",
                                labels: {
                                    show: true,
                                    name: {
                                        show: true,
                                        offsetY: -10,
                                        color: "#1D2939",
                                        fontSize: "14px",
                                        fontWeight: "600",
                                    },
                                    value: {
                                        show: true,
                                        offsetY: 10,
                                        color: "#667085",
                                        fontSize: "16px",
                                        fontWeight: "700",
                                        formatter: (val) => val.toString(),
                                    },
                                    total: {
                                        show: true,
                                        label: "Total Deals",
                                        color: "#111827",
                                        fontSize: "16px",
                                        fontWeight: "700",
                                        formatter: () => totalCount.toString(),
                                    },
                                },
                            },
                        },
                    },
                    dataLabels: {
                        enabled: false,
                    },
                    legend: {
                        show: false, // Hide built-in legend, using custom HTML legend
                    },
                    tooltip: {
                        enabled: true,
                        theme: "light",
                        followCursor: false,
                        custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                            const product = topProducts[seriesIndex];
                            const productName = product.name;
                            const dealCount = product.count;
                            const tfaAmount = product.tfa;
                            const regionalBreakdown = product.regionalBreakdown || { NAM: { count: 0, tfa: 0 }, LATAM: { count: 0, tfa: 0 } };
                            
                            // Build regional table rows (only NAM and LATAM for pipeline)
                            let regionalRows = '';
                            ['NAM', 'LATAM'].forEach(region => {
                                const regionData = regionalBreakdown[region];
                                if (regionData && (regionData.count > 0 || regionData.tfa > 0)) {
                                    regionalRows += `
                                        <tr>
                                            <td style="padding: 6px 8px; text-align: left; font-size: 11px; color: #6B7280; font-weight: 500;">${region}</td>
                                            <td style="padding: 6px 8px; text-align: center; font-size: 11px; color: #111827; font-weight: 600;">${regionData.count}</td>
                                            <td style="padding: 6px 8px; text-align: right; font-size: 11px; color: #111827; font-weight: 600;">${formatCurrency(regionData.tfa)}</td>
                                        </tr>
                                    `;
                                }
                            });
                            
                            return `
                                <div style="
                                    background: #ffffff; 
                                    border-radius: 12px; 
                                    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
                                    min-width: 320px;
                                    max-width: 360px;
                                    overflow: hidden;
                                    font-family: Outfit, sans-serif;
                                ">
                                    <!-- Header with border -->
                                    <div style="
                                        border-bottom: 1px solid #E5E7EB;
                                        padding: 16px 16px 12px 16px;
                                        margin-bottom: 14px;
                                    ">
                                        <div style="
                                            font-weight: 600; 
                                            font-size: 15px; 
                                            color: #111827;
                                            margin-bottom: 4px;
                                        ">${productName}</div>
                                        <div style="
                                            font-size: 12px; 
                                            font-weight: 500;
                                            color: #6B7280;
                                        ">Product Program</div>
                                    </div>
                                    
                                    <!-- Content wrapper -->
                                    <div style="padding: 0 16px 16px 16px;">
                                        <!-- Widget Grid (2 columns) -->
                                        <div style="
                                            display: grid;
                                            grid-template-columns: 1fr 1fr;
                                            gap: 10px;
                                            margin-bottom: 16px;
                                        ">
                                            <!-- Widget 1: Deal Count (already shown in donut, but included for consistency) -->
                                            <div style="
                                                background: #F9FAFB;
                                                border-radius: 8px;
                                                padding: 12px;
                                                border: 1px solid #E5E7EB;
                                            ">
                                                <div style="
                                                    display: flex;
                                                    align-items: center;
                                                    gap: 6px;
                                                    font-size: 11px;
                                                    color: #6B7280;
                                                    font-weight: 500;
                                                    margin-bottom: 6px;
                                                ">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                                    </svg>
                                                    Deals
                                                </div>
                                                <div style="
                                                    font-size: 20px;
                                                    font-weight: 700;
                                                    color: #111827;
                                                ">${dealCount}</div>
                                            </div>
                                            
                                            <!-- Widget 2: TFA (not shown in donut) -->
                                            <div style="
                                                background: #F9FAFB;
                                                border-radius: 8px;
                                                padding: 12px;
                                                border: 1px solid #E5E7EB;
                                            ">
                                                <div style="
                                                    display: flex;
                                                    align-items: center;
                                                    gap: 6px;
                                                    font-size: 11px;
                                                    color: #6B7280;
                                                    font-weight: 500;
                                                    margin-bottom: 6px;
                                                ">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <line x1="12" y1="1" x2="12" y2="23"></line>
                                                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                                    </svg>
                                                    TFA
                                                </div>
                                                <div style="
                                                    font-size: 14px;
                                                    font-weight: 700;
                                                    color: #111827;
                                                ">${formatCurrency(tfaAmount)}</div>
                                            </div>
                                        </div>
                                        
                                        <!-- Regional Distribution Table -->
                                        <div style="margin-top: 12px;">
                                            <div style="
                                                display: flex;
                                                align-items: center;
                                                gap: 6px;
                                                margin-bottom: 8px;
                                            ">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2">
                                                    <circle cx="12" cy="12" r="10"></circle>
                                                    <line x1="2" y1="12" x2="22" y2="12"></line>
                                                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                                </svg>
                                                <span style="
                                                    font-size: 12px;
                                                    font-weight: 600;
                                                    color: #374151;
                                                ">Regional Distribution</span>
                                            </div>
                                            <table style="width: 100%; border-collapse: collapse;">
                                                <thead>
                                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                                        <th style="padding: 6px 8px; text-align: left; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Region</th>
                                                        <th style="padding: 6px 8px; text-align: center; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Deals</th>
                                                        <th style="padding: 6px 8px; text-align: right; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">TFA</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${regionalRows || '<tr><td colspan="3" style="padding: 8px; text-align: center; font-size: 11px; color: #9CA3AF;">No data</td></tr>'}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    },
                };
                
                productCountChartEl.innerHTML = '';
                const productCountChart = new ApexCharts(productCountChartEl, productCountDonutOptions);
                productCountChart.render();
                
                // Add tooltip positioning fix
                setTimeout(() => {
                    const tooltipObserver = new MutationObserver(() => {
                        const tooltip = productCountChartEl.querySelector('.apexcharts-tooltip.apexcharts-active');
                        if (tooltip && !tooltip.hasAttribute('data-positioned')) {
                            const tooltipRect = tooltip.getBoundingClientRect();
                            const windowWidth = window.innerWidth;
                            const windowHeight = window.innerHeight;
                            const margin = 10;
                            
                            let needsReposition = false;
                            
                            if (tooltipRect.left < margin) {
                                tooltip.style.left = margin + 'px';
                                tooltip.style.transform = 'none';
                                needsReposition = true;
                            } else if (tooltipRect.right > windowWidth - margin) {
                                tooltip.style.left = (windowWidth - tooltipRect.width - margin) + 'px';
                                tooltip.style.transform = 'none';
                                needsReposition = true;
                            }
                            
                            if (tooltipRect.top < margin) {
                                tooltip.style.top = margin + 'px';
                                needsReposition = true;
                            } else if (tooltipRect.bottom > windowHeight - margin) {
                                tooltip.style.top = (windowHeight - tooltipRect.height - margin) + 'px';
                                needsReposition = true;
                            }
                            
                            if (needsReposition) {
                                tooltip.setAttribute('data-positioned', 'true');
                            }
                        }
                        
                        const hiddenTooltip = productCountChartEl.querySelector('.apexcharts-tooltip:not(.apexcharts-active)[data-positioned]');
                        if (hiddenTooltip) {
                            hiddenTooltip.removeAttribute('data-positioned');
                        }
                    });
                    
                    tooltipObserver.observe(productCountChartEl, {
                        attributes: true,
                        attributeFilter: ['class'],
                        subtree: true
                    });
                }, 200);
                
                // Populate legend list
                if (productCountListEl) {
                    productCountListEl.innerHTML = topProducts.map((product, index) => {
                        const color = colors[index % colors.length];
                        return `
                            <div class="flex items-center gap-3 py-2">
                                <div class="w-4 h-4 rounded-sm flex-shrink-0" style="background-color: ${color};"></div>
                                <p class="text-sm font-medium text-gray-800 flex-1">${product.name}</p>
                                <p class="text-sm font-semibold text-gray-900">${product.count}</p>
                            </div>
                `;
                    }).join('');
                }
            }
            
            // 2. Product Program Distribution - Donut Chart (matching New Deals YTD Product Distribution style)
            const productChartEl = document.getElementById('pipelineProductTreemap');
            const productListEl = document.getElementById('pipelineProductList');
            if (productChartEl && topProducts && topProducts.length > 0) {
                const totalTFA = topProducts.reduce((sum, p) => sum + p.tfa, 0);
                const colors = [
                    "#3641f5",  // Primary blue
                    "#7592ff",  // Light blue
                    "#dde9ff",  // Lighter blue
                    "#ff6b6b",  // Red
                    "#ffd93d",  // Yellow
                    "#6bcf7f",  // Green
                    "#c084fc",  // Purple
                    "#14b8a6",  // Teal
                    "#f97316",  // Orange
                    "#06b6d4"   // Cyan
                ];
                
                const productDonutOptions = {
                    series: topProducts.map(p => p.tfa),
                    colors: colors.slice(0, topProducts.length),
                    labels: topProducts.map(p => p.name),
                    chart: {
                        fontFamily: "Outfit, sans-serif",
                        type: "donut",
                        width: 300,
                        height: 300,
                    },
                    stroke: {
                        show: false,
                    },
                    plotOptions: {
                        pie: {
                            donut: {
                                size: "65%",
                                background: "transparent",
                                labels: {
                                    show: true,
                                    name: {
                                        show: true,
                                        offsetY: -10,
                                        color: "#1D2939",
                                        fontSize: "14px",
                                        fontWeight: "600",
                                    },
                                    value: {
                                        show: true,
                                        offsetY: 10,
                                        color: "#667085",
                                        fontSize: "16px",
                                        fontWeight: "700",
                                        formatter: (val) => formatCurrency(val),
                                    },
                                    total: {
                                        show: true,
                                        label: "Total TFA",
                                        color: "#111827",
                                        fontSize: "16px",
                                        fontWeight: "700",
                                        formatter: () => formatCurrency(totalTFA),
                                    },
                                },
                            },
                        },
                    },
                    dataLabels: {
                        enabled: false,
                    },
                    legend: {
                        show: false, // Hide built-in legend, using custom HTML legend
                    },
                    tooltip: {
                        enabled: true,
                        theme: "light",
                        followCursor: false,
                        custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                            const product = topProducts[seriesIndex];
                            const productName = product.name;
                            const tfaAmount = product.tfa;
                            const dealCount = product.count;
                            const regionalBreakdown = product.regionalBreakdown || { NAM: { count: 0, tfa: 0 }, LATAM: { count: 0, tfa: 0 } };
                            
                            // Build regional table rows (only NAM and LATAM for pipeline)
                            let regionalRows = '';
                            ['NAM', 'LATAM'].forEach(region => {
                                const regionData = regionalBreakdown[region];
                                if (regionData && (regionData.count > 0 || regionData.tfa > 0)) {
                                    regionalRows += `
                                        <tr>
                                            <td style="padding: 6px 8px; text-align: left; font-size: 11px; color: #6B7280; font-weight: 500;">${region}</td>
                                            <td style="padding: 6px 8px; text-align: center; font-size: 11px; color: #111827; font-weight: 600;">${regionData.count}</td>
                                            <td style="padding: 6px 8px; text-align: right; font-size: 11px; color: #111827; font-weight: 600;">${formatCurrency(regionData.tfa)}</td>
                                        </tr>
                                    `;
                                }
                            });
                            
                            return `
                                <div style="
                                    background: #ffffff; 
                                    border-radius: 12px; 
                                    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
                                    min-width: 320px;
                                    max-width: 360px;
                                    overflow: hidden;
                                    font-family: Outfit, sans-serif;
                                ">
                                    <!-- Header with border -->
                                    <div style="
                                        border-bottom: 1px solid #E5E7EB;
                                        padding: 16px 16px 12px 16px;
                                        margin-bottom: 14px;
                                    ">
                                        <div style="
                                            font-weight: 600; 
                                            font-size: 15px; 
                                            color: #111827;
                                            margin-bottom: 4px;
                                        ">${productName}</div>
                                        <div style="
                                            font-size: 12px; 
                                            font-weight: 500;
                                            color: #6B7280;
                                        ">Product Program</div>
                                    </div>
                                    
                                    <!-- Content wrapper -->
                                    <div style="padding: 0 16px 16px 16px;">
                                        <!-- Widget Grid (2 columns) -->
                                        <div style="
                                            display: grid;
                                            grid-template-columns: 1fr 1fr;
                                            gap: 10px;
                                            margin-bottom: 16px;
                                        ">
                                            <!-- Widget 1: Deal Count (not shown in donut) -->
                                            <div style="
                                                background: #F9FAFB;
                                                border-radius: 8px;
                                                padding: 12px;
                                                border: 1px solid #E5E7EB;
                                            ">
                                                <div style="
                                                    display: flex;
                                                    align-items: center;
                                                    gap: 6px;
                                                    font-size: 11px;
                                                    color: #6B7280;
                                                    font-weight: 500;
                                                    margin-bottom: 6px;
                                                ">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                                    </svg>
                                                    Deals
                                                </div>
                                                <div style="
                                                    font-size: 20px;
                                                    font-weight: 700;
                                                    color: #111827;
                                                ">${dealCount}</div>
                                            </div>
                                            
                                            <!-- Widget 2: TFA (already shown in donut, but included for consistency) -->
                                            <div style="
                                                background: #F9FAFB;
                                                border-radius: 8px;
                                                padding: 12px;
                                                border: 1px solid #E5E7EB;
                                            ">
                                                <div style="
                                                    display: flex;
                                                    align-items: center;
                                                    gap: 6px;
                                                    font-size: 11px;
                                                    color: #6B7280;
                                                    font-weight: 500;
                                                    margin-bottom: 6px;
                                                ">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <line x1="12" y1="1" x2="12" y2="23"></line>
                                                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                                    </svg>
                                                    TFA
                                                </div>
                                                <div style="
                                                    font-size: 14px;
                                                    font-weight: 700;
                                                    color: #111827;
                                                ">${formatCurrency(tfaAmount)}</div>
                                            </div>
                                        </div>
                                        
                                        <!-- Regional Distribution Table -->
                                        <div style="margin-top: 12px;">
                                            <div style="
                                                display: flex;
                                                align-items: center;
                                                gap: 6px;
                                                margin-bottom: 8px;
                                            ">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2">
                                                    <circle cx="12" cy="12" r="10"></circle>
                                                    <line x1="2" y1="12" x2="22" y2="12"></line>
                                                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                                </svg>
                                                <span style="
                                                    font-size: 12px;
                                                    font-weight: 600;
                                                    color: #374151;
                                                ">Regional Distribution</span>
                                            </div>
                                            <table style="width: 100%; border-collapse: collapse;">
                                                <thead>
                                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                                        <th style="padding: 6px 8px; text-align: left; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Region</th>
                                                        <th style="padding: 6px 8px; text-align: center; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Deals</th>
                                                        <th style="padding: 6px 8px; text-align: right; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">TFA</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${regionalRows || '<tr><td colspan="3" style="padding: 8px; text-align: center; font-size: 11px; color: #9CA3AF;">No data</td></tr>'}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    },
                };
                
                productChartEl.innerHTML = '';
                const productChart = new ApexCharts(productChartEl, productDonutOptions);
                productChart.render();
                
                // Add tooltip positioning fix
                setTimeout(() => {
                    const tooltipObserver = new MutationObserver(() => {
                        const tooltip = productChartEl.querySelector('.apexcharts-tooltip.apexcharts-active');
                        if (tooltip && !tooltip.hasAttribute('data-positioned')) {
                            const tooltipRect = tooltip.getBoundingClientRect();
                            const windowWidth = window.innerWidth;
                            const windowHeight = window.innerHeight;
                            const margin = 10;
                            
                            let needsReposition = false;
                            
                            if (tooltipRect.left < margin) {
                                tooltip.style.left = margin + 'px';
                                tooltip.style.transform = 'none';
                                needsReposition = true;
                            } else if (tooltipRect.right > windowWidth - margin) {
                                tooltip.style.left = (windowWidth - tooltipRect.width - margin) + 'px';
                                tooltip.style.transform = 'none';
                                needsReposition = true;
                            }
                            
                            if (tooltipRect.top < margin) {
                                tooltip.style.top = margin + 'px';
                                needsReposition = true;
                            } else if (tooltipRect.bottom > windowHeight - margin) {
                                tooltip.style.top = (windowHeight - tooltipRect.height - margin) + 'px';
                                needsReposition = true;
                            }
                            
                            if (needsReposition) {
                                tooltip.setAttribute('data-positioned', 'true');
                            }
                        }
                        
                        const hiddenTooltip = productChartEl.querySelector('.apexcharts-tooltip:not(.apexcharts-active)[data-positioned]');
                        if (hiddenTooltip) {
                            hiddenTooltip.removeAttribute('data-positioned');
                        }
                    });
                    
                    tooltipObserver.observe(productChartEl, {
                        attributes: true,
                        attributeFilter: ['class'],
                        subtree: true
                    });
                }, 200);
                
                // Populate legend list (matching New Deals YTD style: TFA only)
                if (productListEl) {
                    productListEl.innerHTML = topProducts.map((product, index) => {
                        const color = colors[index % colors.length];
                        const formattedAmount = product.tfa >= 1000000000 
                            ? `$${(product.tfa / 1000000000).toFixed(2)}B`
                            : `$${(product.tfa / 1000000).toFixed(1)}M`;
                        return `
                            <div class="flex items-center gap-3 py-2">
                                <div class="w-4 h-4 rounded-sm flex-shrink-0" style="background-color: ${color};"></div>
                                <p class="text-sm font-medium text-gray-800 flex-1">${product.name}</p>
                                <p class="text-sm font-semibold text-gray-900">${formattedAmount}</p>
                            </div>
                        `;
                    }).join('');
                }
            }
            
            
            // 3. Render the interactive details table with filters, sorting, and pagination
            // NOTE: Using the newer simpler renderPipelineDetailsTable() function instead (defined at ~line 7075)
            // The old complex version has been renamed to renderPipelineDetailsTable_OLD_UNUSED
            // renderPipelineDetailsTable(); // This is now called from populateExpandModalValues instead
        }
        
        // OLD/UNUSED: Render Pipeline Details Table with pagination, filters, and search
        // This function is DEPRECATED - using the newer simpler version with DM/CM filter instead
        function renderPipelineDetailsTable_OLD_UNUSED() {
            console.log(' renderPipelineDetailsTable_OLD called');
            const tbody = document.getElementById('pipelineDetailsTableBody');
            const thead = document.getElementById('pipelineDetailsTableHeader');
            
            if (!tbody) {
                console.error(' pipelineDetailsTableBody element not found');
                return;
            }
            if (!thead) {
                console.error(' pipelineDetailsTableHeader element not found');
                return;
            }
            if (!window.pipelineExpandedData) {
                console.error(' window.pipelineExpandedData not found');
                return;
            }
            
            const state = window.pipelineTableState;
            const { allDeals } = window.pipelineExpandedData;
            
            console.log(' Pipeline data:', {
                hasData: !!window.pipelineExpandedData,
                allDealsCount: allDeals ? allDeals.length : 0,
                sampleDeal: allDeals && allDeals[0]
            });
            
            if (!allDeals || allDeals.length === 0) {
                console.warn(' No deals data available');
                tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-8 text-center text-sm text-gray-500">No pending deals data available</td></tr>';
                return;
            }
            
            // Add aging category to each deal
            const dealsWithAging = allDeals.map(deal => {
                let agingCategory = '';
                if (deal.daysOld >= 1 && deal.daysOld <= 30) {
                    agingCategory = '1-30 Days';
                } else if (deal.daysOld >= 31 && deal.daysOld <= 60) {
                    agingCategory = '31-60 Days';
                } else if (deal.daysOld >= 61 && deal.daysOld <= 90) {
                    agingCategory = '61-90 Days';
                } else if (deal.daysOld > 90) {
                    agingCategory = '> 90 Days';
                }
                return { ...deal, agingCategory };
            });
            
            // Store items before filtering for header unique values
            const itemsBeforeFilters = dealsWithAging;
            
            // Apply search filter
            let filteredItems = dealsWithAging;
            if (state.searchQuery) {
                filteredItems = dealsWithAging.filter(item => {
                    const searchStr = `${item.facilityId} ${item.relationship} ${item.region} ${item.product} ${item.facilityType} ${item.underwriter}`.toLowerCase();
                    return searchStr.includes(state.searchQuery);
                });
            }
            
            // Apply column filters
            if (state.columnFilters && Object.keys(state.columnFilters).length > 0) {
                filteredItems = filteredItems.filter(item => {
                    for (const [column, filters] of Object.entries(state.columnFilters)) {
                        if (filters && filters.length > 0) {
                            let itemValue = item[column];
                            if (!filters.includes(itemValue)) {
                                return false;
                            }
                        }
                    }
                    return true;
                });
            }
            
            // Apply sorting
            if (state.sortColumn) {
                filteredItems.sort((a, b) => {
                    const modifier = state.sortDirection === 'asc' ? 1 : -1;
                    const aVal = a[state.sortColumn];
                    const bVal = b[state.sortColumn];
                    
                    // Handle numeric comparison for TFA and daysOld
                    if (state.sortColumn === 'tfa' || state.sortColumn === 'daysOld') {
                        return (aVal - bVal) * modifier;
                    }
                    
                    // String comparison
                    if (aVal < bVal) return -1 * modifier;
                    if (aVal > bVal) return 1 * modifier;
                    return 0;
                });
            } else {
                // Default sort by TFA descending
                filteredItems.sort((a, b) => b.tfa - a.tfa);
            }
            
            // Store all filtered data
            state.allData = filteredItems;
            
            // Calculate pagination
            const totalItems = filteredItems.length;
            const totalPages = Math.ceil(totalItems / state.perPage);
            const startIdx = (state.currentPage - 1) * state.perPage;
            const endIdx = Math.min(startIdx + state.perPage, totalItems);
            const displayItems = filteredItems.slice(startIdx, endIdx);
            
            // Update pagination info
            document.getElementById('pipelineTableStart').textContent = totalItems > 0 ? startIdx + 1 : 0;
            document.getElementById('pipelineTableEnd').textContent = endIdx;
            document.getElementById('pipelineTableTotal').textContent = totalItems;
            document.getElementById('pipelineTableCurrentPage').textContent = state.currentPage;
            document.getElementById('pipelineTableTotalPages').textContent = totalPages || 1;
            
            // Update pagination buttons
            const prevBtn = document.getElementById('pipelineTablePrevBtn');
            const nextBtn = document.getElementById('pipelineTableNextBtn');
            if (prevBtn) prevBtn.disabled = state.currentPage === 1;
            if (nextBtn) nextBtn.disabled = state.currentPage >= totalPages;
            
            // Update Clear All Filters button visibility and count
            const clearAllBtn = document.getElementById('btnClearAllPipelineFilters');
            const activeFiltersCount = Object.values(state.columnFilters).filter(f => f && f.length > 0).length;
            const hasSorting = state.sortColumn !== '';
            const hasActiveFilters = activeFiltersCount > 0 || hasSorting;
            
            if (clearAllBtn) {
                if (hasActiveFilters) {
                    clearAllBtn.style.display = 'flex';
                    const badge = activeFiltersCount > 0 ? ` (${activeFiltersCount})` : '';
                    clearAllBtn.innerHTML = `
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        Clear Filters${badge}
                    `;
                } else {
                    clearAllBtn.style.display = 'none';
                }
            }
            
            // Helper function to create header cell with filter and sort
            function createHeaderCell(label, columnKey, columnIndex, totalColumns) {
                const hasFilter = state.columnFilters[columnKey] && state.columnFilters[columnKey].length > 0;
                const isSorted = state.sortColumn === columnKey;
                const isFilterOpen = state.openFilterColumn === columnKey;
                
                // Smart positioning: last 3 columns align right, others align left
                const alignRight = columnIndex >= totalColumns - 3;
                
                // Get unique values for this column from items before column filters
                const uniqueValues = new Set();
                itemsBeforeFilters.forEach(item => {
                    if (item[columnKey] !== undefined && item[columnKey] !== null) {
                        uniqueValues.add(item[columnKey]);
                    }
                });
                const sortedValues = Array.from(uniqueValues).sort((a, b) => {
                    if (typeof a === 'string') return a.localeCompare(b);
                    return a - b;
                });
                
                // For TFA column, format display values
                const displayValues = sortedValues.map(val => {
                    if (columnKey === 'tfa') {
                        return { raw: val, display: formatCurrency(val) };
                    }
                    return { raw: val, display: val };
                });
                
                // Generate unique ID for search input
                const searchId = `pipelineFilterSearch_${columnKey}`;
                
                return `
                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">
                        <div class="flex items-center justify-center gap-2">
                            <span>${label}</span>
                            <div class="flex items-center gap-1">
                                <!-- Filter Icon -->
                                <div class="relative pipeline-filter-dropdown">
                                    <button onclick="togglePipelineFilterDropdown('${columnKey}', event)" 
                                        class="p-1 hover:bg-gray-100 rounded relative">
                                        <svg class="h-4 w-4 ${hasFilter ? 'text-blue-500' : 'text-gray-400'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                                        </svg>
                                        ${hasFilter ? '<span class="absolute -top-1 -right-1 h-2 w-2 rounded-full bg-blue-500"></span>' : ''}
                                    </button>
                                    ${isFilterOpen ? `
                                        <div class="absolute top-full ${alignRight ? 'right-0' : 'left-0'} z-[9999] w-72 mt-2 rounded-2xl border border-gray-200 bg-white p-4 shadow-2xl">
                                            <p class="text-sm font-semibold text-gray-800 mb-3">Filter by ${label}</p>
                                            <div class="mb-3">
                                                <input type="text" 
                                                    id="${searchId}"
                                                    oninput="filterPipelineDropdownValues('${columnKey}')"
                                                    placeholder="Search values..." 
                                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none" />
                                            </div>
                                            <div id="pipelineFilterValues_${columnKey}" class="space-y-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-2 bg-gray-50">
                                                ${displayValues.map(valObj => {
                                                    const valStr = String(valObj.display).toLowerCase();
                                                    return `
                                                    <label class="flex items-center gap-2 py-1.5 hover:bg-white rounded-lg px-2 cursor-pointer transition-colors pipeline-filter-value-item" data-value="${valStr}">
                                                        <input type="checkbox" 
                                                            ${state.columnFilters[columnKey] && state.columnFilters[columnKey].includes(valObj.raw) ? 'checked' : ''}
                                                            onchange="togglePipelineColumnFilter('${columnKey}', ${typeof valObj.raw === 'string' ? `'${String(valObj.raw).replace(/'/g, "\\'")}'` : valObj.raw})"
                                                            class="rounded border-gray-300 text-blue-500 focus:ring-blue-500" />
                                                        <span class="text-sm text-gray-700">${valObj.display}</span>
                                                    </label>
                                                `}).join('')}
                                            </div>
                                            <button onclick="clearPipelineColumnFilter('${columnKey}')" 
                                                class="w-full mt-3 px-3 py-2 text-sm font-medium text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50">
                                                Clear Filter
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                                <!-- Sort Icon -->
                                <button onclick="sortPipelineTable('${columnKey}')" class="flex flex-col gap-0.5 p-1">
                                    <svg class="${isSorted && state.sortDirection === 'asc' ? 'fill-blue-500' : 'fill-gray-300'}" width="8" height="5" viewBox="0 0 8 5">
                                        <path d="M4.40962 0.585167C4.21057 0.300808 3.78943 0.300807 3.59038 0.585166L1.05071 4.21327C0.81874 4.54466 1.05582 5 1.46033 5H6.53967C6.94418 5 7.18126 4.54466 6.94929 4.21327L4.40962 0.585167Z"/>
                                    </svg>
                                    <svg class="${isSorted && state.sortDirection === 'desc' ? 'fill-blue-500' : 'fill-gray-300'}" width="8" height="5" viewBox="0 0 8 5">
                                        <path d="M4.40962 4.41483C4.21057 4.69919 3.78943 4.69919 3.59038 4.41483L1.05071 0.786732C0.81874 0.455343 1.05582 0 1.46033 0H6.53967C6.94418 0 7.18126 0.455342 6.94929 0.786731L4.40962 4.41483Z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </th>
                `;
            }
            
            // Render table headers
            const totalCols = 9;
            const headers = createHeaderCell('Facility ID', 'facilityId', 0, totalCols) +
                          createHeaderCell('Relationship', 'relationship', 1, totalCols) +
                          createHeaderCell('Region', 'region', 2, totalCols) +
                          createHeaderCell('Product', 'product', 3, totalCols) +
                          createHeaderCell('Facility Type', 'facilityType', 4, totalCols) +
                          createHeaderCell('Underwriter', 'underwriter', 5, totalCols) +
                          createHeaderCell('TFA', 'tfa', 6, totalCols) +
                          createHeaderCell('Days', 'daysOld', 7, totalCols) +
                          createHeaderCell('Aging', 'agingCategory', 8, totalCols);
            thead.innerHTML = headers;
            
            // Render table rows
            if (displayItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-8 text-center text-sm text-gray-500">No pending deals found</td></tr>';
                return;
            }
            
            let html = '';
            const regionColors = {
                            'NAM': 'bg-orange-50 text-orange-600',
                            'LATAM': 'bg-purple-50 text-purple-600'
                        };
                        
            displayItems.forEach(item => {
                const regionColor = regionColors[item.region] || 'bg-gray-50 text-gray-600';
                
                // Determine badge color based on aging category
                let agingBadgeClass = '';
                const agingCat = item.agingCategory;
                
                if (agingCat === '1-30 Days') {
                    agingBadgeClass = 'bg-green-50 text-green-700 border border-green-200';
                } else if (agingCat === '31-60 Days') {
                    agingBadgeClass = 'bg-amber-50 text-amber-700 border border-amber-200';
                } else if (agingCat === '61-90 Days') {
                    agingBadgeClass = 'bg-orange-50 text-orange-700 border border-orange-200';
                } else if (agingCat === '> 90 Days') {
                    agingBadgeClass = 'bg-red-50 text-red-700 border border-red-200';
                }
                
                html += `
                            <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-center text-sm whitespace-nowrap font-medium text-gray-900">${item.facilityId}</td>
                        <td class="px-6 py-4 text-center text-sm whitespace-nowrap text-gray-900">${item.relationship}</td>
                        <td class="px-6 py-4 text-center">
                            <span class="${regionColor} rounded-full px-2 py-0.5 text-xs font-medium">
                                ${item.region}
                            </span>
                                </td>
                        <td class="px-6 py-4 text-center text-sm text-gray-700">${item.product}</td>
                        <td class="px-6 py-4 text-center text-sm text-gray-700">${item.facilityType}</td>
                        <td class="px-6 py-4 text-center text-sm text-gray-700">${item.underwriter}</td>
                        <td class="px-6 py-4 text-center text-sm font-semibold text-gray-900">${formatCurrency(item.tfa)}</td>
                        <td class="px-6 py-4 text-center text-sm text-gray-700">${item.daysOld}</td>
                        <td class="px-6 py-4 text-center">
                            <span class="${agingBadgeClass} rounded-full px-2 py-0.5 text-xs font-semibold min-w-[60px] inline-block">
                                ${item.agingCategory}
                            </span>
                                </td>
                            </tr>
                        `;
                    });
            
            tbody.innerHTML = html;
        }
        
        // Render Top Relationships Expanded Analysis Views
        function renderTopRelationshipsExpandedViews() {
            
            // 1. Aging Distribution Chart
            const agingChartEl = document.getElementById('pipelineAgingChart');
            if (agingChartEl && aging && aging.length > 0) {
                const agingOptions = {
                    series: [{
                        name: 'Deals',
                        data: aging.map(a => a.count)
                    }],
                    chart: {
                        type: 'bar',
                        height: 300,
                        fontFamily: 'Outfit, sans-serif',
                        toolbar: { show: false }
                    },
                    colors: ['#f59e0b'],
                    plotOptions: {
                        bar: {
                            borderRadius: 6,
                            columnWidth: '70%',
                            dataLabels: { position: 'top' }
                        }
                    },
                    dataLabels: {
                        enabled: true,
                        offsetY: -20,
                        style: {
                            fontSize: '11px',
                            colors: ['#374151']
                        }
                    },
                    xaxis: {
                        categories: aging.map(a => a.label),
                        axisBorder: { show: false },
                        axisTicks: { show: false }
                    },
                    yaxis: {
                        title: { text: 'Number of Deals' }
                    },
                    grid: {
                        borderColor: '#f1f5f9',
                        strokeDashArray: 4
                    },
                    tooltip: {
                        y: {
                            formatter: function(val, opts) {
                                const tfa = aging[opts.dataPointIndex].tfa;
                                return val + ' deals (' + formatCurrency(tfa) + ')';
                            }
                        }
                    }
                };
                
                agingChartEl.innerHTML = '';
                const agingChart = new ApexCharts(agingChartEl, agingOptions);
                agingChart.render();
            }
            
            // 2. Regional Summary Table
            const regionalTableEl = document.getElementById('pipelineRegionalTable');
            if (regionalTableEl && regional) {
                const regions = Object.keys(regional).filter(r => regional[r].count > 0);
                let tableHTML = `
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700">Region</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700">Pending Deals</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700">Total TFA</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700">Avg per Deal</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                `;
                
                let totalCount = 0, totalTFA = 0;
                regions.forEach(region => {
                    const data = regional[region];
                    totalCount += data.count;
                    totalTFA += data.tfa;
                    const avg = data.count > 0 ? data.tfa / data.count : 0;
                    
                    tableHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 text-sm font-medium text-gray-900">${region}</td>
                            <td class="px-4 py-3 text-sm text-right text-gray-700">${data.count}</td>
                            <td class="px-4 py-3 text-sm text-right font-medium text-gray-900">${formatCurrency(data.tfa)}</td>
                            <td class="px-4 py-3 text-sm text-right text-gray-600">${formatCurrency(avg)}</td>
                        </tr>
                    `;
                });
                
                const avgTotal = totalCount > 0 ? totalTFA / totalCount : 0;
                tableHTML += `
                        <tr class="bg-gray-50 font-semibold border-t-2 border-gray-300">
                            <td class="px-4 py-3 text-sm text-gray-900">Total</td>
                            <td class="px-4 py-3 text-sm text-right text-gray-900">${totalCount}</td>
                            <td class="px-4 py-3 text-sm text-right text-gray-900">${formatCurrency(totalTFA)}</td>
                            <td class="px-4 py-3 text-sm text-right text-gray-900">${formatCurrency(avgTotal)}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
                `;
                regionalTableEl.innerHTML = tableHTML;
            }
            
            // 3. Facility Type Chart
            const facilityTypeChartEl = document.getElementById('pipelineFacilityTypeChart');
            if (facilityTypeChartEl && facilityTypes && facilityTypes.length > 0) {
                const facilityTypeOptions = {
                    series: [{
                        name: 'TFA',
                        data: facilityTypes.map(f => f.tfa)
                    }],
                    chart: {
                        type: 'bar',
                        height: 300,
                        fontFamily: 'Outfit, sans-serif',
                        toolbar: { show: false }
                    },
                    colors: ['#6366f1'],
                    plotOptions: {
                        bar: {
                            borderRadius: 6,
                            horizontal: true,
                            dataLabels: { position: 'right' }
                        }
                    },
                    dataLabels: {
                        enabled: true,
                        formatter: function(val) {
                            return formatCurrency(val);
                        },
                        offsetX: 5,
                        style: {
                            fontSize: '10px',
                            colors: ['#374151']
                        }
                    },
                    xaxis: {
                        categories: facilityTypes.map(f => f.name),
                        labels: {
                            formatter: function(val) {
                                return formatCurrency(val);
                            }
                        }
                    },
                    yaxis: {
                        labels: {
                            maxWidth: 150
                        }
                    },
                    grid: {
                        borderColor: '#f1f5f9',
                        strokeDashArray: 4
                    },
                    tooltip: {
                        y: {
                            formatter: function(val, opts) {
                                const count = facilityTypes[opts.dataPointIndex].count;
                                return formatCurrency(val) + ` (${count} deals)`;
                            }
                        }
                    }
                };
                
                facilityTypeChartEl.innerHTML = '';
                const facilityTypeChart = new ApexCharts(facilityTypeChartEl, facilityTypeOptions);
                facilityTypeChart.render();
            }
            
            // 4. Product Table
            const productTableEl = document.getElementById('pipelineProductTable');
            if (productTableEl && products && products.length > 0) {
                let tableHTML = `
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700">Rank</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700">Product Program</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700">Pending Deals</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700">Total TFA</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700">Avg Age (Days)</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                `;
                
                products.forEach((prod, index) => {
                    tableHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 text-sm text-gray-600">${index + 1}</td>
                            <td class="px-4 py-3 text-sm font-medium text-gray-900">${prod.name}</td>
                            <td class="px-4 py-3 text-sm text-right text-gray-700">${prod.count}</td>
                            <td class="px-4 py-3 text-sm text-right font-medium text-gray-900">${formatCurrency(prod.tfa)}</td>
                            <td class="px-4 py-3 text-sm text-right ${prod.avgAge > 90 ? 'text-red-600 font-semibold' : 'text-gray-600'}">${prod.avgAge}</td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                    </tbody>
                </table>
            </div>
                `;
                productTableEl.innerHTML = tableHTML;
            }
            
            // 5. Underwriter Table
            const underwriterTableEl = document.getElementById('pipelineUnderwriterTable');
            if (underwriterTableEl && underwriters && underwriters.length > 0) {
                let tableHTML = `
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700">Rank</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700">Underwriter</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700">Region</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700">Pending Deals</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700">Total TFA</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700">Avg Age (Days)</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                `;
                
                underwriters.forEach((uw, index) => {
                    tableHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 text-sm text-gray-600">${index + 1}</td>
                            <td class="px-4 py-3 text-sm font-medium text-gray-900">${uw.name}</td>
                            <td class="px-4 py-3 text-sm text-center text-gray-700">${uw.region}</td>
                            <td class="px-4 py-3 text-sm text-right text-gray-700">${uw.facilities}</td>
                            <td class="px-4 py-3 text-sm text-right font-medium text-gray-900">${formatCurrency(uw.tfa)}</td>
                            <td class="px-4 py-3 text-sm text-right ${uw.avgAge > 90 ? 'text-red-600 font-semibold' : 'text-gray-600'}">${uw.avgAge}</td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                    </tbody>
                </table>
            </div>
                `;
                underwriterTableEl.innerHTML = tableHTML;
            }
            
            // 6. Relationship Table
            const relationshipTableEl = document.getElementById('pipelineRelationshipTable');
            if (relationshipTableEl && relationships && relationships.length > 0) {
                let tableHTML = `
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700">Rank</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700">Relationship</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700">Pending Deals</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700">Total TFA</th>
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700">Avg Age (Days)</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                `;
                
                relationships.forEach((rel, index) => {
                    tableHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 text-sm text-gray-600">${index + 1}</td>
                            <td class="px-4 py-3 text-sm font-medium text-gray-900">${rel.name}</td>
                            <td class="px-4 py-3 text-sm text-right text-gray-700">${rel.facilities}</td>
                            <td class="px-4 py-3 text-sm text-right font-medium text-gray-900">${formatCurrency(rel.tfa)}</td>
                            <td class="px-4 py-3 text-sm text-right ${rel.avgAge > 90 ? 'text-red-600 font-semibold' : 'text-gray-600'}">${rel.avgAge}</td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                    </tbody>
                </table>
            </div>
                `;
                relationshipTableEl.innerHTML = tableHTML;
            }
        }
        
        // Render Top Relationships Expanded Analysis Views
        function renderTopRelationshipsExpandedViews() {
            if (!window.topRelationshipsExpandedData || typeof ApexCharts === 'undefined') return;
            
            const { hasData, relationships, regional, exposureBreakdown, products, productChartData, underwriters, exposureLabel, topN } = window.topRelationshipsExpandedData;
            
            console.log(' Rendering Top Relationships - Exposure:', exposureLabel, 'Top N:', topN, 'Has Data:', hasData);
            
            // If no data, replace ENTIRE modal content with no-data message (like CAs & Facilities Expiring)
            if (!hasData) {
                const insightsContent = document.getElementById('insightsContent');
                if (insightsContent) {
                    insightsContent.innerHTML = generateNoDataMessage('Top Relationships');
                }
                return; // Don't render anything else
            }
            
            // Update KPI to reflect selected exposure
            const totalExposureEl = document.getElementById('topRelTotalExposure');
            if (totalExposureEl && regional) {
                const totalExposure = Object.values(regional).reduce((sum, r) => sum + (r.exposure || 0), 0);
                totalExposureEl.textContent = formatCurrency(totalExposure);
            }
            
            // Update KPI label
            const exposureLabelEl = document.getElementById('topRelExposureLabel');
            if (exposureLabelEl) {
                exposureLabelEl.textContent = `Total ${exposureLabel}`;
            }
            
            // Update table column header
            const tableHeaderEl = document.getElementById('topRelTableExposureHeader');
            if (tableHeaderEl) {
                tableHeaderEl.textContent = exposureLabel;
            }
            
            // 1. Regional Summary Table
            const regionalTableEl = document.getElementById('topRelationshipsRegionalTable');
            if (regionalTableEl && regional) {
                // Always show all regions, sorted by selected exposure (highest to lowest)
                const regionEntries = [
                    { name: 'APAC', ...(regional.APAC || {count: 0, tfa: 0, exposure: 0}) },
                    { name: 'EMEA', ...(regional.EMEA || {count: 0, tfa: 0, exposure: 0}) },
                    { name: 'NAM', ...(regional.NAM || {count: 0, tfa: 0, exposure: 0}) },
                    { name: 'LATAM', ...(regional.LATAM || {count: 0, tfa: 0, exposure: 0}) }
                ].sort((a, b) => b.exposure - a.exposure);
                
                // Check if total exposure is 0
                const totalExposureCheck = regionEntries.reduce((sum, r) => sum + r.exposure, 0);
                if (totalExposureCheck === 0) {
                    regionalTableEl.innerHTML = generateNoDataMessage('Regional Distribution');
                } else {
                    let tableHTML = `
                        <table class="w-full h-full">
                            <thead>
                                <tr class="border-b border-gray-200 bg-gray-50">
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700">Region</th>
                                    <th class="px-6 py-4 text-right text-xs font-semibold text-gray-700">Relationships</th>
                                    <th class="px-6 py-4 text-right text-xs font-semibold text-gray-700">${exposureLabel}</th>
                                    <th class="px-6 py-4 text-right text-xs font-semibold text-gray-700">Avg per Client</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                    `;
                    
                    let totalCount = 0, totalExposure = 0;
                    regionEntries.forEach(region => {
                        const avg = region.count > 0 ? region.exposure / region.count : 0;
                        totalCount += region.count;
                        totalExposure += region.exposure;
                    
                    tableHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 text-sm font-medium text-gray-900">${region.name}</td>
                            <td class="px-6 py-4 text-sm text-right text-gray-700">${region.count}</td>
                            <td class="px-6 py-4 text-sm text-right font-medium text-gray-900">${formatCurrency(region.exposure)}</td>
                            <td class="px-6 py-4 text-sm text-right text-gray-600">${formatCurrency(avg)}</td>
                        </tr>
                    `;
                });
                
                const avgTotal = totalCount > 0 ? totalExposure / totalCount : 0;
                tableHTML += `
                        <tr class="bg-gray-50 font-semibold border-t-2 border-gray-300">
                            <td class="px-6 py-4 text-sm text-gray-900 rounded-bl-xl">Total</td>
                            <td class="px-6 py-4 text-sm text-right text-gray-900">${totalCount}</td>
                            <td class="px-6 py-4 text-sm text-right text-gray-900">${formatCurrency(totalExposure)}</td>
                            <td class="px-6 py-4 text-sm text-right text-gray-900 rounded-br-xl">${formatCurrency(avgTotal)}</td>
                        </tr>
                        </tbody>
                    </table>
                    `;
                    regionalTableEl.innerHTML = tableHTML;
                }
            }
            
            // 2. Product Level Breakdown - Donut Chart (matching New Deals YTD style)
            const productChartEl = document.getElementById('topRelationshipsProductChart');
            const productListEl = document.getElementById('topRelationshipsProductList');
            if (productChartEl && productChartData && productChartData.length > 0) {
                const totalExposure = productChartData.reduce((sum, p) => sum + p.exposure, 0);
                
                // If total exposure is 0, show no data message
                if (totalExposure === 0) {
                    productChartEl.innerHTML = generateNoDataMessage('Product Breakdown');
                    if (productListEl) {
                        productListEl.innerHTML = '';
                    }
                } else {
                    const colors = [
                    "#3641f5",  // Primary blue
                    "#7592ff",  // Light blue
                    "#dde9ff",  // Lighter blue
                    "#ff6b6b",  // Red
                    "#ffd93d",  // Yellow
                    "#6bcf7f",  // Green
                    "#c084fc",  // Purple
                    "#14b8a6",  // Teal
                    "#f97316",  // Orange
                    "#06b6d4"   // Cyan
                ];
                
                const productDonutOptions = {
                    series: productChartData.map(p => p.exposure),
                    colors: colors.slice(0, productChartData.length),
                    labels: productChartData.map(p => p.product),
                    chart: {
                        fontFamily: "Outfit, sans-serif",
                        type: "donut",
                        width: 300,
                        height: 300,
                    },
                    stroke: {
                        show: false,
                    },
                    plotOptions: {
                        pie: {
                            donut: {
                                size: "65%",
                                background: "transparent",
                                labels: {
                                    show: true,
                                    name: {
                                        show: true,
                                        offsetY: -10,
                                        color: "#1D2939",
                                        fontSize: "14px",
                                        fontWeight: "600",
                                    },
                                    value: {
                                        show: true,
                                        offsetY: 10,
                                        color: "#667085",
                                        fontSize: "16px",
                                        fontWeight: "700",
                                        formatter: (val) => formatCurrency(val),
                                    },
                                    total: {
                                        show: true,
                                        label: `Total ${exposureLabel}`,
                                        color: "#111827",
                                        fontSize: "16px",
                                        fontWeight: "700",
                                        formatter: () => formatCurrency(totalExposure),
                                    },
                                },
                            },
                        },
                    },
                    dataLabels: {
                        enabled: false,
                    },
                    legend: {
                        show: false, // Hide built-in legend, using custom HTML legend
                    },
                    tooltip: {
                        enabled: true,
                        theme: "light",
                        followCursor: false,
                        custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                            const product = productChartData[seriesIndex];
                            const productName = product.product;
                            const exposureAmount = product.exposure;
                            const facilityCount = product.count;
                            const percentage = totalExposure > 0 ? ((exposureAmount / totalExposure) * 100).toFixed(1) : 0;
                            const regionalBreakdown = product.regionalBreakdown || { NAM: { count: 0 }, LATAM: { count: 0 }, EMEA: { count: 0 }, APAC: { count: 0 } };
                            
                            // Get the appropriate exposure field from regional breakdown based on selected exposure type
                            const getRegionalExposure = (regionData) => {
                                switch(exposureLabel) {
                                    case "TFA": return regionData.tfa;
                                    case "Contingent": return regionData.contingent;
                                    case "PSE": return regionData.pse;
                                    case "OSUC": return regionData.osuc;
                                    case "Unused": return regionData.unused;
                                    case "Total OS": return regionData.totalOS;
                                    case "Direct":
                                    default: return regionData.direct;
                                }
                            };
                            
                            // Build regional table rows
                            let regionalRows = '';
                            ['NAM', 'LATAM', 'EMEA', 'APAC'].forEach(region => {
                                const regionData = regionalBreakdown[region];
                                if (regionData) {
                                    const regionExposure = getRegionalExposure(regionData);
                                    if (regionData.count > 0 || regionExposure > 0) {
                                        regionalRows += `
                                            <tr>
                                                <td style="padding: 6px 8px; text-align: left; font-size: 11px; color: #6B7280; font-weight: 500;">${region}</td>
                                                <td style="padding: 6px 8px; text-align: center; font-size: 11px; color: #111827; font-weight: 600;">${regionData.count}</td>
                                                <td style="padding: 6px 8px; text-align: right; font-size: 11px; color: #111827; font-weight: 600;">${formatCurrency(regionExposure)}</td>
                                            </tr>
                                        `;
                                    }
                                }
                            });
                            
                            return `
                                <div style="
                                    background: #ffffff; 
                                    border-radius: 12px; 
                                    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
                                    min-width: 320px;
                                    max-width: 360px;
                                    overflow: hidden;
                                    font-family: Outfit, sans-serif;
                                ">
                                    <!-- Header with border -->
                                    <div style="
                                        border-bottom: 1px solid #E5E7EB;
                                        padding: 16px 16px 12px 16px;
                                        margin-bottom: 14px;
                                    ">
                                        <div style="
                                            font-weight: 600; 
                                            font-size: 15px; 
                                            color: #111827;
                                            margin-bottom: 4px;
                                        ">${productName}</div>
                                        <div style="
                                            font-size: 12px; 
                                            font-weight: 500;
                                            color: #6B7280;
                                        ">Product Program</div>
                                    </div>
                                    
                                    <!-- Content wrapper -->
                                    <div style="padding: 0 16px 16px 16px;">
                                        <!-- Widget Grid (2 columns) -->
                                        <div style="
                                            display: grid;
                                            grid-template-columns: 1fr 1fr;
                                            gap: 10px;
                                            margin-bottom: 16px;
                                        ">
                                            <!-- Widget 1: % of Total -->
                                            <div style="
                                                background: #F9FAFB;
                                                border-radius: 8px;
                                                padding: 12px;
                                                border: 1px solid #E5E7EB;
                                            ">
                                                <div style="
                                                    display: flex;
                                                    align-items: center;
                                                    gap: 6px;
                                                    font-size: 11px;
                                                    color: #6B7280;
                                                    font-weight: 500;
                                                    margin-bottom: 6px;
                                                ">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <circle cx="12" cy="12" r="10"></circle>
                                                        <polyline points="12 6 12 12 16 14"></polyline>
                                                    </svg>
                                                    % of Total
                                                </div>
                                                <div style="
                                                    font-size: 20px;
                                                    font-weight: 700;
                                                    color: #111827;
                                                ">${percentage}%</div>
                                            </div>
                                            
                                            <!-- Widget 2: Facility Count -->
                                            <div style="
                                                background: #F9FAFB;
                                                border-radius: 8px;
                                                padding: 12px;
                                                border: 1px solid #E5E7EB;
                                            ">
                                                <div style="
                                                    display: flex;
                                                    align-items: center;
                                                    gap: 6px;
                                                    font-size: 11px;
                                                    color: #6B7280;
                                                    font-weight: 500;
                                                    margin-bottom: 6px;
                                                ">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                                    </svg>
                                                    Facilities
                                                </div>
                                                <div style="
                                                    font-size: 20px;
                                                    font-weight: 700;
                                                    color: #111827;
                                                ">${facilityCount}</div>
                                            </div>
                                        </div>
                                        
                                        <!-- Regional Distribution Table -->
                                        <div style="margin-top: 12px;">
                                            <div style="
                                                display: flex;
                                                align-items: center;
                                                gap: 6px;
                                                margin-bottom: 8px;
                                            ">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2">
                                                    <circle cx="12" cy="12" r="10"></circle>
                                                    <line x1="2" y1="12" x2="22" y2="12"></line>
                                                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                                </svg>
                                                <span style="
                                                    font-size: 12px;
                                                    font-weight: 600;
                                                    color: #374151;
                                                ">Regional Distribution</span>
                                            </div>
                                            <table style="width: 100%; border-collapse: collapse;">
                                                <thead>
                                                    <tr style="border-bottom: 1px solid #E5E7EB;">
                                                        <th style="padding: 6px 8px; text-align: left; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Region</th>
                                                        <th style="padding: 6px 8px; text-align: center; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Count</th>
                                                        <th style="padding: 6px 8px; text-align: right; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">${exposureLabel}</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${regionalRows || '<tr><td colspan="3" style="padding: 8px; text-align: center; font-size: 11px; color: #9CA3AF;">No data</td></tr>'}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    },
                };
                
                productChartEl.innerHTML = '';
                const productDonutChart = new ApexCharts(productChartEl, productDonutOptions);
                productDonutChart.render();
                
                // Add tooltip positioning fix
                setTimeout(() => {
                    const tooltipObserver = new MutationObserver(() => {
                        const tooltip = productChartEl.querySelector('.apexcharts-tooltip.apexcharts-active');
                        if (tooltip && !tooltip.hasAttribute('data-positioned')) {
                            const tooltipRect = tooltip.getBoundingClientRect();
                            const windowWidth = window.innerWidth;
                            const windowHeight = window.innerHeight;
                            const margin = 10;
                            
                            let needsReposition = false;
                            
                            if (tooltipRect.left < margin) {
                                tooltip.style.left = margin + 'px';
                                tooltip.style.transform = 'none';
                                needsReposition = true;
                            } else if (tooltipRect.right > windowWidth - margin) {
                                tooltip.style.left = (windowWidth - tooltipRect.width - margin) + 'px';
                                tooltip.style.transform = 'none';
                                needsReposition = true;
                            }
                            
                            if (tooltipRect.top < margin) {
                                tooltip.style.top = margin + 'px';
                                needsReposition = true;
                            } else if (tooltipRect.bottom > windowHeight - margin) {
                                tooltip.style.top = (windowHeight - tooltipRect.height - margin) + 'px';
                                needsReposition = true;
                            }
                            
                            if (needsReposition) {
                                tooltip.setAttribute('data-positioned', 'true');
                            }
                        }
                        
                        const hiddenTooltip = productChartEl.querySelector('.apexcharts-tooltip:not(.apexcharts-active)[data-positioned]');
                        if (hiddenTooltip) {
                            hiddenTooltip.removeAttribute('data-positioned');
                        }
                    });
                    
                    tooltipObserver.observe(productChartEl, {
                        attributes: true,
                        attributeFilter: ['class'],
                        subtree: true
                    });
                }, 200);
                
                // Populate legend list (matching New Deals YTD style: exposure  count)
                if (productListEl) {
                    productListEl.innerHTML = productChartData.map((product, index) => {
                        const color = colors[index % colors.length];
                        const formattedAmount = product.exposure >= 1000000000 
                            ? `$${(product.exposure / 1000000000).toFixed(2)}B`
                            : `$${(product.exposure / 1000000).toFixed(1)}M`;
                        return `
                            <div class="flex items-center gap-3 py-2">
                                <div class="w-4 h-4 rounded-sm flex-shrink-0" style="background-color: ${color};"></div>
                                <p class="text-sm font-medium text-gray-800 flex-1">${product.product}</p>
                                <p class="text-sm font-semibold text-gray-900">${formattedAmount}  ${product.count}</p>
                            </div>
                        `;
                    }).join('');
                }
                }
            }
            
            // 3. Relationship Details Table (matching CAs Expiring structure)
            const tableBodyEl = document.getElementById('topRelationshipsTableBody');
            if (tableBodyEl && relationships && relationships.length > 0) {
                // Check if all relationships have 0 for selected exposure
                const totalSelectedExposure = relationships.reduce((sum, r) => sum + (r.selectedExposure || 0), 0);
                
                if (totalSelectedExposure === 0) {
                    tableBodyEl.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-sm text-gray-500">No data available for selected exposure type</td></tr>';
                } else {
                    let html = '';
                    
                    // Limit to top 10
                    const displayRelationships = relationships.slice(0, 10);
                
                displayRelationships.forEach(rel => {
                    const regionColors = {
                        'APAC': 'bg-blue-50 text-blue-600',
                        'EMEA': 'bg-green-50 text-green-600',
                        'NAM': 'bg-orange-50 text-orange-600',
                        'LATAM': 'bg-purple-50 text-purple-600'
                    };
                    const regionColor = regionColors[rel.region] || 'bg-gray-50 text-gray-600';
                    
                    // ROTCE status color
                    const rotceColor = rel.avgROTCE >= 12 
                        ? 'bg-green-100 text-green-700' 
                        : rel.avgROTCE >= 8 
                            ? 'bg-amber-100 text-amber-700' 
                            : 'bg-red-100 text-red-700';
                    
                    html += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 text-center text-sm font-medium text-gray-900">${rel.name}</td>
                            <td class="px-6 py-4 text-center">
                                <span class="${regionColor} rounded-full px-2 py-0.5 text-xs font-medium">
                                    ${rel.region}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="bg-gray-100 rounded-full px-2 py-0.5 text-xs font-medium text-gray-700">
                                    ${rel.facilities}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-center text-sm font-semibold text-gray-900">${formatCurrency(rel.selectedExposure)}</td>
                            <td class="px-6 py-4 text-center text-sm text-gray-700">${formatCurrency(rel.totalOS)}</td>
                            <td class="px-6 py-4 text-center text-sm text-gray-700">${formatCurrency(rel.osuc)}</td>
                            <td class="px-6 py-4 text-center">
                                <span class="${rotceColor} rounded-full px-2 py-0.5 text-xs font-medium">
                                    ${rel.avgROTCE.toFixed(1)}%
                                </span>
                            </td>
                        </tr>
                    `;
                    });
                    
                    tableBodyEl.innerHTML = html;
                }
            } else if (tableBodyEl) {
                tableBodyEl.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-sm text-gray-500">No relationship data available</td></tr>';
            }
        }
        
        // Render ROTCE Performance Expanded Analysis Views
        function renderROTCEExpandedViews() {
            if (!window.rotceExpandedData || typeof ApexCharts === 'undefined') return;
            
            const { hasData, relationships, belowTargetRelationships, regional, portfolioAvg, topN, stats, exposureType, exposureLabel } = window.rotceExpandedData;
            
            console.log(' Rendering ROTCE - Exposure:', exposureType, 'Has Data:', hasData);
            
            // If no data, replace ENTIRE modal content with no-data message (like CAs & Facilities Expiring)
            if (!hasData) {
                const insightsContent = document.getElementById('insightsContent');
                if (insightsContent) {
                    insightsContent.innerHTML = generateNoDataMessage('ROTCE Performance');
                }
                return; // Don't render anything else
            }
            
            // Update KPI values
            document.getElementById('rotcePortfolioAvg').textContent = portfolioAvg.toFixed(1) + '%';
            document.getElementById('rotcePortfolioAvg').className = `text-2xl font-bold ${portfolioAvg >= 12 ? 'text-green-600' : 'text-amber-600'}`;
            
            document.getElementById('rotceAboveTarget').textContent = stats.good + stats.excellent;
            document.getElementById('rotceAboveTargetPct').textContent = `${((stats.good + stats.excellent) / relationships.length * 100).toFixed(0)}% of portfolio`;
            
            document.getElementById('rotceAcceptable').textContent = stats.acceptable;
            document.getElementById('rotceAcceptablePct').textContent = `${(stats.acceptable / relationships.length * 100).toFixed(0)}% of portfolio`;
            
            document.getElementById('rotceBelowTarget').textContent = stats.belowTarget;
            document.getElementById('rotceBelowTargetPct').textContent = `${(stats.belowTarget / relationships.length * 100).toFixed(0)}% of portfolio`;
            
            // 1. Regional Distribution Table (matching CAs Expiring style)
            const regionalTableEl = document.getElementById('rotceRegionalTable');
            if (regionalTableEl && regional) {
                const regionEntries = [
                    { name: 'APAC', ...(regional.APAC || {count: 0, direct: 0, exposure: 0, avgRotce: 0}) },
                    { name: 'EMEA', ...(regional.EMEA || {count: 0, direct: 0, exposure: 0, avgRotce: 0}) },
                    { name: 'NAM', ...(regional.NAM || {count: 0, direct: 0, exposure: 0, avgRotce: 0}) },
                    { name: 'LATAM', ...(regional.LATAM || {count: 0, direct: 0, exposure: 0, avgRotce: 0}) }
                ].sort((a, b) => b.count - a.count);
                
                let tableHTML = `
                <table class="min-w-full h-full">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Region</th>
                            <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Relationships</th>
                            <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">${exposureLabel}</th>
                            <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Avg ROTCE</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                `;
                
                let totalCount = 0;
                let totalExposure = 0;
                let totalRotce = 0;
                let regionsWithData = 0;
                
                regionEntries.forEach(region => {
                    totalCount += region.count;
                    totalExposure += region.exposure;
                    if (region.count > 0) {
                        totalRotce += region.avgRotce;
                        regionsWithData++;
                    }
                    
                    const regionBadgeColors = {
                        'APAC': 'bg-blue-50 text-blue-600',
                        'EMEA': 'bg-green-50 text-green-600',
                        'NAM': 'bg-orange-50 text-orange-600',
                        'LATAM': 'bg-purple-50 text-purple-600'
                    };
                    
                    const rotceColor = region.avgRotce >= 12 ? 'text-green-600' : region.avgRotce >= 8 ? 'text-amber-600' : region.avgRotce > 0 ? 'text-red-600' : 'text-gray-400';
                    
                    tableHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 text-center whitespace-nowrap">
                                <span class="inline-flex items-center justify-center rounded-full px-3 py-1 text-xs font-medium ${regionBadgeColors[region.name]}">${region.name}</span>
                            </td>
                            <td class="px-6 py-4 text-center text-sm whitespace-nowrap text-gray-900">${region.count}</td>
                            <td class="px-6 py-4 text-center text-sm whitespace-nowrap text-gray-900">${formatCurrency(region.exposure)}</td>
                            <td class="px-6 py-4 text-center text-sm whitespace-nowrap font-medium ${rotceColor}">${region.avgRotce > 0 ? region.avgRotce.toFixed(1) + '%' : '-'}</td>
                        </tr>
                    `;
                });
                
                const avgRotce = regionsWithData > 0 ? totalRotce / regionsWithData : 0;
                tableHTML += `
                        <tr class="bg-gray-50 font-semibold border-t-2 border-gray-300">
                            <td class="px-6 py-4 text-center text-sm text-gray-900 rounded-bl-2xl">Total</td>
                            <td class="px-6 py-4 text-center text-sm text-gray-900">${totalCount}</td>
                            <td class="px-6 py-4 text-center text-sm text-gray-900">${formatCurrency(totalExposure)}</td>
                            <td class="px-6 py-4 text-center text-sm font-medium rounded-br-2xl ${avgRotce >= 12 ? 'text-green-600' : avgRotce >= 8 ? 'text-amber-600' : 'text-red-600'}">${avgRotce.toFixed(1)}%</td>
                        </tr>
                    </tbody>
                </table>
                `;
                regionalTableEl.innerHTML = tableHTML;
            }
            
            // 2. Below Target ROTCE Bar Chart (Top 10)
            const belowChartEl = document.getElementById('rotceBelowTargetChart');
            if (belowChartEl) {
                if (belowTargetRelationships && belowTargetRelationships.length > 0) {
                    const belowOptions = {
                        series: [{
                            name: 'ROTCE',
                            data: belowTargetRelationships.map(r => r.avgROTCE)
                        }],
                        chart: {
                            type: 'bar',
                            height: Math.max(300, belowTargetRelationships.length * 40),
                            fontFamily: 'Outfit, sans-serif',
                            toolbar: { show: false },
                            parentHeightOffset: 0
                        },
                        colors: ['#ef4444'],
                        plotOptions: {
                            bar: {
                                borderRadius: 6,
                                horizontal: true,
                                distributed: false,
                                dataLabels: { position: 'right' },
                                barHeight: '70%'
                            }
                        },
                        dataLabels: {
                            enabled: true,
                            textAnchor: 'start',
                            offsetX: 8,
                            style: {
                                fontSize: '11px',
                                fontWeight: 500,
                                colors: ['#374151']
                            },
                            formatter: function(val) {
                                return val.toFixed(1) + '%';
                            }
                        },
                        xaxis: {
                            categories: belowTargetRelationships.map(r => r.name),
                            labels: {
                                formatter: function(val) {
                                    return val.toFixed(1) + '%';
                                },
                                style: {
                                    colors: "#6B7280",
                                    fontSize: "12px",
                                    fontFamily: "Outfit, sans-serif",
                                }
                            },
                            axisBorder: { show: false },
                            axisTicks: { show: false }
                        },
                        yaxis: {
                            labels: {
                                align: 'left',
                                offsetX: -10,
                                style: {
                                    colors: "#6B7280",
                                    fontSize: "12px",
                                    fontFamily: "Outfit, sans-serif",
                                },
                                maxWidth: 180
                            }
                        },
                        grid: {
                            borderColor: '#E5E7EB',
                            strokeDashArray: 4,
                            xaxis: { lines: { show: true } },
                            yaxis: { lines: { show: false } },
                            padding: {
                                top: 4,
                                right: 0,
                                bottom: 0,
                                left: 0
                            }
                        },
                        tooltip: {
                            theme: 'light',
                            followCursor: false,
                            custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                                const rel = belowTargetRelationships[dataPointIndex];
                                const relationshipName = rel.name;
                                const rotce = rel.avgROTCE;
                                const facilities = rel.facilities;
                                const products = rel.products;
                                const region = rel.region;
                                
                                // Region badge colors
                                const regionColors = {
                                    'APAC': '#3B82F6',
                                    'EMEA': '#10B981',
                                    'NAM': '#F97316',
                                    'LATAM': '#A855F7'
                                };
                                const regionColor = regionColors[region] || '#6B7280';
                                
                                // ROTCE status color (for below target)
                                const rotceColor = rotce >= 8 ? '#10B981' : rotce >= 5 ? '#F59E0B' : '#EF4444';
                                
                                // Build exposure breakdown table
                                const exposureData = [
                                    { label: 'TFA', value: rel.tfa },
                                    { label: 'Direct OS', value: rel.direct },
                                    { label: 'Contingent', value: rel.contingent },
                                    { label: 'PSE', value: rel.pse },
                                    { label: 'OSUC', value: rel.osuc },
                                    { label: 'Unused', value: rel.unused }
                                ];
                                
                                let exposureRows = '';
                                exposureData.forEach(item => {
                                    if (item.value > 0) {
                                        exposureRows += `
                                            <tr>
                                                <td style="padding: 6px 8px; text-align: left; font-size: 11px; color: #6B7280; font-weight: 500;">${item.label}</td>
                                                <td style="padding: 6px 8px; text-align: right; font-size: 11px; color: #111827; font-weight: 600;">${formatCurrency(item.value)}</td>
                                            </tr>
                                        `;
                                    }
                                });
                                
                                return `
                                    <div style="
                                        background: #ffffff; 
                                        border-radius: 12px; 
                                        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
                                        min-width: 320px;
                                        max-width: 360px;
                                        overflow: hidden;
                                        font-family: Outfit, sans-serif;
                                    ">
                                        <!-- Header with border -->
                                        <div style="
                                            border-bottom: 1px solid #E5E7EB;
                                            padding: 16px 16px 12px 16px;
                                            margin-bottom: 14px;
                                        ">
                                            <div style="
                                                display: flex;
                                                align-items: center;
                                                gap: 8px;
                                                margin-bottom: 6px;
                                            ">
                                                <div style="
                                                    font-weight: 600; 
                                                    font-size: 15px; 
                                                    color: #111827;
                                                    flex: 1;
                                                ">${relationshipName}</div>
                                                <span style="
                                                    background: ${regionColor};
                                                    color: white;
                                                    font-size: 10px;
                                                    font-weight: 600;
                                                    padding: 3px 8px;
                                                    border-radius: 12px;
                                                ">${region}</span>
                                            </div>
                                            <div style="
                                                font-size: 12px; 
                                                font-weight: 500;
                                                color: #6B7280;
                                            ">Below Target Performance</div>
                                        </div>
                                        
                                        <!-- Content wrapper -->
                                        <div style="padding: 0 16px 16px 16px;">
                                            <!-- Widget Grid (2 columns) -->
                                            <div style="
                                                display: grid;
                                                grid-template-columns: 1fr 1fr;
                                                gap: 10px;
                                                margin-bottom: 16px;
                                            ">
                                                <!-- Widget 1: ROTCE % -->
                                                <div style="
                                                    background: #FEF2F2;
                                                    border-radius: 8px;
                                                    padding: 12px;
                                                    border: 1px solid #FEE2E2;
                                                ">
                                                    <div style="
                                                        display: flex;
                                                        align-items: center;
                                                        gap: 6px;
                                                        font-size: 11px;
                                                        color: #DC2626;
                                                        font-weight: 500;
                                                        margin-bottom: 6px;
                                                    ">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                                                        </svg>
                                                        ROTCE
                                                    </div>
                                                    <div style="
                                                        font-size: 20px;
                                                        font-weight: 700;
                                                        color: ${rotceColor};
                                                    ">${rotce.toFixed(1)}%</div>
                                                </div>
                                                
                                                <!-- Widget 2: Facilities -->
                                                <div style="
                                                    background: #F9FAFB;
                                                    border-radius: 8px;
                                                    padding: 12px;
                                                    border: 1px solid #E5E7EB;
                                                ">
                                                    <div style="
                                                        display: flex;
                                                        align-items: center;
                                                        gap: 6px;
                                                        font-size: 11px;
                                                        color: #6B7280;
                                                        font-weight: 500;
                                                        margin-bottom: 6px;
                                                    ">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                                                        </svg>
                                                        Facilities
                                                    </div>
                                                    <div style="
                                                        font-size: 20px;
                                                        font-weight: 700;
                                                        color: #111827;
                                                    ">${facilities}</div>
                                                </div>
                                            </div>
                                            
                                            <!-- Additional Metrics Row -->
                                            <div style="
                                                display: flex;
                                                gap: 8px;
                                                margin-bottom: 16px;
                                                padding: 8px 12px;
                                                background: #F9FAFB;
                                                border-radius: 6px;
                                            ">
                                                <div style="flex: 1; text-align: center;">
                                                    <div style="font-size: 10px; color: #6B7280; font-weight: 500; margin-bottom: 2px;">Products</div>
                                                    <div style="font-size: 14px; font-weight: 600; color: #111827;">${products}</div>
                                                </div>
                                                <div style="width: 1px; background: #E5E7EB;"></div>
                                                <div style="flex: 1; text-align: center;">
                                                    <div style="font-size: 10px; color: #6B7280; font-weight: 500; margin-bottom: 2px;">Min ROTCE</div>
                                                    <div style="font-size: 14px; font-weight: 600; color: #DC2626;">${rel.minROTCE.toFixed(1)}%</div>
                                                </div>
                                                <div style="width: 1px; background: #E5E7EB;"></div>
                                                <div style="flex: 1; text-align: center;">
                                                    <div style="font-size: 10px; color: #6B7280; font-weight: 500; margin-bottom: 2px;">Max ROTCE</div>
                                                    <div style="font-size: 14px; font-weight: 600; color: ${rel.maxROTCE >= 8 ? '#10B981' : '#DC2626'};">${rel.maxROTCE.toFixed(1)}%</div>
                                                </div>
                                            </div>
                                            
                                            <!-- Exposure Breakdown Table -->
                                            <div style="margin-top: 12px;">
                                                <div style="
                                                    display: flex;
                                                    align-items: center;
                                                    gap: 6px;
                                                    margin-bottom: 8px;
                                                ">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2">
                                                        <line x1="12" y1="1" x2="12" y2="23"></line>
                                                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                                    </svg>
                                                    <span style="
                                                        font-size: 12px;
                                                        font-weight: 600;
                                                        color: #374151;
                                                    ">Exposure Breakdown</span>
                                                </div>
                                                <table style="width: 100%; border-collapse: collapse;">
                                                    <thead>
                                                        <tr style="border-bottom: 1px solid #E5E7EB;">
                                                            <th style="padding: 6px 8px; text-align: left; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Type</th>
                                                            <th style="padding: 6px 8px; text-align: right; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Amount</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${exposureRows || '<tr><td colspan="2" style="padding: 8px; text-align: center; font-size: 11px; color: #9CA3AF;">No data</td></tr>'}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        }
                    };
                    
                    belowChartEl.innerHTML = '';
                    const belowChart = new ApexCharts(belowChartEl, belowOptions);
                    belowChart.render();
                    
                    // Add tooltip positioning fix
                    setTimeout(() => {
                        const tooltipObserver = new MutationObserver(() => {
                            const tooltip = belowChartEl.querySelector('.apexcharts-tooltip.apexcharts-active');
                            if (tooltip && !tooltip.hasAttribute('data-positioned')) {
                                const tooltipRect = tooltip.getBoundingClientRect();
                                const windowWidth = window.innerWidth;
                                const windowHeight = window.innerHeight;
                                const margin = 10;
                                
                                let needsReposition = false;
                                
                                if (tooltipRect.left < margin) {
                                    tooltip.style.left = margin + 'px';
                                    tooltip.style.transform = 'none';
                                    needsReposition = true;
                                } else if (tooltipRect.right > windowWidth - margin) {
                                    tooltip.style.left = (windowWidth - tooltipRect.width - margin) + 'px';
                                    tooltip.style.transform = 'none';
                                    needsReposition = true;
                                }
                                
                                if (tooltipRect.top < margin) {
                                    tooltip.style.top = margin + 'px';
                                    needsReposition = true;
                                } else if (tooltipRect.bottom > windowHeight - margin) {
                                    tooltip.style.top = (windowHeight - tooltipRect.height - margin) + 'px';
                                    needsReposition = true;
                                }
                                
                                if (needsReposition) {
                                    tooltip.setAttribute('data-positioned', 'true');
                                }
                            }
                            
                            const hiddenTooltip = belowChartEl.querySelector('.apexcharts-tooltip:not(.apexcharts-active)[data-positioned]');
                            if (hiddenTooltip) {
                                hiddenTooltip.removeAttribute('data-positioned');
                            }
                        });
                        
                        tooltipObserver.observe(belowChartEl, {
                            attributes: true,
                            attributeFilter: ['class'],
                            subtree: true
                        });
                    }, 200);
                } else {
                    belowChartEl.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-12 text-gray-500">
                            <svg class="h-12 w-12 mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p class="text-sm font-medium">No relationships below target ROTCE</p>
                            <p class="text-sm font-medium text-gray-500 mt-1">All relationships are performing above 8% target</p>
                        </div>
                    `;
                }
            }
        }
        
        // Render Covenant Expanded Analysis Views
        function renderCovenantExpandedViews() {
            if (!window.covenantExpandedData || typeof ApexCharts === 'undefined') return;
            
            const { regional, categories, underwritingLevel, isPastDue, currentViewData, oppositeViewData, totalFacilities, oppositeFacilities } = window.covenantExpandedData;
            
            // Update comparison banner
            const bannerEl = document.getElementById('covenantComparisonBanner');
            if (bannerEl && currentViewData && oppositeViewData) {
                bannerEl.querySelector('p:last-child').innerHTML = `
                    ${isPastDue ? 'Past Due' : 'Coming Due'}: <strong>${currentViewData.length} covenants</strong> (${totalFacilities} facilities) | 
                    ${isPastDue ? 'Coming Due' : 'Past Due'}: <strong>${oppositeViewData.length} covenants</strong> (${oppositeFacilities} facilities)
                `;
            }
            
            // Update KPI metrics
            const metricsEl = document.getElementById('covenantMetrics');
            if (metricsEl && currentViewData) {
                const productCount = Object.keys(currentViewData.reduce((acc, row) => {
                    const product = row.Product_Program_Name || row.Product_Program || "Unknown";
                    acc[product] = true;
                    return acc;
                }, {})).length;
                
                const relationshipCount = Object.keys(currentViewData.reduce((acc, row) => {
                    const rel = row.Relationship_Name || "Unknown";
                    acc[rel] = true;
                    return acc;
                }, {})).length;
                
                const underwriterCount = Object.keys(currentViewData.reduce((acc, row) => {
                    const uw = row.Lead_Underwriter || "Unknown";
                    acc[uw] = true;
                    return acc;
                }, {})).length;
                
                const categoryCount = isPastDue ? Object.keys(currentViewData.reduce((acc, row) => {
                    const cat = row.Past_Due_Category || "Uncategorized";
                    acc[cat] = true;
                    return acc;
                }, {})).length : underwriterCount;
                
                metricsEl.innerHTML = `
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl ${isPastDue ? 'bg-red-100' : 'bg-amber-100'}">
                                <svg class="h-5 w-5 shrink-0 ${isPastDue ? 'text-red-600' : 'text-amber-600'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Total ${isPastDue ? 'Past Due' : 'Coming Due'}</p>
                                <h3 class="text-2xl font-bold text-gray-900">${currentViewData.length}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">${totalFacilities} facilities</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-blue-100">
                                <svg class="h-5 w-5 shrink-0 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Product Programs</p>
                                <h3 class="text-2xl font-bold text-gray-900">${productCount}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">Affected programs</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-purple-100">
                                <svg class="h-5 w-5 shrink-0 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Relationships</p>
                                <h3 class="text-2xl font-bold text-gray-900">${relationshipCount}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">Unique clients</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-green-100">
                                <svg class="h-5 w-5 shrink-0 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">${isPastDue ? 'Categories' : 'Underwriters'}</p>
                                <h3 class="text-2xl font-bold text-gray-900">${categoryCount}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">${isPastDue ? 'Breach types' : 'Responsible'}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // 1. Regional Summary Table (matching CAs Expiring format)
            const regionalTableEl = document.getElementById('covenantRegionalTable');
            if (regionalTableEl && regional) {
                const regionEntries = [
                    { name: 'APAC', ...regional.APAC },
                    { name: 'EMEA', ...regional.EMEA },
                    { name: 'NAM', ...regional.NAM },
                    { name: 'LATAM', ...regional.LATAM }
                ].sort((a, b) => b.count - a.count);
                
                let tableHTML = `
                    <table class="w-full h-full">
                        <thead>
                            <tr class="border-b border-gray-200 bg-gray-50">
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700">Region</th>
                                <th class="px-6 py-4 text-right text-xs font-semibold text-gray-700">Covenants</th>
                                <th class="px-6 py-4 text-right text-xs font-semibold text-gray-700">Facilities</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                `;
                
                let totalCovenants = 0, totalFac = 0;
                regionEntries.forEach(region => {
                    totalCovenants += region.count;
                    totalFac += region.facilityCount;
                    
                    tableHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 text-sm font-medium text-gray-900">${region.name}</td>
                            <td class="px-6 py-4 text-sm text-right text-gray-700">${region.count}</td>
                            <td class="px-6 py-4 text-sm text-right text-gray-700">${region.facilityCount}</td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                        <tr class="bg-gray-50 font-semibold border-t-2 border-gray-300">
                            <td class="px-6 py-4 text-sm text-gray-900 rounded-bl-xl">Total</td>
                            <td class="px-6 py-4 text-sm text-right text-gray-900">${totalCovenants}</td>
                            <td class="px-6 py-4 text-sm text-right text-gray-900 rounded-br-xl">${totalFac}</td>
                        </tr>
                    </tbody>
                </table>
                `;
                regionalTableEl.innerHTML = tableHTML;
            }
            
            // 2. Category/Product Chart - Donut for categories, Bar for products
            const categoryChartEl = document.getElementById('covenantCategoryChart');
            if (categoryChartEl && categories && categories.length > 0) {
                categoryChartEl.innerHTML = '';
                
                if (isPastDue) {
                    // Donut chart for breach categories
                    const colorPalette = ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#6366f1', '#14b8a6', '#f97316'];
                    const categoryOptions = {
                        series: categories.map(c => c.count),
                        labels: categories.map(c => c.name),
                        colors: colorPalette.slice(0, categories.length),
                        chart: {
                            type: 'donut',
                            height: 300,
                            fontFamily: 'Outfit, sans-serif',
                        },
                        plotOptions: {
                            pie: {
                                donut: {
                                    size: '65%',
                                    labels: {
                                        show: true,
                                        name: {
                                            show: true,
                                            fontSize: '14px',
                                            fontWeight: 600,
                                            color: '#1f2937'
                                        },
                                        value: {
                                            show: true,
                                            fontSize: '24px',
                                            fontWeight: 'bold',
                                            color: '#111827',
                                            formatter: (val) => val.toLocaleString()
                                        },
                                        total: {
                                            show: true,
                                            label: 'Total',
                                            fontSize: '14px',
                                            fontWeight: 600,
                                            color: '#6b7280',
                                            formatter: function (w) {
                                                return w.globals.seriesTotals.reduce((a, b) => a + b, 0).toLocaleString();
                                            }
                                        }
                                    }
                                }
                            }
                        },
                        dataLabels: {
                            enabled: false
                        },
                        legend: {
                            position: 'bottom',
                            horizontalAlign: 'center',
                            fontFamily: 'Outfit, sans-serif',
                            fontSize: '12px',
                            fontWeight: 500,
                            markers: {
                                radius: 12
                            },
                            itemMargin: {
                                horizontal: 8,
                                vertical: 4
                            }
                        },
                        tooltip: {
                            enabled: true,
                            theme: 'light',
                            y: {
                                formatter: (val) => `${val} covenants`
                            }
                        }
                    };
                    
                    const categoryChart = new ApexCharts(categoryChartEl, categoryOptions);
                    categoryChart.render();
                } else {
                    // Bar chart for product programs
                    const chartHeight = Math.max(280, categories.length * 34);
                    const categoryOptions = {
                        series: [{
                            name: 'Covenants',
                            data: categories.map(c => c.count)
                        }],
                        chart: {
                            type: 'bar',
                            height: chartHeight,
                            fontFamily: 'Outfit, sans-serif',
                            toolbar: { show: false }
                        },
                        colors: ['#3b82f6'],
                        plotOptions: {
                            bar: {
                                borderRadius: 6,
                                horizontal: true,
                                dataLabels: { position: 'right' }
                            }
                        },
                        dataLabels: {
                            enabled: true,
                            offsetX: 5,
                            style: {
                                fontSize: '11px',
                                fontWeight: 600,
                                colors: ['#374151']
                            }
                        },
                        xaxis: {
                            categories: categories.map(c => c.name.length > 30 ? c.name.substring(0, 30) + '...' : c.name),
                            labels: {
                                style: {
                                    fontSize: '11px'
                                }
                            }
                        },
                        yaxis: {
                            labels: {
                                maxWidth: 150,
                                style: {
                                    fontSize: '11px'
                                }
                            }
                        },
                        grid: {
                            borderColor: '#f1f5f9',
                            strokeDashArray: 4,
                            xaxis: {
                                lines: {
                                    show: true
                                }
                            },
                            yaxis: {
                                lines: {
                                    show: false
                                }
                            }
                        },
                        tooltip: {
                            theme: 'light',
                            y: {
                                formatter: (val) => `${val} covenants`
                            }
                        }
                    };
                    
                    const categoryChart = new ApexCharts(categoryChartEl, categoryOptions);
                    categoryChart.render();
                }
            }
            
            // 3. Render Top 10 Underwriting Level Table
            renderCovenantUnderwritingTable();
        }
        
        // Render Top 10 Underwriting Level table with aging buckets
        function renderCovenantUnderwritingTable() {
            const tableBody = document.getElementById('covenantUnderwritingTableBody');
            if (!tableBody || !window.covenantExpandedData || !window.covenantExpandedData.underwritingLevel) return;
            
            const data = window.covenantExpandedData.underwritingLevel;
            
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="11" class="px-6 py-8 text-center text-sm text-gray-500">No data available for the selected view.</td></tr>';
                return;
            }
            
            const regionColors = {
                'APAC': 'bg-blue-50 text-blue-600 border border-blue-200',
                'EMEA': 'bg-green-50 text-green-600 border border-green-200',
                'NAM': 'bg-orange-50 text-orange-600 border border-orange-200',
                'LATAM': 'bg-purple-50 text-purple-600 border border-purple-200'
            };
            
            let tableHTML = '';
            data.forEach(row => {
                const regionColor = regionColors[row.region] || 'bg-gray-50 text-gray-600 border border-gray-200';
                
                tableHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-center">
                            <span class="${regionColor} rounded-full px-2 py-1 text-xs font-medium whitespace-nowrap">
                                ${row.region}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-center font-medium text-gray-900">${row.underwriter}</td>
                        <td class="px-6 py-4 text-sm text-center text-gray-700">${row.relationshipName}</td>
                        <td class="px-6 py-4 text-sm text-center text-gray-700">${row.facilityType}</td>
                        <td class="px-6 py-4 text-sm text-center text-gray-700">${row.covenantNumber || '-'}</td>
                        <td class="px-6 py-4 text-sm text-center text-gray-700">${row.caId || '-'}</td>
                        <td class="px-6 py-4 text-center">
                            ${row.days_1_45 > 0 ? `<span class="inline-flex items-center justify-center bg-blue-50 text-blue-700 border border-blue-200 rounded-full px-2 py-1 text-xs font-semibold min-w-[40px]">${row.days_1_45}</span>` : '<span class="text-gray-400 text-xs">-</span>'}
                        </td>
                        <td class="px-6 py-4 text-center">
                            ${row.days_46_60 > 0 ? `<span class="inline-flex items-center justify-center bg-orange-50 text-orange-700 border border-orange-200 rounded-full px-2 py-1 text-xs font-semibold min-w-[40px]">${row.days_46_60}</span>` : '<span class="text-gray-400 text-xs">-</span>'}
                        </td>
                        <td class="px-6 py-4 text-center">
                            ${row.days_61_90 > 0 ? `<span class="inline-flex items-center justify-center bg-red-50 text-red-700 border border-red-200 rounded-full px-2 py-1 text-xs font-semibold min-w-[40px]">${row.days_61_90}</span>` : '<span class="text-gray-400 text-xs">-</span>'}
                        </td>
                        <td class="px-6 py-4 text-center">
                            ${row.days_90_plus > 0 ? `<span class="inline-flex items-center justify-center bg-red-100 text-red-900 border border-red-300 rounded-full px-2 py-1 text-xs font-bold min-w-[40px]">${row.days_90_plus}</span>` : '<span class="text-gray-400 text-xs">-</span>'}
                        </td>
                        <td class="px-6 py-4 text-center">
                            ${row.comingDue > 0 ? `<span class="inline-flex items-center justify-center bg-amber-50 text-amber-700 border border-amber-200 rounded-full px-2 py-1 text-xs font-semibold min-w-[40px]">${row.comingDue}</span>` : '<span class="text-gray-400 text-xs">-</span>'}
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
        }
        
        // Old CCM rendering function removed - now using direct initialization in generateCCMExpandedView
        
        // Render expiring table with pagination and search
        function renderExpiringTable(dataSourceParam) {
            const dataSource = dataSourceParam || (filteredData.length > 0 ? filteredData : portfolioData);
            const tbody = document.getElementById('expiringTableBody');
            const thead = document.getElementById('expiringTableHeader');
            
            if (!tbody || !thead || !dataSource) return;
            
            const state = window.expiringTableState;
            const viewFilter = state.viewFilter; // 'cas' or 'facilities'
            const categoryFilter = state.categoryFilter; // 'expiring' or 'expired'
            
            // Get report date
            const reportDates = dataSource.map(row => parseDate(row.Report_Date)).filter(d => d);
            const maxReportDate = reportDates.length > 0 ? new Date(Math.max(...reportDates)) : new Date();
            maxReportDate.setHours(0, 0, 0, 0);
            
            // Calculate date ranges for next 3 months
            const next3MonthsEnd = new Date(maxReportDate);
            next3MonthsEnd.setMonth(next3MonthsEnd.getMonth() + 3);
            next3MonthsEnd.setHours(23, 59, 59, 999);
            
            // Collect items based on filters
            const items = [];
            
            // Process CAs if viewFilter is 'cas'
            if (viewFilter === 'cas') {
                dataSource.forEach(row => {
                    const caExpirationDate = row.CA_Expiration_Date;
                    const managementStatus = (row.Management_Status || "").toUpperCase();
                    const region = (row.Region || "").toUpperCase();
                    const caReview = (row.CA_Review || "").trim();
                    
                    if (caExpirationDate && managementStatus === "CM" && row.Relationship_ID) {
                        const dateObj = parseDate(caExpirationDate);
                        if (!dateObj) return;
                        
                        // Check EMEA CA_Review requirement
                        if (region === "EMEA" && caReview !== "Yes") return;
                        
                        const amount = parseNumber(row.Fac_Amount || row.Facility_Amount);
                        
                        // Collect based on category filter
                        if (categoryFilter === 'expiring') {
                            // Expiring: items in next 3 months
                            if (dateObj >= maxReportDate && dateObj <= next3MonthsEnd) {
                                const daysToExpiry = Math.ceil((dateObj - maxReportDate) / (1000 * 60 * 60 * 24));
                                
                                // Categorize by aging bucket
                                let agingCategory = '';
                                if (daysToExpiry >= 0 && daysToExpiry <= 30) {
                                    agingCategory = '0-30 Days';
                                } else if (daysToExpiry >= 31 && daysToExpiry <= 60) {
                                    agingCategory = '31-60 Days';
                                } else if (daysToExpiry >= 61 && daysToExpiry <= 90) {
                                    agingCategory = '61-90 Days';
                                } else if (daysToExpiry > 90) {
                                    agingCategory = '> 90 Days';
                                }
                                
                                items.push({
                                    type: 'CA',
                                    region: row.Region || 'Unknown',
                                    relationship: row.Relationship_Name || row.Relationship_ID || 'Unknown',
                                    underwriter: row.Lead_Underwriter || 'Unknown',
                                    product: row.Product_Program || 'Unknown',
                                    expiryDate: dateObj.toLocaleDateString(),
                                    date: dateObj,
                                    tfa: amount,
                                    status: 'Expiring',
                                    daysToExpiry: daysToExpiry,
                                    agingCategory: agingCategory
                                });
                            }
                        } else {
                            // Expired: items before report date
                            if (dateObj < maxReportDate) {
                                const daysPastDue = Math.floor((maxReportDate - dateObj) / (1000 * 60 * 60 * 24));
                                
                                // Categorize by aging bucket
                                let agingCategory = '';
                                if (daysPastDue >= 1 && daysPastDue <= 30) {
                                    agingCategory = '1-30 Days';
                                } else if (daysPastDue >= 31 && daysPastDue <= 60) {
                                    agingCategory = '31-60 Days';
                                } else if (daysPastDue >= 61 && daysPastDue <= 90) {
                                    agingCategory = '61-90 Days';
                                } else if (daysPastDue > 90) {
                                    agingCategory = '> 90 Days';
                                }
                                
                                items.push({
                                    type: 'CA',
                                    region: row.Region || 'Unknown',
                                    relationship: row.Relationship_Name || row.Relationship_ID || 'Unknown',
                                    underwriter: row.Lead_Underwriter || 'Unknown',
                                    product: row.Product_Program || 'Unknown',
                                    expiryDate: dateObj.toLocaleDateString(),
                                    date: dateObj,
                                    tfa: amount,
                                    status: 'Expired',
                                    daysPastDue: daysPastDue,
                                    agingCategory: agingCategory
                                });
                            }
                        }
                    }
                });
            }
            
            // Process Facilities if viewFilter is 'facilities'
            if (viewFilter === 'facilities') {
                dataSource.forEach(row => {
                    const maturityDate = row.Maturity_Date;
                    const facilityId = row.Facility_ID;
                    
                    if (maturityDate && facilityId) {
                        const dateObj = parseDate(maturityDate);
                        if (!dateObj) return;
                        
                        const amount = parseNumber(row.Fac_Amount || row.Facility_Amount);
                        
                        // Collect based on category filter
                        if (categoryFilter === 'expiring') {
                            // Expiring: items in next 3 months
                            if (dateObj >= maxReportDate && dateObj <= next3MonthsEnd) {
                                const daysToExpiry = Math.ceil((dateObj - maxReportDate) / (1000 * 60 * 60 * 24));
                                
                                // Categorize by aging bucket
                                let agingCategory = '';
                                if (daysToExpiry >= 0 && daysToExpiry <= 30) {
                                    agingCategory = '0-30 Days';
                                } else if (daysToExpiry >= 31 && daysToExpiry <= 60) {
                                    agingCategory = '31-60 Days';
                                } else if (daysToExpiry >= 61 && daysToExpiry <= 90) {
                                    agingCategory = '61-90 Days';
                                } else if (daysToExpiry > 90) {
                                    agingCategory = '> 90 Days';
                                }
                                
                                items.push({
                                    type: 'Facility',
                                    region: row.Region || 'Unknown',
                                    relationship: row.Relationship_Name || 'Unknown',
                                    underwriter: row.Lead_Underwriter || 'Unknown',
                                    product: row.Product_Program || 'Unknown',
                                    facilityId: facilityId,
                                    maturityDate: dateObj.toLocaleDateString(),
                                    date: dateObj,
                                    tfa: amount,
                                    status: 'Expiring',
                                    daysToExpiry: daysToExpiry,
                                    agingCategory: agingCategory
                                });
                            }
                        } else {
                            // Expired: items before report date
                            if (dateObj < maxReportDate) {
                                const daysPastDue = Math.floor((maxReportDate - dateObj) / (1000 * 60 * 60 * 24));
                                
                                // Categorize by aging bucket
                                let agingCategory = '';
                                if (daysPastDue >= 1 && daysPastDue <= 30) {
                                    agingCategory = '1-30 Days';
                                } else if (daysPastDue >= 31 && daysPastDue <= 60) {
                                    agingCategory = '31-60 Days';
                                } else if (daysPastDue >= 61 && daysPastDue <= 90) {
                                    agingCategory = '61-90 Days';
                                } else if (daysPastDue > 90) {
                                    agingCategory = '> 90 Days';
                                }
                                
                                items.push({
                                    type: 'Facility',
                                    region: row.Region || 'Unknown',
                                    relationship: row.Relationship_Name || 'Unknown',
                                    underwriter: row.Lead_Underwriter || 'Unknown',
                                    product: row.Product_Program || 'Unknown',
                                    facilityId: facilityId,
                                    maturityDate: dateObj.toLocaleDateString(),
                                    date: dateObj,
                                    tfa: amount,
                                    status: 'Expired',
                                    daysPastDue: daysPastDue,
                                    agingCategory: agingCategory
                                });
                            }
                        }
                    }
                });
            }
            
            // Sort by date (closest first for expiring, most overdue first for expired)
            if (categoryFilter === 'expiring') {
                items.sort((a, b) => a.date - b.date);
            } else {
                items.sort((a, b) => b.daysPastDue - a.daysPastDue);
            }
            
            // Store items before filtering for header unique values
            const itemsBeforeFilters = items;
            
            // Apply search filter
            let filteredItems = items;
            if (state.searchQuery) {
                filteredItems = items.filter(item => {
                    const searchStr = `${item.relationship} ${item.region} ${item.underwriter} ${item.product} ${item.facilityId || ''}`.toLowerCase();
                    return searchStr.includes(state.searchQuery);
                });
            }
            
            // Apply column filters
            if (state.columnFilters && Object.keys(state.columnFilters).length > 0) {
                filteredItems = filteredItems.filter(item => {
                    for (const [column, filters] of Object.entries(state.columnFilters)) {
                        if (filters && filters.length > 0) {
                            let itemValue = item[column];
                            if (!filters.includes(itemValue)) {
                                return false;
                            }
                        }
                    }
                    return true;
                });
            }
            
            // Apply sorting
            if (state.sortColumn) {
                filteredItems.sort((a, b) => {
                    const modifier = state.sortDirection === 'asc' ? 1 : -1;
                    const aVal = a[state.sortColumn];
                    const bVal = b[state.sortColumn];
                    
                    // Handle numeric comparison for TFA
                    if (state.sortColumn === 'tfa') {
                        return (aVal - bVal) * modifier;
                    }
                    
                    // Handle date comparison
                    if (state.sortColumn === 'date') {
                        return (aVal - bVal) * modifier;
                    }
                    
                    // String comparison
                    if (aVal < bVal) return -1 * modifier;
                    if (aVal > bVal) return 1 * modifier;
                    return 0;
                });
            }
            
            // Store all filtered data
            state.allData = filteredItems;
            
            // Calculate pagination
            const totalItems = filteredItems.length;
            const totalPages = Math.ceil(totalItems / state.perPage);
            const startIdx = (state.currentPage - 1) * state.perPage;
            const endIdx = Math.min(startIdx + state.perPage, totalItems);
            const displayItems = filteredItems.slice(startIdx, endIdx);
            
            // Update pagination info
            document.getElementById('expiringTableStart').textContent = totalItems > 0 ? startIdx + 1 : 0;
            document.getElementById('expiringTableEnd').textContent = endIdx;
            document.getElementById('expiringTableTotal').textContent = totalItems;
            document.getElementById('expiringTableCurrentPage').textContent = state.currentPage;
            document.getElementById('expiringTableTotalPages').textContent = totalPages || 1;
            
            // Update pagination buttons
            const prevBtn = document.getElementById('expiringTablePrevBtn');
            const nextBtn = document.getElementById('expiringTableNextBtn');
            if (prevBtn) prevBtn.disabled = state.currentPage === 1;
            if (nextBtn) nextBtn.disabled = state.currentPage >= totalPages;
            
            // Update Clear All Filters button visibility and count
            const clearAllBtn = document.getElementById('btnClearAllExpiringFilters');
            const activeFiltersCount = Object.values(state.columnFilters).filter(f => f && f.length > 0).length;
            const hasSorting = state.sortColumn !== '';
            const hasActiveFilters = activeFiltersCount > 0 || hasSorting;
            
            if (clearAllBtn) {
                if (hasActiveFilters) {
                    clearAllBtn.style.display = 'flex';
                    const badge = activeFiltersCount > 0 ? ` (${activeFiltersCount})` : '';
                    clearAllBtn.innerHTML = `
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        Clear Filters${badge}
                    `;
                } else {
                    clearAllBtn.style.display = 'none';
                }
            }
            
            // Helper function to create header cell with filter and sort
            function createHeaderCell(label, columnKey, columnIndex, totalColumns) {
                const hasFilter = state.columnFilters[columnKey] && state.columnFilters[columnKey].length > 0;
                const isSorted = state.sortColumn === columnKey;
                const isFilterOpen = state.openFilterColumn === columnKey;
                
                // Smart positioning: last 3 columns align right, others align left
                const alignRight = columnIndex >= totalColumns - 3;
                
                // Get unique values for this column from items before column filters
                const uniqueValues = new Set();
                itemsBeforeFilters.forEach(item => {
                    if (item[columnKey] !== undefined && item[columnKey] !== null) {
                        uniqueValues.add(item[columnKey]);
                    }
                });
                const sortedValues = Array.from(uniqueValues).sort((a, b) => {
                    if (typeof a === 'string') return a.localeCompare(b);
                    return a - b;
                });
                
                // For TFA column, format display values
                const displayValues = sortedValues.map(val => {
                    if (columnKey === 'tfa') {
                        return { raw: val, display: formatCurrency(val) };
                    }
                    return { raw: val, display: val };
                });
                
                // Generate unique ID for search input
                const searchId = `filterSearch_${columnKey}`;
                
                return `
                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">
                        <div class="flex items-center justify-center gap-2">
                            <span>${label}</span>
                            <div class="flex items-center gap-1">
                                <!-- Filter Icon -->
                                <div class="relative expiring-filter-dropdown">
                                    <button onclick="toggleExpiringFilterDropdown('${columnKey}', event)" 
                                        class="p-1 hover:bg-gray-100 rounded relative">
                                        <svg class="h-4 w-4 ${hasFilter ? 'text-blue-500' : 'text-gray-400'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                                        </svg>
                                        ${hasFilter ? '<span class="absolute -top-1 -right-1 h-2 w-2 rounded-full bg-blue-500"></span>' : ''}
                                    </button>
                                    ${isFilterOpen ? `
                                        <div class="absolute top-full ${alignRight ? 'right-0' : 'left-0'} z-[9999] w-72 mt-2 rounded-2xl border border-gray-200 bg-white p-4 shadow-2xl">
                                            <p class="text-sm font-semibold text-gray-800 mb-3">Filter by ${label}</p>
                                            <div class="mb-3">
                                                <input type="text" 
                                                    id="${searchId}"
                                                    oninput="filterExpiringDropdownValues('${columnKey}')"
                                                    placeholder="Search values..." 
                                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none" />
                                            </div>
                                            <div id="filterValues_${columnKey}" class="space-y-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-2 bg-gray-50">
                                                ${displayValues.map(valObj => {
                                                    const valStr = String(valObj.display).toLowerCase();
                                                    return `
                                                    <label class="flex items-center gap-2 py-1.5 hover:bg-white rounded-lg px-2 cursor-pointer transition-colors filter-value-item" data-value="${valStr}">
                                                        <input type="checkbox" 
                                                            ${state.columnFilters[columnKey] && state.columnFilters[columnKey].includes(valObj.raw) ? 'checked' : ''}
                                                            onchange="toggleExpiringColumnFilter('${columnKey}', ${typeof valObj.raw === 'string' ? `'${String(valObj.raw).replace(/'/g, "\\'")}'` : valObj.raw})"
                                                            class="rounded border-gray-300 text-blue-500 focus:ring-blue-500" />
                                                        <span class="text-sm text-gray-700">${valObj.display}</span>
                                                    </label>
                                                `}).join('')}
                                            </div>
                                            <button onclick="clearExpiringColumnFilter('${columnKey}')" 
                                                class="w-full mt-3 px-3 py-2 text-sm font-medium text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50">
                                                Clear Filter
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                                <!-- Sort Icon -->
                                <button onclick="sortExpiringTable('${columnKey}')" class="flex flex-col gap-0.5 p-1">
                                    <svg class="${isSorted && state.sortDirection === 'asc' ? 'fill-blue-500' : 'fill-gray-300'}" width="8" height="5" viewBox="0 0 8 5">
                                        <path d="M4.40962 0.585167C4.21057 0.300808 3.78943 0.300807 3.59038 0.585166L1.05071 4.21327C0.81874 4.54466 1.05582 5 1.46033 5H6.53967C6.94418 5 7.18126 4.54466 6.94929 4.21327L4.40962 0.585167Z"/>
                                    </svg>
                                    <svg class="${isSorted && state.sortDirection === 'desc' ? 'fill-blue-500' : 'fill-gray-300'}" width="8" height="5" viewBox="0 0 8 5">
                                        <path d="M4.40962 4.41483C4.21057 4.69919 3.78943 4.69919 3.59038 4.41483L1.05071 0.786732C0.81874 0.455343 1.05582 0 1.46033 0H6.53967C6.94418 0 7.18126 0.455342 6.94929 0.786731L4.40962 4.41483Z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </th>
                `;
            }
            
            // Render table headers based on view and category
            let headers = '';
            const totalCols = viewFilter === 'cas' ? 7 : 8;
            const agingLabel = categoryFilter === 'expiring' ? 'Coming Due' : 'Past Due';
            
            if (viewFilter === 'cas') {
                if (categoryFilter === 'expiring') {
                    headers = createHeaderCell('Relationship', 'relationship', 0, totalCols) +
                              createHeaderCell('Region', 'region', 1, totalCols) +
                              createHeaderCell('Underwriter', 'underwriter', 2, totalCols) +
                              createHeaderCell('Product Program', 'product', 3, totalCols) +
                              createHeaderCell('CA Expiry Date', 'expiryDate', 4, totalCols) +
                              createHeaderCell(agingLabel, 'agingCategory', 5, totalCols) +
                              createHeaderCell('TFA', 'tfa', 6, totalCols);
                } else {
                    headers = createHeaderCell('Relationship', 'relationship', 0, totalCols) +
                              createHeaderCell('Region', 'region', 1, totalCols) +
                              createHeaderCell('Underwriter', 'underwriter', 2, totalCols) +
                              createHeaderCell('Product Program', 'product', 3, totalCols) +
                              createHeaderCell('Expired Date', 'expiryDate', 4, totalCols) +
                              createHeaderCell(agingLabel, 'agingCategory', 5, totalCols) +
                              createHeaderCell('TFA', 'tfa', 6, totalCols);
                }
            } else {
                if (categoryFilter === 'expiring') {
                    headers = createHeaderCell('Relationship', 'relationship', 0, totalCols) +
                              createHeaderCell('Region', 'region', 1, totalCols) +
                              createHeaderCell('Underwriter', 'underwriter', 2, totalCols) +
                              createHeaderCell('Product Program', 'product', 3, totalCols) +
                              createHeaderCell('Facility Number', 'facilityId', 4, totalCols) +
                              createHeaderCell('Maturity Date', 'maturityDate', 5, totalCols) +
                              createHeaderCell(agingLabel, 'agingCategory', 6, totalCols) +
                              createHeaderCell('TFA', 'tfa', 7, totalCols);
                } else {
                    headers = createHeaderCell('Relationship', 'relationship', 0, totalCols) +
                              createHeaderCell('Region', 'region', 1, totalCols) +
                              createHeaderCell('Underwriter', 'underwriter', 2, totalCols) +
                              createHeaderCell('Product Program', 'product', 3, totalCols) +
                              createHeaderCell('Facility Number', 'facilityId', 4, totalCols) +
                              createHeaderCell('Matured Date', 'maturityDate', 5, totalCols) +
                              createHeaderCell(agingLabel, 'agingCategory', 6, totalCols) +
                              createHeaderCell('TFA', 'tfa', 7, totalCols);
                }
            }
            thead.innerHTML = headers;
            
            // Render table rows
            if (displayItems.length === 0) {
                const colspan = viewFilter === 'cas' ? '7' : '8';
                tbody.innerHTML = `<tr><td colspan="${colspan}" class="px-6 py-8 text-center text-sm text-gray-500">No ${categoryFilter} ${viewFilter === 'cas' ? 'CAs' : 'facilities'} found</td></tr>`;
                return;
            }
            
            let html = '';
            const regionColors = {
                'APAC': 'bg-blue-50 text-blue-600',
                'EMEA': 'bg-green-50 text-green-600',
                'NAM': 'bg-orange-50 text-orange-600',
                'LATAM': 'bg-purple-50 text-purple-600'
            };
            
            displayItems.forEach(item => {
                const regionColor = regionColors[item.region] || 'bg-gray-50 text-gray-600';
                
                // Determine badge color based on aging category
                let agingBadgeClass = '';
                const agingCat = item.agingCategory;
                
                if (agingCat === '0-30 Days') {
                    agingBadgeClass = 'bg-blue-50 text-blue-700 border border-blue-200';
                } else if (agingCat === '31-60 Days') {
                    agingBadgeClass = 'bg-orange-50 text-orange-700 border border-orange-200';
                } else if (agingCat === '61-90 Days') {
                    agingBadgeClass = 'bg-red-50 text-red-700 border border-red-200';
                } else if (agingCat === '> 90 Days') {
                    agingBadgeClass = 'bg-red-100 text-red-900 border border-red-300';
                }
                
                if (viewFilter === 'cas') {
                    const dateLabel = categoryFilter === 'expiring' ? item.expiryDate : item.expiryDate;
                    
                    html += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 text-center text-sm font-medium text-gray-900">${item.relationship}</td>
                            <td class="px-6 py-4 text-center">
                                <span class="${regionColor} rounded-full px-2 py-0.5 text-xs font-medium">
                                    ${item.region}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-center text-sm text-gray-700">${item.underwriter}</td>
                            <td class="px-6 py-4 text-center text-sm text-gray-700">${item.product}</td>
                            <td class="px-6 py-4 text-center text-sm text-gray-700">${dateLabel}</td>
                            <td class="px-6 py-4 text-center">
                                <span class="${agingBadgeClass} rounded-full px-2 py-0.5 text-xs font-semibold min-w-[60px] inline-block">
                                    ${item.agingCategory}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-center text-sm font-semibold text-gray-900">${formatCurrency(item.tfa)}</td>
                        </tr>
                    `;
                } else {
                    const dateLabel = categoryFilter === 'expiring' ? item.maturityDate : item.maturityDate;
                    
                    html += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 text-center text-sm font-medium text-gray-900">${item.relationship}</td>
                            <td class="px-6 py-4 text-center">
                                <span class="${regionColor} rounded-full px-2 py-0.5 text-xs font-medium">
                                    ${item.region}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-center text-sm text-gray-700">${item.underwriter}</td>
                            <td class="px-6 py-4 text-center text-sm text-gray-700">${item.product}</td>
                            <td class="px-6 py-4 text-center text-sm text-gray-700">${item.facilityId}</td>
                            <td class="px-6 py-4 text-center text-sm text-gray-700">${dateLabel}</td>
                            <td class="px-6 py-4 text-center">
                                <span class="${agingBadgeClass} rounded-full px-2 py-0.5 text-xs font-semibold min-w-[60px] inline-block">
                                    ${item.agingCategory}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-center text-sm font-semibold text-gray-900">${formatCurrency(item.tfa)}</td>
                        </tr>
                    `;
                }
            });
            
            tbody.innerHTML = html;
        }
        
        function generateNewDealsYTDExpandedView(dataSource) {
            // This function now only returns the HTML template
            // Data processing is done in initializeNewDealsYTDChart()
            const { monthStart, monthEnd, reportingMonth: repMonth } = getReportingMonthRange();
            const currentYear = repMonth.getFullYear();
            
            return `
                <!-- Title Section -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">New Deals Year-to-Date - ${currentYear}</h3>
                    <p class="text-sm text-gray-500 mt-1">Comprehensive analysis of deals originated from January through ${repMonth.toLocaleDateString("en-US", { month: "long" })}</p>
                </div>
                
                <!-- Summary KPIs with Variance -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6" id="newDealsYTDKPIs">
                    <!-- KPIs will be populated by renderNewDealsYTDExpandedViews -->
                </div>
                
                <!-- Year-over-Year Comparison -->
                <div class="rounded-xl border border-gray-200 bg-white p-6 mb-6" id="newDealsYTDYoYComparison">
                    <!-- YoY comparison will be populated by renderNewDealsYTDExpandedViews -->
                </div>
                
                <!-- Analysis Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Regional Distribution -->
                    <div class="rounded-xl border border-gray-200 bg-white flex flex-col">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">Regional Distribution</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">YTD deals by region</p>
                        </div>
                        <div class="flex-1 overflow-hidden">
                            <div id="newDealsYTDRegionalTable" class="h-full"></div>
                        </div>
                    </div>
                    
                    <!-- Monthly Trend -->
                    <div class="rounded-xl border border-gray-200 bg-white">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">Monthly Trend</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">Deal count by month</p>
                        </div>
                        <div class="p-6">
                            <div id="newDealsYTDMonthlyChart" style="min-height: 300px;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Product Programs - Split into 2 boxes -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Product Distribution by TFA - Donut Chart with Legends -->
                    <div class="rounded-xl border border-gray-200 bg-white">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">Product Distribution by TFA</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">Distribution of facility amounts</p>
                        </div>
                        <div class="p-6">
                            <div class="flex flex-row items-center justify-center gap-8">
                                <!-- Donut Chart -->
                                <div class="flex-shrink-0">
                                    <div id="newDealsYTDProductChart"></div>
                                </div>
                                
                                <!-- Legend / Details List - Right Side -->
                                <div class="flex-1 max-w-md">
                                    <div id="newDealsYTDProductList" class="space-y-3">
                                        <!-- Legend will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Credit Classification Distribution - Donut Chart with Legends -->
                    <div class="rounded-xl border border-gray-200 bg-white">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">Product Distribution by Deals Count</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">Number of deals by product program</p>
                        </div>
                        <div class="p-6">
                            <div class="flex flex-row items-center justify-center gap-8">
                                <!-- Donut Chart -->
                                <div class="flex-shrink-0">
                                    <div id="newDealsYTDProductCountChart"></div>
                                </div>
                                
                                <!-- Legend / Details List - Right Side -->
                                <div class="flex-1 max-w-md">
                                    <div id="newDealsYTDProductCountList" class="space-y-3">
                                        <!-- Legend will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Underwriter Breakdown -->
                <div class="rounded-2xl border border-gray-200 bg-white mb-6">
                    <div class="px-6 py-4">
                        <h3 class="text-lg font-semibold text-gray-800">New Deals by Underwriter (Top 10)</h3>
                        <p class="text-sm font-medium text-gray-500 mt-1">New deals by underwriters (top 10)</p>
                    </div>
                    <div class="custom-scrollbar overflow-x-auto">
                        <div id="newDealsYTDUnderwriterTable"></div>
                    </div>
                </div>
            `;
        }
        
        function generateNewDealsMTDExpandedView(dataSource) {
            // This function now only returns the HTML template
            // Data processing is done in initializeNewDealsMTDChart()
            const { monthStart, monthEnd, reportingMonth: repMonth } = getReportingMonthRange();
            const monthLabel = repMonth.toLocaleDateString("en-US", { month: "long", year: "numeric" });
            
            return `
                <!-- Title Section -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">New Deals Month-to-Date - ${monthLabel}</h3>
                    <p class="text-sm text-gray-500 mt-1">Comprehensive analysis of deals originated in current month</p>
                </div>
                
                <!-- Summary KPIs with Variance -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6" id="newDealsMTDKPIs">
                    <!-- KPIs will be populated by renderNewDealsMTDExpandedViews -->
                </div>
                
                <!-- Month-over-Month Comparison -->
                <div class="rounded-xl border border-gray-200 bg-white p-6 mb-6" id="newDealsMTDMoMComparison">
                    <!-- MoM comparison will be populated by renderNewDealsMTDExpandedViews -->
                </div>
                
                <!-- Analysis Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Regional Distribution -->
                    <div class="rounded-xl border border-gray-200 bg-white flex flex-col">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">Regional Distribution</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">MTD deals by region</p>
                        </div>
                        <div class="flex-1 overflow-hidden">
                            <div id="newDealsMTDRegionalTable" class="h-full"></div>
                        </div>
                    </div>
                    
                    <!-- Weekly Trend -->
                    <div class="rounded-xl border border-gray-200 bg-white">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">Weekly Trend</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">Deal count by week</p>
                        </div>
                        <div class="p-6">
                            <div id="newDealsMTDWeeklyChart" style="min-height: 300px;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Product Programs - Split into 2 boxes -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Product Distribution by TFA - Donut Chart with Legends -->
                    <div class="rounded-xl border border-gray-200 bg-white">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">Product Distribution by TFA</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">Distribution of facility amounts</p>
                        </div>
                        <div class="p-6">
                            <div class="flex flex-row items-center justify-center gap-8">
                                <!-- Donut Chart -->
                                <div class="flex-shrink-0">
                                    <div id="newDealsMTDProductChart"></div>
                                </div>
                                
                                <!-- Legend / Details List - Right Side -->
                                <div class="flex-1 max-w-md">
                                    <div id="newDealsMTDProductList" class="space-y-3">
                                        <!-- Legend will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Credit Classification Distribution - Donut Chart with Legends -->
                    <div class="rounded-xl border border-gray-200 bg-white">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">Product Distribution by Deals Count</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">Number of deals by product program</p>
                        </div>
                        <div class="p-6">
                            <div class="flex flex-row items-center justify-center gap-8">
                                <!-- Donut Chart -->
                                <div class="flex-shrink-0">
                                    <div id="newDealsMTDProductCountChart"></div>
                                </div>
                                
                                <!-- Legend / Details List - Right Side -->
                                <div class="flex-1 max-w-md">
                                    <div id="newDealsMTDProductCountList" class="space-y-3">
                                        <!-- Legend will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Underwriter Breakdown -->
                <div class="rounded-2xl border border-gray-200 bg-white mb-6">
                    <div class="px-6 py-4">
                        <h3 class="text-lg font-semibold text-gray-800">New Deals by Underwriter (Top 10)</h3>
                        <p class="text-sm font-medium text-gray-500 mt-1">New deals by underwriters (top 10)</p>
                    </div>
                    <div class="custom-scrollbar overflow-x-auto">
                        <div id="newDealsMTDUnderwriterTable"></div>
                    </div>
                </div>
            `;
        }
        function generatePipelineExpandedView(dataSource) {
            // Data processing is now done in initializePipelineChart
            // This function only returns the HTML structure
            
            return `
                <!-- Title Section -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">Deals Pending Closure</h3>
                    <p class="text-sm text-gray-500 mt-1">Approved deals awaiting origination (NAM & LATAM, excl. PSE)</p>
                </div>
                
                <!-- Summary KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-amber-100">
                                <svg class="h-5 w-5 shrink-0 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Total Pending</p>
                                <h3 class="text-2xl font-bold text-gray-900" id="pipelineTotalFacilities">--</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1" id="pipelineTotalTFA">--</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-blue-100">
                                <svg class="h-5 w-5 shrink-0 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">NAM Region</p>
                                <h3 class="text-2xl font-bold text-gray-900" id="pipelineNAMCount">--</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1" id="pipelineNAMTFA">--</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-purple-100">
                                <svg class="h-5 w-5 shrink-0 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">LATAM Region</p>
                                <h3 class="text-2xl font-bold text-gray-900" id="pipelineLATAMCount">--</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1" id="pipelineLATAMTFA">--</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-green-100">
                                <svg class="h-5 w-5 shrink-0 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Avg Deal Size</p>
                                <h3 class="text-2xl font-bold text-gray-900" id="pipelineAvgDealSize">--</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">Per facility</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Analysis Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Product Program Distribution by Count - Donut Chart with Legends -->
                    <div class="rounded-xl border border-gray-200 bg-white">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">Product Program Distribution</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">Deals by product program with count</p>
                        </div>
                        <div class="p-6 flex items-center justify-center" style="min-height: 400px;">
                            <div class="flex flex-row items-center justify-center gap-8">
                                <!-- Donut Chart -->
                                <div class="flex-shrink-0">
                                    <div id="pipelineRegionalChart"></div>
                                </div>
                                
                                <!-- Legend / Details List - Right Side -->
                                <div class="flex-1 max-w-md">
                                    <div id="pipelineRegionalList" class="space-y-3">
                                        <!-- Legend will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Product Program Distribution - Donut Chart with Legends -->
                    <div class="rounded-xl border border-gray-200 bg-white">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">Product Program Distribution</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">Distribution of facility amounts by product</p>
                        </div>
                        <div class="p-6 flex items-center justify-center" style="min-height: 400px;">
                            <div class="flex flex-row items-center justify-center gap-8">
                                <!-- Donut Chart -->
                                <div class="flex-shrink-0">
                                    <div id="pipelineProductTreemap"></div>
                                </div>
                                
                                <!-- Legend / Details List - Right Side -->
                                <div class="flex-1 max-w-md">
                                    <div id="pipelineProductList" class="space-y-3">
                                        <!-- Legend will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Deals Pending Closure Details Table with Filters and Pagination -->
                <div class="rounded-2xl border border-gray-200 bg-white" id="pipelineDetailsContainer">
                    <!-- Header with Filters -->
                    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Deals Pending Closure Details</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">All pending deals awaiting closure</p>
                    </div>
                        <div class="flex items-center gap-3">
                            <!-- Status Filter (DM/CM) -->
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-medium text-gray-500 tracking-wider">Status:</span>
                                <div class="inline-flex items-center gap-0.5 rounded-lg bg-gray-100 p-0.5">
                                    <button id="btnPipelineStatusAll" onclick="selectPipelineStatusFilter('all')" class="min-w-[45px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs shadow-sm text-gray-900 bg-white">
                                        All
                                    </button>
                                    <button id="btnPipelineStatusCM" onclick="selectPipelineStatusFilter('CM')" class="min-w-[45px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                                        CM
                                    </button>
                                    <button id="btnPipelineStatusDM" onclick="selectPipelineStatusFilter('DM')" class="min-w-[45px] px-3 py-1.5 font-medium transition-colors rounded-md text-xs text-gray-600 hover:text-gray-900">
                                        DM
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Search Input -->
                            <div class="relative">
                                <input 
                                    type="text" 
                                    id="pipelineTableSearch" 
                                    placeholder="Search..." 
                                    onkeyup="updatePipelineTableSearch(this.value)"
                                    class="w-48 px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                />
                                <svg class="absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            
                            <!-- Clear All Filters Button -->
                            <button 
                                id="btnClearAllPipelineFilters"
                                onclick="clearAllPipelineFilters()"
                                style="display: none;"
                                class="px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-1.5">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                Clear Filters
                            </button>
                            
                            <!-- Export Button -->
                            <button 
                                id="btnExportPipelineTable"
                                onclick="exportPipelineTableToCSV()"
                                class="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 border border-blue-600 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-1.5">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Export
                            </button>
                        </div>
                    </div>
                    
                    <!-- Table -->
                    <div class="custom-scrollbar overflow-x-auto" style="min-height: 500px;">
                        <table class="min-w-full">
                            <thead>
                                <tr class="bg-gray-50" id="pipelineDetailsTableHeader">
                                    <!-- Headers will be dynamically rendered -->
                                </tr>
                            </thead>
                            <tbody id="pipelineDetailsTableBody" class="divide-y divide-gray-200">
                                <tr><td colspan="9" class="px-6 py-8 text-center text-sm text-gray-500">Loading data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Footer with Pagination -->
                    <div class="flex items-center justify-between px-6 py-4 border-t border-gray-200 bg-gray-50" style="border-bottom-left-radius: 1rem; border-bottom-right-radius: 1rem;">
                        <div class="flex items-center gap-4">
                            <div class="text-sm text-gray-700" id="pipelineTableInfo">
                                Showing <span class="font-medium" id="pipelineTableStart">0</span> to <span class="font-medium" id="pipelineTableEnd">0</span> of <span class="font-medium" id="pipelineTableTotal">0</span> items
                            </div>
                            <select 
                                id="pipelineTablePerPage" 
                                onchange="updatePipelineTablePerPage(parseInt(this.value))"
                                class="text-sm border border-gray-300 rounded-lg px-2 py-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="10" selected>10 per page</option>
                                <option value="20">20 per page</option>
                                <option value="50">50 per page</option>
                                <option value="100">100 per page</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2">
                            <button 
                                id="pipelineTablePrevBtn"
                                onclick="changePipelineTablePage('prev')" 
                                disabled
                                class="px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                Previous
                            </button>
                            <div class="text-sm text-gray-700">
                                Page <span class="font-medium" id="pipelineTableCurrentPage">1</span> of <span class="font-medium" id="pipelineTableTotalPages">1</span>
                            </div>
                            <button 
                                id="pipelineTableNextBtn"
                                onclick="changePipelineTablePage('next')" 
                                disabled
                                class="px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                Next
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        function generateTopRelationshipsExpandedView(dataSource) {
            const excludedFacilityTypes = [
                "Uncommitted Advised Lines",
                "Credit Cards",
                "Overdraft Protection"
            ];
            
            // Age buckets
            const ageBuckets = [
                { label: '1-30 Days', min: 1, max: 30, count: 0, facilities: new Set(), tfa: 0 },
                { label: '31-60 Days', min: 31, max: 60, count: 0, facilities: new Set(), tfa: 0 },
                { label: '61-90 Days', min: 61, max: 90, count: 0, facilities: new Set(), tfa: 0 },
                { label: '>90 Days', min: 91, max: Infinity, count: 0, facilities: new Set(), tfa: 0 }
            ];
            
            // Collect detailed data
            const regionalData = { NAM: {count: 0, tfa: 0, facilities: new Set()}, LATAM: {count: 0, tfa: 0, facilities: new Set()} };
            const productData = {};
            const underwriterData = {};
            const facilityTypeData = {};
            const relationshipData = {};
            const allPendingFacilities = new Set();
            let totalTFA = 0;
            
            // Process data
            dataSource.forEach(row => {
                // Always exclude PSE
                const pseColumn = row["PSE_non-PSE"] || row.PSE_non_PSE || "";
                const pseValue = String(pseColumn).trim().toUpperCase();
                if (pseValue === "PSE") return;
                
                // Only include NAM and LATAM regions
                const region = String(row.Region || "").trim().toUpperCase();
                if (region !== "NAM" && region !== "LATAM") return;
                
                // Exclude specific facility types
                const facilityType = String(row.Facility_Type || "").trim();
                if (excludedFacilityTypes.includes(facilityType)) return;
                
                const originationDate = row.Origination_Date;
                const firstApprovalDate = parseDate(row.Facility_First_Approval_Date);
                const facilityId = row.Facility_ID;
                const tfaAmount = parseNumber(row.Fac_Amount || row.Facility_Amount);
                const product = row.Product_Program || "Unknown";
                const underwriter = row.Lead_Underwriter || "Unknown";
                const relationship = row.Relationship_Name || "Unknown";
                
                // Pending closure criteria
                if ((!originationDate || originationDate.trim() === '') &&
                    firstApprovalDate &&
                    facilityId &&
                    firstApprovalDate.getFullYear() === currentYear) {
                    
                    allPendingFacilities.add(facilityId);
                    totalTFA += tfaAmount;
                    
                    // Calculate days since approval
                    const daysSinceApproval = Math.floor((today - firstApprovalDate) / (1000 * 60 * 60 * 24));
                    
                    // Age buckets
                    for (const bucket of ageBuckets) {
                        if (daysSinceApproval >= bucket.min && daysSinceApproval <= bucket.max) {
                            bucket.facilities.add(facilityId);
                            bucket.tfa += tfaAmount;
                            break;
                        }
                    }
                    
                    // Regional data
                    if (!regionalData[region]) {
                        regionalData[region] = {count: 0, tfa: 0, facilities: new Set()};
                    }
                    regionalData[region].facilities.add(facilityId);
                    regionalData[region].tfa += tfaAmount;
                    
                    // Product data
                    if (!productData[product]) {
                        productData[product] = { count: 0, tfa: 0, facilities: new Set(), avgAge: 0, totalAge: 0 };
                    }
                    productData[product].facilities.add(facilityId);
                    productData[product].tfa += tfaAmount;
                    productData[product].totalAge += daysSinceApproval;
                    
                    // Underwriter data
                    if (!underwriterData[underwriter]) {
                        underwriterData[underwriter] = { facilities: new Set(), tfa: 0, region: region, avgAge: 0, totalAge: 0 };
                    }
                    underwriterData[underwriter].facilities.add(facilityId);
                    underwriterData[underwriter].tfa += tfaAmount;
                    underwriterData[underwriter].totalAge += daysSinceApproval;
                    
                    // Facility Type data
                    if (!facilityTypeData[facilityType]) {
                        facilityTypeData[facilityType] = { count: 0, tfa: 0, facilities: new Set() };
                    }
                    facilityTypeData[facilityType].facilities.add(facilityId);
                    facilityTypeData[facilityType].tfa += tfaAmount;
                    
                    // Relationship data
                    if (!relationshipData[relationship]) {
                        relationshipData[relationship] = { facilities: new Set(), tfa: 0, avgAge: 0, totalAge: 0 };
                    }
                    relationshipData[relationship].facilities.add(facilityId);
                    relationshipData[relationship].tfa += tfaAmount;
                    relationshipData[relationship].totalAge += daysSinceApproval;
                }
            });
            
            // Calculate counts and averages
            ageBuckets.forEach(bucket => {
                bucket.count = bucket.facilities.size;
            });
            
            Object.keys(regionalData).forEach(region => {
                regionalData[region].count = regionalData[region].facilities.size;
            });
            
            Object.keys(productData).forEach(product => {
                const data = productData[product];
                data.count = data.facilities.size;
                data.avgAge = data.count > 0 ? Math.round(data.totalAge / data.count) : 0;
            });
            
            Object.keys(underwriterData).forEach(underwriter => {
                const data = underwriterData[underwriter];
                data.avgAge = data.facilities.size > 0 ? Math.round(data.totalAge / data.facilities.size) : 0;
            });
            
            Object.keys(facilityTypeData).forEach(type => {
                facilityTypeData[type].count = facilityTypeData[type].facilities.size;
            });
            
            Object.keys(relationshipData).forEach(rel => {
                const data = relationshipData[rel];
                data.avgAge = data.facilities.size > 0 ? Math.round(data.totalAge / data.facilities.size) : 0;
            });
            
            // Convert to arrays and sort
            const topProducts = Object.entries(productData)
                .map(([name, data]) => ({name, count: data.count, tfa: data.tfa, avgAge: data.avgAge}))
                .sort((a, b) => b.tfa - a.tfa)
                .slice(0, 10);
            
            const topUnderwriters = Object.entries(underwriterData)
                .map(([name, data]) => ({name, facilities: data.facilities.size, tfa: data.tfa, region: data.region, avgAge: data.avgAge}))
                .sort((a, b) => b.tfa - a.tfa)
                .slice(0, 10);
            
            const topRelationships = Object.entries(relationshipData)
                .map(([name, data]) => ({name, facilities: data.facilities.size, tfa: data.tfa, avgAge: data.avgAge}))
                .sort((a, b) => b.tfa - a.tfa)
                .slice(0, 10);
            
            const facilityTypes = Object.entries(facilityTypeData)
                .map(([name, data]) => ({name, count: data.count, tfa: data.tfa}))
                .sort((a, b) => b.tfa - a.tfa);
            
            // Calculate aging metrics
            const over90Days = ageBuckets[3].count;
            const over90DaysTFA = ageBuckets[3].tfa;
            const avgDealSize = allPendingFacilities.size > 0 ? totalTFA / allPendingFacilities.size : 0;
            
            return `
                <!-- Title Section -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">Deals Pending Closure - ${currentYear}</h3>
                    <p class="text-sm text-gray-500 mt-1">Approved deals awaiting origination (NAM & LATAM, excl. PSE)</p>
                </div>
                
                <!-- Summary KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-amber-100">
                                <svg class="h-5 w-5 shrink-0 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Total Pending</p>
                                <h3 class="text-2xl font-bold text-gray-900">${allPendingFacilities.size}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">${formatCurrency(totalTFA)}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-red-100">
                                <svg class="h-5 w-5 shrink-0 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Over 90 Days</p>
                                <h3 class="text-2xl font-bold text-gray-900">${over90Days}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">${formatCurrency(over90DaysTFA)}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-blue-100">
                                <svg class="h-5 w-5 shrink-0 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Avg Deal Size</p>
                                <h3 class="text-2xl font-bold text-gray-900">${formatCurrency(avgDealSize)}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">Per facility</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-purple-100">
                                <svg class="h-5 w-5 shrink-0 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Relationships</p>
                                <h3 class="text-2xl font-bold text-gray-900">${Object.keys(relationshipData).length}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">Unique clients</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Aging Analysis Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Age Distribution Chart -->
                    <div class="rounded-xl border border-gray-200 bg-white">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">Aging Distribution</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">Days since first approval</p>
                        </div>
                        <div class="p-6">
                            <div id="pipelineAgingChart" style="min-height: 300px;"></div>
                        </div>
                    </div>
                    
                    <!-- Regional Distribution -->
                    <div class="rounded-xl border border-gray-200 bg-white">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">Regional Distribution</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">NAM & LATAM breakdown</p>
                        </div>
                        <div class="p-6">
                            <div id="pipelineRegionalTable"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Facility Type Distribution -->
                <div class="rounded-xl border border-gray-200 bg-white mb-6">
                    <div class="border-b border-gray-200 px-6 py-4">
                        <h3 class="text-base font-semibold text-gray-900">Facility Type Distribution</h3>
                        <p class="text-sm font-medium text-gray-500 mt-1">Breakdown by facility type</p>
                    </div>
                    <div class="p-6">
                        <div id="pipelineFacilityTypeChart" style="min-height: 300px;"></div>
                    </div>
                </div>
                
                <!-- Product Programs -->
                <div class="rounded-xl border border-gray-200 bg-white mb-6">
                    <div class="border-b border-gray-200 px-6 py-4">
                        <h3 class="text-base font-semibold text-gray-900">Top Product Programs</h3>
                        <p class="text-sm font-medium text-gray-500 mt-1">By TFA with average aging</p>
                    </div>
                    <div class="p-6">
                        <div id="pipelineProductTable"></div>
                    </div>
                </div>
                
                <!-- Underwriter Breakdown -->
                <div class="rounded-xl border border-gray-200 bg-white mb-6">
                    <div class="border-b border-gray-200 px-6 py-4">
                        <h3 class="text-base font-semibold text-gray-900">Deals by Underwriter</h3>
                        <p class="text-sm font-medium text-gray-500 mt-1">Lead underwriters with pending deals</p>
                    </div>
                    <div class="p-6">
                        <div id="pipelineUnderwriterTable"></div>
                    </div>
                </div>
                
                <!-- Top Relationships -->
                <div class="rounded-xl border border-gray-200 bg-white mb-6">
                    <div class="border-b border-gray-200 px-6 py-4">
                        <h3 class="text-base font-semibold text-gray-900">Top Relationships</h3>
                        <p class="text-sm font-medium text-gray-500 mt-1">Clients with most pending deals</p>
                    </div>
                    <div class="p-6">
                        <div id="pipelineRelationshipTable"></div>
                    </div>
                </div>
                
                <script>
                    // Store data for rendering
                    window.pipelineExpandedData = {
                        aging: ${JSON.stringify(ageBuckets.map(b => ({label: b.label, count: b.count, tfa: b.tfa})))},
                        regional: ${JSON.stringify(regionalData)},
                        products: ${JSON.stringify(topProducts)},
                        underwriters: ${JSON.stringify(topUnderwriters)},
                        relationships: ${JSON.stringify(topRelationships)},
                        facilityTypes: ${JSON.stringify(facilityTypes)}
                    };
                    
                    // Render views after a short delay
                    setTimeout(() => {
                        renderPipelineExpandedViews();
                    }, 100);
                <\/script>
            `;
        }
        function generateNewFacilitiesExpandedView(dataSource) {
            // This function now only returns the HTML template
            // Data processing is done in initializeNewFacilitiesChart()
            
            // Get the selected period and calculate the period label
            const period = selectedPeriod || 'current';
            let periodLabel = '';
            let periodDescription = '';
            
            // Find the most recent Report_Date to determine the period
            let mostRecentReportDate = null;
            for (let i = 0; i < dataSource.length; i++) {
                const reportDate = parseDate(dataSource[i].Report_Date);
                if (reportDate && (!mostRecentReportDate || reportDate > mostRecentReportDate)) {
                    mostRecentReportDate = reportDate;
                }
            }
            
            if (mostRecentReportDate) {
                if (period === "current") {
                    // Current month: use the most recent report date's month
                    periodLabel = mostRecentReportDate.toLocaleDateString("en-US", { month: "long", year: "numeric" });
                    periodDescription = `Facilities approved in ${periodLabel}`;
                } else {
                    // Previous month: one month before the report date
                    const prevMonth = new Date(mostRecentReportDate.getFullYear(), mostRecentReportDate.getMonth() - 1, 1);
                    periodLabel = prevMonth.toLocaleDateString("en-US", { month: "long", year: "numeric" });
                    periodDescription = `Facilities approved in ${periodLabel}`;
                }
            } else {
                periodLabel = period === 'current' ? 'Current Period' : 'Previous Period';
                periodDescription = `Analysis of newly approved facilities for the selected period`;
            }
            
            return `
                <!-- Title Section -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">New Facilities Approved (${period === 'current' ? 'Current' : 'Previous'} Period)</h3>
                    <p class="text-sm text-gray-500 mt-1">${periodDescription}</p>
                </div>
                
                <!-- Summary KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6" id="newFacilitiesKPIs">
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-blue-100">
                                <svg class="h-5 w-5 shrink-0 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Total New Facilities</p>
                                <h3 class="text-2xl font-bold text-gray-900" id="newFacilitiesCount">0</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1" id="newFacilitiesTotalTFA">$0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-purple-100">
                                <svg class="h-5 w-5 shrink-0 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Regions Active</p>
                                <h3 class="text-2xl font-bold text-gray-900" id="newFacilitiesRegions">0</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">Geographic coverage</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-green-100">
                                <svg class="h-5 w-5 shrink-0 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Underwriters Involved</p>
                                <h3 class="text-2xl font-bold text-gray-900" id="newFacilitiesUnderwriters">0</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">Lead underwriters</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Analysis Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Regional Distribution -->
                    <div class="rounded-xl border border-gray-200 bg-white flex flex-col">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">Regional Distribution</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">New facilities by region</p>
                        </div>
                        <div class="flex-1 overflow-hidden">
                            <div id="newFacilitiesRegionalTable" class="h-full"></div>
                        </div>
                    </div>
                    
                    <!-- Approval Timeline Chart -->
                    <div class="rounded-xl border border-gray-200 bg-white">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">Top 10 Underwriters by Deal Count</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">Lead underwriters with most deals approved</p>
                        </div>
                        <div class="p-6">
                            <div id="newFacilitiesSizeChart" style="min-height: 300px;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Top 10 Facilities -->
                <div class="rounded-2xl border border-gray-200 bg-white mb-6">
                    <div class="px-6 py-4">
                        <h3 class="text-lg font-semibold text-gray-800">Top 10 Facilities by TFA Approved</h3>
                        <p class="text-sm font-medium text-gray-500 mt-1">Facilities with highest TFA approved in the period</p>
                    </div>
                    <div class="custom-scrollbar overflow-x-auto">
                        <div id="newFacilitiesUnderwriterTable"></div>
                    </div>
                </div>
            `;
        }
        
        function generateTopRelationshipsExpandedView(dataSource) {
            // Get Top N filter value
            const topN = parseInt(document.getElementById("topNFilter").value) || 10;
            
            // Collect relationship data
            const relationshipData = new Map();
            const productByRelationship = new Map();
            const facilityTypeByRelationship = new Map();
            const underwriterByRelationship = new Map();
            
            dataSource.forEach(row => {
                const relId = row.Relationship_Name || row.Relationship_ID;
                const region = (row.Region || "Unknown").toUpperCase();
                const product = row.Product_Program || "Unknown";
                const facilityType = row.Facility_Type || "Unknown";
                const underwriter = row.Lead_Underwriter || "Unknown";
                
                if (!relId) return;
                
                // Relationship totals
                if (!relationshipData.has(relId)) {
                    relationshipData.set(relId, {
                        name: relId,
                        region: region,
                        tfa: 0,
                        direct: 0,
                        contingent: 0,
                        pse: 0,
                        totalOS: 0,
                        osuc: 0,
                        unused: 0,
                        facilities: new Set(),
                        rotce: []
                    });
                }
                
                const data = relationshipData.get(relId);
                data.tfa += parseNumber(row.Fac_Amount || row.Facility_Amount);
                data.direct += parseNumber(row.Direct_OS);
                data.contingent += parseNumber(row.Contingent_OS);
                data.pse += parseNumber(row.PSE_OS);
                data.totalOS += parseNumber(row.Total_OS);
                data.osuc += parseNumber(row.OSUC);
                data.unused += parseNumber(row.Unused_Committed);
                if (row.Facility_ID) data.facilities.add(row.Facility_ID);
                
                // ROTCE values
                const rotce = parsePercentage(row.ROTCE);
                if (!isNaN(rotce)) {
                    data.rotce.push(rotce);
                }
                
                // Product breakdown by relationship
                if (!productByRelationship.has(relId)) {
                    productByRelationship.set(relId, {});
                }
                const prodMap = productByRelationship.get(relId);
                if (!prodMap[product]) {
                    prodMap[product] = { tfa: 0, count: 0 };
                }
                prodMap[product].tfa += parseNumber(row.Fac_Amount || row.Facility_Amount);
                prodMap[product].count++;
                
                // Facility type breakdown
                if (!facilityTypeByRelationship.has(relId)) {
                    facilityTypeByRelationship.set(relId, {});
                }
                const typeMap = facilityTypeByRelationship.get(relId);
                if (!typeMap[facilityType]) {
                    typeMap[facilityType] = { tfa: 0, count: 0 };
                }
                typeMap[facilityType].tfa += parseNumber(row.Fac_Amount || row.Facility_Amount);
                typeMap[facilityType].count++;
                
                // Underwriter
                if (!underwriterByRelationship.has(relId)) {
                    underwriterByRelationship.set(relId, underwriter);
                }
            });
            
            // Calculate averages and prepare data
            relationshipData.forEach((data, relId) => {
                data.facilityCount = data.facilities.size;
                data.avgROTCE = data.rotce.length > 0 
                    ? data.rotce.reduce((sum, val) => sum + val, 0) / data.rotce.length 
                    : 0;
                data.avgDealSize = data.facilityCount > 0 ? data.tfa / data.facilityCount : 0;
            });
            
            // Sort by Direct OS (default) and get top N
            const topRelationships = Array.from(relationshipData.values())
                .sort((a, b) => b.direct - a.direct)
                .slice(0, topN);
            
            // Calculate regional distribution
            const regionalData = { 
                APAC: {count: 0, tfa: 0, direct: 0}, 
                EMEA: {count: 0, tfa: 0, direct: 0}, 
                NAM: {count: 0, tfa: 0, direct: 0},
                LATAM: {count: 0, tfa: 0, direct: 0}
            };
            topRelationships.forEach(rel => {
                const region = rel.region;
                if (!regionalData[region]) {
                    regionalData[region] = {count: 0, tfa: 0, direct: 0};
                }
                regionalData[region].count++;
                regionalData[region].tfa += rel.tfa;
                regionalData[region].direct += rel.direct;
            });
            
            // Get exposure type breakdown for top relationships
            const exposureBreakdown = topRelationships.map(rel => ({
                name: rel.name,
                direct: rel.direct,
                contingent: rel.contingent,
                pse: rel.pse,
                totalOS: rel.totalOS
            })).slice(0, 10); // Top 10 for chart
            
            return `
                <!-- Title Section -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">Top ${topN} Relationships by Direct OS</h3>
                    <p class="text-sm text-gray-500 mt-1">Comprehensive analysis of largest client relationships</p>
                </div>
                
                <!-- Summary KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-blue-100">
                                <svg class="h-5 w-5 shrink-0 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Total Relationships</p>
                                <h3 class="text-2xl font-bold text-gray-900">${topRelationships.length}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">Top ${topN} clients</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-green-100">
                                <svg class="h-5 w-5 shrink-0 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500" id="topRelExposureLabel">Total Direct OS</p>
                                <h3 class="text-xl font-bold text-gray-900" id="topRelTotalExposure">${formatCurrency(topRelationships.reduce((sum, r) => sum + r.direct, 0))}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">Combined exposure</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-purple-100">
                                <svg class="h-5 w-5 shrink-0 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Total Facilities</p>
                                <h3 class="text-2xl font-bold text-gray-900">${topRelationships.reduce((sum, r) => sum + r.facilityCount, 0)}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">Across top ${topN}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-amber-100">
                                <svg class="h-5 w-5 shrink-0 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Avg ROTCE</p>
                                <h3 class="text-2xl font-bold text-gray-900">${(topRelationships.reduce((sum, r) => sum + r.avgROTCE, 0) / topRelationships.length).toFixed(1)}%</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">Portfolio average</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Analysis Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Regional Distribution -->
                    <div class="rounded-xl border border-gray-200 bg-white flex flex-col">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">Regional Distribution</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">Top relationships by region</p>
                        </div>
                        <div class="flex-1 overflow-hidden">
                            <div id="topRelationshipsRegionalTable" class="h-full"></div>
                        </div>
                    </div>
                    
                    <!-- Product Level Breakdown -->
                    <div class="rounded-xl border border-gray-200 bg-white">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">Product Level Breakdown</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">Products by selected exposure across top relationships</p>
                        </div>
                        <div class="p-6">
                            <div class="flex flex-row items-center justify-center gap-8">
                                <!-- Donut Chart -->
                                <div class="flex-shrink-0">
                                    <div id="topRelationshipsProductChart"></div>
                                </div>
                                
                                <!-- Legend / Details List - Right Side -->
                                <div class="flex-1 max-w-md">
                                    <div id="topRelationshipsProductList" class="space-y-3">
                                        <!-- Legend will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Relationship Details Table -->
                <div class="rounded-2xl border border-gray-200 bg-white" id="topRelationshipsTable">
                    <div class="px-6 py-4">
                        <h3 class="text-lg font-semibold text-gray-800">Top Relationships Details (Top 10)</h3>
                        <p class="text-sm font-medium text-gray-500 mt-1">Comprehensive metrics for largest client relationships</p>
                    </div>
                    <div class="custom-scrollbar overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Relationship</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Region</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Facilities</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500" id="topRelTableExposureHeader">Direct OS</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Total OS</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">OSUC</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Avg ROTCE</th>
                                </tr>
                            </thead>
                            <tbody id="topRelationshipsTableBody" class="divide-y divide-gray-200">
                                <tr><td colspan="7" class="px-6 py-8 text-center text-sm text-gray-500">Loading data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function generateROTCEExpandedView(dataSource) {
            // Data processing is now done in initializeROTCEChart
            // This function only returns the HTML structure
            
            return `
                <!-- Title Section -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">ROTCE Performance - Top N Relationships</h3>
                    <p class="text-sm text-gray-500 mt-1">Return on Tangible Common Equity analysis for largest clients</p>
                </div>
                
                <!-- Summary KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-blue-100">
                                <svg class="h-5 w-5 shrink-0 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Portfolio Avg ROTCE</p>
                                <h3 class="text-2xl font-bold text-gray-900" id="rotcePortfolioAvg">--</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">Target: 12%+</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-green-100">
                                <svg class="h-5 w-5 shrink-0 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Above Target (12%)</p>
                                <h3 class="text-2xl font-bold text-gray-900" id="rotceAboveTarget">--</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1" id="rotceAboveTargetPct">--</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-amber-100">
                                <svg class="h-5 w-5 shrink-0 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Acceptable (8-12%)</p>
                                <h3 class="text-2xl font-bold text-gray-900" id="rotceAcceptable">--</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1" id="rotceAcceptablePct">--</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-red-100">
                                <svg class="h-5 w-5 shrink-0 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Below Target (<8%)</p>
                                <h3 class="text-2xl font-bold text-gray-900" id="rotceBelowTarget">--</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1" id="rotceBelowTargetPct">--</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Analysis Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Regional Distribution -->
                    <div class="rounded-2xl border border-gray-200 bg-white flex flex-col">
                        <div class="px-6 py-4">
                            <h3 class="text-lg font-semibold text-gray-800">Regional Distribution</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">Breakdown by region for ROTCE performance</p>
                        </div>
                        <div class="flex-1 overflow-hidden">
                            <div id="rotceRegionalTable" class="h-full"></div>
                        </div>
                    </div>
                    
                    <!-- Below Target ROTCE Chart -->
                    <div class="rounded-xl border border-gray-200 bg-white">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">Below Target ROTCE (Top 10)</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">Relationships with ROTCE below 8% target</p>
                        </div>
                        <div class="p-6">
                            <div id="rotceBelowTargetChart" style="min-height: 300px;"></div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function generateCovenantExpandedView(dataSource) {
            console.log(' generateCovenantExpandedView called with dataSource:', dataSource ? dataSource.length : 0, 'records');
            
            // Use filtered data from dataSource to respect user filters
            const covenantDataSource = dataSource && dataSource.length > 0 ? dataSource : (window.covenantsData || []);
            console.log(' Covenant data source length:', covenantDataSource.length);
            
            if (!covenantDataSource || covenantDataSource.length === 0) {
                console.warn(' No covenant data available');
                return `<div class="flex items-center justify-center h-full min-h-[400px]">
                    <div class="text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No covenant data available</h3>
                        <p class="mt-1 text-sm text-gray-500">There are no covenants matching your current filters.</p>
                    </div>
                </div>`;
            }
            
            // Get current view type (pastDue or comingDue) from global state
            const viewType = window.currentCovenantViewType || 'pastDue';
            const isPastDue = viewType === 'pastDue';
            const title = isPastDue ? 'Past Due Covenants' : 'Coming Due Covenants (Next 30 Days)';
            
            console.log(' Current view type:', viewType, '(isPastDue:', isPastDue, ', Coming Due = next 30 days only)');
            
            // Filter by view type (Coming Due = next 30 days only)
            const filteredCovenants = covenantDataSource.filter(row => {
                const status = String(row.Coming_Due_Past_Due || "").trim().toLowerCase();
                const matches = isPastDue ? status === 'past due' : (status === 'coming due' && isWithinNext30Days(row.Covenant_Due_Date));
                return matches;
            });
            
            console.log(' Filtered covenants by view type:', filteredCovenants.length, 'records (Coming Due = next 30 days only)');
            
            // Calculate KPIs
            const totalCovenants = filteredCovenants.length;
            const uniqueRelationships = new Set(filteredCovenants.map(r => r.Relationship_Name || r.Relationship_ID).filter(Boolean)).size;
            const uniqueFacilities = new Set(filteredCovenants.map(r => r.Facility_Number || r.Facility_ID).filter(Boolean)).size;
            
            // Calculate avg days past due for past due covenants
            let avgDaysPastDue = 0;
            if (isPastDue) {
                const totalDays = filteredCovenants.reduce((sum, row) => sum + (parseFloat(row.Days_Past_Due) || 0), 0);
                avgDaysPastDue = totalCovenants > 0 ? Math.round(totalDays / totalCovenants) : 0;
            }
            
            // Group by product program with regional and aging breakdown
            const byProduct = {};
            filteredCovenants.forEach(row => {
                const product = row.Product_Program || row.Product_Program_Name || 'Unknown';
                const region = String(row.Region || "Unknown").trim().toUpperCase();
                const pastDueCategory = String(row.Past_Due_Category || "").trim();
                
                if (!byProduct[product]) {
                    byProduct[product] = {
                        count: 0,
                        regionalBreakdown: { NAM: 0, LATAM: 0, EMEA: 0, APAC: 0 },
                        agingBreakdown: { '1-45': 0, '46-60': 0, '61-90': 0, '>90': 0, 'comingDue': 0 }
                    };
                }
                byProduct[product].count++;
                
                // Regional breakdown
                if (byProduct[product].regionalBreakdown[region] !== undefined) {
                    byProduct[product].regionalBreakdown[region]++;
                }
                
                // Aging breakdown
                if (isPastDue) {
                    if (pastDueCategory === '0-30 Days' || pastDueCategory === '31-45 Days') {
                        byProduct[product].agingBreakdown['1-45']++;
                    } else if (pastDueCategory === '46-60 Days' || pastDueCategory === '61-90 Days') {
                        byProduct[product].agingBreakdown['46-60']++;
                    } else if (pastDueCategory === '>90 Days') {
                        byProduct[product].agingBreakdown['>90']++;
                    }
                } else if (isWithinNext30Days(row.Covenant_Due_Date)) {
                    byProduct[product].agingBreakdown['comingDue']++;
                }
            });
            const sortedProducts = Object.entries(byProduct).sort((a, b) => b[1].count - a[1].count);
            
            // Group by category (for past due)
            const byCategory = {};
            if (isPastDue) {
                filteredCovenants.forEach(row => {
                    const cat = row.Past_Due_Category || 'Unknown';
                    byCategory[cat] = (byCategory[cat] || 0) + 1;
                });
            }
            
            // Group by underwriter for detailed table
            const byUnderwriter = {};
            filteredCovenants.forEach(row => {
                const underwriter = row.Lead_Underwriter || 'Unknown';
                const region = row.Region || 'Unknown';
                
                if (!byUnderwriter[underwriter]) {
                    byUnderwriter[underwriter] = {
                        underwriter,
                        region,
                        total: 0,
                        days_1_45: 0,
                        days_46_60: 0,
                        days_61_90: 0,
                        days_90_plus: 0,
                        coming_due: 0
                    };
                }
                byUnderwriter[underwriter].total++;
                
                if (isPastDue) {
                    const category = row.Past_Due_Category || '';
                    if (category.includes('1-45')) byUnderwriter[underwriter].days_1_45++;
                    else if (category.includes('46-60')) byUnderwriter[underwriter].days_46_60++;
                    else if (category.includes('61-90')) byUnderwriter[underwriter].days_61_90++;
                    else if (category.includes('>90')) byUnderwriter[underwriter].days_90_plus++;
                } else {
                    byUnderwriter[underwriter].coming_due++;
                }
            });
            
            const topUnderwriters = Object.values(byUnderwriter)
                .sort((a, b) => b.total - a.total)
                .slice(0, 10);
            
            // Calculate variance metrics vs last week
            const lastWeekData = window.covenantsDataLW || [];
            const lastWeekFiltered = lastWeekData.filter(row => {
                const status = String(row.Coming_Due_Past_Due || "").trim().toLowerCase();
                const matches = isPastDue ? status === 'past due' : (status === 'coming due' && isWithinNext30Days(row.Covenant_Due_Date));
                return matches;
            });
            
            const lastWeekTotal = lastWeekFiltered.length;
            const variance = totalCovenants - lastWeekTotal;
            const variancePercent = lastWeekTotal > 0 ? ((variance / lastWeekTotal) * 100).toFixed(1) : 0;
            
            // Regional data for table - match dashboard structure exactly
            const regions = ['APAC', 'EMEA', 'NAM', 'LATAM'];
            const regionalAgingData = {};
            const regionPopulation = {}; // Total covenants per region (no status filter)
            
            regions.forEach(region => {
                regionalAgingData[region] = {
                    '1-30': 0,
                    '31-45': 0,
                    '46-60': 0,
                    '61-90': 0,
                    '>90': 0,
                    'comingDue': 0
                };
                regionPopulation[region] = 0;
            });
            
            // FIRST PASS: Count total covenants per region (Population - no status filter)
            covenantDataSource.forEach(row => {
                const region = String(row.Region || "").trim().toUpperCase();
                if (!regions.includes(region)) return;
                regionPopulation[region]++;
            });
            
            // SECOND PASS: Count by aging buckets for filtered covenants
            filteredCovenants.forEach(row => {
                const status = String(row.Coming_Due_Past_Due || "").trim().toLowerCase();
                const region = String(row.Region || "").trim().toUpperCase();
                const pastDueCategory = String(row.Past_Due_Category || "").trim();
                
                if (!regions.includes(region)) return;
                
                if (status === 'past due') {
                    if (pastDueCategory === '>90 Days') {
                        regionalAgingData[region]['>90']++;
                    } else if (pastDueCategory === '61-90 Days') {
                        regionalAgingData[region]['61-90']++;
                    } else if (pastDueCategory === '46-60 Days') {
                        regionalAgingData[region]['46-60']++;
                    } else if (pastDueCategory === '31-45 Days') {
                        regionalAgingData[region]['31-45']++;
                    } else if (pastDueCategory === '0-30 Days') {
                        regionalAgingData[region]['1-30']++;
                    }
                }
                
                if (status === 'coming due' && isWithinNext30Days(row.Covenant_Due_Date)) {
                    regionalAgingData[region]['comingDue']++;
                }
            });
            
            // Variance by region (for potential future use)
            const varianceByRegion = {};
            ['APAC', 'EMEA', 'NAM', 'LATAM'].forEach(region => {
                const thisWeek = filteredCovenants.filter(r => r.Region === region).length;
                const lastWeek = lastWeekFiltered.filter(r => r.Region === region).length;
                varianceByRegion[region] = {
                    thisWeek,
                    lastWeek,
                    variance: thisWeek - lastWeek,
                    variancePercent: lastWeek > 0 ? (((thisWeek - lastWeek) / lastWeek) * 100).toFixed(1) : 0
                };
            });
            
            // Variance by product program
            const varianceByProduct = {};
            sortedProducts.forEach(([product]) => {
                const thisWeek = filteredCovenants.filter(r => (r.Product_Program || r.Product_Program_Name) === product).length;
                const lastWeek = lastWeekFiltered.filter(r => (r.Product_Program || r.Product_Program_Name) === product).length;
                varianceByProduct[product] = {
                    thisWeek,
                    lastWeek,
                    variance: thisWeek - lastWeek
                };
            });
            
            // Group by Covenant Description Type (extract from Covenant_Description)
            const byCovenantDescType = {};
            filteredCovenants.forEach(row => {
                const desc = row.Covenant_Description || '';
                let type = 'Other';
                if (desc.includes('Debt Service Coverage')) type = 'Debt Service Coverage';
                else if (desc.includes('Leverage Ratio')) type = 'Leverage Ratio';
                else if (desc.includes('Current Ratio')) type = 'Current Ratio';
                else if (desc.includes('Interest Coverage')) type = 'Interest Coverage';
                else if (desc.includes('Tangible Net Worth')) type = 'Tangible Net Worth';
                
                byCovenantDescType[type] = (byCovenantDescType[type] || 0) + 1;
            });
            
            // Group by Relationship for detailed table
            const detailedTableData = {};
            let debugAgingCounts = { '1-45': 0, '46-60': 0, '61-90': 0, '>90': 0 };
            
            filteredCovenants.forEach(row => {
                const relationshipID = row.Relationship_ID || 'Unknown';
                const relationshipName = row.Relationship_Name || row.Borrowers_Name || 'Unknown';
                const underwriter = row.Lead_Underwriter || 'Unknown';
                const region = row.Region || 'Unknown';
                const key = `${relationshipID}|${relationshipName}|${underwriter}|${region}`;
                
                if (!detailedTableData[key]) {
                    detailedTableData[key] = {
                        relationshipID,
                        relationshipName,
                        underwriter,
                        region,
                        days_1_45: 0,
                        days_46_60: 0,
                        days_61_90: 0,
                        days_90_plus: 0,
                        coming_due: 0,
                        // For Coming Due view
                        nextDueDate: null,
                        frequency: null
                    };
                }
                
                const status = String(row.Coming_Due_Past_Due || "").trim().toLowerCase();
                if (status === 'past due') {
                    const category = String(row.Past_Due_Category || '').trim();
                    // Use exact category matching (not includes)
                    if (category === '0-30 Days' || category === '31-45 Days') {
                        detailedTableData[key].days_1_45++;
                        debugAgingCounts['1-45']++;
                    }
                    else if (category === '46-60 Days' || category === '61-90 Days') {
                        detailedTableData[key].days_46_60++;
                        debugAgingCounts['46-60']++;
                    }
                    else if (category === '>90 Days') {
                        detailedTableData[key].days_90_plus++;
                        debugAgingCounts['>90']++;
                        console.log(' Found >90 Days covenant:', { relationshipName, underwriter, category });
                    }
                } else if (status === 'coming due' && isWithinNext30Days(row.Covenant_Due_Date)) {
                    detailedTableData[key].coming_due++;
                    // Store the earliest due date and most common frequency
                    if (!detailedTableData[key].nextDueDate || (row.Covenant_Due_Date && row.Covenant_Due_Date < detailedTableData[key].nextDueDate)) {
                        detailedTableData[key].nextDueDate = row.Covenant_Due_Date;
                    }
                    if (!detailedTableData[key].frequency) {
                        detailedTableData[key].frequency = row.Periodic_Frequency;
                    }
                }
            });
            
            console.log(' Covenant Aging Bucket Counts:', debugAgingCounts);
            
            // Multi-level sorting: 90+ (desc), 61-90 (desc), 46-60 (desc), 1-45 (desc)
            const detailedTableRows = Object.values(detailedTableData)
                .sort((a, b) => {
                    // Level 1: 90+ Days (largest to smallest)
                    if (b.days_90_plus !== a.days_90_plus) return b.days_90_plus - a.days_90_plus;
                    // Level 2: 61-90 Days (largest to smallest)
                    if (b.days_61_90 !== a.days_61_90) return b.days_61_90 - a.days_61_90;
                    // Level 3: 46-60 Days (largest to smallest)
                    if (b.days_46_60 !== a.days_46_60) return b.days_46_60 - a.days_46_60;
                    // Level 4: 1-45 Days (largest to smallest)
                    return b.days_1_45 - a.days_1_45;
                });
            
            console.log(' Top 5 rows after sorting (by >90 Days):', 
                detailedTableRows.slice(0, 5).map(r => ({
                    relationship: r.relationshipName,
                    underwriter: r.underwriter,
                    '90+': r.days_90_plus,
                    '61-90': r.days_61_90,
                    '46-60': r.days_46_60,
                    '1-45': r.days_1_45
                }))
            );
            
            return `
                <!-- Title Section -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">${title}</h3>
                    <p class="text-sm text-gray-500 mt-1">Monitor covenant ${isPastDue ? 'breaches' : 'compliance requirements'} across your portfolio</p>
                </div>
                
                <!-- Key Metrics Grid with Icons -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                    <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-blue-100">
                                <svg class="h-5 w-5 shrink-0 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                            </div>
                        <div>
                                <p class="text-sm font-medium text-gray-500">Total Covenants</p>
                                <h3 class="text-2xl font-bold text-gray-900">${totalCovenants}</h3>
                        </div>
                    </div>
                </div>
                
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-purple-100">
                                <svg class="h-5 w-5 shrink-0 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Unique Relationships</p>
                                <h3 class="text-2xl font-bold text-gray-900">${uniqueRelationships}</h3>
                            </div>
                        </div>
                </div>
                
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-green-100">
                                <svg class="h-5 w-5 shrink-0 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Unique Facilities</p>
                                <h3 class="text-2xl font-bold text-gray-900">${uniqueFacilities}</h3>
                            </div>
                        </div>
                    </div>
                    
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-${isPastDue ? 'red' : 'orange'}-100">
                                <svg class="h-5 w-5 shrink-0 text-${isPastDue ? 'red' : 'orange'}-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">${isPastDue ? 'Avg Days Past Due' : 'Avg per Relationship'}</p>
                                <h3 class="text-2xl font-bold text-gray-900">${isPastDue ? avgDaysPastDue + ' days' : (uniqueRelationships > 0 ? (totalCovenants / uniqueRelationships).toFixed(1) : '0')}</h3>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Analysis Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Regional Distribution Table - Matching Dashboard Structure -->
                    <div class="rounded-xl border border-gray-200 bg-white flex flex-col">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">${isPastDue ? 'Past Due Covenants by Region' : 'Coming Due Covenants by Region (Next 30 Days)'}</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">${isPastDue ? 'Regional breakdown of past due covenants' : 'Regional breakdown of covenants due in the next 30 days'}</p>
                        </div>
                        <div class="flex-1 overflow-hidden">
                            <div class="h-full max-w-full overflow-x-auto">
                                <table class="w-full h-full table-auto">
                                    <thead>
                                        <tr class="bg-gray-50 text-left">
                                            ${isPastDue ? `
                                                <th class="px-3 py-3 text-xs font-semibold text-gray-700 tracking-wider whitespace-nowrap">Region</th>
                                                <th class="px-2 py-3 text-xs font-semibold text-gray-700 tracking-wider text-center"><span class="whitespace-nowrap">1-45</span><br><span class="whitespace-nowrap">Days</span></th>
                                                <th class="px-2 py-3 text-xs font-semibold text-gray-700 tracking-wider text-center"><span class="whitespace-nowrap">46-90</span><br><span class="whitespace-nowrap">Days</span></th>
                                                <th class="px-2 py-3 text-xs font-semibold text-gray-700 tracking-wider text-center"><span class="whitespace-nowrap">&gt;90</span><br><span class="whitespace-nowrap">Days</span></th>
                                                <th class="px-2 py-3 text-xs font-semibold text-gray-700 tracking-wider text-center"><span class="whitespace-nowrap">Total</span><br><span class="whitespace-nowrap">Past Dues</span></th>
                                                <th class="px-2 py-3 text-xs font-semibold text-gray-700 tracking-wider text-center"><span class="whitespace-nowrap">Total</span><br><span class="whitespace-nowrap">Covenants</span></th>
                                                <th class="px-2 py-3 text-xs font-semibold text-gray-700 tracking-wider text-center"><span class="whitespace-nowrap">% of</span><br><span class="whitespace-nowrap">Total</span></th>
                                            ` : `
                                                <th class="px-3 py-3 text-xs font-semibold text-gray-700 tracking-wider whitespace-nowrap">Region</th>
                                                <th class="px-2 py-3 text-xs font-semibold text-gray-700 tracking-wider text-center"><span class="whitespace-nowrap">Coming</span><br><span class="whitespace-nowrap">Due</span></th>
                                                <th class="px-2 py-3 text-xs font-semibold text-gray-700 tracking-wider text-center"><span class="whitespace-nowrap">Total</span><br><span class="whitespace-nowrap">Covenants</span></th>
                                                <th class="px-2 py-3 text-xs font-semibold text-gray-700 tracking-wider text-center"><span class="whitespace-nowrap">% of</span><br><span class="whitespace-nowrap">Total</span></th>
                                            `}
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-100">
                                        ${regions.map(region => {
                                            // Calculate combined columns (matching dashboard logic)
                                            const count145 = regionalAgingData[region]['1-30'] + regionalAgingData[region]['31-45'];
                                            const count4690 = regionalAgingData[region]['46-60'] + regionalAgingData[region]['61-90'];
                                            const countOver90 = regionalAgingData[region]['>90'];
                                            const countComingDue = regionalAgingData[region]['comingDue'];
                                            
                                            const regionPastDueTotal = count145 + count4690 + countOver90;
                                            const regPopulation = regionPopulation[region];
                                            
                                            if (isPastDue) {
                                                // % of Total = Past Due Total / Region's Total Covenants
                                                const percentOfTotal = regPopulation > 0 ? ((regionPastDueTotal / regPopulation) * 100).toFixed(1) : '0.0';
                                                
                                                return `
                                                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                                                        <td class="px-3 py-3 text-xs font-medium text-gray-700">${region}</td>
                                                        <td class="px-2 py-3 text-xs text-gray-700 text-center font-semibold">${count145}</td>
                                                        <td class="px-2 py-3 text-xs text-gray-700 text-center font-semibold">${count4690}</td>
                                                        <td class="px-2 py-3 text-xs text-gray-700 text-center font-semibold">${countOver90}</td>
                                                        <td class="px-2 py-3 text-xs text-gray-900 text-center font-bold">${regionPastDueTotal}</td>
                                                        <td class="px-2 py-3 text-xs text-gray-900 text-center font-bold">${regPopulation}</td>
                                                        <td class="px-2 py-3 text-xs text-gray-900 text-center font-semibold">${percentOfTotal}%</td>
                                                    </tr>
                                                `;
                                            } else {
                                                // For Coming Due: % of Total = Coming Due for region / Total Coming Due across all regions
                                                const totalComingDueAcrossRegions = regions.reduce((sum, r) => sum + regionalAgingData[r]['comingDue'], 0);
                                                const percentOfTotal = totalComingDueAcrossRegions > 0 ? ((countComingDue / totalComingDueAcrossRegions) * 100).toFixed(1) : '0.0';
                                                
                                                return `
                                                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                                                        <td class="px-3 py-3 text-xs font-medium text-gray-700">${region}</td>
                                                        <td class="px-2 py-3 text-xs text-gray-900 text-center font-bold">${countComingDue}</td>
                                                        <td class="px-2 py-3 text-xs text-gray-900 text-center font-bold">${regPopulation}</td>
                                                        <td class="px-2 py-3 text-xs text-gray-900 text-center font-semibold">${percentOfTotal}%</td>
                                                    </tr>
                                                `;
                                            }
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Product Program Distribution - Donut Chart -->
                    <div class="rounded-xl border border-gray-200 bg-white">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">Covenants by Product Program</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">Distribution across product programs</p>
                        </div>
                        <div class="p-6 flex items-center justify-center" style="min-height: 400px;">
                            <div class="flex flex-row items-center justify-center gap-8 w-full">
                                <!-- Donut Chart -->
                                <div class="flex-shrink-0">
                                    <div id="covenantProductDonutChart"></div>
                                </div>
                                
                                <!-- Legend / Details List - Right Side -->
                                <div class="flex-1 max-w-md">
                                    <div id="covenantProductList" class="space-y-3">
                                        ${sortedProducts.map(([program, data], index) => {
                                            const colors = ["#3641f5", "#7592ff", "#dde9ff", "#ff6b6b", "#ffd93d", "#6bcf7f", "#c084fc"];
                                            const color = colors[index % colors.length];
                                            const count = data.count;
                                            const percentage = ((count / totalCovenants) * 100).toFixed(1);
                                            return `
                                                <div class="flex items-center gap-3 py-2">
                                                    <div class="w-4 h-4 rounded-sm flex-shrink-0" style="background-color: ${color};"></div>
                                                    <p class="text-sm font-medium text-gray-800 flex-1">${program}</p>
                                                    <p class="text-sm font-semibold text-gray-900">${count} <span class="text-gray-500 font-normal"> ${percentage}%</span></p>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Detailed Grouped Table -->
                <div class="rounded-2xl border border-gray-200 bg-white">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800">Covenant Details by Relationship & Underwriter</h3>
                        <p class="text-sm font-medium text-gray-500 mt-1">Comprehensive breakdown ${isPastDue ? 'with aging buckets' : 'of covenants coming due'}</p>
                    </div>
                    <div class="custom-scrollbar overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-6 py-4 text-left text-sm font-medium whitespace-nowrap text-gray-500">Relationship ID</th>
                                    <th class="px-6 py-4 text-left text-sm font-medium whitespace-nowrap text-gray-500">Relationship Name</th>
                                    <th class="px-6 py-4 text-left text-sm font-medium whitespace-nowrap text-gray-500">Underwriter</th>
                                    <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Region</th>
                                    ${isPastDue ? `
                                        <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">1-45 Days</th>
                                        <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">46-60 Days</th>
                                        <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">61-90 Days</th>
                                        <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">90+ Days</th>
                                    ` : `
                                        <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Due Date</th>
                                        <th class="px-6 py-4 text-center text-sm font-medium whitespace-nowrap text-gray-500">Frequency</th>
                                    `}
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${detailedTableRows.length > 0 ? detailedTableRows.map(row => {
                                    const regionColors = {
                                        'APAC': 'bg-blue-50 text-blue-600',
                                        'EMEA': 'bg-green-50 text-green-600',
                                        'NAM': 'bg-orange-50 text-orange-600',
                                        'LATAM': 'bg-purple-50 text-purple-600'
                                    };
                                    const regionColor = regionColors[row.region] || 'bg-gray-50 text-gray-600';
                                    
                                    return `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-6 py-4 text-left text-sm text-gray-600">${row.relationshipID}</td>
                                            <td class="px-6 py-4 text-left text-sm font-medium text-gray-900">${row.relationshipName}</td>
                                            <td class="px-6 py-4 text-left text-sm text-gray-700">${row.underwriter}</td>
                                            <td class="px-6 py-4 text-center">
                                                <span class="${regionColor} rounded-full px-2 py-0.5 text-xs font-medium">
                                                    ${row.region}
                                                </span>
                                            </td>
                                            ${isPastDue ? `
                                                <td class="px-6 py-4 text-center">
                                                    <span class="bg-green-100 text-green-700 rounded-full px-2 py-0.5 text-xs font-medium">
                                                        ${row.days_1_45}
                                                    </span>
                                                </td>
                                                <td class="px-6 py-4 text-center">
                                                    <span class="bg-yellow-100 text-yellow-700 rounded-full px-2 py-0.5 text-xs font-medium">
                                                        ${row.days_46_60}
                                                    </span>
                                                </td>
                                                <td class="px-6 py-4 text-center">
                                                    <span class="bg-orange-100 text-orange-700 rounded-full px-2 py-0.5 text-xs font-medium">
                                                        ${row.days_61_90}
                                                    </span>
                                                </td>
                                                <td class="px-6 py-4 text-center">
                                                    <span class="bg-red-100 text-red-700 rounded-full px-2 py-0.5 text-xs font-medium">
                                                        ${row.days_90_plus}
                                                    </span>
                                                </td>
                                            ` : `
                                                <td class="px-6 py-4 text-center text-sm text-gray-700">${row.nextDueDate || 'N/A'}</td>
                                                <td class="px-6 py-4 text-center text-sm text-gray-700">${row.frequency || 'N/A'}</td>
                                            `}
                                        </tr>
                                    `;
                                }).join('') : `
                                    <tr>
                                        <td colspan="${isPastDue ? '8' : '6'}" class="px-6 py-8 text-center text-sm text-gray-500">
                                            <div class="flex flex-col items-center gap-2">
                                                <svg class="h-12 w-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                                                </svg>
                                                <p>No data available</p>
                                            </div>
                                        </td>
                                    </tr>
                                `}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <script>
                    setTimeout(() => {
                        console.log(' Rendering covenant charts...');
                        const productData = ${JSON.stringify(sortedProducts)};
                        const varianceByRegion = ${JSON.stringify(varianceByRegion)};
                        const isPastDue = ${isPastDue};
                        
                        // Chart 1: Product Program Donut (Matching TFA style exactly)
                        const donutEl = document.getElementById('covenantProductDonutChart');
                        if (donutEl && productData.length > 0) {
                            const colors = ["#3641f5", "#7592ff", "#dde9ff", "#ff6b6b", "#ffd93d", "#6bcf7f", "#c084fc"];
                            const isPastDueView = ${isPastDue};
                            const totalCovenantsForChart = productData.reduce((sum, p) => sum + p[1].count, 0);
                            const donutOptions = {
                                series: productData.map(p => p[1].count),
                                labels: productData.map(p => p[0]),
                                colors: colors.slice(0, productData.length),
                                chart: {
                                    fontFamily: "Outfit, sans-serif",
                                    type: "donut",
                                    width: 300,
                                    height: 300,
                                },
                                stroke: {
                                    show: false,
                                },
                                plotOptions: {
                                    pie: {
                                        donut: {
                                            size: "65%",
                                            background: "transparent",
                                            labels: {
                                                show: true,
                                                name: {
                                                    show: true,
                                                    offsetY: -10,
                                                    color: "#1D2939",
                                                    fontSize: "14px",
                                                    fontWeight: "600",
                                                },
                                                value: {
                                                    show: true,
                                                    offsetY: 10,
                                                    color: "#667085",
                                                    fontSize: "16px",
                                                    fontWeight: "700",
                                                },
                                                total: {
                                                    show: true,
                                                    label: "Total",
                                                    color: "#111827",
                                                    fontSize: "16px",
                                                    fontWeight: "700",
                                                    formatter: function (w) {
                                                        return w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                                                    }
                                                },
                                            },
                                        },
                                    },
                                },
                                dataLabels: {
                                    enabled: false,
                                },
                                legend: {
                                    show: false, // Hide built-in legend, using custom HTML legend
                                },
                                tooltip: {
                                    enabled: true,
                                    theme: "light",
                                    followCursor: false,
                                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                                        const productName = productData[seriesIndex][0];
                                        const productInfo = productData[seriesIndex][1];
                                        const covenantCount = productInfo.count;
                                        const percentage = totalCovenantsForChart > 0 ? ((covenantCount / totalCovenantsForChart) * 100).toFixed(1) : 0;
                                        const regionalBreakdown = productInfo.regionalBreakdown || { NAM: 0, LATAM: 0, EMEA: 0, APAC: 0 };
                                        const agingBreakdown = productInfo.agingBreakdown || { '1-45': 0, '46-60': 0, '61-90': 0, '>90': 0, 'comingDue': 0 };
                                        
                                        // Build aging/coming due table rows
                                        let distributionRows = '';
                                        if (isPastDueView) {
                                            // Show aging distribution for past due
                                            const agingData = [
                                                { label: '1-45 Days', value: agingBreakdown['1-45'], color: '#10B981' },
                                                { label: '46-60 Days', value: agingBreakdown['46-60'], color: '#F59E0B' },
                                                { label: '61-90 Days', value: agingBreakdown['61-90'], color: '#EF4444' },
                                                { label: '>90 Days', value: agingBreakdown['>90'], color: '#DC2626' }
                                            ];
                                            agingData.forEach(item => {
                                                if (item.value > 0) {
                                                    distributionRows += \`
                                                        <tr>
                                                            <td style="padding: 6px 8px; text-align: left; font-size: 11px; color: #6B7280; font-weight: 500;">\${item.label}</td>
                                                            <td style="padding: 6px 8px; text-align: right; font-size: 11px; color: \${item.color}; font-weight: 600;">\${item.value}</td>
                                                        </tr>
                                                    \`;
                                                }
                                            });
                                        } else {
                                            // Show coming due (next 30 days)
                                            distributionRows = \`
                                                <tr>
                                                    <td style="padding: 6px 8px; text-align: left; font-size: 11px; color: #6B7280; font-weight: 500;">Next 30 Days</td>
                                                    <td style="padding: 6px 8px; text-align: right; font-size: 11px; color: #F59E0B; font-weight: 600;">\${agingBreakdown['comingDue']}</td>
                                                </tr>
                                            \`;
                                        }
                                        
                                        // Build regional table rows
                                        let regionalRows = '';
                                        ['NAM', 'LATAM', 'EMEA', 'APAC'].forEach(region => {
                                            const regionCount = regionalBreakdown[region] || 0;
                                            if (regionCount > 0) {
                                                regionalRows += \`
                                                    <tr>
                                                        <td style="padding: 6px 8px; text-align: left; font-size: 11px; color: #6B7280; font-weight: 500;">\${region}</td>
                                                        <td style="padding: 6px 8px; text-align: right; font-size: 11px; color: #111827; font-weight: 600;">\${regionCount}</td>
                                                    </tr>
                                                \`;
                                            }
                                        });
                                        
                                        return \`
                                            <div style="
                                                background: #ffffff; 
                                                border-radius: 12px; 
                                                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
                                                min-width: 320px;
                                                max-width: 360px;
                                                overflow: hidden;
                                                font-family: Outfit, sans-serif;
                                            ">
                                                <!-- Header with border -->
                                                <div style="
                                                    border-bottom: 1px solid #E5E7EB;
                                                    padding: 16px 16px 12px 16px;
                                                    margin-bottom: 14px;
                                                ">
                                                    <div style="
                                                        font-weight: 600; 
                                                        font-size: 15px; 
                                                        color: #111827;
                                                        margin-bottom: 4px;
                                                    ">\${productName}</div>
                                                    <div style="
                                                        font-size: 12px; 
                                                        font-weight: 500;
                                                        color: #6B7280;
                                                    ">Product Program</div>
                                                </div>
                                                
                                                <!-- Content wrapper -->
                                                <div style="padding: 0 16px 16px 16px;">
                                                    <!-- Widget Grid (2 columns) -->
                                                    <div style="
                                                        display: grid;
                                                        grid-template-columns: 1fr 1fr;
                                                        gap: 10px;
                                                        margin-bottom: 16px;
                                                    ">
                                                        <!-- Widget 1: Covenant Count -->
                                                        <div style="
                                                            background: #F9FAFB;
                                                            border-radius: 8px;
                                                            padding: 12px;
                                                            border: 1px solid #E5E7EB;
                                                        ">
                                                            <div style="
                                                                display: flex;
                                                                align-items: center;
                                                                gap: 6px;
                                                                font-size: 11px;
                                                                color: #6B7280;
                                                                font-weight: 500;
                                                                margin-bottom: 6px;
                                                            ">
                                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                                    <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                                </svg>
                                                                Covenants
                                                            </div>
                                                            <div style="
                                                                font-size: 20px;
                                                                font-weight: 700;
                                                                color: #111827;
                                                            ">\${covenantCount}</div>
                                                        </div>
                                                        
                                                        <!-- Widget 2: % of Total -->
                                                        <div style="
                                                            background: #F9FAFB;
                                                            border-radius: 8px;
                                                            padding: 12px;
                                                            border: 1px solid #E5E7EB;
                                                        ">
                                                            <div style="
                                                                display: flex;
                                                                align-items: center;
                                                                gap: 6px;
                                                                font-size: 11px;
                                                                color: #6B7280;
                                                                font-weight: 500;
                                                                margin-bottom: 6px;
                                                            ">
                                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                                    <circle cx="12" cy="12" r="10"></circle>
                                                                    <polyline points="12 6 12 12 16 14"></polyline>
                                                                </svg>
                                                                % of Total
                                                            </div>
                                                            <div style="
                                                                font-size: 20px;
                                                                font-weight: 700;
                                                                color: #111827;
                                                            ">\${percentage}%</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Aging/Coming Due Distribution Table -->
                                                    <div style="margin-bottom: 12px;">
                                                        <div style="
                                                            display: flex;
                                                            align-items: center;
                                                            gap: 6px;
                                                            margin-bottom: 8px;
                                                        ">
                                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2">
                                                                <circle cx="12" cy="12" r="10"></circle>
                                                                <polyline points="12 6 12 12 16 14"></polyline>
                                                            </svg>
                                                            <span style="
                                                                font-size: 12px;
                                                                font-weight: 600;
                                                                color: #374151;
                                                            ">\${isPastDueView ? 'Aging Distribution' : 'Coming Due Distribution'}</span>
                                                        </div>
                                                        <table style="width: 100%; border-collapse: collapse;">
                                                            <thead>
                                                                <tr style="border-bottom: 1px solid #E5E7EB;">
                                                                    <th style="padding: 6px 8px; text-align: left; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Period</th>
                                                                    <th style="padding: 6px 8px; text-align: right; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Count</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                \${distributionRows || '<tr><td colspan="2" style="padding: 8px; text-align: center; font-size: 11px; color: #9CA3AF;">No data</td></tr>'}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    
                                                    <!-- Regional Distribution Table -->
                                                    <div style="margin-top: 12px;">
                                                        <div style="
                                                            display: flex;
                                                            align-items: center;
                                                            gap: 6px;
                                                            margin-bottom: 8px;
                                                        ">
                                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2">
                                                                <circle cx="12" cy="12" r="10"></circle>
                                                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                                            </svg>
                                                            <span style="
                                                                font-size: 12px;
                                                                font-weight: 600;
                                                                color: #374151;
                                                            ">Regional Distribution</span>
                                                        </div>
                                                        <table style="width: 100%; border-collapse: collapse;">
                                                            <thead>
                                                                <tr style="border-bottom: 1px solid #E5E7EB;">
                                                                    <th style="padding: 6px 8px; text-align: left; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Region</th>
                                                                    <th style="padding: 6px 8px; text-align: right; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Count</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                \${regionalRows || '<tr><td colspan="2" style="padding: 8px; text-align: center; font-size: 11px; color: #9CA3AF;">No data</td></tr>'}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        \`;
                                    }
                                }
                            };
                            donutEl.innerHTML = '';
                            const productDonutChart = new ApexCharts(donutEl, donutOptions);
                            productDonutChart.render();
                            
                            // Add tooltip positioning fix
                            setTimeout(() => {
                                const tooltipObserver = new MutationObserver(() => {
                                    const tooltip = donutEl.querySelector('.apexcharts-tooltip.apexcharts-active');
                                    if (tooltip && !tooltip.hasAttribute('data-positioned')) {
                                        const tooltipRect = tooltip.getBoundingClientRect();
                                        const windowWidth = window.innerWidth;
                                        const windowHeight = window.innerHeight;
                                        const margin = 10;
                                        
                                        let needsReposition = false;
                                        
                                        if (tooltipRect.left < margin) {
                                            tooltip.style.left = margin + 'px';
                                            tooltip.style.transform = 'none';
                                            needsReposition = true;
                                        } else if (tooltipRect.right > windowWidth - margin) {
                                            tooltip.style.left = (windowWidth - tooltipRect.width - margin) + 'px';
                                            tooltip.style.transform = 'none';
                                            needsReposition = true;
                                        }
                                        
                                        if (tooltipRect.top < margin) {
                                            tooltip.style.top = margin + 'px';
                                            needsReposition = true;
                                        } else if (tooltipRect.bottom > windowHeight - margin) {
                                            tooltip.style.top = (windowHeight - tooltipRect.height - margin) + 'px';
                                            needsReposition = true;
                                        }
                                        
                                        if (needsReposition) {
                                            tooltip.setAttribute('data-positioned', 'true');
                                        }
                                    }
                                    
                                    const hiddenTooltip = donutEl.querySelector('.apexcharts-tooltip:not(.apexcharts-active)[data-positioned]');
                                    if (hiddenTooltip) {
                                        hiddenTooltip.removeAttribute('data-positioned');
                                    }
                                });
                                
                                tooltipObserver.observe(donutEl, {
                                    attributes: true,
                                    attributeFilter: ['class'],
                                    subtree: true
                                });
                            }, 200);
                        }
                        
                        // Week-over-Week Variance chart removed - replaced with Regional Distribution table
                    }, 100);
                <\/script>
            `;
        }
        
        function generateCovenantRegionalExpandedView(dataSource) {
            // Use the same view but emphasize it's the regional breakdown
            // The function already respects currentCovenantViewType
            return generateCovenantExpandedView(dataSource);
        }
        
        function generateCCMExpandedView(dataSource) {
            // CCM data comes from dataSource parameter (already filtered by populateExpandModalValues)
            const ccmDataSource = dataSource || window.ccmData || [];
            const ccmDataPreviousSource = window.ccmDataPrevious || [];
            
            if (ccmDataSource.length === 0) {
                return '<p class="text-gray-500 p-8 text-center">No CCM data available. Please ensure CCM_current.xlsx is loaded.</p>';
            }
            
            // Filter data by region, underwriter, and relationship (user filters are already applied in dataSource)
            const filteredCCMs = ccmDataSource.filter(row => {
                const region = String(row.Region || "").trim().toUpperCase();
                if (!['APAC', 'EMEA', 'NAM', 'LATAM'].includes(region)) return false;
                return true;
            });
            
            const filteredCCMsPrev = ccmDataPreviousSource.filter(row => {
                const region = String(row.Region || "").trim().toUpperCase();
                if (!['APAC', 'EMEA', 'NAM', 'LATAM'].includes(region)) return false;
                if (window.selectedRegion && window.selectedRegion !== 'all' && region !== window.selectedRegion.toUpperCase()) return false;
                return true;
            });
            
            // === DATA AGGREGATION ===
            
            // Regional data for stacked bar chart
            const regionalData = {};
            ['APAC', 'EMEA', 'NAM', 'LATAM'].forEach(region => {
                regionalData[region] = { pastDue: 0, comingDue: 0, open: 0, total: 0 };
            });
            
            // Classification data (for future use)
            const byClassification = new Map();
            
            // Frequency data (for future use)
            const byFrequency = new Map();
            
            // Underwriter data for treemap (Top 5)
            const byUnderwriter = new Map();
            
            // Underwriter data for detailed table
            const detailedTableData = new Map();
            
            // Status variance data (current vs previous month) with regional breakdown
            const statusVariance = {
                pastDue: { 
                    current: 0, 
                    previous: 0,
                    regionalBreakdown: { NAM: 0, LATAM: 0, EMEA: 0, APAC: 0 }
                },
                comingDue: { 
                    current: 0, 
                    previous: 0,
                    regionalBreakdown: { NAM: 0, LATAM: 0, EMEA: 0, APAC: 0 }
                },
                open: { 
                    current: 0, 
                    previous: 0,
                    regionalBreakdown: { NAM: 0, LATAM: 0, EMEA: 0, APAC: 0 }
                }
            };
            
            // KPI counters
            let totalCCMs = 0;
            let totalPastDue = 0;
            let totalComingDue = 0;
            let totalOpen = 0;
            const uniqueClients = new Set();
            
            filteredCCMs.forEach(row => {
                const region = String(row.Region || "").trim().toUpperCase();
                const ccmStatus = String(row.CCM_Status || "").trim().toLowerCase();
                const classification = row.Classification || "Unknown";
                const frequency = row.Frequency || "Unknown";
                const underwriter = row.Underwriter || "Unknown";
                const clientName = row.Client_Name || "Unknown";
                
                totalCCMs++;
                uniqueClients.add(row.Relationship_ID || clientName);
                
                // Regional aggregation
                if (regionalData[region]) {
                if (ccmStatus === 'past due') {
                    regionalData[region].pastDue++;
                    totalPastDue++;
                        statusVariance.pastDue.current++;
                        if (statusVariance.pastDue.regionalBreakdown[region] !== undefined) {
                            statusVariance.pastDue.regionalBreakdown[region]++;
                        }
                } else if (ccmStatus === 'coming due') {
                    regionalData[region].comingDue++;
                    totalComingDue++;
                        statusVariance.comingDue.current++;
                        if (statusVariance.comingDue.regionalBreakdown[region] !== undefined) {
                            statusVariance.comingDue.regionalBreakdown[region]++;
                        }
                } else if (ccmStatus === 'open') {
                    regionalData[region].open++;
                    totalOpen++;
                        statusVariance.open.current++;
                        if (statusVariance.open.regionalBreakdown[region] !== undefined) {
                            statusVariance.open.regionalBreakdown[region]++;
                        }
                    }
                    regionalData[region].total++;
                }
                
                // Classification aggregation (kept for future use)
                const classKey = classification;
                if (!byClassification.has(classKey)) {
                    byClassification.set(classKey, { name: classification, count: 0, pastDue: 0, comingDue: 0, open: 0 });
                }
                const classData = byClassification.get(classKey);
                classData.count++;
                if (ccmStatus === 'past due') classData.pastDue++;
                else if (ccmStatus === 'coming due') classData.comingDue++;
                else if (ccmStatus === 'open') classData.open++;
                
                // Frequency aggregation (kept for future use)
                const freqKey = frequency;
                if (!byFrequency.has(freqKey)) {
                    byFrequency.set(freqKey, { name: frequency, count: 0 });
                }
                byFrequency.get(freqKey).count++;
                
                // Underwriter aggregation for treemap
                if (!byUnderwriter.has(underwriter)) {
                    byUnderwriter.set(underwriter, {
                        name: underwriter,
                        pastDue: 0,
                        comingDue: 0,
                        open: 0,
                        total: 0
                    });
                }
                const uwData = byUnderwriter.get(underwriter);
                if (ccmStatus === 'past due') uwData.pastDue++;
                else if (ccmStatus === 'coming due') uwData.comingDue++;
                else if (ccmStatus === 'open') uwData.open++;
                uwData.total++;
                
                // Detailed table aggregation (by Underwriter & Region & Classification)
                const tableKey = `${underwriter}|${region}|${classification}`;
                if (!detailedTableData.has(tableKey)) {
                    detailedTableData.set(tableKey, {
                        underwriter,
                        region,
                        classification,
                        pastDue: 0,
                        comingDue: 0,
                        open: 0,
                        total: 0
                    });
                }
                const tableRow = detailedTableData.get(tableKey);
                if (ccmStatus === 'past due') tableRow.pastDue++;
                else if (ccmStatus === 'coming due') tableRow.comingDue++;
                else if (ccmStatus === 'open') tableRow.open++;
                tableRow.total++;
            });
            
            // Previous month data for variance
            let totalCCMsPrev = 0;
            filteredCCMsPrev.forEach(row => {
                const region = String(row.Region || "").trim().toUpperCase();
                const ccmStatus = String(row.CCM_Status || "").trim().toLowerCase();
                if (['APAC', 'EMEA', 'NAM', 'LATAM'].includes(region)) {
                    totalCCMsPrev++;
                    if (ccmStatus === 'past due') statusVariance.pastDue.previous++;
                    else if (ccmStatus === 'coming due') statusVariance.comingDue.previous++;
                    else if (ccmStatus === 'open') statusVariance.open.previous++;
                }
            });
            
            // Variance calculations
            const variance = totalCCMs - totalCCMsPrev;
            // If no previous data, show neutral (gray) regardless of current value
            const hasPreviousData = totalCCMsPrev > 0;
            const variancePercent = hasPreviousData ? ((variance / totalCCMsPrev) * 100).toFixed(1) : '0.0';
            const varianceColor = !hasPreviousData ? 'gray' : (variance > 0 ? 'red' : variance < 0 ? 'green' : 'gray');
            const varianceIcon = !hasPreviousData ? '' : (variance > 0 ? '' : variance < 0 ? '' : '');
            
            // Variance by region
            const varianceByRegion = {};
            ['APAC', 'EMEA', 'NAM', 'LATAM'].forEach(region => {
                const currentCount = regionalData[region].total;
                const prevCount = filteredCCMsPrev.filter(r => String(r.Region || "").trim().toUpperCase() === region).length;
                const regVariance = currentCount - prevCount;
                varianceByRegion[region] = {
                    current: currentCount,
                    previous: prevCount,
                    variance: regVariance,
                    variancePercent: prevCount > 0 ? ((regVariance / prevCount) * 100).toFixed(1) : '0.0'
                };
            });
            
            // Sort data
            const sortedClassifications = Array.from(byClassification.values()).sort((a, b) => b.count - a.count);
            const sortedFrequencies = Array.from(byFrequency.values()).sort((a, b) => b.count - a.count);
            const sortedUnderwriters = Array.from(byUnderwriter.values()).sort((a, b) => b.total - a.total).slice(0, 5); // Top 5
            const sortedTableData = Array.from(detailedTableData.values()).sort((a, b) => 
                b.total - a.total || a.underwriter.localeCompare(b.underwriter)
            );
            
            // Handle no data case
            if (totalCCMs === 0) {
                return '<p class="text-gray-500 p-8 text-center">No CCM data available for the selected filters.</p>';
            }
            
            // === HTML GENERATION ===
            return `
                <!-- Title Section -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">Credit Committee Memos & Reviews</h3>
                    <p class="text-sm text-gray-500 mt-1">Comprehensive analysis of CCM status, distribution, and trends</p>
                </div>
                
                <!-- KPI Cards (4 across) -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <!-- KPI 1: Total CCMs -->
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-blue-100">
                                <svg class="h-5 w-5 shrink-0 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Total CCMs</p>
                                <h3 class="text-2xl font-bold text-gray-900">${totalCCMs}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">Current month</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- KPI 2: Unique Clients -->
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-purple-100">
                                <svg class="h-5 w-5 shrink-0 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Unique Clients</p>
                                <h3 class="text-2xl font-bold text-gray-900">${uniqueClients.size}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">With active CCMs</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- KPI 3: Past Due CCMs -->
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-red-100">
                                <svg class="h-5 w-5 shrink-0 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Past Due CCMs</p>
                                <h3 class="text-2xl font-bold text-gray-900">${totalPastDue}</h3>
                                <p class="text-sm font-medium text-gray-500 mt-1">${(totalPastDue / totalCCMs * 100).toFixed(0)}% of total</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- KPI 4: Month-over-Month Variance -->
                    <div class="rounded-xl border border-gray-200 bg-white p-5">
                        <div class="flex items-start gap-3">
                            <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-${varianceColor === 'red' ? 'red' : varianceColor === 'green' ? 'green' : 'gray'}-100">
                                <svg class="h-5 w-5 shrink-0 text-${varianceColor === 'red' ? 'red' : varianceColor === 'green' ? 'green' : 'gray'}-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-500">vs Last Month</p>
                                <h3 class="text-2xl font-bold text-gray-900">${varianceIcon}${Math.abs(variance)}</h3>
                                <p class="text-sm font-medium text-${varianceColor === 'red' ? 'red' : varianceColor === 'green' ? 'green' : 'gray'}-600 mt-1">${variance > 0 ? '+' : ''}${variancePercent}%</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts Grid (1x2) -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Chart 1: Regional Distribution (Table) -->
                    <div class="rounded-xl border border-gray-200 bg-white flex flex-col" style="min-height: 400px;">
                        <div class="border-b border-gray-200 px-6 py-4 flex-shrink-0">
                            <h3 class="text-base font-semibold text-gray-900">Regional Distribution</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">Breakdown by region for CCM items</p>
                        </div>
                        <div class="flex-1 overflow-hidden">
                            <div id="ccmRegionalSummaryTable" class="h-full"></div>
                        </div>
                    </div>
                    
                    <!-- Chart 2: Status Variance (Grouped Bar - Current vs Previous Month) -->
                    <div class="rounded-xl border border-gray-200 bg-white">
                        <div class="border-b border-gray-200 px-6 py-4">
                            <h3 class="text-base font-semibold text-gray-900">Status Distribution Comparison</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">Current month vs previous month by status</p>
                        </div>
                        <div class="p-6 flex items-center justify-center" style="min-height: 400px;">
                            <div id="ccmStatusVarianceChart" class="w-full"></div>
                        </div>
                    </div>
                </div>
                
                <!-- CCM Details Table with Filters and Pagination -->
                <div class="rounded-2xl border border-gray-200 bg-white mb-6" id="ccmDetailsContainer">
                    <!-- Header with Filters -->
                    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">CCM Details</h3>
                            <p class="text-sm font-medium text-gray-500 mt-1">All CCM records with comprehensive details</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <!-- Status Filter Buttons -->
                            <div class="flex items-center gap-1 bg-gray-100 rounded-lg p-0.5">
                                <button 
                                    id="btnCCMPastDue"
                                    onclick="filterCCMTableByStatus('pastDue')"
                                    class="px-2 py-1 text-xs rounded-md transition-all duration-200 bg-white shadow-sm text-gray-900 font-medium">
                                    Past Due
                                </button>
                                <button 
                                    id="btnCCMComingDue"
                                    onclick="filterCCMTableByStatus('comingDue')"
                                    class="px-2 py-1 text-xs rounded-md transition-all duration-200 text-gray-600">
                                    Coming Due
                                </button>
                                <button 
                                    id="btnCCMOpen"
                                    onclick="filterCCMTableByStatus('open')"
                                    class="px-2 py-1 text-xs rounded-md transition-all duration-200 text-gray-600">
                                    Open
                                </button>
                            </div>
                            
                            <!-- Search Input -->
                            <div class="relative">
                                <input 
                                    type="text" 
                                    id="ccmTableSearch" 
                                    placeholder="Search..." 
                                    onkeyup="updateCCMTableSearch(this.value)"
                                    class="w-48 px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                />
                                <svg class="absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            
                            <!-- Clear All Filters Button -->
                            <button 
                                id="btnClearAllCCMFilters"
                                onclick="clearAllCCMFilters()"
                                style="display: none;"
                                class="px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-1.5">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                Clear Filters
                            </button>
                            
                            <!-- Export Button -->
                            <button 
                                id="btnExportCCMTable"
                                onclick="exportCCMTableToCSV()"
                                class="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 border border-blue-600 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-1.5">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Export
                            </button>
                        </div>
                    </div>
                    
                    <!-- Table -->
                    <div class="custom-scrollbar overflow-x-auto" style="min-height: 500px;">
                        <table class="min-w-full">
                            <thead>
                                <tr class="bg-gray-50" id="ccmDetailsTableHeader">
                                    <!-- Headers will be dynamically rendered -->
                                </tr>
                            </thead>
                            <tbody id="ccmDetailsTableBody" class="divide-y divide-gray-200">
                                <tr><td colspan="9" class="px-6 py-8 text-center text-sm text-gray-500">Loading data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Footer with Pagination -->
                    <div class="flex items-center justify-between px-6 py-4 border-t border-gray-200 bg-gray-50">
                        <div class="flex items-center gap-4">
                            <div class="text-sm text-gray-700" id="ccmTableInfo">
                                Showing <span class="font-medium" id="ccmTableStart">0</span> to <span class="font-medium" id="ccmTableEnd">0</span> of <span class="font-medium" id="ccmTableTotal">0</span> items
                            </div>
                            <select 
                                id="ccmTablePerPage" 
                                onchange="updateCCMTablePerPage(parseInt(this.value))"
                                class="text-sm border border-gray-300 rounded-lg px-2 py-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="10" selected>10 per page</option>
                                <option value="20">20 per page</option>
                                <option value="50">50 per page</option>
                                <option value="100">100 per page</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2">
                            <button 
                                id="ccmTablePrevBtn"
                                onclick="changeCCMTablePage('prev')" 
                                disabled
                                class="px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                Previous
                            </button>
                            <div class="text-sm text-gray-700">
                                Page <span class="font-medium" id="ccmTableCurrentPage">1</span> of <span class="font-medium" id="ccmTableTotalPages">1</span>
                            </div>
                            <button 
                                id="ccmTableNextBtn"
                                onclick="changeCCMTablePage('next')" 
                                disabled
                                class="px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                Next
                            </button>
                        </div>
                    </div>
                </div>
                
                <script>
                    // Direct chart initialization (TFA methodology)
                    setTimeout(() => {
                        // Chart 1: Regional Distribution Table
                        const regionalTableEl = document.getElementById('ccmRegionalSummaryTable');
                        if (regionalTableEl) {
                            const regionalData = {
                                APAC: { pastDue: ${regionalData.APAC.pastDue}, comingDue: ${regionalData.APAC.comingDue}, open: ${regionalData.APAC.open} },
                                EMEA: { pastDue: ${regionalData.EMEA.pastDue}, comingDue: ${regionalData.EMEA.comingDue}, open: ${regionalData.EMEA.open} },
                                NAM: { pastDue: ${regionalData.NAM.pastDue}, comingDue: ${regionalData.NAM.comingDue}, open: ${regionalData.NAM.open} },
                                LATAM: { pastDue: ${regionalData.LATAM.pastDue}, comingDue: ${regionalData.LATAM.comingDue}, open: ${regionalData.LATAM.open} }
                            };
                            
                            // Convert to array and sort by total (highest to lowest)
                            const regionEntries = [
                                { name: 'APAC', ...regionalData.APAC },
                                { name: 'EMEA', ...regionalData.EMEA },
                                { name: 'NAM', ...regionalData.NAM },
                                { name: 'LATAM', ...regionalData.LATAM }
                            ].sort((a, b) => (b.pastDue + b.comingDue + b.open) - (a.pastDue + a.comingDue + a.open));
                            
                            let tableHTML = \`
                                <table class="w-full h-full">
                                    <thead>
                                        <tr class="border-b border-gray-200 bg-gray-50">
                                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700">Region</th>
                                            <th class="px-6 py-4 text-right text-xs font-semibold text-gray-700">Past Due</th>
                                            <th class="px-6 py-4 text-right text-xs font-semibold text-gray-700">Coming Due</th>
                                            <th class="px-6 py-4 text-right text-xs font-semibold text-gray-700">Open</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-100">
                            \`;
                            
                            let totalPastDue = 0, totalComingDue = 0, totalOpen = 0;
                            regionEntries.forEach(region => {
                                totalPastDue += region.pastDue;
                                totalComingDue += region.comingDue;
                                totalOpen += region.open;
                            });
                            
                            regionEntries.forEach(region => {
                                tableHTML += \`
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 text-sm font-medium text-gray-900">\${region.name}</td>
                                        <td class="px-6 py-4 text-sm text-right text-gray-700">\${region.pastDue}</td>
                                        <td class="px-6 py-4 text-sm text-right text-gray-700">\${region.comingDue}</td>
                                        <td class="px-6 py-4 text-sm text-right text-gray-700">\${region.open}</td>
                                    </tr>
                                \`;
                            });
                            
                            tableHTML += \`
                                    <tr class="bg-gray-50 font-semibold border-t-2 border-gray-300">
                                        <td class="px-6 py-4 text-sm text-gray-900 rounded-bl-xl">Total</td>
                                        <td class="px-6 py-4 text-sm text-right text-gray-900">\${totalPastDue}</td>
                                        <td class="px-6 py-4 text-sm text-right text-gray-900">\${totalComingDue}</td>
                                        <td class="px-6 py-4 text-sm text-right text-gray-900 rounded-br-xl">\${totalOpen}</td>
                                    </tr>
                                </tbody>
                            </table>
                            \`;
                            regionalTableEl.innerHTML = tableHTML;
                        }
                        
                        // Chart 2: Status Variance (Grouped Bar - Current vs Previous)
                        const statusVarianceEl = document.getElementById('ccmStatusVarianceChart');
                        if (statusVarianceEl) {
                            const statusVarianceData = ${JSON.stringify(statusVariance)};
                            
                            const statusVarianceOptions = {
                                series: [
                                    {
                                        name: 'Previous Month',
                                        data: [
                                            statusVarianceData.pastDue.previous,
                                            statusVarianceData.comingDue.previous,
                                            statusVarianceData.open.previous
                                        ]
                                    },
                                    {
                                        name: 'Current Month',
                                        data: [
                                            statusVarianceData.pastDue.current,
                                            statusVarianceData.comingDue.current,
                                            statusVarianceData.open.current
                                        ]
                                    }
                                ],
                                colors: ['#93a8ff', '#465fff'],
                                chart: {
                                    fontFamily: 'Outfit, sans-serif',
                                    type: 'bar',
                                    height: 340,
                                    toolbar: { show: false },
                                    parentHeightOffset: 0
                                },
                                plotOptions: {
                                    bar: {
                                        horizontal: false,
                                        columnWidth: '55%',
                                        borderRadius: 6
                                    }
                                },
                                dataLabels: {
                                    enabled: false
                                },
                                stroke: {
                                    show: true,
                                    width: 2,
                                    colors: ['transparent']
                                },
                                xaxis: {
                                    categories: ['Past Due', 'Coming Due', 'Open'],
                                    labels: {
                                        style: {
                                            fontSize: '12px',
                                            fontWeight: 500
                                        }
                                    },
                                    axisBorder: {
                                        show: false
                                    },
                                    axisTicks: {
                                        show: false
                                    }
                                },
                                yaxis: {
                                    title: {
                                        text: 'Count',
                                        style: {
                                            fontSize: '12px',
                                            fontWeight: 500
                                        }
                                    },
                                    labels: {
                                        style: {
                                            fontSize: '11px'
                                        }
                                    }
                                },
                                legend: {
                                    position: 'top',
                                    horizontalAlign: 'center',
                                    fontSize: '12px',
                                    offsetY: 0,
                                    markers: {
                                        width: 12,
                                        height: 12,
                                        radius: 3
                                    },
                                    itemMargin: {
                                        horizontal: 10
                                    }
                                },
                                grid: {
                                    borderColor: '#E5E7EB',
                                    strokeDashArray: 4,
                                    padding: {
                                        top: 0,
                                        right: 0,
                                        bottom: 0,
                                        left: 0
                                    }
                                },
                                tooltip: {
                                    enabled: true,
                                    theme: "light",
                                    followCursor: false,
                                    custom: function ({ series, seriesIndex, dataPointIndex, w }) {
                                        const statusNames = ['Past Due', 'Coming Due', 'Open'];
                                        const statusKeys = ['pastDue', 'comingDue', 'open'];
                                        const statusName = statusNames[dataPointIndex];
                                        const statusKey = statusKeys[dataPointIndex];
                                        const currentCount = statusVarianceData[statusKey].current;
                                        const previousCount = statusVarianceData[statusKey].previous;
                                        const variance = currentCount - previousCount;
                                        const variancePercent = previousCount > 0 ? ((variance / previousCount) * 100).toFixed(1) : 0;
                                        const regionalBreakdown = statusVarianceData[statusKey].regionalBreakdown || { NAM: 0, LATAM: 0, EMEA: 0, APAC: 0 };
                                        
                                        // Status color
                                        const statusColors = {
                                            'Past Due': '#EF4444',
                                            'Coming Due': '#F59E0B',
                                            'Open': '#10B981'
                                        };
                                        const statusColor = statusColors[statusName] || '#6B7280';
                                        
                                        // Variance color
                                        const varianceColor = variance > 0 ? '#EF4444' : variance < 0 ? '#10B981' : '#6B7280';
                                        const varianceIcon = variance > 0 ? '' : variance < 0 ? '' : '';
                                        
                                        // Build regional table rows
                                        let regionalRows = '';
                                        ['NAM', 'LATAM', 'EMEA', 'APAC'].forEach(region => {
                                            const regionCount = regionalBreakdown[region] || 0;
                                            if (regionCount > 0) {
                                                regionalRows += \`
                                                    <tr>
                                                        <td style="padding: 6px 8px; text-align: left; font-size: 11px; color: #6B7280; font-weight: 500;">\${region}</td>
                                                        <td style="padding: 6px 8px; text-align: right; font-size: 11px; color: #111827; font-weight: 600;">\${regionCount}</td>
                                                    </tr>
                                                \`;
                                            }
                                        });
                                        
                                        return \`
                                            <div style="
                                                background: #ffffff; 
                                                border-radius: 12px; 
                                                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
                                                min-width: 320px;
                                                max-width: 360px;
                                                overflow: hidden;
                                                font-family: Outfit, sans-serif;
                                            ">
                                                <!-- Header with border -->
                                                <div style="
                                                    border-bottom: 1px solid #E5E7EB;
                                                    padding: 16px 16px 12px 16px;
                                                    margin-bottom: 14px;
                                                ">
                                                    <div style="
                                                        font-weight: 600; 
                                                        font-size: 15px; 
                                                        color: #111827;
                                                        margin-bottom: 4px;
                                                    ">\${statusName}</div>
                                                    <div style="
                                                        font-size: 12px; 
                                                        font-weight: 500;
                                                        color: #6B7280;
                                                    ">CCM Status</div>
                                                </div>
                                                
                                                <!-- Content wrapper -->
                                                <div style="padding: 0 16px 16px 16px;">
                                                    <!-- Widget Grid (2 columns) -->
                                                    <div style="
                                                        display: grid;
                                                        grid-template-columns: 1fr 1fr;
                                                        gap: 10px;
                                                        margin-bottom: 16px;
                                                    ">
                                                        <!-- Widget 1: Current Month -->
                                                        <div style="
                                                            background: #F9FAFB;
                                                            border-radius: 8px;
                                                            padding: 12px;
                                                            border: 1px solid #E5E7EB;
                                                        ">
                                                            <div style="
                                                                display: flex;
                                                                align-items: center;
                                                                gap: 6px;
                                                                font-size: 11px;
                                                                color: #6B7280;
                                                                font-weight: 500;
                                                                margin-bottom: 6px;
                                                            ">
                                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                                                </svg>
                                                                Current
                                                            </div>
                                                            <div style="
                                                                font-size: 20px;
                                                                font-weight: 700;
                                                                color: \${statusColor};
                                                            ">\${currentCount}</div>
                                                        </div>
                                                        
                                                        <!-- Widget 2: Previous Month -->
                                                        <div style="
                                                            background: #F9FAFB;
                                                            border-radius: 8px;
                                                            padding: 12px;
                                                            border: 1px solid #E5E7EB;
                                                        ">
                                                            <div style="
                                                                display: flex;
                                                                align-items: center;
                                                                gap: 6px;
                                                                font-size: 11px;
                                                                color: #6B7280;
                                                                font-weight: 500;
                                                                margin-bottom: 6px;
                                                            ">
                                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                                    <circle cx="12" cy="12" r="10"></circle>
                                                                    <polyline points="12 6 12 12 16 14"></polyline>
                                                                </svg>
                                                                Previous
                                                            </div>
                                                            <div style="
                                                                font-size: 20px;
                                                                font-weight: 700;
                                                                color: #111827;
                                                            ">\${previousCount}</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Variance Metric -->
                                                    <div style="
                                                        display: flex;
                                                        gap: 8px;
                                                        margin-bottom: 16px;
                                                        padding: 8px 12px;
                                                        background: #F9FAFB;
                                                        border-radius: 6px;
                                                    ">
                                                        <div style="flex: 1;">
                                                            <div style="font-size: 10px; color: #6B7280; font-weight: 500; margin-bottom: 2px;">Change</div>
                                                            <div style="font-size: 14px; font-weight: 600; color: \${varianceColor};">\${varianceIcon} \${Math.abs(variance)}</div>
                                                        </div>
                                                        <div style="width: 1px; background: #E5E7EB;"></div>
                                                        <div style="flex: 1; text-align: right;">
                                                            <div style="font-size: 10px; color: #6B7280; font-weight: 500; margin-bottom: 2px;">% Change</div>
                                                            <div style="font-size: 14px; font-weight: 600; color: \${varianceColor};">\${variancePercent > 0 ? '+' : ''}\${variancePercent}%</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Regional Distribution Table -->
                                                    <div style="margin-top: 12px;">
                                                        <div style="
                                                            display: flex;
                                                            align-items: center;
                                                            gap: 6px;
                                                            margin-bottom: 8px;
                                                        ">
                                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6B7280" stroke-width="2">
                                                                <circle cx="12" cy="12" r="10"></circle>
                                                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                                            </svg>
                                                            <span style="
                                                                font-size: 12px;
                                                                font-weight: 600;
                                                                color: #374151;
                                                            ">Regional Distribution</span>
                                                        </div>
                                                        <table style="width: 100%; border-collapse: collapse;">
                                                            <thead>
                                                                <tr style="border-bottom: 1px solid #E5E7EB;">
                                                                    <th style="padding: 6px 8px; text-align: left; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Region</th>
                                                                    <th style="padding: 6px 8px; text-align: right; font-size: 10px; color: #6B7280; font-weight: 600; text-transform: uppercase;">Count</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                \${regionalRows || '<tr><td colspan="2" style="padding: 8px; text-align: center; font-size: 11px; color: #9CA3AF;">No data</td></tr>'}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        \`;
                                    }
                                }
                            };
                            statusVarianceEl.innerHTML = '';
                            const statusVarianceChart = new ApexCharts(statusVarianceEl, statusVarianceOptions);
                            statusVarianceChart.render();
                            
                            // Add tooltip positioning fix
                            setTimeout(() => {
                                const tooltipObserver = new MutationObserver(() => {
                                    const tooltip = statusVarianceEl.querySelector('.apexcharts-tooltip.apexcharts-active');
                                    if (tooltip && !tooltip.hasAttribute('data-positioned')) {
                                        const tooltipRect = tooltip.getBoundingClientRect();
                                        const windowWidth = window.innerWidth;
                                        const windowHeight = window.innerHeight;
                                        const margin = 10;
                                        
                                        let needsReposition = false;
                                        
                                        if (tooltipRect.left < margin) {
                                            tooltip.style.left = margin + 'px';
                                            tooltip.style.transform = 'none';
                                            needsReposition = true;
                                        } else if (tooltipRect.right > windowWidth - margin) {
                                            tooltip.style.left = (windowWidth - tooltipRect.width - margin) + 'px';
                                            tooltip.style.transform = 'none';
                                            needsReposition = true;
                                        }
                                        
                                        if (tooltipRect.top < margin) {
                                            tooltip.style.top = margin + 'px';
                                            needsReposition = true;
                                        } else if (tooltipRect.bottom > windowHeight - margin) {
                                            tooltip.style.top = (windowHeight - tooltipRect.height - margin) + 'px';
                                            needsReposition = true;
                                        }
                                        
                                        if (needsReposition) {
                                            tooltip.setAttribute('data-positioned', 'true');
                                        }
                                    }
                                    
                                    const hiddenTooltip = statusVarianceEl.querySelector('.apexcharts-tooltip:not(.apexcharts-active)[data-positioned]');
                                    if (hiddenTooltip) {
                                        hiddenTooltip.removeAttribute('data-positioned');
                                    }
                                });
                                
                                tooltipObserver.observe(statusVarianceEl, {
                                    attributes: true,
                                    attributeFilter: ['class'],
                                    subtree: true
                                });
                            }, 200);
                        }
                        
                        // Initialize CCM Details Table
                        const ccmDetailsData = ${JSON.stringify(dataSource)};
                        window.ccmDetailsFullData = ccmDetailsData;
                        window.ccmTableState = {
                            data: ccmDetailsData,
                            filtered: ccmDetailsData,
                            currentPage: 1,
                            perPage: 10,
                            searchTerm: '',
                            statusFilter: 'pastDue',
                            sortColumn: null,
                            sortDirection: 'asc'
                        };
                        
                        // Apply initial filters (user filters + status filter)
                        applyCCMUserFilters();
                        initializeCCMDetailsTable();
                    }, 100);
                <\/script>
            `;
        }
        
        // Close expand modal
        function closeExpandModal() {
            const modal = document.getElementById("expandModal");
            modal.classList.add("hidden");
            document.body.style.overflow = "auto";
            currentExpandType = null;
        }
        
        // View data from expand modal - closes expand modal first
        function viewDataFromExpandModal() {
            const chartType = currentExpandType;
            closeExpandModal();
            // Small delay to ensure modal is closed before opening the next one
            setTimeout(() => {
                openChartDataModal(chartType);
            }, 100);
        }

        // Add keyboard listener for ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const expandModal = document.getElementById("expandModal");
                if (expandModal && !expandModal.classList.contains('hidden')) {
                    closeExpandModal();
                }
            }
        });

        // ========================================
        // CHART DATA VIEWER MODAL FUNCTIONS
        // ========================================

        // Open chart data modal with specific dataset
        function openChartDataModal(chartType) {
            const modal = document.getElementById("chartDataModal");
            const modalTitle = document.getElementById("chartDataModalTitle");
            const modalSubtitle = document.getElementById("chartDataModalSubtitle");
            const tableHeader = document.getElementById("chartDataTableHeader");
            const tableBody = document.getElementById("chartDataTableBody");

            // Show modal immediately with loading state
            modal.classList.remove("hidden");
            document.body.style.overflow = "hidden";
            
            // Show loading state
            tableHeader.innerHTML = '<th colspan="100" class="px-4 py-8 text-center text-gray-500">Loading...</th>';
            tableBody.innerHTML = '';
            document.getElementById("chartDataTableFilters").innerHTML = '';
            
            // Defer data loading to next frame for instant modal opening
            requestAnimationFrame(() => {
                setTimeout(() => {
                    loadChartData(chartType, modalTitle, modalSubtitle, tableHeader, tableBody);
                }, 10);
            });
        }

        function loadChartData(chartType, modalTitle, modalSubtitle, tableHeader, tableBody) {
            // Determine which data to show
            let data = [];
            let chartName = "";

            switch (chartType) {
                // Top 5 Metric Cards
                case "tfa":
                    chartName = "Total Facilities Approved (TFA)";
                    data = filteredData.length > 0 ? filteredData : portfolioData;
                    break;
                case "osuc":
                    chartName = "OSUC breakdown";
                    data = filteredData.length > 0 ? filteredData : portfolioData;
                    break;
                case "outstanding":
                    chartName = "Total Outstanding Balance";
                    data = filteredData.length > 0 ? filteredData : portfolioData;
                    break;
                case "facilities":
                    chartName = "Total Facilities";
                    data = filteredData.length > 0 ? filteredData : portfolioData;
                    break;
                case "relationships":
                    chartName = "Total Relationships";
                    data = filteredData.length > 0 ? filteredData : portfolioData;
                    break;
                // Chart Cards
                case "expiring":
                    chartName = "CAs & Facilities Expiring";
                    data = getExpiringData();
                    break;
                case "newFacilities":
                    chartName = "New Facilities Approved ";
                    data = getNewFacilitiesData();
                    break;
                case "topRelationships":
                    chartName = "Top Relationships by " + getExposureTypeName();
                    data = getTopRelationshipsData();
                    break;
                case "rotce":
                    chartName = "ROTCE Performance";
                    data = getROTCEData();
                    break;
                case "newDealsYTD":
                    chartName = "New Deals Closed YTD";
                    data = getNewDealsYTDData();
                    break;
                case "newDealsMTD":
                    chartName = "New Deals Closed MTD";
                    data = getNewDealsMTDData();
                    break;
                case "covenantsByProgram":
                    chartName = "Covenants by Product Program";
                    data = getCovenantsByProgramData();
                    break;
                case "covenantMonitoring":
                    chartName = currentCovenantViewType === 'pastDue' ? "Past Due Covenants" : "Coming Due Covenants (Next 30 Days)";
                    data = getCovenantMonitoringData();
                    break;
                case "covenantRegional":
                    chartName = currentCovenantViewType === 'pastDue' ? "Past Due Covenants by Region" : "Coming Due Covenants by Region (Next 30 Days)";
                    data = getCovenantRegionalData();
                    break;
                case "ccmRegionalChart":
                    chartName = "Criticized/Classified Memos & Reviews";
                    data = getCCMFilteredData();
                    break;
                case "ccmStats":
                    chartName = "Credit Committee Memos";
                    data = getCCMFilteredData();
                    break;
                case "pipeline":
                    chartName = "Deals Pending Closure";
                    data = filteredData.length > 0 ? filteredData : portfolioData;
                    break;
                default:
                    data = filteredData.length > 0 ? filteredData : portfolioData;
            }

            // Update modal title
            modalTitle.textContent = chartName + " - Underlying Data";
            
            // Build filter description
            let filterDesc = [];
            if (filteredData.length > 0 && filteredData.length < portfolioData.length) {
                filterDesc.push("portfolio filters applied");
            }
            if (selectedRegion !== 'all') {
                filterDesc.push(`Region: ${selectedRegion.toUpperCase()}`);
            }
            // Add view type for covenant charts
            if (chartType === 'covenantMonitoring' || chartType === 'covenantRegional') {
                filterDesc.push(`View: ${currentCovenantViewType === 'pastDue' ? 'Past Due' : 'Coming Due (30 days)'}`);
            }
            // Add status info for CCM charts
            if (chartType === 'ccmRegionalChart' || chartType === 'ccmStats') {
                filterDesc.push("All CCM statuses (Past Due, Coming Due, Open)");
            }
            
            const filterText = filterDesc.length > 0 ? ` (${filterDesc.join(", ")})` : "";
            modalSubtitle.textContent = `Showing ${data.length} records${filterText}`;

            // Store data and chart name for export
            window.currentChartData = { data, chartName };

            // Build table
            buildDataTable(data, tableHeader, tableBody);
        }

        // Close chart data modal
        function closeChartDataModal() {
            const modal = document.getElementById("chartDataModal");
            modal.classList.add("hidden");
            document.body.style.overflow = "auto";
        }

        // Get exposure type name
        function getExposureTypeName() {
            const names = {
                direct: "Direct OS",
                contingent: "Contingent OS",
                pse: "PSE OS",
                osuc: "OSUC",
                unused: "Undrawn Commitment",
                tfa: "Total Facility Amount",
            };
            return names[selectedAmountType] || "Direct OS";
        }

        // Get expiring data (CAs & Facilities expiring in next 3 months, excludes DM, EMEA CAs require CA_Review = "Yes")
        function getExpiringData() {
            const dataSource =
                filteredData.length > 0 ? filteredData : portfolioData;
            console.log("getExpiringData - dataSource length:", dataSource.length);
            
            // Get report date from data
            const reportDates = dataSource
                .map((row) => parseDate(row.Report_Date))
                .filter((d) => d);
            if (reportDates.length === 0) {
                console.log(" No valid report dates found");
                return [];
            }
            const maxReportDate = new Date(Math.max(...reportDates));
            maxReportDate.setHours(0, 0, 0, 0);
            
            const threeMonthsLater = new Date(maxReportDate);
            threeMonthsLater.setMonth(threeMonthsLater.getMonth() + 3);

            const result = dataSource.filter((row) => {
                const managementStatus = (row.Management_Status || "").toUpperCase();
                const region = (row.Region || "").toUpperCase();
                const caReview = (row.CA_Review || "").trim();
                
                // Exclude DM status
                if (managementStatus === "DM") return false;
                
                const caExpiry = parseDate(row.CA_Expiration_Date);
                const maturityDate = parseDate(row.Maturity_Date);

                const caExpiring =
                    caExpiry && caExpiry >= maxReportDate && caExpiry <= threeMonthsLater;
                const facilityExpiring =
                    maturityDate &&
                    maturityDate >= maxReportDate &&
                    maturityDate <= threeMonthsLater;

                // For CA expiring in EMEA, require CA_Review = "Yes"
                if (caExpiring && region === "EMEA" && caReview !== "Yes") {
                    return facilityExpiring; // Only include if facility is also expiring
                }

                return caExpiring || facilityExpiring;
            });
            
            console.log("getExpiringData - filtered result length:", result.length);
            return result;
        }

        // Get new facilities data (based on selected period)
        function getNewFacilitiesData() {
            const dataSource =
                filteredData.length > 0 ? filteredData : portfolioData;
            console.log(
                "getNewFacilitiesData - dataSource length:",
                dataSource.length,
                "selectedPeriod:",
                selectedPeriod
            );
            const reportDates = dataSource
                .map((row) => parseDate(row.Report_Date))
                .filter((d) => d);
            if (reportDates.length === 0) {
                console.log("getNewFacilitiesData - No report dates found");
                return [];
            }

            const mostRecentReportDate = new Date(Math.max(...reportDates));

            let targetStartDate, targetEndDate;
            if (selectedPeriod === "current") {
                targetStartDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth(),
                    1
                );
                targetStartDate.setHours(0, 0, 0, 0);
                targetEndDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth() + 1,
                    0
                );
                targetEndDate.setHours(23, 59, 59, 999);
            } else {
                targetStartDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth() - 1,
                    1
                );
                targetStartDate.setHours(0, 0, 0, 0);
                targetEndDate = new Date(
                    mostRecentReportDate.getFullYear(),
                    mostRecentReportDate.getMonth(),
                    0
                );
                targetEndDate.setHours(23, 59, 59, 999);
            }

            const result = dataSource.filter((row) => {
                const firstApprovalDate = parseDate(row.Facility_First_Approval_Date);
                return (
                    firstApprovalDate &&
                    firstApprovalDate >= targetStartDate &&
                    firstApprovalDate <= targetEndDate
                );
            });

            console.log(
                "getNewFacilitiesData - filtered result length:",
                result.length
            );
            return result;
        }

        // Get top relationships data
        function getTopRelationshipsData() {
            const dataSource =
                filteredData.length > 0 ? filteredData : portfolioData;
            const topN = parseInt(document.getElementById("topNFilter").value);
            console.log(
                "getTopRelationshipsData - dataSource length:",
                dataSource.length,
                "topN:",
                topN,
                "selectedAmountType:",
                selectedAmountType
            );

            // Aggregate by relationship
            const relationshipData = new Map();
            for (const row of dataSource) {
                const relId = row.Relationship_Name || row.Relationship_ID;
                if (!relId) continue;

                if (!relationshipData.has(relId)) {
                    relationshipData.set(relId, []);
                }
                relationshipData.get(relId).push(row);
            }

            // Calculate totals for sorting
            const relationshipTotals = new Map();
            for (const [relId, rows] of relationshipData.entries()) {
                let total = 0;
                for (const row of rows) {
                    switch (selectedAmountType) {
                        case "tfa":
                            total += parseNumber(row.Facility_Amount);
                            break;
                        case "direct":
                            total += parseNumber(row.Direct_OS);
                            break;
                        case "contingent":
                            total += parseNumber(row.Contingent_OS);
                            break;
                        case "pse":
                            total += parseNumber(row.PSE_OS);
                            break;
                        case "osuc":
                            total += parseNumber(row.OSUC);
                            break;
                        case "unused":
                            total += parseNumber(row.Unused_Committed);
                            break;
                        default:
                            total += parseNumber(row.Direct_OS);
                    }
                }
                relationshipTotals.set(relId, total);
            }

            // Get top N relationships
            const topRelationships = Array.from(relationshipTotals.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, topN)
                .map(([relId]) => relId);

            // Return all rows for top relationships
            const result = dataSource.filter((row) => {
                const relId = row.Relationship_Name || row.Relationship_ID;
                return topRelationships.includes(relId);
            });
            
            console.log(
                "getTopRelationshipsData - filtered result length:",
                result.length
            );
            return result;
        }

        // Get New Deals YTD data
        function getNewDealsYTDData() {
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
            
            // Use reporting month instead of actual current date
            const { monthStart, monthEnd, reportingMonth: repMonth } = getReportingMonthRange();
            const currentYear = repMonth.getFullYear();
            const yearStartDate = new Date(currentYear, 0, 1);
            yearStartDate.setHours(0, 0, 0, 0);

            // Get unique facilities with origination date in reporting year (up to reporting month)
            const facilitiesSet = new Set();
            const result = dataSource.filter((row) => {
                const originationDate = parseDate(row.Origination_Date);
                const facilityId = row.Facility_ID || row.Facility_Name;
                const region = String(row.Region || "").trim().toUpperCase();
                
                // Apply region filter if active
                if (selectedRegion !== 'all' && region !== selectedRegion.toUpperCase()) return false;
                
                if (originationDate && originationDate >= yearStartDate && originationDate <= repMonth && facilityId) {
                    if (!facilitiesSet.has(facilityId)) {
                        facilitiesSet.add(facilityId);
                        return true;
                    }
                }
                return false;
            });

            console.log("getNewDealsYTDData - filtered result length:", result.length);
            return result;
        }

        // Get New Deals MTD data
        function getNewDealsMTDData() {
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;

            // Use reporting month instead of actual current date
            const { monthStart, monthEnd, reportingMonth: repMonth } = getReportingMonthRange();

            // Get unique facilities with origination date in reporting month
            const facilitiesSet = new Set();
            const result = dataSource.filter((row) => {
                const originationDate = parseDate(row.Origination_Date);
                const facilityId = row.Facility_ID || row.Facility_Name;
                const region = String(row.Region || "").trim().toUpperCase();
                
                // Apply region filter if active
                if (selectedRegion !== 'all' && region !== selectedRegion.toUpperCase()) return false;
                
                if (originationDate && originationDate >= monthStart && originationDate <= monthEnd && facilityId) {
                    if (!facilitiesSet.has(facilityId)) {
                        facilitiesSet.add(facilityId);
                        return true;
                    }
                }
                return false;
            });

            console.log("getNewDealsMTDData - filtered result length:", result.length);
            return result;
        }

        // Get covenants by product program data
        function getCovenantsByProgramData() {
            // Use covenant data if available, otherwise fall back to portfolio data
            const dataSource = covenantsData.length > 0 ? covenantsData : (filteredData.length > 0 ? filteredData : portfolioData);
            
            console.log("getCovenantsByProgramData - using", covenantsData.length > 0 ? "covenant data" : "portfolio data");
            
            // Filter for rows that have covenant data and apply region filter
            const result = dataSource.filter((row) => {
                const programName = String(row.Product_Program_Name || "").trim();
                const region = String(row.Region || "").trim().toUpperCase();
                
                // Skip if no program name
                if (programName === "") return false;
                
                // Apply region filter if active
                if (selectedRegion !== 'all' && region !== selectedRegion.toUpperCase()) return false;
                
                return true;
            });
            
            console.log("getCovenantsByProgramData - filtered result length:", result.length);
            return result;
        }

        // Get covenant monitoring data (filtered by current view type: pastDue or comingDue)
        function getCovenantMonitoringData() {
            // Use covenant data if available, otherwise fall back to portfolio data
            const dataSource = covenantsData.length > 0 ? covenantsData : (filteredData.length > 0 ? filteredData : portfolioData);
            
            console.log("getCovenantMonitoringData - using", covenantsData.length > 0 ? "covenant data" : "portfolio data", "view:", currentCovenantViewType);
            
            // Filter for rows based on current view type using exact dataLoader field names
            const result = dataSource.filter((row) => {
                // Use exact field name from dataLoader: Coming_Due_Past_Due
                const status = String(row.Coming_Due_Past_Due || "").trim().toLowerCase();
                const region = String(row.Region || "").trim().toUpperCase();
                
                // Apply region filter if active
                if (selectedRegion !== 'all' && region !== selectedRegion.toUpperCase()) return false;
                
                // Apply view type filter using Coming_Due_Past_Due from dataLoader (Coming Due = next 30 days only)
                if (currentCovenantViewType === 'pastDue') {
                    if (status !== 'past due') return false;
                } else if (currentCovenantViewType === 'comingDue') {
                    if (status !== 'coming due' || !isWithinNext30Days(row.Covenant_Due_Date)) return false;
                }
                
                return true;
            });
            
            console.log("getCovenantMonitoringData - filtered result length:", result.length);
            return result;
        }
        
        // Get covenant regional data (for Past Due Covenants by Region table - filtered by current view type)
        function getCovenantRegionalData() {
            const dataSource = covenantsData.length > 0 ? covenantsData : portfolioData;
            
            console.log("getCovenantRegionalData - view:", currentCovenantViewType);
            
            // Filter based on current view type using exact dataLoader field names
            const result = dataSource.filter((row) => {
                // Use exact field name from dataLoader: Coming_Due_Past_Due
                const status = String(row.Coming_Due_Past_Due || "").trim().toLowerCase();
                const region = String(row.Region || "").trim().toUpperCase();
                
                // Apply region filter if active
                if (selectedRegion !== 'all' && region !== selectedRegion.toUpperCase()) return false;
                
                // Apply view type filter using Coming_Due_Past_Due from dataLoader (Coming Due = next 30 days only)
                if (currentCovenantViewType === 'pastDue') {
                    if (status !== 'past due') return false;
                } else if (currentCovenantViewType === 'comingDue') {
                    if (status !== 'coming due' || !isWithinNext30Days(row.Covenant_Due_Date)) return false;
                }
                
                return true;
            });
            
            console.log("getCovenantRegionalData - filtered result length:", result.length);
            return result;
        }
        
        // Get CCM data with filters applied (includes status categorization)
        function getCCMFilteredData() {
            if (!ccmData || ccmData.length === 0) return [];
            
            // Filter CCM data based on region filter and use CCM_Status from dataLoader
            const result = ccmData.filter((row) => {
                const region = String(row.Region || "").trim().toUpperCase();
                
                // Apply region filter if active
                if (selectedRegion !== 'all' && region !== selectedRegion.toUpperCase()) return false;
                
                return true;
            }).map((row) => {
                // Use CCM_Status from dataLoader export directly
                return {
                    ...row,
                    Computed_CCM_Status: row.CCM_Status || 'Unknown'
                };
            });
            
            console.log("getCCMFilteredData - filtered result length:", result.length);
            return result;
        }
        
        // Get ROTCE data for the top N relationships (matching chart logic)
        function getROTCEData() {
            const dataSource = filteredData.length > 0 ? filteredData : portfolioData;
            const topN = parseInt(document.getElementById("topNFilter").value);
            
            // Build relationship data map (same logic as chart)
            const relationshipData = new Map();
            for (const row of dataSource) {
                const relId = row.Relationship_Name || row.Relationship_ID;
                if (!relId) continue;
                
                if (!relationshipData.has(relId)) {
                    relationshipData.set(relId, {
                        tfa: 0,
                        direct: 0,
                        contingent: 0,
                        pse: 0,
                        osuc: 0,
                        unused: 0,
                    });
                }
                const data = relationshipData.get(relId);
                data.tfa += parseNumber(row.Fac_Amount || row.Facility_Amount);
                data.direct += parseNumber(row.Direct_OS);
                data.contingent += parseNumber(row.Contingent_OS);
                data.pse += parseNumber(row.PSE_OS);
                data.osuc += parseNumber(row.OSUC);
                data.unused += parseNumber(row.Unused_Committed);
            }
            
            // Get the selected field value for sorting
            const relationshipTotals = new Map();
            for (const [relId, data] of relationshipData.entries()) {
                let sortValue = 0;
                switch (selectedAmountType) {
                    case "tfa": sortValue = data.tfa; break;
                    case "direct": sortValue = data.direct; break;
                    case "contingent": sortValue = data.contingent; break;
                    case "pse": sortValue = data.pse; break;
                    case "osuc": sortValue = data.osuc; break;
                    case "unused": sortValue = data.unused; break;
                    default: sortValue = data.direct;
                }
                relationshipTotals.set(relId, sortValue);
            }
            
            // Get top N relationships by selected exposure type
            const topRelationships = Array.from(relationshipTotals.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, topN)
                .map(([relId]) => relId);
            
            // Return rows for top relationships that have ROTCE data
            const result = dataSource.filter((row) => {
                const relId = row.Relationship_Name || row.Relationship_ID;
                const rotce = row.ROTCE;
                return topRelationships.includes(relId) && rotce !== undefined && rotce !== null && rotce !== '';
            });
            
            console.log("getROTCEData - filtered result length:", result.length);
            return result;
        }

        // Build data table dynamically
        // Global variables for table state
        let tableState = {
            data: [],
            filteredData: [],
            columns: [],
            currentPage: 1,
            pageSize: 100,
            columnFilters: {}
        };

        function buildDataTable(data, tableHeader, tableBody) {
            if (data.length === 0) {
                tableHeader.innerHTML = "";
                document.getElementById("chartDataTableFilters").innerHTML = "";
                tableBody.innerHTML =
                    '<tr><td colspan="100" class="text-center py-8 text-gray-500">No data available</td></tr>';
                updatePaginationControls(0, 0, 0);
                return;
            }

            // Initialize table state
            tableState.data = data;
            tableState.columns = Object.keys(data[0]);
            tableState.currentPage = 1;
            tableState.columnFilters = {};
            
            // Apply filters to get filtered data
            applyTableFilters();

            // Build header
            buildTableHeader(tableHeader);
            
            // Build filter row
            buildFilterRow();

            // Render current page
            renderTablePage(tableBody);
            
            // Setup pagination controls
            setupPaginationControls();
        }

        function buildTableHeader(tableHeader) {
            tableHeader.innerHTML = tableState.columns
                .map(
                    (col) =>
                        `<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 tracking-wider bg-gray-50">${col.replace(
                            /_/g,
                            " "
                        )}</th>`
                )
                .join("");
        }

        function buildFilterRow() {
            const filterRow = document.getElementById("chartDataTableFilters");
            
            // Get unique values for each column and detect column types
            const columnInfo = {};
            tableState.columns.forEach(col => {
                const uniqueValues = [...new Set(tableState.data.map(row => row[col]))];
                const cleanValues = uniqueValues.filter(v => v !== null && v !== undefined && v !== '');
                
                // Detect if column is numeric/amount
                const colLower = col.toLowerCase();
                const isAmountColumn = colLower.includes('amount') || 
                                      colLower.includes('_os') || 
                                      colLower.includes('osuc') || 
                                      colLower.includes('committed') ||
                                      colLower.includes('outstanding') ||
                                      colLower.includes('balance') ||
                                      colLower.includes('tfa') ||
                                      colLower.includes('exposure');
                
                const isNumericColumn = isAmountColumn || colLower.includes('rate') || colLower.includes('percent') || colLower.includes('rotce');
                
                // Check if values are actually numeric
                const sampleValues = cleanValues.slice(0, 10);
                const areValuesNumeric = sampleValues.length > 0 && 
                                        sampleValues.every(v => !isNaN(parseFloat(String(v).replace(/[$,]/g, ''))));
                
                columnInfo[col] = {
                    values: cleanValues.sort().slice(0, 100),
                    isNumeric: isNumericColumn && areValuesNumeric,
                    isAmount: isAmountColumn && areValuesNumeric,
                    isCategorical: cleanValues.length <= 50 && !isNumericColumn
                };
            });
            
            filterRow.innerHTML = tableState.columns
                .map((col, idx) => {
                    const info = columnInfo[col];
                    const currentFilter = tableState.columnFilters[col] || '';
                    
                    // Amount/Numeric columns - show range filter
                    if (info.isAmount || info.isNumeric) {
                        const currentOp = tableState.columnFilterOps?.[col] || 'range';
                        const currentMin = tableState.columnFilterMin?.[col] || '';
                        const currentMax = tableState.columnFilterMax?.[col] || '';
                        const currentExact = tableState.columnFilterExact?.[col] || '';
                        const displayText = (typeof currentFilter === 'object' && currentFilter.display) ? currentFilter.display : 'Filter...';
                        
                        return `<th class="px-4 py-2 bg-gray-50" 
                                    x-data="{open${idx}: false, filterOp${idx}: '${currentOp}'}">
                            <button @click="open${idx} = !open${idx}"
                                class="inline-flex items-center justify-between w-full gap-1 rounded-lg border border-gray-300 bg-white px-2 py-1 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                <span class="truncate max-w-[100px]">${displayText}</span>
                                <svg class="h-3 w-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            <div x-show="open${idx}" @click.outside="open${idx} = false"
                                class="absolute z-[9999] w-64 space-y-2 rounded-2xl border border-gray-200 bg-white p-3 shadow-theme-lg mt-2">
                                <div class="text-xs font-semibold text-gray-700 mb-2">${col.replace(/_/g, ' ')}</div>
                                
                                <!-- Filter Type Selector -->
                                <div class="grid grid-cols-2 gap-1 mb-2">
                                    <button @click="filterOp${idx} = 'exact'"
                                        :class="filterOp${idx} === 'exact' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                        class="px-2 py-1 text-xs rounded transition-colors">
                                        Exact
                                    </button>
                                    <button @click="filterOp${idx} = 'range'"
                                        :class="filterOp${idx} === 'range' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                        class="px-2 py-1 text-xs rounded transition-colors">
                                        Range
                                    </button>
                                    <button @click="filterOp${idx} = 'greater'"
                                        :class="filterOp${idx} === 'greater' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                        class="px-2 py-1 text-xs rounded transition-colors">
                                        Greater
                                    </button>
                                    <button @click="filterOp${idx} = 'less'"
                                        :class="filterOp${idx} === 'less' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                                        class="px-2 py-1 text-xs rounded transition-colors">
                                        Less
                                    </button>
                                </div>
                                
                                <!-- Exact Match Filter -->
                                <div x-show="filterOp${idx} === 'exact'" class="space-y-2">
                                    <div>
                                        <label class="text-xs text-gray-600 mb-1 block">Exact Value</label>
                                        <input type="number" id="exact${idx}" placeholder="Enter exact amount" 
                                            class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                            value="${currentExact}">
                                    </div>
                                    <button @click="open${idx} = false; window.applyNumericFilter('${col}', 'exact', document.getElementById('exact${idx}').value);"
                                        class="w-full px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">
                                        Apply Filter
                                    </button>
                                </div>
                                
                                <!-- Range Filter -->
                                <div x-show="filterOp${idx} === 'range'" class="space-y-2">
                                    <div>
                                        <label class="text-xs text-gray-600 mb-1 block">Min Value</label>
                                        <input type="number" id="min${idx}" placeholder="Min" 
                                            class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                            value="${currentMin}">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-600 mb-1 block">Max Value</label>
                                        <input type="number" id="max${idx}" placeholder="Max" 
                                            class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                            value="${currentMax}">
                                    </div>
                                    <button @click="open${idx} = false; window.applyNumericFilter('${col}', 'range', document.getElementById('min${idx}').value, document.getElementById('max${idx}').value);"
                                        class="w-full px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">
                                        Apply Range
                                    </button>
                                </div>
                                
                                <!-- Greater Than Filter -->
                                <div x-show="filterOp${idx} === 'greater'" class="space-y-2">
                                    <div>
                                        <label class="text-xs text-gray-600 mb-1 block">Greater Than</label>
                                        <input type="number" id="greater${idx}" placeholder="Enter value" 
                                            class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                            value="${currentMin}">
                                    </div>
                                    <button @click="open${idx} = false; window.applyNumericFilter('${col}', 'greater', document.getElementById('greater${idx}').value);"
                                        class="w-full px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">
                                        Apply Filter
                                    </button>
                                </div>
                                
                                <!-- Less Than Filter -->
                                <div x-show="filterOp${idx} === 'less'" class="space-y-2">
                                    <div>
                                        <label class="text-xs text-gray-600 mb-1 block">Less Than</label>
                                        <input type="number" id="less${idx}" placeholder="Enter value" 
                                            class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                            value="${currentMax}">
                                    </div>
                                    <button @click="open${idx} = false; window.applyNumericFilter('${col}', 'less', document.getElementById('less${idx}').value);"
                                        class="w-full px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">
                                        Apply Filter
                                    </button>
                                </div>
                                
                                <!-- Clear Button -->
                                <button @click="open${idx} = false; window.clearNumericFilter('${col}');"
                                    class="w-full px-3 py-1.5 text-xs font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                                    Clear Filter
                                </button>
                            </div>
                        </th>`;
                    }
                    
                    // Categorical columns with few values - show dropdown
                    if (info.isCategorical) {
                        const displayText = currentFilter || 'All';
                        
                        return `<th class="px-4 py-2 bg-gray-50" 
                                    x-data="{open${idx}: false, selected${idx}: '${currentFilter}'}">
                            <button @click="open${idx} = !open${idx}"
                                class="inline-flex items-center justify-between w-full gap-2 rounded-lg border border-gray-300 bg-white px-2 py-1 text-xs font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                                <span class="truncate max-w-[120px]" x-text="selected${idx} || 'All'"></span>
                                <svg class="h-3 w-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            <div x-show="open${idx}" @click.outside="open${idx} = false"
                                class="absolute z-[9999] w-48 max-h-64 overflow-y-auto space-y-1 rounded-2xl border border-gray-200 bg-white p-2 shadow-theme-lg mt-2">
                                <button
                                    @click="selected${idx} = ''; open${idx} = false; window.applyColumnFilter('${col}', '');"
                                    :class="selected${idx} === '' ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                    class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors">
                                    All
                                </button>
                                ${info.values.map(value => {
                                    const displayValue = String(value).substring(0, 50);
                                    const safeValue = String(value).replace(/'/g, "\\'");
                                    return `<button
                                        @click="selected${idx} = '${safeValue}'; open${idx} = false; window.applyColumnFilter('${col}', '${safeValue}');"
                                        :class="selected${idx} === '${safeValue}' ? 'bg-blue-50 text-blue-700' : 'text-gray-700 hover:bg-gray-100'"
                                        class="flex w-full rounded-lg px-3 py-1.5 text-left text-xs font-medium transition-colors truncate">
                                        ${displayValue}
                                    </button>`;
                                }).join('')}
                            </div>
                        </th>`;
                    }
                    
                    // Text search for other columns
                    return `<th class="px-4 py-2 bg-gray-50">
                        <input 
                            type="text" 
                            placeholder="Search..." 
                            data-column="${col}"
                            data-column-index="${idx}"
                            class="table-filter-input w-full px-2 py-1 text-xs border border-gray-300 rounded focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                            value="${currentFilter}"
                        />
                    </th>`;
                })
                .join("");
            
            // Add event listeners to text filter inputs
            filterRow.querySelectorAll('.table-filter-input').forEach(input => {
                input.addEventListener('input', debounce((e) => {
                    const column = e.target.dataset.column;
                    const value = e.target.value.trim().toLowerCase();
                    
                    if (value) {
                        tableState.columnFilters[column] = value;
                    } else {
                        delete tableState.columnFilters[column];
                    }
                    
                    tableState.currentPage = 1;
                    applyTableFilters();
                    renderTablePage(document.getElementById("chartDataTableBody"));
                    setupPaginationControls();
                    updateClearFiltersButton();
                }, 300));
            });
        }
        
        // Global function to apply numeric filter
        window.applyNumericFilter = function(column, operator, minOrValue, maxValue) {
            // Initialize filter ops storage if not exists
            if (!tableState.columnFilterOps) tableState.columnFilterOps = {};
            if (!tableState.columnFilterMin) tableState.columnFilterMin = {};
            if (!tableState.columnFilterMax) tableState.columnFilterMax = {};
            if (!tableState.columnFilterExact) tableState.columnFilterExact = {};
            
            tableState.columnFilterOps[column] = operator;
            
            if (operator === 'exact') {
                const value = parseFloat(minOrValue);
                if (!isNaN(value)) {
                    tableState.columnFilters[column] = {
                        type: 'exact',
                        value: value,
                        display: `= ${formatShortNumber(value)}`
                    };
                    tableState.columnFilterExact[column] = minOrValue;
                } else {
                    delete tableState.columnFilters[column];
                    delete tableState.columnFilterExact[column];
                }
            } else if (operator === 'range') {
                const min = minOrValue ? parseFloat(minOrValue) : null;
                const max = maxValue ? parseFloat(maxValue) : null;
                
                if (min !== null || max !== null) {
                    tableState.columnFilters[column] = {
                        type: 'range',
                        min: min,
                        max: max,
                        display: min !== null && max !== null ? `${formatShortNumber(min)} - ${formatShortNumber(max)}` :
                                min !== null ? ` ${formatShortNumber(min)}` :
                                ` ${formatShortNumber(max)}`
                    };
                    tableState.columnFilterMin[column] = minOrValue;
                    tableState.columnFilterMax[column] = maxValue;
                } else {
                    delete tableState.columnFilters[column];
                    delete tableState.columnFilterMin[column];
                    delete tableState.columnFilterMax[column];
                }
            } else if (operator === 'greater') {
                const value = parseFloat(minOrValue);
                if (!isNaN(value)) {
                    tableState.columnFilters[column] = {
                        type: 'greater',
                        value: value,
                        display: `> ${formatShortNumber(value)}`
                    };
                    tableState.columnFilterMin[column] = minOrValue;
                } else {
                    delete tableState.columnFilters[column];
                    delete tableState.columnFilterMin[column];
                }
            } else if (operator === 'less') {
                const value = parseFloat(minOrValue);
                if (!isNaN(value)) {
                    tableState.columnFilters[column] = {
                        type: 'less',
                        value: value,
                        display: `< ${formatShortNumber(value)}`
                    };
                    tableState.columnFilterMax[column] = minOrValue;
                } else {
                    delete tableState.columnFilters[column];
                    delete tableState.columnFilterMax[column];
                }
            }
            
            tableState.currentPage = 1;
            applyTableFilters();
            renderTablePage(document.getElementById("chartDataTableBody"));
            setupPaginationControls();
            updateClearFiltersButton();
        };
        
        // Global function to clear numeric filter
        window.clearNumericFilter = function(column) {
            delete tableState.columnFilters[column];
            if (tableState.columnFilterOps) delete tableState.columnFilterOps[column];
            if (tableState.columnFilterMin) delete tableState.columnFilterMin[column];
            if (tableState.columnFilterMax) delete tableState.columnFilterMax[column];
            if (tableState.columnFilterExact) delete tableState.columnFilterExact[column];
            
            tableState.currentPage = 1;
            applyTableFilters();
            renderTablePage(document.getElementById("chartDataTableBody"));
            setupPaginationControls();
            updateClearFiltersButton();
        };
        
        // Global function to clear all table filters
        window.clearAllTableFilters = function() {
            // Clear all filter states
            tableState.columnFilters = {};
            if (tableState.columnFilterOps) tableState.columnFilterOps = {};
            if (tableState.columnFilterMin) tableState.columnFilterMin = {};
            if (tableState.columnFilterMax) tableState.columnFilterMax = {};
            if (tableState.columnFilterExact) tableState.columnFilterExact = {};
            
            // Reset to first page
            tableState.currentPage = 1;
            
            // Reapply filters (will clear everything)
            applyTableFilters();
            renderTablePage(document.getElementById("chartDataTableBody"));
            setupPaginationControls();
            
            // Rebuild filter row to reset all dropdowns and inputs
            buildFilterRow();
            
            // Hide clear button
            updateClearFiltersButton();
        };
        
        // Function to show/hide clear filters button
        function updateClearFiltersButton() {
            const hasFilters = Object.keys(tableState.columnFilters).length > 0;
            const button = document.getElementById('clearFiltersBtn');
            if (button) {
                if (hasFilters) {
                    button.classList.remove('hidden');
                    button.classList.add('flex');
                } else {
                    button.classList.add('hidden');
                    button.classList.remove('flex');
                }
            }
        }
        
        // Initialize Regional Distribution Map
        function initializeRegionalMap(mapId, listId, dataSource, amountField) {
            console.log(`Initializing regional map: ${mapId}`);
            
            // Define region to ISO country codes mapping (matching your regional structure)
            const regionCountries = {
                'NAM': ['US', 'CA'], // North America - United States, Canada
                'LATAM': ['MX', 'BZ', 'CR', 'SV', 'GT', 'HN', 'NI', 'PA', 'AG', 'BS', 'BB', 'CU', 'DM', 'DO', 'GD', 'HT', 'JM', 'KN', 'LC', 'VC', 'TT', 'AR', 'BO', 'BR', 'CL', 'CO', 'EC', 'GY', 'PY', 'PE', 'SR', 'UY', 'VE'], // Latin America - Mexico + Central America + Caribbean + South America
                'EMEA': [
                    // Europe
                    'AL', 'AD', 'AT', 'BY', 'BE', 'BA', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', 'DE', 'GR', 'HU', 'IS', 'IE', 'IT', 'LV', 'LI', 'LT', 'LU', 'MT', 'MD', 'MC', 'ME', 'NL', 'MK', 'NO', 'PL', 'PT', 'RO', 'SM', 'RS', 'SK', 'SI', 'ES', 'SE', 'CH', 'UA', 'GB', 'VA',
                    // Middle East
                    'BH', 'IL', 'JO', 'KW', 'LB', 'OM', 'QA', 'SA', 'AE', 'YE', 'IQ', 'IR', 'SY', 'TR',
                    // Africa
                    'DZ', 'AO', 'BJ', 'BW', 'BF', 'BI', 'CV', 'CM', 'CF', 'TD', 'KM', 'CG', 'CD', 'DJ', 'EG', 'GQ', 'ER', 'SZ', 'ET', 'GA', 'GM', 'GH', 'GN', 'GW', 'CI', 'KE', 'LS', 'LR', 'LY', 'MG', 'MW', 'ML', 'MR', 'MU', 'MA', 'MZ', 'NA', 'NE', 'NG', 'RW', 'ST', 'SN', 'SC', 'SL', 'SO', 'ZA', 'SS', 'SD', 'TZ', 'TG', 'TN', 'UG', 'ZM', 'ZW'
                ], // Europe, Middle East, and Africa
                'APAC': [
                    // East Asia
                    'CN', 'HK', 'MO', 'JP', 'MN', 'KP', 'KR', 'TW',
                    // Southeast Asia
                    'BN', 'KH', 'ID', 'LA', 'MY', 'MM', 'PH', 'SG', 'TH', 'TL', 'VN',
                    // South Asia
                    'AF', 'BD', 'BT', 'IN', 'MV', 'NP', 'PK', 'LK',
                    // Central Asia
                    'KZ', 'KG', 'TJ', 'TM', 'UZ',
                    // Oceania
                    'AU', 'NZ', 'FJ', 'PG', 'SB', 'VU', 'WS', 'TO', 'KI', 'FM', 'MH', 'NR', 'PW', 'TV'
                ] // Asia-Pacific
            };
            
            // Color scheme for regions
            const regionColors = {
                'NAM': '#3B82F6',    // Blue
                'LATAM': '#10B981',  // Green
                'EMEA': '#8B5CF6',   // Purple
                'APAC': '#F59E0B'    // Orange
            };
            
            // Calculate regional totals with unique facility tracking
            const regionalData = {};
            let grandTotal = 0;
            
            dataSource.forEach(row => {
                const region = String(row.Region || '').trim().toUpperCase();
                const amount = parseNumber(row[amountField]);
                const facilityId = row.Facility_ID || row.FacilityID || row.Fac_ID;
                
                if (region && amount > 0) {
                    if (!regionalData[region]) {
                        regionalData[region] = { 
                            total: 0, 
                            facilities: new Set() 
                        };
                    }
                    regionalData[region].total += amount;
                    if (facilityId) {
                        regionalData[region].facilities.add(facilityId);
                    }
                    grandTotal += amount;
                }
            });
            
            // Sort regions by total (descending)
            const sortedRegions = Object.keys(regionalData).sort((a, b) => 
                regionalData[b].total - regionalData[a].total
            );
            
            console.log(`Map ${mapId} - Sorted regions:`, sortedRegions);
            console.log(`Map ${mapId} - Regional data:`, regionalData);
            
            // Initialize the map
            try {
                const mapElement = document.querySelector(`#${mapId}`);
                if (mapElement && typeof jsVectorMap !== 'undefined') {
                    console.log(`Initializing map: ${mapId}`);
                    
                    const mapConfig = {
                        selector: `#${mapId}`,
                        map: 'world',
                        zoomButtons: false,
                        
                        regionStyle: {
                            initial: {
                                fill: '#D9D9D9',
                                fillOpacity: 1
                            },
                            hover: {
                                fillOpacity: 1,
                                cursor: 'pointer'
                            }
                        }
                    };
                    
                    // Add callbacks
                    mapConfig.onRegionTooltipShow = function(event, tooltip, code) {
                        console.log('Tooltip show for code:', code);
                        console.log('Tooltip object:', tooltip);
                        
                        // Find which region this country belongs to
                        let regionName = '';
                        for (const [region, countries] of Object.entries(regionCountries)) {
                            if (countries.includes(code)) {
                                regionName = region;
                                break;
                            }
                        }
                        
                        console.log('Region found:', regionName);
                        
                        if (regionName && regionalData[regionName]) {
                            const data = regionalData[regionName];
                            const percentage = ((data.total / grandTotal) * 100).toFixed(1);
                            const facilityCount = data.facilities.size;
                            const color = regionColors[regionName];
                            
                            // Build tooltip text
                            const tooltipText = regionName + '<br>' +
                                formatCurrency(data.total) + ' (' + percentage + '%)<br>' +
                                facilityCount + ' ' + (facilityCount === 1 ? 'facility' : 'facilities');
                            
                            // Update tooltip - try different methods
                            if (tooltip) {
                                if (tooltip.text && typeof tooltip.text === 'function') {
                                    tooltip.text(tooltipText.replace(/<br>/g, '\n'));
                                }
                                if (tooltip.css && typeof tooltip.css === 'function') {
                                    tooltip.css({
                                        'background-color': color,
                                        'color': '#ffffff',
                                        'font-size': '12px',
                                        'padding': '8px 12px',
                                        'border-radius': '6px',
                                        'font-weight': '500',
                                        'line-height': '1.4'
                                    });
                                }
                                // Also try direct DOM manipulation
                                if (tooltip.selector) {
                                    tooltip.selector.innerHTML = tooltipText;
                                    tooltip.selector.style.backgroundColor = color;
                                    tooltip.selector.style.color = '#ffffff';
                                }
                            }
                            
                            console.log('Tooltip updated with color:', color);
                            
                            // Color all countries in the region on hover
                            const svg = mapElement.querySelector('svg');
                            if (regionCountries[regionName] && svg) {
                                regionCountries[regionName].forEach(countryCode => {
                                    const pathElement = svg.querySelector(`path[data-code="${countryCode}"]`);
                                    if (pathElement) {
                                        pathElement.setAttribute('fill', color);
                                        pathElement.style.fillOpacity = '1';
                                    }
                                });
                                console.log(`Colored ${regionCountries[regionName].length} countries in ${regionName}`);
                            }
                        } else {
                            console.log('No regional data found for:', regionName);
                        }
                    };
                    
                    mapConfig.onRegionOut = function(event, code) {
                        console.log('Region out for code:', code);
                        
                        // Reset ALL countries back to grey (not just the hovered region)
                        // This ensures no countries are left colored
                        const svg = mapElement.querySelector('svg');
                        if (svg) {
                            // Reset all countries in all regions
                            Object.keys(regionCountries).forEach(region => {
                                if (regionCountries[region] && Array.isArray(regionCountries[region])) {
                                    regionCountries[region].forEach(countryCode => {
                                        const pathElement = svg.querySelector(`path[data-code="${countryCode}"]`);
                                        if (pathElement) {
                                            pathElement.setAttribute('fill', '#D9D9D9');
                                            pathElement.style.fillOpacity = '1';
                                        }
                                    });
                                }
                            });
                            console.log('Reset all countries to grey');
                        }
                    };
                    
                    // Create the map instance
                    const mapInstance = new jsVectorMap(mapConfig);
                    
                    console.log(` Regional map ${mapId} initialized successfully`);
                    
                    // Add mouseleave listener to SVG to reset all countries when mouse leaves the map
                    setTimeout(() => {
                        const svg = mapElement.querySelector('svg');
                        if (svg) {
                            // Add listener to SVG element itself
                            svg.addEventListener('mouseleave', function() {
                                console.log('Mouse left SVG - resetting all countries');
                                // Reset all countries to grey
                                Object.keys(regionCountries).forEach(region => {
                                    if (regionCountries[region] && Array.isArray(regionCountries[region])) {
                                        regionCountries[region].forEach(countryCode => {
                                            const pathElement = svg.querySelector(`path[data-code="${countryCode}"]`);
                                            if (pathElement) {
                                                pathElement.setAttribute('fill', '#D9D9D9');
                                                pathElement.style.fillOpacity = '1';
                                            }
                                        });
                                    }
                                });
                            });
                            
                            // Also add to map container as backup
                            mapElement.addEventListener('mouseleave', function() {
                                console.log('Mouse left map container - resetting all countries');
                                Object.keys(regionCountries).forEach(region => {
                                    if (regionCountries[region] && Array.isArray(regionCountries[region])) {
                                        regionCountries[region].forEach(countryCode => {
                                            const pathElement = svg.querySelector(`path[data-code="${countryCode}"]`);
                                            if (pathElement) {
                                                pathElement.setAttribute('fill', '#D9D9D9');
                                                pathElement.style.fillOpacity = '1';
                                            }
                                        });
                                    }
                                });
                            });
                        }
                    }, 100);
                }
            } catch (error) {
                console.error(` Error initializing regional map ${mapId}:`, error);
            }
            
            // Generate regional list
            const listElement = document.getElementById(listId);
            if (listElement && sortedRegions.length > 0) {
                const listHTML = sortedRegions.map(region => {
                    const data = regionalData[region];
                    const percentage = ((data.total / grandTotal) * 100).toFixed(1);
                    const color = regionColors[region] || '#D9D9D9';
                    const facilityCount = data.facilities.size;
                    
                    return `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="flex items-center justify-center w-[70px]">
                                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold" 
                                          style="background-color: ${color}20; color: ${color};">
                                        ${region}
                                    </span>
                                </div>
                                <div>
                                    <p class="text-sm font-semibold text-gray-800">${formatCurrency(data.total)}</p>
                                    <span class="block text-xs text-gray-500">${facilityCount} ${facilityCount === 1 ? 'facility' : 'facilities'}</span>
                                </div>
                            </div>
                            <div class="flex w-full max-w-[140px] items-center gap-3">
                                <div class="relative block h-2 w-full max-w-[100px] rounded-sm bg-gray-200">
                                    <div class="absolute left-0 top-0 flex h-full items-center justify-center rounded-sm text-xs font-medium text-white"
                                         style="width: ${percentage}%; background-color: ${color};"></div>
                                </div>
                                <p class="text-sm font-medium text-gray-800 min-w-[45px] text-right">${percentage}%</p>
                            </div>
                        </div>
                    `;
                }).join('');
                
                listElement.innerHTML = listHTML;
            }
        }
        
        // Format number for display
        function formatShortNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toFixed(0);
        }
        
        // Global function to apply column filter from dropdown (for old chartDataModal - different table)
        window.applyChartDataColumnFilter = function(column, value) {
            if (value) {
                tableState.columnFilters[column] = value.toLowerCase();
            } else {
                delete tableState.columnFilters[column];
            }
            
            tableState.currentPage = 1;
            applyTableFilters();
            renderTablePage(document.getElementById("chartDataTableBody"));
            setupPaginationControls();
            updateClearFiltersButton();
        };

        function applyTableFilters() {
            const filters = tableState.columnFilters;
            const hasFilters = Object.keys(filters).length > 0;
            
            if (!hasFilters) {
                tableState.filteredData = tableState.data;
                return;
            }
            
            tableState.filteredData = tableState.data.filter(row => {
                return Object.entries(filters).every(([column, filterValue]) => {
                    // Handle numeric filters (exact, range, greater, less)
                    if (typeof filterValue === 'object' && filterValue.type) {
                        const cellValue = parseFloat(String(row[column] || '').replace(/[$,]/g, ''));
                        
                        if (isNaN(cellValue)) return false;
                        
                        if (filterValue.type === 'exact') {
                            return cellValue === filterValue.value;
                        } else if (filterValue.type === 'range') {
                            const min = filterValue.min;
                            const max = filterValue.max;
                            if (min !== null && max !== null) {
                                return cellValue >= min && cellValue <= max;
                            } else if (min !== null) {
                                return cellValue >= min;
                            } else if (max !== null) {
                                return cellValue <= max;
                            }
                            return true;
                        } else if (filterValue.type === 'greater') {
                            return cellValue > filterValue.value;
                        } else if (filterValue.type === 'less') {
                            return cellValue < filterValue.value;
                        }
                    }
                    
                    // Handle text filters
                    const cellValue = String(row[column] || '').toLowerCase();
                    return cellValue.includes(filterValue);
                });
            });
        }

        function renderTablePage(tableBody) {
            const data = tableState.filteredData;
            const pageSize = tableState.pageSize;
            const currentPage = tableState.currentPage;
            const startIdx = (currentPage - 1) * pageSize;
            const endIdx = Math.min(startIdx + pageSize, data.length);
            const pageData = data.slice(startIdx, endIdx);

            if (pageData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${tableState.columns.length}" class="text-center py-8 text-gray-500">No matching records found</td></tr>`;
                updatePaginationControls(0, 0, data.length);
                return;
            }

            tableBody.innerHTML = pageData
                .map(
                    (row, idx) =>
                        `<tr>
                    ${tableState.columns
                            .map((col) => {
                    const value = row[col];
                    const formattedValue = formatCellValue(col, value);
                    return `<td class="py-3 px-5 whitespace-nowrap sm:px-6">
                        <div class="flex items-center">
                            <p class="text-sm text-gray-700">${formattedValue}</p>
                        </div>
                    </td>`;
                            })
                            .join("")}
                </tr>`
                )
                .join("");

            updatePaginationControls(startIdx + 1, endIdx, data.length);
        }

        function setupPaginationControls() {
            const pageSize = tableState.pageSize;
            const totalRows = tableState.filteredData.length;
            const totalPages = Math.ceil(totalRows / pageSize);
            
            const prevBtn = document.getElementById('dataPrevBtn');
            const nextBtn = document.getElementById('dataNextBtn');
            const pageSizeSelect = document.getElementById('dataPageSize');
            
            // Update page selector
            pageSizeSelect.value = pageSize;
            
            // Update buttons
            prevBtn.disabled = tableState.currentPage <= 1;
            nextBtn.disabled = tableState.currentPage >= totalPages;
            
            document.getElementById('dataCurrentPage').textContent = tableState.currentPage;
            document.getElementById('dataTotalPages').textContent = totalPages || 1;
            
            // Remove old event listeners by cloning
            const newPrevBtn = prevBtn.cloneNode(true);
            const newNextBtn = nextBtn.cloneNode(true);
            const newPageSizeSelect = pageSizeSelect.cloneNode(true);
            
            prevBtn.parentNode.replaceChild(newPrevBtn, prevBtn);
            nextBtn.parentNode.replaceChild(newNextBtn, nextBtn);
            pageSizeSelect.parentNode.replaceChild(newPageSizeSelect, pageSizeSelect);
            
            // Add new event listeners
            newPrevBtn.addEventListener('click', () => {
                if (tableState.currentPage > 1) {
                    tableState.currentPage--;
                    renderTablePage(document.getElementById("chartDataTableBody"));
                    setupPaginationControls();
                }
            });
            
            newNextBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(tableState.filteredData.length / tableState.pageSize);
                if (tableState.currentPage < totalPages) {
                    tableState.currentPage++;
                    renderTablePage(document.getElementById("chartDataTableBody"));
                    setupPaginationControls();
                }
            });
            
            newPageSizeSelect.addEventListener('change', (e) => {
                tableState.pageSize = parseInt(e.target.value);
                tableState.currentPage = 1;
                renderTablePage(document.getElementById("chartDataTableBody"));
                setupPaginationControls();
            });
        }

        function updatePaginationControls(start, end, total) {
            document.getElementById('dataRowsStart').textContent = start;
            document.getElementById('dataRowsEnd').textContent = end;
            document.getElementById('dataTotalRows').textContent = total;
        }

        // Debounce helper function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Format cell value based on column name
        function formatCellValue(column, value) {
            if (value === null || value === undefined || value === "") return "-";

            const col = column.toLowerCase();

            // Format currency columns
            if (
                col.includes("amount") ||
                col.includes("_os") ||
                col.includes("osuc") ||
                col.includes("committed")
            ) {
                const num = parseNumber(value);
                if (!isNaN(num) && num !== 0) {
                    return formatCurrency(num);
                }
            }

            // Format date columns
            if (col.includes("date")) {
                const date = parseDate(value);
                if (date) {
                    return formatDate(date);
                }
            }

            // Format percentage columns
            if (col.includes("rate") || col.includes("percent")) {
                const num = parseFloat(value);
                if (!isNaN(num)) {
                    return num.toFixed(2) + "%";
                }
            }

            return String(value);
        }


        // Export data from the modal (when modal is open)
        function exportModalData() {
            if (
                !window.currentChartData ||
                !window.currentChartData.data ||
                window.currentChartData.data.length === 0
            ) {
                showNotification("Export Failed", "No data available to export", "error");
                return;
            }

            // Check if XLSX library is loaded
            if (typeof XLSX === "undefined") {
                showNotification(
                    "Export Failed",
                    "Export library not loaded. Please refresh the page and try again.",
                    "error"
                );
                return;
            }

            const data = window.currentChartData.data;
            const chartName = window.currentChartData.chartName;

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, "Data");

            // Generate filename with chart name and date
            const dateStr = new Date().toISOString().split("T")[0];
            const filename = `${chartName}_${dateStr}.xlsx`;

            // Download file
            XLSX.writeFile(wb, filename);
        }

        // Export chart data to XLSX
        function exportChartData(chartType) {
            // Check if data is loaded
            if (!portfolioData || portfolioData.length === 0) {
                showNotification("Export Failed", "No data available. Please ensure the data is loaded first.", "error");
                return;
            }

            // Check if XLSX library is loaded
            if (typeof XLSX === "undefined") {
                showNotification(
                    "Export Failed",
                    "Export library not loaded. Please refresh the page and try again.",
                    "error"
                );
                return;
            }

            // Get data based on chart type
            let data = [];
            let chartName = "";

            switch (chartType) {
                case "expiring":
                    chartName = "CAs_Facilities_Expiring";
                    data = getExpiringData();
                    break;
                case "newFacilities":
                    chartName = "New_Facilities_by_Product_Program";
                    data = getNewFacilitiesData();
                    break;
                case "topRelationships":
                    chartName =
                        "Top_Relationships_by_" + selectedAmountType.toUpperCase();
                    data = getTopRelationshipsData();
                    break;
                case "rotce":
                    chartName = "ROTCE_Performance";
                    data = getROTCEData();
                    break;
                case "newDealsYTD":
                    chartName = "New_Deals_Closed_YTD";
                    data = getNewDealsYTDData();
                    break;
                case "newDealsMTD":
                    chartName = "New_Deals_Closed_MTD";
                    data = getNewDealsMTDData();
                    break;
                case "covenantsByProgram":
                    chartName = "Covenants_by_Product_Program";
                    data = getCovenantsByProgramData();
                    break;
                case "covenantMonitoring":
                    chartName = currentCovenantViewType === 'pastDue' ? "Covenants_Past_Due" : "Covenants_Coming_Due_Next_30_Days";
                    data = getCovenantMonitoringData();
                    break;
                case "covenantRegional":
                    chartName = currentCovenantViewType === 'pastDue' ? "Covenants_Past_Due_by_Region" : "Covenants_Coming_Due_by_Region_Next_30_Days";
                    data = getCovenantRegionalData();
                    break;
                case "ccmRegionalChart":
                    chartName = "CCM_by_Region";
                    data = getCCMFilteredData();
                    break;
                case "ccmStats":
                    chartName = "Credit_Committee_Memos";
                    data = getCCMFilteredData();
                    break;
            }

            console.log(
                "Export chart data:",
                chartType,
                "Records found:",
                data ? data.length : 0
            );

            if (!data || data.length === 0) {
                showNotification(
                    "Export Failed",
                    "No data to export for this chart. Please check your filters or ensure data matches the chart criteria.",
                    "warning"
                );
                return;
            }

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, "Data");

            // Generate filename with chart name and date
            const dateStr = new Date().toISOString().split("T")[0];
            const filename = `${chartName}_${dateStr}.xlsx`;

            // Download file
            XLSX.writeFile(wb, filename);
        }
    </script>
</body>

</html>
